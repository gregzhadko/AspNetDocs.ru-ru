---
uid: mvc/overview/older-versions/hands-on-labs/aspnet-mvc-4-custom-action-filters
title: Фильтры настраиваемых действий ASP.NET MVC 4 | Документация Майкрософт
author: rick-anderson
description: ASP.NET MVC предоставляет фильтры действий для выполнения логики фильтрации либо до, либо после вызова метода действия. Фильтры действий являются пользовательскими атрибутами Tha...
ms.author: riande
ms.date: 02/18/2013
ms.assetid: 969ab824-1b98-4552-81fe-b60ef5fc6887
msc.legacyurl: /mvc/overview/older-versions/hands-on-labs/aspnet-mvc-4-custom-action-filters
msc.type: authoredcontent
ms.openlocfilehash: eaeb32180f79fabf557cbc38ff067eb26b47fea7
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78468180"
---
# <a name="aspnet-mvc-4-custom-action-filters"></a>Фильтры настраиваемых действий в ASP.NET MVC 4

по [веб-Camp командам](https://twitter.com/webcamps)

[Скачать обучающий комплект Web Camp](https://aka.ms/webcamps-training-kit)

ASP.NET MVC предоставляет фильтры действий для выполнения логики фильтрации либо до, либо после вызова метода действия. Фильтры действий — это настраиваемые атрибуты, которые предоставляют декларативные средства для добавления поведения действий, выполняемых перед действием и после действия, в методы действий контроллера.

В этой практической лабораторной работе вы создадите настраиваемый атрибут фильтра действий в решении Мвкмусиксторе для перехвата запросов контроллера и регистрации активности сайта в таблице базы данных. Вы сможете добавить фильтр ведения журнала путем внедрения в любой контроллер или действие. Наконец, вы увидите представление журнала, в котором отображается список посетителей.

В этой практической лабораторной работе предполагается, что у вас есть базовые знания о **ASP.NET MVC**. Если вы ранее не использовали **ASP.NET MVC** , мы рекомендуем вам перейти на практический семинар **ASP.NET MVC 4** .

> [!NOTE]
> Все примеры кода и фрагментов включены в комплект обучающих курсов Web Camp, доступный в [выпусках Microsoft Web/вебкамптраинингкит](https://aka.ms/webcamps-training-kit). Проект, относящийся к этой лабораторной работе, доступен по [настраиваемым фильтрам действий ASP.NET MVC 4](https://github.com/Microsoft-Web/HOL-MVC4CustomActionFilters).

<a id="Objectives"></a>
### <a name="objectives"></a>Цели

В этой практической лабораторной работе вы узнаете, как выполнять следующие задачи:

- Создание атрибута настраиваемого фильтра действий для расширения возможностей фильтрации
- Применение настраиваемого атрибута фильтра путем внедрения к определенному уровню
- Глобально зарегистрировать фильтры настраиваемых действий

<a id="Prerequisites"></a>

<a id="Prerequisites"></a>
### <a name="prerequisites"></a>предварительные требования

Для выполнения этой лабораторной работы необходимо иметь следующие элементы:

- [Microsoft Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/eng/products/visual-studio-express-for-web) или старше (см. [приложение а](#AppendixA) для получения инструкций по его установке).

<a id="Setup"></a>

<a id="Setup"></a>
### <a name="setup"></a>Настройка

**Установка фрагментов кода**

Для удобства большая часть кода, который вы будете управлять в этой лаборатории, доступна в виде фрагментов кода Visual Studio. Чтобы установить фрагменты кода, запустите файл **.\саурце\сетуп\кодесниппетс.ВСИ** .

Если вы не знакомы с фрагментами кода Visual Studio Code и хотите узнать, как их использовать, см. приложение в этом документе &quot;[приложении C: использование фрагментов кода](#AppendixC)&quot;.

---

<a id="Exercises"></a>

<a id="Exercises"></a>
## <a name="exercises"></a>Полнят

Эта практическая лабораторная работа состоит из следующих упражнений:

1. [Упражнение 1. действия ведения журнала](#Exercise1)
2. [Упражнение 2. Управление несколькими фильтрами действий](#Exercise2)

Предполагаемое время выполнения этой лабораторной работы: **30 минут**.

> [!NOTE]
> Каждое упражнение сопровождается **конечной** папкой, содержащей итоговое решение, которое следует получить после завершения упражнений. Это решение можно использовать в качестве инструкции, если вам нужна дополнительная помощь по работе с упражнениями.

<a id="Exercise1"></a>

<a id="Exercise_1_Logging_Actions"></a>
### <a name="exercise-1-logging-actions"></a>Упражнение 1. действия ведения журнала

В этом упражнении вы узнаете, как создать настраиваемый фильтр журнала действий с помощью поставщиков фильтров ASP.NET MVC 4. Для этой цели вы примените фильтр ведения журнала к сайту Мусиксторе, который будет записывать все действия в выбранных контроллерах.

Фильтр расширяет **актионфилтераттрибутекласс** и переопределяет метод **OnActionExecuting** для перехвата каждого запроса, а затем выполняет действия по ведению журнала. Контекстные сведения о HTTP-запросах, методах, результатах и параметрах будут предоставлены классом ASP.NET MVC **ActionExecutingContext** **.**

> [!NOTE]
> В ASP.NET MVC 4 также есть поставщики фильтров по умолчанию, которые можно использовать без создания настраиваемого фильтра. ASP.NET MVC 4 предоставляет следующие типы фильтров:
> 
> - Фильтр **авторизации** , позволяющий принимать решения по безопасности о том, следует ли выполнять метод действия, например выполнять проверку подлинности или проверять свойства запроса.
> - Фильтр **действий** , который служит оболочкой для выполнения метода действия. Этот фильтр может выполнять дополнительную обработку, например предоставление дополнительных данных для метода действия, проверку возвращаемого значения или Отмена выполнения метода действия.
> - Фильтр **результатов** , который служит оболочкой для выполнения объекта ActionResult. Этот фильтр может выполнять дополнительную обработку результата, например изменение HTTP-ответа.
> - Фильтр **исключений** , который выполняется при возникновении необработанного исключения в методе действия, начиная с фильтров авторизации и заканчивая выполнением результата. Фильтры исключений можно использовать для ведения журнала или для отображения страниц об ошибках.
> 
> Дополнительные сведения о поставщиках фильтров см. по этой ссылке MSDN: ([https://msdn.microsoft.com/library/dd410209.aspx](https://msdn.microsoft.com/library/dd410209.aspx)).

<a id="AboutLoggingFeature"></a>

<a id="About_MVC_Music_Store_Application_logging_feature"></a>
#### <a name="about-mvc-music-store-application-logging-feature"></a>О функции ведения журнала приложения музыкального магазина MVC

В этом решении музыкального магазина имеется новая таблица модели данных для ведения журнала сайта **актионлог**со следующими полями: имя контроллера, получившего запрос, называемый действием, IP-адрес клиента и отметка времени.

![Модель данных. Таблица Актионлог.](aspnet-mvc-4-custom-action-filters/_static/image1.png "Модель данных. Таблица Актионлог.")

*Модель данных — таблица Актионлог*

Решение предоставляет представление MVC ASP.NET для журнала действий, которое можно найти по адресу **мвкмусиксторес/views/актионлог**:

![Представление журнала действий](aspnet-mvc-4-custom-action-filters/_static/image2.png "Представление журнала действий")

*Представление журнала действий*

Учитывая эту структуру, вся работа будет сосредоточена на запросе контроллера прерывания и выполнении ведения журнала с помощью пользовательской фильтрации.

<a id="Ex1Task1"></a>

<a id="Task_1_-_Creating_a_Custom_Filter_to_Catch_a_Controllers_Request"></a>
#### <a name="task-1---creating-a-custom-filter-to-catch-a-controllers-request"></a>Задача 1. Создание настраиваемого фильтра для перехвата запроса контроллера

В этой задаче будет создан класс настраиваемого атрибута фильтра, который будет содержать логику ведения журнала. Для этой цели будет расширен класс ASP.NET MVC **ActionFilterAttribute** и реализован интерфейс **иактионфилтер**.

> [!NOTE]
> **ActionFilterAttribute** является базовым классом для всех фильтров атрибутов. Он предоставляет следующие методы для выполнения определенной логики после и до выполнения действия контроллера:
> 
> - **OnActionExecuting**(ActionExecutingContext филтерконтекст): непосредственно перед вызовом метода действия.
> - **OnActionExecuted**(актионексекутедконтекст филтерконтекст): после вызова метода действия и перед выполнением результата (перед отрисовкой представления).
> - **OnResultExecuting**(ресултексекутингконтекст филтерконтекст): непосредственно перед выполнением результата (перед отрисовкой представления).
> - **Онресултексекутед**(ресултексекутедконтекст филтерконтекст): после выполнения результата (после подготовки представления).
> 
> Переопределяя любой из этих методов в производный класс, можно выполнить собственный код фильтрации.

1. Откройте решение **Начало** решения, расположенное в папке **\Source\Ex01-LoggingActions\Begin** .

   1. Перед продолжением необходимо загрузить некоторые недостающие пакеты NuGet. Для этого в меню **проект** выберите пункт **Управление пакетами NuGet**.
   2. В диалоговом окне **Управление пакетами NuGet** нажмите кнопку **восстановить** , чтобы скачать недостающие пакеты.
   3. Наконец, создайте решение, щелкнув **build** | **Build Solution**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является то, что вам не нужно поставлять все библиотеки в проекте, уменьшая размер проекта. С помощью средств управления питанием NuGet, указав версии пакетов в файле Packages. config, вы сможете скачать все необходимые библиотеки при первом запуске проекта. Именно поэтому после открытия существующего решения из этой лабораторной работы потребуется выполнить следующие действия.
      > 
      > Дополнительные сведения см. в этой статье: [http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages](http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages).
2. Добавьте новый C# класс в папку **Filters** и назовите его *CustomActionFilter.CS*. В этой папке будут храниться все настраиваемые фильтры.
3. Откройте **CustomActionFilter.CS** и добавьте ссылку на пространства имен **System. Web. MVC** и **мвкмусиксторе. Models** :

    (Фрагмент кода — *ASP.NET MVC 4 Custom Action Filters-EX1-кустомактионфилтернамеспацес*)

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample1.cs)]
4. Наследуйте класс **кустомактионфилтер** из **ActionFilterAttribute** , а затем создайте класс **Кустомактионфилтер** , реализующий интерфейс **иактионфилтер** .

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample2.cs)]
5. Сделайте класс **кустомактионфилтер** переопределять метод **OnActionExecuting** и добавить необходимую логику для записи в журнал выполнения фильтра. Для этого добавьте следующий выделенный код в класс **кустомактионфилтер** .

    (Фрагмент кода — *ASP.NET MVC 4 Custom Action Filters-EX1-логгингактионс*)

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample3.cs#Highlight)]

    > [!NOTE]
    > Метод **OnActionExecuting** использует **Entity Framework** для добавления нового регистра актионлог. Он создает и заполняет новый экземпляр сущности сведениями о контексте из **филтерконтекст**.
    > 
    > Дополнительные сведения о классе **контроллерконтекст** можно узнать на [сайте MSDN](https://msdn.microsoft.com/library/system.web.mvc.controllercontext.aspx).

<a id="Ex1Task2"></a>

<a id="Task_2_-_Injecting_a_Code_Interceptor_into_the_Store_Controller_Class"></a>
#### <a name="task-2---injecting-a-code-interceptor-into-the-store-controller-class"></a>Задача 2. Внедрение перехватчика кода в класс контроллера Store

В этой задаче будет добавлен настраиваемый фильтр, который будет внедрен во все классы контроллеров и действия контроллера, которые будут регистрироваться в журнале. В этом упражнении класс контроллера хранилища будет иметь журнал.

Метод **OnActionExecuting** из настраиваемого фильтра **актионлогфилтераттрибуте** запускается при вызове внедренного элемента.

Кроме того, можно перехватить конкретный метод контроллера.

1. Откройте **стореконтроллер** по адресу **мвкмусиксторе\контроллерс** и добавьте ссылку на пространство имен **Filters** :

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample4.cs)]
2. Вставьте пользовательский фильтр **кустомактионфилтер** в класс **стореконтроллер** , добавив атрибут **[кустомактионфилтер]** перед объявлением класса.

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample5.cs)]

   > [!NOTE]
   > При внедрении фильтра в класс контроллера также вставляются все его действия. Если вы хотите применить фильтр только к набору действий, необходимо внедрить **[кустомактионфилтер]** в один из них:
   > 
   > [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample6.cs)]

<a id="Ex1Task3"></a>

<a id="Task_3_-_Running_the_Application"></a>
#### <a name="task-3---running-the-application"></a>Задача 3. Запуск приложения

В этой задаче будет протестировать работу фильтра ведения журнала. Вы запустите приложение и зайдете в магазин, а затем проверите зарегистрированные действия.

1. Нажмите клавишу **F5** для запуска приложения.
2. Перейдите по **/актионлог** , чтобы просмотреть начальное состояние представления журнала:

    ![Состояние средства записи журнала перед действием страницы](aspnet-mvc-4-custom-action-filters/_static/image3.png "Состояние средства записи журнала перед действием страницы")

    *Состояние средства записи журнала перед действием страницы*

   > [!NOTE]
   > По умолчанию он всегда будет отображать один элемент, созданный при извлечении существующих жанров для меню.
   > 
   > В целях простоты мы очищаете таблицу **актионлог** при каждом запуске приложения, чтобы они показывали только журналы проверки каждой конкретной задачи.
   > 
   > Может потребоваться удалить следующий код из метода **сеанса\_Start** (в классе **Global. asax** ), чтобы сохранить журнал журнала для всех действий, выполняемых в контроллере хранилища.
   > 
   > [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample7.cs)]
3. Щелкните один из **жанров** в меню и выполните некоторые действия, например просмотр доступного альбома.
4. Перейдите в **/актионлог** и, если журнал пуст, нажмите клавишу **F5** , чтобы обновить страницу. Убедитесь, что посещения были отслеживанием:

    ![Журнал действий с регистрируемым действием](aspnet-mvc-4-custom-action-filters/_static/image4.png "Журнал действий с регистрируемым действием")

    *Журнал действий с регистрируемым действием*

<a id="Exercise2"></a>

<a id="Exercise_2_Managing_Multiple_Action_Filters"></a>
### <a name="exercise-2-managing-multiple-action-filters"></a>Упражнение 2. Управление несколькими фильтрами действий

В этом упражнении вы добавите второй настраиваемый фильтр действий в класс Стореконтроллер и определите конкретный порядок, в котором будут выполняться оба фильтра. Затем вы обновите код, чтобы зарегистрировать фильтр глобально.

При определении порядка выполнения фильтров можно учитывать различные параметры. Например, свойство Order и область фильтров:

Можно определить **область** для каждого из фильтров, например, можно задать область действия всех фильтров действий, которые будут выполняться в пределах **области контроллера**, и все фильтры авторизации для выполнения в **глобальной области**. Области имеют определенный порядок выполнения.

Кроме того, у каждого фильтра действий есть свойство Order, которое используется для определения порядка выполнения в области фильтра.

Дополнительные сведения о порядке выполнения фильтров настраиваемых действий см. в этой статье MSDN: ([https://msdn.microsoft.com/library/dd381609(v=vs.98).aspx](https://msdn.microsoft.com/library/dd381609(v=vs.98).aspx)).

<a id="Ex2Task1"></a>

<a id="Task_1_Creating_a_new_Custom_Action_Filter"></a>
#### <a name="task-1-creating-a-new-custom-action-filter"></a>Задача 1. Создание нового настраиваемого фильтра действий

В этой задаче вы создадите новый настраиваемый фильтр действий для внедрения в класс Стореконтроллер, чтобы узнать, как управлять порядком выполнения фильтров.

1. Откройте решение **Начало** решения, расположенное в папке **\Source\Ex02-ManagingMultipleActionFilters\Begin** . В противном случае вы можете продолжать **использовать решение, полученное в результате** выполнения предыдущего упражнения.

    1. Если вы открыли предоставленное **Начальное** решение, перед продолжением потребуется загрузить некоторые недостающие пакеты NuGet. Для этого в меню **проект** выберите пункт **Управление пакетами NuGet**.
    2. В диалоговом окне **Управление пакетами NuGet** нажмите кнопку **восстановить** , чтобы скачать недостающие пакеты.
    3. Наконец, создайте решение, щелкнув **build** | **Build Solution**.

        > [!NOTE]
        > Одним из преимуществ использования NuGet является то, что вам не нужно поставлять все библиотеки в проекте, уменьшая размер проекта. С помощью средств управления питанием NuGet, указав версии пакетов в файле Packages. config, вы сможете скачать все необходимые библиотеки при первом запуске проекта. Именно поэтому после открытия существующего решения из этой лабораторной работы потребуется выполнить следующие действия.
        > 
        > Дополнительные сведения см. в этой статье: [http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages](http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages).
2. Добавьте новый C# класс в папку **Filters** и назовите его *MyNewCustomActionFilter.CS* .
3. Откройте **MyNewCustomActionFilter.CS** и добавьте ссылку на **System. Web. MVC** и пространство имен **мвкмусиксторе. Models** :

    (Фрагмент кода — *ASP.NET MVC 4 Custom Action Filters-EX2-миневкустомактионфилтернамеспацес*)

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample8.cs)]
4. Замените объявление класса по умолчанию следующим кодом.

    (Фрагмент кода — *ASP.NET MVC 4 Custom Action Filters-EX2-миневкустомактионфилтеркласс*)

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample9.cs)]

    > [!NOTE]
    > Этот настраиваемый фильтр действий почти не тот, который был создан в предыдущем упражнении. Основное отличие заключается в том, что в нем есть *&quot;, регистрируемые&quot;ным* атрибутом, обновленным с помощью этого нового класса "имя", чтобы узнать, какой фильтр зарегистрировал журнал.

<a id="Ex2Task2"></a>

<a id="Task_2_Injecting_a_new_Code_Interceptor_into_the_StoreController_Class"></a>
#### <a name="task-2-injecting-a-new-code-interceptor-into-the-storecontroller-class"></a>Задача 2. внедрение нового перехватчика кода в класс Стореконтроллер

В этой задаче вы добавите новый настраиваемый фильтр в класс Стореконтроллер и запустите решение, чтобы проверить, как оба фильтра работают вместе.

1. Откройте класс **стореконтроллер** , расположенный по адресу **мвкмусиксторе\контроллерс** , и вставьте новый настраиваемый фильтр **миневкустомактионфилтер** в класс **стореконтроллер** , как показано в следующем коде.

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample10.cs)]
2. Теперь запустите приложение, чтобы увидеть, как работают эти два настраиваемых фильтра действий. Для этого нажмите клавишу **F5** и дождитесь запуска приложения.
3. Перейдите по **/актионлог** , чтобы просмотреть начальное состояние представления журнала.

    ![Состояние средства записи журнала перед действием страницы](aspnet-mvc-4-custom-action-filters/_static/image5.png "Состояние средства записи журнала перед действием страницы")

    *Состояние средства записи журнала перед действием страницы*
4. Щелкните один из **жанров** в меню и выполните некоторые действия, например просмотр доступного альбома.
5. Проверьте это время. посещения были записаны дважды: один раз для каждого из фильтров настраиваемых действий, добавленных в класс **сторажеконтроллер** .

    ![Журнал действий с регистрируемым действием](aspnet-mvc-4-custom-action-filters/_static/image6.png "Журнал действий с регистрируемым действием")

    *Журнал действий с регистрируемым действием*
6. Закройте браузер.

<a id="Ex2Task3"></a>

<a id="Task_3_Managing_Filter_Ordering"></a>
#### <a name="task-3-managing-filter-ordering"></a>Задача 3. Управление порядком фильтрации

В этой задаче вы узнаете, как управлять порядком выполнения фильтров с помощью свойства Order.

1. Откройте класс **стореконтроллер** , расположенный по адресу **мвкмусиксторе\контроллерс** , и укажите свойство **Order** в обоих фильтрах, как показано ниже.

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample11.cs)]
2. Теперь проверьте, как выполняются фильтры в зависимости от значения свойства Order. Вы обнаружите, что фильтр с наименьшим порядковым значением (**кустомактионфилтер**) является первым из выполняемых. Нажмите клавишу **F5** и дождитесь запуска приложения.
3. Перейдите по **/актионлог** , чтобы просмотреть начальное состояние представления журнала.

    ![Состояние средства записи журнала перед действием страницы](aspnet-mvc-4-custom-action-filters/_static/image7.png "Состояние средства записи журнала перед действием страницы")

    *Состояние средства записи журнала перед действием страницы*
4. Щелкните один из **жанров** в меню и выполните некоторые действия, например просмотр доступного альбома.
5. Убедитесь, что на этот раз посещения были отсортированы по порядковому номеру: сначала **кустомактионфилтер** журналы.

    ![Журнал действий с регистрируемым действием](aspnet-mvc-4-custom-action-filters/_static/image8.png "Журнал действий с регистрируемым действием")

    *Журнал действий с регистрируемым действием*
6. Теперь вы обновите значение порядка фильтров и убедитесь, как изменяется порядок ведения журнала. В классе **стореконтроллер** обновите значение порядка фильтров, как показано ниже.

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample12.cs)]
7. Запустите приложение еще раз, нажав клавишу **F5**.
8. Щелкните один из **жанров** в меню и выполните некоторые действия, например просмотр доступного альбома.
9. Убедитесь, что в этот раз журналы, созданные с помощью фильтра **миневкустомактионфилтер** , отображаются первыми.

    ![Журнал действий с регистрируемым действием](aspnet-mvc-4-custom-action-filters/_static/image9.png "Журнал действий с регистрируемым действием")

    *Журнал действий с регистрируемым действием*

<a id="Ex2Task4"></a>

<a id="Task_4_Registering_Filters_Globally"></a>
#### <a name="task-4-registering-filters-globally"></a>Задача 4. Глобальная регистрация фильтров

В этой задаче будет обновлено решение для регистрации нового фильтра (**миневкустомактионфилтер**) в качестве глобального фильтра. Таким образом, все действия, выполняемые в приложении, будут запускаться не только в Стореконтроллер, но и в предыдущей задаче.

1. В классе **стореконтроллер** удалите атрибут **[миневкустомактионфилтер]** и свойство Order из **[кустомактионфилтер]** . Он должен выглядеть примерно так:

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample13.cs)]
2. Откройте файл **Global. asax** и перейдите к методу **\_запуск приложения** . Обратите внимание, что каждый раз, когда приложение запускается, регистрирует глобальные фильтры путем вызова метода **регистерглобалфилтерс** в классе **филтерконфиг** .

    ![Регистрация глобальных фильтров в Global. asax](aspnet-mvc-4-custom-action-filters/_static/image10.png "Регистрация глобальных фильтров в Global. asax")

    *Регистрация глобальных фильтров в Global. asax*
3. Откройте файл **FilterConfig.CS** в папке **app\_Start** .
4. Добавить ссылку на использование System. Web. MVC; Использование Мвкмусиксторе. Filters; имен.

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample14.cs)]
5. Обновите метод **регистерглобалфилтерс** , добавив настраиваемый фильтр. Для этого добавьте выделенный код:

    [!code-csharp[Main](aspnet-mvc-4-custom-action-filters/samples/sample15.cs)]
6. Запустите приложение, нажав клавишу **F5**.
7. Щелкните один из **жанров** в меню и выполните некоторые действия, например просмотр доступного альбома.
8. Убедитесь, что сейчас **[миневкустомактионфилтер]** будет внедрен в HomeController и актионлогконтроллер.

    ![Журнал действий с регистрируемым действием](aspnet-mvc-4-custom-action-filters/_static/image11.png "Журнал действий с регистрируемым действием")

    *Журнал действий с зарегистрированным глобальным действием*

> [!NOTE]
> Кроме того, это приложение можно развернуть на веб-сайтах Windows Azure в [приложении б: Публикация приложения ASP.NET MVC 4 с помощью веб-развертывание](#AppendixB).

---

<a id="Summary"></a>

<a id="Summary"></a>
## <a name="summary"></a>Сводка

С помощью этой практической лабораторной работы вы узнали, как расширить фильтр действий для выполнения настраиваемых действий. Вы также узнали, как внедрить любой фильтр на контроллеры страниц. Используются следующие основные понятия:

- Создание настраиваемых фильтров действий с помощью класса ASP.NET MVC ActionFilterAttribute
- Как внедрять фильтры в ASP.NET MVC Controllers
- Управление порядком фильтрации с помощью свойства Order
- Глобальная регистрация фильтров

<a id="AppendixA"></a>

<a id="Appendix_A_Installing_Visual_Studio_Express_2012_for_Web"></a>
## <a name="appendix-a-installing-visual-studio-express-2012-for-web"></a>Приложение а. Установка Visual Studio Express 2012 для Web

Вы можете установить **Microsoft Visual Studio Express 2012 для Web** или другой &quot;Express&quot; версии с помощью **[установщик веб-платформы Майкрософт](https://www.microsoft.com/web/downloads/platform.aspx)** . Следующие инструкции помогут вам выполнить действия, необходимые для установки *Visual Studio Express 2012 для Web* с помощью *установщик веб-платформы Майкрософт*.

1. Перейдите на сайт [https://go.microsoft.com/?linkid=9810169](https://go.microsoft.com/?linkid=9810169). Кроме того, если у вас уже установлен установщик веб-платформы, вы можете открыть его и найти продукт &quot;<em>Visual Studio Express 2012 для Web с Windows Azure SDK</em>&quot;.
2. Щелкните **Install Now (установить сейчас**). Если у вас нет **установщика веб-платформы** , вы будете сначала перенаправлены на загрузку и установку.
3. После открытия **установщика веб-платформы** нажмите кнопку **установить** , чтобы начать установку.

    ![Установка Visual Studio Express](aspnet-mvc-4-custom-action-filters/_static/image12.png "Установка Visual Studio Express")

    *Установка Visual Studio Express*
4. Прочитайте все лицензии и условия продуктов и нажмите кнопку " **принять** ", чтобы продолжить.

    ![Принятие условий лицензии](aspnet-mvc-4-custom-action-filters/_static/image13.png)

    *Принятие условий лицензии*
5. Дождитесь завершения процесса загрузки и установки.

    ![Ход установки](aspnet-mvc-4-custom-action-filters/_static/image14.png)

    *Ход установки*
6. После завершения установки нажмите кнопку **Готово**.

    ![Установка завершена](aspnet-mvc-4-custom-action-filters/_static/image15.png)

    *Установка завершена*
7. Нажмите кнопку **выход** , чтобы закрыть установщик веб-платформы.
8. Чтобы открыть Visual Studio Express для Интернета, перейдите на **начальный** экран и начните запись &quot;**VS Express**&quot;, а затем щелкните плитку **VS Express для Web** .

    ![Плитка VS Express для Web](aspnet-mvc-4-custom-action-filters/_static/image16.png)

    *Плитка VS Express для Web*

<a id="AppendixB"></a>

<a id="Appendix_B_Publishing_an_ASPNET_MVC_4_Application_using_Web_Deploy"></a>
## <a name="appendix-b-publishing-an-aspnet-mvc-4-application-using-web-deploy"></a>Приложение б. Публикация приложения ASP.NET MVC 4 с помощью веб-развертывание

В этом приложении показано, как создать новый веб-сайт из портал управления Windows Azure и опубликовать полученное приложение, выполнив следующие лабораторные занятия, используя возможности публикации веб-развертывание, предоставляемые Windows Azure.

<a id="ApxBTask1"></a>

<a id="Task_1_-_Creating_a_New_Web_Site_from_the_Windows_Azure_Portal"></a>
#### <a name="task-1---creating-a-new-web-site-from-the-windows-azure-portal"></a>Задача 1. Создание нового веб-сайта на портале Windows Azure

1. Перейдите в [портал управления Windows Azure](https://manage.windowsazure.com/) и выполните вход с использованием учетных данных Майкрософт, связанных с подпиской.

    > [!NOTE]
    > С помощью Windows Azure можно бесплатно разместить 10 веб-сайтов ASP.NET, а затем масштабировать их по мере роста объема трафика. Вы можете зарегистрироваться [здесь](https://aka.ms/aspnet-hol-azure).

    ![Вход в Windows портал Azure](aspnet-mvc-4-custom-action-filters/_static/image17.png "Вход в Windows портал Azure")

    *Вход в Windows Azure портал управления*
2. На панели команд щелкните **создать** .

    ![Создание нового веб-сайта](aspnet-mvc-4-custom-action-filters/_static/image18.png "Создание нового веб-сайта")

    *Создание нового веб-сайта*
3. Щелкните **Compute** | **веб-сайт**. Затем выберите пункт **Быстрое создание** . Предоставьте доступный URL-адрес для нового веб-сайта и щелкните **создать веб-сайт**.

    > [!NOTE]
    > Веб-сайт Windows Azure — это узел для веб-приложения, работающего в облаке, которыми можно управлять и которыми вы управляете. Параметр Быстрое создание позволяет развернуть завершенное веб-приложение на веб-сайте Windows Azure извне портала. Он не включает шаги по настройке базы данных.

    ![Создание нового веб-сайта с помощью быстрого создания](aspnet-mvc-4-custom-action-filters/_static/image19.png "Создание нового веб-сайта с помощью быстрого создания")

    *Создание нового веб-сайта с помощью быстрого создания*
4. Дождитесь создания нового **веб-сайта** .
5. После создания веб-сайта щелкните ссылку в столбце **URL-адрес** . Убедитесь, что новый веб-сайт работает.

    ![Обзор нового веб-сайта](aspnet-mvc-4-custom-action-filters/_static/image20.png "Обзор нового веб-сайта")

    *Обзор нового веб-сайта*

    ![Веб-сайт работает](aspnet-mvc-4-custom-action-filters/_static/image21.png "Веб-сайт работает")

    *Веб-сайт работает*
6. Вернитесь на портал и щелкните имя веб-сайта в столбце **имя** , чтобы отобразить страницы управления.

    ![Открытие страниц управления веб-сайтом](aspnet-mvc-4-custom-action-filters/_static/image22.png "Открытие страниц управления веб-сайтом")

    *Открытие страниц управления веб-сайтом*
7. На странице **панель мониторинга** в разделе **краткий обзор** щелкните ссылку **скачать профиль публикации** .

    > [!NOTE]
    > *Профиль публикации* содержит все сведения, необходимые для публикации веб-приложения на веб-сайте Windows Azure для каждого включенного метода публикации. Профиль публикации содержит URL-адреса, учетные данные пользователей и строки для открытия базы данных, которые необходимы для проверки подлинности и подключения к каждой из конечных точек, соответствующей разрешенному методу публикации. **Microsoft WebMatrix 2**, **Microsoft Visual Studio Express для Web** и **Microsoft Visual Studio 2012** поддерживают чтение профилей публикации для автоматизации настройки этих программ для публикации веб-приложений на веб-сайтах Windows Azure.

    ![Скачивание профиля публикации веб-сайта](aspnet-mvc-4-custom-action-filters/_static/image23.png "Скачивание профиля публикации веб-сайта")

    *Скачивание профиля публикации веб-сайта*
8. Скачайте файл профиля публикации в известное расположение. Далее в этом упражнении вы узнаете, как использовать этот файл для публикации веб-приложения на веб-сайтах Windows Azure из Visual Studio.

    ![Сохранение файла профиля публикации](aspnet-mvc-4-custom-action-filters/_static/image24.png "Сохранение профиля публикации")

    *Сохранение файла профиля публикации*

<a id="ApxBTask2"></a>

<a id="Task_2_-_Configuring_the_Database_Server"></a>
#### <a name="task-2---configuring-the-database-server"></a>Задача 2. Настройка сервера базы данных

Если приложение использует SQL Server базы данных, потребуется создать сервер базы данных SQL. Если вы хотите развернуть простое приложение, которое не использует SQL Server вы можете пропустить эту задачу.

1. Для хранения базы данных приложения необходим сервер базы данных SQL. Серверы базы данных SQL можно просмотреть в подписке на портале управления Windows Azure в **базах данных sql** | **серверы** | **панели мониторинга сервера**. Если сервер не создан, можно создать его с помощью кнопки **Добавить** на панели команд. Запишите **имя сервера и URL-адрес, имя для входа администратора и пароль**, так как они будут использоваться в следующих задачах. Пока не создавайте базу данных, так как она будет создана на более позднем этапе.

    ![Панель мониторинга сервера базы данных SQL](aspnet-mvc-4-custom-action-filters/_static/image25.png "Панель мониторинга сервера базы данных SQL")

    *Панель мониторинга сервера базы данных SQL*
2. В следующей задаче вы проверите подключение к базе данных из Visual Studio. по этой причине необходимо включить локальный IP-адрес в список **разрешенных IP-адресов**сервера. Для этого нажмите кнопку **настроить**, выберите IP-адрес из **текущего IP-адреса клиента** и вставьте его в текстовые поля **начальный IP-адрес** и **конечный IP** -адрес и нажмите кнопку ![добавить-клиент-IP – адрес-OK-кнопка](aspnet-mvc-4-custom-action-filters/_static/image26.png).

    ![Добавление IP-адреса клиента](aspnet-mvc-4-custom-action-filters/_static/image27.png)

    *Добавление IP-адреса клиента*
3. После добавления **IP-адреса клиента** в список Разрешенные IP-адреса нажмите кнопку **сохранить** , чтобы подтвердить изменения.

    ![Подтверждение изменений](aspnet-mvc-4-custom-action-filters/_static/image28.png)

    *Подтверждение изменений*

<a id="ApxBTask3"></a>

<a id="Task_3_-_Publishing_an_ASPNET_MVC_4_Application_using_Web_Deploy"></a>
#### <a name="task-3---publishing-an-aspnet-mvc-4-application-using-web-deploy"></a>Задача 3. Публикация приложения ASP.NET MVC 4 с помощью веб-развертывание

1. Вернитесь к решению ASP.NET MVC 4. В **Обозреватель решений**щелкните правой кнопкой мыши проект веб-сайта и выберите **опубликовать**.

    ![Публикация приложения](aspnet-mvc-4-custom-action-filters/_static/image29.png "Публикация приложения")

    *Публикация веб-сайта*
2. Импортируйте профиль публикации, сохраненный в первой задаче.

    ![Импорт профиля публикации](aspnet-mvc-4-custom-action-filters/_static/image30.png "Импорт профиля публикации")

    *Импорт профиля публикации*
3. Щелкните **проверить подключение**. После завершения проверки нажмите кнопку **Далее**.

    > [!NOTE]
    > Проверка завершится, когда появится зеленая галочка рядом с кнопкой проверить подключение.

    ![Проверка подключения](aspnet-mvc-4-custom-action-filters/_static/image31.png "Проверка подключения")

    *Проверка подключения*
4. На странице **Параметры** в разделе **базы данных** нажмите кнопку рядом с текстовым полем подключения к базе данных (т. е. **DefaultConnection**).

    ![Конфигурация веб-развертывания](aspnet-mvc-4-custom-action-filters/_static/image32.png "Конфигурация веб-развертывания")

    *Конфигурация веб-развертывания*
5. Настройте подключение к базе данных следующим образом.

   - В поле **имя сервера** введите URL-адрес сервера базы данных SQL с помощью префикса *TCP:* .
   - В окне **имя пользователя** введите имя для входа администратора сервера.
   - В окне **пароль** введите пароль для входа администратора сервера.
   - Введите новое имя базы данных.

     ![Настройка строки подключения к целевому объекту](aspnet-mvc-4-custom-action-filters/_static/image33.png "Настройка строки подключения к целевому объекту")

     *Настройка строки подключения к целевому объекту*
6. Нажмите кнопку **ОК**. При появлении запроса на создание базы данных нажмите кнопку **Да**.

    ![Создание базы данных](aspnet-mvc-4-custom-action-filters/_static/image34.png "Создание строки базы данных")

    *Создание базы данных*
7. Строка подключения, которая будет использоваться для подключения к базе данных SQL в Windows Azure, отображается в текстовом поле подключения по умолчанию. Затем нажмите кнопку **Далее**.

    ![Строка подключения, указывающая на базу данных SQL](aspnet-mvc-4-custom-action-filters/_static/image35.png "Строка подключения, указывающая на базу данных SQL")

    *Строка подключения, указывающая на базу данных SQL*
8. На странице **Предварительный просмотр** нажмите кнопку **опубликовать**.

    ![Публикация веб-приложения](aspnet-mvc-4-custom-action-filters/_static/image36.png "Публикация веб-приложения")

    *Публикация веб-приложения*
9. По завершении процесса публикации браузер по умолчанию будет открывать опубликованный веб-сайт.

<a id="AppendixC"></a>

<a id="Appendix_C_Using_Code_Snippets"></a>
## <a name="appendix-c-using-code-snippets"></a>Приложение в. Использование фрагментов кода

С помощью фрагментов кода вы можете получить все необходимые вам коды. В лабораторном документе вы узнаете, когда можно использовать их, как показано на следующем рисунке.

![Использование фрагментов кода Visual Studio для вставки кода в проект](aspnet-mvc-4-custom-action-filters/_static/image37.png "Использование фрагментов кода Visual Studio для вставки кода в проект")

*Использование фрагментов кода Visual Studio для вставки кода в проект*

***Добавление фрагмента кода с помощью клавиатуры (C# только)***

1. Поместите курсор в то место, куда вы хотите вставить код.
2. Начните вводить имя фрагмента (без пробелов или дефисов).
3. Посмотрите, как IntelliSense отображает соответствующие имена фрагментов кода.
4. Выберите правильный фрагмент кода (или вводите его, пока не будет выбрано имя всего фрагмента).
5. Дважды нажмите клавишу TAB, чтобы вставить фрагмент в позицию курсора.

![Начните вводить имя фрагмента](aspnet-mvc-4-custom-action-filters/_static/image38.png "Начните вводить имя фрагмента")

*Начните вводить имя фрагмента*

![Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.](aspnet-mvc-4-custom-action-filters/_static/image39.png "Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.")

*Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.*

![Снова нажмите клавишу TAB, и фрагмент развернется](aspnet-mvc-4-custom-action-filters/_static/image40.png "Снова нажмите клавишу TAB, и фрагмент развернется")

*Снова нажмите клавишу TAB, и фрагмент развернется*

***Добавление фрагмента кода с помощью мыши (C#, Visual Basic и XML)*** одного. Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода.

1. Выберите **Вставить фрагмент** , за которым следуют **фрагменты кода**.
2. Выберите соответствующий фрагмент из списка, щелкнув его.

![Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.](aspnet-mvc-4-custom-action-filters/_static/image41.png "Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.")

*Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.*

![Выберите соответствующий фрагмент из списка, щелкнув его.](aspnet-mvc-4-custom-action-filters/_static/image42.png "Выберите соответствующий фрагмент из списка, щелкнув его.")

*Выберите соответствующий фрагмент из списка, щелкнув его.*
