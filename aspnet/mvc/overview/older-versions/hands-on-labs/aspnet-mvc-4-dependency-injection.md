---
uid: mvc/overview/older-versions/hands-on-labs/aspnet-mvc-4-dependency-injection
title: Внедрение зависимостей ASP.NET MVC 4 | Документация Майкрософт
author: rick-anderson
description: Примечание. в этом практическом занятии предполагается, что у вас есть базовые знания о ASP.NET MVC и фильтрах ASP.NET MVC 4. Если вы не использовали фильтры ASP.NET MVC 4 ранее, мы предлагаем...
ms.author: riande
ms.date: 02/18/2013
ms.assetid: 84c7baca-1c54-4c44-8f52-4282122d6acb
msc.legacyurl: /mvc/overview/older-versions/hands-on-labs/aspnet-mvc-4-dependency-injection
msc.type: authoredcontent
ms.openlocfilehash: 15c9d4dcb9e2c6b9f6adf54d65d15737b32cca3b
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78451824"
---
# <a name="aspnet-mvc-4-dependency-injection"></a>Внедрение зависимостей в ASP.NET MVC 4

по [веб-Camp командам](https://twitter.com/webcamps)

[Скачать обучающий комплект Web Camp](https://aka.ms/webcamps-training-kit)

В этой практической лабораторной работе предполагается, что у вас есть базовые знания о **ASP.NET MVC** и **фильтрах ASP.NET MVC 4**. Если вы ранее не использовали **фильтры ASP.NET MVC 4** , рекомендуем вам перейти к практическим занятиям по **фильтрам настраиваемых действий ASP.NET MVC** .

> [!NOTE]
> Все примеры кода и фрагментов включены в комплект обучающих курсов Web Camp, доступный в [выпусках Microsoft Web/вебкамптраинингкит](https://aka.ms/webcamps-training-kit). Проект, относящийся к этой лабораторной работе, доступен по [внедрению зависимостей ASP.NET MVC 4](https://github.com/Microsoft-Web/HOL-MVC4DependencyInjection).

В парадигме **объектно-ориентированного программирования** объекты работают вместе в модели совместной работы, где есть участники и потребители. Естественно, эта модель взаимодействия создает зависимости между объектами и компонентами, что затрудняет управление при увеличении сложности.

![Зависимости классов и сложность модели](aspnet-mvc-4-dependency-injection/_static/image1.png "Зависимости классов и сложность модели")

*Зависимости классов и сложность модели*

Вероятно, вы слышали о **шаблоне фабрики** и разделении между интерфейсом и реализацией с помощью служб, где клиентские объекты часто отвечают за обнаружение службы.

Шаблон внедрения зависимостей является конкретной реализацией инверсии элемента управления. **Инверсия управления (IOC)** означает, что объекты не создают другие объекты, от которых зависит работа. Вместо этого они получают объекты, необходимые для внешнего источника (например, XML-файл конфигурации).

**Внедрение зависимостей (DI)** означает, что это делается без вмешательства объекта, обычно с помощью компонента платформы, который передает параметры конструктора и устанавливает свойства.

<a id="The_Dependency_Injection_DI_Design_Pattern"></a>
### <a name="the-dependency-injection-di-design-pattern"></a>Шаблон разработки внедрения зависимостей (DI)

На высоком уровне цель внедрения зависимостей заключается в том, что клиентский класс (например *, элементу гольфа*) должен удовлетворять определенному интерфейсу (например, *иклуб*). Не имеет значения, какой конкретный тип (например *, вудклуб, иронклуб, веджеклуб* или *путтерклуб*), он хочет, чтобы кто-то другой обработал это (например, хороший *Кадди*). Сопоставитель зависимостей в ASP.NET MVC позволяет зарегистрировать логику зависимости в другом месте (например, в контейнере или контейнере *треф*).

![Схема внедрения зависимостей](aspnet-mvc-4-dependency-injection/_static/image2.png "Иллюстрация внедрения зависимостей")

*Внедрение зависимостей — аналогия гольфа*

Ниже перечислены преимущества использования шаблона внедрения зависимостей и инверсии управления.

- Сокращение взаимосвязей классов
- Увеличение повторного использования кода
- Улучшение поддержки кода
- Улучшение тестирования приложений

> [!NOTE]
> Внедрение зависимостей иногда сравнивается с абстрактным шаблоном проектирования фабрики, но существует небольшая разница между обоими способами. В среде внедрения инфраструктура, работающая над разрешениями зависимостей, вызывает фабрики и зарегистрированные службы.

Теперь, когда вы понимаете шаблон внедрения зависимостей, вы узнаете в этой лабораторной работе, как применить ее в ASP.NET MVC 4. Вы начнете использовать внедрение зависимостей на **контроллерах** для включения службы доступа к базе данных. Далее вы примените внедрение зависимостей к **представлениям** для использования службы и отображения информации. Наконец, вы расширяете модель DI на ASP.NET MVC 4 Filters, добавляя настраиваемый фильтр действий в решение.

В этой практической лабораторной работе вы узнаете, как выполнять следующие задачи:

- Интеграция ASP.NET MVC 4 с Unity для внедрения зависимостей с помощью пакетов NuGet
- Использование внедрения зависимостей в контроллере MVC ASP.NET
- Использование внедрения зависимостей в представлении MVC ASP.NET
- Использовать внедрение зависимостей в фильтре действий MVC ASP.NET

> [!NOTE]
> В этом лабораторном занятии используется пакет NuGet для Unity. Mvc3 для разрешения зависимостей, но можно адаптировать любую инфраструктуру внедрения зависимостей для работы с ASP.NET MVC 4.

<a id="Prerequisites"></a>

<a id="Prerequisites"></a>
### <a name="prerequisites"></a>предварительные требования

Для выполнения этой лабораторной работы необходимо иметь следующие элементы:

- [Microsoft Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/eng/products/visual-studio-express-for-web) или старше (см. [приложение а](#AppendixA) для получения инструкций по его установке).

<a id="Setup"></a>

<a id="Setup"></a>
### <a name="setup"></a>Настройка

**Установка фрагментов кода**

Для удобства большая часть кода, который вы будете управлять в этой лаборатории, доступна в виде фрагментов кода Visual Studio. Чтобы установить фрагменты кода, запустите файл **.\саурце\сетуп\кодесниппетс.ВСИ** .

Если вы не знакомы с фрагментами кода Visual Studio Code и хотите узнать, как их использовать, можно обратиться к приложению из этого документа &quot;[приложении б. Использование фрагментов кода](#AppendixB)&quot;.

---

<a id="Exercises"></a>

<a id="Exercises"></a>
## <a name="exercises"></a>Полнят

Эта практическая лабораторная работа состоит из следующих упражнений:

1. [Упражнение 1. Внедрение контроллера](#Exercise1)
2. [Упражнение 2. Внедрение представления](#Exercise2)
3. [Упражнение 3. Внедрение фильтров](#Exercise3)

> [!NOTE]
> Каждое упражнение сопровождается **конечной** папкой, содержащей итоговое решение, которое следует получить после завершения упражнений. Это решение можно использовать в качестве инструкции, если вам нужна дополнительная помощь по работе с упражнениями.

Предполагаемое время выполнения этой лабораторной работы: **30 минут**.

<a id="Exercise1"></a>

<a id="Exercise_1_Injecting_a_Controller"></a>
### <a name="exercise-1-injecting-a-controller"></a>Упражнение 1. Внедрение контроллера

В этом упражнении вы узнаете, как использовать внедрение зависимостей в контроллерах MVC ASP.NET, интегрируя Unity с помощью пакета NuGet. По этой причине вы включите службы в контроллеры Мвкмусиксторе, чтобы отделить логику от доступа к данным. Службы будут создавать новую зависимость в конструкторе контроллера, которая будет разрешаться с помощью внедрения зависимостей в справке **Unity**.

Этот подход показывает, как создавать менее взаимосвязанные приложения, которые являются более гибкими и простыми в обслуживании и тестировании. Вы также узнаете, как интегрировать ASP.NET MVC с Unity.

<a id="About_StoreManager_Service"></a>
#### <a name="about-storemanager-service"></a>Сведения о службе Стореманажер

Музыкальное хранилище MVC, предоставленное в начале решения, теперь содержит службу, которая управляет данными контроллера хранилища с именем **сторесервице**. Ниже будет обнаружена реализация службы магазина. Обратите внимание, что все методы возвращают сущности модели.

[!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample1.cs)]

**Стореконтроллер** из начального решения теперь использует **сторесервице**. Все ссылки на данные были удалены из **стореконтроллер**и теперь можно изменить текущий поставщик доступа к данным, не изменяя метод, использующий **сторесервице**.

Ниже вы увидите, что реализация **стореконтроллер** имеет зависимость с **сторесервице** в конструкторе класса.

> [!NOTE]
> Зависимость, представленная в этом упражнении, связана с инверсией **управления** (IOC).
> 
> Конструктор класса **стореконтроллер** получает параметр типа **исторесервице** , который необходим для выполнения вызовов служб внутри класса. Однако **стореконтроллер** не реализует конструктор по умолчанию (без параметров), который необходим любому контроллеру для работы с ASP.NET MVC.
> 
> Для разрешения зависимости контроллер должен быть создан абстрактной фабрикой (класс, возвращающий любой объект указанного типа).

[!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample2.cs)]

> [!NOTE]
> При попытке класса создать Стореконтроллер без отправки объекта службы возникнет ошибка, так как конструктор без параметров не объявлен.

<a id="Ex1Task1"></a>

<a id="Task_1_-_Running_the_Application"></a>
#### <a name="task-1---running-the-application"></a>Задача 1. Запуск приложения

В этой задаче будет запущено приложение Begin, которое включает службу в контроллер хранилища, который отделяет доступ к данным от логики приложения.

При запуске приложения будет получено исключение, так как служба контроллера не передается как параметр по умолчанию:

1. Откройте **Начальное** решение, расположенное в **Source\Ex01-Injecting контроллер\бегин**.

   1. Перед продолжением необходимо загрузить некоторые недостающие пакеты NuGet. Для этого в меню **проект** выберите пункт **Управление пакетами NuGet**.
   2. В диалоговом окне **Управление пакетами NuGet** нажмите кнопку **восстановить** , чтобы скачать недостающие пакеты.
   3. Наконец, создайте решение, щелкнув **build** | **Build Solution**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является то, что вам не нужно поставлять все библиотеки в проекте, уменьшая размер проекта. С помощью средств управления питанием NuGet, указав версии пакетов в файле Packages. config, вы сможете скачать все необходимые библиотеки при первом запуске проекта. Именно поэтому после открытия существующего решения из этой лабораторной работы потребуется выполнить следующие действия.
2. Нажмите клавиши **CTRL + F5** , чтобы запустить приложение без отладки. Вы получите сообщение об ошибке, &quot;**для этого объекта не определен конструктор без параметров** ,&quot;:

    ![Ошибка при запуске приложения ASP.NET MVC](aspnet-mvc-4-dependency-injection/_static/image3.png "Ошибка при запуске приложения ASP.NET MVC")

    *Ошибка при запуске приложения ASP.NET MVC*
3. Закройте браузер.

В следующих шагах вы будете работать с решением "музыкальное хранилище" для внедрения зависимости, необходимого для этого контроллера.

<a id="Ex1Task2"></a>

<a id="Task_2_-_Including_Unity_into_MvcMusicStore_Solution"></a>
#### <a name="task-2---including-unity-into-mvcmusicstore-solution"></a>Задача 2. Включение Unity в решение Мвкмусиксторе

В этой задаче в решение будет включен пакет NuGet **Unity. Mvc3** .

> [!NOTE]
> Пакет Unity. Mvc3 был разработан для ASP.NET MVC 3, но полностью совместим с ASP.NET MVC 4.
> 
> Unity — это упрощенный расширяемый контейнер внедрения зависимостей с дополнительной поддержкой перехвата экземпляра и типа. Это контейнер общего назначения для использования в любом типе приложения .NET. Он предоставляет все общие функции, доступные в механизме внедрения зависимостей, включая создание объектов, абстракцию требований путем указания зависимостей во время выполнения и гибкость, откладывая конфигурацию компонента на контейнер.

1. Установите пакет NuGet **Unity. Mvc3** в проект **мвкмусиксторе** . Для этого откройте **консоль диспетчера пакетов** из окна **Просмотр** | **других окон**.
2. Выполните следующую команду.

    PMC

    [!code-powershell[Main](aspnet-mvc-4-dependency-injection/samples/sample3.ps1)]

    ![Установка пакета NuGet для Unity. Mvc3](aspnet-mvc-4-dependency-injection/_static/image4.png "Установка пакета NuGet для Unity. Mvc3")

    *Установка пакета NuGet для Unity. Mvc3*
3. После установки пакета **Unity. Mvc3** изучите файлы и папки, которые он добавляет автоматически, чтобы упростить настройку Unity.

    ![Установлен пакет Unity. Mvc3](aspnet-mvc-4-dependency-injection/_static/image5.png "Установлен пакет Unity. Mvc3")

    *Установлен пакет Unity. Mvc3*

<a id="Ex1Task3"></a>

<a id="Task_3_-_Registering_Unity_in_Globalasaxcs_Application_Start"></a>
#### <a name="task-3---registering-unity-in-globalasaxcs-application_start"></a>Задача 3. Регистрация Unity в приложении Global.asax.cs\_запуск

В этой задаче будет обновлен метод **\_запуск приложения** , расположенный в **Global.asax.CS** , чтобы вызвать инициализатор загрузчика Unity, а затем обновить файл загрузчика, регистрирующий службу и контроллер, которые будут использоваться для внедрения зависимостей.

1. Теперь необходимо подключить загрузчик, который является файлом, который инициализирует контейнер Unity и сопоставитель зависимостей. Для этого откройте **Global.asax.CS** и добавьте следующий выделенный код в метод **\_запуска приложения** .

    (Фрагмент кода — *Лаборатория внедрения зависимостей ASP.NET-Ex01-Initialize Unity*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample4.cs)]
2. Откройте файл **bootstrapper.CS** .
3. Включите следующие пространства имен: **мвкмусиксторе. Services** и **мусиксторе. Controllers**.

    (Фрагмент кода — *ASP.NET внедрения зависимостей — Ex01 — начальный загрузчик, добавляющий пространства имен*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample5.cs)]
4. Замените содержимое метода **буилдунитиконтаинер** следующим кодом, который регистрирует контроллер хранилища и службу хранилища.

    (Фрагмент кода — *Лаборатория внедрения зависимостей ASP.NET — Ex01 — контроллер и служба регистрации магазина*).

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample6.cs)]

<a id="Ex1Task4"></a>

<a id="Task_4_-_Running_the_Application"></a>
#### <a name="task-4---running-the-application"></a>Задача 4. Запуск приложения

В этой задаче будет запущено приложение, чтобы убедиться, что теперь его можно загрузить после включения Unity.

1. Нажмите клавишу **F5** для запуска приложения. Теперь приложение должно загружаться без отображения сообщения об ошибке.

    ![Выполнение приложения с внедрением зависимостей](aspnet-mvc-4-dependency-injection/_static/image6.png "Выполнение приложения с внедрением зависимостей")

    *Выполнение приложения с внедрением зависимостей*
2. Перейдите по **/Store**. Это вызовет **стореконтроллер**, который теперь создается с помощью **Unity**.

    ![Музыкальное хранилище MVC](aspnet-mvc-4-dependency-injection/_static/image7.png "Музыкальное хранилище MVC")

    *Музыкальное хранилище MVC*
3. Закройте браузер.

В следующих упражнениях вы узнаете, как расширить область внедрения зависимостей, чтобы она использовалась внутри ASP.NET представлений MVC и фильтров действий.

<a id="Exercise2"></a>

<a id="Exercise_2_Injecting_a_View"></a>
### <a name="exercise-2-injecting-a-view"></a>Упражнение 2. Внедрение представления

В этом упражнении вы узнаете, как использовать внедрение зависимостей в представлении с новыми функциями ASP.NET MVC 4 для интеграции Unity. Для этого необходимо вызвать пользовательскую службу в представлении обзора магазина, где будет отображаться сообщение и изображение ниже.

Затем вы интегрируете проект с Unity и создаете пользовательский сопоставитель зависимостей для внедрения зависимостей.

<a id="Ex2Task1"></a>

<a id="Task_1_-_Creating_a_View_that_Consumes_a_Service"></a>
#### <a name="task-1---creating-a-view-that-consumes-a-service"></a>Задача 1. Создание представления, использующего службу

В этой задаче будет создано представление, которое выполняет вызов службы для создания новой зависимости. Служба включает в себя простую службу обмена сообщениями, входящую в это решение.

1. Откройте **Начальное** решение, расположенное в папке **Source\Ex02-Injecting виев\бегин** . В противном случае вы можете продолжать **использовать решение, полученное в результате** выполнения предыдущего упражнения.

   1. Если вы открыли предоставленное **Начальное** решение, перед продолжением потребуется загрузить некоторые недостающие пакеты NuGet. Для этого в меню **проект** выберите пункт **Управление пакетами NuGet**.
   2. В диалоговом окне **Управление пакетами NuGet** нажмите кнопку **восстановить** , чтобы скачать недостающие пакеты.
   3. Наконец, создайте решение, щелкнув **build** | **Build Solution**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является то, что вам не нужно поставлять все библиотеки в проекте, уменьшая размер проекта. С помощью средств управления питанием NuGet, указав версии пакетов в файле Packages. config, вы сможете скачать все необходимые библиотеки при первом запуске проекта. Именно поэтому после открытия существующего решения из этой лабораторной работы потребуется выполнить следующие действия.
      > 
      > Дополнительные сведения см. в этой статье: [http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages](http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages).
2. Включите классы **MessageService.CS** и **IMessageService.CS** , расположенные в папке **Source \ассетс** в **/сервицес**. Для этого щелкните правой кнопкой мыши папку **службы** и выберите команду **Добавить существующий элемент**. Перейдите к расположению файлов и включите их.

    ![Добавление службы сообщений и интерфейса службы](aspnet-mvc-4-dependency-injection/_static/image8.png "Добавление службы сообщений и интерфейса службы")

    *Добавление службы сообщений и интерфейса службы*

    > [!NOTE]
    > Интерфейс **имессажесервице** определяет два свойства, реализуемых классом **мессажесервице** . Эти свойства —**Message** и **ImageUrl**— хранят сообщение и URL-адрес отображаемого изображения.
3. Создайте папку **/pages** в корневой папке проекта, а затем добавьте существующий класс **MyBasePage.CS** из **саурце\ассетс**. Базовая страница, от которой будет осуществляться наследование, имеет следующую структуру.

    ![Папка "страницы"](aspnet-mvc-4-dependency-injection/_static/image9.png "Папка Pages")

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample7.cs)]
4. Откройте представление **Browse. cshtml** из папки **/виевс/Сторе** и сделайте его производным от **MyBasePage.CS**.

    [!code-cshtml[Main](aspnet-mvc-4-dependency-injection/samples/sample8.cshtml)]
5. В представлении **Обзор** добавьте вызов **мессажесервице** , чтобы отобразить изображение и сообщение, полученное службой.
   C#

    [!code-cshtml[Main](aspnet-mvc-4-dependency-injection/samples/sample9.cshtml)]

<a id="Ex2Task2"></a>

<a id="Task_2_-_Including_a_Custom_Dependency_Resolver_and_a_Custom_View_Page_Activator"></a>
#### <a name="task-2---including-a-custom-dependency-resolver-and-a-custom-view-page-activator"></a>Задача 2. Включение пользовательского сопоставителя зависимостей и активатора страниц пользовательского представления

В предыдущей задаче вы вставили новую зависимость внутри представления для выполнения вызова службы внутри нее. Теперь вы разрешите эту зависимость, реализовав интерфейсы внедрения зависимостей ASP.NET MVC **ивиевпажеактиватор** и **IDependencyResolver**. В решение будет включена реализация **IDependencyResolver** , которая будет работать с извлечением службы с помощью Unity. Затем будет включена еще одна пользовательская реализация интерфейса **ивиевпажеактиватор** , позволяющая создавать представления.

> [!NOTE]
> Начиная с ASP.NET MVC 3, реализация внедрения зависимостей упростила интерфейсы для регистрации служб. **IDependencyResolver** и **ивиевпажеактиватор** являются частью функций ASP.NET MVC 3 для внедрения зависимостей.
> 
> **-Интерфейс IDependencyResolver** заменяет предыдущий имвксервицелокатор. Разработчики IDependencyResolver должны возвращать экземпляр службы или коллекции служб.
> 
> 
> [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample10.cs)]
> 
> Интерфейс **ивиевпажеактиватор** обеспечивает более детализированный контроль над созданием экземпляров страниц представления с помощью внедрения зависимостей. Классы, реализующие интерфейс **ивиевпажеактиватор** , могут создавать экземпляры представления, используя сведения о контексте.
> 
> 
> [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample11.cs)]

1. Создайте папку**фабрики** или в корневой папке проекта.
2. Включите **CustomViewPageActivator.CS** в решение из папки **/саурцес/Ассетс/** to **фабрики** . Для этого щелкните правой кнопкой мыши папку **/факториес** и выберите **Добавить | Существующий элемент** , а затем выберите **CustomViewPageActivator.CS**. Этот класс реализует интерфейс **ивиевпажеактиватор** для хранения контейнера Unity.

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample12.cs)]

    > [!NOTE]
    > **Кустомвиевпажеактиватор** отвечает за управление созданием представления с помощью контейнера Unity.
3. Включить файл **UnityDependencyResolver.CS** из папки **/саурцес/Ассетс** в **/факториес** . Для этого щелкните правой кнопкой мыши папку **/факториес** и выберите **Добавить | Существующий элемент** , а затем выберите **UnityDependencyResolver.CS** File.

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample13.cs)]

    > [!NOTE]
    > Класс **унитидепенденциресолвер** является пользовательским Депенденциресолвер для Unity. Если службу не удается найти в контейнере Unity, базовый сопоставитель — инвокатед.

В следующей задаче будут зарегистрированы обе реализации, чтобы модель знала расположение служб и представлений.

<a id="Ex2Task3"></a>

<a id="Task_3_-_Registering_for_Dependency_Injection_within_Unity_container"></a>
#### <a name="task-3---registering-for-dependency-injection-within-unity-container"></a>Задача 3. Регистрация внедрения зависимостей в контейнере Unity

В этой задаче все предыдущие элементы будут размещены вместе, чтобы сделать внедрение зависимостей.

Теперь решение содержит следующие элементы:

- Представление **просмотра** , наследуемое от **мибасекласс** и использующее **мессажесервице**.
- Промежуточный класс-**мибасекласс**, имеющий внедрение зависимостей, объявленное для интерфейса службы.
- Служба — **мессажесервице** — и ее интерфейс **имессажесервице**.
- Пользовательский сопоставитель зависимостей для Unity- **унитидепенденциресолвер** , который работает с извлечением служб.
- Активатор страницы представления — **кустомвиевпажеактиватор** , который создает страницу.

Чтобы вставить представление " **Обзор** ", теперь можно зарегистрировать пользовательский сопоставитель зависимостей в контейнере Unity.

1. Откройте файл **bootstrapper.CS** .
2. Зарегистрируйте экземпляр **мессажесервице** в контейнере Unity для инициализации службы:

    (Фрагмент кода — *Лаборатория внедрения зависимостей ASP.NET — Ex02 — регистрация сообщений Service*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample14.cs)]
3. Добавьте ссылку на пространство имен **мвкмусиксторе. фабрики** .

    (Фрагмент кода — *ASP.NET внедрения зависимостей Lab-Ex02-фабрики*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample15.cs)]
4. Зарегистрировать **кустомвиевпажеактиватор** в качестве активатора страницы представления в контейнере Unity:

    (Фрагмент кода — *Лаборатория внедрения зависимостей ASP.NET — Ex02 — Register кустомвиевпажеактиватор*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample16.cs)]
5. Замените сопоставитель зависимостей по умолчанию ASP.NET MVC 4 экземпляром **унитидепенденциресолвер**. Для этого замените содержимое метода **Initialize** следующим кодом:

    (Фрагмент кода — *ASP.NET внедрения зависимостей в лаборатории — Ex02 — сопоставитель зависимостей обновления*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample17.cs)]

    > [!NOTE]
    > ASP.NET MVC предоставляет класс сопоставителя зависимостей по умолчанию. Для работы с пользовательскими арбитрами конфликтов, созданными для Unity, этот сопоставитель необходимо заменить.

<a id="Ex2Task4"></a>

<a id="Task_4_-_Running_the_Application"></a>
#### <a name="task-4---running-the-application"></a>Задача 4. Запуск приложения

В этой задаче будет запущено приложение для проверки того, что обозреватель магазина использует службу и показывает изображение и полученное сообщение:

1. Нажмите клавишу **F5** для запуска приложения.
2. Щелкните **рок** в меню жанры и посмотрите, как **мессажесервице** был вставлен в представление и загрузили приветственное сообщение и изображение. В этом примере мы будем вводить &quot;**рок**&quot;:

    ![Музыкальное хранилище MVC — введение в представление](aspnet-mvc-4-dependency-injection/_static/image10.png "Музыкальное хранилище MVC — введение в представление")

    *Музыкальное хранилище MVC — введение в представление*
3. Закройте браузер.

<a id="Exercise3"></a>

<a id="Exercise_3_Injecting_Action_Filters"></a>
### <a name="exercise-3-injecting-action-filters"></a>Упражнение 3. Внедрение фильтров действий

В предыдущем практическом занятии **фильтры настраиваемых действий** работали с настройками и внедрением фильтров. В этом упражнении вы узнаете, как внедрять фильтры с внедрением зависимостей с помощью контейнера Unity. Для этого вы добавите в решение "музыкальное хранилище" настраиваемый фильтр действий, который будет отслеживать активность сайта.

<a id="Ex3Task1"></a>

<a id="Task_1_-_Including_the_Tracking_Filter_in_the_Solution"></a>
#### <a name="task-1---including-the-tracking-filter-in-the-solution"></a>Задача 1. Включение фильтра отслеживания в решение

В этой задаче вы включите в музыкальное хранилище пользовательский фильтр действий для трассировки событий. Поскольку основные понятия фильтра действий уже обрабатываются в предыдущей лаборатории &quot;фильтры настраиваемых действий&quot;, вы просто включаете класс Filter из папки Assets этой лабораторной работы, а затем создаете поставщик фильтра для Unity:

1. Откройте **Начальное** решение, расположенное в папке **Source\Ex03 действие филтер\бегин** . В противном случае вы можете продолжать **использовать решение, полученное в результате** выполнения предыдущего упражнения.

   1. Если вы открыли предоставленное **Начальное** решение, перед продолжением потребуется загрузить некоторые недостающие пакеты NuGet. Для этого в меню **проект** выберите пункт **Управление пакетами NuGet**.
   2. В диалоговом окне **Управление пакетами NuGet** нажмите кнопку **восстановить** , чтобы скачать недостающие пакеты.
   3. Наконец, создайте решение, щелкнув **build** | **Build Solution**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является то, что вам не нужно поставлять все библиотеки в проекте, уменьшая размер проекта. С помощью средств управления питанием NuGet, указав версии пакетов в файле Packages. config, вы сможете скачать все необходимые библиотеки при первом запуске проекта. Именно поэтому после открытия существующего решения из этой лабораторной работы потребуется выполнить следующие действия.
      > 
      > Дополнительные сведения см. в этой статье: [http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages](http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages).
2. Включить файл **TraceActionFilter.CS** из папки **/саурцес/Ассетс** в **/Филтерс** .

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample18.cs)]

    > [!NOTE]
    > Этот настраиваемый фильтр действий выполняет трассировку ASP.NET. Вы можете проверить &quot;ASP.NET MVC 4 локальные и динамические фильтры действий&quot; лабораторию для получения дополнительной справки.
3. Добавьте пустой класс **FilterProvider.CS** в проект в папке **/Филтерс.**
4. Добавьте пространства имен **System. Web. MVC** и **Microsoft. Practices. Unity** в **FilterProvider.CS**.

    (Фрагмент кода: *Лаборатория внедрения зависимостей ASP.NET — Ex03 — поставщик фильтра, добавляющий пространства имен*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample19.cs)]
5. Сделайте класс производным от интерфейса **ифилтерпровидер** .

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample20.cs)]
6. Добавьте свойство **иунитиконтаинер** в класс **филтерпровидер** , а затем создайте конструктор класса, чтобы назначить контейнер.

    (Фрагмент кода — *ASP.NET внедрения зависимостей — Ex03 — конструктор поставщика фильтра*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample21.cs)]

    > [!NOTE]
    > Конструктор класса фильтра поставщика не создает **Новый** объект внутри. Контейнер передается в качестве параметра, и зависимость разрешается Unity.
7. В классе **филтерпровидер** реализуйте метод, используя **фильтры** из интерфейса **ифилтерпровидер** .

    (Фрагмент кода: *Лаборатория внедрения зависимостей ASP.NET — Ex03 — фильтры поставщика*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample22.cs)]

<a id="Ex3Task2"></a>

<a id="Task_2_-_Registering_and_Enabling_the_Filter"></a>
#### <a name="task-2---registering-and-enabling-the-filter"></a>Задача 2. Регистрация и включение фильтра

В этой задаче будет включено отслеживание сайта. Для этого необходимо зарегистрировать фильтр в методе **bootstrapper.CS буилдунитиконтаинер** , чтобы начать трассировку:

1. Откройте **файл Web. config** , расположенный в корневом каталоге проекта, и включите отслеживание трассировки в группе System. Web.

    [!code-xml[Main](aspnet-mvc-4-dependency-injection/samples/sample23.xml)]
2. Откройте **bootstrapper.CS** в корневом каталоге проекта.
3. Добавьте ссылку на пространство имен **мвкмусиксторе. Filters** .

    (Фрагмент кода — *ASP.NET внедрения зависимостей — Ex03 — начальный загрузчик, добавляющий пространства имен*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample24.cs)]
4. Выберите метод **буилдунитиконтаинер** и зарегистрируйте фильтр в контейнере Unity. Вам потребуется зарегистрировать поставщик фильтра, а также фильтр действий.

    (Фрагмент кода — *Лаборатория внедрения зависимостей ASP.NET — Ex03 — Register филтерпровидер и ActionFilter*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample25.cs)]

<a id="Ex3Task3"></a>

<a id="Task_3_-_Running_the_Application"></a>
#### <a name="task-3---running-the-application"></a>Задача 3. Запуск приложения

В этой задаче будет запущено приложение и выполнена проверка того, что настраиваемый фильтр действий выполняет трассировку действия:

1. Нажмите клавишу **F5** для запуска приложения.
2. Щелкните **рок** в меню жанры. При необходимости можно перейти к дополнительным жанрам.

    ![Приложение Music Store](aspnet-mvc-4-dependency-injection/_static/image11.png "Приложение Music Store")

    *Приложение Music Store*
3. Перейдите к **/траце.аксд** , чтобы открыть страницу трассировка приложения, а затем щелкните **Просмотреть сведения**.

    ![Журнал трассировки приложения](aspnet-mvc-4-dependency-injection/_static/image12.png "Журнал трассировки приложения")

    *Журнал трассировки приложения*

    ![Трассировка приложения — сведения о запросе](aspnet-mvc-4-dependency-injection/_static/image13.png "Трассировка приложения — сведения о запросе")

    *Трассировка приложения — сведения о запросе*
4. Закройте браузер.

---

<a id="Summary"></a>

<a id="Summary"></a>
## <a name="summary"></a>Сводка

Выполнив эту практическое лабораторное занятие, вы узнали, как использовать внедрение зависимостей в ASP.NET MVC 4 путем интеграции Unity с помощью пакета NuGet. Для этого вы использовали внедрение зависимостей внутри контроллеров, представлений и фильтров действий.

Были рассмотрены следующие концепции:

- Функции внедрения зависимостей ASP.NET MVC 4
- Интеграция Unity с помощью пакета NuGet для Unity. Mvc3
- Внедрение зависимостей в контроллерах
- Внедрение зависимостей в представления
- Внедрение зависимостей фильтров действий

<a id="AppendixA"></a>

<a id="Appendix_A_Installing_Visual_Studio_Express_2012_for_Web"></a>
## <a name="appendix-a-installing-visual-studio-express-2012-for-web"></a>Приложение а. Установка Visual Studio Express 2012 для Web

Вы можете установить **Microsoft Visual Studio Express 2012 для Web** или другой &quot;Express&quot; версии с помощью **[установщик веб-платформы Майкрософт](https://www.microsoft.com/web/downloads/platform.aspx)** . Следующие инструкции помогут вам выполнить действия, необходимые для установки *Visual Studio Express 2012 для Web* с помощью *установщик веб-платформы Майкрософт*.

1. Перейдите на сайт [https://go.microsoft.com/?linkid=9810169](https://go.microsoft.com/?linkid=9810169). Кроме того, если у вас уже установлен установщик веб-платформы, вы можете открыть его и найти продукт &quot;<em>Visual Studio Express 2012 для Web с Windows Azure SDK</em>&quot;.
2. Щелкните **Install Now (установить сейчас**). Если у вас нет **установщика веб-платформы** , вы будете сначала перенаправлены на загрузку и установку.
3. После открытия **установщика веб-платформы** нажмите кнопку **установить** , чтобы начать установку.

    ![Установка Visual Studio Express](aspnet-mvc-4-dependency-injection/_static/image14.png "Установка Visual Studio Express")

    *Установка Visual Studio Express*
4. Прочитайте все лицензии и условия продуктов и нажмите кнопку " **принять** ", чтобы продолжить.

    ![Принятие условий лицензии](aspnet-mvc-4-dependency-injection/_static/image15.png)

    *Принятие условий лицензии*
5. Дождитесь завершения процесса загрузки и установки.

    ![Ход установки](aspnet-mvc-4-dependency-injection/_static/image16.png)

    *Ход установки*
6. После завершения установки нажмите кнопку **Готово**.

    ![Установка завершена](aspnet-mvc-4-dependency-injection/_static/image17.png)

    *Установка завершена*
7. Нажмите кнопку **выход** , чтобы закрыть установщик веб-платформы.
8. Чтобы открыть Visual Studio Express для Интернета, перейдите на **начальный** экран и начните запись &quot;**VS Express**&quot;, а затем щелкните плитку **VS Express для Web** .

    ![Плитка VS Express для Web](aspnet-mvc-4-dependency-injection/_static/image18.png)

    *Плитка VS Express для Web*

<a id="AppendixB"></a>

<a id="Appendix_B_Using_Code_Snippets"></a>
## <a name="appendix-b-using-code-snippets"></a>Приложение б. Использование фрагментов кода

С помощью фрагментов кода вы можете получить все необходимые вам коды. В лабораторном документе вы узнаете, когда можно использовать их, как показано на следующем рисунке.

![Использование фрагментов кода Visual Studio для вставки кода в проект](aspnet-mvc-4-dependency-injection/_static/image19.png "Использование фрагментов кода Visual Studio для вставки кода в проект")

*Использование фрагментов кода Visual Studio для вставки кода в проект*

***Добавление фрагмента кода с помощью клавиатуры (C# только)***

1. Поместите курсор в то место, куда вы хотите вставить код.
2. Начните вводить имя фрагмента (без пробелов или дефисов).
3. Посмотрите, как IntelliSense отображает соответствующие имена фрагментов кода.
4. Выберите правильный фрагмент кода (или вводите его, пока не будет выбрано имя всего фрагмента).
5. Дважды нажмите клавишу TAB, чтобы вставить фрагмент в позицию курсора.

![Начните вводить имя фрагмента](aspnet-mvc-4-dependency-injection/_static/image20.png "Начните вводить имя фрагмента")

*Начните вводить имя фрагмента*

![Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.](aspnet-mvc-4-dependency-injection/_static/image21.png "Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.")

*Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.*

![Снова нажмите клавишу TAB, и фрагмент развернется](aspnet-mvc-4-dependency-injection/_static/image22.png "Снова нажмите клавишу TAB, и фрагмент развернется")

*Снова нажмите клавишу TAB, и фрагмент развернется*

***Добавление фрагмента кода с помощью мыши (C#, Visual Basic и XML)*** одного. Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода.

1. Выберите **Вставить фрагмент** , за которым следуют **фрагменты кода**.
2. Выберите соответствующий фрагмент из списка, щелкнув его.

![Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.](aspnet-mvc-4-dependency-injection/_static/image23.png "Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.")

*Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.*

![Выберите соответствующий фрагмент из списка, щелкнув его.](aspnet-mvc-4-dependency-injection/_static/image24.png "Выберите соответствующий фрагмент из списка, щелкнув его.")

*Выберите соответствующий фрагмент из списка, щелкнув его.*
