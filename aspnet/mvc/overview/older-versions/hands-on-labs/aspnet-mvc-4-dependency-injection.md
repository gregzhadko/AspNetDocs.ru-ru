---
uid: mvc/overview/older-versions/hands-on-labs/aspnet-mvc-4-dependency-injection
title: Внедрение зависимостей в ASP.NET MVC 4 | Документация Майкрософт
author: rick-anderson
description: Примечание. Это Практическое лабораторное занятие предполагает, что у вас есть базовые знания о ASP.NET MVC и ASP.NET MVC 4 фильтры. Если вы не использовали фильтров ASP.NET MVC 4 до, мы rec...
ms.author: riande
ms.date: 02/18/2013
ms.assetid: 84c7baca-1c54-4c44-8f52-4282122d6acb
msc.legacyurl: /mvc/overview/older-versions/hands-on-labs/aspnet-mvc-4-dependency-injection
msc.type: authoredcontent
ms.openlocfilehash: 86781a1f46ce0c01a5d70b1f0cf8a81f3f96a032
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59405928"
---
# <a name="aspnet-mvc-4-dependency-injection"></a>Внедрение зависимостей в ASP.NET MVC 4

по [Web Слышатся Team](https://twitter.com/webcamps)

[Скачайте комплект учебных материалов по лагеря Web](https://aka.ms/webcamps-training-kit)

Это Практическое лабораторное занятие предполагается, что у вас есть базовые знания о **ASP.NET MVC** и **фильтров ASP.NET MVC 4**. Если вы не использовали **фильтров ASP.NET MVC 4** раньше, мы рекомендуем к превышению **настраиваемые действия ASP.NET MVC фильтры** Практическое лабораторное занятие.

> [!NOTE]
> Все примеры кода и фрагменты кода включены в Web лагеря комплект обучающих материалов, доступных из в [выпуски Microsoft Web/WebCampTrainingKit](https://aka.ms/webcamps-training-kit). Проект, относящиеся к этой лаборатории доступен в [внедрения зависимостей ASP.NET MVC 4](https://github.com/Microsoft-Web/HOL-MVC4DependencyInjection).

В **объектно-ориентированного программирования** парадигма, совместной работы объектов в модели совместной работы которых содержится участники и потребителей. Естественно эта модель связи приводит к возникновению ошибки зависимости между объектами и компонентами, становится сложно управлять при увеличении сложности.

![Класс зависимостей и сложность модели](aspnet-mvc-4-dependency-injection/_static/image1.png "класса зависимости и сложность модели")

*Класс зависимостей и сложность модели*

Вы, вероятно, слышали о **шаблон фабрики** и разделение между интерфейсом и реализации, с помощью служб, где клиентские объекты часто отвечают за расположение службы.

Шаблон внедрения зависимостей является конкретной реализацией Inversion of Control. **Инверсии управления (IoC)** означает, что объекты не создавайте другие объекты, на которые они используют для выполнения своих задач. Вместо этого они получают объекты, которые им необходимы из внешнего источника (например, файл конфигурации xml).

**Внедрение зависимостей (DI)** означает, что это сделать без вмешательства объекта, как правило, компонентом платформы, который передает параметры конструктора и задайте свойства.

<a id="The_Dependency_Injection_DI_Design_Pattern"></a>
### <a name="the-dependency-injection-di-design-pattern"></a>Шаблон разработки внедрения зависимостей

На высоком уровне, внедрение зависимостей призвано, класс клиента (например *golfer*) требуется что-нибудь, удовлетворяющий интерфейс (например *IClub*). Безразлично, что такое конкретный тип (например *WedgeClub WoodClub IronClub,* или *PutterClub*), ему кто-то другой для обработки, (например хорошее *caddy*). Сопоставитель зависимостей в ASP.NET MVC можно позволяют регистрировать логику зависимостей где-то еще (например контейнер или *контейнер треф*).

![Схема внедрения зависимостей](aspnet-mvc-4-dependency-injection/_static/image2.png "рисунке внедрения зависимостей")

*Внедрение зависимостей - аналогию Golf*

Ниже перечислены преимущества использования шаблон внедрения зависимостей и инверсии управления.

- Уменьшает взаимозависимости классов
- Увеличивает повторное использование кода
- Повышает удобство поддержки кода
- Улучшает тестирования приложений

> [!NOTE]
> Внедрение зависимостей иногда сравнивается с абстрактным фабричного конструктивного шаблона, но есть незначительные различия между оба подхода. DI имеет структуру, работа за устранить зависимости, вызов фабрики и зарегистрированных служб.


Теперь, когда вы знаете шаблон внедрения зависимостей, вы узнаете в этом лабораторном занятии как применять их в ASP.NET MVC 4. Сначала с помощью внедрения зависимости в **контроллеров** включена служба доступа к базе данных. После этого будет применить внедрение зависимостей для **представления** для использования службы и отображения сведений. Наконец будут расширены внедрения Зависимостей в ASP.NET MVC 4 фильтры, внедрение пользовательского фильтра действий в решении.

В этом Практическое лабораторное занятие, вы узнаете, как:

- Интеграция ASP.NET MVC 4 с Unity для внедрения зависимостей, использование пакетов NuGet
- С помощью внедрения зависимостей в контроллер ASP.NET MVC
- С помощью внедрения зависимостей в представления ASP.NET MVC
- С помощью внедрения зависимостей в ASP.NET MVC фильтра действий

> [!NOTE]
> Это лабораторное занятие использует пакет NuGet Unity.Mvc3 для разрешения зависимостей, но можно адаптировать любой платформой внедрения зависимостей для работы с ASP.NET MVC 4.


<a id="Prerequisites"></a>

<a id="Prerequisites"></a>
### <a name="prerequisites"></a>Предварительные требования

Необходимо иметь следующие элементы во укомплектовать данную лабораторию:

- [Microsoft Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/eng/products/visual-studio-express-for-web) или руководителя (чтение [приложение А](#AppendixA) инструкции по его установке).

<a id="Setup"></a>

<a id="Setup"></a>
### <a name="setup"></a>Установка

**Установка фрагменты кода**

Для удобства большая часть кода, который вы планируете управлять вдоль этой лаборатории доступен как фрагменты кода Visual Studio. Чтобы установить фрагменты кода запуска **.\Source\Setup\CodeSnippets.vsi** файла.

Если вы не знакомы с фрагменты кода Visual Studio и хотите научиться использовать их, можно ссылаться в приложение из этого документа &quot; [приложении б: Фрагменты кода](#AppendixB)&quot;.

---

<a id="Exercises"></a>

<a id="Exercises"></a>
## <a name="exercises"></a>Упражнения

Это Практическое лабораторное занятие включает по следующие упражнения:

1. [Упражнение 1. Добавление контроллера](#Exercise1)
2. [Упражнение 2. Добавление представления](#Exercise2)
3. [Упражнение 3. Добавление фильтров](#Exercise3)

> [!NOTE]
> Каждого упражнения сопровождается **окончания** папку, содержащую полученное решение, должен быть получен после завершения упражнения. Это решение можно использовать как руководство, если вам нужна дополнительная помощь при работе с примерами.


Предполагаемое время для выполнения этого лабораторного: **30 минут**.

<a id="Exercise1"></a>

<a id="Exercise_1_Injecting_a_Controller"></a>
### <a name="exercise-1-injecting-a-controller"></a>Упражнение 1. Добавление контроллера

В этом упражнении вы узнаете, как использовать внедрение зависимостей в ASP.NET MVC Controllers, интеграция Unity с помощью пакета NuGet. По этой причине службы будет включать в свои контроллеры MvcMusicStore для отделения логики от доступа к данным. Службы создаст новую зависимость в конструктор контроллера, который будет разрешаться с использованием внедрения зависимостей с помощью **Unity**.

Этот подход будет показано, как для создания менее связанных приложений, которые являются более гибкими и простыми в обслуживании и тестировании. Вы также узнаете, как интегрировать ASP.NET MVC с помощью Unity.

<a id="About_StoreManager_Service"></a>
#### <a name="about-storemanager-service"></a>Сведения о службе StoreManager

Music Store MVC, теперь предоставляются в решении begin содержит службу, которая управляет данными Store контроллер с именем **StoreService**. Ниже Вы найдете реализация службы Store. Обратите внимание, что все методы возвращают сущностей модели.

[!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample1.cs)]

**StoreController** из begin решение использует **StoreService**. Все ссылки на данные были удалены из **StoreController**и теперь можно изменить текущий поставщик доступа к данным без изменения любой метод, который потребляет **StoreService**.

Вы найдете ниже, **StoreController** реализация имеет зависимость от **StoreService** внутри конструктора класса.

> [!NOTE]
> Зависимости, представленные в этом упражнении связана с **Inversion of Control** (IoC).
> 
> **StoreController** конструктор класса получает **IStoreService** параметру типа, который необходим для выполнения вызовов службы от внутри класса. Тем не менее **StoreController** не реализован конструктор по умолчанию (с без параметров), любой контроллер для работы с ASP.NET MVC.
> 
> Чтобы устранить зависимость, контроллер может создаваться фабрикой абстрактным (класс, который возвращает любой объект указанного типа).


[!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample2.cs)]

> [!NOTE]
> Вы получите ошибку при попытке создать StoreController без отправки объекта службы, так как не объявлен конструктор класса.


<a id="Ex1Task1"></a>

<a id="Task_1_-_Running_the_Application"></a>
#### <a name="task-1---running-the-application"></a>Задача 1 - Запуск приложения

В этой задаче будет выполняться приложения Begin, который включает в себя службу в контроллер Store отделяет доступа к данным от логики приложения.

При запуске приложения, вы получите исключение, так как служба контроллера не передается в качестве параметра по умолчанию:

1. Откройте **начать** решение находится в **внедрение Source\Ex01 Controller\Begin**.

   1. Необходимо будет загрузить некоторые отсутствующие пакеты NuGet прежде чем продолжить. Чтобы сделать это, нажмите кнопку **проекта** меню и выберите **управление пакетами NuGet**.
   2. В **управление пакетами NuGet** диалоговое окно, нажмите кнопку **восстановить** чтобы скачивать отсутствующие пакеты.
   3. Наконец, постройте решение, нажав кнопку **построения** | **построить решение**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является отсутствие поставлять все библиотеки в проекте, уменьшив размер проекта. С помощью NuGet Power Tools путем указания версий пакета в файле Packages.config можно для скачивания всех необходимых библиотек при первом запуске проекта. Вот почему необходимо выполните описанные выше действия, после открытия существующего решения из этой лаборатории.
2. Нажмите клавишу **Ctrl + F5** для запуска приложения без отладки. Вы получите сообщение об ошибке &quot; **нет конструктора без параметров, определенных для данного объекта**&quot;:

    ![Ошибка при выполнении приложения начать ASP.NET MVC](aspnet-mvc-4-dependency-injection/_static/image3.png "ошибка во время выполнения приложение начать ASP.NET MVC")

    *Ошибка при выполнении приложения начать ASP.NET MVC*
3. Закройте браузер.

В следующих шагах будет работать решение Music Store для внедрения зависимости, необходимые для этого контроллера.

<a id="Ex1Task2"></a>

<a id="Task_2_-_Including_Unity_into_MvcMusicStore_Solution"></a>
#### <a name="task-2---including-unity-into-mvcmusicstore-solution"></a>Задача 2 - включая Unity в решение MvcMusicStore

В этой задаче будет включать **Unity.Mvc3** пакет NuGet для решения.

> [!NOTE]
> Пакет Unity.Mvc3 был разработан для ASP.NET MVC 3, но она полностью совместима с ASP.NET MVC 4.
> 
> Unity — это контейнер внедрения зависимостей облегченный и расширяемый с дополнительной поддержкой для экземпляра и типа. Это контейнер общего назначения для использования в приложении .NET любого типа. Он предоставляет общие возможности, в том числе механизмы внедрения зависимостей: создание объектов, абстракции требований, указав зависимости во время выполнения и гибкость, за счет отсрочки конфигурация компонента в контейнер.


1. Установка **Unity.Mvc3** пакет NuGet в **MvcMusicStore** проекта. Чтобы сделать это, откройте **консоль диспетчера пакетов** из **представление** | **Other Windows**.
2. Выполните следующую команду:

    PMC

    [!code-powershell[Main](aspnet-mvc-4-dependency-injection/samples/sample3.ps1)]

    ![Установка пакета NuGet Unity.Mvc3](aspnet-mvc-4-dependency-injection/_static/image4.png "установки пакета NuGet Unity.Mvc3")

    *Установка пакета NuGet Unity.Mvc3*
3. Один раз **Unity.Mvc3** установки пакета, просмотрите файлы и папки, она автоматически добавляется для упрощения конфигурации Unity.

    ![Установленный пакет Unity.Mvc3](aspnet-mvc-4-dependency-injection/_static/image5.png "Unity.Mvc3 пакета")

    *Установленный пакет Unity.Mvc3*

<a id="Ex1Task3"></a>

<a id="Task_3_-_Registering_Unity_in_Globalasaxcs_Application_Start"></a>
#### <a name="task-3---registering-unity-in-globalasaxcs-applicationstart"></a>Задача 3 - регистрация Unity в приложении Global.asax.cs\_запуск

В этой задаче вы обновите **приложения\_запустить** метод находится в **Global.asax.cs** для вызова инициализатор загрузчика Unity и затем обновить регистрацию файл начального загрузчика Службы и контроллер, будет использоваться для внедрения зависимостей.

1. Теперь будет подключить загрузчика, — это файл, который инициализирует контейнера Unity и Сопоставитель зависимостей. Чтобы сделать это, откройте **Global.asax.cs** и добавьте следующий выделенный код в **приложения\_запустить** метод.

    (Code Snippet - *лаборатории внедрения зависимостей ASP.NET - Ex01 - инициализировать Unity*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample4.cs)]
2. Откройте **Bootstrapper.cs** файла.
3. Включите следующие пространства имен: **MvcMusicStore.Services** и **MusicStore.Controllers**.

    (Code Snippet - *ASP.NET внедрения зависимостей лаборатории - Ex01 - загрузчик, добавление пространств имен*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample5.cs)]
4. Замените **BuildUnityContainer** метод содержимого следующим кодом, который регистрирует Store контроллера и службы Store.

    (Code Snippet - *ASP.NET зависимостей путем внедрения кода лаборатории - Ex01 - Store Register контроллера и службы*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample6.cs)]

<a id="Ex1Task4"></a>

<a id="Task_4_-_Running_the_Application"></a>
#### <a name="task-4---running-the-application"></a>Задача 4 - запуск приложения

В этой задаче будет выполняться приложение, чтобы убедиться, что его можно загрузить теперь после включения Unity.

1. Нажмите клавишу **F5** для запуска приложения, приложения должен загружаться без отображения сообщения об ошибке.

    ![Запуск приложения с помощью внедрения зависимостей](aspnet-mvc-4-dependency-injection/_static/image6.png "запуск приложения с помощью внедрения зависимостей")

    *Запуск приложения с помощью внедрения зависимостей*
2. Перейдите к **/Store**. Это вызовет **StoreController**, который создается с помощью **Unity**.

    ![MVC Music Store](aspnet-mvc-4-dependency-injection/_static/image7.png "MVC Music Store")

    *MVC Music Store*
3. Закройте браузер.

В следующих упражнениях вы узнаете, как расширить область внедрения зависимостей, чтобы использовать его внутри представлений MVC ASP.NET и фильтры действий.

<a id="Exercise2"></a>

<a id="Exercise_2_Injecting_a_View"></a>
### <a name="exercise-2-injecting-a-view"></a>Упражнение 2. Добавление представления

В этом упражнении вы узнаете, как использовать внедрение зависимостей в представления с новыми функциями ASP.NET MVC 4 для интеграции с Unity. Для этого будет вызывать пользовательскую службу внутри представление Обзор Store, которое будет отображаться сообщение и изображение ниже.

Затем следует интегрировать с помощью Unity и создать пользовательскую зависимость Сопоставитель для внедрения зависимостей.

<a id="Ex2Task1"></a>

<a id="Task_1_-_Creating_a_View_that_Consumes_a_Service"></a>
#### <a name="task-1---creating-a-view-that-consumes-a-service"></a>Задача 1 - Создание представления, использующее службу

В этой задаче вы создадите представление, которое выполняет вызов службы для создания новой зависимости. Служба состоит в простую службу обмена сообщениями, входят в это решение.

1. Откройте **начать** решение находится в **внедрение Source\Ex02 View\Begin** папки. В противном случае можно продолжить использование **окончания** решение получен путем выполнения предыдущего упражнения.

   1. Если вы открыли предоставленный **начать** решение, необходимо будет загрузить некоторые отсутствующие пакеты NuGet прежде чем продолжить. Чтобы сделать это, нажмите кнопку **проекта** меню и выберите **управление пакетами NuGet**.
   2. В **управление пакетами NuGet** диалоговое окно, нажмите кнопку **восстановить** чтобы скачивать отсутствующие пакеты.
   3. Наконец, постройте решение, нажав кнопку **построения** | **построить решение**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является отсутствие поставлять все библиотеки в проекте, уменьшив размер проекта. С помощью NuGet Power Tools путем указания версий пакета в файле Packages.config можно для скачивания всех необходимых библиотек при первом запуске проекта. Вот почему необходимо выполните описанные выше действия, после открытия существующего решения из этой лаборатории.
      > 
      > Дополнительные сведения см. в этой статье: [ http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages ](http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages).
2. Включить **MessageService.cs** и **IMessageService.cs** классы находятся в **источника \Assets** папку в **/службы**. Чтобы сделать это, щелкните правой кнопкой мыши **служб** папку и выберите **добавить существующий элемент**. Перейдите в расположение файлов и включать их.

    ![Добавление службы сообщений и интерфейс службы](aspnet-mvc-4-dependency-injection/_static/image8.png "Добавление службы сообщений и интерфейс службы")

    *Добавление службы сообщений и интерфейс службы*

    > [!NOTE]
    > **IMessageService** интерфейс определяет два свойства, реализуемый **MessageService** класса. Эти свойства —**сообщение** и **ImageUrl**-хранить сообщение и URL-адрес изображения для отображения.
3. Создать папку **/Pages** в проекте корневой папки, а затем добавьте существующий класс **MyBasePage.cs** из **Source\Assets**. Основной страницы, который будет наследовать от имеет следующую структуру.

    ![Папка страниц](aspnet-mvc-4-dependency-injection/_static/image9.png "папка страниц")

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample7.cs)]
4. Откройте **Browse.cshtml** просмотра из **/Views/Store** папки и сделать ее от **MyBasePage.cs**.

    [!code-cshtml[Main](aspnet-mvc-4-dependency-injection/samples/sample8.cshtml)]
5. В **Обзор** просмотреть, добавить вызов **MessageService** для отображения изображения и сообщение извлечено службой.
   (C#)

    [!code-cshtml[Main](aspnet-mvc-4-dependency-injection/samples/sample9.cshtml)]

<a id="Ex2Task2"></a>

<a id="Task_2_-_Including_a_Custom_Dependency_Resolver_and_a_Custom_View_Page_Activator"></a>
#### <a name="task-2---including-a-custom-dependency-resolver-and-a-custom-view-page-activator"></a>Задача 2 - включая арбитра пользовательскую зависимость и активатор страницы представления

В предыдущей задаче вы добавили новую зависимость внутри представления для выполнения вызова службы внутри него. Теперь эту зависимость разрешит путем реализации интерфейсов внедрения зависимостей ASP.NET MVC **IViewPageActivator** и **IDependencyResolver**. В решении будет включать реализацию **IDependencyResolver** , обеспечит получение службы с помощью Unity. То, будет включать другой пользовательской реализации **IViewPageActivator** интерфейс, который решит создавать представления.

> [!NOTE]
> С момента ASP.NET MVC 3 реализацию для внедрения зависимостей упрощена интерфейсы для регистрации службы. **IDependencyResolver** и **IViewPageActivator** являются частью функции ASP.NET MVC 3 для внедрения зависимостей.
> 
> **-IDependencyResolver** интерфейс заменяет предыдущие IMvcServiceLocator. Объекты, реализующие IDependencyResolver должен возвращать экземпляр службы или службы коллекции.
> 
> 
> [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample10.cs)]
> 
> **-IViewPageActivator** интерфейс обеспечивает более точный контроль над как просмотреть страницы создаются посредством внедрения зависимостей. Классы, реализующие **IViewPageActivator** интерфейс можно создавать экземпляры представления, используя информацию о контексте.
> 
> 
> [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample11.cs)]


1. Создать /**фабрик** папку в корневой папке проекта.
2. Включить **CustomViewPageActivator.cs** в решение из **/источники/ресурсы/** для **фабрик** папки. Чтобы сделать это, щелкните правой кнопкой мыши **/Factories** папку, выберите **Add | Существующий элемент** , а затем выберите **CustomViewPageActivator.cs**. Этот класс реализует **IViewPageActivator** интерфейс для хранения контейнера Unity.

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample12.cs)]

    > [!NOTE]
    > **CustomViewPageActivator** отвечает за управление созданием представления с помощью Unity-контейнера.
3. Включить **UnityDependencyResolver.cs** файла из **/источники/активы** для **/Factories** папки. Чтобы сделать это, щелкните правой кнопкой мыши **/Factories** папку, выберите **Add | Существующий элемент** , а затем выберите **UnityDependencyResolver.cs** файла.

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample13.cs)]

    > [!NOTE]
    > **UnityDependencyResolver** класс является пользовательских DependencyResolver для Unity. Если службу не удается найти внутри контейнера Unity, является invocated базового сопоставителя.

В следующей задаче будет зарегистрирован обе реализации позволяет знать расположение службы и представления модели.

<a id="Ex2Task3"></a>

<a id="Task_3_-_Registering_for_Dependency_Injection_within_Unity_container"></a>
#### <a name="task-3---registering-for-dependency-injection-within-unity-container"></a>Задача 3 - регистрация для внедрения зависимости в пределах контейнера Unity

В этой задаче будет поместить все предыдущие друг с другом, чтобы сделать работать внедрения зависимостей, что.

Пока решение содержит следующие элементы:

- Объект **Обзор** представление, которое наследует от **MyBaseClass с помощью модификатора** и использует **MessageService**.
- Промежуточный класс -**MyBaseClass с помощью модификатора**-с внедрения зависимостей, объявленным для интерфейса службы.
- Службы - **MessageService** - и его интерфейс **IMessageService**.
- Сопоставитель пользовательскую зависимость для Unity — **UnityDependencyResolver** -имеет дело с получения службы.
- Активатор страницы представления - **CustomViewPageActivator** -, создает страницу.

Чтобы внедрить **Обзор** представление, вы теперь регистрирует Сопоставитель пользовательскую зависимость в контейнера Unity.

1. Откройте **Bootstrapper.cs** файла.
2. Регистрация экземпляра **MessageService** в контейнер Unity инициализировать службу:

    (Code Snippet - *службу сообщения Register лаборатории - Ex02 - внедрения зависимостей ASP.NET*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample14.cs)]
3. Добавьте ссылку на **MvcMusicStore.Factories** пространства имен.

    (Code Snippet - *пространство имен фабрик лаборатории - Ex02 - внедрения зависимостей ASP.NET*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample15.cs)]
4. Зарегистрировать **CustomViewPageActivator** как активатор страницы представления в контейнер Unity:

    (Code Snippet - *ASP.NET зависимостей путем внедрения кода лаборатории - Ex02 - Register CustomViewPageActivator*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample16.cs)]
5. Замените экземпляр сопоставителя зависимостей по умолчанию ASP.NET MVC 4 **UnityDependencyResolver**. Чтобы сделать это, замените **инициализировать** метод содержимого следующим кодом:

    (Code Snippet - *ASP.NET зависимостей путем внедрения кода лаборатории - Ex02 - обновления Сопоставитель зависимостей*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample17.cs)]

    > [!NOTE]
    > ASP.NET MVC предоставляет класс Сопоставитель зависимостей по умолчанию. Для работы с сопоставителей пользовательских зависимостей, которое мы создали для unity, должно быть заменено данным сопоставителем.

<a id="Ex2Task4"></a>

<a id="Task_4_-_Running_the_Application"></a>
#### <a name="task-4---running-the-application"></a>Задача 4 - запуск приложения

В этой задаче будет выполняться приложение, чтобы убедиться, что браузер Store использует службу и показано изображение и сообщение, полученное:

1. Нажмите клавишу **F5** для запуска приложения.
2. Нажмите кнопку **рок** в меню жанров и см. в разделе как **MessageService** был внедрен в представление и загружаются приветственное сообщение и изображения. В этом примере выполняется переход к &quot; **рок**&quot;:

    ![MVC Music Store - внедрения представления](aspnet-mvc-4-dependency-injection/_static/image10.png "MVC Music Store - внедрения представления")

    *MVC Music Store - внедрения представления*
3. Закройте браузер.

<a id="Exercise3"></a>

<a id="Exercise_3_Injecting_Action_Filters"></a>
### <a name="exercise-3-injecting-action-filters"></a>Упражнение 3. Добавление фильтров действий

В предыдущей практической работу **настраиваемые фильтры действий** вы работали с настройки фильтров и внедрения. В этом упражнении вы узнаете, как внедрить фильтры с помощью внедрения зависимостей с помощью контейнера Unity. Чтобы сделать это, будет добавлен в решение Music Store пользовательского фильтра действий, будет отслеживать веб-узла.

<a id="Ex3Task1"></a>

<a id="Task_1_-_Including_the_Tracking_Filter_in_the_Solution"></a>
#### <a name="task-1---including-the-tracking-filter-in-the-solution"></a>Задача 1 - Включение отслеживания фильтра в решение

В этой задаче будут включены в Music Store пользовательского фильтра действий для события трассировки. Основные понятия как пользовательского фильтра действий, всегда обрабатываются в предыдущем лаборатории &quot;пользовательских фильтров действий&quot;, необходимо просто добавить класс фильтра из папки Assets данную лабораторию и затем создать поставщик фильтра для Unity:

1. Откройте **начать** решение находится в **Source\Ex03 - внедрение Filter\Begin действие** папки. В противном случае можно продолжить использование **окончания** решение получен путем выполнения предыдущего упражнения.

   1. Если вы открыли предоставленный **начать** решение, необходимо будет загрузить некоторые отсутствующие пакеты NuGet прежде чем продолжить. Чтобы сделать это, нажмите кнопку **проекта** меню и выберите **управление пакетами NuGet**.
   2. В **управление пакетами NuGet** диалоговое окно, нажмите кнопку **восстановить** чтобы скачивать отсутствующие пакеты.
   3. Наконец, постройте решение, нажав кнопку **построения** | **построить решение**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является отсутствие поставлять все библиотеки в проекте, уменьшив размер проекта. С помощью NuGet Power Tools путем указания версий пакета в файле Packages.config можно для скачивания всех необходимых библиотек при первом запуске проекта. Вот почему необходимо выполните описанные выше действия, после открытия существующего решения из этой лаборатории.
      > 
      > Дополнительные сведения см. в этой статье: [ http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages ](http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages).
2. Включить **TraceActionFilter.cs** файла из **/источники/активы** для **/фильтрует** папки.

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample18.cs)]

    > [!NOTE]
    > Этот фильтр настраиваемое действие выполняет трассировку ASP.NET. Вы можете проверить &quot;локальный ASP.NET MVC 4 и динамические фильтры операций&quot; лаборатории для Дополнительные ссылки.
3. Добавьте пустой класс **FilterProvider.cs** в проект в папке   **/фильтры.**
4. Добавить **System.Web.Mvc** и **Microsoft.Practices.Unity** пространств имен в **FilterProvider.cs**.

    (Code Snippet - *ASP.NET зависимостей путем внедрения кода лаборатории - Ex03 - фильтр поставщика добавление пространств имен*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample19.cs)]
5. Сделайте соответствующие классы наследуют от **IFilterProvider** интерфейс.

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample20.cs)]
6. Добавить **IUnityContainer** свойство в **FilterProvider** класса, а затем создать конструктор класса, чтобы назначить контейнера.

    (Code Snippet - *ASP.NET зависимостей путем внедрения кода лаборатории - Ex03 - фильтр поставщика конструктор*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample21.cs)]

    > [!NOTE]
    > Конструктор класса поставщика фильтра не создаете **новый** объекта внутри. Контейнера передается в качестве параметра, а зависимость решается путем Unity.
7. В **FilterProvider** , следует реализовать метод **GetFilters** из **IFilterProvider** интерфейс.

    (Code Snippet - *ASP.NET зависимостей путем внедрения кода лаборатории - Ex03 - фильтр поставщика GetFilters*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample22.cs)]

<a id="Ex3Task2"></a>

<a id="Task_2_-_Registering_and_Enabling_the_Filter"></a>
#### <a name="task-2---registering-and-enabling-the-filter"></a>Задача 2 - регистрация и включение фильтра

В этой задаче будет включить отслеживание сайта. Чтобы сделать это, вы будете регистрировать фильтр в **Bootstrapper.cs BuildUnityContainer** метод для запуска трассировки:

1. Откройте **Web.config** в корневую папку проекта и Включение отслеживания трассировки в группе System.Web.

    [!code-xml[Main](aspnet-mvc-4-dependency-injection/samples/sample23.xml)]
2. Откройте **Bootstrapper.cs** в корневом каталоге проекта.
3. Добавьте ссылку на **MvcMusicStore.Filters** пространства имен.

    (Code Snippet - *ASP.NET внедрения зависимостей лаборатории - Ex03 - загрузчик, добавление пространств имен*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample24.cs)]
4. Выберите **BuildUnityContainer** метод и регистрация фильтра в контейнера Unity. Вам будет необходимо зарегистрировать у поставщика фильтров, а также действие фильтра.

    (Code Snippet - *ASP.NET зависимостей путем внедрения кода лаборатории - Ex03 - Register FilterProvider и ActionFilter*)

    [!code-csharp[Main](aspnet-mvc-4-dependency-injection/samples/sample25.cs)]

<a id="Ex3Task3"></a>

<a id="Task_3_-_Running_the_Application"></a>
#### <a name="task-3---running-the-application"></a>Задача 3 - запуск приложения

В этой задаче будет запустить приложение и проверить, что настраиваемого фильтра действий является трассировка действия:

1. Нажмите клавишу **F5** для запуска приложения.
2. Нажмите кнопку **рок** меню жанров. Если вы хотите можно просмотреть дополнительные жанров.

    ![Music Store](aspnet-mvc-4-dependency-injection/_static/image11.png "Music Store")

    *Приложение Music Store*
3. Перейдите к **/Trace.axd** для просмотра трассировки приложения странице, а затем выберите **Просмотр сведений о**.

    ![Журнал трассировки приложения](aspnet-mvc-4-dependency-injection/_static/image12.png "журнал трассировки приложения")

    *Журнал трассировки приложения*

    ![Трассировка приложения — сведения о запросе](aspnet-mvc-4-dependency-injection/_static/image13.png "трассировки приложения — сведения о запросе")

    *Трассировка приложения — сведения о запросе*
4. Закройте браузер.

---

<a id="Summary"></a>

<a id="Summary"></a>
## <a name="summary"></a>Сводка

Выполнив этот практический семинар вы узнали, как использовать внедрение зависимостей в ASP.NET MVC 4, интеграция Unity с помощью пакета NuGet. Чтобы добиться этого, вы использовали внедрение зависимостей в контроллеры, представления и фильтры действий.

Охваченных следующие понятия:

- Функции внедрения зависимостей ASP.NET MVC 4
- Интеграция с Unity с помощью пакета NuGet Unity.Mvc3
- Внедрение зависимостей в контроллеры
- Внедрение зависимостей в представления
- Внедрение зависимостей фильтров действий

<a id="AppendixA"></a>

<a id="Appendix_A_Installing_Visual_Studio_Express_2012_for_Web"></a>
## <a name="appendix-a-installing-visual-studio-express-2012-for-web"></a>Приложение а. Установка Visual Studio Express 2012 для Web

Вы можете установить **Microsoft Visual Studio Express 2012 для Web** или другой &quot;Express&quot; версию с помощью **[Microsoft Web Platform Installer](https://www.microsoft.com/web/downloads/platform.aspx)**. Приведенные ниже инструкции описывают действия, необходимые для установки *Visual studio Express 2012 для Web* с помощью *Microsoft Web Platform Installer*.

1. Перейдите по адресу [https://go.microsoft.com/?linkid=9810169](https://go.microsoft.com/?linkid=9810169). Кроме того, если вы уже установили установщика веб-платформы, можно открыть его и выполните поиск продукта &quot; <em>Visual Studio Express 2012 для Web с пакетом Windows Azure SDK</em>&quot;.
2. Щелкните **установить сейчас**. Если у вас нет **установщика веб-платформы** вы будете перенаправлены к сначала загрузить и установить его.
3. Один раз **установщика веб-платформы** открыт, нажмите кнопку **установить** для запуска программы установки.

    ![Установка Visual Studio Express](aspnet-mvc-4-dependency-injection/_static/image14.png "установка Visual Studio Express")

    *Установка Visual Studio Express*
4. Прочтите лицензии и условия все продукты и нажмите кнопку **я принимаю** для продолжения.

    ![Принятие условий лицензии](aspnet-mvc-4-dependency-injection/_static/image15.png)

    *Принятие условий лицензии*
5. Подождите, пока не завершится процесс загрузки и установки.

    ![Ход установки](aspnet-mvc-4-dependency-injection/_static/image16.png)

    *Ход установки*
6. После завершения установки нажмите кнопку **Готово**.

    ![Установка завершена](aspnet-mvc-4-dependency-injection/_static/image17.png)

    *Установка завершена*
7. Нажмите кнопку **выхода** закрыть установщик веб-платформы.
8. Чтобы открыть Visual Studio Express для Web, перейдите к **запустить** экрана и Займитесь написанием &quot; **VS Express**&quot;, нажмите кнопку на **VS Express для Web** Плитка.

    ![VS Express для Web плитки](aspnet-mvc-4-dependency-injection/_static/image18.png)

    *VS Express для Web плитки*

<a id="AppendixB"></a>

<a id="Appendix_B_Using_Code_Snippets"></a>
## <a name="appendix-b-using-code-snippets"></a>Приложение б. Фрагменты кода

С помощью фрагментов кода у вас есть весь код, который требуется в вашем распоряжении. Лаборатории документ поможет определить точно при их использовании, как показано на рисунке ниже.

![Фрагменты кода Visual Studio, чтобы вставить код в проект](aspnet-mvc-4-dependency-injection/_static/image19.png "фрагменты кода с помощью Visual Studio, чтобы вставить код в проект")

*Фрагменты кода Visual Studio, чтобы вставить код в проект*

***Чтобы добавить фрагмент кода, с помощью клавиатуры (только C#)***

1. Поместите курсор в место вставки кода.
2. Начните вводить имя фрагмента (без пробелов и дефисов).
3. Посмотрите, как IntelliSense отображает, совпадающие с именами фрагменты.
4. Выберите правильный фрагмент (или продолжите ввод, пока не будет выделен весь фрагмент имени).
5. Нажмите клавишу Tab дважды, чтобы вставить фрагмент в положении курсора.

![Начните вводить имя фрагмента](aspnet-mvc-4-dependency-injection/_static/image20.png "начните вводить имя фрагмента")

*Начните вводить имя фрагмента*

![Нажмите клавишу Tab, чтобы выделить фрагмент в выделенный](aspnet-mvc-4-dependency-injection/_static/image21.png "нажмите клавишу Tab, чтобы выделить выделенный фрагмент")

*Нажмите клавишу Tab, чтобы выделить выделенный фрагмент*

![Снова нажмите клавишу Tab и фрагмент будет расширяться](aspnet-mvc-4-dependency-injection/_static/image22.png "еще раз нажмите клавишу Tab и фрагмент будет расширяться")

*Снова нажмите клавишу Tab и фрагмент будет расширяться*

***Чтобы добавить фрагмент кода, с помощью мыши (C#, Visual Basic и XML)*** 1. Щелкните правой кнопкой мыши место для вставки фрагмента кода.

1. Выберите **вставить фрагмент** следуют **Мои фрагменты кода**.
2. Выберите соответствующий фрагмент из списка, щелкнув его.

![Щелкните правой кнопкой мыши, где необходимо вставить фрагмент кода и выберите Вставить фрагмент](aspnet-mvc-4-dependency-injection/_static/image23.png "щелкните правой кнопкой мыши, где необходимо вставить фрагмент кода и выберите Вставить фрагмент")

*Щелкните правой кнопкой мыши место для вставки фрагмента кода и выберите Вставить фрагмент*

![Выберите соответствующий фрагмент из списка, щелкнув по ней](aspnet-mvc-4-dependency-injection/_static/image24.png "выбрать соответствующий фрагмент из списка, щелкнув по ней")

*Выберите соответствующий фрагмент из списка, щелкнув по ней*
