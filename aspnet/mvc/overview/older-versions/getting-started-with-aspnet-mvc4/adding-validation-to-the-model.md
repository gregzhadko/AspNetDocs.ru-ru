---
uid: mvc/overview/older-versions/getting-started-with-aspnet-mvc4/adding-validation-to-the-model
title: Добавление проверки в модель | Документация Майкрософт
author: Rick-Anderson
description: Примечание. Обновленная версия этого учебника доступна здесь, в которой используется ASP.NET MVC 5 и Visual Studio 2013. Он более безопасен, гораздо проще в исполнении и демонстрации...
ms.author: riande
ms.date: 08/28/2012
ms.assetid: 5d9a2999-fcc4-4c45-a018-271fddf74a3b
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-aspnet-mvc4/adding-validation-to-the-model
msc.type: authoredcontent
ms.openlocfilehash: c9f6699c5d3500d4c1fcade9252aeb9dd92983da
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77455962"
---
# <a name="adding-validation-to-the-model"></a>Добавление проверки в модель

по [Рик Андерсон (](https://twitter.com/RickAndMSFT)

> > [!NOTE]
> > Обновленная версия этого учебника доступна [здесь](../../getting-started/introduction/getting-started.md) , в которой используется ASP.NET MVC 5 и Visual Studio 2013. Он более безопасен, гораздо проще следовать и демонстрирует дополнительные функции.

В этом разделе вы добавите логику проверки к модели `Movie`, и вы убедитесь, что правила проверки применяются каждый раз, когда пользователь попытается создать или изменить фильм с помощью приложения.

## <a name="keeping-things-dry"></a>Поддержание СУХИх вещей

Один из основных принципов проектирования ASP.NET MVC — сухой (&quot;принцип "Не повторяйся"&quot;). ASP.NET MVC позволяет указать функциональные возможности или поведение только один раз, после чего они будут отражены в любом приложении. Это сокращает объем кода, который необходимо написать, и делает код менее подверженным ошибкам и проще в обслуживании.

Поддержка проверки, предоставляемая ASP.NET MVC и Entity Framework Code First, является хорошим примером принципа сухой в действии. Правила проверки можно декларативно задавать в одном месте (в классе Model), а правила применяются везде в приложении.

Рассмотрим, как можно воспользоваться преимуществами этой поддержки проверки в приложении Movie.

## <a name="adding-validation-rules-to-the-movie-model"></a>Добавление правил проверки к модели фильмов

Начнем с добавления логики проверки к классу `Movie`.

Откройте файл *Movie.cs*. Добавьте в начало файла инструкцию `using`, которая ссылается на пространство имен [`System.ComponentModel.DataAnnotations`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.aspx) :

[!code-csharp[Main](adding-validation-to-the-model/samples/sample1.cs)]

Обратите внимание, что пространство имен не содержит `System.Web`. Аннотации данных предоставляют встроенный набор атрибутов проверки, которые можно декларативно применять к любому классу или свойству.

Теперь обновите класс `Movie`, чтобы воспользоваться преимуществами встроенных [`Required`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.requiredattribute.aspx), [`StringLength`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.stringlengthattribute.aspx)и [`Range`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.rangeattribute.aspx) атрибутов проверки. Используйте следующий код в качестве примера того, где применять атрибуты.

[!code-csharp[Main](adding-validation-to-the-model/samples/sample2.cs?highlight=4,10,13,17)]

Запустите приложение, и вы снова получите следующую ошибку времени выполнения:

***Модель, которая является резервной моделью контекста "Мовиедбконтекст", изменилась с момента создания базы данных. Рекомендуется использовать Code First Migrations для обновления базы данных ([https://go.microsoft.com/fwlink/?LinkId=238269](https://go.microsoft.com/fwlink/?LinkId=238269)).***

Для обновления схемы мы будем использовать миграции. Выполните сборку решения, а затем откройте окно **консоли диспетчера пакетов** и введите следующие команды:

[!code-console[Main](adding-validation-to-the-model/samples/sample3.cmd)]

По завершении выполнения этой команды Visual Studio открывает файл класса, который определяет новый производный класс `DbMigration` с указанным именем (*адддатааннотатионсмиг*), а в методе `Up` можно увидеть код, который обновляет ограничения схемы. Поля `Title` и `Genre` больше не допускают значение null (то есть необходимо вводить значение), а поле `Rating` имеет максимальную длину 5.

Атрибуты проверки определяют поведение для свойств модели, к которым они применяются. Атрибут `Required` указывает, что свойство должно иметь значение. в этом примере фильм должен иметь значения для свойств `Title`, `ReleaseDate`, `Genre`и `Price`, чтобы быть допустимыми. Атрибут `Range` ограничивает диапазон значений. Атрибут `StringLength` позволяет задать максимальную и при необходимости минимальную длину строкового свойства. Встроенные типы (такие как `decimal, int, float, DateTime`) являются обязательными по умолчанию и не требуют атрибута `Required`.

Code First гарантирует, что правила проверки, указанные в классе модели, будут применены, прежде чем приложение сохранит изменения в базе данных. Например, приведенный ниже код вызывает исключение при вызове метода `SaveChanges`, так как отсутствуют несколько обязательных `Movie` значений свойств и цена равна нулю (за пределами допустимого диапазона).

[!code-csharp[Main](adding-validation-to-the-model/samples/sample4.cs?highlight=7-8)]

Если правила проверки автоматически принудительно применяются .NET Framework помогает сделать приложение более надежным. Это также гарантирует, что в любом случае будут выполнены все проверки и в базе данных не будут случайно оставлены поврежденные данные.

Ниже приведен полный листинг кода для обновленного файла *Movie.CS* :

[!code-csharp[Main](adding-validation-to-the-model/samples/sample5.cs)]

## <a name="validation-error-ui-in-aspnet-mvc"></a>Пользовательский интерфейс ошибки проверки в ASP.NET MVC

Повторно запустите приложение и перейдите по URL-адресу */Movies* .

Щелкните ссылку **создать** , чтобы добавить новый фильм. Заполните форму недопустимыми значениями и нажмите кнопку " **создать** ".

![8_validationErrors](adding-validation-to-the-model/_static/image1.png)

> [!NOTE]
> для поддержки проверки jQuery для национальных стандартов, отличных от английского, в которых используется запятая (&quot;,&quot;) для десятичной запятой, необходимо включить *глобализацию. js* и определенные *языки и региональные параметры/глобализации. js* (из [https://github.com/jquery/globalize](https://github.com/jquery/globalize) ) и JavaScript для использования `Globalize.parseFloat`. В следующем коде показаны изменения в файле Виевс\мовиес\едит.кштмл для работы с культурой &quot;fr-FR&quot;.

[!code-cshtml[Main](adding-validation-to-the-model/samples/sample6.cshtml)]

Обратите внимание, что форма автоматически использовала красный цвет границы для выделения текстовых полей, содержащих недопустимые данные, и выдает соответствующее сообщение об ошибке проверки рядом с каждым из них. Эти ошибки применяются как на стороне клиента (с помощью JavaScript и jQuery), так и на стороне сервера (если пользователь отключает JavaScript).

Настоящим преимуществом является то, что вам не пришлось изменять одну строку кода в классе `MoviesController` или в представлении *Create. cshtml* , чтобы включить этот пользовательский интерфейс проверки. В контроллере и представлениях, создаваемых в рамках этого руководства, автоматически применяются правила проверки, для определения которых к свойствам класса модели `Movie` были применены атрибуты.

Возможно, вы заметили, что свойства `Title` и `Genre`, необходимый атрибут не применяется, пока вы не отправите форму (нажмите кнопку **создать** ) или вводите текст в поле ввода и удалили его. Для поля, которое изначально пусто (например, поля в представлении создания), которое имеет только обязательный атрибут и не имеет других атрибутов проверки, можно выполнить следующие действия, чтобы активировать проверку:

1. В поле.
2. Введите текст.
3. Выйдите из поля с помощью клавиши TAB.
4. Вернитесь в поле.
5. Удалите текст.
6. Выйдите из поля с помощью клавиши TAB.

Указанная выше последовательность активирует необходимую проверку без нажатия кнопки "Отправить". Простое нажатие кнопки Submit без ввода каких либо полей приведет к активации проверки на стороне клиента. Данные формы передаются на сервер только после того, как будут устранены любые ошибки на стороне клиента. Это можно проверить путем помещения точки останова в метод HTTP POST или с помощью средства [Fiddler](http://fiddler2.com/fiddler2/) или [средств РАЗРАБОТЧИКА F12](https://msdn.microsoft.com/ie/aa740478)для IE 9.

![](adding-validation-to-the-model/_static/image2.png)

## <a name="how-validation-occurs-in-the-create-view-and-create-action-method"></a>Как выполняется проверка в методе создания представления и создания действия

Вам может быть интересно, как пользовательский интерфейс проверки создается без обновления кода контроллера или представлений. В следующем листинге показано, как выглядят методы `Create` в классе `MovieController`. Они не изменяются из того, как вы создали их ранее в этом руководстве.

[!code-csharp[Main](adding-validation-to-the-model/samples/sample7.cs?highlight=12,15)]

Первый метод действия `Create` (HTTP GET) отображает исходную форму создания. Вторая версия (`[HttpPost]`) обрабатывает передачу формы. Второй метод `Create` (версия `HttpPost`) вызывает `ModelState.IsValid`, который определяет наличие ошибок проверки в фильме. При вызове этого метода оцениваются все атрибуты проверки, которые были применены к объекту. При наличии ошибок проверки в объекте метод `Create` повторно отображает форму. Если ошибок нет, метод сохраняет новый фильм в базе данных. В нашем примере использования фильма **форма не отправляется на сервер при обнаружении ошибок проверки на стороне клиента; второй** **метод `Create`никогда не вызывается**. При отключении JavaScript в браузере проверка клиента отключается, а метод HTTP POST `Create` вызывает `ModelState.IsValid`, чтобы проверить, имеются ли в фильме ошибки проверки.

Вы можете установить точку останова в метод `HttpPost Create` и убедиться, что он не вызывается и данные формы не передаются, если на стороне клиента присутствуют ошибки проверки. Если отключить JavaScript в браузере и отправить форму с ошибками, будет достигнута точка останова. Без JavaScript вы по-прежнему будете получать полную проверку. На следующем рисунке показано, как отключить JavaScript в Internet Explorer.

![](adding-validation-to-the-model/_static/image3.png)

![](adding-validation-to-the-model/_static/image4.png)

На следующем рисунке показано, как отключить JavaScript в браузере FireFox.

![](adding-validation-to-the-model/_static/image5.png)

На следующем рисунке показано, как отключить JavaScript с помощью браузера Chrome.

![](adding-validation-to-the-model/_static/image6.png)

Ниже приведен шаблон представления *Create. cshtml* , сформированный ранее в этом руководстве. Он используется в показанных выше методах действия для отображения исходной формы и повторного вывода формы в случае ошибки.

[!code-cshtml[Main](adding-validation-to-the-model/samples/sample8.cshtml?highlight=22-23,30-31,38-39,46-47)]

Обратите внимание, что в коде используется вспомогательный метод `Html.EditorFor` для вывода элемента `<input>` для каждого свойства `Movie`. Рядом с этим вспомогательным модулем вызывается вспомогательный метод `Html.ValidationMessageFor`. Эти два вспомогательных метода работают с объектом модели, который передается контроллером в представление (в данном случае это объект `Movie`). Они автоматически ищут атрибуты проверки, указанные в модели, и отображают сообщения об ошибках соответствующим образом.

Все, что хорошо замечательно в этом подходе, заключается в том, что ни контроллер, ни шаблон создания представления не знают о фактических правилах проверки, которые применяются, или о конкретных сообщениях об ошибках. Правила проверки и строки ошибок указываются только в классе `Movie`. Эти же правила проверки автоматически применяются к представлению редактирования и другим шаблонам представлений, которые можно создать, изменяя модель.

Если вы хотите изменить логику проверки позже, это можно сделать в одном месте, добавив к модели атрибуты проверки (в этом примере — класс `movie`). Вам не придется беспокоиться о несогласованности применения правил в различных частях приложения, поскольку вся логика проверки будет определена в одном месте и начнет применяться по всему приложению. Это позволяет максимально оптимизировать код и обеспечить удобство его совершенствования и поддержки. Кроме того, таким образом вы будете полностью соблюдать требования принципа "Не повторяйся".

## <a name="adding-formatting-to-the-movie-model"></a>Добавление форматирования в модель фильмов

Откройте файл *Movie.cs* и проверьте класс `Movie`. Пространство имен [`System.ComponentModel.DataAnnotations`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.aspx) предоставляет атрибуты форматирования в дополнение к встроенному набору атрибутов проверки. Мы уже применили значение перечисления [`DataType`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.datatype.aspx) к дате выпуска и к полям цены. В следующем коде показаны свойства `ReleaseDate` и `Price` с соответствующим атрибутом [`DisplayFormat`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.displayformatattribute.aspx) .

[!code-csharp[Main](adding-validation-to-the-model/samples/sample9.cs)]

Атрибуты [`DataType`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.datatype.aspx) не являются атрибутами проверки, они используются, чтобы сообщить подсистеме представлений о том, как визуализировать код HTML. В приведенном выше примере атрибут `DataType.Date` отображает даты фильма только как даты без времени. Например, следующие атрибуты [`DataType`](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.datatype.aspx) не проверяют формат данных:

[!code-csharp[Main](adding-validation-to-the-model/samples/sample10.cs)]

Перечисленные выше атрибуты предоставляют подсистеме просмотра только указания для форматирования данных (и предоставляют такие атрибуты, как &lt;&gt; для URL-адреса и &lt;&quot;href =&quot;mailto:Емаиладдресс. com &gt; для электронной почты. Для проверки формата данных можно использовать атрибут [RegularExpression](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.regularexpressionattribute.aspx) .

Альтернативный подход к использованию атрибутов `DataType` можно явно задать значение [`DataFormatString`](https://msdn.microsoft.com/library/system.string.format.aspx) . В следующем коде показано свойство Дата выпуска со строкой формата даты (а именно &quot;d&quot;). Этот параметр используется для указания, что вы не хотите использовать время в качестве части даты выпуска.

[!code-csharp[Main](adding-validation-to-the-model/samples/sample11.cs)]

Ниже приведен полный класс `Movie`.

[!code-csharp[Main](adding-validation-to-the-model/samples/sample12.cs)]

Запустите приложение и перейдите к контроллеру `Movies`. Дата и цена выпуска хорошо отформатированы. На следующем рисунке показана дата и цена выпуска с использованием &quot;fr-FR&quot; в качестве языка и региональных параметров.

![8_format_SM](adding-validation-to-the-model/_static/image7.png)

На рисунке ниже показаны те же данные, которые отображаются с языком и региональными параметрами по умолчанию (Английский США).

![](adding-validation-to-the-model/_static/image8.png)

В следующей части этой серии мы рассмотрим приложение и внесем ряд изменений в автоматически создаваемые методы `Details` и `Delete`.

> [!div class="step-by-step"]
> [Назад](adding-a-new-field-to-the-movie-model-and-table.md)
> [Вперед](examining-the-details-and-delete-methods.md)
