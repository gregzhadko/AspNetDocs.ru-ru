---
uid: mvc/overview/older-versions/getting-started-with-aspnet-mvc4/adding-a-new-field-to-the-movie-model-and-table
title: Добавление нового поля в модель Movie и таблицу | Документация Майкрософт
author: Rick-Anderson
description: Примечание. Обновленную версию этого учебника доступен здесь, использующий ASP.NET MVC 5 и Visual Studio 2013. Это более безопасное и гораздо проще выполнить и демонстрационных версий...
ms.author: riande
ms.date: 08/28/2012
ms.assetid: 9ef2c4f1-a305-4e0a-9fb8-bfbd9ef331d9
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-aspnet-mvc4/adding-a-new-field-to-the-movie-model-and-table
msc.type: authoredcontent
ms.openlocfilehash: 307719f30c9efc8001f63f3ab068e50f82e1c5c0
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59399623"
---
# <a name="adding-a-new-field-to-the-movie-model-and-table"></a>Добавление нового поля в модель и таблицу Movie

по [Рик Андерсон]((https://twitter.com/RickAndMSFT))

> > [!NOTE]
> > Обновленную версию этого учебника доступен [здесь](../../getting-started/introduction/getting-started.md) , использующий ASP.NET MVC 5 и Visual Studio 2013. Она более безопасные, гораздо проще следовать и показаны дополнительные возможности.


В этом разделе используется Entity Framework Code First Migrations перенести некоторые изменения в классы моделей для применения изменений к базе данных.

По умолчанию при использовании Entity Framework Code First для автоматического создания базы данных, как это делалось ранее в этом учебнике, Code First добавляет таблицу в базу данных, которая позволяет отслеживать синхронизацию с классами модели, в которой она была создана из схемы базы данных. Если синхронизация нарушена, Entity Framework завершается ошибкой. Это упрощает для выявления проблем во время разработки, в противном случае только выявленных (по непонятные ошибки) во время выполнения.

## <a name="setting-up-code-first-migrations-for-model-changes"></a>Настройка Code First Migrations для изменения модели

Если вы используете Visual Studio 2012, дважды щелкните *Movies.mdf* файл из обозревателя решений, чтобы открыть средство баз данных. Visual Studio Express для Web будет Показать обозреватель баз данных, Visual Studio 2012 будет отображаться в обозревателе серверов. Если вы используете Visual Studio 2010, используйте обозреватель объектов SQL Server.

В средстве базы данных (обозреватель баз данных, обозреватель серверов или обозревателе объектов SQL Server), щелкните правой кнопкой мыши `MovieDBContext` и выберите **удалить** удалить базу данных фильмов.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image1.png)

Перейдите обратно в обозревателе решений. Щелкните правой кнопкой мыши *Movies.mdf* файл и выберите **удалить** удаление базы данных фильмов.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image2.png)

Постройте приложение, чтобы убедиться в отсутствии ошибок.

Из **средства** меню, щелкните **диспетчер пакетов NuGet** и затем **консоль диспетчера пакетов**.

![Добавьте пакет Man](adding-a-new-field-to-the-movie-model-and-table/_static/image3.png)

В **консоль диспетчера пакетов** окно при `PM>` командной строке введите «Enable-Migrations - ContextTypeName MvcMovie.Models.MovieDBContext».

![](adding-a-new-field-to-the-movie-model-and-table/_static/image4.png)

**Enable-Migrations** (как показано выше) команда создает *Configuration.cs* файл в новом *миграций* папки.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image5.png)

Visual Studio открывает *Configuration.cs* файла. Замените `Seed` метод в *Configuration.cs* файла следующим кодом:

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample1.cs)]

Щелкните правой кнопкой мыши на волнистую красную линию под `Movie` и выберите **устранить** затем **с помощью** **MvcMovie.Models;**

![](adding-a-new-field-to-the-movie-model-and-table/_static/image6.png)

Это добавляет следующий оператор using:

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample2.cs)]

> [!NOTE] 
> 
> Code First Migrations вызовы `Seed` метод после каждой миграции (то есть вызов **обновления базы данных** в консоли диспетчера пакетов), и этот метод обновляет строки, которые уже были вставлены или вставляет их, если они еще не существует.


**Нажмите клавиши CTRL + SHIFT + B для сборки проекта.** (Ниже завершится ошибкой, если ваш не на этом этапе построения.)

Следующим шагом является создание `DbMigration` класс для первоначальной миграции. Этот перенос создает новую базу данных, поэтому вы удалили *movie.mdf* файл на предыдущем шаге.

В **консоль диспетчера пакетов** окно, введите команду «add-migration Initial» для создания первоначальной миграции. Имя «Начальный» является произвольным и используется для именования создан файл для миграции.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image7.png)

Code First Migrations создает еще один файл класса в *миграций* папку (с именем *{метки даты}\_Initial.cs* ), и этот класс содержит код, создающий схему базы данных. Имя файла миграции предварительно исправлена с меткой времени для облегчения упорядочения. Изучите *{метки даты}\_Initial.cs* файл, он содержит инструкции для создания таблицы фильмы для базой данных Movie. При обновлении базы данных в инструкциях ниже, это *{метки даты}\_Initial.cs* файл будет выполняться и создать схему базы данных. Затем **начальное значение** метод выполняется для заполнения БАЗЫ данных тестовыми данными.

В **консоль диспетчера пакетов**, введите команду «update-database» для создания базы данных и запуска **начальное значение** метод.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image8.png)

Если отобразится сообщение об ошибке, указывающее таблицу, уже существует и не может быть создан, то, скорее всего вы запустили приложения после удаления базы данных и до выполнения `update-database`. В этом случае удалите *Movies.mdf* файл еще раз и повторите попытку `update-database` команды. Если вы по-прежнему возникает ошибка, удалите папку migrations и содержимое, а затем запустите с инструкциями в верхней части этой страницы (это delete *Movies.mdf* файл, а затем перейти к Enable-Migrations).

Запустите приложение и перейдите к */Movies* URL-адрес. Отображается начальные данные.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image9.png)

## <a name="adding-a-rating-property-to-the-movie-model"></a>Добавление свойства Rating в модель Movie

Начните с добавления нового `Rating` к существующему полю `Movie` класса. Откройте *Models\Movie.cs* файл и добавьте `Rating` свойство следующего вида:

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample3.cs)]

Полный `Movie` класса сейчас выглядит аналогично следующему коду:

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample4.cs?highlight=8)]

Постройте приложение в среде **построения** &gt; **построения фильма** меню команду или нажав сочетание клавиш CTRL-SHIFT-B.

Теперь, когда вы обновили `Model` класса, необходимо также обновить *\Views\Movies\Index.cshtml* и *\Views\Movies\Create.cshtml* просмотра шаблонов для отображения новых `Rating`свойства в представлении браузера.

Откройте<em>\Views\Movies\Index.cshtml</em> файл и добавьте `<th>Rating</th>` сразу после заголовка столбца <strong>цена</strong> столбца. Затем добавьте `<td>` столбца в конце шаблона для отображения `@item.Rating` значение. Ниже приведен какие обновленный <em>Index.cshtml</em> Просмотр шаблона выглядит как:

[!code-cshtml[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample5.cshtml?highlight=26-28,46-48)]

Затем откройте *\Views\Movies\Create.cshtml* файл и добавьте следующую разметку в конце формы. Это отрисовывает текстовое поле, можно указать оценку, если создается новый фильм.

[!code-cshtml[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample6.cshtml)]

Теперь вы обновили код приложения, поддерживающие новое `Rating` свойство.

Теперь запустите приложение и перейдите к */Movies* URL-адрес. При этом, однако вы увидите одно из следующих ошибок:

![](adding-a-new-field-to-the-movie-model-and-table/_static/image10.png)

![](adding-a-new-field-to-the-movie-model-and-table/_static/image11.png)

Вы видите эту ошибку, так как обновленный `Movie` класс модели в приложение теперь отличается от схемы `Movie` таблицы в существующей базе данных. (В таблице базы данных отсутствует столбец `Rating`.)


Устранить эту ошибку можно несколькими способами:

1. Можно с помощью Entity Framework автоматически удалить и повторно создать базу данных на основе новой схемы класса модели. Такой подход очень удобен при выполнении активное развертывание в тестовой базы данных; он позволяет быстро развитие модели и схемы базы данных осуществляется одновременно. Недостатком, однако является потеря существующих данных в базе данных, поэтому вы *не* хотите использовать этот подход на производственной базы данных! Часто используется инициализатор для автоматического заполнения базы тестовыми данными является эффективный способ разработки приложения. Дополнительные сведения об инициализаторах базы данных Entity Framework, см. в разделе том Дайкстра [учебник по ASP.NET MVC и Entity Framework](../../getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).
2. Можно явно изменить схему существующей базы данных в соответствии с новыми классами модели. Преимущество такого подхода состоит в том, что сохраняются все данные. Это изменение можно выполнить как вручную, так и с помощью соответствующего скрипта базы данных.
3. Можно обновить схему базы данных с помощью Code First Migrations.


В этом руководстве используется Code First Migrations.

Обновите метод заполнения, таким образом, чтобы он предоставлял значение нового столбца. Откройте файл Migrations\Configuration.cs и добавьте поле оценки для каждого объекта фильма.

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample7.cs?highlight=6)]

Выполните сборку решения, а затем откройте **консоль диспетчера пакетов** окна и введите следующую команду:

`add-migration AddRatingMig`

`add-migration` Команда указывает платформе миграции для проверки текущей модели фильма с текущей схемой базы данных фильмов и создать необходимый код для переноса базы данных в новую модель. AddRatingMig является произвольным и используется для имени файла переноса. Рекомендуется использовать понятное имя для этапов миграции.

По завершении этой команды Visual Studio открывает файл класса, который определяет новый `DbMigration` производного класса и в `Up` метода вы увидите код, создающий новый столбец.

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample8.cs)]

Выполните сборку решения, а затем введите команду «update-database» в **консоль диспетчера пакетов** окна.

На следующем рисунке показаны выходные данные в **консоль диспетчера пакетов** окна (Метка даты, добавляя AddRatingMig будет отличаться.)

![](adding-a-new-field-to-the-movie-model-and-table/_static/image12.png)

Повторно запустите приложение и перейдите к /Movies URL-адрес. Вы увидите новое поле оценки.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image13.png)

Нажмите кнопку **Create New** ссылку, чтобы добавить новый фильм. Обратите внимание на то, что вы можете добавить оценку.

![7_CreateRioII](adding-a-new-field-to-the-movie-model-and-table/_static/image14.png)

Нажмите кнопку **Создать**. Этот новый фильм, включая оценку, отображается в окне списка фильмов:

![7_ourNewMovie_SM](adding-a-new-field-to-the-movie-model-and-table/_static/image15.png)

Также следует добавить `Rating` поле для изменения "," Сведения "и" SearchIndex шаблонов представлений.

Можно ввести команду «update-database» в **консоль диспетчера пакетов** окно еще раз и изменения не будут внесены, так как схема соответствует модели.

В этом разделе вы узнали, как можно изменять объекты модели и синхронизации базы данных с изменениями. Вы также узнали способ заполнения вновь созданную базу данных с демонстрационными данными, можно опробовать сценарии. Теперь давайте взглянем на как можно добавить более широкие логику проверки в классы модели и включить некоторые бизнес-правила, которые будут применяться.

> [!div class="step-by-step"]
> [Назад](examining-the-edit-methods-and-edit-view.md)
> [Вперед](adding-validation-to-the-model.md)
