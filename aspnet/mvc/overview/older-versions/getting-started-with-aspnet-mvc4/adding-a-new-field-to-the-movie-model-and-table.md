---
uid: mvc/overview/older-versions/getting-started-with-aspnet-mvc4/adding-a-new-field-to-the-movie-model-and-table
title: Добавление нового поля в модель и таблицу фильмов | Документация Майкрософт
author: Rick-Anderson
description: Примечание. Обновленная версия этого учебника доступна здесь, в которой используется ASP.NET MVC 5 и Visual Studio 2013. Он более безопасен, гораздо проще в исполнении и демонстрации...
ms.author: riande
ms.date: 08/28/2012
ms.assetid: 9ef2c4f1-a305-4e0a-9fb8-bfbd9ef331d9
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-aspnet-mvc4/adding-a-new-field-to-the-movie-model-and-table
msc.type: authoredcontent
ms.openlocfilehash: d966b95163f64b20a17d2327a12c5d6c44a4a66b
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77457704"
---
# <a name="adding-a-new-field-to-the-movie-model-and-table"></a>Добавление нового поля в модель и таблицу Movie

по [Рик Андерсон (](https://twitter.com/RickAndMSFT)

> > [!NOTE]
> > Обновленная версия этого учебника доступна [здесь](../../getting-started/introduction/getting-started.md) , в которой используется ASP.NET MVC 5 и Visual Studio 2013. Он более безопасен, гораздо проще следовать и демонстрирует дополнительные функции.

В этом разделе вы будете использовать Entity Framework Code First Migrations для переноса некоторых изменений в классы модели, чтобы изменения применялись к базе данных.

По умолчанию при использовании Entity Framework Code First для автоматического создания базы данных, как это было сделано ранее в этом руководстве, Code First добавляет таблицу в базу данных, чтобы определить, синхронизирована ли схема базы данных с классами модели, из которых она была создана. Если они не синхронизированы, Entity Framework выдает ошибку. Это упрощает отслеживание проблем во время разработки, которые в противном случае могут быть найдены (путем маскировки ошибок) во время выполнения.

## <a name="setting-up-code-first-migrations-for-model-changes"></a>Настройка Code First Migrations для изменений модели

Если вы используете Visual Studio 2012, дважды щелкните файл *movies. mdf* в Обозреватель решений, чтобы открыть средство базы данных. Visual Studio Express для веб-узла покажет обозреватель базы данных, Visual Studio 2012 отобразит обозреватель сервера. Если вы используете Visual Studio 2010, используйте обозреватель объектов SQL Server.

В средстве "база данных" (обозреватель базы данных, обозреватель сервера или обозреватель объектов SQL Server) щелкните правой кнопкой мыши `MovieDBContext` и выберите **Удалить** , чтобы удалить базу данных фильмов.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image1.png)

Вернитесь к обозреватель решений. Щелкните правой кнопкой мыши файл *movies. mdf* и выберите **Удалить** , чтобы удалить базу данных фильмов.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image2.png)

Постройте приложение, чтобы убедиться в отсутствии ошибок.

В меню **Сервис** щелкните **Диспетчер пакетов NuGet**, а затем щелкните **Консоль диспетчера пакетов**.

![Добавить пакет man](adding-a-new-field-to-the-movie-model-and-table/_static/image3.png)

В окне **консоли диспетчера пакетов** в строке `PM>` введите "Enable-migrations-ContextTypeName MvcMovie. Models. мовиедбконтекст".

![](adding-a-new-field-to-the-movie-model-and-table/_static/image4.png)

Команда **включить-миграции** (показанная выше) создает файл *Configuration.CS* в новой папке *migrations* .

![](adding-a-new-field-to-the-movie-model-and-table/_static/image5.png)

Visual Studio откроет файл *Configuration.CS* . Замените метод `Seed` в файле *Configuration.CS* следующим кодом:

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample1.cs)]

Щелкните правой кнопкой мыши красную волнистую линию в разделе `Movie` и выберите **Разрешить** , **а затем —** **MvcMovie. Models;**

![](adding-a-new-field-to-the-movie-model-and-table/_static/image6.png)

При этом добавляется следующая инструкция using:

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample2.cs)]

> [!NOTE] 
> 
> Code First Migrations вызывает метод `Seed` после каждой миграции (то есть вызывает **Обновление базы данных** в консоли диспетчера пакетов), и этот метод обновляет уже вставленные строки или вставляет их, если они еще не существуют.

**Нажмите клавиши CTRL + SHIFT + B, чтобы выполнить сборку проекта.** (Если на этом этапе не выполняется сборка, следующие действия завершаются ошибкой.)

Следующим шагом является создание класса `DbMigration` для первоначальной миграции. Эта миграция создает новую базу данных, поэтому вы удалили файл *Movie. mdf* на предыдущем шаге.

В окне **консоли диспетчера пакетов** введите команду "добавить начальную миграцию", чтобы создать первоначальную миграцию. Имя «Initial» является произвольным и используется для имени создаваемого файла миграции.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image7.png)

Code First Migrations создает другой файл класса в папке *migrations* (с именем *{датестамп}\_Initial.CS* ), а этот класс содержит код, создающий схему базы данных. Имя файла миграции предварительно исправлено с меткой времени, помогающей в упорядочении. Проверьте файл *{датестамп}\_Initial.CS* , он содержит инструкции по созданию таблицы фильмов для базы данных Movie. При обновлении базы данных в приведенных ниже инструкциях файл *{датестамп}\_Initial.CS* будет запущен и создана схема базы данных. Затем будет выполнен метод **SEED** для заполнения базы данных тестовыми данными.

В **консоли диспетчера пакетов**введите команду Update-Database, чтобы создать базу данных и запустить метод **SEED** .

![](adding-a-new-field-to-the-movie-model-and-table/_static/image8.png)

Если появляется сообщение об ошибке, показывающее, что таблица уже существует и не может быть создана, возможно, приложение было запущено после удаления базы данных и перед выполнением `update-database`. В этом случае удалите файл *movies. mdf* еще раз и повторите команду `update-database`. Если вы по-прежнему получаете сообщение об ошибке, удалите папку и содержимое миграции, а затем начните с указания в верхней части этой страницы (которая удаляет файл *movies. mdf* , а затем переходит к включению-миграции).

Запустите приложение и перейдите по URL-адресу */Movies* . Отобразятся начальные данные.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image9.png)

## <a name="adding-a-rating-property-to-the-movie-model"></a>Добавление свойства Rating в модель Movie

Для начала добавьте новое свойство `Rating` в существующий класс `Movie`. Откройте файл *моделс\мовие.КС* и добавьте свойство `Rating` следующим образом:

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample3.cs)]

Теперь полный `Movie` класс выглядит следующим образом:

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample4.cs?highlight=8)]

Создайте приложение с помощью команды меню **построить** &gt;**создать фильм** или нажав клавиши CTRL + SHIFT + B.

Теперь, когда вы обновили класс `Model`, вам также потребуется обновить шаблоны представления *\виевс\мовиес\индекс.кштмл* и *\виевс\мовиес\креате.кштмл* , чтобы отобразить новое свойство `Rating` в представлении браузера.

Откройте файл<em>\виевс\мовиес\индекс.кштмл</em> и добавьте заголовок столбца `<th>Rating</th>` сразу после столбца <strong>Price</strong> . Затем добавьте `<td>` столбец рядом с концом шаблона, чтобы отобразить значение `@item.Rating`. Ниже показано, как выглядит обновленный шаблон представления <em>index. cshtml</em> :

[!code-cshtml[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample5.cshtml?highlight=26-28,46-48)]

Затем откройте файл *\виевс\мовиес\креате.кштмл* и добавьте следующую разметку в конец формы. При этом текстовое поле подготавливается к просмотру, что позволяет указать рейтинг при создании нового фильма.

[!code-cshtml[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample6.cshtml)]

Теперь вы обновили код приложения для поддержки нового свойства `Rating`.

Теперь запустите приложение и перейдите по URL-адресу */Movies* . Однако при этом вы увидите одну из следующих ошибок:

![](adding-a-new-field-to-the-movie-model-and-table/_static/image10.png)

![](adding-a-new-field-to-the-movie-model-and-table/_static/image11.png)

Эта ошибка возникает, поскольку обновленный класс модели `Movie` в приложении теперь отличается от схемы `Movie` таблицы существующей базы данных. (В таблице базы данных отсутствует столбец `Rating`.)

Устранить эту ошибку можно несколькими способами:

1. Можно с помощью Entity Framework автоматически удалить и повторно создать базу данных на основе новой схемы класса модели. Этот подход очень удобен при выполнении активной разработки в тестовой базе данных. Это позволяет быстро развивать модель и схему базы данных вместе. Недостаток этого подхода заключается в том, что в базе данных теряются существующие данные — поэтому вы *не* хотите использовать этот подход в рабочей базе данных! Использование инициализатора для автоматического заполнения базы данных с тестовыми данными часто является эффективным способом разработки приложения. Дополнительные сведения об Entity Framework инициализаторах баз данных см. в руководстве по [ASP.NET MVC и Entity Framework](../../getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)для Tom Dykstra).
2. Можно явно изменить схему существующей базы данных в соответствии с новыми классами модели. Преимущество такого подхода состоит в том, что сохраняются все данные. Это изменение можно выполнить как вручную, так и с помощью соответствующего скрипта базы данных.
3. Можно обновить схему базы данных с помощью Code First Migrations.

В этом руководстве используется Code First Migrations.

Обновите метод SEED, чтобы он выдает значение для нового столбца. Откройте файл Migrations\Configuration.cs и добавьте поле рейтинга в каждый объект Movie.

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample7.cs?highlight=6)]

Выполните сборку решения, а затем откройте окно **консоли диспетчера пакетов** и введите следующую команду:

`add-migration AddRatingMig`

Команда `add-migration` сообщает платформе миграции, что необходимо проверить текущую модель фильма с текущей схемой базы данных Movie и создать необходимый код для переноса базы данных в новую модель. Аддратингмиг является произвольным и используется для имени файла миграции. Полезно использовать понятное имя для шага миграции.

По завершении этой команды Visual Studio открывает файл класса, который определяет новый производный класс `DbMigration`, а в методе `Up` можно увидеть код, создающий новый столбец.

[!code-csharp[Main](adding-a-new-field-to-the-movie-model-and-table/samples/sample8.cs)]

Выполните сборку решения, а затем введите команду "обновить базу данных" в окне **консоли диспетчера пакетов** .

На следующем рисунке показаны выходные данные в окне **консоли диспетчера пакетов** (отметка даты ожидаемая аддратингмиг будет отличаться).

![](adding-a-new-field-to-the-movie-model-and-table/_static/image12.png)

Повторно запустите приложение и перейдите по URL-адресу/movies. Можно увидеть новое поле рейтинг.

![](adding-a-new-field-to-the-movie-model-and-table/_static/image13.png)

Щелкните ссылку **создать** , чтобы добавить новый фильм. Обратите внимание, что можно добавить оценку.

![7_CreateRioII](adding-a-new-field-to-the-movie-model-and-table/_static/image14.png)

Нажмите кнопку **Создать**. Теперь новый фильм, включая рейтинг, отображается в списке фильмов:

![7_ourNewMovie_SM](adding-a-new-field-to-the-movie-model-and-table/_static/image15.png)

Также следует добавить поле `Rating` в шаблоны представлений Edit, Details и Сеарчиндекс.

Можно снова ввести команду "обновить базу данных" в окне **консоли диспетчера пакетов** и не вносить изменения, так как схема соответствует модели.

В этом разделе вы узнали, как можно изменить объекты модели и синхронизировать базу данных с изменениями. Вы также узнали, как заполнить созданную базу данных образцами данных, чтобы вы могли испытать сценарии. Теперь рассмотрим, как можно добавить расширенную логику проверки к классам модели и обеспечить применение некоторых бизнес-правил.

> [!div class="step-by-step"]
> [Назад](examining-the-edit-methods-and-edit-view.md)
> [Вперед](adding-validation-to-the-model.md)
