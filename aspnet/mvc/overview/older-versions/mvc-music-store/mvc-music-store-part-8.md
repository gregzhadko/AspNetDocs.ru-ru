---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-8
title: Часть 8. Корзина для покупок с обновлениями AJAX | Документация Майкрософт
author: jongalloway
description: В этой серии руководств подробно описаны все шаги, предпринятые для создания примера приложения музыкального хранилища ASP.NET MVC. В части 8 описывается покупательская корзина с обновлениями AJAX.
ms.author: riande
ms.date: 04/21/2011
ms.assetid: 26b2f55e-ed42-4277-89b0-c941eb754145
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-8
msc.type: authoredcontent
ms.openlocfilehash: 89897ad41b217764cbd17317d4bf5d6a5c5d488f
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78433518"
---
# <a name="part-8-shopping-cart-with-ajax-updates"></a>Часть 8. Корзина для покупок с обновлениями AJAX

[Джон Гэллоуэй](https://github.com/jongalloway)

> Музыкальное хранилище MVC — это учебное приложение, в котором представлены и объясняются пошаговые инструкции по использованию ASP.NET MVC и Visual Studio для разработки веб-приложений.  
>   
> Музыкальное хранилище MVC — это упрощенная реализация в магазине, которая продает музыкальные альбомы в сети и реализует базовое администрирование сайта, вход пользователя в систему и функции корзины покупок.  
>   
> В этой серии руководств подробно описаны все шаги, предпринятые для создания примера приложения музыкального хранилища ASP.NET MVC. В части 8 описывается покупательская корзина с обновлениями AJAX.

Мы разоставим пользователям возможность размещения альбомов в корзине без регистрации, но для завершения их извлечения потребуется зарегистрироваться как гости. Процесс покупки и извлечения будет разделен на два контроллера: контроллер ShoppingCart, который разрешает анонимное Добавление элементов в корзину и контроллер извлечения, который обрабатывает процесс извлечения. Мы начнем с корзины для покупок в этом разделе, а затем создадим процесс извлечения в следующем разделе.

## <a name="adding-the-cart-order-and-orderdetail-model-classes"></a>Добавление классов моделей корзины, заказов и OrderDetail

В нашей корзине и процессах извлечения будут использоваться некоторые новые классы. Щелкните правой кнопкой мыши папку Models и добавьте класс корзины (Cart.cs) со следующим кодом.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample1.cs)]

Этот класс очень похож на другие, которые мы использовали до сих пор, за исключением атрибута [key] для свойства RecordId. Наши элементы корзины будут иметь строковый идентификатор с именем Картид, чтобы разрешить анонимные покупки, но таблица включает целочисленный первичный ключ с именем RecordId. По соглашению Entity Framework Code-First ожидает, что первичный ключ для таблицы с именем корзины будет либо Картид, либо ИДЕНТИФИКАТОРом, но мы можем легко переопределить это с помощью заметок или кода, если это необходимо. Вот пример того, как мы можем использовать простые соглашения в Entity Framework коде — сначала, если они соответствуют нам, но мы не ограничены по ним, если это не так.

Затем добавьте класс Order (Order.cs) со следующим кодом.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample2.cs)]

Этот класс отслеживает сводку и сведения о доставке для заказа. **Он еще не компилируется**, так как имеет свойство навигации OrderDetails, которое зависит от класса, который еще не создан. Теперь добавим класс с именем OrderDetail.cs, добавив в него следующий код.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample3.cs)]

Мы сделаем Последнее обновление нашего класса Мусиксторинтитиес, чтобы включить Дбсетс, которые предоставляют эти новые классы модели, также включая DbSet&lt;исполнителя&gt;. Обновленный класс Мусиксторинтитиес выглядит следующим образом.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample4.cs)]

## <a name="managing-the-shopping-cart-business-logic"></a>Управление бизнес-логикой покупательской корзины

Далее мы создадим класс ShoppingCart в папке Models. Модель ShoppingCart обрабатывает доступ к данным в таблице корзины. Кроме того, он будет выполнять бизнес-логику для добавления и удаления элементов из корзины для покупок.

Так как мы не хотим требовать от пользователей регистрации учетной записи только для добавления элементов в покупательскую корзину, мы назначаем пользователям временный уникальный идентификатор (с помощью GUID или глобальный уникальный идентификатор) при обращении к корзине для покупок. Этот идентификатор будет храниться с помощью класса сеанса ASP.NET.

*Примечание. сеанс ASP.NET — это удобное место для хранения сведений о пользователе, срок действия которого истекает после выхода сайта. В то время как неправильное использование состояния сеанса может негативно сказаться на производительности на больших сайтах, наша легкая работа будет хорошо работать в демонстрационных целях.*

Класс ShoppingCart предоставляет следующие методы:

**Аддтокарт** принимает в качестве параметра альбом и добавляет его в корзину пользователя. Так как таблица корзины отслеживает количество для каждого альбома, она включает в себя логику для создания новой строки при необходимости или просто увеличивает количество, если пользователь уже выполнил сортировку по одной копии альбома.

**Ремовефромкарт** принимает идентификатор альбома и удаляет его из корзины пользователя. Если у пользователя есть только одна копия альбома в корзине, строка удаляется.

**Емптикарт** удаляет все элементы из покупательской корзины пользователя.

**Жеткартитемс** извлекает список картитемс для вывода или обработки.

Функция **NOCOUNT** извлекает общее число альбомов, имеющихся у пользователя в корзине для покупок.

**Подытог** вычисляет общую стоимость всех элементов в корзине.

**CreateOrder** преобразует корзину для покупок в заказ на этапе извлечения.

GetObject **— это статический метод,** позволяющий контроллерам получить объект корзины. Он использует метод **жеткартид** для управления чтением картид из сеанса пользователя. Метод Жеткартид требует HttpContextBase, чтобы он мог считывать Картид пользователя из сеанса пользователя.

Вот полный **класс ShoppingCart**:

[!code-csharp[Main](mvc-music-store-part-8/samples/sample5.cs)]

## <a name="viewmodels"></a>Модели представлений

Нашему контроллеру покупательской корзины необходимо передать некоторую сложную информацию в свои представления, которые не будут четко сопоставляться с нашими объектами модели. Мы не хотим изменять наши модели в соответствии с нашими представлениями; Классы моделей должны представлять наш домен, а не пользовательский интерфейс. Одним из решений было бы передача информации в наши представления с помощью класса ViewBag, как это было сделано с раскрывающимся списком менеджеров магазина, но передача большого объема информации через ViewBag становится трудной для управления.

Решением этой проблемы является использование шаблона *ViewModel* . При использовании этого шаблона создаются строго типизированные классы, оптимизированные для наших сценариев представления, которые предоставляют свойства для динамических значений и содержимого, необходимых для наших шаблонов представления. Наши классы контроллеров могут затем заполнять и передавать эти оптимизированные для просмотра классы в наш шаблон представления для использования. Это обеспечивает безопасность типов, проверку во время компиляции и IntelliSense в редакторе в шаблонах представления.

Мы создадим две модели представления для использования в нашем контроллере покупательской корзины: Шоппингкартвиевмодел будет содержать содержимое покупательской корзины, а Шоппингкартремовевиевмодел будет использоваться для отображения сведений о подтверждении, когда пользователь удаляет что-либо. из своей корзины.

Давайте создадим новую папку ViewModels в корне нашего проекта, чтобы не усложнять их. Щелкните правой кнопкой мыши проект и выберите Добавить или создать папку.

![](mvc-music-store-part-8/_static/image1.jpg)

Присвойте папке имя ViewModel.

![](mvc-music-store-part-8/_static/image1.png)

Затем добавьте класс Шоппингкартвиевмодел в папку ViewModels. Он имеет два свойства: список элементов корзины и десятичное значение для хранения общей цены для всех элементов в корзине.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample6.cs)]

Теперь добавьте Шоппингкартремовевиевмодел в папку ViewModels со следующими четырьмя свойствами.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample7.cs)]

## <a name="the-shopping-cart-controller"></a>Контроллер корзины для покупок

Контроллер корзины для покупок имеет три основных цели: Добавление элементов в корзину, удаление элементов из корзины и просмотр элементов в корзине. В нем будут использоваться только что созданные три класса: Шоппингкартвиевмодел, Шоппингкартремовевиевмодел и ShoppingCart. Как и в Стореконтроллер и Стореманажерконтроллер, мы добавим поле для хранения экземпляра Мусиксторинтитиес.

Добавьте новый контроллер корзины для покупок в проект, используя пустой шаблон контроллера.

![](mvc-music-store-part-8/_static/image2.png)

Вот полный контроллер ShoppingCart. Действия индекса и добавления контроллера должны выглядеть очень хорошо. Действия контроллера Remove и Картсуммари обрабатывались в двух особых случаях, которые обсуждаются в следующем разделе.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample8.cs)]

## <a name="ajax-updates-with-jquery"></a>Обновления AJAX с jQuery

Далее мы создадим страницу индекса покупательской корзины, которая является строго типизированной для Шоппингкартвиевмодел и использует шаблон представления списка, используя тот же метод, что и раньше.

![](mvc-music-store-part-8/_static/image3.png)

Однако вместо использования HTML. ActionLink для удаления элементов из корзины мы будем использовать jQuery для "подключения" события Click для всех ссылок в этом представлении, имеющих HTML-класс Ремовелинк. Вместо отправки формы этот обработчик событий щелчка мыши просто сделает обратный вызов AJAX для нашего действия контроллера Ремовефромкарт. Ремовефромкарт Возвращает сериализованный результат JSON, который затем осуществляет обратный вызов jQuery и выполняет четыре быстрых обновления страницы с помощью jQuery:

- 1. Удаляет удаленный альбом из списка
- 2. Обновляет число корзин в заголовке
- 3. Отображает сообщение об обновлении для пользователя
- 4. Обновляет общую цену корзины

Так как сценарий удаления обрабатывается обратным вызовом AJAX в представлении индекса, для действия Ремовефромкарт не требуется дополнительное представление. Ниже приведен полный код для представления/Шоппингкарт/индекс:

[!code-cshtml[Main](mvc-music-store-part-8/samples/sample9.cshtml)]

Чтобы протестировать это, нам нужно иметь возможность добавлять элементы в нашу корзину для покупок. Мы будем обновлять наше представление **сведений о магазине** , включив кнопку "добавить в корзину". Мы можем включить в него некоторые дополнительные сведения, которые мы добавили с момента последнего обновления этого представления: Жанр, исполнитель, Цена и обложка альбома. Обновленный код представления сведений о магазине отображается, как показано ниже.

[!code-cshtml[Main](mvc-music-store-part-8/samples/sample10.cshtml)]

Теперь мы можем щелкнуть магазин и протестировать Добавление и удаление альбомов в нашей корзине для покупок. Запустите приложение и перейдите к индексу магазина.

![](mvc-music-store-part-8/_static/image4.png)

Затем щелкните Жанр, чтобы просмотреть список альбомов.

![](mvc-music-store-part-8/_static/image5.png)

Щелкнув название альбома, вы увидите обновленное представление сведений о альбоме, включая кнопку "добавить в корзину".

![](mvc-music-store-part-8/_static/image6.png)

При нажатии кнопки "добавить в корзину" отображается представление индекса корзины для покупок с перечнем сводки корзины.

![](mvc-music-store-part-8/_static/image7.png)

После загрузки корзины для покупок можно щелкнуть ссылку удалить из корзины, чтобы просмотреть обновление AJAX в корзину для покупок.

![](mvc-music-store-part-8/_static/image8.png)

Мы создали рабочую корзину для покупок, которая позволяет незарегистрированным пользователям добавлять элементы в корзину. В следующем разделе мы развернемся к регистрации и завершению процесса извлечения.

> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-7.md)
> [Вперед](mvc-music-store-part-9.md)
