---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-8
title: Часть 8. Корзина для покупок с обновлениями Ajax | Документация Майкрософт
author: jongalloway
description: В этой серии руководств описаны все шаги, необходимые для построения примера приложения ASP.NET MVC Music Store. Часть 8 рассматриваются корзину для покупок с обновлениями Ajax.
ms.author: riande
ms.date: 04/21/2011
ms.assetid: 26b2f55e-ed42-4277-89b0-c941eb754145
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-8
msc.type: authoredcontent
ms.openlocfilehash: 89897ad41b217764cbd17317d4bf5d6a5c5d488f
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65112909"
---
# <a name="part-8-shopping-cart-with-ajax-updates"></a>Часть 8. Корзина для покупок с обновлениями Ajax

по [Джон Гэллоуэй](https://github.com/jongalloway)

> Store музыки MVC является учебного приложения, которое вводятся и описываются пошаговые использование ASP.NET MVC и Visual Studio для разработки веб-приложений.  
>   
> Store музыки MVC — это реализация хранилища упрощенный пример, который продает музыкальные альбомы через Интернет и реализует базовый сайт администрирования, вход пользователя и корзины для покупок функциональные возможности.  
>   
> В этой серии руководств описаны все шаги, необходимые для построения примера приложения ASP.NET MVC Music Store. Часть 8 рассматриваются корзину для покупок с обновлениями Ajax.

Я разрешу пользователям помещать альбомов в их для покупок без регистрации, но им нужно будет зарегистрировать в качестве гостей для завершения извлечения. В процессе покупки и извлечения будут разделены на два контроллера: контроллер ShoppingCart, который разрешает анонимно Добавление элементов в корзину и извлечение контроллер, который обрабатывает процесс подсчета стоимости сначала. Мы будем приступить к корзине для покупок в этом разделе, а затем сформируйте процесс подсчета стоимости покупок в следующем разделе.

## <a name="adding-the-cart-order-and-orderdetail-model-classes"></a>Добавление классов модели для покупок, Order и OrderDetail

Сделает наши процессы корзину для покупок и извлечение использование некоторых новых классов. Щелкните правой кнопкой мыши папку Models и добавьте класс корзины для покупок (Cart.cs) следующим кодом.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample1.cs)]

Этот класс является довольно аналогично другим пользователям, которые мы использовали на данный момент, за исключением атрибута [Key] для свойства RecordId. Наши элементам корзины покупок будет иметь идентификатор строки с именем CartID, чтобы разрешить анонимный покупок, но в таблице содержатся целочисленного первичного ключа с именем RecordId. По соглашению Entity Framework Code First ожидает, что первичный ключ для таблицы с именем для покупок будет CartId или идентификатор, что мы можно легко изменить, с помощью заметок или кода при необходимости. Ниже приведен пример того, как мы можно использовать простой соглашения в Entity Framework Code-First при соответствии им с нами, но мы не являетесь ограничен типом их, когда они не.

Добавьте класс Order (Order.cs) следующим кодом.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample2.cs)]

Этот класс отслеживает сведения сводки и доставки для заказа. **Она не будет компилироваться еще**, так как он имеет свойство навигации OrderDetails зависящее от класса, мы еще не созданы. Исправим внимание на то, что теперь, добавив класс с именем OrderDetail.cs, добавив следующий код.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample3.cs)]

Мы внесем одно последнее обновление к нашему классу MusicStoreEntities для включения DbSets, которую позднее предоставите эти новые классы модели, включая DbSet также&lt;исполнителя&gt;. Обновленный класс MusicStoreEntities отображается как ниже.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample4.cs)]

## <a name="managing-the-shopping-cart-business-logic"></a>Управление бизнес-логики корзину для покупок

Далее мы создадим класс ShoppingCart в папку Models. Модель ShoppingCart обрабатывает доступ к данным в таблицу для покупок. Кроме того он будет обрабатывать бизнес-логику для добавления и удаления элементов из корзины.

Так как мы не хотим пользователям необходимо зарегистрировать учетную запись только для добавления элементов в корзину, будут назначены пользователям временный уникальный идентификатор (используя GUID или глобальный уникальный идентификатор) при получении доступа к корзине для покупок. Мы будем хранить этот идентификатор, с помощью класса сеанса ASP.NET.

*Примечание. В сеансе ASP.NET — это удобное место для хранения данных конкретного пользователя, которой истечет после увольнения сайта. Хотя неправильное использование состояния сеанса может негативно влиять на производительность на больших сайтах, света использование хорошо работает для демонстрационных целей.*

Класс ShoppingCart предоставляет следующие методы:

**AddToCart** принимает альбом в качестве параметра и добавляет его в корзину пользователя. Так как в таблице покупок, отслеживает количество для каждого альбома содержит логику для создания новой строки, при необходимости или просто увеличить количество, если пользователь уже заказать одну копию альбома.

**RemoveFromCart** принимает идентификатор альбома и удаляет его из корзины пользователя. Если пользователь только одна копия альбом в их для покупок, то строка удаляется.

**EmptyCart** удаляет все элементы из корзины пользователя.

**GetCartItems** извлекает список CartItems для отображения или обработки.

**GetCount** извлекает общее число альбомов, у пользователя в его корзине.

**GetTotal, используемую** вычисляет общую стоимость всех элементов в корзине.

**CreateOrder** преобразует Корзина для покупок в заказ на этапе оформления заказа.

**GetCart** — это статический метод, позволяющий наших контроллерах, чтобы получить объект корзины для покупок. Она использует **GetCartId** метод для обработки чтения CartId из сеанса пользователя. Метод GetCartId требует HttpContextBase таким образом, он может считывать CartId пользователя из сеанса пользователя.

Ниже приведен полный **класс ShoppingCart**:

[!code-csharp[Main](mvc-music-store-part-8/samples/sample5.cs)]

## <a name="viewmodels"></a>Модели представлений

Контроллер корзины для покупок, потребуется некоторые сложную информацию для своих представлений, который не полностью сопоставлен с нашей модели объектов. Мы не хотим изменить наши модели в соответствии с наши представления; Классы модели должна представлять наш домен, а не пользовательского интерфейса. Одним из решений будет для передачи информации в наши представления, с помощью класса ViewBag, как мы сделали с информацией раскрывающийся список Store Manager, однако передача больших данных с помощью ViewBag получает сложнее в управлении.

Решением является использование *ViewModel* шаблон. При использовании этого шаблона, мы создаем классы со строгой типизацией, оптимизированных для наших вариантов использования конкретного представления и предоставляют свойства для динамического значения или содержимого необходимые наших шаблонов представлений. Наши классы контроллера можно заполнить и передать шаблон представления для использования этих классов, оптимизированный для представления. Благодаря этому безопасность типов, проверки во время компиляции и редактор IntelliSense в шаблоны представлений.

Мы создадим две модели представления для использования в своем контроллере корзину для покупок: ShoppingCartViewModel будет содержать содержимое корзины пользователя, и чтобы отобразить сведения о подтверждении, когда пользователь удаляет что-то будет использоваться ShoppingCartRemoveViewModel из корзины покупателя.

Давайте создадим новую папку ViewModels в корне нашего проекта, чтобы не усложнять организации. Щелкните правой кнопкой мыши проект, выберите Add / новую папку.

![](mvc-music-store-part-8/_static/image1.jpg)

Назовите папку ViewModels.

![](mvc-music-store-part-8/_static/image1.png)

Добавьте в класс ShoppingCartViewModel в папку ViewModels. Он имеет два свойства: список элементов корзины покупок и десятичное значение для хранения итоговая цена для всех элементов в корзине.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample6.cs)]

Теперь добавьте ShoppingCartRemoveViewModel в папку ViewModels с следующие четыре свойства.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample7.cs)]

## <a name="the-shopping-cart-controller"></a>Контроллер корзины

Корзина для покупок контроллер имеет три основные функции: Добавление элементов в корзину, удаление элементов из корзины и просмотр элементов в корзине. Это сделает использовать из трех классов, мы только что создали: ShoppingCartViewModel ShoppingCartRemoveViewModel и ShoppingCart. Как и в StoreController и StoreManagerController мы добавим поле, содержащее экземпляр MusicStoreEntities.

Добавите новый контроллер корзину для покупок в проект с помощью шаблона пустой контроллер.

![](mvc-music-store-part-8/_static/image2.png)

Ниже приведен полный контроллер ShoppingCart. Действия индекса и добавление контроллера покажется очень знакомой. Удаление и CartSummary действия контроллера обрабатывать два особых случаев, которые мы обсудим в следующем разделе.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample8.cs)]

## <a name="ajax-updates-with-jquery"></a>AJAX-обновления с jQuery

Далее мы создадим страницу индекса Корзина для покупок, строго типизируется с ShoppingCartViewModel и использует шаблон представления списка, используя тот же метод.

![](mvc-music-store-part-8/_static/image3.png)

Тем не менее вместо использования Html.ActionLink для удаления элементов из корзины, мы будем использовать jQuery для «подключения» события щелчка для всех ссылок в этом представлении, имеющие класс HTML RemoveLink. Вместо того чтобы обратной передачи формы, этот обработчик событий click просто сделает обратный вызов AJAX к действию контроллера наших RemoveFromCart. RemoveFromCart возвращает результат сериализации JSON, который затем выполняет синтаксический анализ наш jQuery обратного вызова и выполняет четыре быстрого обновления страницы с помощью jQuery:

- 1. Удаляет из списка удаленных альбома
- 2. Обновляет счетчик для покупок в заголовке
- 3. Отображает сообщение об обновлении для пользователя
- 4. Обновляет итоговая цена для покупок

Так как в сценарии remove обрабатываются обратного вызова Ajax в представлении индекса, мы не требуется дополнительного представления для RemoveFromCart действие. Ниже приведен полный код для представления /ShoppingCart/Index:

[!code-cshtml[Main](mvc-music-store-part-8/samples/sample9.cshtml)]

Чтобы убедиться, нам нужно иметь возможность добавлять элементы в нашей корзину для покупок. Мы обновим наши **сведения Store** представление, включив кнопка «Добавить в корзину». Хотя мы взялись за это, мы может включать некоторые дополнительные сведения о диске, который мы добавили так, как мы последнего обновления в этом представлении: Genre, исполнителя, цены и альбома. Обновленные сведения Store код представления выглядит следующим образом.

[!code-cshtml[Main](mvc-music-store-part-8/samples/sample10.cshtml)]

Теперь мы помогают выбрать хранилище и тестирования, добавление и удаление альбомов в и из наших корзину для покупок. Запустите приложение и перейдите к индексу Store.

![](mvc-music-store-part-8/_static/image4.png)

Далее щелкните жанра, чтобы просмотреть список альбомов.

![](mvc-music-store-part-8/_static/image5.png)

Теперь щелкните название альбома отобразить нашего обновленные сведения об альбоме представления, включая кнопка «Добавить в корзину».

![](mvc-music-store-part-8/_static/image6.png)

Нажатие кнопки «Добавить в корзину» показывает нашего представления индекса корзину для покупок в сводном списке корзину для покупок.

![](mvc-music-store-part-8/_static/image7.png)

После загрузки вашей корзины для покупок, можно щелкнуть удалить из корзины для покупок ссылку, чтобы увидеть обновление Ajax в корзину для покупок.

![](mvc-music-store-part-8/_static/image8.png)

Мы создали out рабочее Корзина для покупок, что позволяет незарегистрированных пользователей для добавления элементов в корзину. В следующем разделе будет разрешить их регистрации и завершить процесс подсчета стоимости сначала.

> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-7.md)
> [Вперед](mvc-music-store-part-9.md)
