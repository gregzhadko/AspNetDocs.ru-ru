---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-4
title: Часть 4. модели и доступ к данным | Документация Майкрософт
author: jongalloway
description: В этой серии руководств подробно описаны все шаги, предпринятые для создания примера приложения музыкального хранилища ASP.NET MVC. В части 4 приводятся модели и доступ к данным.
ms.author: riande
ms.date: 04/21/2011
ms.assetid: ab55ca81-ab9b-44a0-8700-dc6da2599335
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-4
msc.type: authoredcontent
ms.openlocfilehash: 402be340f1ea3344675e7b859cea8c5130cfc8ee
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78451020"
---
# <a name="part-4-models-and-data-access"></a>Часть 4. модели и доступ к данным

[Джон Гэллоуэй](https://github.com/jongalloway)

> Музыкальное хранилище MVC — это учебное приложение, в котором представлены и объясняются пошаговые инструкции по использованию ASP.NET MVC и Visual Studio для разработки веб-приложений.  
>   
> Музыкальное хранилище MVC — это упрощенная реализация в магазине, которая продает музыкальные альбомы в сети и реализует базовое администрирование сайта, вход пользователя в систему и функции корзины покупок.
> 
> В этой серии руководств подробно описаны все шаги, предпринятые для создания примера приложения музыкального хранилища ASP.NET MVC. В части 4 приводятся модели и доступ к данным.

До сих пор мы только передаем "фиктивные данные" с наших контроллеров в наши шаблоны представления. Теперь все готово к подключению реальной базы данных. В этом учебнике мы покажем, как использовать выпуск SQL Server Compact Edition (часто именуемый SQL CE) в качестве ядра СУБД. SQL CE — это бесплатная встроенная база данных на основе файлов, которая не требует установки или настройки, что делает ее действительно удобной для локальной разработки.

## <a name="database-access-with-entity-framework-code-first"></a>Доступ к базе данных с помощью Entity Frameworkного кода — сначала

Мы будем использовать поддержку Entity Framework (EF), которая включена в проекты ASP.NET MVC 3 для запроса и обновления базы данных. EF — это гибкая функция API данных реляционного сопоставления объектов, позволяющая разработчикам запрашивать и обновлять данные, хранящиеся в базе данных, в объектно-ориентированном виде.

Entity Framework версии 4 поддерживает парадигму разработки, именуемую Code-First. Code-First позволяет создавать объекты модели путем написания простых классов (также известных как POCO из «обычных» объектов CLR) и даже создавать базу данных на лету из классов.

### <a name="changes-to-our-model-classes"></a>Изменения в наших классах модели

В Entity Framework в этом руководстве мы будем использовать функцию создания базы данных. Тем не менее, прежде чем делать это, давайте сделаем несколько незначительных изменений наших классов модели, чтобы добавить некоторые вещи, которые будут использоваться позже.

#### <a name="adding-the-artist-model-classes"></a>Добавление классов модели исполнителя

Наши альбомы будут связаны с исполнителями, поэтому мы добавим простой класс модели для описания исполнителя. Добавьте новый класс в папку Models с именем Artist.cs, используя приведенный ниже код.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample1.cs)]

#### <a name="updating-our-model-classes"></a>Обновление наших классов модели

Обновите класс альбома, как показано ниже.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample2.cs)]

Затем внесите следующие изменения в класс жанра.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample3.cs)]

### <a name="adding-the-app_data-folder"></a>Добавление папки данных приложения\_

Мы добавим каталог данных приложения\_в наш проект для хранения файлов базы данных SQL Server Express. Данные\_приложений — это специальный каталог в ASP.NET, который уже имеет правильные разрешения безопасности доступа к базе данных. В меню Проект выберите пункт Добавить папку ASP.NET, а затем —\_данные приложения.

![](mvc-music-store-part-4/_static/image1.png)

### <a name="creating-a-connection-string-in-the-webconfig-file"></a>Создание строки подключения в файле Web. config

Мы добавим несколько строк в файл конфигурации веб-сайта, чтобы Entity Framework знать, как подключиться к нашей базе данных. Дважды щелкните файл Web. config, расположенный в корневом каталоге проекта.

![](mvc-music-store-part-4/_static/image2.png)

Прокрутите файл до конца и добавьте &lt;connectionString&gt; раздел непосредственно над последней строкой, как показано ниже.

[!code-xml[Main](mvc-music-store-part-4/samples/sample4.xml)]

### <a name="adding-a-context-class"></a>Добавление класса контекста

Щелкните правой кнопкой мыши папку Models и добавьте новый класс с именем MusicStoreEntities.cs.

![](mvc-music-store-part-4/_static/image3.png)

Этот класс будет представлять контекст базы данных Entity Framework и будет выполнять операции создания, чтения, обновления и удаления для нас. Код для этого класса показан ниже.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample5.cs)]

Вот и другие настройки, специальные интерфейсы и т. д. Благодаря расширению базового класса DbContext наш класс Мусиксторинтитиес способен справиться с нашими операциями с базой данных. Теперь, когда у нас есть подключение, давайте добавим еще несколько свойств в наши классы модели, чтобы воспользоваться преимуществами некоторых дополнительных сведений в нашей базе данных.

### <a name="adding-our-store-catalog-data"></a>Добавление данных каталога магазинов

Мы будем использовать функцию в Entity Framework, которая добавляет "начальные" данные во вновь созданную базу данных. В нашем каталоге магазина будет заполняться список жанров, исполнителей и альбомов. Загрузка Мвкмусиксторе-Ассетс. zip, которая включала в себя файлы разработки сайта, использовавшиеся ранее в этом руководстве, содержит файл класса с этими начальными данными, расположенный в папке с именем Code.

В папке Code/Models выберите файл SampleData.cs и поместите его в папку Models в нашем проекте, как показано ниже.

![](mvc-music-store-part-4/_static/image4.png)

Теперь нужно добавить одну строку кода, чтобы сообщить Entity Framework об этом классе SampleData. Дважды щелкните файл Global. asax в корневом каталоге проекта, чтобы открыть его, и добавьте следующую строку в начало приложения\_запуск.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample6.cs)]

На этом этапе мы завершили работу, необходимую для настройки Entity Framework для нашего проекта.

## <a name="querying-the-database"></a>Запрос к базе данных

Теперь давайте изменим наш Стореконтроллер, чтобы вместо использования "фиктивных данных" вместо этого он обращается к нашей базе данных для запроса всей информации. Начнем с объявления поля в **стореконтроллер** для хранения экземпляра класса мусиксторинтитиес с именем сторедб:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample7.cs)]

### <a name="updating-the-store-index-to-query-the-database"></a>Обновление индекса хранилища для запроса базы данных

Класс Мусиксторинтитиес поддерживается Entity Framework и предоставляет свойство коллекции для каждой таблицы в нашей базе данных. Давайте изменим действие индекса Стореконтроллер, чтобы получить все жанры в нашей базе данных. Ранее мы сделали это с помощью жестко запрограммированных строковых данных. Теперь можно просто использовать Entity Frameworkную коллекцию Женерес Context:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample8.cs)]

В наш шаблон представления не нужно вносить никаких изменений, так как мы по-прежнему возвращаем те же Стореиндексвиевмодел, которые мы возвращали до-мы просто возвращаем данные из нашей базы данных прямо сейчас.

После повторного запуска проекта и перехода по URL-адресу «/Store» будет выведен список всех жанров в нашей базе данных:

![](mvc-music-store-part-4/_static/image1.jpg)

### <a name="updating-store-browse-and-details-to-use-live-data"></a>Обновление обзора и сведений о магазине для использования динамических данных

При использовании метода действия/Сторе/бровсе? жанр = *[some-жанр]* выполняется поиск жанра по имени. Мы предполагаем только один результат, так как у нас никогда не будет двух записей с одинаковым названием жанра, и поэтому мы можем использовать. Single () в LINQ для запроса соответствующего объекта жанра (это еще не вводите):

[!code-csharp[Main](mvc-music-store-part-4/samples/sample9.cs)]

Один метод принимает лямбда-выражение в качестве параметра, которое указывает, что нам нужен один объект жанра, который соответствует заданному значению. В приведенном выше примере мы загружаем один объект жанра со значением Name, соответствующим Disco.

Мы будем использовать функцию Entity Framework, которая позволяет указать другие связанные сущности, которые нужно загрузить, а также при извлечении объекта жанра. Эта функция называется формированием результатов запроса и позволяет сократить количество обращений к базе данных, чтобы получить всю необходимую информацию. Мы хотим предварительно получить Альбомы для жанра, который мы получаем, поэтому мы будем обновлять наш запрос для включения в жанры. Включите ("альбомы"), чтобы указать, что нам нужны связанные альбомы. Это более эффективно, так как в одном запросе к базе данных будут извлекаться данные о жанре и альбоме.

Выполнив объяснения, мы рассмотрим, как выглядит обновленное действие контроллера Browse:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample10.cs)]

Теперь можно обновить представление обзора хранилища, чтобы отобразить альбомы, доступные в каждом жанре. Откройте шаблон представления (находится в/Виевс/Сторе/бровсе.кштмл) и добавьте маркированный список альбомов, как показано ниже.

[!code-cshtml[Main](mvc-music-store-part-4/samples/sample11.cshtml)]

Запустив наше приложение и перейдя к/Сторе/бровсе? Жанр = Джаз, вы увидите, что наши результаты теперь извлекаются из базы данных, отображая все альбомы в нашем выбранном жанре.

![](mvc-music-store-part-4/_static/image2.jpg)

Мы изменим те же изменения в нашем URL-адресе/Сторе/детаилс/[ID] и заменяем фиктивные данные запросом к базе данных, который загружает альбом, идентификатор которого соответствует значению параметра.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample12.cs)]

Запуск нашего приложения и просмотр в/Store/Details/1 показывает, что наши результаты теперь извлекаются из базы данных.

![](mvc-music-store-part-4/_static/image5.png)

Теперь, когда страница сведений о магазине настроена на отображение альбома по ИДЕНТИФИКАТОРу альбома, обновите представление " **Обзор** ", чтобы связать с представлением сведений. Мы будем использовать HTML. ActionLink, точно так же, как мы содержали ссылку из индекса магазина, чтобы сохранить обзор в конце предыдущего раздела. Полный исходный код для представления "Обзор" показан ниже.

[!code-cshtml[Main](mvc-music-store-part-4/samples/sample13.cshtml)]

Теперь можно перейти со страницы Store на страницу жанра, в которой перечислены доступные альбомы, а также щелкнуть альбом, чтобы просмотреть сведения об этом альбоме.

![](mvc-music-store-part-4/_static/image6.png)

> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-3.md)
> [Вперед](mvc-music-store-part-5.md)
