---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-4
title: Часть 4. Модели и доступ к данным | Документация Майкрософт
author: jongalloway
description: В этой серии руководств описаны все шаги, необходимые для построения примера приложения ASP.NET MVC Music Store. Часть 4 описывает моделей и доступа к данным.
ms.author: riande
ms.date: 04/21/2011
ms.assetid: ab55ca81-ab9b-44a0-8700-dc6da2599335
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-4
msc.type: authoredcontent
ms.openlocfilehash: 6a07bf6c8a3fb926ae25fe1f6c9359e64cd7a290
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57041221"
---
<a name="part-4-models-and-data-access"></a>Часть 4. Модели и доступ к данным
====================
по [Джон Гэллоуэй](https://github.com/jongalloway)

> Store музыки MVC является учебного приложения, которое вводятся и описываются пошаговые использование ASP.NET MVC и Visual Studio для разработки веб-приложений.  
>   
> Store музыки MVC — это реализация хранилища упрощенный пример, который продает музыкальные альбомы через Интернет и реализует базовый сайт администрирования, вход пользователя и корзины для покупок функциональные возможности.
> 
> В этой серии руководств описаны все шаги, необходимые для построения примера приложения ASP.NET MVC Music Store. Часть 4 описывает моделей и доступа к данным.


На данный момент мы просто передача «фиктивных данных» с нашей контроллеров в наших шаблонов представлений. Теперь мы готовы для подключения к любой настоящей базе данных. В этом руководстве мы будем рассматривать способы использования SQL Server Compact Edition (часто называемые SQL CE) как наша подсистема базы данных. SQL CE — это бесплатная, внедренная, файловая база данных, не требующий любой установки или настройки, что делает его очень удобным для локальной разработки.

## <a name="database-access-with-entity-framework-code-first"></a>Доступ к базе данных с Entity Framework Code-First

Мы будем использовать поддержки Entity Framework (EF), который включен в проектах ASP.NET MVC 3 для запроса и обновления базы данных. EF является гибкой объектом реляционного сопоставления (ORM) данных API, который позволяет разработчикам запрашивать и обновлять данные, хранящиеся в базе данных, в объектно ориентированному подходу.

Платформа Entity Framework версии 4 поддерживает парадигму разработки, называется code first. Code first позволяет создать объект модели, написав простые классы (также известный как POCO из объектов среды CLR «plain old») и даже может создать базу данных в режиме реального времени из классов.

### <a name="changes-to-our-model-classes"></a>Изменения в классах модели

Мы будем использовать функцию создания базы данных в Entity Framework в этом руководстве. Перед этим, однако сделаем с незначительными изменениями для наших классов модели, чтобы добавить несколько действий, которые мы будем использовать позже.

#### <a name="adding-the-artist-model-classes"></a>Добавление классов модели исполнителя

Наши альбомов будет связан с исполнители, поэтому мы добавим простой класс модели для описания художника. Добавьте новый класс с именем Artist.cs, используя приведенный ниже код папке «модели».

[!code-csharp[Main](mvc-music-store-part-4/samples/sample1.cs)]

#### <a name="updating-our-model-classes"></a>Обновление наших классов модели

Обновите класс альбома, как показано ниже.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample2.cs)]

Затем внесите следующие изменения в класс жанра.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample3.cs)]

### <a name="adding-the-appdata-folder"></a>Добавление приложения\_папка данных

Мы добавим приложение\_каталог данных для нашего проекта для хранения файлов базы данных SQL Server Express. Приложение\_данных представляет собой специальный каталог, в ASP.NET, который уже имеет разрешения безопасности доступа для доступа к базе данных. В меню «Проект» выберите Добавить папку ASP.NET, а затем приложение\_данных.

![](mvc-music-store-part-4/_static/image1.png)

### <a name="creating-a-connection-string-in-the-webconfig-file"></a>Создание строки подключения в файле web.config

Мы добавим несколько строк в файле конфигурации веб сайта, чтобы платформа Entity Framework знает, как подключиться к базе данных. Дважды щелкните файл Web.config, расположенный в корневой папке проекта.

![](mvc-music-store-part-4/_static/image2.png)

Прокрутите до нижней части этого файла и добавьте &lt;connectionStrings&gt; разделе непосредственно над последней строки, как показано ниже.

[!code-xml[Main](mvc-music-store-part-4/samples/sample4.xml)]

### <a name="adding-a-context-class"></a>Добавление класса контекста

Щелкните правой кнопкой мыши папку Models и добавьте новый класс с именем MusicStoreEntities.cs.

![](mvc-music-store-part-4/_static/image3.png)

Этот класс будет представляет контекст базы данных Entity Framework и будет обрабатывать наших создание, чтение, обновление и операций удаления для нас. Ниже приведен код для этого класса.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample5.cs)]

Вот и все — нет, не другие конфигурации, специальных интерфейсов, и т.д. Путем расширения базового класса DbContext, наш класс MusicStoreEntities возможность обрабатывать операций базы данных для нас. Теперь, когда у нас есть, подключить, давайте добавим несколько свойств для наших классов модели, чтобы воспользоваться преимуществами некоторых дополнительных сведений в базе данных.

### <a name="adding-our-store-catalog-data"></a>Добавление наших хранения данных каталога

Мы будет воспользоваться функцией в Entity Framework, который добавляет «начальное значение» данных вновь созданную базу данных. Это будет предварительно указано наш каталог хранилища со списком жанров, исполнителей и альбомы. Скачивание MvcMusicStore Assets.zip - включавший наши файлы узла разработки, использованные ранее в этом руководстве - имеет файл класса с этими данными начальное значение, расположенный в папке кода.

В коде / папку Models, найдите файл SampleData.cs и поместите его в папку Models в нашем проекте, как показано ниже.

![](mvc-music-store-part-4/_static/image4.png)

Теперь необходимо добавить одну строку кода, нужно сообщить об этом классе SampleData Entity Framework. Дважды щелкните файл Global.asax в корневой папке проекта, чтобы открыть его и добавьте следующие строки в начало приложения\_метод Start.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample6.cs)]

На этом этапе мы завершили работу действия, необходимые для настройки Entity Framework для проекта.

## <a name="querying-the-database"></a>Запрос к базе данных

Теперь давайте обновим наши StoreController таким образом, вместо того чтобы использовать «пустой данных» вместо этого он вызывает в нашу базу данных, чтобы запросить все его данные. Мы начнем с объявления поля на **StoreController** для хранения экземпляра класса MusicStoreEntities, с именем storeDB:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample7.cs)]

### <a name="updating-the-store-index-to-query-the-database"></a>Обновления индекса в базе данных Store

Класс MusicStoreEntities поддерживается платформой Entity Framework и предоставляет свойство коллекции для каждой таблицы в базе данных. Давайте обновим наши StoreController действие индекса для получения всех жанров в нашей базе данных. Ранее мы сделали это жесткое программирование строковых данных. Теперь можно вместо этого просто использовать контекст Entity Framework Generes коллекции:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample8.cs)]

Не требуется изменения случаться к шаблону представления, поскольку мы по-прежнему возвращая же StoreIndexViewModel, мы вернули перед — мы просто возвращая реальные данные из базы данных теперь.

Мы снова запустите проект и посетите URL-адреса «/ Store», мы теперь отображается список всех жанров в нашей базе данных:

![](mvc-music-store-part-4/_static/image1.jpg)

### <a name="updating-store-browse-and-details-to-use-live-data"></a>Обновление Store Обзор и сведения, чтобы использовать актуальные данные

С помощью/Store/обзора? жанр =*[некоторые жанр]* метода действия, мы ищем жанр фильма по имени. Ожидается только один результат, так как мы никогда не должны иметь две записи того же имени жанра, поэтому мы можем использовать. Расширение Single() в LINQ для запроса к соответствующему объекту жанра, следующим образом (не следует вводить это еще):

[!code-csharp[Main](mvc-music-store-part-4/samples/sample9.cs)]

Один метод принимает как параметр, указывающий, что мы хотим объекта жанр, таким образом, чтобы его имя совпадает со значением, которое мы определили лямбда-выражение. В приведенном выше примере мы загружаем объекта жанр с именем значение, соответствующее Disco.

Мы рассмотрим преимущества функцию Entity Framework, которая позволяет указать другие связанные сущности, которые требуется загрузить также при извлечении объекта жанра. Эта функция вызывается формирование результатов запроса и позволило сократить количество раз, нам нужно получить доступ к базе данных для получения всех данных, что нужно. Мы хотим упреждающую выборку альбомов для жанра, мы получаем, поэтому мы обновим наш запрос для включения Genres.Include("Albums"), чтобы указать, что мы хотим, а также связанные альбомы. Это более эффективно, так как он извлечет как наш жанра, так и на дисках данных в запросе отдельной базы данных.

С объяснениями в сторону Вот, как выглядит нашей обновленной действие контроллера просмотра:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample10.cs)]

Теперь можно обновлять Store Обзор представления для отображения альбомы, которые доступны в каждом жанре. Откройте этот шаблон (в /Views/Store/Browse.cshtml) и добавьте маркированный список альбомов, как показано ниже.

[!code-cshtml[Main](mvc-music-store-part-4/samples/sample11.cshtml)]

Запуск приложения и выбрав/Store/обзора? жанр = Jazz показывает, наши результаты теперь извлекаемых из базы данных, отображение всех альбомов в нашей выбранного жанра.

![](mvc-music-store-part-4/_static/image2.jpg)

Сделаем те же изменения наш/Store/сведения / [id] URL-адрес и замените нашей фиктивными данными запроса к базе данных, который загружает альбом, идентификатор которого соответствует значению параметра.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample12.cs)]

Запуск приложения и выбрав /Store/Details/1 показывает, что результаты теперь извлекаемых из базы данных.

![](mvc-music-store-part-4/_static/image5.png)

Теперь, когда нашей странице сведений о Store предназначена для отображения альбом по Идентификатору альбома, давайте обновим **Обзор** представление для связи в представлении сведений. Мы будем использовать Html.ActionLink, именно так, как мы сделали ссылки из Store индекс для просмотра Store в конце предыдущего раздела. Полный вариант исходного кода для представления обзора появляется.

[!code-cshtml[Main](mvc-music-store-part-4/samples/sample13.cshtml)]

Мы теперь возможность перейти с нашей страницы Store к странице жанра, которые перечислены доступные альбомов, и, щелкнув альбом можно просмотреть подробные сведения об этом альбоме.

![](mvc-music-store-part-4/_static/image6.png)

> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-3.md)
> [Вперед](mvc-music-store-part-5.md)
