---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-9
title: Часть 9. Регистрация и оформление заказа | Документация Майкрософт
author: jongalloway
description: В этой серии руководств описаны все шаги, необходимые для построения примера приложения ASP.NET MVC Music Store. Часть 9 рассматривается регистрация и оформление заказа.
ms.author: riande
ms.date: 04/21/2011
ms.assetid: d65c5c2b-a039-463f-ad29-25cf9fb7a1ba
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-9
msc.type: authoredcontent
ms.openlocfilehash: c7151351b087439f17457b254cd9e373af21cae3
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59380903"
---
# <a name="part-9-registration-and-checkout"></a>Часть 9. Регистрация и оформление заказа

по [Джон Гэллоуэй](https://github.com/jongalloway)

> Store музыки MVC является учебного приложения, которое вводятся и описываются пошаговые использование ASP.NET MVC и Visual Studio для разработки веб-приложений.  
>   
> Store музыки MVC — это реализация хранилища упрощенный пример, который продает музыкальные альбомы через Интернет и реализует базовый сайт администрирования, вход пользователя и корзины для покупок функциональные возможности.  
>   
> В этой серии руководств описаны все шаги, необходимые для построения примера приложения ASP.NET MVC Music Store. Часть 9 рассматривается регистрация и оформление заказа.


В этом разделе мы создадим CheckoutController, который соберет покупателя адрес и сведения об оплате. Мы будет необходимо зарегистрировать в наш сайт перед извлечением, поэтому этот контроллер будет требовать авторизации.

Пользователи, чтобы перейти процесс подсчета стоимости покупок в корзину, нажав кнопку «Извлечь».

![](mvc-music-store-part-9/_static/image1.jpg)

Если пользователь не вошел, им будет предложено.

![](mvc-music-store-part-9/_static/image1.png)

После успешного входа пользователь затем отображается представление адрес и оплаты.

![](mvc-music-store-part-9/_static/image2.png)

Как только они заполнения формы и подтверждением заказа, они будут показаны экране подтверждения заказа.

![](mvc-music-store-part-9/_static/image3.png)

Попытка просмотреть порядок несуществующий или заказа, не принадлежит покажет представлении ошибок.

![](mvc-music-store-part-9/_static/image4.png)

## <a name="migrating-the-shopping-cart"></a>Миграция в корзину для покупок

Хотя процесс покупки анонимен, когда пользователь нажимает кнопку извлечения, ему придется пройти для регистрации и входа. Пользователи ожидают, что мы будет поддерживать их о корзине покупок посещениях, поэтому будет необходимо связать с пользователем о корзине покупок, после завершения регистрации или входа.

Это фактически очень легко сделать, так как наш класс ShoppingCart уже есть метод, который будет связывать все элементы в текущем корзины для покупок с именем пользователя. Нам просто нужно вызвать этот метод, когда пользователь завершает регистрации или входа.

Откройте **AccountController** класс, который мы добавили, настраивая мы членство и авторизация. Добавить с помощью инструкции, ссылающиеся на MvcMusicStore.Models, затем добавьте следующий метод MigrateShoppingCart:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample1.cs)]

Затем измените действия после входа в систему для вызова MigrateShoppingCart после проверки пользователя, как показано ниже:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample2.cs)]

Сделать то же изменение в регистр действий, выполняемых после, сразу после успешного создания учетной записи пользователя:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample3.cs)]

Вот и все — теперь анонимный корзину будут автоматически передаваться учетную запись пользователя после успешной регистрации или входа.

## <a name="creating-the-checkoutcontroller"></a>Создание CheckoutController

Щелкните правой кнопкой мыши папку Controllers и добавите новый контроллер в проект с именем CheckoutController, с помощью шаблона пустой контроллер.

![](mvc-music-store-part-9/_static/image5.png)

Во-первых добавьте атрибут Authorize над объявлением класса контроллера требуется использовать Зарегистрируйтесь до извлечения.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample4.cs)]

*Примечание. Это похоже на изменение, которое мы ранее сделанные для StoreManagerController, но в этом случае атрибут Authorize требуется, чтобы пользователь был в роль администратора. В контроллере извлечения, мы при необходимости пользователю войти систему, но не требуется, чтобы они были администраторов.*

Для простоты мы не будет иметь дело с платежной информации в этом руководстве. Вместо этого мы позволяем пользователям извлекать, указав код акции. Мы сохраним этот код акции, с помощью константу с именем Промокода.

Как и в StoreController я объявлю поле, содержащее экземпляр класса MusicStoreEntities, с именем storeDB. Чтобы использовать класс MusicStoreEntities, нам потребуется добавить с помощью инструкции для пространства имен MvcMusicStore.Models. Появляется вверху нашего контроллера для выписки.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample5.cs)]

CheckoutController будет иметь следующее контроллера:

**(Метод GET) AddressAndPayment** форма позволяет пользователю ввести данные.

**(Метод POST) AddressAndPayment** проверяет входные данные и обработки заказа.

**Полный** будет отображаться после пользователь успешно завершил процесс подсчета стоимости сначала. В этом представлении будет включать номер заказа пользователя, в качестве подтверждения.

Во-первых для AddressAndPayment переименуем действия контроллера индекса (который был создан при создании контроллера). Это действие контроллера просто отображает форму извлечения, чтобы он не требовал любые сведения о модели.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample6.cs)]

Наш метод AddressAndPayment POST будет тот же шаблон, мы использовали в StoreManagerController: он будет пытаться принять отправки формы и завершить порядок и повторного отображения формы в случае неудачи.

После проверки входных данных формы отвечает требованиям наших проверки заказа, проверяется значение формы промокод напрямую. Предположим, что все работает правильно, мы сохраним обновленную информацию с заказом, заставить объект ShoppingCart выполнить процесс заказа и перенаправления для завершения действия.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample7.cs)]

После успешного завершения процесса извлечения пользователи будут перенаправляться к действию полный контроллера. Это действие будет выполнять простую проверку, чтобы проверить, что порядок действительно принадлежат вошедшего в систему пользователя перед отображением в качестве подтверждения номер заказа.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample8.cs)]

*Примечание. Ошибка представления был автоматически создан для нас в папке /Views/Shared когда мы начали работать проект.*

Полный код CheckoutController выглядит следующим образом:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample9.cs)]

## <a name="adding-the-addressandpayment-view"></a>Добавление представления AddressAndPayment

Теперь давайте создадим AddressAndPayment представления. Щелкните правой кнопкой мыши на одно из действий контроллера AddressAndPayment и добавьте представление с именем AddressAndPayment, строго типизируется как заказ и используется изменить шаблон, как показано ниже.

![](mvc-music-store-part-9/_static/image6.png)

В этом представлении сделает использовать из двух методов, мы рассмотрели при построении StoreManagerEdit представления:

- Мы будем использовать Html.EditorForModel() для отображения поля формы для модели заказа
- Мы будем использовать правила проверки с помощью класса Order с атрибутами проверки

Мы начнем, обновив код формы для использования Html.EditorForModel(), следуют дополнительные textbox для промо-код. Ниже приведен полный код для представления AddressAndPayment.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample10.cshtml)]

## <a name="defining-validation-rules-for-the-order"></a>Определение правила проверки для заказа

Теперь, когда нашего представления настроена, мы настроим правила проверки для нашей модели порядок как это делалось ранее для модели альбома. Щелкните правой кнопкой мыши папку Models и добавьте класс с именем заказа. Помимо атрибутов проверки, которые мы использовали ранее альбома мы также используем регулярное выражение для проверки адреса электронной почты пользователя.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample11.cs)]

Попытка отправить форму с отсутствующим или недопустимых данных, появится сообщение об ошибке с помощью проверки на стороне клиента.

![](mvc-music-store-part-9/_static/image7.png)

Итак мы выполнили большинство часть тяжелой работы для процесса извлечения; Мы просто выбрали несколько заканчивается и вероятность завершения. Нам нужно добавить два простых представления, а нам нужно позаботиться о получения информации для покупок, при входе в систему.

## <a name="adding-the-checkout-complete-view"></a>Добавление завершения извлечения представления

Извлечение полного представления довольно прост, так как он просто должен отображать номер заказа. Щелкните правой кнопкой мыши на действие завершения контроллера и добавить представление с именем завершить, который является строго типизированным как целочисленное значение

![](mvc-music-store-part-9/_static/image8.png)

Теперь мы будем обновлять код представления для отображения идентификатор заказа, как показано ниже.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample12.cshtml)]

## <a name="updating-the-error-view"></a>Обновление представления ошибки

Шаблон по умолчанию включает в себя представление "ошибок" в папке views Shared таким образом, чтобы его можно использовать повторно в другом месте на сайте. В этом представлении ошибка содержит ошибку очень простой и не использует наш сайт макета, поэтому мы обновим его.

Так как это типовой страницы ошибки, содержимое очень прост. Мы будем включать сообщение и ссылку для перехода на предыдущую страницу в журнале, если пользователь хочет повторить попытку их действия.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample13.cshtml)]


> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-8.md)
> [Вперед](mvc-music-store-part-10.md)
