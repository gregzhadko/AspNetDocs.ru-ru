---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-9
title: Часть 9. Регистрация и извлечение | Документация Майкрософт
author: jongalloway
description: В этой серии руководств подробно описаны все шаги, предпринятые для создания примера приложения музыкального хранилища ASP.NET MVC. Часть 9 охватывает регистрацию и извлечение.
ms.author: riande
ms.date: 04/21/2011
ms.assetid: d65c5c2b-a039-463f-ad29-25cf9fb7a1ba
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-9
msc.type: authoredcontent
ms.openlocfilehash: 040bc0ccef889fb9a7c3d9b5ce88c75b7b754248
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78450900"
---
# <a name="part-9-registration-and-checkout"></a>Часть 9. Регистрация и извлечение

[Джон Гэллоуэй](https://github.com/jongalloway)

> Музыкальное хранилище MVC — это учебное приложение, в котором представлены и объясняются пошаговые инструкции по использованию ASP.NET MVC и Visual Studio для разработки веб-приложений.  
>   
> Музыкальное хранилище MVC — это упрощенная реализация в магазине, которая продает музыкальные альбомы в сети и реализует базовое администрирование сайта, вход пользователя в систему и функции корзины покупок.  
>   
> В этой серии руководств подробно описаны все шаги, предпринятые для создания примера приложения музыкального хранилища ASP.NET MVC. Часть 9 охватывает регистрацию и извлечение.

В этом разделе мы создадим Чеккаутконтроллер, который будет получать сведения об адресе и платеже покупателя. Перед извлечением необходимо, чтобы пользователи регистрировались на нашем сайте, поэтому для этого контроллера потребуется авторизация.

Пользователи будут переходить к процессу извлечения из покупательской корзины, нажав кнопку "извлечь".

![](mvc-music-store-part-9/_static/image1.jpg)

Если пользователь не вошел в систему, ему будет предложено.

![](mvc-music-store-part-9/_static/image1.png)

После успешного входа пользователь отобразит представление адрес и платеж.

![](mvc-music-store-part-9/_static/image2.png)

После заполнения формы и отправки заказа они будут отображаться на экране подтверждения заказа.

![](mvc-music-store-part-9/_static/image3.png)

При попытке просмотра несуществующего заказа или заказа, который не принадлежит вам, отобразится представление ошибок.

![](mvc-music-store-part-9/_static/image4.png)

## <a name="migrating-the-shopping-cart"></a>Перенос корзины для покупок

Хотя процесс покупки является анонимным, когда пользователь нажимает кнопку "извлечь", ему потребуется зарегистрироваться и войти в систему. Пользователи будут иметь возможность сохранять информацию о корзине для покупок между посещениями, поэтому нам нужно будет связать сведения о корзине для покупок с пользователем при завершении регистрации или входе.

Это очень просто, так как у нашего класса ShoppingCart уже есть метод, который свяжет все элементы в текущей корзине с именем пользователя. При завершении регистрации или входа пользователь должен просто вызвать этот метод.

Откройте класс **AccountController** , который мы добавили при настройке членства и авторизации. Добавьте инструкцию using, ссылающуюся на Мвкмусиксторе. Models, а затем добавьте следующий метод Мигратешоппингкарт:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample1.cs)]

Затем измените действие LogOn POST, чтобы вызвать Мигратешоппингкарт после проверки пользователя, как показано ниже:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample2.cs)]

Внесите одно и то же изменение в действие регистрация после успешного создания учетной записи пользователя:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample3.cs)]

Теперь она будет автоматически перенесена в учетную запись пользователя после успешной регистрации или входа.

## <a name="creating-the-checkoutcontroller"></a>Создание Чеккаутконтроллер

Щелкните правой кнопкой мыши папку Controllers и добавьте новый контроллер в проект с именем Чеккаутконтроллер, используя пустой шаблон контроллера.

![](mvc-music-store-part-9/_static/image5.png)

Сначала добавьте атрибут авторизовать над объявлением класса контроллера, чтобы требовать, чтобы пользователи регистрировались перед извлечением:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample4.cs)]

*Примечание. Это похоже на изменение, которое мы ранее внесли в Стореманажерконтроллер, но в этом случае атрибуту авторизации требуется, чтобы пользователь был в роли администратора. В контроллере извлечения требуется, чтобы пользователь вошел в систему, но не требовал, чтобы он был администратором.*

Для простоты мы не будем работать со сведениями о платежах в этом учебнике. Вместо этого мы предоставляем пользователям возможность извлекаться с помощью рекламного кода. Мы будем хранить этот код рекламной акции с помощью константы с именем промокод.

Как и в Стореконтроллер, мы объявляем поле для хранения экземпляра класса Мусиксторинтитиес с именем Сторедб. Чтобы использовать класс Мусиксторинтитиес, необходимо добавить инструкцию using для пространства имен Мвкмусиксторе. Models. Верхняя часть нашего контроллера извлечения показана ниже.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample5.cs)]

Чеккаутконтроллер будет иметь следующие действия контроллера:

**Аддрессандпаймент (метод Get)** будет отображать форму, позволяющую пользователю вводить данные.

**Аддрессандпаймент (метод POST)** проверит ввод и обработает заказ.

**Полная** будет показана после успешного завершения процесса извлечения пользователем. Это представление будет включать номер заказа пользователя в качестве подтверждения.

Во-первых, переименование действия контроллера индекса (созданного при создании контроллера) в Аддрессандпаймент. Это действие контроллера просто отображает форму извлечения, поэтому для нее не требуются сведения о модели.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample6.cs)]

Наш метод Аддрессандпаймент POST будет следовать тому же шаблону, который мы использовали в Стореманажерконтроллер: он попытается принять отправку формы и выполнить заказ, после чего снова отобразит форму в случае сбоя.

После проверки того, что входные данные соответствуют требованиям к проверке заказа, мы будем проверять значение формы промокод напрямую. Предполагая, что все правильно, мы сохраняем обновленные сведения в заказе, наскажуи объекту ShoppingCart завершить процесс заказа и перейдете к выполнению действия.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample7.cs)]

После успешного завершения процесса извлечения пользователи будут перенаправлены к полному действию контроллера. Это действие выполняет простую проверку того, что заказ действительно принадлежит пользователю, вошедшему в систему, перед отображением номера заказа в качестве подтверждения.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample8.cs)]

*Примечание. представление ошибок было автоматически создано для нас в папке/Виевс/Шаред, когда мы начали проект.*

Полный код Чеккаутконтроллер выглядит следующим образом:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample9.cs)]

## <a name="adding-the-addressandpayment-view"></a>Добавление представления Аддрессандпаймент

Теперь создадим представление Аддрессандпаймент. Щелкните правой кнопкой мыши одно из действий контроллера Аддрессандпаймент и добавьте представление с именем Аддрессандпаймент, которое строго типизировано как заказ и использует шаблон редактирования, как показано ниже.

![](mvc-music-store-part-9/_static/image6.png)

В этом представлении будут использоваться два метода, которые мы рассматривали при создании представления Стореманажередит:

- Мы будем использовать HTML. Едиторформодел () для вывода полей формы для модели заказа.
- Мы будем использовать правила проверки, используя класс Order с атрибутами проверки.

Мы начнем с обновления кода формы для использования HTML. Едиторформодел (), за которым следует дополнительное текстовое поле для кода Акционная. Полный код для представления Аддрессандпаймент приведен ниже.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample10.cshtml)]

## <a name="defining-validation-rules-for-the-order"></a>Определение правил проверки для заказа

Теперь, когда наше представление настроено, мы настроили правила проверки для нашей модели заказов, как это было сделано ранее для модели альбома. Щелкните правой кнопкой мыши папку Models и добавьте класс с именем Order. Помимо атрибутов проверки, использовавшихся ранее для альбома, мы также будем использовать регулярное выражение для проверки адреса электронной почты пользователя.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample11.cs)]

При попытке отправить форму с отсутствующими или недопустимыми сведениями будет отображаться сообщение об ошибке с помощью проверки на стороне клиента.

![](mvc-music-store-part-9/_static/image7.png)

Итак, мы сделали большую часть сложной работы для процесса извлечения. у нас есть несколько вероятность и завершение. Нам нужно добавить два простых представления, и во время входа в систему необходимо принять во внимание сведения о корзине.

## <a name="adding-the-checkout-complete-view"></a>Добавление представления "Извлечение завершено"

Представление "Извлечение завершено" довольно простое, так как ему просто нужно отобразить идентификатор заказа. Щелкните правой кнопкой мыши действие завершение контроллера и добавьте представление с именем Complete, которое строго типизировано как целое число.

![](mvc-music-store-part-9/_static/image8.png)

Теперь мы будем обновлять код представления для отображения идентификатора заказа, как показано ниже.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample12.cshtml)]

## <a name="updating-the-error-view"></a>Обновление представления ошибок

Шаблон по умолчанию включает представление ошибок в папку Общие представления, чтобы его можно было повторно использовать в любом месте сайта. Это представление ошибок содержит очень простую ошибку и не использует макет сайта, поэтому мы будем обновлять его.

Так как это общая страница ошибки, содержимое очень простое. Мы будем включать сообщение и ссылку для перехода на предыдущую страницу в журнале, если пользователь хочет повторно выполнить действие.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample13.cshtml)]

> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-8.md)
> [Вперед](mvc-music-store-part-10.md)
