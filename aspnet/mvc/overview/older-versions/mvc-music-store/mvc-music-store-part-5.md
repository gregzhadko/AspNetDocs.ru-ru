---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-5
title: Часть 5. Изменение форм и создание шаблонов | Документация Майкрософт
author: jongalloway
description: В этой серии руководств описаны все шаги, необходимые для построения примера приложения ASP.NET MVC Music Store. Часть 5 описывается изменение форм и шаблонов.
ms.author: riande
ms.date: 04/21/2011
ms.assetid: 6b09413a-6d6a-425a-87c9-629f91b91b28
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-5
msc.type: authoredcontent
ms.openlocfilehash: 20b99cbe57b5dfa623205838a5929733a6c2d70d
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65112988"
---
# <a name="part-5-edit-forms-and-templating"></a>Часть 5. Изменение форм и создание шаблонов

по [Джон Гэллоуэй](https://github.com/jongalloway)

> Store музыки MVC является учебного приложения, которое вводятся и описываются пошаговые использование ASP.NET MVC и Visual Studio для разработки веб-приложений.  
>   
> Store музыки MVC — это реализация хранилища упрощенный пример, который продает музыкальные альбомы через Интернет и реализует базовый сайт администрирования, вход пользователя и корзины для покупок функциональные возможности.
> 
> В этой серии руководств описаны все шаги, необходимые для построения примера приложения ASP.NET MVC Music Store. Часть 5 описывается изменение форм и шаблонов.

В последние главе мы были загрузка данных из базы данных и его отображения. В этой главе мы также дает редактирования данных.

## <a name="creating-the-storemanagercontroller"></a>Создание StoreManagerController

Начнем с создания нового контроллера с именем **StoreManagerController**. Для этого контроллера мы будет используют преимущества функций формирования шаблонов, доступных в обновление средств ASP.NET MVC 3. Задание параметров в диалоговом окне Добавить контроллер, как показано ниже.

![](mvc-music-store-part-5/_static/image1.png)

При нажатии кнопки «Добавить», вы увидите, что механизм формирования шаблонов ASP.NET MVC 3 не достаточно большой объем работы для вас:

- Он создает новый StoreManagerController с локальной переменной Entity Framework
- Он добавляет папку StoreManager в папке представления проекта
- Он добавляет представление Create.cshtml, Delete.cshtml, Details.cshtml, Edit.cshtml и Index.cshtml, строго типизированный к классу альбома

![](mvc-music-store-part-5/_static/image2.png)

Новый класс контроллера StoreManager включает CRUD (Создание, чтение, обновление и удаление) действия контроллера, которые умеют работать с альбом класс модели и использовать наш контекст Entity Framework для доступа к базе данных.

## <a name="modifying-a-scaffolded-view"></a>Изменение сформированные представления

Это важно помнить, что, хотя этот код был создан для нас, это стандартный код ASP.NET MVC, так же, как как мы писали в этом руководстве. Она предназначена для сохранения бы потратить время на написание стандартный код контроллера и создание строго типизированные представления вручную, но это не тип созданного кода, вы могли заметить, предваряемые фразой дыре предупреждений в комментарии о том, как вы не должны изменять код. Это код, и вы должны изменить его.

Итак давайте начнем с Быстрое редактирование в представление StoreManager Index (/ Views/StoreManager/Index.cshtml). Это представление отображает таблицу, которая перечисляет альбомов в нашем магазине с изменением / сведения о / удаление ссылок и включает в себя свойства открытого альбома. Мы удалим поле AlbumArtUrl, так как он не очень полезны в этом окне. В &lt;таблицы&gt; раздел кода представление, удалите &lt;th&gt; и &lt;td&gt; элементы вокруг AlbumArtUrl ссылки, как указано ниже выделенные строки:

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample1.cshtml)]

Просмотреть измененный код будет выглядеть следующим образом:

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample2.cshtml)]

## <a name="a-first-look-at-the-store-manager"></a>Первый взгляд на диспетчер Store

Теперь запустите приложение и перейдите к/StoreManager /. Здесь показаны измененные, со списком альбомов в хранилище со ссылками на редактирования и сведений и удалить индекс Store Manager.

![](mvc-music-store-part-5/_static/image3.png)

Щелкнув ссылку "Изменить" отображается форма редактирования с полями альбома, включая раскрывающиеся списки для жанр и исполнителя.

![](mvc-music-store-part-5/_static/image4.png)

Щелкните ссылку «Обратно в список» внизу, а затем щелкните ссылку сведения для альбома. Отобразится подробная информация об отдельных альбома.

![](mvc-music-store-part-5/_static/image5.png)

Опять же щелкните ссылки возврата в списке, а затем щелкните ссылку, удалить. Откроется диалоговое окно подтверждения, показывая сведения об альбоме и запросом, если мы уверены, что нам нужно удалить его.

![](mvc-music-store-part-5/_static/image6.png)

Нажав кнопку «Удалить» в нижней ведет к удалению альбома и вернулись к страницу индекса, которая показывает альбом, удалены.

Мы не завершили работу с Store Manager, но у нас есть контроллер и представление кода для операций CRUD для запуска из работы.

## <a name="looking-at-the-store-manager-controller-code"></a>Просмотрев код Store Manager контроллера

Контроллер Store Manager содержит достаточно большой объем кода. Давайте разберем это сверху вниз. Контроллер включает некоторые стандартные пространства имен для контроллера MVC, а также ссылку на пространство имен нашей модели. Контроллер может единичный экземпляр MusicStoreEntities, используемых каждым из действий контроллера, для доступа к данным.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample3.cs)]

### <a name="store-manager-index-and-details-actions"></a>Store Manager Index и Details действия

Представление index извлекает список альбомов, включая каждого альбома упоминаемого жанр и исполнителях сведения, как мы видели ранее при работе в методе Store Обзор. Представление Index подписан ссылки на связанные объекты можно отображать его название жанра каждого альбома, а также имя исполнителя, чтобы контроллер, эффективные и выполнения запросов для получения этих сведений в исходном запросе.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample4.cs)]

Действие контроллера сведения контроллеру StoreManager работает так же, как на действие Details контроллера Store, мы писали раньше - он запрашивает альбома по Идентификатору, используя метод Find(), затем возвращает его представление.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample5.cs)]

### <a name="the-create-action-methods"></a>Создавать методы действий

Методы действий Create — это немного отличаются от тех, которые мы уже видели, поскольку они обрабатывают входные данные формы. При первом посещении /StoreManager/создать/будут показаны как пустая форма. Эта страница HTML будет содержать &lt;формы&gt; элемент, который содержит раскрывающийся список и текстового поля входных элементов, где они могут ввести сведения об альбоме.

После пользователь заполняет значения формы альбома, их можно нажать кнопку «Сохранить», чтобы отправить эти изменения обратно в наше приложение, чтобы сохранить в базе данных. Когда пользователь нажимает кнопку «Сохранить» &lt;формы&gt; выполнит запрос HTTP POST к /StoreManager/создать/URL-адрес и отправьте &lt;формы&gt; значения как часть HTTP-POST.

ASP.NET MVC позволяет нам легко разделить логику из этих двух сценариев вызова URL-адрес, благодаря чему мы можем реализовать два отдельных метода действия «Создать» в наш класс StoreManagerController — один для обработки первоначальной обзора HTTP-GET для /StoreManager/Create / URL-адрес, а другой для обработки HTTP-POST отправляемых изменений.

### <a name="passing-information-to-a-view-using-viewbag"></a>Передача сведений об в представление с помощью ViewBag

Мы использовали ViewBag ранее в этом учебнике, но еще не было сказано немного о нем. ViewBag позволяет нам для передачи информации в представление без использования объекта строго типизированные модели. В этом случае наши действия контроллера изменить HTTP-GET должен пройти обоих список жанров и исполнители в форму для заполнения раскрывающихся списков и для этого проще всего вернуть их в виде элементов ViewBag.

ViewBag является динамическим объектом, это означает, что вы можете ввести ViewBag.Foo или ViewBag.YourNameHere без написания кода для определения этих свойств. В этом случае код контроллера использует ViewBag.GenreId и ViewBag.ArtistId, таким образом будет раскрывающийся список значений, отправленных с формой, GenreId и ArtistId, которые являются альбома свойства, которые будут настраиваться.

Эти значения раскрывающегося списка возвращаются в форму, используя объект SelectList, которая построена специально для этой цели. Это делается с помощью следующего кода:

[!code-csharp[Main](mvc-music-store-part-5/samples/sample6.cs)]

Как видно из кода метода действия, для создания данного объекта используются три параметра:

- Список элементов, которые будут применяться для отображения раскрывающегося списка. Обратите внимание, что это не просто строка — мы передаем список жанров.
- Следующий параметр, передаваемые SelectList является выбранному значению. Этот способ SelectList знает, как предварительно выбранный элемент в списке. Это будет легче понять, если взглянуть на форму редактирования, который очень похож.
- Последний параметр является свойство для отображения. В этом случае это указывает, Genre.Name свойством, какие данные будут отображаться для пользователя.

С учетом этого, действие создания HTTP-GET довольно прост — ViewBag добавляются два SelectLists затем объект модели не передается в форму (так как он еще не создан еще).

[!code-csharp[Main](mvc-music-store-part-5/samples/sample7.cs)]

### <a name="html-helpers-to-display-the-drop-downs-in-the-create-view"></a>Вспомогательные методы HTML для отображения в списке Drop в Create View

Так как мы говорили о как раскрывающийся список значения передаются в представление, давайте кратко рассмотрим представление, чтобы увидеть, как отображаются значения. В представлении кода (/ Views/StoreManager/Create.cshtml), вы увидите следующий вызов для отображения раскрывающегося жанр вниз.

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample8.cshtml)]

Это называется вспомогательный метод HTML - служебный метод, который выполняет типичную задачу представления. Вспомогательные методы HTML очень полезны в обеспечении наш код представления четкими и удобочитаемыми. Вспомогательный метод Html.DropDownList обеспечивается ASP.NET MVC, но как мы увидим позже его можно создать собственные вспомогательные функции для просмотра кода, который мы будем использовать в наше приложение.

Вызов Html.DropDownList только должен знать две вещи - get отображались в списке, и какое значение (если таковые имеются) должен быть уже выбран. Первый параметр, GenreId, определяет DropDownList искомое значение с именем GenreId в модели или ViewBag. Второй параметр используется для указания значения, чтобы показать, как изначально выбираются в раскрывающемся списке. Так как эта форма является создание формы, нет значения, чтобы быть предустановленные и передается String.Empty.

### <a name="handling-the-posted-form-values"></a>Обработка значений учтена формы

Как уже говорилось, прежде чем, существует два метода действия, связанные с каждой формы. Первая обрабатывает запрос HTTP GET и отображает форму. Вторая обрабатывает запрос HTTP POST, который содержит значения отправленной формы. Обратите внимание на то, что действие контроллера имеет атрибут [HttpPost], который сообщает ASP.NET MVC, что он только должен отвечать на запросы HTTP-POST.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample9.cs)]

Это действие имеет четыре обязанности:

- 1. Чтение значения формы
- 2. Проверьте, если значения формы передать все правила проверки
- 3. Если отправка формы является допустимым, для сохранения данных, так и для отображения обновленного списка
- 4. Если отправка формы не является допустимым, повторного вывода формы с ошибками проверки

#### <a name="reading-form-values-with-model-binding"></a>Считывание значений формы с привязкой модели

Действие контроллера обрабатывает отправки формы, включает в себя значения GenreId и ArtistId (из раскрывающегося списка) и текстовое поле значения для заголовка, цену и AlbumArtUrl. Хотя можно получить прямой доступ к значениям формы, лучшим подходом является использование возможностей привязки модели ASP.NET MVC. Когда действие контроллера принимает тип модели в качестве параметра, ASP.NET MVC попытается заполнить объект этого типа с помощью формы ввода данных (а также значения маршрута и строки запроса). Это делается путем поиска значений, имена которых соответствуют свойствам объекта модели, например при установке нового альбома объекта GenreId значения, он ищет входных данных с именем GenreId. При создании представлений с помощью стандартных методов в ASP.NET MVC, формы всегда отображается с помощью имен свойств как имена полей ввода, поэтому это поле будет просто соответствия имен.

#### <a name="validating-the-model"></a>Проверка модели

Модель проверяется с помощью простого вызова ModelState.IsValid. Мы еще не добавили все правила проверки к нашему классу альбома, но — мы сделаем, через несколько минут — Теперь эта проверка не нечего делать. Важно то, что эта проверка ModelStat.IsValid будет адаптироваться к правила проверки, которые мы поместили в нашей модели, поэтому будущие изменения в правила проверки не требует никаких обновлений для кода действия контроллера.

#### <a name="saving-the-submitted-values"></a>Сохранение предоставленными значениями

Если отправка формы проходит проверку, пришло время для сохранения значений в базу данных. С помощью Entity Framework, требуется выполнить добавление модели в коллекцию альбомы и вызова метода SaveChanges.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample10.cs)]

Entity Framework создает соответствующие команды SQL для сохранения значения. После сохранения данных, мы перенаправления обратно к списку альбомов, мы видим наши обновления. Это делается путем возвращения RedirectToAction с именем действия контроллера, которое должно отображаться. В этом случае это метод Index.

#### <a name="displaying-invalid-form-submissions-with-validation-errors"></a>Отображение отправок недопустимую форму с ошибками проверки

В случае недопустимой форме ввода раскрывающийся список значений добавляются ViewBag (как в случае HTTP-GET) и привязанная модель они передаются обратно в представление для отображения. Ошибки проверки автоматически отображаются с помощью @Html.ValidationMessageFor вспомогательный метод HTML.

#### <a name="testing-the-create-form"></a>Тестирование Создание формы

Чтобы проверить это, выполнения приложения и перейдите к /StoreManager/создать / - вы увидите пустую форму, который был возвращен методом StoreController создать HTTP-GET.

Заполните некоторые значения и нажмите кнопку «Создать» для отправки формы.

![](mvc-music-store-part-5/_static/image7.png)

![](mvc-music-store-part-5/_static/image8.png)

### <a name="handling-edits"></a>Обработка изменений

Пары «изменение действия» (HTTP-GET и HTTP-POST) очень похожи на методов создания действий, которые мы только что рассмотрели. Поскольку сценарии редактирования включает работу с существующий альбом, изменить HTTP-GET метод загружает альбома, на основе параметра «id», передан по маршруту. Этот код для извлечения и альбом AlbumId совпадает с ранее рассматривались в действие контроллера Details. Как и в случае с помощью команды Create / метод HTTP-GET, раскрывающийся список значения возвращаются через ViewBag. Это позволяет нам для возврата альбом как нашего объекта модели представления (который является строго типизированным к классу альбом) во время передачи дополнительных данных (например список жанров) через ViewBag.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample11.cs)]

Изменить HTTP-POST действие очень похоже на действие создания HTTP-POST. Единственная разница, вместо добавления нового альбома на базу данных. Коллекции альбомов, мы поиск текущего экземпляра альбома с помощью db. Entry(Album) и перевода его в состояние Modified. Это сообщает Entity Framework, что мы изменяем существующий альбом в отличие от создания нового.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample12.cs)]

Эту возможность можно проверить путем запуска приложения и просмотр/StoreManger /, а затем щелкнув ссылку правки для альбома.

![](mvc-music-store-part-5/_static/image9.png)

Откроется показано с помощью метода HTTP-GET, изменить форму редактирования. Заполните некоторые значения и нажмите кнопку "Сохранить".

![](mvc-music-store-part-5/_static/image10.png)

Это отправляет форму, сохраняет значения и возвращает нас к списку альбома, показывающий, что значения были обновлены.

![](mvc-music-store-part-5/_static/image11.png)

### <a name="handling-deletion"></a>Обработка удаления

Удаление та же схема, как Edit and Create, используя действие одного контроллера для отображения формы подтверждения и другое действие контроллера для обработки отправки формы.

Действие контроллера удалить HTTP-GET именно так же, как наши предыдущее действие контроллера сведения Store Manager.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample13.cs)]

Мы показываем форму, которая является строго типизированным типа альбома, с помощью шаблона содержимого представления Delete.

![](mvc-music-store-part-5/_static/image12.png)

Шаблон удаления будут видны все поля для модели, но довольно можно упростить, вниз. Измените код представления в /Views/StoreManager/Delete.cshtml следующим образом.

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample14.cshtml)]

Здесь показаны упрощенный подтверждение удаления.

![](mvc-music-store-part-5/_static/image13.png)

Нажатие кнопки удаления приводит к обратной передаче на сервер, который выполняет действие DeleteConfirmed формы.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample15.cs)]

Действии HTTP-POST удалить контроллер выполняет следующие действия:

- 1. Загружает альбом по Идентификатору
- 2. Удаляет его альбома и сохранить изменения
- 3. Перенаправление в индекс, показывающий, что альбом был удален из списка

Чтобы проверить это, запустите приложение и перейдите к /StoreManager. Выберите его из списка и щелкните ссылку «Удалить».

![](mvc-music-store-part-5/_static/image14.png)

Откроется экран подтверждения нашей Delete.

![](mvc-music-store-part-5/_static/image15.png)

Нажав кнопку Delete удаляет альбом и возвращает нам страницу индекса Store Manager, которая показывает, что альбом была удалена.

![](mvc-music-store-part-5/_static/image16.png)

### <a name="using-a-custom-html-helper-to-truncate-text"></a>Использование пользовательского вспомогательного метода HTML для усечения текста

У нас есть одна потенциальная проблема с нашей страницы индекса Store Manager. Название альбома и имя исполнителя свойства могут быть достаточно длинным, что они могут сбросить наших форматирование таблицы. Мы создадим пользовательский вспомогательный метод HTML, которые позволяют легко выполнить усечение этих и других свойств в наши представления.

![](mvc-music-store-part-5/_static/image17.png)

В Razor @helper синтаксис стало довольно легко создавать собственные вспомогательные функции для использования в представлениях. Откройте представление /Views/StoreManager/Index.cshtml и добавьте следующий код сразу после @model строки.

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample16.cshtml)]

Этот вспомогательный метод принимает строку и максимальную длину, чтобы разрешить. Если значение текста, поставляемого короче указанной длины, вспомогательное приложение выводит его как-является. Если длина его усекает текст и отображает «...», далее.

Теперь можно использовать наши усечения вспомогательный для убедитесь, что имя исполнителя и название альбома свойства меньше 25 символов. Полное представление кода, используя наш новый вспомогательный метод усечения появляется.

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample17.cshtml)]

Теперь когда мы просматривают /StoreManager/ URL-адрес, альбомы и заголовки хранятся ниже наших максимальной длины.

![](mvc-music-store-part-5/_static/image18.png)

Примечание. Это показывает простой пример создания и использования вспомогательного метода в одном представлении. Дополнительные сведения о создании вспомогательные функции, которые можно использовать на протяжении всего веб-узла, см. в разделе в моем блоге: [http://bit.ly/mvc3-helper-options](http://bit.ly/mvc3-helper-options)

> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-4.md)
> [Вперед](mvc-music-store-part-6.md)
