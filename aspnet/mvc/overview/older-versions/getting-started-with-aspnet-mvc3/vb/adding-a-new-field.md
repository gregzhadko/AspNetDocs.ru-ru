---
uid: mvc/overview/older-versions/getting-started-with-aspnet-mvc3/vb/adding-a-new-field
title: Добавление нового поля в модель фильмов и таблицу базы данных (VB) | Документация Майкрософт
author: Rick-Anderson
description: В этом учебнике вы узнаете об основах создания веб-приложения ASP.NET MVC с помощью Microsoft Visual Web Developer 2010 Express с пакетом обновления 1 (SP1)...
ms.author: riande
ms.date: 01/12/2011
ms.assetid: 28970e1b-1845-4015-86ef-121e52a6c397
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-aspnet-mvc3/vb/adding-a-new-field
msc.type: authoredcontent
ms.openlocfilehash: b2b26b6009c55f02c8a4159bda839fe7aefea4c0
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78434652"
---
# <a name="adding-a-new-field-to-the-movie-model-and-database-table-vb"></a>Добавление нового поля в модель Movie и таблицу базы данных (VB)

по [Рик Андерсон (](https://twitter.com/RickAndMSFT)

> В этом учебнике вы узнаете об основах создания веб-приложения ASP.NET MVC с помощью Microsoft Visual Web Developer 2010 Express с пакетом обновления 1 (SP1), который является бесплатной версией Microsoft Visual Studio. Прежде чем начать, убедитесь, что установлены предварительные требования, перечисленные ниже. Чтобы установить все эти компоненты, щелкните следующую ссылку: [установщик веб-платформы](https://www.microsoft.com/web/gallery/install.aspx?appid=VWD2010SP1Pack). Кроме того, вы можете отдельно установить необходимые компоненты, используя следующие ссылки:
> 
> - [Предварительные требования для Visual Studio Web Developer Express SP1](https://www.microsoft.com/web/gallery/install.aspx?appid=VWD2010SP1Pack)
> - [Обновление инструментов ASP.NET MVC 3](https://www.microsoft.com/web/gallery/install.aspx?appsxml=&amp;appid=MVC3)
> - [SQL Server Compact 4,0](https://www.microsoft.com/web/gallery/install.aspx?appid=SQLCE;SQLCEVSTools_4_0)(поддержка времени выполнения и средств)
> 
> Если вы используете Visual Studio 2010 вместо Visual Web Developer 2010, установите необходимые компоненты, щелкнув следующую ссылку: [Предварительные требования для Visual studio 2010](https://www.microsoft.com/web/gallery/install.aspx?appsxml=&amp;appid=VS2010SP1Pack).
> 
> Для этого раздела доступен проект Visual Web Developer с исходным кодом VB.NET. [Скачайте версию VB.NET](https://code.msdn.microsoft.com/Introduction-to-MVC-3-10d1b098). При желании C#переключитесь на [ C# версию](../cs/adding-a-new-field.md) этого учебника.

В этом разделе вы внесете некоторые изменения в классы модели и узнаете, как можно обновить схему базы данных в соответствии с изменениями модели.

## <a name="adding-a-rating-property-to-the-movie-model"></a>Добавление свойства Rating в модель Movie

Для начала добавьте новое свойство `Rating` в существующий класс `Movie`. Откройте файл *Movie.CS* и добавьте свойство `Rating` следующим образом:

[!code-vb[Main](adding-a-new-field/samples/sample1.vb)]

Теперь полный `Movie` класс выглядит следующим образом:

[!code-vb[Main](adding-a-new-field/samples/sample2.vb)]

Перекомпилируйте приложение с помощью команды меню " **отладка** &gt;**создать ролик** ".

Теперь, когда вы обновили класс `Model`, вам также потребуется обновить шаблоны представления *\виевс\мовиес\индекс.вбхтмл* и *\виевс\мовиес\креате.вбхтмл* , чтобы обеспечить поддержку нового свойства `Rating`.

Откройте файл<em>\виевс\мовиес\индекс.вбхтмл</em> и добавьте заголовок столбца `<th>Rating</th>` сразу после столбца <strong>Price</strong> . Затем добавьте `<td>` столбец рядом с концом шаблона, чтобы отобразить значение `@item.Rating`. Ниже показано, как выглядит обновленный шаблон представления <em>index. vbhtml</em> .

[!code-vbhtml[Main](adding-a-new-field/samples/sample3.vbhtml)]

Затем откройте файл *\виевс\мовиес\креате.вбхтмл* и добавьте следующую разметку в конец формы. При этом текстовое поле подготавливается к просмотру, что позволяет указать рейтинг при создании нового фильма.

[!code-cshtml[Main](adding-a-new-field/samples/sample4.cshtml)]

## <a name="managing-model-and-database-schema-differences"></a>Управление различиями в модели и схеме базы данных

Теперь вы обновили код приложения для поддержки нового свойства `Rating`.

Теперь запустите приложение и перейдите по URL-адресу */Movies* . При этом вы увидите следующую ошибку:

![](adding-a-new-field/_static/image1.png)

Эта ошибка возникает, поскольку обновленный класс модели `Movie` в приложении теперь отличается от схемы `Movie` таблицы существующей базы данных. (В таблице базы данных отсутствует столбец `Rating`.)

По умолчанию при использовании Entity Framework Code First для автоматического создания базы данных, как это было сделано ранее в этом руководстве, Code First добавляет таблицу в базу данных, чтобы определить, синхронизирована ли схема базы данных с классами модели, из которых она была создана. Если они не синхронизированы, Entity Framework выдает ошибку. Это упрощает отслеживание проблем во время разработки, которые в противном случае могут быть найдены (путем маскировки ошибок) во время выполнения. Функция проверки синхронизации — это то, что приводит к отображению сообщения об ошибке, которое вы только что видели.

Существует два подхода к устранению этой ошибки:

1. Можно с помощью Entity Framework автоматически удалить и повторно создать базу данных на основе новой схемы класса модели. Этот подход очень удобен при выполнении активной разработки в тестовой базе данных, так как позволяет быстро развивать модель и схему базы данных вместе. Недостаток этого подхода заключается в том, что в базе данных теряются существующие данные — поэтому вы *не* хотите использовать этот подход в рабочей базе данных!
2. Можно явно изменить схему существующей базы данных в соответствии с новыми классами модели. Преимущество такого подхода состоит в том, что сохраняются все данные. Это изменение можно выполнить как вручную, так и с помощью соответствующего скрипта базы данных.

В этом руководстве мы будем использовать первый подход — у вас будет Entity Framework Code First автоматически воссоздать базу данных в любое время при изменении модели.

## <a name="automatically-re-creating-the-database-on-model-changes"></a>Автоматическое повторное создание базы данных при изменении модели

Теперь обновите приложение таким образом, чтобы Code First автоматически удалят и повторно создает базу данных в любое время, когда вы изменяете модель для приложения.

> [!NOTE] 
> 
> **Предупреждение об ошибке** Этот подход следует включать для автоматического удаления и повторного создания базы данных только при использовании базы данных разработки или тестирования, а *не* в рабочей базе данных, содержащей реальные данные. Использование на рабочем сервере может привести к утрате данных.

В **Обозреватель решений**щелкните правой кнопкой мыши папку *модели* , выберите **добавить**, а затем выберите **класс**.

![](adding-a-new-field/_static/image2.png)

Присвойте классу имя &quot;Мовиеинитиализер&quot;. Обновите класс `MovieInitializer`, чтобы он содержал следующий код:

[!code-vb[Main](adding-a-new-field/samples/sample5.vb)]

Класс `MovieInitializer` указывает, что база данных, используемая моделью, должна быть удалена и автоматически создана повторно, если классы модели когда-либо изменяются. Код включает метод `Seed` для указания некоторых данных по умолчанию, которые автоматически добавляются в базу данных при каждом ее создании (или повторном создании). Это позволяет получить удобный способ заполнения базы данных несколькими демонстрационными данными без необходимости вручную заполнять ее при каждом изменении модели.

Теперь, когда вы определили класс `MovieInitializer`, вы хотите подключить его таким образом, чтобы при каждом запуске приложения он проверял, отличаются ли классы модели от схемы в базе данных. Если это так, можно запустить инициализатор, чтобы повторно создать базу данных в соответствии с моделью и затем заполнить базу данных образцом данных.

Откройте файл *Global. asax* в корне проекта `MvcMovies`:

Файл *Global. asax* содержит класс, который определяет все приложение для проекта, и содержит обработчик событий `Application_Start`, который выполняется при первом запуске приложения.

Найдите метод `Application_Start` и добавьте вызов `Database.SetInitializer` в начале метода, как показано ниже:

[!code-vb[Main](adding-a-new-field/samples/sample6.vb)]

Только что добавленная инструкция `Database.SetInitializer` указывает, что база данных, используемая экземпляром `MovieDBContext`, должна автоматически удаляться и создаваться повторно, если схема и база данных не совпадают. Как вы видели, он также заполняет базу данных образцом данных, указанным в классе `MovieInitializer`.

Закройте файл *Global. asax* .

Повторно запустите приложение и перейдите по URL-адресу */Movies* . При запуске приложение обнаруживает, что структура модели больше не соответствует схеме базы данных. Она автоматически повторно создает базу данных в соответствии с новой структурой модели и заполняет базу данных образцами фильмов:

![7_MyMovieList_SM](adding-a-new-field/_static/image3.png)

Щелкните ссылку **создать** , чтобы добавить новый фильм. Обратите внимание, что можно добавить оценку.

[![7_CreateRioII](adding-a-new-field/_static/image5.png)](adding-a-new-field/_static/image4.png)

Нажмите кнопку **Создать**. Теперь новый фильм, включая рейтинг, отображается в списке фильмов:

![7_ourNewMovie_SM](adding-a-new-field/_static/image6.png)

В этом разделе вы узнали, как можно изменить объекты модели и синхронизировать базу данных с изменениями. Вы также узнали, как заполнить созданную базу данных образцами данных, чтобы вы могли испытать сценарии. Теперь рассмотрим, как можно добавить расширенную логику проверки к классам модели и обеспечить применение некоторых бизнес-правил.

> [!div class="step-by-step"]
> [Назад](examining-the-edit-methods-and-edit-view.md)
> [Вперед](adding-validation-to-the-model.md)
