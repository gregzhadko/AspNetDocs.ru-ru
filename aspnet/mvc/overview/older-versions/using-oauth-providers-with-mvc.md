---
uid: mvc/overview/older-versions/using-oauth-providers-with-mvc
title: Использование поставщиков OAuth с MVC 4 | Документация Майкрософт
author: Rick-Anderson
description: Этот учебник показывает, как создавать веб-приложения ASP.NET MVC 4, который позволяет пользователям входить в систему с учетными данными из внешнего поставщика, например Facebo...
ms.author: riande
ms.date: 06/19/2013
ms.assetid: 7a87f16f-0e19-4f15-a88a-094ae866c4a2
msc.legacyurl: /mvc/overview/older-versions/using-oauth-providers-with-mvc
msc.type: authoredcontent
ms.openlocfilehash: c2fe74c3d7b1aa0d230f1893f6ba7dcaa7a88419
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59396987"
---
# <a name="using-oauth-providers-with-mvc-4"></a>Использование поставщиков OAuth с MVC 4

по [Tom FitzMacken](https://github.com/tfitzmac)

> Этом руководстве показано, как создавать веб-приложение ASP.NET MVC 4, позволяет пользователям войти по учетным данных из внешнего поставщика, например Facebook, Twitter, Microsoft или Google и затем интегрировать некоторые функциональные возможности через эти поставщики в вашей веб-приложение. Для простоты это руководство посвящено работе с учетными данными от Facebook.
> 
> Чтобы использовать внешних учетных данных в веб-приложение ASP.NET MVC 5, см. в разделе [Создание приложения ASP.NET MVC 5 с использованием Facebook и Google OAuth2 и OpenID единого входа](../security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).
> 
> Включение эти учетные данные в веб-сайтов обеспечивает значительное преимущество, так как миллионам пользователей уже есть учетные записи с помощью этих внешних поставщиков. Эти пользователи могут быть более необходимо, чтобы зарегистрироваться для веб-узла, если они не нужно создавать и запоминать новый набор учетных данных. Кроме того после входа пользователя через одного из этих поставщиков, можно включить операции социальных сетей от поставщика.


## <a name="what-youll-build"></a>Вы создадите

В этом учебнике есть две основные цели:

1. Разрешите пользователю войти, используя учетные данные от поставщика OAuth.
2. Получить данные учетной записи от поставщика и интеграции с регистрации учетной записи для вашего сайта.

Несмотря на то, что в примерах в этом руководстве уделить использованию Facebook в качестве поставщика проверки подлинности, можно изменить код, чтобы использовать любого поставщика. Шаги по реализации любого поставщика очень похожи на шаги, вы увидите в этом руководстве. Можно заметить только существенные различия при выполнении прямых вызовов к API поставщика задать.

## <a name="prerequisites"></a>Предварительные требования

- [Microsoft Visual Studio 2012](https://www.microsoft.com/visualstudio/eng/downloads#vs) или [Microsoft Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/eng/downloads#d-2012-express)

Или

- Microsoft Visual Studio 2010 с пакетом обновления 1 или [Visual Web Developer Express 2010 с пакетом обновления 1](https://www.microsoft.com/visualstudio/eng/downloads#d-2010-express)
- [ASP.NET MVC 4](https://go.microsoft.com/fwlink/?LinkId=243392)

Кроме того в этом разделе предполагается, что вы имеете базовые знания о ASP.NET MVC и Visual Studio. Введение в ASP.NET MVC 4, см. в статье [введение в ASP.NET MVC 4](getting-started-with-aspnet-mvc4/intro-to-aspnet-mvc-4.md).

## <a name="create-the-project"></a>Создание проекта

В Visual Studio создайте новое приложение ASP.NET MVC 4 Web и назовите его &quot;OAuthMVC&quot;. Можно работать с .NET Framework 4.5 или 4.

![Создание проекта](using-oauth-providers-with-mvc/_static/image1.png)

В окне создания проекта ASP.NET MVC 4, выберите **веб-приложение** и оставить **Razor** как обработчик представлений.

![Выберите веб-приложение](using-oauth-providers-with-mvc/_static/image2.png)

## <a name="enable-a-provider"></a>Включение поставщика

При создании веб-приложение MVC 4 с помощью шаблона веб-приложение, файл с именем AuthConfig.cs в приложении создается проект\_Начальная папка.

![Файл AuthConfig](using-oauth-providers-with-mvc/_static/image3.png)

Файл AuthConfig содержит код для регистрации клиентов для внешних поставщиков проверки подлинности. По умолчанию этот код закомментирован, поэтому ни один из внешних поставщиков включены.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample1.cs)]

Необходимо Раскомментировать этот код для использования внешней проверки подлинности клиента. Раскомментировать только поставщиков, который вы хотите включить в веб-узла. В этом учебнике будет включена только учетными данными Facebook.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample2.cs)]

Обратите внимание, что в приведенном выше примере, что метод включает пустые строки для параметров регистрации. Если попытаться запустить приложение сейчас, приложение создает исключение аргумента, так как пустые строки запрещены для параметров. Чтобы предоставить допустимые значения, необходимо зарегистрировать веб-сайт с помощью внешних поставщиков, как показано в следующем разделе.

## <a name="registering-with-an-external-provider"></a>Регистрация с помощью внешнего поставщика

Для проверки подлинности пользователей с учетными данными из внешнего поставщика, необходимо зарегистрировать веб-сайт с поставщиком. При регистрации веб-узла, вы получите параметры (например, ключ или идентификатор и секрет) для включения при регистрации клиента. Необходимо иметь учетную запись с поставщиками, которые вы хотите использовать.

Этот учебник не содержит все действия, которые необходимо выполнить для регистрации этих поставщиков. Действия, обычно не сложно. Для успешной регистрации веб-узла, следуйте инструкциям, приведенным на этих сайтах. Чтобы начать работу с Регистрация веб-узла, см. в разделе на сайте разработчика:

- [Facebook](https://developers.facebook.com/)
- [Google](https://developers.google.com/)
- [Майкрософт](http://manage.dev.live.com/)
- [Twitter](https://dev.twitter.com/)

Если регистрация веб-узла с помощью Facebook, вы можете предоставить &quot;localhost&quot; для домена сайта и `&quot;http://localhost/&quot;` для URL-адреса, как показано на рисунке ниже. С помощью localhost работает с большинством поставщиков, но в настоящее время не работает с поставщиком Microsoft. Для поставщика Microsoft необходимо включить веб-сайт, допустимый URL-адрес.

![Зарегистрируйте сайт](using-oauth-providers-with-mvc/_static/image4.png)

На предыдущем рисунке значения для идентификатора приложения, секрет приложения и контактный адрес электронной почты будут удалены. Когда вы фактически регистрации узла, будет присутствовать эти значения. Требуется Обратите внимание на значения для идентификатора приложения и секрет приложения, так как их можно добавить в приложение.

## <a name="creating-test-users"></a>Создание тестовых пользователей

Если не имеет значения, используя существующую учетную запись Facebook для проверки сайта, этот раздел можно пропустить.

Можно легко создать тестовых пользователей для приложения на странице управления приложения Facebook. Их можно использовать тестовые учетные записи для входа на сайт. Создайте тестовых пользователей, щелкнув **ролей** ссылку в левой области навигации и нажав кнопку **создать** ссылку.

![Создание тестовых пользователей](using-oauth-providers-with-mvc/_static/image5.png)

На сайте Facebook автоматически создает число тестовых учетных записей, которые можно запрашивать.

## <a name="adding-application-id-and-secret-from-the-provider"></a>Добавление идентификатора приложения и секрет от поставщика

Теперь, когда вы получили идентификатор и секрет от Facebook, вернитесь к файлу AuthConfig и добавить их в качестве значений параметров. Указанные ниже значения не являются реальными значениями.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample3.cs)]

## <a name="log-in-with-external-credentials"></a>Войдите с помощью внешних учетных данных

Это все, что нужно сделать для включения внешних учетных данных узла. Запустите приложение и щелкните ссылку входа в правом верхнем углу. Шаблон автоматически распознает зарегистрировали Facebook как поставщик и включает в себя поставщика кнопки. Если зарегистрировать несколько поставщиков, кнопки для каждого из них будет автоматически включена.

![Внешнее имя входа](using-oauth-providers-with-mvc/_static/image6.png)

Этом руководстве не рассматривается настройка журнала в кнопках для внешних поставщиков. Дополнительные сведения см. в разделе [Настройка пользовательский Интерфейс входа, при использовании протокола OAuth или OpenID](https://blogs.msdn.com/b/pranav_rastogi/archive/2012/08/24/customizing-the-login-ui-when-using-oauth-openid.aspx).

Нажмите кнопку "Facebook", чтобы войти с учетными данными Facebook. При выборе одного из внешних поставщиков, вы перенаправляются к этому сайту и запрос служб на вход.

Ниже показан экран входа для Facebook. Он отмечает, что при использовании учетной записи Facebook, чтобы войти на сайт с именем oauthmvcexample.

![Проверка подлинности Facebook](using-oauth-providers-with-mvc/_static/image7.png)

После входа с учетными данными Facebook, страницу пользователю, сайт будет иметь доступ к основные сведения.

![Запросите разрешения](using-oauth-providers-with-mvc/_static/image8.png)

После выбора **перейдите к приложению**, пользователь должен зарегистрировать для сайта. Ниже приведен на странице регистрации, после входа пользователя в систему с учетными данными Facebook. Имя пользователя обычно предварительно заполняется, его имя от поставщика.

![register](using-oauth-providers-with-mvc/_static/image9.png)

Нажмите кнопку **зарегистрировать** для завершения регистрации. Закройте браузер.

Вы увидите, что новая учетная запись добавлен к базе данных. В обозревателе сервера откройте **DefaultConnection** базы данных и откройте **таблиц** папки.

![таблицы баз данных](using-oauth-providers-with-mvc/_static/image10.png)

Щелкните правой кнопкой мыши **UserProfile** таблицы и выберите **Показать таблицу данных**.

![Отображение данных](using-oauth-providers-with-mvc/_static/image11.png)

Вы увидите новую учетную запись, которую вы добавили. Просмотрите данные в **веб-странице\_OAuthMembership** таблицы. Вы увидите дополнительные данные, относящиеся к внешнему поставщику для учетной записи, которую вы только что добавили.

Если вы хотите только включить внешней проверки подлинности, завершено. Тем не менее Дополнительно можно интегрировать сведения от поставщика в процесс регистрации пользователя, как показано в следующих разделах.

## <a name="create-models-for-additional-user-information"></a>Создание моделей для дополнительных сведений о пользователе

Как можно заметить в предыдущих разделах, вы не обязательно должны извлекать любые дополнительные данные для встроенной учетной записи регистрации для работы. Однако большинство внешних поставщиков передачи обратно дополнительных сведений о пользователе. Ниже показано, как сохраняют эту информацию и сохраните его в базу данных. В частности вы сохраните значения для полного имени пользователя, URI пользователя личные веб-страницы и значение, указывающее, проверяются ли Facebook учетную запись.

Вы воспользуетесь [Code First Migrations](https://msdn.microsoft.com/data/jj591621) Добавление таблицы для хранения дополнительных сведений о пользователе. Таблицы будут добавлены к существующей базе данных, поэтому необходимо сначала создать моментальный снимок текущей базы данных. Создавая моментальный снимок текущей базы данных, можно создать позже миграции, который содержит только новую таблицу. Чтобы создать моментальный снимок текущей базы данных:

1. Откройте **консоль диспетчера пакетов**
2. Выполните команду **enable-migrations**
3. Выполните команду **добавьте миграции начальной — IgnoreChanges**
4. Выполните команду **обновления базы данных**

Теперь вы добавите новые свойства. В папке Models откройте файл AccountModels.cs и найти класс RegisterExternalLoginModel. Класс RegisterExternalLoginModel содержит значения, полученные от поставщика проверки подлинности. Добавьте свойства с именами FullName и ссылку, как показано ниже.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample4.cs?highlight=9-13)]

Также в AccountModels.cs, добавьте новый класс с именем ExtraUserInformation. Этот класс представляет новую таблицу, которая будет создана в базе данных.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample5.cs)]

В классе UsersContext добавьте выделенный код ниже, чтобы создать свойство DbSet для нового класса.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample6.cs?highlight=9)]

Теперь вы готовы к созданию новой таблицы. Откройте консоль диспетчера пакетов, еще раз и это время:

1. Выполните команду **AddExtraUserInformation Добавление миграции**
2. Выполните команду **обновления базы данных**

Новая таблица теперь существует в базе данных.

## <a name="retrieve-the-additional-data"></a>Получить дополнительные данные

Существует два способа получения дополнительных сведений о пользователях. Первый способ заключается в том, чтобы сохранить данные пользователя, который передается обратно, по умолчанию, во время запроса на проверку подлинности. Вторым способом является специально вызывать API поставщика и запросить дополнительную информацию. Значения по FullName и связи, автоматически передаются обратно с Facebook. Значение, указывающее, проверяются ли Facebook учетная запись извлекается посредством вызова Facebook API. Во-первых нужно будет заполнить значений для FullName и ссылку и затем более поздней версии, вы получите Проверенное значение.

Чтобы получить дополнительные данные о пользователе, откройте **AccountController.cs** файл **контроллеров** папки.

Этот файл содержит логику для ведения журнала, регистрации и управления учетными записями. В частности, обратите внимание, что методы, вызываемые **ExternalLoginCallback** и **ExternalLoginConfirmation**. В этих методов можно добавить код для настройки операции внешнего входа для приложения. Первая часть **ExternalLoginCallback** метод содержит:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample7.cs)]

Дополнительные данные о пользователе передается обратно в **ExtraData** свойство **AuthenticationResult** объект, возвращаемый из **VerifyAuthentication** метод. Клиент Facebook содержит следующие значения в **ExtraData** свойство:

- id
- имя
- связь
- Пол
- accesstoken

Другие поставщики будут иметь похожие но слегка отличающиеся данные в свойстве ExtraData.

Если пользователь является новый сайт, вы извлечет некоторые дополнительные данные и передачи этих данных в представление подтверждения. Последний блок кода в методе выполняется только в том случае, если пользователь является новый сайт. Замените следующую строку:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample8.cs)]

Со следующей строки:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample9.cs)]

Это изменение просто содержит значения для свойства FullName и ссылки.

В **ExternalLoginConfirmation** метод, измените код, выделенный ниже, чтобы сохранить Дополнительные сведения о пользователе.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample10.cs?highlight=4,7-13)]

## <a name="adjusting-the-view"></a>Настройка изображения

Дополнительные данные о пользователе, полученный от поставщика будет отображаться на странице регистрации.

В **представления**/**учетной записи** откройте **ExternalLoginConfirmation.cshtml**. Ниже существующего поля для имени пользователя добавьте поля FullName, ссылки и PictureLink.

[!code-cshtml[Main](using-oauth-providers-with-mvc/samples/sample11.cshtml)]

Теперь вы готовы почти для запуска приложения и зарегистрируйте нового пользователя с дополнительной информацией, который сохранен. Необходимо иметь учетную запись, которая еще не зарегистрирован с сайтом. Можно использовать другой тестовой учетной записи, или удалить строки в **UserProfile** и **веб-страниц\_OAuthMembership** таблиц для учетной записи, необходимо повторно использовать. Удалив эти строки, вы должны гарантировать, что учетная запись зарегистрирована еще раз.

Запустите приложение и зарегистрируйте нового пользователя. Обратите внимание, что это время на странице подтверждения дополнительные значения.

![register](using-oauth-providers-with-mvc/_static/image12.png)

После завершения регистрации, закройте браузер. Найдите в базе данных и обратите внимание на новые значения в **ExtraUserInformation** таблицы.

## <a name="install-nuget-package-for-facebook-api"></a>Установите пакет NuGet для Facebook API

Facebook предоставляет [API](https://developers.facebook.com/docs/reference/apis/) , можно вызвать для выполнения операций. Интерфейс Facebook API можно вызвать либо путем направления отправки запросов HTTP, либо с помощью установки пакета NuGet, упрощающий отправки этих запросов. С помощью пакета NuGet отображается в этом руководстве, но установка NuGet пакета не является необходимым. Этом руководстве показано, как использовать пакет Facebook C# SDK. Существуют другие пакеты NuGet, помощи при вызове Facebook API.

Из **управление пакетами NuGet** windows, выберите пакет, пакет SDK для Facebook C#.

![Установка пакета](using-oauth-providers-with-mvc/_static/image13.png)

Facebook C# SDK будет использовать для вызова операции, которой требуется маркер доступа для пользователя. В следующем разделе показано, как получить маркер доступа.

## <a name="retrieve-access-token"></a>Получить маркер доступа

Большинство внешних поставщиков вернуть маркер доступа после проверки учетных данных пользователя. Этот маркер доступа очень важно, так как она позволяет вызывать операции, которые доступны только пользователям, прошедшим проверку. Таким образом извлечение и хранение маркера доступа важно для обеспечения дополнительных функциональных возможностей.

В зависимости от внешнего поставщика маркер доступа могут быть допустимы только в течение ограниченного времени. Чтобы убедиться, что у вас есть действительный маркер доступа, вы получите его каждый раз пользователь входит в систему и сохраните его как значение сеанса, а не сохраняется в базе данных.

В **ExternalLoginCallback** метод, маркер доступа также передается обратно в **ExtraData** свойство **AuthenticationResult** объекта. Добавьте выделенный код, который **ExternalLoginCallback** сохранить маркер доступа в **сеанса** объекта. Этот код выполняется каждый раз при входе пользователя в учетную запись Facebook.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample12.cs?highlight=11-14)]

Несмотря на то, что в этом примере извлекает токен доступа от Facebook, можно получить маркер доступа из любого внешнего поставщика через тот же ключ с именем &quot;accesstoken&quot;.

## <a name="logging-off"></a>выход из системы;

Значение по умолчанию **выхода** метод входа пользователя из приложения, но не выполняет вход пользователя из внешнего поставщика. Для входа пользователя из Facebook и предотвращения маркер от сохранения после завершения сеанса пользователя, можно добавить следующий выделенный код, который **выхода** метод в AccountController.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample13.cs?highlight=6-14)]

Значение, вами в `next` параметр является URL-адрес для использования после выхода пользователя Facebook. При тестировании на локальном компьютере будет укажите правильный номер порта для локального сайта. В рабочей среде вы не сможете страницу по умолчанию, например contoso.com.

## <a name="retrieve-user-information-that-requires-the-access-token"></a>Получить сведения о пользователе, который требуется маркер доступа

Теперь, когда у вас хранятся маркер доступа и установки пакета пакет SDK для Facebook C#, их можно использовать вместе для запроса дополнительных сведений о пользователе из Facebook. В **ExternalLoginConfirmation** метод, создайте экземпляр **FacebookClient** класса, передавая значение маркера доступа. Запросите значение **проверить** свойства для текущего пользователя. **Проверить** свойство указывает, прошел ли Facebook учетной записи через другие средства, такие как отправка сообщения на мобильный телефон. Сохраните это значение в базе данных.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample14.cs?highlight=7-18,25)]

Снова потребуется либо удалить записи из базы данных для пользователя, либо использовать другую учетную запись Facebook.

Запустите приложение и регистрации нового пользователя. Рассмотрим **ExtraUserInformation** таблицу, чтобы узнать значение свойства проверяется.

## <a name="conclusion"></a>Заключение

В этом руководстве вы создали сайт, который интегрируется с Facebook для проверки подлинности пользователей и регистрационные данные. Вы узнали о поведении по умолчанию, настроенный для веб-приложение MVC 4 и как настроить это поведение по умолчанию.

## <a name="related-topics"></a>См. также

- [Создание приложения ASP.NET MVC с проверкой подлинности и база данных SQL и развертывание в службе приложений Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data)
