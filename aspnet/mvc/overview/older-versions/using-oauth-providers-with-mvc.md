---
uid: mvc/overview/older-versions/using-oauth-providers-with-mvc
title: Использование поставщиков OAuth с MVC 4 | Документация Майкрософт
author: Rick-Anderson
description: В этом руководстве показано, как создать веб-приложение ASP.NET MVC 4, которое позволяет пользователям входить с учетными данными из внешнего поставщика, например Фацебо...
ms.author: riande
ms.date: 06/19/2013
ms.assetid: 7a87f16f-0e19-4f15-a88a-094ae866c4a2
msc.legacyurl: /mvc/overview/older-versions/using-oauth-providers-with-mvc
msc.type: authoredcontent
ms.openlocfilehash: 5dfd1305376a62f4987caea242ca0f6aac1018e9
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78433368"
---
# <a name="using-oauth-providers-with-mvc-4"></a>Использование поставщиков OAuth с MVC 4

от [Tom фитзмаккен](https://github.com/tfitzmac)

> В этом руководстве показано, как создать веб-приложение ASP.NET MVC 4, которое позволяет пользователям входить в систему с учетными данными из внешнего поставщика, такого как Facebook, Twitter, Microsoft или Google, а затем интегрировать некоторые функции этих поставщиков в веб-приложение. Для простоты в этом учебнике рассматривается работа с учетными данными из Facebook.
> 
> Сведения об использовании внешних учетных данных в веб-приложении ASP.NET MVC 5 см. в статье [Создание приложения ASP.NET MVC 5 с помощью Facebook и Google OAuth2 и OpenID Connect вход](../security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).
> 
> Включение этих учетных данных на веб-сайтах обеспечивает значительное преимущество, поскольку миллионы пользователей уже имеют учетные записи с этими внешними поставщиками. Эти пользователи могут быть более наклонными для регистрации на сайте, если им не нужно создавать и запоминать новый набор учетных данных. Кроме того, после входа пользователя через одного из этих поставщиков можно включить социальные операции от поставщика.

## <a name="what-youll-build"></a>Что будет построено

В этом учебнике есть две основные цели.

1. Разрешить пользователю выполнять вход с учетными данными из поставщика OAuth.
2. Получение сведений об учетной записи от поставщика и их интеграция с регистрацией учетной записи для сайта.

Хотя в примерах этого учебника основное внимание уделяется использованию Facebook в качестве поставщика проверки подлинности, можно изменить код для использования любого из поставщиков. Действия по реализации любого поставщика очень похожи на шаги, которые вы увидите в этом учебнике. При осуществлении прямых вызовов к набору API поставщика будут заметны только значительные отличия.

## <a name="prerequisites"></a>предварительные требования

- [Microsoft Visual Studio 2012](https://www.microsoft.com/visualstudio/eng/downloads#vs) или [Microsoft Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/eng/downloads#d-2012-express)

либо

- Microsoft Visual Studio 2010 SP1 или [Visual Web Developer Express 2010 SP1](https://www.microsoft.com/visualstudio/eng/downloads#d-2010-express)
- [ASP.NET MVC 4](https://go.microsoft.com/fwlink/?LinkId=243392)

Кроме того, в этом разделе предполагается, что у вас есть базовые знания о ASP.NET MVC и Visual Studio. Если вам требуется введение в ASP.NET MVC 4, см. статью введение [в ASP.NET MVC 4](getting-started-with-aspnet-mvc4/intro-to-aspnet-mvc-4.md).

## <a name="create-the-project"></a>Создание проекта

В Visual Studio создайте новое веб-приложение ASP.NET MVC 4 и назовите его &quot;Оаусмвк&quot;. Можно выбрать либо .NET Framework 4,5, либо 4.

![создание проекта](using-oauth-providers-with-mvc/_static/image1.png)

В новом окне проекта ASP.NET MVC 4 выберите **Интернет приложение** и оставьте **Razor** в качестве обработчика представлений.

![выбор Интернет приложения](using-oauth-providers-with-mvc/_static/image2.png)

## <a name="enable-a-provider"></a>Включение поставщика

При создании веб-приложения MVC 4 с помощью шаблона приложения Интернета проект создается с файлом с именем AuthConfig.cs в папке App\_Start.

![Файл Аусконфиг](using-oauth-providers-with-mvc/_static/image3.png)

Файл Аусконфиг содержит код для регистрации клиентов для внешних поставщиков проверки подлинности. По умолчанию этот код записывается в комментарий, поэтому внешние поставщики не включаются.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample1.cs)]

Необходимо раскомментировать этот код, чтобы использовать внешний клиент проверки подлинности. Вы Раскомментируйте только те поставщики, которые вы хотите включить на сайт. В этом учебнике будут включены только учетные данные Facebook.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample2.cs)]

Обратите внимание, что в приведенном выше примере метод содержит пустые строки для параметров регистрации. Если вы попытаетесь запустить приложение сейчас, приложение создаст исключение аргумента, так как для параметров не допускаются пустые строки. Чтобы указать допустимые значения, необходимо зарегистрировать веб-сайт с внешними поставщиками, как показано в следующем разделе.

## <a name="registering-with-an-external-provider"></a>Регистрация с помощью внешнего поставщика

Чтобы проверить подлинность пользователей с помощью учетных данных внешнего поставщика, необходимо зарегистрировать веб-сайт в поставщике. При регистрации сайта вы получите параметры (например, ключ или идентификатор и секрет), которые будут включены при регистрации клиента. Необходимо иметь учетную запись с поставщиками, которые вы хотите использовать.

В этом учебнике не показаны все действия, которые необходимо выполнить для регистрации в этих поставщиках. Обычно эти действия не являются сложными. Для успешной регистрации сайта следуйте инструкциям, приведенным на этих сайтах. Чтобы приступить к регистрации сайта, ознакомьтесь с разработкой сайта для разработчиков:

- [Facebook](https://developers.facebook.com/)
- [Google](https://developers.google.com/)
- [Майкрософт](http://manage.dev.live.com/)
- [Twitter](https://dev.twitter.com/)

При регистрации сайта в Facebook можно указать &quot;localhost&quot; для домена сайта и `&quot; http://localhost/&quot;` URL-адрес, как показано на рисунке ниже. Использование localhost работает с большинством поставщиков, но в настоящее время не работает с поставщиком Майкрософт. Для поставщика услуг Майкрософт необходимо указать допустимый URL-адрес сайта.

![зарегистрировать сайт](using-oauth-providers-with-mvc/_static/image4.png)

На предыдущем рисунке были удалены значения идентификатора приложения, секрета приложения и контактного адреса электронной почты. При фактической регистрации сайта эти значения будут представлены. Необходимо отметить значения идентификатора приложения и секрета приложения, так как они будут добавлены в приложение.

## <a name="creating-test-users"></a>Создание тестовых пользователей

Если вы не хотите использовать существующую учетную запись Facebook для тестирования сайта, этот раздел можно пропустить.

Вы можете легко создавать тестовых пользователей для приложения на странице управления приложениями Facebook. Эти тестовые учетные записи можно использовать для входа на сайт. Чтобы создать тестовых пользователей, щелкните ссылку **роли** в левой области навигации и щелкните ссылку **создать** .

![Создание тестовых пользователей](using-oauth-providers-with-mvc/_static/image5.png)

Сайт Facebook автоматически создает запрошенное количество тестовых учетных записей.

## <a name="adding-application-id-and-secret-from-the-provider"></a>Добавление идентификатора приложения и секрета от поставщика

Теперь, когда вы получили идентификатор и секрет из Facebook, вернитесь в файл Аусконфиг и добавьте их в качестве значений параметров. Приведенные ниже значения не являются реальными значениями.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample3.cs)]

## <a name="log-in-with-external-credentials"></a>Вход с использованием внешних учетных данных

Это все, что необходимо сделать для включения внешних учетных данных на сайте. Запустите приложение и щелкните ссылку входа в правом верхнем углу. Шаблон автоматически определяет, что вы зарегистрировали Facebook в качестве поставщика и включаете кнопку для поставщика. При регистрации нескольких поставщиков кнопка для каждой из них автоматически включается.

![внешнее имя входа](using-oauth-providers-with-mvc/_static/image6.png)

В этом учебнике не рассматривается настройка кнопок входа для внешних поставщиков. Дополнительные сведения см. [в разделе Настройка пользовательского интерфейса входа при использовании OAuth/OpenID Connect](https://blogs.msdn.com/b/pranav_rastogi/archive/2012/08/24/customizing-the-login-ui-when-using-oauth-openid.aspx).

Нажмите кнопку Facebook, чтобы войти с использованием учетных данных Facebook. При выборе одного из внешних поставщиков вы перенаправляетесь на этот сайт и запрашиваете эту службу для входа.

На следующем рисунке показан экран входа для Facebook. Заметка, что вы используете учетную запись Facebook для входа на сайт с именем оаусмвцексампле.

![Проверка подлинности Facebook](using-oauth-providers-with-mvc/_static/image7.png)

После входа с использованием учетных данных Facebook страница информирует пользователя о том, что сайт будет иметь доступ к основным сведениям.

![запросить разрешение](using-oauth-providers-with-mvc/_static/image8.png)

После выбора пункта **Переход к приложению**пользователь должен зарегистрироваться для сайта. На следующем рисунке показана страница регистрации после входа пользователя с учетными данными Facebook. Имя пользователя обычно заранее заполняется именем поставщика.

![регистрация](using-oauth-providers-with-mvc/_static/image9.png)

Нажмите кнопку **Регистрация** , чтобы завершить регистрацию. Закройте браузер.

Вы видите, что новая учетная запись добавлена в базу данных. В обозреватель сервера откройте базу данных **DefaultConnection** и откройте папку **таблицы** .

![таблицы баз данных](using-oauth-providers-with-mvc/_static/image10.png)

Щелкните правой кнопкой мыши таблицу **UserProfile** и выберите команду **отобразить данные таблицы**.

![Отображение данных](using-oauth-providers-with-mvc/_static/image11.png)

Вы увидите новую добавленную учетную запись. Просмотрите данные на **веб-странице\_таблице оаусмембершип** . Вы увидите больше данных, связанных с внешним поставщиком для только что добавленной учетной записи.

Если вы хотите включить только внешнюю проверку подлинности, то все готово. Однако вы можете дополнительно интегрировать информацию из поставщика в новый процесс регистрации пользователей, как показано в следующих разделах.

## <a name="create-models-for-additional-user-information"></a>Создание моделей для дополнительных сведений о пользователях

Как вы заметили в предыдущих разделах, вам не нужно получать дополнительные сведения для работы встроенной регистрации учетной записи. Однако большинство внешних поставщиков передают дополнительные сведения о пользователе. В следующих разделах показано, как сохранить эти сведения и сохранить их в базе данных. В частности, будут сохранены значения для полного имени пользователя, URI личной веб-страницы пользователя и значение, указывающее, проверялась ли учетная запись в Facebook.

Чтобы добавить таблицу для хранения дополнительных сведений о пользователях, используйте [Code First migrations](https://msdn.microsoft.com/data/jj591621) . Вы добавляете таблицу в существующую базу данных, поэтому сначала необходимо создать моментальный снимок текущей базы данных. Создав моментальный снимок текущей базы данных, можно позднее создать миграцию, содержащую только новую таблицу. Создание моментального снимка текущей базы данных:

1. Открытие **консоли диспетчера пакетов**
2. Выполнение команды " **включить и перенести** "
3. Выполните команду " **Добавить-перенести" начальный — игноречанжес**
4. Выполнение команды **Update — Database**

Теперь вы добавите новые свойства. В папке Models откройте файл AccountModels.cs и найдите класс Регистерекстерналлогинмодел. Класс Регистерекстерналлогинмодел содержит значения, возвращенные поставщиком проверки подлинности. Добавьте свойства с именем FullName и Link, как показано ниже.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample4.cs?highlight=9-13)]

Кроме того, в AccountModels.cs добавьте новый класс с именем Екстраусеринформатион. Этот класс представляет новую таблицу, которая будет создана в базе данных.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample5.cs)]

В классе Усерсконтекст Добавьте выделенный ниже код, чтобы создать свойство DbSet для нового класса.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample6.cs?highlight=9)]

Теперь все готово для создания новой таблицы. Снова откройте консоль диспетчера пакетов и на этот раз:

1. Выполните команду **Add-Migration аддекстраусеринформатион**
2. Выполнение команды **Update — Database**

Новая таблица теперь существует в базе данных.

## <a name="retrieve-the-additional-data"></a>Получение дополнительных данных

Получить дополнительные данные пользователя можно двумя способами. Первый способ — хранить пользовательские данные, которые по умолчанию передаются обратно во время запроса проверки подлинности. Второй способ заключается в специальном вызове API поставщика и запросе дополнительных сведений. Значения FullName и LINK автоматически передаются обратно Facebook. Значение, указывающее, проверялась ли учетная запись Facebook при вызове API Facebook. Сначала вы заполните значения FullName и Link, а затем получите проверенное значение.

Чтобы получить дополнительные данные пользователя, откройте файл **AccountController.CS** в папке **Controllers** .

Этот файл содержит логику для ведения журнала, регистрации и управления учетными записями. В частности, обратите внимание на методы с именами **екстерналлогинкаллбакк** и **ExternalLoginConfirmation**. В этих методах можно добавить код для настройки операций внешнего входа в приложение. Первая строка метода **екстерналлогинкаллбакк** содержит:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample7.cs)]

Дополнительные пользовательские данные передаются обратно в свойство **екстрадата** объекта **AuthenticationResult** , возвращаемого методом **верифяусентикатион** . Клиент Facebook содержит следующие значения в свойстве **екстрадата** :

- идентификатор
- name
- link
- gender
- accesstoken

Другие поставщики будут иметь похожие, но слегка отличающиеся данные в свойстве Екстрадата.

Если пользователь является новым для вашего сайта, вы получите некоторые дополнительные данные и передайте их в представление подтверждения. Последний блок кода в методе выполняется только в том случае, если пользователь является новым для вашего сайта. Замените следующую строку:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample8.cs)]

Вставьте вместо нее эту строку:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample9.cs)]

Это изменение просто включает значения свойств FullName и Link.

В методе **ExternalLoginConfirmation** измените код, выделенный ниже, чтобы сохранить дополнительные сведения о пользователе.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample10.cs?highlight=4,7-13)]

## <a name="adjusting-the-view"></a>Настройка представления

Дополнительные данные пользователя, получаемые от поставщика, будут отображаться на странице регистрации.

В папке **views**/**Account** (представления) откройте **ExternalLoginConfirmation. cshtml**. Под существующим полем Имя пользователя добавьте поля для FullName, Link и Пиктурелинк.

[!code-cshtml[Main](using-oauth-providers-with-mvc/samples/sample11.cshtml)]

Теперь все готово для запуска приложения и регистрации нового пользователя с сохранением дополнительной информации. Необходимо иметь учетную запись, которая еще не зарегистрирована на сайте. Можно использовать другую тестовую учетную запись или удалить строки в **UserProfile** и **веб-страницах\_оаусмембершип** таблицы для учетной записи, которую вы хотите повторно использовать. Удаляя эти строки, вы гарантируете, что учетная запись снова будет зарегистрирована.

Запустите приложение и зарегистрируйте нового пользователя. Обратите внимание, что на этот раз страница подтверждения содержит больше значений.

![регистрация](using-oauth-providers-with-mvc/_static/image12.png)

После завершения регистрации закройте браузер. Просмотрите базу данных, чтобы увидеть новые значения в таблице **екстраусеринформатион** .

## <a name="install-nuget-package-for-facebook-api"></a>Установка пакета NuGet для API Facebook

Facebook предоставляет [API](https://developers.facebook.com/docs/reference/apis/) , который можно вызывать для выполнения операций. Вы можете вызвать API Facebook либо путем направления отправки HTTP-запросов, либо путем установки пакета NuGet, который упрощает отправку этих запросов. В этом руководстве показано использование пакета NuGet, но установка пакета NuGet не является обязательной. В этом руководстве показано, как использовать пакет C# SDK для Facebook. Существуют другие пакеты NuGet, помогающие при вызове API Facebook.

В окнах **Управление пакетами NuGet** выберите пакет SDK C# для Facebook.

![установить пакет](using-oauth-providers-with-mvc/_static/image13.png)

Пакет SDK для Facebook C# будет использоваться для вызова операции, для которой требуется маркер доступа пользователя. В следующем разделе показано, как получить маркер доступа.

## <a name="retrieve-access-token"></a>Получить маркер доступа

Большинство внешних поставщиков передают маркер доступа после проверки учетных данных пользователя. Этот маркер доступа очень важен, так как он позволяет вызывать операции, доступные только для пользователей, прошедших проверку подлинности. Поэтому получение и хранение маркера доступа очень важно, если требуется предоставить больше функциональных возможностей.

В зависимости от внешнего поставщика маркер доступа может быть допустимым только в течение ограниченного периода времени. Чтобы обеспечить наличие допустимого маркера доступа, он будет извлекаться каждый раз при входе пользователя в систему и хранить его как значение сеанса, а не сохранять в базе данных.

В методе **екстерналлогинкаллбакк** маркер доступа также передается обратно в свойство **екстрадата** объекта **AuthenticationResult** . Добавьте выделенный код в **екстерналлогинкаллбакк** , чтобы сохранить маркер доступа в объекте **Session** . Этот код выполняется каждый раз, когда пользователь входит в систему с учетной записью Facebook.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample12.cs?highlight=11-14)]

Хотя этот пример извлекает маркер доступа из Facebook, можно получить маркер доступа от любого внешнего поставщика с помощью того же ключа с именем &quot;accesstoken&quot;.

## <a name="logging-off"></a>выход из системы;

Метод **выхода из системы** по умолчанию записывает пользователя в приложение, но не выполнит выход пользователя из внешнего поставщика. Для выхода пользователя из Facebook и предотвращения сохранения маркера после выхода пользователя из системы можно добавить следующий выделенный код в метод **logoff** в AccountController.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample13.cs?highlight=6-14)]

Значение, которое вы задаете в параметре `next`, является URL-адресом, который будет использоваться после выхода пользователя из Facebook. При тестировании на локальном компьютере необходимо указать правильный номер порта для локального сайта. В рабочей среде можно указать страницу по умолчанию, например contoso.com.

## <a name="retrieve-user-information-that-requires-the-access-token"></a>Получение сведений о пользователе, требующем маркера доступа

Теперь, когда вы сохранили маркер доступа и установили пакет C# SDK для Facebook, вы можете использовать их вместе для запроса дополнительных сведений о пользователях из Facebook. В методе **ExternalLoginConfirmation** создайте экземпляр класса **фацебукклиент** , передав значение маркера доступа. Запросите значение **проверенного** свойства для текущего пользователя, прошедшего проверку подлинности. Свойство " **Проверено** " указывает, проверила ли учетная запись Facebook с помощью других средств, таких как отправка сообщения на сотовый телефон. Сохраните это значение в базе данных.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample14.cs?highlight=7-18,25)]

Потребуется либо удалить записи в базе данных для пользователя, либо использовать другую учетную запись Facebook.

Запустите приложение и зарегистрируйте нового пользователя. Просмотрите таблицу **екстраусеринформатион** , чтобы увидеть значение для проверенного свойства.

## <a name="conclusion"></a>Заключение

В этом руководстве вы создали сайт, интегрированный с Facebook для проверки подлинности пользователей и регистрации данных. Вы узнали о поведении по умолчанию, которое настроено для веб-приложения MVC 4, и о том, как настроить это поведение по умолчанию.

## <a name="related-topics"></a>Связанные разделы

- [Создание приложения ASP.NET MVC с аутентификацией и базой данных SQL и его развертывание в службе приложений Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data)
