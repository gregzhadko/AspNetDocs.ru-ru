---
uid: mvc/overview/older-versions/using-oauth-providers-with-mvc
title: Использование поставщиков OAuth с MVC 4 | Документация Майкрософт
author: Rick-Anderson
description: В этом руководстве показано, как создать веб-приложение ASP.NET MVC 4, которое позволяет пользователям входить с учетными данными из внешнего поставщика, например Фацебо...
ms.author: riande
ms.date: 06/19/2013
ms.assetid: 7a87f16f-0e19-4f15-a88a-094ae866c4a2
msc.legacyurl: /mvc/overview/older-versions/using-oauth-providers-with-mvc
msc.type: authoredcontent
ms.openlocfilehash: 5dfd1305376a62f4987caea242ca0f6aac1018e9
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78433368"
---
# <a name="using-oauth-providers-with-mvc-4"></a><span data-ttu-id="f8776-103">Использование поставщиков OAuth с MVC 4</span><span class="sxs-lookup"><span data-stu-id="f8776-103">Using OAuth Providers with MVC 4</span></span>

<span data-ttu-id="f8776-104">от [Tom фитзмаккен](https://github.com/tfitzmac)</span><span class="sxs-lookup"><span data-stu-id="f8776-104">by [Tom FitzMacken](https://github.com/tfitzmac)</span></span>

> <span data-ttu-id="f8776-105">В этом руководстве показано, как создать веб-приложение ASP.NET MVC 4, которое позволяет пользователям входить в систему с учетными данными из внешнего поставщика, такого как Facebook, Twitter, Microsoft или Google, а затем интегрировать некоторые функции этих поставщиков в веб-приложение.</span><span class="sxs-lookup"><span data-stu-id="f8776-105">This tutorial shows you how to build an ASP.NET MVC 4 web application that enables users to log in with credentials from an external provider, such as Facebook, Twitter, Microsoft, or Google, and then integrate some of the functionality from those providers into your web application.</span></span> <span data-ttu-id="f8776-106">Для простоты в этом учебнике рассматривается работа с учетными данными из Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-106">For simplicity, this tutorial focuses on working with credentials from Facebook.</span></span>
> 
> <span data-ttu-id="f8776-107">Сведения об использовании внешних учетных данных в веб-приложении ASP.NET MVC 5 см. в статье [Создание приложения ASP.NET MVC 5 с помощью Facebook и Google OAuth2 и OpenID Connect вход](../security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="f8776-107">To use external credentials in an ASP.NET MVC 5 web application, see [Create an ASP.NET MVC 5 App with Facebook and Google OAuth2 and OpenID Sign-on](../security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
> 
> <span data-ttu-id="f8776-108">Включение этих учетных данных на веб-сайтах обеспечивает значительное преимущество, поскольку миллионы пользователей уже имеют учетные записи с этими внешними поставщиками.</span><span class="sxs-lookup"><span data-stu-id="f8776-108">Enabling these credentials in your web sites provides a significant advantage because millions of users already have accounts with these external providers.</span></span> <span data-ttu-id="f8776-109">Эти пользователи могут быть более наклонными для регистрации на сайте, если им не нужно создавать и запоминать новый набор учетных данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-109">These users may be more inclined to sign up for your site if they do not have to create and remember a new set of credentials.</span></span> <span data-ttu-id="f8776-110">Кроме того, после входа пользователя через одного из этих поставщиков можно включить социальные операции от поставщика.</span><span class="sxs-lookup"><span data-stu-id="f8776-110">Also, after a user has logged in through one of these providers, you can incorporate social operations from the provider.</span></span>

## <a name="what-youll-build"></a><span data-ttu-id="f8776-111">Что будет построено</span><span class="sxs-lookup"><span data-stu-id="f8776-111">What you'll build</span></span>

<span data-ttu-id="f8776-112">В этом учебнике есть две основные цели.</span><span class="sxs-lookup"><span data-stu-id="f8776-112">There are two main goals in this tutorial:</span></span>

1. <span data-ttu-id="f8776-113">Разрешить пользователю выполнять вход с учетными данными из поставщика OAuth.</span><span class="sxs-lookup"><span data-stu-id="f8776-113">Enable a user to log in with credentials from an OAuth provider.</span></span>
2. <span data-ttu-id="f8776-114">Получение сведений об учетной записи от поставщика и их интеграция с регистрацией учетной записи для сайта.</span><span class="sxs-lookup"><span data-stu-id="f8776-114">Retrieve account information from the provider and integrate that information with the account registration for your site.</span></span>

<span data-ttu-id="f8776-115">Хотя в примерах этого учебника основное внимание уделяется использованию Facebook в качестве поставщика проверки подлинности, можно изменить код для использования любого из поставщиков.</span><span class="sxs-lookup"><span data-stu-id="f8776-115">Although the examples in this tutorial focus on using Facebook as the authentication provider, you can modify the code to use any of the providers.</span></span> <span data-ttu-id="f8776-116">Действия по реализации любого поставщика очень похожи на шаги, которые вы увидите в этом учебнике.</span><span class="sxs-lookup"><span data-stu-id="f8776-116">The steps to implement any provider are very similar to the steps you will see in this tutorial.</span></span> <span data-ttu-id="f8776-117">При осуществлении прямых вызовов к набору API поставщика будут заметны только значительные отличия.</span><span class="sxs-lookup"><span data-stu-id="f8776-117">You will only notice significant differences when making direct calls to the provider's API set.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="f8776-118">предварительные требования</span><span class="sxs-lookup"><span data-stu-id="f8776-118">Prerequisites</span></span>

- <span data-ttu-id="f8776-119">[Microsoft Visual Studio 2012](https://www.microsoft.com/visualstudio/eng/downloads#vs) или [Microsoft Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/eng/downloads#d-2012-express)</span><span class="sxs-lookup"><span data-stu-id="f8776-119">[Microsoft Visual Studio 2012](https://www.microsoft.com/visualstudio/eng/downloads#vs) or [Microsoft Visual Studio Express 2012 for Web](https://www.microsoft.com/visualstudio/eng/downloads#d-2012-express)</span></span>

<span data-ttu-id="f8776-120">либо</span><span class="sxs-lookup"><span data-stu-id="f8776-120">Or</span></span>

- <span data-ttu-id="f8776-121">Microsoft Visual Studio 2010 SP1 или [Visual Web Developer Express 2010 SP1](https://www.microsoft.com/visualstudio/eng/downloads#d-2010-express)</span><span class="sxs-lookup"><span data-stu-id="f8776-121">Microsoft Visual Studio 2010 SP1 or [Visual Web Developer Express 2010 SP1](https://www.microsoft.com/visualstudio/eng/downloads#d-2010-express)</span></span>
- [<span data-ttu-id="f8776-122">ASP.NET MVC 4</span><span class="sxs-lookup"><span data-stu-id="f8776-122">ASP.NET MVC 4</span></span>](https://go.microsoft.com/fwlink/?LinkId=243392)

<span data-ttu-id="f8776-123">Кроме того, в этом разделе предполагается, что у вас есть базовые знания о ASP.NET MVC и Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="f8776-123">Furthermore, this topic assumes you have basic knowledge about ASP.NET MVC and Visual Studio.</span></span> <span data-ttu-id="f8776-124">Если вам требуется введение в ASP.NET MVC 4, см. статью введение [в ASP.NET MVC 4](getting-started-with-aspnet-mvc4/intro-to-aspnet-mvc-4.md).</span><span class="sxs-lookup"><span data-stu-id="f8776-124">If you need an introduction to ASP.NET MVC 4, see [Intro to ASP.NET MVC 4](getting-started-with-aspnet-mvc4/intro-to-aspnet-mvc-4.md).</span></span>

## <a name="create-the-project"></a><span data-ttu-id="f8776-125">Создание проекта</span><span class="sxs-lookup"><span data-stu-id="f8776-125">Create the project</span></span>

<span data-ttu-id="f8776-126">В Visual Studio создайте новое веб-приложение ASP.NET MVC 4 и назовите его &quot;Оаусмвк&quot;.</span><span class="sxs-lookup"><span data-stu-id="f8776-126">In Visual Studio, create a new ASP.NET MVC 4 Web Application, and name it &quot;OAuthMVC&quot;.</span></span> <span data-ttu-id="f8776-127">Можно выбрать либо .NET Framework 4,5, либо 4.</span><span class="sxs-lookup"><span data-stu-id="f8776-127">You can target either .NET Framework 4.5 or 4.</span></span>

![создание проекта](using-oauth-providers-with-mvc/_static/image1.png)

<span data-ttu-id="f8776-129">В новом окне проекта ASP.NET MVC 4 выберите **Интернет приложение** и оставьте **Razor** в качестве обработчика представлений.</span><span class="sxs-lookup"><span data-stu-id="f8776-129">In the New ASP.NET MVC 4 Project window, select **Internet Application** and leave **Razor** as the view engine.</span></span>

![выбор Интернет приложения](using-oauth-providers-with-mvc/_static/image2.png)

## <a name="enable-a-provider"></a><span data-ttu-id="f8776-131">Включение поставщика</span><span class="sxs-lookup"><span data-stu-id="f8776-131">Enable a provider</span></span>

<span data-ttu-id="f8776-132">При создании веб-приложения MVC 4 с помощью шаблона приложения Интернета проект создается с файлом с именем AuthConfig.cs в папке App\_Start.</span><span class="sxs-lookup"><span data-stu-id="f8776-132">When you create an MVC 4 web application with the Internet Application template, the project is created with a file named AuthConfig.cs in the App\_Start folder.</span></span>

![Файл Аусконфиг](using-oauth-providers-with-mvc/_static/image3.png)

<span data-ttu-id="f8776-134">Файл Аусконфиг содержит код для регистрации клиентов для внешних поставщиков проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8776-134">The AuthConfig file contains code to register clients for external authentication providers.</span></span> <span data-ttu-id="f8776-135">По умолчанию этот код записывается в комментарий, поэтому внешние поставщики не включаются.</span><span class="sxs-lookup"><span data-stu-id="f8776-135">By default, this code is commented out, so none of the external providers are enabled.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample1.cs)]

<span data-ttu-id="f8776-136">Необходимо раскомментировать этот код, чтобы использовать внешний клиент проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8776-136">You must uncomment this code to use the external authentication client.</span></span> <span data-ttu-id="f8776-137">Вы Раскомментируйте только те поставщики, которые вы хотите включить на сайт.</span><span class="sxs-lookup"><span data-stu-id="f8776-137">You uncomment only the providers you want to include in your site.</span></span> <span data-ttu-id="f8776-138">В этом учебнике будут включены только учетные данные Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-138">For this tutorial, you will only enable the Facebook credentials.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample2.cs)]

<span data-ttu-id="f8776-139">Обратите внимание, что в приведенном выше примере метод содержит пустые строки для параметров регистрации.</span><span class="sxs-lookup"><span data-stu-id="f8776-139">Notice in the above example that the method includes empty strings for the registration parameters.</span></span> <span data-ttu-id="f8776-140">Если вы попытаетесь запустить приложение сейчас, приложение создаст исключение аргумента, так как для параметров не допускаются пустые строки.</span><span class="sxs-lookup"><span data-stu-id="f8776-140">If you try to run the application now, the application throws an argument exception because empty strings are not allowed for the parameters.</span></span> <span data-ttu-id="f8776-141">Чтобы указать допустимые значения, необходимо зарегистрировать веб-сайт с внешними поставщиками, как показано в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="f8776-141">To provide valid values, you must register your web site with the external providers, as shown in the next section.</span></span>

## <a name="registering-with-an-external-provider"></a><span data-ttu-id="f8776-142">Регистрация с помощью внешнего поставщика</span><span class="sxs-lookup"><span data-stu-id="f8776-142">Registering with an external provider</span></span>

<span data-ttu-id="f8776-143">Чтобы проверить подлинность пользователей с помощью учетных данных внешнего поставщика, необходимо зарегистрировать веб-сайт в поставщике.</span><span class="sxs-lookup"><span data-stu-id="f8776-143">To authenticate users with credentials from an external provider, you must register your web site with the provider.</span></span> <span data-ttu-id="f8776-144">При регистрации сайта вы получите параметры (например, ключ или идентификатор и секрет), которые будут включены при регистрации клиента.</span><span class="sxs-lookup"><span data-stu-id="f8776-144">When you register your site, you will receive the parameters (such as key or id, and secret) to include when registering the client.</span></span> <span data-ttu-id="f8776-145">Необходимо иметь учетную запись с поставщиками, которые вы хотите использовать.</span><span class="sxs-lookup"><span data-stu-id="f8776-145">You must have an account with the providers you wish to use.</span></span>

<span data-ttu-id="f8776-146">В этом учебнике не показаны все действия, которые необходимо выполнить для регистрации в этих поставщиках.</span><span class="sxs-lookup"><span data-stu-id="f8776-146">This tutorial does not show all of the steps you must perform to register with these providers.</span></span> <span data-ttu-id="f8776-147">Обычно эти действия не являются сложными.</span><span class="sxs-lookup"><span data-stu-id="f8776-147">The steps are typically not difficult.</span></span> <span data-ttu-id="f8776-148">Для успешной регистрации сайта следуйте инструкциям, приведенным на этих сайтах.</span><span class="sxs-lookup"><span data-stu-id="f8776-148">To successfully register your site, follow the instructions provided on those sites.</span></span> <span data-ttu-id="f8776-149">Чтобы приступить к регистрации сайта, ознакомьтесь с разработкой сайта для разработчиков:</span><span class="sxs-lookup"><span data-stu-id="f8776-149">To get started with registering your site, see the developer site for:</span></span>

- [<span data-ttu-id="f8776-150">Facebook</span><span class="sxs-lookup"><span data-stu-id="f8776-150">Facebook</span></span>](https://developers.facebook.com/)
- [<span data-ttu-id="f8776-151">Google</span><span class="sxs-lookup"><span data-stu-id="f8776-151">Google</span></span>](https://developers.google.com/)
- [<span data-ttu-id="f8776-152">Майкрософт</span><span class="sxs-lookup"><span data-stu-id="f8776-152">Microsoft</span></span>](http://manage.dev.live.com/)
- [<span data-ttu-id="f8776-153">Twitter</span><span class="sxs-lookup"><span data-stu-id="f8776-153">Twitter</span></span>](https://dev.twitter.com/)

<span data-ttu-id="f8776-154">При регистрации сайта в Facebook можно указать &quot;localhost&quot; для домена сайта и `&quot; http://localhost/&quot;` URL-адрес, как показано на рисунке ниже.</span><span class="sxs-lookup"><span data-stu-id="f8776-154">When registering your site with Facebook, you can provide &quot;localhost&quot; for the site domain and `&quot;http://localhost/&quot;` for the URL, as shown in the image below.</span></span> <span data-ttu-id="f8776-155">Использование localhost работает с большинством поставщиков, но в настоящее время не работает с поставщиком Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="f8776-155">Using localhost works with most providers, but currently does not work with the Microsoft provider.</span></span> <span data-ttu-id="f8776-156">Для поставщика услуг Майкрософт необходимо указать допустимый URL-адрес сайта.</span><span class="sxs-lookup"><span data-stu-id="f8776-156">For the Microsoft provider, you must include a valid web site URL.</span></span>

![зарегистрировать сайт](using-oauth-providers-with-mvc/_static/image4.png)

<span data-ttu-id="f8776-158">На предыдущем рисунке были удалены значения идентификатора приложения, секрета приложения и контактного адреса электронной почты.</span><span class="sxs-lookup"><span data-stu-id="f8776-158">In the previous image, the values for the app id, app secret, and contact email have been removed.</span></span> <span data-ttu-id="f8776-159">При фактической регистрации сайта эти значения будут представлены.</span><span class="sxs-lookup"><span data-stu-id="f8776-159">When you actually register your site, those values will be present.</span></span> <span data-ttu-id="f8776-160">Необходимо отметить значения идентификатора приложения и секрета приложения, так как они будут добавлены в приложение.</span><span class="sxs-lookup"><span data-stu-id="f8776-160">You will want to note the values for app id and app secret because you will add them to your application.</span></span>

## <a name="creating-test-users"></a><span data-ttu-id="f8776-161">Создание тестовых пользователей</span><span class="sxs-lookup"><span data-stu-id="f8776-161">Creating test users</span></span>

<span data-ttu-id="f8776-162">Если вы не хотите использовать существующую учетную запись Facebook для тестирования сайта, этот раздел можно пропустить.</span><span class="sxs-lookup"><span data-stu-id="f8776-162">If you do not mind using an existing Facebook account to test your site, you can skip this section.</span></span>

<span data-ttu-id="f8776-163">Вы можете легко создавать тестовых пользователей для приложения на странице управления приложениями Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-163">You can easily create test users for your application within the Facebook app management page.</span></span> <span data-ttu-id="f8776-164">Эти тестовые учетные записи можно использовать для входа на сайт.</span><span class="sxs-lookup"><span data-stu-id="f8776-164">You can use these test accounts to log in to your site.</span></span> <span data-ttu-id="f8776-165">Чтобы создать тестовых пользователей, щелкните ссылку **роли** в левой области навигации и щелкните ссылку **создать** .</span><span class="sxs-lookup"><span data-stu-id="f8776-165">You create test users by clicking the **Roles** link in the left navigation pane and the clicking the **Create** link.</span></span>

![Создание тестовых пользователей](using-oauth-providers-with-mvc/_static/image5.png)

<span data-ttu-id="f8776-167">Сайт Facebook автоматически создает запрошенное количество тестовых учетных записей.</span><span class="sxs-lookup"><span data-stu-id="f8776-167">The Facebook site automatically creates the number of test accounts that you request.</span></span>

## <a name="adding-application-id-and-secret-from-the-provider"></a><span data-ttu-id="f8776-168">Добавление идентификатора приложения и секрета от поставщика</span><span class="sxs-lookup"><span data-stu-id="f8776-168">Adding application id and secret from the provider</span></span>

<span data-ttu-id="f8776-169">Теперь, когда вы получили идентификатор и секрет из Facebook, вернитесь в файл Аусконфиг и добавьте их в качестве значений параметров.</span><span class="sxs-lookup"><span data-stu-id="f8776-169">Now that you have received the id and secret from Facebook, go back to the AuthConfig file and add them as the parameter values.</span></span> <span data-ttu-id="f8776-170">Приведенные ниже значения не являются реальными значениями.</span><span class="sxs-lookup"><span data-stu-id="f8776-170">The values shown below are not real values.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample3.cs)]

## <a name="log-in-with-external-credentials"></a><span data-ttu-id="f8776-171">Вход с использованием внешних учетных данных</span><span class="sxs-lookup"><span data-stu-id="f8776-171">Log in with external credentials</span></span>

<span data-ttu-id="f8776-172">Это все, что необходимо сделать для включения внешних учетных данных на сайте.</span><span class="sxs-lookup"><span data-stu-id="f8776-172">That is all you have to do to enable external credentials in your site.</span></span> <span data-ttu-id="f8776-173">Запустите приложение и щелкните ссылку входа в правом верхнем углу.</span><span class="sxs-lookup"><span data-stu-id="f8776-173">Run your application and click the login link in the upper right corner.</span></span> <span data-ttu-id="f8776-174">Шаблон автоматически определяет, что вы зарегистрировали Facebook в качестве поставщика и включаете кнопку для поставщика.</span><span class="sxs-lookup"><span data-stu-id="f8776-174">The template automatically recognizes that you have registered Facebook as a provider and includes a button for the provider.</span></span> <span data-ttu-id="f8776-175">При регистрации нескольких поставщиков кнопка для каждой из них автоматически включается.</span><span class="sxs-lookup"><span data-stu-id="f8776-175">If you register multiple providers, a button for each one is automatically included.</span></span>

![внешнее имя входа](using-oauth-providers-with-mvc/_static/image6.png)

<span data-ttu-id="f8776-177">В этом учебнике не рассматривается настройка кнопок входа для внешних поставщиков.</span><span class="sxs-lookup"><span data-stu-id="f8776-177">This tutorial does not cover how to customize the log in buttons for the external providers.</span></span> <span data-ttu-id="f8776-178">Дополнительные сведения см. [в разделе Настройка пользовательского интерфейса входа при использовании OAuth/OpenID Connect](https://blogs.msdn.com/b/pranav_rastogi/archive/2012/08/24/customizing-the-login-ui-when-using-oauth-openid.aspx).</span><span class="sxs-lookup"><span data-stu-id="f8776-178">For that information, see [Customizing the login UI when using OAuth/OpenID](https://blogs.msdn.com/b/pranav_rastogi/archive/2012/08/24/customizing-the-login-ui-when-using-oauth-openid.aspx).</span></span>

<span data-ttu-id="f8776-179">Нажмите кнопку Facebook, чтобы войти с использованием учетных данных Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-179">Click on the Facebook button to log in with Facebook credentials.</span></span> <span data-ttu-id="f8776-180">При выборе одного из внешних поставщиков вы перенаправляетесь на этот сайт и запрашиваете эту службу для входа.</span><span class="sxs-lookup"><span data-stu-id="f8776-180">When you select one of the external providers, you are redirected to that site and prompted by that service to log in.</span></span>

<span data-ttu-id="f8776-181">На следующем рисунке показан экран входа для Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-181">The following image shows the login screen for Facebook.</span></span> <span data-ttu-id="f8776-182">Заметка, что вы используете учетную запись Facebook для входа на сайт с именем оаусмвцексампле.</span><span class="sxs-lookup"><span data-stu-id="f8776-182">It notes that you are using your Facebook account to log in to a site named oauthmvcexample.</span></span>

![Проверка подлинности Facebook](using-oauth-providers-with-mvc/_static/image7.png)

<span data-ttu-id="f8776-184">После входа с использованием учетных данных Facebook страница информирует пользователя о том, что сайт будет иметь доступ к основным сведениям.</span><span class="sxs-lookup"><span data-stu-id="f8776-184">After logging in with Facebook credentials, a page informs the user that the site will have access to basic information.</span></span>

![запросить разрешение](using-oauth-providers-with-mvc/_static/image8.png)

<span data-ttu-id="f8776-186">После выбора пункта **Переход к приложению**пользователь должен зарегистрироваться для сайта.</span><span class="sxs-lookup"><span data-stu-id="f8776-186">After selecting **Go to App**, the user must register for the site.</span></span> <span data-ttu-id="f8776-187">На следующем рисунке показана страница регистрации после входа пользователя с учетными данными Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-187">The following image shows the registration page after a user has logged in with Facebook credentials.</span></span> <span data-ttu-id="f8776-188">Имя пользователя обычно заранее заполняется именем поставщика.</span><span class="sxs-lookup"><span data-stu-id="f8776-188">The user name is typically pre-filled with a name from the provider.</span></span>

![регистрация](using-oauth-providers-with-mvc/_static/image9.png)

<span data-ttu-id="f8776-190">Нажмите кнопку **Регистрация** , чтобы завершить регистрацию.</span><span class="sxs-lookup"><span data-stu-id="f8776-190">Click **Register** to complete registration.</span></span> <span data-ttu-id="f8776-191">Закройте браузер.</span><span class="sxs-lookup"><span data-stu-id="f8776-191">Close the browser.</span></span>

<span data-ttu-id="f8776-192">Вы видите, что новая учетная запись добавлена в базу данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-192">You can see that the new account has been added to your database.</span></span> <span data-ttu-id="f8776-193">В обозреватель сервера откройте базу данных **DefaultConnection** и откройте папку **таблицы** .</span><span class="sxs-lookup"><span data-stu-id="f8776-193">In Server Explorer, open the **DefaultConnection** database and open the **Tables** folder.</span></span>

![таблицы баз данных](using-oauth-providers-with-mvc/_static/image10.png)

<span data-ttu-id="f8776-195">Щелкните правой кнопкой мыши таблицу **UserProfile** и выберите команду **отобразить данные таблицы**.</span><span class="sxs-lookup"><span data-stu-id="f8776-195">Right-click the **UserProfile** table and select **Show Table Data**.</span></span>

![Отображение данных](using-oauth-providers-with-mvc/_static/image11.png)

<span data-ttu-id="f8776-197">Вы увидите новую добавленную учетную запись.</span><span class="sxs-lookup"><span data-stu-id="f8776-197">You will see the new account you added.</span></span> <span data-ttu-id="f8776-198">Просмотрите данные на **веб-странице\_таблице оаусмембершип** .</span><span class="sxs-lookup"><span data-stu-id="f8776-198">Look at the data in **webpage\_OAuthMembership** table.</span></span> <span data-ttu-id="f8776-199">Вы увидите больше данных, связанных с внешним поставщиком для только что добавленной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="f8776-199">You will see more data related to the external provider for the account you just added.</span></span>

<span data-ttu-id="f8776-200">Если вы хотите включить только внешнюю проверку подлинности, то все готово.</span><span class="sxs-lookup"><span data-stu-id="f8776-200">If you only want to enable external authentication, you are done.</span></span> <span data-ttu-id="f8776-201">Однако вы можете дополнительно интегрировать информацию из поставщика в новый процесс регистрации пользователей, как показано в следующих разделах.</span><span class="sxs-lookup"><span data-stu-id="f8776-201">However, you can further integrate information from the provider into the new user registration process, as shown in the following sections.</span></span>

## <a name="create-models-for-additional-user-information"></a><span data-ttu-id="f8776-202">Создание моделей для дополнительных сведений о пользователях</span><span class="sxs-lookup"><span data-stu-id="f8776-202">Create models for additional user information</span></span>

<span data-ttu-id="f8776-203">Как вы заметили в предыдущих разделах, вам не нужно получать дополнительные сведения для работы встроенной регистрации учетной записи.</span><span class="sxs-lookup"><span data-stu-id="f8776-203">As you noticed in the previous sections, you do not need to retrieve any additional information for the built-in account registration to work.</span></span> <span data-ttu-id="f8776-204">Однако большинство внешних поставщиков передают дополнительные сведения о пользователе.</span><span class="sxs-lookup"><span data-stu-id="f8776-204">However, most external providers pass back additional information about the user.</span></span> <span data-ttu-id="f8776-205">В следующих разделах показано, как сохранить эти сведения и сохранить их в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-205">The following sections show how to retain that information and save it to a database.</span></span> <span data-ttu-id="f8776-206">В частности, будут сохранены значения для полного имени пользователя, URI личной веб-страницы пользователя и значение, указывающее, проверялась ли учетная запись в Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-206">Specifically, you will retain values for the user's full name, the URI of the user's personal web page, and a value that indicates whether Facebook has verified the account.</span></span>

<span data-ttu-id="f8776-207">Чтобы добавить таблицу для хранения дополнительных сведений о пользователях, используйте [Code First migrations](https://msdn.microsoft.com/data/jj591621) .</span><span class="sxs-lookup"><span data-stu-id="f8776-207">You will use [Code First Migrations](https://msdn.microsoft.com/data/jj591621) to add a table for storing additional user information.</span></span> <span data-ttu-id="f8776-208">Вы добавляете таблицу в существующую базу данных, поэтому сначала необходимо создать моментальный снимок текущей базы данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-208">You are adding the table to an existing database, so you will first need to create a snapshot of the current database.</span></span> <span data-ttu-id="f8776-209">Создав моментальный снимок текущей базы данных, можно позднее создать миграцию, содержащую только новую таблицу.</span><span class="sxs-lookup"><span data-stu-id="f8776-209">By creating a snapshot of the current database, you can later create a migration that contains only the new table.</span></span> <span data-ttu-id="f8776-210">Создание моментального снимка текущей базы данных:</span><span class="sxs-lookup"><span data-stu-id="f8776-210">To create a snapshot of the current database:</span></span>

1. <span data-ttu-id="f8776-211">Открытие **консоли диспетчера пакетов**</span><span class="sxs-lookup"><span data-stu-id="f8776-211">Open the **Package Manager Console**</span></span>
2. <span data-ttu-id="f8776-212">Выполнение команды " **включить и перенести** "</span><span class="sxs-lookup"><span data-stu-id="f8776-212">Run the command **enable-migrations**</span></span>
3. <span data-ttu-id="f8776-213">Выполните команду " **Добавить-перенести" начальный — игноречанжес**</span><span class="sxs-lookup"><span data-stu-id="f8776-213">Run the command **add-migration initial –IgnoreChanges**</span></span>
4. <span data-ttu-id="f8776-214">Выполнение команды **Update — Database**</span><span class="sxs-lookup"><span data-stu-id="f8776-214">Run the command **update-database**</span></span>

<span data-ttu-id="f8776-215">Теперь вы добавите новые свойства.</span><span class="sxs-lookup"><span data-stu-id="f8776-215">Now, you will add the new properties.</span></span> <span data-ttu-id="f8776-216">В папке Models откройте файл AccountModels.cs и найдите класс Регистерекстерналлогинмодел.</span><span class="sxs-lookup"><span data-stu-id="f8776-216">In the Models folder, open the AccountModels.cs file, and find the RegisterExternalLoginModel class.</span></span> <span data-ttu-id="f8776-217">Класс Регистерекстерналлогинмодел содержит значения, возвращенные поставщиком проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8776-217">The RegisterExternalLoginModel class holds values that come back from the authentication provider.</span></span> <span data-ttu-id="f8776-218">Добавьте свойства с именем FullName и Link, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="f8776-218">Add properties named FullName and Link, as highlighted below.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample4.cs?highlight=9-13)]

<span data-ttu-id="f8776-219">Кроме того, в AccountModels.cs добавьте новый класс с именем Екстраусеринформатион.</span><span class="sxs-lookup"><span data-stu-id="f8776-219">Also in AccountModels.cs, add a new class called ExtraUserInformation.</span></span> <span data-ttu-id="f8776-220">Этот класс представляет новую таблицу, которая будет создана в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-220">This class represents the new table which will be created in the database.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample5.cs)]

<span data-ttu-id="f8776-221">В классе Усерсконтекст Добавьте выделенный ниже код, чтобы создать свойство DbSet для нового класса.</span><span class="sxs-lookup"><span data-stu-id="f8776-221">In the UsersContext class, add the highlighted code below to create a DbSet property for the new class.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample6.cs?highlight=9)]

<span data-ttu-id="f8776-222">Теперь все готово для создания новой таблицы.</span><span class="sxs-lookup"><span data-stu-id="f8776-222">You are now ready to create the new table.</span></span> <span data-ttu-id="f8776-223">Снова откройте консоль диспетчера пакетов и на этот раз:</span><span class="sxs-lookup"><span data-stu-id="f8776-223">Open the Package Manager Console again and this time:</span></span>

1. <span data-ttu-id="f8776-224">Выполните команду **Add-Migration аддекстраусеринформатион**</span><span class="sxs-lookup"><span data-stu-id="f8776-224">Run the command **add-migration AddExtraUserInformation**</span></span>
2. <span data-ttu-id="f8776-225">Выполнение команды **Update — Database**</span><span class="sxs-lookup"><span data-stu-id="f8776-225">Run the command **update-database**</span></span>

<span data-ttu-id="f8776-226">Новая таблица теперь существует в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-226">The new table now exists in the database.</span></span>

## <a name="retrieve-the-additional-data"></a><span data-ttu-id="f8776-227">Получение дополнительных данных</span><span class="sxs-lookup"><span data-stu-id="f8776-227">Retrieve the additional data</span></span>

<span data-ttu-id="f8776-228">Получить дополнительные данные пользователя можно двумя способами.</span><span class="sxs-lookup"><span data-stu-id="f8776-228">There are two ways to retrieve additional user data.</span></span> <span data-ttu-id="f8776-229">Первый способ — хранить пользовательские данные, которые по умолчанию передаются обратно во время запроса проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8776-229">The first way is to retain user data that is passed back, by default, during the authentication request.</span></span> <span data-ttu-id="f8776-230">Второй способ заключается в специальном вызове API поставщика и запросе дополнительных сведений.</span><span class="sxs-lookup"><span data-stu-id="f8776-230">The second way is to specifically call the provider API and request more information.</span></span> <span data-ttu-id="f8776-231">Значения FullName и LINK автоматически передаются обратно Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-231">Values for FullName and Link are automatically passed back by Facebook.</span></span> <span data-ttu-id="f8776-232">Значение, указывающее, проверялась ли учетная запись Facebook при вызове API Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-232">A value that indicates whether Facebook has verified the account is retrieved through a call to the Facebook API.</span></span> <span data-ttu-id="f8776-233">Сначала вы заполните значения FullName и Link, а затем получите проверенное значение.</span><span class="sxs-lookup"><span data-stu-id="f8776-233">First, you will populate values for FullName and Link, and then later, you will get the verified value.</span></span>

<span data-ttu-id="f8776-234">Чтобы получить дополнительные данные пользователя, откройте файл **AccountController.CS** в папке **Controllers** .</span><span class="sxs-lookup"><span data-stu-id="f8776-234">To retrieve the additional user data, open the **AccountController.cs** file in the **Controllers** folder.</span></span>

<span data-ttu-id="f8776-235">Этот файл содержит логику для ведения журнала, регистрации и управления учетными записями.</span><span class="sxs-lookup"><span data-stu-id="f8776-235">This file contains the logic for logging, registering, and managing accounts.</span></span> <span data-ttu-id="f8776-236">В частности, обратите внимание на методы с именами **екстерналлогинкаллбакк** и **ExternalLoginConfirmation**.</span><span class="sxs-lookup"><span data-stu-id="f8776-236">In particular, notice the methods called **ExternalLoginCallback** and **ExternalLoginConfirmation**.</span></span> <span data-ttu-id="f8776-237">В этих методах можно добавить код для настройки операций внешнего входа в приложение.</span><span class="sxs-lookup"><span data-stu-id="f8776-237">Within these methods, you can add code to customize external login operations for your application.</span></span> <span data-ttu-id="f8776-238">Первая строка метода **екстерналлогинкаллбакк** содержит:</span><span class="sxs-lookup"><span data-stu-id="f8776-238">The first line of the **ExternalLoginCallback** method contains:</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample7.cs)]

<span data-ttu-id="f8776-239">Дополнительные пользовательские данные передаются обратно в свойство **екстрадата** объекта **AuthenticationResult** , возвращаемого методом **верифяусентикатион** .</span><span class="sxs-lookup"><span data-stu-id="f8776-239">Additional user data is passed back in the **ExtraData** property of the **AuthenticationResult** object that is returned from the **VerifyAuthentication** method.</span></span> <span data-ttu-id="f8776-240">Клиент Facebook содержит следующие значения в свойстве **екстрадата** :</span><span class="sxs-lookup"><span data-stu-id="f8776-240">The Facebook client contains the following values in the **ExtraData** property:</span></span>

- <span data-ttu-id="f8776-241">идентификатор</span><span class="sxs-lookup"><span data-stu-id="f8776-241">id</span></span>
- <span data-ttu-id="f8776-242">name</span><span class="sxs-lookup"><span data-stu-id="f8776-242">name</span></span>
- <span data-ttu-id="f8776-243">link</span><span class="sxs-lookup"><span data-stu-id="f8776-243">link</span></span>
- <span data-ttu-id="f8776-244">gender</span><span class="sxs-lookup"><span data-stu-id="f8776-244">gender</span></span>
- <span data-ttu-id="f8776-245">accesstoken</span><span class="sxs-lookup"><span data-stu-id="f8776-245">accesstoken</span></span>

<span data-ttu-id="f8776-246">Другие поставщики будут иметь похожие, но слегка отличающиеся данные в свойстве Екстрадата.</span><span class="sxs-lookup"><span data-stu-id="f8776-246">Other providers will have similar but slightly different data in the ExtraData property.</span></span>

<span data-ttu-id="f8776-247">Если пользователь является новым для вашего сайта, вы получите некоторые дополнительные данные и передайте их в представление подтверждения.</span><span class="sxs-lookup"><span data-stu-id="f8776-247">If the user is new to your site, you will retrieve some the additional data and pass that data to the confirmation view.</span></span> <span data-ttu-id="f8776-248">Последний блок кода в методе выполняется только в том случае, если пользователь является новым для вашего сайта.</span><span class="sxs-lookup"><span data-stu-id="f8776-248">The last block of code in the method is run only if the user is new to your site.</span></span> <span data-ttu-id="f8776-249">Замените следующую строку:</span><span class="sxs-lookup"><span data-stu-id="f8776-249">Replace the following line:</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample8.cs)]

<span data-ttu-id="f8776-250">Вставьте вместо нее эту строку:</span><span class="sxs-lookup"><span data-stu-id="f8776-250">With this line:</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample9.cs)]

<span data-ttu-id="f8776-251">Это изменение просто включает значения свойств FullName и Link.</span><span class="sxs-lookup"><span data-stu-id="f8776-251">This change merely includes values for the FullName and Link properties.</span></span>

<span data-ttu-id="f8776-252">В методе **ExternalLoginConfirmation** измените код, выделенный ниже, чтобы сохранить дополнительные сведения о пользователе.</span><span class="sxs-lookup"><span data-stu-id="f8776-252">In the **ExternalLoginConfirmation** method, modify the code as highlighted below to save the additional user information.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample10.cs?highlight=4,7-13)]

## <a name="adjusting-the-view"></a><span data-ttu-id="f8776-253">Настройка представления</span><span class="sxs-lookup"><span data-stu-id="f8776-253">Adjusting the view</span></span>

<span data-ttu-id="f8776-254">Дополнительные данные пользователя, получаемые от поставщика, будут отображаться на странице регистрации.</span><span class="sxs-lookup"><span data-stu-id="f8776-254">The additional user data that you retrieve from the provider will be displayed in the registration page.</span></span>

<span data-ttu-id="f8776-255">В папке **views**/**Account** (представления) откройте **ExternalLoginConfirmation. cshtml**.</span><span class="sxs-lookup"><span data-stu-id="f8776-255">In the **Views**/**Account** folder, open **ExternalLoginConfirmation.cshtml**.</span></span> <span data-ttu-id="f8776-256">Под существующим полем Имя пользователя добавьте поля для FullName, Link и Пиктурелинк.</span><span class="sxs-lookup"><span data-stu-id="f8776-256">Below the existing field for user name, add fields for FullName, Link, and PictureLink.</span></span>

[!code-cshtml[Main](using-oauth-providers-with-mvc/samples/sample11.cshtml)]

<span data-ttu-id="f8776-257">Теперь все готово для запуска приложения и регистрации нового пользователя с сохранением дополнительной информации.</span><span class="sxs-lookup"><span data-stu-id="f8776-257">You are now almost ready to run the application and register a new user with the additional information saved.</span></span> <span data-ttu-id="f8776-258">Необходимо иметь учетную запись, которая еще не зарегистрирована на сайте.</span><span class="sxs-lookup"><span data-stu-id="f8776-258">You must have an account that is not already registered with the site.</span></span> <span data-ttu-id="f8776-259">Можно использовать другую тестовую учетную запись или удалить строки в **UserProfile** и **веб-страницах\_оаусмембершип** таблицы для учетной записи, которую вы хотите повторно использовать.</span><span class="sxs-lookup"><span data-stu-id="f8776-259">You can either use a different test account, or delete the rows in the **UserProfile** and **webpages\_OAuthMembership** tables for the account you wish to reuse.</span></span> <span data-ttu-id="f8776-260">Удаляя эти строки, вы гарантируете, что учетная запись снова будет зарегистрирована.</span><span class="sxs-lookup"><span data-stu-id="f8776-260">By deleting those rows, you will ensure that the account is registered again.</span></span>

<span data-ttu-id="f8776-261">Запустите приложение и зарегистрируйте нового пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8776-261">Run the application and register the new user.</span></span> <span data-ttu-id="f8776-262">Обратите внимание, что на этот раз страница подтверждения содержит больше значений.</span><span class="sxs-lookup"><span data-stu-id="f8776-262">Notice that this time the confirmation page contains more values.</span></span>

![регистрация](using-oauth-providers-with-mvc/_static/image12.png)

<span data-ttu-id="f8776-264">После завершения регистрации закройте браузер.</span><span class="sxs-lookup"><span data-stu-id="f8776-264">After completing registration, close the browser.</span></span> <span data-ttu-id="f8776-265">Просмотрите базу данных, чтобы увидеть новые значения в таблице **екстраусеринформатион** .</span><span class="sxs-lookup"><span data-stu-id="f8776-265">Look in the database to notice the new values in the **ExtraUserInformation** table.</span></span>

## <a name="install-nuget-package-for-facebook-api"></a><span data-ttu-id="f8776-266">Установка пакета NuGet для API Facebook</span><span class="sxs-lookup"><span data-stu-id="f8776-266">Install NuGet package for Facebook API</span></span>

<span data-ttu-id="f8776-267">Facebook предоставляет [API](https://developers.facebook.com/docs/reference/apis/) , который можно вызывать для выполнения операций.</span><span class="sxs-lookup"><span data-stu-id="f8776-267">Facebook provides an [API](https://developers.facebook.com/docs/reference/apis/) that you can call to perform operations.</span></span> <span data-ttu-id="f8776-268">Вы можете вызвать API Facebook либо путем направления отправки HTTP-запросов, либо путем установки пакета NuGet, который упрощает отправку этих запросов.</span><span class="sxs-lookup"><span data-stu-id="f8776-268">You can call the Facebook API either by directing sending HTTP requests, or by using installing a NuGet package that facilitates sending those requests.</span></span> <span data-ttu-id="f8776-269">В этом руководстве показано использование пакета NuGet, но установка пакета NuGet не является обязательной.</span><span class="sxs-lookup"><span data-stu-id="f8776-269">Using a NuGet package is shown in this tutorial, but installing NuGet package is not essential.</span></span> <span data-ttu-id="f8776-270">В этом руководстве показано, как использовать пакет C# SDK для Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-270">This tutorial shows how to use the Facebook C# SDK package.</span></span> <span data-ttu-id="f8776-271">Существуют другие пакеты NuGet, помогающие при вызове API Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-271">There are other NuGet packages that assist with calling the Facebook API.</span></span>

<span data-ttu-id="f8776-272">В окнах **Управление пакетами NuGet** выберите пакет SDK C# для Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-272">From the **Manage NuGet Packages** windows, select the Facebook C# SDK package.</span></span>

![установить пакет](using-oauth-providers-with-mvc/_static/image13.png)

<span data-ttu-id="f8776-274">Пакет SDK для Facebook C# будет использоваться для вызова операции, для которой требуется маркер доступа пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8776-274">You will use the Facebook C# SDK to call an operation that requires the access token for the user.</span></span> <span data-ttu-id="f8776-275">В следующем разделе показано, как получить маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="f8776-275">The next section shows how to get the access token.</span></span>

## <a name="retrieve-access-token"></a><span data-ttu-id="f8776-276">Получить маркер доступа</span><span class="sxs-lookup"><span data-stu-id="f8776-276">Retrieve access token</span></span>

<span data-ttu-id="f8776-277">Большинство внешних поставщиков передают маркер доступа после проверки учетных данных пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8776-277">Most external providers pass back an access token after the user's credentials are verified.</span></span> <span data-ttu-id="f8776-278">Этот маркер доступа очень важен, так как он позволяет вызывать операции, доступные только для пользователей, прошедших проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8776-278">This access token is very important because it enables you to call operations that are only available to authenticated users.</span></span> <span data-ttu-id="f8776-279">Поэтому получение и хранение маркера доступа очень важно, если требуется предоставить больше функциональных возможностей.</span><span class="sxs-lookup"><span data-stu-id="f8776-279">Therefore, retrieving and storing the access token is essential when you want to provide more functionality.</span></span>

<span data-ttu-id="f8776-280">В зависимости от внешнего поставщика маркер доступа может быть допустимым только в течение ограниченного периода времени.</span><span class="sxs-lookup"><span data-stu-id="f8776-280">Depending on the external provider, the access token may be valid for only a limited amount of time.</span></span> <span data-ttu-id="f8776-281">Чтобы обеспечить наличие допустимого маркера доступа, он будет извлекаться каждый раз при входе пользователя в систему и хранить его как значение сеанса, а не сохранять в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-281">To ensure that you have a valid access token, you will retrieve it each time the user logs in, and store it as a session value rather than save it to a database.</span></span>

<span data-ttu-id="f8776-282">В методе **екстерналлогинкаллбакк** маркер доступа также передается обратно в свойство **екстрадата** объекта **AuthenticationResult** .</span><span class="sxs-lookup"><span data-stu-id="f8776-282">In the **ExternalLoginCallback** method, the access token is also passed back in the **ExtraData** property of the **AuthenticationResult** object.</span></span> <span data-ttu-id="f8776-283">Добавьте выделенный код в **екстерналлогинкаллбакк** , чтобы сохранить маркер доступа в объекте **Session** .</span><span class="sxs-lookup"><span data-stu-id="f8776-283">Add the highlighted code to **ExternalLoginCallback** to save the access token in the **Session** object.</span></span> <span data-ttu-id="f8776-284">Этот код выполняется каждый раз, когда пользователь входит в систему с учетной записью Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-284">This code is run every time the user logs in with a Facebook account.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample12.cs?highlight=11-14)]

<span data-ttu-id="f8776-285">Хотя этот пример извлекает маркер доступа из Facebook, можно получить маркер доступа от любого внешнего поставщика с помощью того же ключа с именем &quot;accesstoken&quot;.</span><span class="sxs-lookup"><span data-stu-id="f8776-285">Although this example retrieves an access token from Facebook, you can retrieve the access token from any external provider through the same key named &quot;accesstoken&quot;.</span></span>

## <a name="logging-off"></a><span data-ttu-id="f8776-286">выход из системы;</span><span class="sxs-lookup"><span data-stu-id="f8776-286">Logging off</span></span>

<span data-ttu-id="f8776-287">Метод **выхода из системы** по умолчанию записывает пользователя в приложение, но не выполнит выход пользователя из внешнего поставщика.</span><span class="sxs-lookup"><span data-stu-id="f8776-287">The default **LogOff** method logs the user out of your application, but does not log the user out of the external provider.</span></span> <span data-ttu-id="f8776-288">Для выхода пользователя из Facebook и предотвращения сохранения маркера после выхода пользователя из системы можно добавить следующий выделенный код в метод **logoff** в AccountController.</span><span class="sxs-lookup"><span data-stu-id="f8776-288">To log the user out of Facebook, and prevent the token from persisting after the user has logged off, you can add the following highlighted code to the **LogOff** method in the AccountController.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample13.cs?highlight=6-14)]

<span data-ttu-id="f8776-289">Значение, которое вы задаете в параметре `next`, является URL-адресом, который будет использоваться после выхода пользователя из Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-289">The value you provide in the `next` parameter is the URL to use after the user has logged out of Facebook.</span></span> <span data-ttu-id="f8776-290">При тестировании на локальном компьютере необходимо указать правильный номер порта для локального сайта.</span><span class="sxs-lookup"><span data-stu-id="f8776-290">When testing on your local computer, you would provide the correct port number for your local site.</span></span> <span data-ttu-id="f8776-291">В рабочей среде можно указать страницу по умолчанию, например contoso.com.</span><span class="sxs-lookup"><span data-stu-id="f8776-291">In production, you would provide a default page, such as contoso.com.</span></span>

## <a name="retrieve-user-information-that-requires-the-access-token"></a><span data-ttu-id="f8776-292">Получение сведений о пользователе, требующем маркера доступа</span><span class="sxs-lookup"><span data-stu-id="f8776-292">Retrieve user information that requires the access token</span></span>

<span data-ttu-id="f8776-293">Теперь, когда вы сохранили маркер доступа и установили пакет C# SDK для Facebook, вы можете использовать их вместе для запроса дополнительных сведений о пользователях из Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-293">Now that you have stored the access token and installed the Facebook C# SDK package, you can use them together to request additional user information from Facebook.</span></span> <span data-ttu-id="f8776-294">В методе **ExternalLoginConfirmation** создайте экземпляр класса **фацебукклиент** , передав значение маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="f8776-294">In the **ExternalLoginConfirmation** method, create an instance of the **FacebookClient** class by passing the value of the access token.</span></span> <span data-ttu-id="f8776-295">Запросите значение **проверенного** свойства для текущего пользователя, прошедшего проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="f8776-295">Request the value of the **verified** property for the current, authenticated user.</span></span> <span data-ttu-id="f8776-296">Свойство " **Проверено** " указывает, проверила ли учетная запись Facebook с помощью других средств, таких как отправка сообщения на сотовый телефон.</span><span class="sxs-lookup"><span data-stu-id="f8776-296">The **verified** property indicates whether Facebook has validated the account through some other means, such as sending a message to a cell phone.</span></span> <span data-ttu-id="f8776-297">Сохраните это значение в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-297">Save this value in the database.</span></span>

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample14.cs?highlight=7-18,25)]

<span data-ttu-id="f8776-298">Потребуется либо удалить записи в базе данных для пользователя, либо использовать другую учетную запись Facebook.</span><span class="sxs-lookup"><span data-stu-id="f8776-298">You will again need to either delete the records in the database for the user, or use a different Facebook account.</span></span>

<span data-ttu-id="f8776-299">Запустите приложение и зарегистрируйте нового пользователя.</span><span class="sxs-lookup"><span data-stu-id="f8776-299">Run the application, and register the new user.</span></span> <span data-ttu-id="f8776-300">Просмотрите таблицу **екстраусеринформатион** , чтобы увидеть значение для проверенного свойства.</span><span class="sxs-lookup"><span data-stu-id="f8776-300">Look at the **ExtraUserInformation** table to see the value for the Verified property.</span></span>

## <a name="conclusion"></a><span data-ttu-id="f8776-301">Заключение</span><span class="sxs-lookup"><span data-stu-id="f8776-301">Conclusion</span></span>

<span data-ttu-id="f8776-302">В этом руководстве вы создали сайт, интегрированный с Facebook для проверки подлинности пользователей и регистрации данных.</span><span class="sxs-lookup"><span data-stu-id="f8776-302">In this tutorial, you created a site that is integrated with Facebook for user authentication and registration data.</span></span> <span data-ttu-id="f8776-303">Вы узнали о поведении по умолчанию, которое настроено для веб-приложения MVC 4, и о том, как настроить это поведение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="f8776-303">You learned about the default behavior that is set up for MVC 4 web application, and how to customize that default behavior.</span></span>

## <a name="related-topics"></a><span data-ttu-id="f8776-304">Связанные разделы</span><span class="sxs-lookup"><span data-stu-id="f8776-304">Related topics</span></span>

- [<span data-ttu-id="f8776-305">Создание приложения ASP.NET MVC с аутентификацией и базой данных SQL и его развертывание в службе приложений Azure</span><span class="sxs-lookup"><span data-stu-id="f8776-305">Create an ASP.NET MVC app with auth and SQL DB and deploy to Azure App Service</span></span>](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data)
