---
uid: mvc/overview/older-versions-1/nerddinner/use-ajax-to-implement-mapping-scenarios
title: Использование AJAX для реализации сценариев сопоставления | Документация Майкрософт
author: rick-anderson
description: На шаге 11 показано, как интегрировать поддержку сопоставления AJAX в приложение NerdDinner, что позволяет пользователям, создающим, редактирующих или просматривающим диннерс, видеть l...
ms.author: riande
ms.date: 07/27/2010
ms.assetid: f731990a-0a81-4d62-81df-87d676cdedd6
msc.legacyurl: /mvc/overview/older-versions-1/nerddinner/use-ajax-to-implement-mapping-scenarios
msc.type: authoredcontent
ms.openlocfilehash: 03b3a27d4b761d0417160b95cc6f39a345385065
ms.sourcegitcommit: 4e6d586faadbe4d9ef27122f86335ec9385134af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2020
ms.locfileid: "89044328"
---
# <a name="use-ajax-to-implement-mapping-scenarios"></a>Использование AJAX для реализации сценариев сопоставления

по [Майкрософт](https://github.com/microsoft)

[Загрузить PDF-файл](http://aspnetmvcbook.s3.amazonaws.com/aspnetmvc-nerdinner_v1.pdf)

> Это шаг 11 из бесплатного [учебника по NerdDinner приложению](introducing-the-nerddinner-tutorial.md) , в котором рассматривается создание небольшого, но полного веб-приложения с использованием ASP.NET MVC 1.
> 
> На шаге 11 показано, как интегрировать поддержку сопоставления AJAX в приложение NerdDinner, чтобы пользователи, создающие, редактирующие или просматривающие диннерс, могли увидеть расположение компании Dinner Graphic.
> 
> Если вы используете ASP.NET MVC 3, мы рекомендуем следовать руководствам по [Начало работы в MVC 3 или в приложении для](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) [музыкального магазина MVC](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) .

## <a name="nerddinner-step-11-integrating-an-ajax-map"></a>NerdDinner шаг 11. Интеграция схемы AJAX

Теперь мы сделаем наше приложение более привлекательным, интегрируя поддержку сопоставления AJAX. Это позволит пользователям, создающим, редактирующих или просматривающим диннерс, просматривать расположение компании Dinner Graphic.

### <a name="creating-a-map-partial-view"></a>Создание частичного представления карт

Мы будем использовать функции сопоставления в нескольких местах нашего приложения. Для сохранения нашего кода мы будем инкапсулировать общую функциональность карт в пределах одного частичного шаблона, который можно использовать в нескольких действиях и представлениях контроллера. Мы назовем это частичное представление "Map. ascx" и создадим его в каталоге \Виевс\диннерс.

Можно создать частичный объект Map. ascx, щелкнув правой кнопкой мыши каталог \Виевс\диннерс и выбрав команду меню добавить- &gt; Просмотреть. Мы назовем представление "Map. ascx", выберем его как частичное представление и указали, что мы передаем его строго типизированный класс модели "ужин":

![](use-ajax-to-implement-mapping-scenarios/_static/image1.png)

При нажатии кнопки "Добавить" будет создан частичный шаблон. Затем вы обновите файл Map. ascx, чтобы он имел следующее содержимое:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample1.aspx)]

Первая &lt; ссылка на скрипт &gt; указывает на библиотеку сопоставления Microsoft Virtual Earth 6,2. Вторая &lt; ссылка на скрипт &gt; указывает на файл map.js, который вскоре будет создан, который будет инкапсулировать общую логику сопоставления JavaScript. &lt;Элемент div ID = "семап" &gt; — это контейнер HTML, который Virtual Earth будет использовать для размещения схемы.

Затем у нас есть встроенный &lt; &gt; Блок script, который содержит две функции JavaScript, характерные для этого представления. Первая функция использует jQuery для подключения функции, которая выполняется, когда страница готова к запуску клиентского скрипта. Он вызывает вспомогательную функцию Лоадмап (), которую мы определим в нашем файле скрипта Map.js, чтобы загрузить элемент управления картой Virtual Earth. Вторая функция — это обработчик событий обратного вызова, который добавляет в карту ПИН-код, определяющий расположение.

Обратите внимание, что мы используем &lt; блок% =% на стороне &gt; клиента в блоке клиентского сценария для внедрения широты и долготы компании Dinner, которую мы хотим сопоставлять в JavaScript. Это полезный метод для вывода динамических значений, которые могут использоваться сценарием на стороне клиента (без необходимости обратного вызова AJAX на сервер для получения значений, что делает его более быстрым). &lt;Блоки% =% &gt; будут выполняться при отрисовке представления на сервере, поэтому выходные данные HTML будут иметь встроенные значения JavaScript (например, var широта = 47,64312;).

### <a name="creating-a-mapjs-utility-library"></a>Создание библиотеки служебной программы Map.js

Теперь создадим файл Map.js, который мы можем использовать для инкапсуляции функций JavaScript для нашего Map (и реализации методов Лоадмап и Лоадпин выше). Это можно сделать, щелкнув правой кнопкой мыши каталог \Scripts в нашем проекте, а затем выбрав &gt; команду меню "добавить новый элемент", выбрав элемент JScript и назовите его "Map.js".

Ниже приведен код JavaScript, который мы добавим в файл Map.js, который будет взаимодействовать с Virtual Earth, чтобы отобразить наши контакты Map и Add Locations to the диннерс:

[!code-javascript[Main](use-ajax-to-implement-mapping-scenarios/samples/sample2.js)]

### <a name="integrating-the-map-with-create-and-edit-forms"></a>Интеграция схемы с формами создания и редактирования

Теперь мы будем интегрировать поддержку карт с существующими сценариями создания и редактирования. Хорошая новость состоит в том, что это довольно просто и не требует от нас изменения какого-либо кода контроллера. Так как наши представления Create и Edit совместно используют общее частичное представление "Диннерформ" для реализации пользовательского интерфейса компании dinnered, мы можем добавить карту в одном месте и использовать их в обоих сценариях создания и редактирования.

Все, что нам нужно, — это открыть частичное представление \Виевс\диннерс\диннерформ.асккс и обновить его, чтобы включить новую карту частично. Ниже показано, как будет выглядеть обновленный Диннерформ после добавления схемы (Примечание. элементы формы HTML опущены в следующем фрагменте кода для краткости):

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample3.aspx)]

Часть Диннерформ, приведенная выше, принимает объект типа "Диннерформвиевмодел" в качестве типа модели (поскольку для этого требуется как объект ужин, так и SelectList для заполнения DropDownList в странах). Для нашей неразделяемой карте требуется объект типа "ужин" в качестве типа модели, поэтому когда мы подготавливаем частичную карту, мы передаем ему только подсвойства компании Диннерформвиевмодел:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample4.aspx)]

Функция JavaScript, добавленная к частично, использует jQuery для присоединения события размытия к текстовому полю HTML Address. Вы, вероятно, слышали о событиях фокусировки, возникающих при нажатии пользователем или табуляции в текстовое поле. Противоположным является событие «размытие», возникающее при выходе пользователя из текстового поля. Приведенный выше обработчик событий очищает значения поля широты и долготы, когда это происходит, а затем отображает новое расположение адреса на карте. Обработчик событий обратного вызова, который мы определили в файле map.js, обновит поля долготы и широты в нашей форме, используя значения, возвращаемые Virtual Earth на основе адреса, который мы ему присвоили.

Теперь, когда мы снова запустим приложение и щелкните вкладку "узел компании", вы увидите карту по умолчанию, которая отображается вместе со стандартными элементами в форме Dinnered Form:

![](use-ajax-to-implement-mapping-scenarios/_static/image2.png)

При вводе адреса и последующем нажатии клавиши TAB таблица будет динамически обновляться для отображения расположения, а наш обработчик событий будет заполнять текстовые поля широты и долготы значениями расположения:

![](use-ajax-to-implement-mapping-scenarios/_static/image3.png)

Если мы сохраняем новый ужин, а затем снова откроем его для редактирования, мы найдем, что расположение на карте отображается при загрузке страницы:

![](use-ajax-to-implement-mapping-scenarios/_static/image4.png)

При каждом изменении поля адреса будет обновлена схема и координаты широты и долготы.

Теперь, когда на карте отображается место для обедов, можно также изменить поля формы широты и долготы из видимых текстовых полей, чтобы они были скрытыми (так как на карте автоматически обновляются при каждом входе в адрес). Для этого мы перейдем к использованию вспомогательного метода HTML HTML. TextBox () HTML для работы с вспомогательным методом в формате HTML ().

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample5.aspx)]

И теперь наши формы немного удобны для пользователей и не отображают необработанную широту и долготу (сохраняя их вместе с каждым обедом в базе данных):

![](use-ajax-to-implement-mapping-scenarios/_static/image5.png)

### <a name="integrating-the-map-with-the-details-view"></a>Интеграция схемы с подробным представлением

Теперь, когда у нас есть схема, интегрированная с нашими сценариями создания и редактирования, давайте также выполним ее интеграцию с нашим подробным сценарием. Нам нужно только вызвать &lt; % HTML. рендерпартиал ("Map");% &gt; в представлении Details.

Ниже приведен исходный код для полного представления подробных сведений (с интеграцией карт).

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample6.aspx)]

Теперь, когда пользователь переходит по URL-адресу/диннерс/детаилс/[ID], он увидит сведения о обеде, расположении обеда на карте (с помощью push-уведомления, которое при наведении указателя мыши выводит название компании и ее адрес), а также имеет ссылку AJAX на RSVP:

![](use-ajax-to-implement-mapping-scenarios/_static/image6.png)

### <a name="implementing-location-search-in-our-database-and-repository"></a>Реализация поиска местоположения в нашей базе данных и репозитории

Чтобы завершить реализацию AJAX, добавим карту на домашнюю страницу приложения, которая позволит пользователям графически искать диннерс рядом с ними.

![](use-ajax-to-implement-mapping-scenarios/_static/image7.png)

Мы начнем с реализации поддержки в базе данных и слое репозитория данных для эффективного выполнения поиска RADIUS на основе расположения для диннерс. Мы могли бы использовать новые [геопространственные функции sql 2008](https://www.microsoft.com/sqlserver/2008/en/us/spatial-data.aspx) для реализации этого, или же мы можем использовать функцию SQL, Гари дриден, обсуждаемую в статье здесь: [http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx](http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx) и Вадим-конус, посвященный использованию с LINQ to SQL здесь: [http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/](http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/)

Чтобы реализовать этот метод, откройте "обозреватель сервера" в Visual Studio, выберите базу данных NerdDinner, а затем щелкните правой кнопкой мыши вложенный узел "функции" под ним и выберите создать новую "скалярную функцию":

![](use-ajax-to-implement-mapping-scenarios/_static/image8.png)

Затем будет вставлена следующая функция Дистанцебетвин:

[!code-sql[Main](use-ajax-to-implement-mapping-scenarios/samples/sample7.sql)]

Затем мы создадим новую возвращающую табличное значение функцию в SQL Server, которая будет называться "Неарестдиннерс":

![](use-ajax-to-implement-mapping-scenarios/_static/image9.png)

Эта функция таблицы "Неарестдиннерс" использует вспомогательную функцию Дистанцебетвин для возвращения всех диннерс в пределах 100 километров от широты и долготы, которую мы предоставляем:

[!code-sql[Main](use-ajax-to-implement-mapping-scenarios/samples/sample8.sql)]

Чтобы вызвать эту функцию, сначала откройте конструктор LINQ to SQL, дважды щелкнув файл NerdDinner. dbml в нашем каталоге \Моделс:

![](use-ajax-to-implement-mapping-scenarios/_static/image10.png)

Затем мы перетаскивайте функции Неарестдиннерс и Дистанцебетвин в конструктор LINQ to SQL, который приведет к их добавлению в качестве методов в наш LINQ to SQL класс Нерддиннердатаконтекст:

![](use-ajax-to-implement-mapping-scenarios/_static/image11.png)

Затем мы можем предоставить метод запроса "Финдбилокатион" в нашем классе Диннеррепоситори, который использует функцию Неарестдиннер для возврата предстоящих диннерс, которые находятся в пределах 100 миль в указанном расположении:

[!code-csharp[Main](use-ajax-to-implement-mapping-scenarios/samples/sample9.cs)]

### <a name="implementing-a-json-based-ajax-search-action-method"></a>Реализация метода действия поиска AJAX на основе JSON

Теперь мы реализуем метод действия контроллера, который использует преимущества нового метода репозитория Финдбилокатион () для возврата списка данных о ужинах, которые можно использовать для заполнения карт. Этот метод действия возвращает данные о обедах в формате JSON (нотация объектов JavaScript), чтобы его можно было легко манипулировать с помощью JavaScript на клиенте.

Чтобы реализовать это, мы создадим новый класс "Сеарчконтроллер", щелкнув правой кнопкой мыши каталог \Controllers и выбрав &gt; команду меню Добавить контроллер. Затем мы реализуем метод действия "Сеарчбилокатион" в новом классе Сеарчконтроллер, как показано ниже:

[!code-csharp[Main](use-ajax-to-implement-mapping-scenarios/samples/sample10.cs)]

Метод действия Сеарчбилокатион Сеарчконтроллер внутренне вызывает метод Финдбилокатион для Диннеррепоситори, чтобы получить список ближайших диннерс. Однако вместо того, чтобы возвращать объекты компании непосредственно клиенту, он вместо этого возвращает объекты Жсондиннер. Класс Жсондиннер предоставляет подмножество свойств ужина (например, в целях безопасности он не раскрывает имена пользователей, имеющих RSVP для обедов). Он также включает свойство Рсвпкаунт, которое не существует в ужине и которое динамически вычисляется путем подсчета количества объектов RSVP, связанных с конкретным обедом.

Затем мы используем вспомогательный метод JSON () в базовом классе контроллера, чтобы получить последовательность диннерс, используя формат на основе JSON. JSON — это стандартный текстовый формат для представления простых структур данных. Ниже приведен пример того, как выглядит список из двух объектов Жсондиннер в формате JSON при возврате из метода действия:

[!code-json[Main](use-ajax-to-implement-mapping-scenarios/samples/sample11.txt)]

### <a name="calling-the-json-based-ajax-method-using-jquery"></a>Вызов метода AJAX на основе JSON с помощью jQuery

Теперь все готово к обновлению домашней страницы приложения NerdDinner для использования метода действия Сеарчбилокатион Сеарчконтроллер. Чтобы сделать это, мы откроем шаблон представления/Виевс/Хоме/индекс.аспкс и обновляем его, чтобы иметь текстовое поле, кнопку поиска, карту и &lt; &gt; элемент div с именем диннерлист:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample12.aspx)]

Затем можно добавить на страницу две функции JavaScript:

[!code-html[Main](use-ajax-to-implement-mapping-scenarios/samples/sample13.html)]

Первая функция JavaScript загружает карту при первой загрузке страницы. Вторая функция JavaScript связывает обработчик событий нажатия кнопки JavaScript на кнопке поиска. При нажатии кнопки вызывается функция JavaScript Финддиннерсгивенлокатион (), которую мы добавим в наш файл Map.js:

[!code-javascript[Main](use-ajax-to-implement-mapping-scenarios/samples/sample14.js)]

Эта функция Финддиннерсгивенлокатион () вызывает Map. Найдите () на элементе управления Virtual Earth, чтобы центрировать его в указанной папке. Когда служба карт Virtual Earth возвращает, Map. Метод Find () вызывает метод обратного вызова Каллбаккупдатемапдиннерс, который мы передали в качестве последнего аргумента.

Метод Каллбаккупдатемапдиннерс () — это место, где выполняется реальная работа. Он использует вспомогательный метод $. POST () jQuery для выполнения вызова AJAX к методу действия Сеарчбилокатион (), передавая ему широту и долготу новой выровненной по центру карте. Он определяет встроенную функцию, которая будет вызываться при завершении вспомогательного метода $. POST (), а результаты в формате JSON, возвращенные методом действия Сеарчбилокатион (), будут переданы с помощью переменной "диннерс". Затем он выполняет foreach на каждом возвращенном обеде и использует широту и долготу компании Dinner и другие свойства для добавления нового ПИН-кода на карте. Она также добавляет запись в список HTML диннерс справа от Map. Затем он подключается к событию наведения указателя на кнопки и список HTML, чтобы сведения о обеде отображались, когда пользователь наводит на них указатель мыши:

[!code-html[Main](use-ajax-to-implement-mapping-scenarios/samples/sample15.html)]

Теперь при запуске приложения и посещении домашней страницы будет представлено соответствие. Когда мы вводим название города, на карте отобразится ближайшее диннерс рядом с ним:

![](use-ajax-to-implement-mapping-scenarios/_static/image12.png)

При наведении указателя мыши на обед отобразятся сведения о нем.

Если щелкнуть название компании в пузырьковой или правой части списка HTML, будет выполнен переход к нам по адресу, который затем можно дополнительно RSVP:

![](use-ajax-to-implement-mapping-scenarios/_static/image13.png)

### <a name="next-step"></a>Следующий шаг

Теперь мы реализовали все функциональные возможности приложения NerdDinner. Давайте теперь посмотрим, как можно включить автоматическое модульное тестирование.

> [!div class="step-by-step"]
> [Назад](use-ajax-to-deliver-dynamic-updates.md)
> [Вперед](enable-automated-unit-testing.md)
