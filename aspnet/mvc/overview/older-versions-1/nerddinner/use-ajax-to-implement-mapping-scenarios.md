---
uid: mvc/overview/older-versions-1/nerddinner/use-ajax-to-implement-mapping-scenarios
title: Используйте AJAX для реализации сценариев картирования (ru) Документы Майкрософт
author: rick-anderson
description: Шаг 11 показывает, как интегрировать поддержку отображения AJAX в наше приложение NerdDinner, позволяя пользователям, которые создают, редактируют или просматривают обеды, чтобы увидеть l...
ms.author: riande
ms.date: 07/27/2010
ms.assetid: f731990a-0a81-4d62-81df-87d676cdedd6
msc.legacyurl: /mvc/overview/older-versions-1/nerddinner/use-ajax-to-implement-mapping-scenarios
msc.type: authoredcontent
ms.openlocfilehash: f2e2640eb421d5ee8006915f46cbe1090b8d21ad
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81542590"
---
# <a name="use-ajax-to-implement-mapping-scenarios"></a>Использование AJAX для реализации сценариев сопоставления

[корпорацией Майкрософт](https://github.com/microsoft)

[Скачать PDF](http://aspnetmvcbook.s3.amazonaws.com/aspnetmvc-nerdinner_v1.pdf)

> Это шаг 11 бесплатно ["NerdDinner" приложение учебник,](introducing-the-nerddinner-tutorial.md) который ходит через как построить небольшой, но полный, веб-приложение с помощью ASP.NET MVC 1.
> 
> Шаг 11 показывает, как интегрировать поддержку отображения AJAX в наше приложение NerdDinner, позволяя пользователям, которые создают, редактировать или просматривать обеды, чтобы увидеть расположение ужина графически.
> 
> Если вы используете ASP.NET MVC 3, мы рекомендуем вам следовать [начиная с MVC 3](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) или [MVC Music Store](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) учебники.

## <a name="nerddinner-step-11-integrating-an-ajax-map"></a>NerdDinner Шаг 11: Интеграция карты AJAX

Теперь мы сделаем наше приложение немного более визуально захватывающим, интегрируя поддержку отображения AJAX. Это позволит пользователям, которые создают, редактирования или просмотра обедов, чтобы увидеть расположение ужина графически.

### <a name="creating-a-map-partial-view"></a>Создание частичного представления карты

Мы собираемся использовать функцию отображения в нескольких местах в нашем приложении. Чтобы сохранить наш КОД DRY, мы инкапсулируем общую функциональность карты в одном частичном шаблоне, который мы можем повторно использовать в нескольких действиях и представлениях контроллера. Мы назовем это частичное представление "map.ascx" и создадим его в каталоге «Виды» Dinners.

Мы можем создать map.ascx частично, нажав на каталог «Виды» и&gt;выбрав команду меню Add- View. Мы назовем представление "Map.ascx", проверим его как частичное представление и укажите, что мы собираемся передать его сильно натипивированный модельный класс "Ужин":

![](use-ajax-to-implement-mapping-scenarios/_static/image1.png)

Когда мы нажимаем кнопку "Добавить" наш частичный шаблон будет создан. Затем мы обновим файл Map.ascx, чтобы иметь следующее содержимое:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample1.aspx)]

Первый &lt;&gt; сценарий указывает на библиотеку отображения Microsoft Virtual Earth 6.2. Второй &lt;скрипт&gt; указывает на файл map.js, который мы в скором времени создадим, который будет инкапсулировать нашу общую логику отображения Javascript. Элемент &lt;div id'"theMap"&gt; — это HTML-контейнер, который Виртуальная Земля будет использовать для размещения карты.

Затем у нас &lt;&gt; есть встроенный блок скриптов, который содержит две функции JavaScript, специфичные для этого представления. Первая функция использует j's'query для просмежки функции, которая выполняет, когда страница готова к запуску сценария на стороне клиента. Он вызывает функцию помощи LoadMap(), которую мы определим в нашем файле сценария Map.js для загрузки виртуального управления картой Земли. Вторая функция — это обработчик событий обратного вызова, который добавляет на карту значок, идентифицируя местоположение.

Обратите внимание, как мы &lt;используем&gt; блок на стороне сервера% в блоке сценария на стороне клиента для встраиваемшира и долготы ужина, которые мы хотим сопоставить в JavaScript. Это полезный метод вывода динамических значений, которые могут быть использованы сценарием на стороне клиента (без необходимости отдельного вызова AJAX обратно на сервер для получения значений - что делает его быстрее). &gt; Блоки &lt;% % будут выполняться, когда представление отображается на сервере , и поэтому выход HTML будет просто в конечном итоге со встроенными значениями JavaScript (например: var широты 47.64312;).

### <a name="creating-a-mapjs-utility-library"></a>Создание утилиты Map.js

Давайте создадим файл Map.js, который мы можем использовать для инкапсулирования функциональности JavaScript для нашей карты (и реализации методов LoadMap и LoadPin выше). Мы можем сделать это, нажав на каталог «Скрипты» в нашем&gt;проекте, а затем выберите команду меню «Добавить новый элемент», выберите элемент JScript и назовите его «Map.js».

Ниже приведен код JavaScript, который мы добавим в файл Map.js, который будет взаимодействовать с Виртуальной Землей, чтобы отобразить нашу карту и добавить к ней контакты местоположения для наших ужинов:

[!code-javascript[Main](use-ajax-to-implement-mapping-scenarios/samples/sample2.js)]

### <a name="integrating-the-map-with-create-and-edit-forms"></a>Интеграция карты с формами создания и отсвачения

Теперь мы интегрируем поддержку Карты с существующими сценариями создания и отсвачения. Хорошей новостью является то, что это довольно легко сделать, и не требует от нас, чтобы изменить любой из наших код контроллера. Поскольку наши представления Create и Edit имеют общий частичный вид "DinnerForm" для реализации uI формы ужина, мы можем добавить карту в одном месте и использовать сценарии создания и отсылки.

Все, что нам нужно сделать, это открыть "Виды" Dinners /DinnerForm.ascx частичное представление и обновить его, чтобы включить нашу новую карту частично. Ниже приведено то, что обновленный DinnerForm будет выглядеть после того, как карта будет добавлена (обратите внимание: элементы формы HTML опущены из фрагмента кода ниже для краткости):

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample3.aspx)]

DinnerForm частично выше принимает объект типа "DinnerFormViewModel" в качестве своего типа модели (потому что он нуждается как в объекте ужин, а также SelectList, чтобы заполнить список стран). Наша карта частичнопросто просто нуждается в объекте типа "Ужин" в качестве своего типа модели, и поэтому, когда мы делаем карту частичной мы проходим только ужин субсобственности DinnerFormViewModel к нему:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample4.aspx)]

Функция JavaScript, добавленная к частичному использованию j'query, чтобы прикрепить событие «blur» к текстовому ящику HTML «Адрес». Вы, наверное, слышали о "фокус" событий, которые огонь, когда пользователь нажимает или вкладки в текстовый ящик. Противоположностью является событие "размытие", которое сравнивается при выходе пользователя из текстового ящика. Вышеупомянутый обработчик событий очищает значения текстового ящика широты и долготы, когда это происходит, а затем отображает новое местоположение адреса на нашей карте. Обработчик событий обратного вызова, который мы определили в файле map.js, затем обновит текстовые ящики долготы и широты в нашей форме, используя значения, возвращенные виртуальной землей на основе адреса, который мы им дали.

И теперь, когда мы запускаем наше приложение снова и нажмите на вкладку "Host Dinner", мы увидим карту по умолчанию, отображаемую вместе с нашими стандартными элементами формы ужина:

![](use-ajax-to-implement-mapping-scenarios/_static/image2.png)

Когда мы введем адрес, а затем отошли, карта динамически обновится для отображения местоположения, и наш обработчик событий заселит текстовые ящики широты/долготы со значениями местоположения:

![](use-ajax-to-implement-mapping-scenarios/_static/image3.png)

Если мы сохраним новый ужин, а затем откроем его снова для редактирования, мы обнаружим, что местоположение карты отображается при загрузке страницы:

![](use-ajax-to-implement-mapping-scenarios/_static/image4.png)

Каждый раз, когда поле адреса меняется, карта и координаты широты/долготы будут обновляться.

Теперь, когда карта отображает местоположение Ужина, мы также можем изменить поля формы широты и долготы от видимых текстовых ящиков на скрытые элементы (поскольку карта автоматически обновляет их каждый раз, когда вводится адрес). Для этого мы переключимся с использования html.TextBox() HTML-помощника на метод помощника Html.Hidden()

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample5.aspx)]

И теперь наши формы немного более удобными для пользователей и избежать отображения сырой широты / долготы (в то же время хранить их с каждым ужином в базе данных):

![](use-ajax-to-implement-mapping-scenarios/_static/image5.png)

### <a name="integrating-the-map-with-the-details-view"></a>Интеграция карты с представлением деталей

Теперь, когда карта интегрирована с нашими сценариями создания и отсвазания, давайте также интегрируем ее в наш сценарий «Детали». Все, что нам нужно &lt;сделать, это назвать% Html.RenderPartial ("карта"); %&gt; в представлении Детали.

Ниже приведен исходный код для полного представления Детали (с интеграцией карты) выглядит следующим:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample6.aspx)]

И теперь, когда пользователь переходит на /Dinners /Подробности / URL-адрес они увидят подробную информацию об ужине, расположение ужина на карте (в комплекте с push-pin, что при зависе над отображает название ужина и адрес его), и иметь AJAX ссылку на RSVP для него:

![](use-ajax-to-implement-mapping-scenarios/_static/image6.png)

### <a name="implementing-location-search-in-our-database-and-repository"></a>Реализация поиска местоположения в нашей базе данных и репозитории

Чтобы закончить реализацию AJAX, давайте добавим карту на главную страницу приложения, которая позволяет пользователям графически искать обеды рядом с ними.

![](use-ajax-to-implement-mapping-scenarios/_static/image7.png)

Начнем с внедрения поддержки в нашей базе данных и сложек репозитория данных для эффективного выполнения поиска радиуса местоположения для Dinners. Мы могли бы использовать новые [геопространственные особенности S'L 2008](https://www.microsoft.com/sqlserver/2008/en/us/spatial-data.aspx) для реализации этого, или же мы [http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx](http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx) можем использовать функциональный подход, который Гэри Драйден обсуждал в статье здесь: и Роб Конэри писал об использовании с помощью LIN' для S'L здесь:[http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/](http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/)

Для реализации этого метода мы откроем "Server Explorer" в Visual Studio, выберем базу данных NerdDinner, а затем нажмите правой кнопкой мыши на подузлах "функций" под ним и выберем для создания новой "Scalar-ценности функции":

![](use-ajax-to-implement-mapping-scenarios/_static/image8.png)

Затем мы вставьте в следующей функции Расстоянии:

[!code-sql[Main](use-ajax-to-implement-mapping-scenarios/samples/sample7.sql)]

Затем мы создадим новую функцию, ценную на таблицу, в сервере S'L, которую мы назовем «NearestDinners»:

![](use-ajax-to-implement-mapping-scenarios/_static/image9.png)

Эта функция таблицы "NearestDinners" использует функцию Помощи DistanceBetween, чтобы вернуть все Dinners в пределах 100 миль от широты и долготы, которые мы поставляем:

[!code-sql[Main](use-ajax-to-implement-mapping-scenarios/samples/sample8.sql)]

Для вызова этой функции мы сначала откроем LIN'l дизайнеру S'L, дважды нажав на файл NerdDinner.dbml в нашем каталоге «Модели»:

![](use-ajax-to-implement-mapping-scenarios/_static/image10.png)

Затем мы перетащим ближайшие ужины и функции Между функциями на lin'l дизайнеру S'L, что приведет к их добавлению в качестве методов на нашем lin' в класс S'L NerdDinnerDataContext:

![](use-ajax-to-implement-mapping-scenarios/_static/image11.png)

Затем мы можем разоблачить метод запроса "FindByLocation" на нашем классе DinnerRepository, который использует функцию NearestDinner для возвращения предстоящих ужинов, которые находятся в пределах 100 миль от указанного местоположения:

[!code-csharp[Main](use-ajax-to-implement-mapping-scenarios/samples/sample9.cs)]

### <a name="implementing-a-json-based-ajax-search-action-method"></a>Внедрение метода действий по поиску AJAX на основе JSON

Теперь мы реализуем метод действия контроллера, который использует новый метод репозитория FindByLocation() для возвращения списка данных Ужина, которые могут быть использованы для заполнения карты. Этот метод действия вернет данные ужина в формате JSON (JavaScript Object Notation), чтобы ими можно было легко манипулировать с помощью JavaScript на клиенте.

Для реализации этого мы создадим новый класс "SearchController", нажав на каталог&gt;"Контролеры" и выбрав команду меню Add- Controller. Затем мы реализуем метод действий "SearchByLocation" в новом классе SearchController, как ниже:

[!code-csharp[Main](use-ajax-to-implement-mapping-scenarios/samples/sample10.cs)]

Метод действий SearchController SearchByLocation внутренне вызывает метод FindByLocation на DinnerRepository, чтобы получить список близлежащих обедов. Однако вместо того, чтобы возвращать объекты Dinner непосредственно клиенту, он возвращает объекты JsonDinner. Класс JsonDinner предоставляет подмножество свойств Dinner (например: по соображениям безопасности он не раскрывает имена людей, у которых есть RSVP'd на ужин). Он также включает в себя свойство RSVPCount, которое не существует на ужине и которое динамически рассчитывается путем подсчета количества объектов RSVP, связанных с конкретным ужином.

Затем мы используем метод помощника Json () на базовом классе контроллера, чтобы вернуть последовательность обедов с помощью формата проводов на основе JSON. JSON является стандартным текстовым форматом для представления простых структур данных. Ниже приведен пример того, как выглядит список двух объектов JsonDinner, когда возвращается из нашего метода действий:

[!code-json[Main](use-ajax-to-implement-mapping-scenarios/samples/sample11.json)]

### <a name="calling-the-json-based-ajax-method-using-jquery"></a>Вызов метода AJAX на основе JSON с помощью j'ary

Теперь мы готовы обновить домашнюю страницу приложения NerdDinner, чтобы использовать метод действий SearchController SearchByLocation. Для этого мы откроем шаблон представления /Views/Home/Index.aspx и обновим его, чтобы иметь &lt;текстовый ящик, кнопку поиска, нашу карту и элемент div&gt; под названием dinnerList:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample12.aspx)]

Затем мы можем добавить две функции JavaScript на страницу:

[!code-html[Main](use-ajax-to-implement-mapping-scenarios/samples/sample13.html)]

Первая функция JavaScript загружает карту при первой загрузке страницы. Вторая функция JavaScript подсовкивает обработчик события JavaScript на кнопке поиска. При нажатии кнопки она вызывает функцию FindDinnersGivenLocation() JavaScript, которую мы добавим в наш файл Map.js:

[!code-javascript[Main](use-ajax-to-implement-mapping-scenarios/samples/sample14.js)]

Эта функция FindDinnersGivenLocation() вызывает карту. Найти () на виртуальном управлении Землей, чтобы центр его на введанным местоположении. Когда виртуальная служба карты земли возвращается, карта. Найти () метод вызывает обратный вызовUpdateMapDinners обратный метод мы передали его в качестве окончательного аргумента.

Метод callbackUpdateMapDinners() — это метод, в котором выполняется реальная работа. Он использует метод помощника J'ery's $.post() для выполнения вызова AJAX к нашему searchController's SearchByLocation() методу действий - передав его широту и долготу недавно центрированной карты. Он определяет внеочередную функцию, которая будет называться, когда метод помощника $.post() завершается, а результаты ужина, отформатированные JSON, будут возвращены из метода действий SearchByLocation() будет передан аименной, называемой «ужинами». Затем он делает foreach над каждым возвращенным обедом, и использует широту и долготу обеда и другие свойства для того чтобы добавить новый штырь на карте. Он также добавляет запись ужина в список HTML ужинов справа от карты. Затем провода до нависания событие для обоих pushpins и HTML список так, что детали о ужине отображаются, когда пользователь парит над ними:

[!code-html[Main](use-ajax-to-implement-mapping-scenarios/samples/sample15.html)]

А теперь, когда мы забьем приложение и посетим домашнюю страницу, нам представят карту. Когда мы введом название города карта будет отображать предстоящие обеды рядом с ним:

![](use-ajax-to-implement-mapping-scenarios/_static/image12.png)

Нависая над ужином будет отображать подробности об этом.

Нажав на название ужина либо в пузыре, либо на правой стороне в списке HTML, мы перейдем к обеду, который мы можем дополнительно провести RSVP для:

![](use-ajax-to-implement-mapping-scenarios/_static/image13.png)

### <a name="next-step"></a>Следующий шаг

Теперь мы внедрили всю функциональность приложения нашего приложения NerdDinner. Давайте теперь рассмотрим, как мы можем включить автоматическое модульное тестирование его.

> [!div class="step-by-step"]
> [Назад](use-ajax-to-deliver-dynamic-updates.md)
> [Вперед](enable-automated-unit-testing.md)
