---
uid: mvc/overview/older-versions-1/nerddinner/use-ajax-to-implement-mapping-scenarios
title: Использование AJAX для реализации сценариев сопоставления | Документация Майкрософт
author: microsoft
description: Шаг 11 показано, как интегрировать поддержку сопоставления AJAX в наше приложение NerdDinner, позволяет пользователям, создание, изменение или просмотр ужинов, чтобы увидеть l...
ms.author: riande
ms.date: 07/27/2010
ms.assetid: f731990a-0a81-4d62-81df-87d676cdedd6
msc.legacyurl: /mvc/overview/older-versions-1/nerddinner/use-ajax-to-implement-mapping-scenarios
msc.type: authoredcontent
ms.openlocfilehash: f7de23ca46e6dc00fe8075e28068a8b3f95d02cd
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57053261"
---
<a name="use-ajax-to-implement-mapping-scenarios"></a>Использование AJAX для реализации сценариев сопоставления
====================
по [Microsoft](https://github.com/microsoft)

[Загрузить PDF-файл](http://aspnetmvcbook.s3.amazonaws.com/aspnetmvc-nerdinner_v1.pdf)

> Это 11 из бесплатной [руководство по использованию приложения «NerdDinner»](introducing-the-nerddinner-tutorial.md) , пошаговое рассмотрение как создать небольшой, но завершить, веб-приложения с помощью ASP.NET MVC 1.
> 
> Шаг 11 показано, как интегрировать поддержку сопоставления AJAX в наше приложение NerdDinner, позволяет пользователям, создание, изменение или просмотр ужинов, чтобы просмотреть расположение компании dinner графически.
> 
> Если вы используете ASP.NET MVC 3, рекомендуется следовать [Приступая к работе с MVC 3](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) или [MVC Music Store](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) учебники.


## <a name="nerddinner-step-11-integrating-an-ajax-map"></a>NerdDinner Step 11: Интеграция картой AJAX

Теперь сделаем наше приложение немного более визуально интересных путем интеграции поддержку сопоставления AJAX. Это позволит пользователям, создание, изменение или просмотр ужинов, чтобы просмотреть расположение компании dinner графически.

### <a name="creating-a-map-partial-view"></a>Создание карты частичного представления

Мы собираемся использовать функцию сопоставления в нескольких местах внутри нашего приложения. Чтобы сохранить наш код ПРОБНОГО мы оформим общие функции карты в пределах одного частичного шаблона, который можно повторно использовать в нескольких действий контроллера и представлений. Мы будем назовите этот частичное представление «map.ascx» и создайте его в каталоге \Views\Dinners.

Можно создать map.ascx частичного, щелкнув правой кнопкой мыши каталог \Views\Dinners и выбрав Add -&gt;просмотреть команду меню. Будет представлению имя «Map.ascx», проверьте его как частичное представление и указать, что мы хотим передать его класс модели со строгой типизацией «обед»:

![](use-ajax-to-implement-mapping-scenarios/_static/image1.png)

При нажатии кнопки «Добавить» создается наших частичного шаблона. Затем мы обновим файл Map.ascx следующим содержимым:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample1.aspx)]

Первый &lt;скрипт&gt; ссылок, в библиотеку Microsoft виртуального Earth 6.2 сопоставления. Второй &lt;скрипт&gt; ссылок, в файл map.js, мы создадим чуть ниже, который будет инкапсулироваться наших общую логику сопоставления Javascript. &lt;Div id = «theMap»&gt; элемент является контейнером HTML, который будет использовать Virtual Earth для размещения карты.

Затем у нас встроенный &lt;скрипт&gt; блока, который содержит две функции JavaScript, относящиеся к этому представлению. Первая функция использует jQuery для передачи up функцию, которая выполняется, когда страница готова для выполнения сценария на стороне клиента. Вызывает вспомогательную функцию LoadMap(), мы определим в наш файл скрипта Map.js загрузить управления картой virtual earth. Вторая функция — это обработчик событий обратного вызова, который добавляет ПИН-кода на карту, определяющий расположение.

Обратите внимание на то, как мы используем на стороне сервера &lt;% = %&gt; блок в блоке сценария на стороне клиента для внедрения широту и долготу обед, требуется сопоставить в JavaScript. Это удобный способ вывода динамические значения, которые могут использоваться скрипт на стороне клиента (не требуется отдельный вызов AJAX на сервер для получения значений — ускоряющую). &lt;% = %&gt; Блоки будут выполняться при подготовке к просмотру представлении на сервере — и поэтому выходные данные HTML-просто появятся внедренные значения JavaScript (например: var latitude = 47.64312;).

### <a name="creating-a-mapjs-utility-library"></a>Создание библиотеки Map.js служебной программы

Теперь создадим файл Map.js, который можно использовать для инкапсуляции функций JavaScript для нашей карты (и реализуют LoadMap и LoadPin выше). Мы можете это сделать, щелкнув правой кнопкой мыши каталог \Scripts в наш проект, а затем выберите «Add -&gt;новый элемент» команды меню, выберите элемент JScript и назовите его «Map.js».

Ниже приведен код JavaScript, мы добавим в файл Map.js, которая будет взаимодействовать с Virtual Earth для отображения нашу карту и добавление его расположения ПИН-коды для наших ужинов:

[!code-javascript[Main](use-ajax-to-implement-mapping-scenarios/samples/sample2.js)]

### <a name="integrating-the-map-with-create-and-edit-forms"></a>Интеграция карты Создание и изменение форм

Поддержка карты теперь будет интегрировано с помощью наших существующих сценариев Create и Edit. Хорошая новость — что это довольно просто задачи и не нужно изменить какие-либо часть нашего кода контроллера. Наши представления Create и Edit, общие для нескольких распространенных частичное представление «DinnerForm» реализовать пользовательский Интерфейс формы dinner мы можно добавить карту в одном месте и оба наших Создание и изменение сценария его использовать.

Все, что нам нужно дел — открыть \Views\Dinners\DinnerForm.ascx частичного представления и обновить его для включения частичного нашей новой карте. Ниже приведен обновленные DinnerForm будет выглядеть после добавления карты (Примечание: в приведенном ниже фрагменте кода для краткости опущены элементы HTML-формы):

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample3.aspx)]

Частичные выше DinnerForm принимает объект типа «DinnerFormViewModel» как тип модели (так как он требуется, как объект Dinner, так и SelectList для заполнения элемента управления dropdownlist стран). Нашу карту частичного требуется только объект типа «Обед» как тип модели, и поэтому когда мы подготовки карты к просмотру частичного мы передаем просто Dinner подчиненное свойство DinnerFormViewModel к нему:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample4.aspx)]

Функция JavaScript, которая мы добавили частичного использует jQuery для присоединения событий «размытия» в текстовое поле «Адрес» HTML. Вы, вероятно, слышали «фокус» события, которые срабатывают при щелчке или вкладок в текстовое поле. Обратное — «размытия» событие, которое возникает, когда пользователь выходит из текстового поля. Выше обработчик событий очищает текстовое поле значения широты и долготы, когда это происходит и затем отображает новое расположение адреса на краю карты. Обработчик события обратного вызова, определенный в файле map.js обновляют текстовые поля широты и долготы на нашу форму, используя значения, возвращаемые методом виртуального earth по адресу, который мы дали.

И теперь мы запустить наше приложение снова перейдите на вкладку «Узла обед», мы увидим сопоставления по умолчанию, отображается вместе с нашей стандартных элементов формы компании Dinner:

![](use-ajax-to-implement-mapping-scenarios/_static/image2.png)

Когда мы введите адрес и нажмите клавишу tab, немедленно, карты будет динамически обновляться для отображения расположения и наш обработчик событий будет заполнять текстовые поля широты и долготы расположение значениями:

![](use-ajax-to-implement-mapping-scenarios/_static/image3.png)

Если сохранить новый dinner и затем снова открыть его для редактирования, очень скоро найдется что расположения карты отображается при загрузке страницы:

![](use-ajax-to-implement-mapping-scenarios/_static/image4.png)

Каждый раз при изменении поля «адрес», будет обновлять карты и координаты широты и долготы.

Теперь, когда на карте отображается расположение обед, мы можем изменить поля широты и долготы формы не видны текстовые поля на следующую скрытых элементов (так как карты автоматически обновляет их каждый раз, когда введенный адрес). Задача этого мы перейдем от использование вспомогательного метода Html.TextBox() HTML с помощью вспомогательного метода Html.Hidden():

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample5.aspx)]

И теперь наши forms немного более понятны и избежать отображения необработанных широты и долготы (сохраняя по-прежнему их с каждой ужин в базе данных):

![](use-ajax-to-implement-mapping-scenarios/_static/image5.png)

### <a name="integrating-the-map-with-the-details-view"></a>Интеграция карты в представлении сведений

Теперь, когда у нас есть карты, интегрированных с нашими сценариями Create и Edit, давайте также интегрировать ее с нашей ситуации сведения. Все, что нам нужно задача заключается в вызове &lt;% Html.RenderPartial("map"); %&gt; в представлении подробных сведений.

Ниже приведен исходный код завершения представление Details (с помощью интеграции карты) выглядит как:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample6.aspx)]

И теперь при переходе на /Dinners/сведения / [id] URL-адрес, они будут просматривать сведения о обед, расположение на карте компании dinner (дополненный канцелярской кнопки что при прохождении курсора над отображает название компании dinner и адрес ее), и иметь ссылку RSVP fo AJAX r его:

![](use-ajax-to-implement-mapping-scenarios/_static/image6.png)

### <a name="implementing-location-search-in-our-database-and-repository"></a>Реализация поиска расположения в нашей базе данных и репозитория

Чтобы завершить создание нашей реализации AJAX, давайте добавим карту на домашнюю страницу приложения, которое позволяет пользователям производить поиск в графическом виде для ужинов рядом с ними.

![](use-ajax-to-implement-mapping-scenarios/_static/image7.png)

Начнем с реализации поддержки в рамках нашей базы данных и данных уровня репозитория эффективно выполнять поиск ужинов radius на основе расположения. Мы могли бы использовать новый [геопространственных функций SQL 2008](https://www.microsoft.com/sqlserver/2008/en/us/spatial-data.aspx) реализовать это, или в качестве альтернативы можно использовать подход функция SQL, который Драйден Гари описано в статье: [ http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx ](http://www.codeproject.com/KB/cs/distancebetweenlocations.aspx) и Rob Conery писал об использовании с помощью LINQ to SQL, здесь: [http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/](http://blog.wekeroad.com/2007/08/30/linq-and-geocoding/)

Реализация этой методики, мы будет откройте «Обозреватель серверов» в Visual Studio, NerdDinner базы данных, щелкните правой кнопкой мыши на узле «функции» вложенных под ним и выберите пункт для создания нового «скалярные функции»:

![](use-ajax-to-implement-mapping-scenarios/_static/image8.png)

Мы будем вставьте следующую функцию DistanceBetween:

[!code-sql[Main](use-ajax-to-implement-mapping-scenarios/samples/sample7.sql)]

Затем мы создадим новую функцию с табличным в SQL Server, который мы назовем «NearestDinners»:

![](use-ajax-to-implement-mapping-scenarios/_static/image9.png)

Эта функция таблицы «NearestDinners» использует функцию DistanceBetween для возврата всех ужинов в 100 миль от широты и долготы мы используем ее:

[!code-sql[Main](use-ajax-to-implement-mapping-scenarios/samples/sample8.sql)]

Чтобы вызвать эту функцию, мы будем сначала откройте конструктор LINQ to SQL, дважды щелкнув файл в каталог \Models NerdDinner.dbml:

![](use-ajax-to-implement-mapping-scenarios/_static/image10.png)

Мы будем перетащите функции NearestDinners и DistanceBetween LINQ к SQL конструктор, который приведет к их добавление к классу SQL NerdDinnerDataContext как к методам в нашем LINQ:

![](use-ajax-to-implement-mapping-scenarios/_static/image11.png)

Мы можем предоставить метод запроса «FindByLocation» на наш класс DinnerRepository, функция NearestDinner для возврата предстоящих ужинов, которые находятся в 100 миль от заданного расположения:

[!code-csharp[Main](use-ajax-to-implement-mapping-scenarios/samples/sample9.cs)]

### <a name="implementing-a-json-based-ajax-search-action-method"></a>Реализация метода действия поиска на основе JSON AJAX

Теперь мы реализуем метод действия контроллера, в котором используются преимущества нового метода репозитория FindByLocation() возвращения список компании Dinner данных, который может использоваться для заполнения карту. У нас будет данным методом действия вернуть обратно компании Dinner данные в формате JSON (JavaScript Object Notation), чтобы его можно легко управлять с помощью JavaScript на стороне клиента.

Чтобы реализовать это, мы создадим новый класс «SearchController», щелкнув правой кнопкой мыши каталог \Controllers и выбрав Add -&gt;контроллера меню команды. Затем мы реализуем метод действия «SearchByLocation» в новый класс SearchController как ниже:

[!code-csharp[Main](use-ajax-to-implement-mapping-scenarios/samples/sample10.cs)]

Метод действия SearchByLocation SearchController внутренне вызывает метод FindByLocation DinnerRespository, чтобы получить список близлежащих ужинов. Вместо того чтобы возвращать объекты Dinner непосредственно клиенту, однако вместо этого он возвращает JsonDinner объектов. Класс JsonDinner предоставляет подмножество свойств Dinner (например: оно не раскрывает имена людей, которые RSVP'd пообедать по причинам безопасности). Он также включает свойство RSVPCount, не существует на ужин — и динамически которого вычисляется путем подсчета количества RSVP объекты, связанные с определенной dinner.

Затем используется вспомогательный метод на JSON в базовом классе контроллера будет возвращать последовательность ужинов, с помощью формата передачи на основе JSON. JSON — это стандартный текстовый формат для представления простых структур данных. Ниже приведен пример списка формате JSON для двух объектов JsonDinner просмотр после возвращения из наших метода действия.

[!code-json[Main](use-ajax-to-implement-mapping-scenarios/samples/sample11.json)]

### <a name="calling-the-json-based-ajax-method-using-jquery"></a>Вызов метода AJAX на основе JSON, с помощью jQuery

Теперь мы готовы обновление домашней страницы приложения для использования метода действия SearchByLocation SearchController NerdDinner. Задача, мы откройте шаблон представления /Views/Home/Index.aspx и обновить ее, чтобы установить текстовое поле, кнопку поиска, нашу карту и &lt;div&gt; элемент с именем dinnerList:

[!code-aspx[Main](use-ajax-to-implement-mapping-scenarios/samples/sample12.aspx)]

Затем можно добавить две функции JavaScript на страницу:

[!code-html[Main](use-ajax-to-implement-mapping-scenarios/samples/sample13.html)]

Первая функция JavaScript загружает карту при первой загрузке страницы. Второй провода функции JavaScript вверх JavaScript нажмите кнопку обработчика событий кнопки search. При нажатии кнопки вызывается функция FindDinnersGivenLocation() JavaScript, который мы добавим в наш файл Map.js:

[!code-javascript[Main](use-ajax-to-implement-mapping-scenarios/samples/sample14.js)]

Эта функция FindDinnersGivenLocation() вызывает карты. Применения Find() для элемента управления виртуальной Earth ее в центре введенное местоположение. Когда виртуальный earth map служба возвращает, карты. Метод Find() вызывает метод обратного вызова callbackUpdateMapDinners, который мы передали как последний аргумент.

Метод callbackUpdateMapDinners() является, где выполняется реальная работа. Используется jQuery $.post() вспомогательный метод для выполнения вызова AJAX к методу действия наших SearchController SearchByLocation() — передается широту и долготу вновь выровненные по центру карты. Он определяет встраиваемая функция, которая будет вызываться при завершении вспомогательный метод $.post() и формате JSON dinner результаты, возвращенные из SearchByLocation(), метод действия будут передаваться с помощью переменной с именем «ужины». Он затем делает foreach через каждый возвращенный dinner, а также использует dinner широты и долготы и другие свойства для добавления нового ПИН-кода на карте. Он также добавляет запись dinner HTML список ужинов справа от карты. Он затем провода вверх события наведения указателя для кнопок и HTML-списка, сведения о компании dinner отображаются при наведении на них:

[!code-html[Main](use-ajax-to-implement-mapping-scenarios/samples/sample15.html)]

И теперь когда мы запустите приложение и посетите домашнюю страницу, мы будет выведен список с картой. Когда мы вводим имя города карты для отображения предстоящих ужины рядом с ней:

![](use-ajax-to-implement-mapping-scenarios/_static/image12.png)

При наведении курсора на ужин будут отображаться сведения о нем.

Щелкните название компании Dinner на пузырьковой или в области справа в списке HTML нам, чтобы перейти компании dinner — мы могут затем при необходимости ответить на Приглашение для:

![](use-ajax-to-implement-mapping-scenarios/_static/image13.png)

### <a name="next-step"></a>Следующий шаг

Теперь мы реализовали все функции приложения наше приложение NerdDinner. Теперь давайте рассмотрим, как мы можем включить автоматического модульного тестирования его.

> [!div class="step-by-step"]
> [Назад](use-ajax-to-deliver-dynamic-updates.md)
> [Вперед](enable-automated-unit-testing.md)
