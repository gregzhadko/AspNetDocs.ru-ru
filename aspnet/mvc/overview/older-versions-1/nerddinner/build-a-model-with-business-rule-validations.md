---
uid: mvc/overview/older-versions-1/nerddinner/build-a-model-with-business-rule-validations
title: Создание модели с проверками бизнес-правил | Документация Майкрософт
author: microsoft
description: На шаге 3 показано, как создать модель, которую можно использовать для запроса и обновления базы данных для нашего приложения NerdDinner.
ms.author: riande
ms.date: 07/27/2010
ms.assetid: 0bc191b2-4311-479a-a83a-7f1b1c32e6fe
msc.legacyurl: /mvc/overview/older-versions-1/nerddinner/build-a-model-with-business-rule-validations
msc.type: authoredcontent
ms.openlocfilehash: 6ebf1b71c089229ba9139ff7dc788b8978724046
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78435582"
---
# <a name="build-a-model-with-business-rule-validations"></a><span data-ttu-id="1f48a-103">Создание модели с проверками бизнес-правил</span><span class="sxs-lookup"><span data-stu-id="1f48a-103">Build a Model with Business Rule Validations</span></span>

<span data-ttu-id="1f48a-104">по [Майкрософт](https://github.com/microsoft)</span><span class="sxs-lookup"><span data-stu-id="1f48a-104">by [Microsoft](https://github.com/microsoft)</span></span>

[<span data-ttu-id="1f48a-105">Скачать в формате PDF</span><span class="sxs-lookup"><span data-stu-id="1f48a-105">Download PDF</span></span>](http://aspnetmvcbook.s3.amazonaws.com/aspnetmvc-nerdinner_v1.pdf)

> <span data-ttu-id="1f48a-106">Это шаг 3 из бесплатного [учебника по NerdDinner приложению](introducing-the-nerddinner-tutorial.md) , в котором рассматривается создание небольшого, но полного веб-приложения с использованием ASP.NET MVC 1.</span><span class="sxs-lookup"><span data-stu-id="1f48a-106">This is step 3 of a free ["NerdDinner" application tutorial](introducing-the-nerddinner-tutorial.md) that walks-through how to build a small, but complete, web application using ASP.NET MVC 1.</span></span>
> 
> <span data-ttu-id="1f48a-107">На шаге 3 показано, как создать модель, которую можно использовать для запроса и обновления базы данных для нашего приложения NerdDinner.</span><span class="sxs-lookup"><span data-stu-id="1f48a-107">Step 3 shows how to create a model that we can use to both query and update the database for our NerdDinner application.</span></span>
> 
> <span data-ttu-id="1f48a-108">Если вы используете ASP.NET MVC 3, мы рекомендуем следовать руководствам по [Начало работы в MVC 3 или в приложении для](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) [музыкального магазина MVC](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) .</span><span class="sxs-lookup"><span data-stu-id="1f48a-108">If you are using ASP.NET MVC 3, we recommend you follow the [Getting Started With MVC 3](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) or [MVC Music Store](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) tutorials.</span></span>

## <a name="nerddinner-step-3-building-the-model"></a><span data-ttu-id="1f48a-109">NerdDinner. этап 3. Создание модели</span><span class="sxs-lookup"><span data-stu-id="1f48a-109">NerdDinner Step 3: Building the Model</span></span>

<span data-ttu-id="1f48a-110">В инфраструктуре "модель-представление-контроллер" термин "модель" относится к объектам, представляющим данные приложения, а также к соответствующей логике предметной области, которая интегрирует проверку и бизнес-правила с ним.</span><span class="sxs-lookup"><span data-stu-id="1f48a-110">In a model-view-controller framework the term "model" refers to the objects that represent the data of the application, as well as the corresponding domain logic that integrates validation and business rules with it.</span></span> <span data-ttu-id="1f48a-111">Эта модель во многом зависит от «сердца» приложения на основе MVC, и, как мы увидим позднее, поймет его поведение.</span><span class="sxs-lookup"><span data-stu-id="1f48a-111">The model is in many ways the "heart" of an MVC-based application, and as we'll see later fundamentally drives the behavior of it.</span></span>

<span data-ttu-id="1f48a-112">Платформа ASP.NET MVC поддерживает использование любой технологии доступа к данным, и разработчики могут выбирать из множества разнообразных возможностей данных .NET для реализации их моделей, в том числе: LINQ to Entities, LINQ to SQL, NHibernate, LLBLGen Pro, Вилсонорм или только необработанные ADO. NET DataReaders или наборы данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-112">The ASP.NET MVC framework supports using any data access technology, and developers can choose from a variety of rich .NET data options to implement their models including: LINQ to Entities, LINQ to SQL, NHibernate, LLBLGen Pro, SubSonic, WilsonORM, or just raw ADO.NET DataReaders or DataSets.</span></span>

<span data-ttu-id="1f48a-113">Для нашего приложения NerdDinner мы будем использовать LINQ to SQL, чтобы создать простую модель, которая полностью соответствует нашей структуре базы данных, и добавляет некоторую пользовательскую логику проверки и бизнес-правила.</span><span class="sxs-lookup"><span data-stu-id="1f48a-113">For our NerdDinner application we are going to use LINQ to SQL to create a simple model that corresponds fairly closely to our database design, and adds some custom validation logic and business rules.</span></span> <span data-ttu-id="1f48a-114">Затем мы реализуем класс репозитория, который помогает абстрактно использовать реализацию сохраняемости данных из остальной части приложения и позволяет нам легко выполнять модульное тестирование.</span><span class="sxs-lookup"><span data-stu-id="1f48a-114">We will then implement a repository class that helps abstract away the data persistence implementation from the rest of the application, and enables us to easily unit test it.</span></span>

### <a name="linq-to-sql"></a><span data-ttu-id="1f48a-115">LINQ to SQL</span><span class="sxs-lookup"><span data-stu-id="1f48a-115">LINQ to SQL</span></span>

<span data-ttu-id="1f48a-116">LINQ to SQL является ORM (реляционным модулем сопоставления объектов), который поставляется в составе .NET 3,5.</span><span class="sxs-lookup"><span data-stu-id="1f48a-116">LINQ to SQL is an ORM (object relational mapper) that ships as part of .NET 3.5.</span></span>

<span data-ttu-id="1f48a-117">LINQ to SQL предоставляет простой способ сопоставлять таблицы базы данных с классами .NET, к которым можно выполнять код.</span><span class="sxs-lookup"><span data-stu-id="1f48a-117">LINQ to SQL provides an easy way to map database tables to .NET classes we can code against.</span></span> <span data-ttu-id="1f48a-118">Для нашего NerdDinner приложения мы будем использовать его для преобразования таблиц диннерс и RSVP в базе данных в классы ужин и RSVP.</span><span class="sxs-lookup"><span data-stu-id="1f48a-118">For our NerdDinner application we'll use it to map the Dinners and RSVP tables within our database to Dinner and RSVP classes.</span></span> <span data-ttu-id="1f48a-119">Столбцы таблиц диннерс и RSVP будут соответствовать свойствам в классах Dinner и RSVP.</span><span class="sxs-lookup"><span data-stu-id="1f48a-119">The columns of the Dinners and RSVP tables will correspond to properties on the Dinner and RSVP classes.</span></span> <span data-ttu-id="1f48a-120">Каждый объект Dinner and RSVP будет представлять отдельную строку в таблицах диннерс или RSVP в базе данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-120">Each Dinner and RSVP object will represent a separate row within the Dinners or RSVP tables in the database.</span></span>

<span data-ttu-id="1f48a-121">LINQ to SQL позволяет нам избегать ручного создания инструкций SQL для получения и обновления объектов Dinner и RSVP с данными базы данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-121">LINQ to SQL allows us to avoid having to manually construct SQL statements to retrieve and update Dinner and RSVP objects with database data.</span></span> <span data-ttu-id="1f48a-122">Вместо этого мы определим классы Dinner and RSVP, способ сопоставления с базой данных и связи между ними.</span><span class="sxs-lookup"><span data-stu-id="1f48a-122">Instead, we'll define the Dinner and RSVP classes, how they map to/from the database, and the relationships between them.</span></span> <span data-ttu-id="1f48a-123">После этого LINQ to SQL позаботится о создании соответствующей логики выполнения SQL, которая будет использоваться во время выполнения при взаимодействии и использовании.</span><span class="sxs-lookup"><span data-stu-id="1f48a-123">LINQ to SQL will then takes care of generating the appropriate SQL execution logic to use at runtime when we interact and use them.</span></span>

<span data-ttu-id="1f48a-124">Мы можем использовать поддержку языка LINQ в VB и C# писать выразительные запросы, которые извлекают объекты Dinner и RSVP из базы данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-124">We can use the LINQ language support within VB and C# to write expressive queries that retrieve Dinner and RSVP objects from the database.</span></span> <span data-ttu-id="1f48a-125">Это уменьшает объем кода данных, который нам нужно написать, и позволяет создавать реальные приложения.</span><span class="sxs-lookup"><span data-stu-id="1f48a-125">This minimizes the amount of data code we need to write, and allows us to build really clean applications.</span></span>

### <a name="adding-linq-to-sql-classes-to-our-project"></a><span data-ttu-id="1f48a-126">Добавление LINQ to SQL классов в наш проект</span><span class="sxs-lookup"><span data-stu-id="1f48a-126">Adding LINQ to SQL Classes to our project</span></span>

<span data-ttu-id="1f48a-127">Начнем с того, что щелкните правой кнопкой мыши папку "Models" в нашем проекте и выберите команду **Добавить-&gt;создать элемент** меню:</span><span class="sxs-lookup"><span data-stu-id="1f48a-127">We'll begin by right-clicking on the "Models" folder within our project, and select the **Add-&gt;New Item** menu command:</span></span>

![](build-a-model-with-business-rule-validations/_static/image1.png)

<span data-ttu-id="1f48a-128">Откроется диалоговое окно "Добавление нового элемента".</span><span class="sxs-lookup"><span data-stu-id="1f48a-128">This will bring up the "Add New Item" dialog.</span></span> <span data-ttu-id="1f48a-129">Фильтрация по категории "данные" и выбор в ней шаблона "LINQ to SQL классы".</span><span class="sxs-lookup"><span data-stu-id="1f48a-129">We'll filter by the "Data" category and select the "LINQ to SQL Classes" template within it:</span></span>

![](build-a-model-with-business-rule-validations/_static/image2.png)

<span data-ttu-id="1f48a-130">Мы назовем элемент «NerdDinner» и надолжим кнопку «Add» (Добавить).</span><span class="sxs-lookup"><span data-stu-id="1f48a-130">We'll name the item "NerdDinner" and click the "Add" button.</span></span> <span data-ttu-id="1f48a-131">Visual Studio добавит файл NerdDinner. dbml в каталог \Моделс, а затем откроет LINQ to SQL реляционный конструктор объектов:</span><span class="sxs-lookup"><span data-stu-id="1f48a-131">Visual Studio will add a NerdDinner.dbml file under our \Models directory, and then open the LINQ to SQL object relational designer:</span></span>

![](build-a-model-with-business-rule-validations/_static/image3.png)

### <a name="creating-data-model-classes-with-linq-to-sql"></a><span data-ttu-id="1f48a-132">Создание классов модели данных с помощью LINQ to SQL</span><span class="sxs-lookup"><span data-stu-id="1f48a-132">Creating Data Model Classes with LINQ to SQL</span></span>

<span data-ttu-id="1f48a-133">LINQ to SQL позволяет быстро создавать классы модели данных из существующей схемы базы данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-133">LINQ to SQL enables us to quickly create data model classes from existing database schema.</span></span> <span data-ttu-id="1f48a-134">Для этого мы откроем базу данных NerdDinner в обозреватель сервера и выбираем таблицы, которые нужно моделировать.</span><span class="sxs-lookup"><span data-stu-id="1f48a-134">To-do this we'll open the NerdDinner database in the Server Explorer, and select the Tables we want to model in it:</span></span>

![](build-a-model-with-business-rule-validations/_static/image4.png)

<span data-ttu-id="1f48a-135">Затем можно перетащить таблицы на поверхность конструктора LINQ to SQL.</span><span class="sxs-lookup"><span data-stu-id="1f48a-135">We can then drag the tables onto the LINQ to SQL designer surface.</span></span> <span data-ttu-id="1f48a-136">Когда мы делаем это, LINQ to SQL автоматически создаст классы ужин и RSVP, используя схему таблиц (со свойствами класса, которые сопоставляются со столбцами таблицы базы данных):</span><span class="sxs-lookup"><span data-stu-id="1f48a-136">When we do this LINQ to SQL will automatically create Dinner and RSVP classes using the schema of the tables (with class properties that map to the database table columns):</span></span>

![](build-a-model-with-business-rule-validations/_static/image5.png)

<span data-ttu-id="1f48a-137">По умолчанию конструктор LINQ to SQL автоматически задает имена таблиц и столбцов "перевод" при создании классов на основе схемы базы данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-137">By default the LINQ to SQL designer automatically "pluralizes" table and column names when it creates classes based on a database schema.</span></span> <span data-ttu-id="1f48a-138">Например: таблица "диннерс" в нашем примере выше привела к классу "ужин".</span><span class="sxs-lookup"><span data-stu-id="1f48a-138">For example: the "Dinners" table in our example above resulted in a "Dinner" class.</span></span> <span data-ttu-id="1f48a-139">Такое именование классов помогает сделать наши модели совместимыми с соглашениями об именовании .NET, и я обычно находим, что конструктор самостоятельно решает эту проблему (особенно при добавлении большого числа таблиц).</span><span class="sxs-lookup"><span data-stu-id="1f48a-139">This class naming helps make our models consistent with .NET naming conventions, and I usually find that having the designer fix this up convenient (especially when adding lots of tables).</span></span> <span data-ttu-id="1f48a-140">Однако если вам не нравится имя класса или свойства, создаваемого конструктором, вы всегда можете переопределить его и изменить его на любое нужное имя.</span><span class="sxs-lookup"><span data-stu-id="1f48a-140">If you don't like the name of a class or property that the designer generates, though, you can always override it and change it to any name you want.</span></span> <span data-ttu-id="1f48a-141">Это можно сделать, изменив имя сущности или свойства в строке в конструкторе или изменив его с помощью сетки свойств.</span><span class="sxs-lookup"><span data-stu-id="1f48a-141">You can do this either by editing the entity/property name in-line within the designer or by modifying it via the property grid.</span></span>

<span data-ttu-id="1f48a-142">По умолчанию LINQ to SQLный конструктор также проверяет связи первичного и внешнего ключей таблиц, и на их основе автоматически создает по умолчанию связи связей между различными создаваемыми классами модели.</span><span class="sxs-lookup"><span data-stu-id="1f48a-142">By default the LINQ to SQL designer also inspects the primary key/foreign key relationships of the tables, and based on them automatically creates default "relationship associations" between the different model classes it creates.</span></span> <span data-ttu-id="1f48a-143">Например, при перетаскивании таблиц диннерс и RSVP в конструктор LINQ to SQL связь «один ко многим» между двумя была определена на основе того факта, что таблица RSVP имела внешний ключ к таблице диннерс (это обозначается стрелкой в элементе конструктор):</span><span class="sxs-lookup"><span data-stu-id="1f48a-143">For example, when we dragged the Dinners and RSVP tables onto the LINQ to SQL designer a one-to-many relationship association between the two was inferred based on the fact that the RSVP table had a foreign-key to the Dinners table (this is indicated by the arrow in the designer):</span></span>

![](build-a-model-with-business-rule-validations/_static/image6.png)

<span data-ttu-id="1f48a-144">Приведенная выше Ассоциация приведет к тому, что LINQ to SQL добавить в класс RSVP строго типизированное свойство "ужин", которое разработчики могут использовать для доступа к обеду, связанному с заданным RSVP.</span><span class="sxs-lookup"><span data-stu-id="1f48a-144">The above association will cause LINQ to SQL to add a strongly typed "Dinner" property to the RSVP class that developers can use to access the Dinner associated with a given RSVP.</span></span> <span data-ttu-id="1f48a-145">Кроме того, класс ужин будет иметь свойство сбора "RSVP", которое позволяет разработчикам извлекать и обновлять объекты RSVP, связанные с конкретным обедом.</span><span class="sxs-lookup"><span data-stu-id="1f48a-145">It will also cause the Dinner class to have a "RSVPs" collection property that enables developers to retrieve and update RSVP objects associated with a particular Dinner.</span></span>

<span data-ttu-id="1f48a-146">Ниже показан пример IntelliSense в Visual Studio, когда мы создаем новый объект RSVP и добавляем его в коллекцию RSVP-оповещений компании Dinner.</span><span class="sxs-lookup"><span data-stu-id="1f48a-146">Below you can see an example of intellisense within Visual Studio when we create a new RSVP object and add it to a Dinner's RSVPs collection.</span></span> <span data-ttu-id="1f48a-147">Обратите внимание, что LINQ to SQL автоматически добавила в объект ужин коллекцию "RSVP":</span><span class="sxs-lookup"><span data-stu-id="1f48a-147">Notice how LINQ to SQL automatically added a "RSVPs" collection on the Dinner object:</span></span>

![](build-a-model-with-business-rule-validations/_static/image7.png)

<span data-ttu-id="1f48a-148">Добавив объект RSVP в коллекцию RSVP-партнеров компании Dinner The, мы сообщаем LINQ to SQL связать связь внешнего ключа между компанией Dinner and the RSVP в нашей базе данных:</span><span class="sxs-lookup"><span data-stu-id="1f48a-148">By adding the RSVP object to the Dinner's RSVPs collection we are telling LINQ to SQL to associate a foreign-key relationship between the Dinner and the RSVP row in our database:</span></span>

![](build-a-model-with-business-rule-validations/_static/image8.png)

<span data-ttu-id="1f48a-149">Если вы не хотите, чтобы конструктор был смоделирован или назывался ассоциацией таблиц, его можно переопределить.</span><span class="sxs-lookup"><span data-stu-id="1f48a-149">If you don't like how the designer has modeled or named a table association, you can override it.</span></span> <span data-ttu-id="1f48a-150">Просто щелкните стрелку взаимосвязи в конструкторе и получите доступ к его свойствам через сетку свойств, чтобы переименовать, удалить или изменить ее.</span><span class="sxs-lookup"><span data-stu-id="1f48a-150">Just click on the association arrow within the designer and access its properties via the property grid to rename, delete or modify it.</span></span> <span data-ttu-id="1f48a-151">Однако для нашего приложения NerdDinner правила взаимосвязей по умолчанию хорошо подходят для создаваемых классов модели данных, и мы можем использовать поведение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="1f48a-151">For our NerdDinner application, though, the default association rules work well for the data model classes we are building and we can just use the default behavior.</span></span>

### <a name="nerddinnerdatacontext-class"></a><span data-ttu-id="1f48a-152">Класс Нерддиннердатаконтекст</span><span class="sxs-lookup"><span data-stu-id="1f48a-152">NerdDinnerDataContext Class</span></span>

<span data-ttu-id="1f48a-153">Visual Studio автоматически создаст классы .NET, представляющие модели и связи базы данных, определенные с помощью конструктора LINQ to SQL.</span><span class="sxs-lookup"><span data-stu-id="1f48a-153">Visual Studio will automatically create .NET classes that represent the models and database relationships defined using the LINQ to SQL designer.</span></span> <span data-ttu-id="1f48a-154">Для каждого файла конструктора LINQ to SQL, добавленного в решение, также создается LINQ to SQL класс DataContext.</span><span class="sxs-lookup"><span data-stu-id="1f48a-154">A LINQ to SQL DataContext class is also generated for each LINQ to SQL designer file added to the solution.</span></span> <span data-ttu-id="1f48a-155">Так как мы назвали наш LINQ to SQL элемент класса «NerdDinner», созданный класс DataContext будет называться «Нерддиннердатаконтекст».</span><span class="sxs-lookup"><span data-stu-id="1f48a-155">Because we named our LINQ to SQL class item "NerdDinner", the DataContext class created will be called "NerdDinnerDataContext".</span></span> <span data-ttu-id="1f48a-156">Этот класс Нерддиннердатаконтекст является основным способом взаимодействия с базой данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-156">This NerdDinnerDataContext class is the primary way we will interact with the database.</span></span>

<span data-ttu-id="1f48a-157">Наш класс Нерддиннердатаконтекст предоставляет два свойства — "диннерс" и "RSVP", которые представляют две таблицы, смоделированные в базе данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-157">Our NerdDinnerDataContext class exposes two properties - "Dinners" and "RSVPs" - that represent the two tables we modeled within the database.</span></span> <span data-ttu-id="1f48a-158">Можно использовать C# для записи запросов LINQ к этим свойствам для запроса и получения объектов Dinner и RSVP из базы данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-158">We can use C# to write LINQ queries against those properties to query and retrieve Dinner and RSVP objects from the database.</span></span>

<span data-ttu-id="1f48a-159">В следующем коде показано, как создать экземпляр объекта Нерддиннердатаконтекст и выполнить запрос LINQ к нему для получения последовательности диннерс, которая возникает в будущем.</span><span class="sxs-lookup"><span data-stu-id="1f48a-159">The following code demonstrates how to instantiate a NerdDinnerDataContext object and perform a LINQ query against it to obtain a sequence of Dinners that occur in the future.</span></span> <span data-ttu-id="1f48a-160">Visual Studio предоставляет полную IntelliSense при написании запроса LINQ, а возвращенные из него объекты являются строго типизированными, а также поддерживают IntelliSense:</span><span class="sxs-lookup"><span data-stu-id="1f48a-160">Visual Studio provides full intellisense when writing the LINQ query, and the objects returned from it are strongly-typed and also support intellisense:</span></span>

![](build-a-model-with-business-rule-validations/_static/image9.png)

<span data-ttu-id="1f48a-161">Помимо предоставления запроса на получение объектов Dinner and RSVP, Нерддиннердатаконтекст также автоматически отслеживает все изменения, внесенные в объекты Dinnered и RSVP.</span><span class="sxs-lookup"><span data-stu-id="1f48a-161">In addition to allowing us to query for Dinner and RSVP objects, a NerdDinnerDataContext also automatically tracks any changes we subsequently make to the Dinner and RSVP objects we retrieve through it.</span></span> <span data-ttu-id="1f48a-162">Эту функцию можно использовать для простого сохранения изменений в базе данных, не требуя написания явного кода обновления SQL.</span><span class="sxs-lookup"><span data-stu-id="1f48a-162">We can use this functionality to easily save the changes back to the database - without having to write any explicit SQL update code.</span></span>

<span data-ttu-id="1f48a-163">Например, в приведенном ниже коде показано, как использовать запрос LINQ для получения одного объекта Dinner из базы данных, обновления двух свойств ужина и сохранения изменений обратно в базу данных:</span><span class="sxs-lookup"><span data-stu-id="1f48a-163">For example, the code below demonstrates how to use a LINQ query to retrieve a single Dinner object from the database, update two of the Dinner properties, and then save the changes back to the database:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample1.cs)]

<span data-ttu-id="1f48a-164">Объект Нерддиннердатаконтекст в приведенном выше коде автоматически отследится от изменений свойств, внесенных в объект ужин, полученный из него.</span><span class="sxs-lookup"><span data-stu-id="1f48a-164">The NerdDinnerDataContext object in the code above automatically tracked the property changes made to the Dinner object we retrieved from it.</span></span> <span data-ttu-id="1f48a-165">При вызове метода "SubmitChanges ()" будет выполнена соответствующая инструкция SQL "UPDATE" в базе данных для сохранения обновленных значений.</span><span class="sxs-lookup"><span data-stu-id="1f48a-165">When we called the "SubmitChanges()" method, it will execute an appropriate SQL "UPDATE" statement to the database to persist the updated values back.</span></span>

### <a name="creating-a-dinnerrepository-class"></a><span data-ttu-id="1f48a-166">Создание класса Диннеррепоситори</span><span class="sxs-lookup"><span data-stu-id="1f48a-166">Creating a DinnerRepository Class</span></span>

<span data-ttu-id="1f48a-167">Для небольших приложений иногда удобно, чтобы контроллеры работали непосредственно с LINQ to SQL классом DataContext и внедрять запросы LINQ в контроллеры.</span><span class="sxs-lookup"><span data-stu-id="1f48a-167">For small applications it is sometimes fine to have Controllers work directly against a LINQ to SQL DataContext class, and embed LINQ queries within the Controllers.</span></span> <span data-ttu-id="1f48a-168">Однако по мере того, как приложения получают больший размер, этот подход довольно громоздким для обслуживания и тестирования.</span><span class="sxs-lookup"><span data-stu-id="1f48a-168">As applications get larger, though, this approach becomes cumbersome to maintain and test.</span></span> <span data-ttu-id="1f48a-169">Это также может привести к дублированию одних и тех же запросов LINQ в нескольких местах.</span><span class="sxs-lookup"><span data-stu-id="1f48a-169">It can also lead to us duplicating the same LINQ queries in multiple places.</span></span>

<span data-ttu-id="1f48a-170">Один из подходов, позволяющих упростить обслуживание и тестирование приложений, заключается в использовании шаблона "репозитория".</span><span class="sxs-lookup"><span data-stu-id="1f48a-170">One approach that can make applications easier to maintain and test is to use a "repository" pattern.</span></span> <span data-ttu-id="1f48a-171">Класс репозитория помогает инкапсулировать запросы данных и логику сохраняемости, а также абстрагирует сведения о реализации сохраняемости данных из приложения.</span><span class="sxs-lookup"><span data-stu-id="1f48a-171">A repository class helps encapsulate data querying and persistence logic, and abstracts away the implementation details of the data persistence from the application.</span></span> <span data-ttu-id="1f48a-172">В дополнение к очистке кода приложения использование шаблона репозитория упрощает изменение реализаций хранилища данных в будущем и помогает выполнять модульное тестирование приложения, не требуя наличия реальной базы данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-172">In addition to making application code cleaner, using a repository pattern can make it easier to change data storage implementations in the future, and it can help facilitate unit testing an application without requiring a real database.</span></span>

<span data-ttu-id="1f48a-173">Для нашего приложения NerdDinner мы определим класс Диннеррепоситори с указанной ниже сигнатурой:</span><span class="sxs-lookup"><span data-stu-id="1f48a-173">For our NerdDinner application we'll define a DinnerRepository class with the below signature:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample2.cs)]

<span data-ttu-id="1f48a-174">*Примечание. Далее в этой главе мы извлеким интерфейс Идиннеррепоситори из этого класса и разберем на наших контроллерах внедрение зависимостей. Тем не менее, начните с простого и просто начните работу непосредственно с классом Диннеррепоситори.*</span><span class="sxs-lookup"><span data-stu-id="1f48a-174">*Note: Later in this chapter we'll extract an IDinnerRepository interface from this class and enable dependency injection with it on our Controllers. To begin with, though, we are going to start simple and just work directly with the DinnerRepository class.*</span></span>

<span data-ttu-id="1f48a-175">Чтобы реализовать этот класс, щелкните правой кнопкой мыши папку Models и выберите команду **Добавить-&gt;создать элемент** меню.</span><span class="sxs-lookup"><span data-stu-id="1f48a-175">To implement this class we'll right-click on our "Models" folder and choose the **Add-&gt;New Item** menu command.</span></span> <span data-ttu-id="1f48a-176">В диалоговом окне "Добавление нового элемента" мы выберем шаблон "class" и назовем имя файла "DinnerRepository.cs":</span><span class="sxs-lookup"><span data-stu-id="1f48a-176">Within the "Add New Item" dialog we'll select the "Class" template and name the file "DinnerRepository.cs":</span></span>

![](build-a-model-with-business-rule-validations/_static/image10.png)

<span data-ttu-id="1f48a-177">Затем мы можем реализовать наш класс Диннеррепоситори, используя приведенный ниже код.</span><span class="sxs-lookup"><span data-stu-id="1f48a-177">We can then implement our DinnerRepository class using the code below:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample3.cs)]

### <a name="retrieving-updating-inserting-and-deleting-using-the-dinnerrepository-class"></a><span data-ttu-id="1f48a-178">Извлечение, обновление, вставка и удаление с помощью класса Диннеррепоситори</span><span class="sxs-lookup"><span data-stu-id="1f48a-178">Retrieving, Updating, Inserting and Deleting using the DinnerRepository class</span></span>

<span data-ttu-id="1f48a-179">Теперь, когда мы создали наш класс Диннеррепоситори, рассмотрим несколько примеров кода, демонстрирующих распространенные задачи, которые мы можем сделать с ним:</span><span class="sxs-lookup"><span data-stu-id="1f48a-179">Now that we've created our DinnerRepository class, let's look at a few code examples that demonstrate common tasks we can do with it:</span></span>

#### <a name="querying-examples"></a><span data-ttu-id="1f48a-180">Примеры запросов</span><span class="sxs-lookup"><span data-stu-id="1f48a-180">Querying Examples</span></span>

<span data-ttu-id="1f48a-181">Приведенный ниже код извлекает один обед, используя значение Диннерид:</span><span class="sxs-lookup"><span data-stu-id="1f48a-181">The code below retrieves a single Dinner using the DinnerID value:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample4.cs)]

<span data-ttu-id="1f48a-182">Приведенный ниже код извлекает все предстоящие диннерс и циклы по ним:</span><span class="sxs-lookup"><span data-stu-id="1f48a-182">The code below retrieves all upcoming dinners and loops over them:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample5.cs)]

#### <a name="insert-and-update-examples"></a><span data-ttu-id="1f48a-183">Примеры для вставки и обновления</span><span class="sxs-lookup"><span data-stu-id="1f48a-183">Insert and Update Examples</span></span>

<span data-ttu-id="1f48a-184">В приведенном ниже коде показано добавление двух новых диннерс.</span><span class="sxs-lookup"><span data-stu-id="1f48a-184">The code below demonstrates adding two new dinners.</span></span> <span data-ttu-id="1f48a-185">Добавление или изменение репозитория не фиксируется в базе данных до тех пор, пока для него не будет вызван метод Save ().</span><span class="sxs-lookup"><span data-stu-id="1f48a-185">Additions/modifications to the repository aren't committed to the database until the "Save()" method is called on it.</span></span> <span data-ttu-id="1f48a-186">LINQ to SQL автоматически заключает все изменения в транзакции базы данных, так что все изменения происходят или ни одна из них не выполняется при сохранении репозитория:</span><span class="sxs-lookup"><span data-stu-id="1f48a-186">LINQ to SQL automatically wraps all changes in a database transaction – so either all changes happen or none of them do when our repository saves:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample6.cs)]

<span data-ttu-id="1f48a-187">Приведенный ниже код извлекает существующий объект Dinnered и изменяет на нем два свойства.</span><span class="sxs-lookup"><span data-stu-id="1f48a-187">The code below retrieves an existing Dinner object, and modifies two properties on it.</span></span> <span data-ttu-id="1f48a-188">Изменения записываются обратно в базу данных, когда в нашем репозитории вызывается метод Save ():</span><span class="sxs-lookup"><span data-stu-id="1f48a-188">The changes are committed back to the database when the "Save()" method is called on our repository:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample7.cs)]

<span data-ttu-id="1f48a-189">Приведенный ниже код извлекает обед, а затем добавляет в него RSVP.</span><span class="sxs-lookup"><span data-stu-id="1f48a-189">The code below retrieves a dinner and then adds an RSVP to it.</span></span> <span data-ttu-id="1f48a-190">Это делается с помощью коллекции RSVP для объекта Dinner, который LINQ to SQL создан для нас (поскольку существует связь «первичный-ключ — внешний ключ» между двумя объектами в базе данных).</span><span class="sxs-lookup"><span data-stu-id="1f48a-190">It does this using the RSVPs collection on the Dinner object that LINQ to SQL created for us (because there is a primary-key/foreign-key relationship between the two in the database).</span></span> <span data-ttu-id="1f48a-191">Это изменение сохраняется в базе данных как новая строка таблицы RSVP при вызове метода "Save ()" в репозитории:</span><span class="sxs-lookup"><span data-stu-id="1f48a-191">This change is persisted back to the database as a new RSVP table row when the "Save()" method is called on the repository:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample8.cs)]

#### <a name="delete-example"></a><span data-ttu-id="1f48a-192">Пример удаления</span><span class="sxs-lookup"><span data-stu-id="1f48a-192">Delete Example</span></span>

<span data-ttu-id="1f48a-193">Приведенный ниже код извлекает существующий объект ужин, а затем помечает его как удаляемый.</span><span class="sxs-lookup"><span data-stu-id="1f48a-193">The code below retrieves an existing Dinner object, and then marks it to be deleted.</span></span> <span data-ttu-id="1f48a-194">При вызове метода "Save ()" в репозитории он будет фиксировать удаление в базе данных:</span><span class="sxs-lookup"><span data-stu-id="1f48a-194">When the "Save()" method is called on the repository it will commit the delete back to the database:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample9.cs)]

### <a name="integrating-validation-and-business-rule-logic-with-model-classes"></a><span data-ttu-id="1f48a-195">Интеграция проверки и логики бизнес-правил с классами модели</span><span class="sxs-lookup"><span data-stu-id="1f48a-195">Integrating Validation and Business Rule Logic with Model Classes</span></span>

<span data-ttu-id="1f48a-196">Интеграция проверки и логики бизнес-правил является ключевой частью любого приложения, которое работает с данными.</span><span class="sxs-lookup"><span data-stu-id="1f48a-196">Integrating validation and business rule logic is a key part of any application that works with data.</span></span>

#### <a name="schema-validation"></a><span data-ttu-id="1f48a-197">Проверка схемы</span><span class="sxs-lookup"><span data-stu-id="1f48a-197">Schema Validation</span></span>

<span data-ttu-id="1f48a-198">Когда классы модели определяются с помощью конструктора LINQ to SQL, типы данных свойств в классах модели данные соответствуют типам данных таблицы базы.</span><span class="sxs-lookup"><span data-stu-id="1f48a-198">When model classes are defined using the LINQ to SQL designer, the datatypes of the properties in the data model classes correspond to the datatypes of the database table.</span></span> <span data-ttu-id="1f48a-199">Например: если столбец «Евентдате» в таблице диннерс имеет значение «DateTime», то класс модели данных, созданный LINQ to SQL, будет иметь тип «DateTime» (встроенный тип данных .NET).</span><span class="sxs-lookup"><span data-stu-id="1f48a-199">For example: if the "EventDate" column in the Dinners table is a "datetime", the data model class created by LINQ to SQL will be of type "DateTime" (which is a built-in .NET datatype).</span></span> <span data-ttu-id="1f48a-200">Это означает, что при попытке присвоить ему целочисленное или логическое значение из кода произойдет ошибка компиляции, и при попытке неявного преобразования недействительного типа строки во время выполнения будет выводиться сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="1f48a-200">This means you will get compile errors if you attempt to assign an integer or boolean to it from code, and it will raise an error automatically if you attempt to implicitly convert a non-valid string type to it at runtime.</span></span>

<span data-ttu-id="1f48a-201">LINQ to SQL также автоматически обрабатывает escape-значения SQL при использовании строк, что позволяет защитить вас от атак путем внедрения кода SQL при его использовании.</span><span class="sxs-lookup"><span data-stu-id="1f48a-201">LINQ to SQL will also automatically handles escaping SQL values for you when using strings - which helps protect you against SQL injection attacks when using it.</span></span>

#### <a name="validation-and-business-rule-logic"></a><span data-ttu-id="1f48a-202">Логика проверки и бизнес-правил</span><span class="sxs-lookup"><span data-stu-id="1f48a-202">Validation and Business Rule Logic</span></span>

<span data-ttu-id="1f48a-203">Проверка схемы полезна в первую очередь, но она редко бывает достаточной.</span><span class="sxs-lookup"><span data-stu-id="1f48a-203">Schema validation is useful as a first step, but is rarely sufficient.</span></span> <span data-ttu-id="1f48a-204">В большинстве реальных сценариев требуется возможность указывать расширенную логику проверки, которая может охватывать несколько свойств, выполнять код и часто имеет осведомленность о состоянии модели (например, создается/упдатед/делетед или в определенном для домена состоянии, например "Архивировано").</span><span class="sxs-lookup"><span data-stu-id="1f48a-204">Most real-world scenarios require the ability to specify richer validation logic that can span multiple properties, execute code, and often have awareness of a model's state (for example: is it being created /updated/deleted, or within a domain-specific state like "archived").</span></span> <span data-ttu-id="1f48a-205">Существует множество различных шаблонов и платформ, которые можно использовать для определения и применения правил проверки к классам модели, и существует несколько платформ на основе .NET, которые можно использовать для помощи в этом.</span><span class="sxs-lookup"><span data-stu-id="1f48a-205">There are a variety of different patterns and frameworks that can be used to define and apply validation rules to model classes, and there are several .NET based frameworks out there that can be used to help with this.</span></span> <span data-ttu-id="1f48a-206">В приложениях ASP.NET MVC можно использовать практически любой из них.</span><span class="sxs-lookup"><span data-stu-id="1f48a-206">You can use pretty much any of them within ASP.NET MVC applications.</span></span>

<span data-ttu-id="1f48a-207">Для нашего приложения NerdDinner мы будем использовать сравнительно простой и прямолинейный шаблон, где мы предоставляем свойство IsValid и метод Жетрулевиолатионс () для нашего объекта модели Dinner.</span><span class="sxs-lookup"><span data-stu-id="1f48a-207">For the purposes of our NerdDinner application, we'll use a relatively simple and straight-forward pattern where we expose an IsValid property and a GetRuleViolations() method on our Dinner model object.</span></span> <span data-ttu-id="1f48a-208">Свойство IsValid возвратит значение true или false в зависимости от того, являются ли допустимыми все проверки и бизнес-правила.</span><span class="sxs-lookup"><span data-stu-id="1f48a-208">The IsValid property will return true or false depending on whether the validation and business rules are all valid.</span></span> <span data-ttu-id="1f48a-209">Метод Жетрулевиолатионс () возвратит список любых ошибок правил.</span><span class="sxs-lookup"><span data-stu-id="1f48a-209">The GetRuleViolations() method will return a list of any rule errors.</span></span>

<span data-ttu-id="1f48a-210">Мы реализуем IsValid и Жетрулевиолатионс () для нашей компании, добавив «частичный класс» в наш проект.</span><span class="sxs-lookup"><span data-stu-id="1f48a-210">We'll implement IsValid and GetRuleViolations() for our Dinner model by adding a "partial class" to our project.</span></span> <span data-ttu-id="1f48a-211">Разделяемые классы можно использовать для добавления методов, свойств и событий в классы, поддерживаемые конструктором VS (например, класс Dinner, созданный конструктором LINQ to SQL), и помогает избежать перепутать средство с нашим кодом.</span><span class="sxs-lookup"><span data-stu-id="1f48a-211">Partial classes can be used to add methods/properties/events to classes maintained by a VS designer (like the Dinner class generated by the LINQ to SQL designer) and help avoid the tool from messing with our code.</span></span> <span data-ttu-id="1f48a-212">Можно добавить в наш проект новый разделяемый класс, щелкнув правой кнопкой мыши папку \Моделс, а затем выбрав команду "добавить новый элемент".</span><span class="sxs-lookup"><span data-stu-id="1f48a-212">We can add a new partial class to our project by right-clicking on the \Models folder, and then select the "Add New Item" menu command.</span></span> <span data-ttu-id="1f48a-213">Затем можно выбрать шаблон "класс" в диалоговом окне "Добавление нового элемента" и присвоить ему имя Dinner.cs.</span><span class="sxs-lookup"><span data-stu-id="1f48a-213">We can then choose the "Class" template within the "Add New Item" dialog and name it Dinner.cs.</span></span>

![](build-a-model-with-business-rule-validations/_static/image11.png)

<span data-ttu-id="1f48a-214">Нажатие кнопки "Добавить" добавит файл Dinner.cs в наш проект и откроет его в интегрированной среде разработки.</span><span class="sxs-lookup"><span data-stu-id="1f48a-214">Clicking the "Add" button will add a Dinner.cs file to our project and open it within the IDE.</span></span> <span data-ttu-id="1f48a-215">Затем можно реализовать базовую платформу применения правил или проверки, используя приведенный ниже код.</span><span class="sxs-lookup"><span data-stu-id="1f48a-215">We can then implement a basic rule/validation enforcement framework using the below code:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample10.cs)]

<span data-ttu-id="1f48a-216">Несколько замечаний о приведенном выше коде:</span><span class="sxs-lookup"><span data-stu-id="1f48a-216">A few notes about the above code:</span></span>

- <span data-ttu-id="1f48a-217">Класс ужин предшествует ключевому слову "partial" — это означает, что код, содержащийся в нем, будет сочетаться с классом, созданным или обслуживаемым конструктором LINQ to SQL и скомпилированным в один класс.</span><span class="sxs-lookup"><span data-stu-id="1f48a-217">The Dinner class is prefaced with a "partial" keyword – which means the code contained within it will be combined with the class generated/maintained by the LINQ to SQL designer and compiled into a single class.</span></span>
- <span data-ttu-id="1f48a-218">Класс Рулевиолатион — это вспомогательный класс, который будет добавлен в проект, позволяющий предоставлять дополнительные сведения о нарушении правил.</span><span class="sxs-lookup"><span data-stu-id="1f48a-218">The RuleViolation class is a helper class we'll add to the project that allows us to provide more details about a rule violation.</span></span>
- <span data-ttu-id="1f48a-219">Метод компании Dinner. Жетрулевиолатионс () приводит к вычислению нашей проверки и бизнес-правил (мы будем их реализовывать чуть позже).</span><span class="sxs-lookup"><span data-stu-id="1f48a-219">The Dinner.GetRuleViolations() method causes our validation and business rules to be evaluated (we'll implement them shortly).</span></span> <span data-ttu-id="1f48a-220">Затем он возвращает последовательность объектов Рулевиолатион, которые предоставляют дополнительные сведения об ошибках правил.</span><span class="sxs-lookup"><span data-stu-id="1f48a-220">It then returns back a sequence of RuleViolation objects that provide more details about any rule errors.</span></span>
- <span data-ttu-id="1f48a-221">Свойство "ужин. IsValid" предоставляет удобное вспомогательное свойство, которое указывает, имеет ли объект ужин какие-либо активные Рулевиолатионс.</span><span class="sxs-lookup"><span data-stu-id="1f48a-221">The Dinner.IsValid property provides a convenient helper property that indicates whether the Dinner object has any active RuleViolations.</span></span> <span data-ttu-id="1f48a-222">Он может быть заранее проверен разработчиком с помощью объекта Dinner в любое время (и не создает исключение).</span><span class="sxs-lookup"><span data-stu-id="1f48a-222">It can be proactively checked by a developer using the Dinner object at anytime (and does not raise an exception).</span></span>
- <span data-ttu-id="1f48a-223">Частичный метод компании Dinner. OnValidate () является обработчиком, который LINQ to SQL предоставляет, что позволяет получать уведомления всякий раз, когда объект Dinner собирается сохраняться в базе данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-223">The Dinner.OnValidate() partial method is a hook that LINQ to SQL provides that allows us to be notified anytime the Dinner object is about to be persisted within the database.</span></span> <span data-ttu-id="1f48a-224">Приведенная выше реализация OnValidate () гарантирует, что ужин не Рулевиолатионс перед сохранением.</span><span class="sxs-lookup"><span data-stu-id="1f48a-224">Our OnValidate() implementation above ensures that the Dinner has no RuleViolations before it is saved.</span></span> <span data-ttu-id="1f48a-225">Если он находится в недопустимом состоянии, вызывается исключение, которое приведет к LINQ to SQL прервать транзакцию.</span><span class="sxs-lookup"><span data-stu-id="1f48a-225">If it is in an invalid state it raises an exception, which will cause LINQ to SQL to abort the transaction.</span></span>

<span data-ttu-id="1f48a-226">Такой подход обеспечивает простую платформу, в которую можно интегрировать проверку и бизнес-правила.</span><span class="sxs-lookup"><span data-stu-id="1f48a-226">This approach provides a simple framework that we can integrate validation and business rules into.</span></span> <span data-ttu-id="1f48a-227">Теперь давайте добавим приведенные ниже правила в метод Жетрулевиолатионс ():</span><span class="sxs-lookup"><span data-stu-id="1f48a-227">For now let's add the below rules to our GetRuleViolations() method:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample11.cs)]

<span data-ttu-id="1f48a-228">Мы используем функцию yield return C# в, чтобы вернуть последовательность любых рулевиолатионс.</span><span class="sxs-lookup"><span data-stu-id="1f48a-228">We are using the "yield return" feature of C# to return a sequence of any RuleViolations.</span></span> <span data-ttu-id="1f48a-229">Первые шесть проверок правил выше просто обеспечивают, что строковые свойства в ужине не могут иметь значение null или быть пустыми.</span><span class="sxs-lookup"><span data-stu-id="1f48a-229">The first six rule checks above simply enforce that string properties on our Dinner cannot be null or empty.</span></span> <span data-ttu-id="1f48a-230">Последнее правило является несколько более интересным и вызывает вспомогательный метод Фоневалидатор. Исвалиднумбер (), который можно добавить в наш проект, чтобы проверить, соответствует ли формат номера Контактфоне странам компании Dinner.</span><span class="sxs-lookup"><span data-stu-id="1f48a-230">The last rule is a little more interesting, and calls a PhoneValidator.IsValidNumber() helper method that we can add to our project to verify that the ContactPhone number format matches the Dinner's country.</span></span>

<span data-ttu-id="1f48a-231">Мы можем использовать. Поддержка регулярных выражений NET для реализации этой поддержки проверки телефона.</span><span class="sxs-lookup"><span data-stu-id="1f48a-231">We can use .NET's regular expression support to implement this phone validation support.</span></span> <span data-ttu-id="1f48a-232">Ниже приведена простая реализация Фоневалидатор, которую можно добавить в наш проект, что позволяет добавлять проверки шаблона регулярных выражений, зависящих от страны:</span><span class="sxs-lookup"><span data-stu-id="1f48a-232">Below is a simple PhoneValidator implementation that we can add to our project that enables us to add country-specific Regex pattern checks:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample12.cs)]

#### <a name="handling-validation-and-business-logic-violations"></a><span data-ttu-id="1f48a-233">Обработка нарушений проверки и бизнес-логики</span><span class="sxs-lookup"><span data-stu-id="1f48a-233">Handling Validation and Business Logic Violations</span></span>

<span data-ttu-id="1f48a-234">Теперь, когда мы добавили приведенный выше код проверки и бизнес-правила, каждый раз при попытке создать или обновить обед будут оценены и применены правила логики проверки.</span><span class="sxs-lookup"><span data-stu-id="1f48a-234">Now that we've added the above validation and business rule code, any time we try to create or update a Dinner, our validation logic rules will be evaluated and enforced.</span></span>

<span data-ttu-id="1f48a-235">Разработчики могут написать код, подобный приведенному ниже, чтобы заранее определить, является ли объект ужин допустимым, и получить список всех нарушений в нем без вызова исключений.</span><span class="sxs-lookup"><span data-stu-id="1f48a-235">Developers can write code like below to proactively determine if a Dinner object is valid, and retrieve a list of all violations in it without raising any exceptions:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample13.cs)]

<span data-ttu-id="1f48a-236">При попытке сохранить ужин в недопустимом состоянии будет вызвано исключение при вызове метода Save () для Диннеррепоситори.</span><span class="sxs-lookup"><span data-stu-id="1f48a-236">If we attempt to save a Dinner in an invalid state, an exception will be raised when we call the Save() method on the DinnerRepository.</span></span> <span data-ttu-id="1f48a-237">Это происходит потому, что LINQ to SQL автоматически вызывает разделяемый метод Dinner. OnValidate (), прежде чем он сохраняет изменения компании Dinnered, и мы добавили код в ужин. OnValidate (), чтобы вызвать исключение, если на обеде существуют какие-либо нарушения правил.</span><span class="sxs-lookup"><span data-stu-id="1f48a-237">This occurs because LINQ to SQL automatically calls our Dinner.OnValidate() partial method before it saves the Dinner's changes, and we added code to Dinner.OnValidate() to raise an exception if any rule violations exist in the Dinner.</span></span> <span data-ttu-id="1f48a-238">Мы можем перехватить это исключение и в активном состоянии получить список нарушений для исправления:</span><span class="sxs-lookup"><span data-stu-id="1f48a-238">We can catch this exception and reactively retrieve a list of the violations to fix:</span></span>

[!code-csharp[Main](build-a-model-with-business-rule-validations/samples/sample14.cs)]

<span data-ttu-id="1f48a-239">Так как наши проверки и бизнес-правила реализуются на уровне модели, а не на уровне пользовательского интерфейса, они будут применены и использованы во всех сценариях приложения.</span><span class="sxs-lookup"><span data-stu-id="1f48a-239">Because our validation and business rules are implemented within our model layer, and not within the UI layer, they will be applied and used across all scenarios within our application.</span></span> <span data-ttu-id="1f48a-240">Позже мы можем изменить или добавить бизнес-правила, и весь код, который работает с нашими объектами компании, учитывает их.</span><span class="sxs-lookup"><span data-stu-id="1f48a-240">We can later change or add business rules and have all code that works with our Dinner objects honor them.</span></span>

<span data-ttu-id="1f48a-241">Благодаря возможности изменять бизнес-правила в одном месте, не внося этих изменений в приложения и логику пользовательского интерфейса, это знакомство с хорошо написанным приложением и преимущество, которое может помочь платформе MVC.</span><span class="sxs-lookup"><span data-stu-id="1f48a-241">Having the flexibility to change business rules in one place, without having these changes ripple throughout the application and UI logic, is a sign of a well-written application, and a benefit that an MVC framework helps encourage.</span></span>

### <a name="next-step"></a><span data-ttu-id="1f48a-242">Следующий шаг</span><span class="sxs-lookup"><span data-stu-id="1f48a-242">Next Step</span></span>

<span data-ttu-id="1f48a-243">Теперь у нас есть модель, которую можно использовать для запроса и обновления нашей базы данных.</span><span class="sxs-lookup"><span data-stu-id="1f48a-243">We've now got a model that we can use to both query and update our database.</span></span>

<span data-ttu-id="1f48a-244">Теперь добавим в проект некоторые контроллеры и представления, которые можно использовать для создания пользовательского интерфейса HTML.</span><span class="sxs-lookup"><span data-stu-id="1f48a-244">Let's now add some controllers and views to the project that we can use to build an HTML UI experience around it.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="1f48a-245">[Назад](create-a-database.md)
> [Вперед](use-controllers-and-views-to-implement-a-listingdetails-ui.md)</span><span class="sxs-lookup"><span data-stu-id="1f48a-245">[Previous](create-a-database.md)
[Next](use-controllers-and-views-to-implement-a-listingdetails-ui.md)</span></span>
