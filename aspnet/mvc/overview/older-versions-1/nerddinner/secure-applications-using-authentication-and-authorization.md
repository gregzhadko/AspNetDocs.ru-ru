---
uid: mvc/overview/older-versions-1/nerddinner/secure-applications-using-authentication-and-authorization
title: Защита приложений с помощью проверки подлинности и авторизации | Документация Майкрософт
author: microsoft
description: На шаге 9 показано, как добавить проверку подлинности и авторизацию для обеспечения безопасности приложения NerdDinner, чтобы пользователи могли зарегистрироваться и войти на сайт для создания...
ms.author: riande
ms.date: 07/27/2010
ms.assetid: 9e4d5cac-b071-440c-b044-20b6d0c964fb
msc.legacyurl: /mvc/overview/older-versions-1/nerddinner/secure-applications-using-authentication-and-authorization
msc.type: authoredcontent
ms.openlocfilehash: 8d509c5f15bb4d5014e53b8dc2a736454238e72c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78486426"
---
# <a name="secure-applications-using-authentication-and-authorization"></a><span data-ttu-id="ceeb7-103">Защита приложений с помощью проверки подлинности и авторизации</span><span class="sxs-lookup"><span data-stu-id="ceeb7-103">Secure Applications Using Authentication and Authorization</span></span>

<span data-ttu-id="ceeb7-104">по [Майкрософт](https://github.com/microsoft)</span><span class="sxs-lookup"><span data-stu-id="ceeb7-104">by [Microsoft](https://github.com/microsoft)</span></span>

[<span data-ttu-id="ceeb7-105">Скачать в формате PDF</span><span class="sxs-lookup"><span data-stu-id="ceeb7-105">Download PDF</span></span>](http://aspnetmvcbook.s3.amazonaws.com/aspnetmvc-nerdinner_v1.pdf)

> <span data-ttu-id="ceeb7-106">Это шаг 9 из бесплатного [учебника по приложению "NerdDinner"](introducing-the-nerddinner-tutorial.md) , в котором рассматривается создание небольшого, но полного веб-приложения с использованием ASP.NET MVC 1.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-106">This is step 9 of a free ["NerdDinner" application tutorial](introducing-the-nerddinner-tutorial.md) that walks-through how to build a small, but complete, web application using ASP.NET MVC 1.</span></span>
> 
> <span data-ttu-id="ceeb7-107">На шаге 9 показано, как добавить проверку подлинности и авторизацию для защиты нашего приложения NerdDinner, чтобы пользователям было необходимо зарегистрировать сайт и войти на него, чтобы создать новый диннерс, и только пользователь, который размещает обед, сможет изменить его позже.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-107">Step 9 shows how to add authentication and authorization to secure our NerdDinner application, so that users need to register and login to the site to create new dinners, and only the user who is hosting a dinner can edit it later.</span></span>
> 
> <span data-ttu-id="ceeb7-108">Если вы используете ASP.NET MVC 3, мы рекомендуем следовать руководствам по [Начало работы в MVC 3 или в приложении для](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) [музыкального магазина MVC](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) .</span><span class="sxs-lookup"><span data-stu-id="ceeb7-108">If you are using ASP.NET MVC 3, we recommend you follow the [Getting Started With MVC 3](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) or [MVC Music Store](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) tutorials.</span></span>

## <a name="nerddinner-step-9-authentication-and-authorization"></a><span data-ttu-id="ceeb7-109">NerdDinner шаг 9. Проверка подлинности и авторизация</span><span class="sxs-lookup"><span data-stu-id="ceeb7-109">NerdDinner Step 9: Authentication and Authorization</span></span>

<span data-ttu-id="ceeb7-110">Сейчас наше приложение NerdDinner предоставляет всем посетителям сайта возможность создавать и изменять сведения о любом обеде.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-110">Right now our NerdDinner application grants anyone visiting the site the ability to create and edit the details of any dinner.</span></span> <span data-ttu-id="ceeb7-111">Давайте изменим это, чтобы пользователи могли регистрироваться на сайте и входить на него, чтобы создать новый диннерс, и добавить ограничение, чтобы его можно было изменить только у пользователя, размещающего обед.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-111">Let's change this so that users need to register and login to the site to create new dinners, and add a restriction so that only the user who is hosting a dinner can edit it later.</span></span>

<span data-ttu-id="ceeb7-112">Чтобы сделать это, мы будем использовать проверку подлинности и авторизацию для защиты нашего приложения.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-112">To enable this we'll use authentication and authorization to secure our application.</span></span>

### <a name="understanding-authentication-and-authorization"></a><span data-ttu-id="ceeb7-113">Общие сведения о проверке подлинности и авторизации</span><span class="sxs-lookup"><span data-stu-id="ceeb7-113">Understanding Authentication and Authorization</span></span>

<span data-ttu-id="ceeb7-114">*Проверка подлинности* — это процесс идентификации и проверки удостоверения клиента, обращающегося к приложению.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-114">*Authentication* is the process of identifying and validating the identity of a client accessing an application.</span></span> <span data-ttu-id="ceeb7-115">Говоря более просто, это означает, что пользователь, который является конечным пользователем, посещает веб-сайт.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-115">Put more simply, it is about identifying "who" the end-user is when they visit a website.</span></span> <span data-ttu-id="ceeb7-116">ASP.NET поддерживает несколько способов проверки подлинности пользователей браузера.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-116">ASP.NET supports multiple ways to authenticate browser users.</span></span> <span data-ttu-id="ceeb7-117">Для веб-приложений в Интернете наиболее распространенный способ проверки подлинности называется "Проверка подлинности с помощью форм".</span><span class="sxs-lookup"><span data-stu-id="ceeb7-117">For Internet web applications, the most common authentication approach used is called "Forms Authentication".</span></span> <span data-ttu-id="ceeb7-118">Проверка подлинности с помощью форм позволяет разработчику создать форму входа в HTML в своем приложении, а затем проверить имя пользователя и пароль, отправляемые конечным пользователем для базы данных или другого хранилища учетных данных пароля.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-118">Forms Authentication enables a developer to author an HTML login form within their application, and then validate the username/password an end-user submits against a database or other password credential store.</span></span> <span data-ttu-id="ceeb7-119">Если задано правильное сочетание имени пользователя и пароля, разработчик может попросить ASP.NET выдать зашифрованный файл cookie HTTP, чтобы указать пользователя в будущих запросах.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-119">If the username/password combination is correct, the developer can then ask ASP.NET to issue an encrypted HTTP cookie to identify the user across future requests.</span></span> <span data-ttu-id="ceeb7-120">Мы будем использовать проверку подлинности с помощью форм в нашем приложении NerdDinner.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-120">We'll by using forms authentication with our NerdDinner application.</span></span>

<span data-ttu-id="ceeb7-121">*Авторизация* — это процесс определения того, имеет ли прошедший проверку подлинности пользователя разрешение на доступ к определенному URL-адресу или ресурсу или выполнение какого-либо действия.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-121">*Authorization* is the process of determining whether an authenticated user has permission to access a particular URL/resource or to perform some action.</span></span> <span data-ttu-id="ceeb7-122">Например, в нашем приложении NerdDinner мы хотим авторизовать, чтобы только пользователи, которые вошли в систему, могли получить доступ к URL-адресу */диннерс/креате* и создать новый диннерс.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-122">For example, within our NerdDinner application we'll want to authorize that only users who are logged in can access the */Dinners/Create* URL and create new Dinners.</span></span> <span data-ttu-id="ceeb7-123">Мы также хотим добавить логику авторизации, чтобы только пользователь, который размещает обед, мог редактировать его — и запрещать доступ на редактирование всем остальным пользователям.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-123">We'll also want to add authorization logic so that only the user who is hosting a dinner can edit it – and deny edit access to all other users.</span></span>

### <a name="forms-authentication-and-the-accountcontroller"></a><span data-ttu-id="ceeb7-124">Проверка подлинности с помощью форм и AccountController</span><span class="sxs-lookup"><span data-stu-id="ceeb7-124">Forms Authentication and the AccountController</span></span>

<span data-ttu-id="ceeb7-125">Шаблон проекта Visual Studio по умолчанию для ASP.NET MVC автоматически включает проверку подлинности на формах при создании новых приложений ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-125">The default Visual Studio project template for ASP.NET MVC automatically enables forms authentication when new ASP.NET MVC applications are created.</span></span> <span data-ttu-id="ceeb7-126">Он также автоматически добавляет в проект предварительно созданную реализацию страницы входа в учетную запись, что упрощает интеграцию безопасности в пределах сайта.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-126">It also automatically adds a pre-built account login page implementation to the project – which makes it really easy to integrate security within a site.</span></span>

<span data-ttu-id="ceeb7-127">В верхней правой части веб-страницы Site. master по умолчанию отображается ссылка для входа в систему, когда пользователь, обращающийся к нему, не прошел проверку подлинности:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-127">The default Site.master master page displays a "Log On" link at the top-right of the site when the user accessing it is not authenticated:</span></span>

![](secure-applications-using-authentication-and-authorization/_static/image1.png)

<span data-ttu-id="ceeb7-128">Щелкните ссылку "вход", чтобы перейти на URL-адрес */аккаунт/Логон* :</span><span class="sxs-lookup"><span data-stu-id="ceeb7-128">Clicking the "Log On" link takes a user to the */Account/LogOn* URL:</span></span>

![](secure-applications-using-authentication-and-authorization/_static/image2.png)

<span data-ttu-id="ceeb7-129">Посетители, которые не зарегистрировались, могут сделать это, щелкнув ссылку «Register» (зарегистрировать), которая переберет их на URL-адрес */аккаунт/регистер* и позволит им ввести сведения об учетной записи:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-129">Visitors who haven't registered can do so by clicking the "Register" link – which will take them to the */Account/Register* URL and allow them to enter account details:</span></span>

![](secure-applications-using-authentication-and-authorization/_static/image3.png)

<span data-ttu-id="ceeb7-130">Нажатие кнопки "зарегистрировать" приведет к созданию нового пользователя в системе членства в ASP.NET и проверке подлинности пользователя на сайте с использованием проверки подлинности с помощью форм.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-130">Clicking the "Register" button will create a new user within the ASP.NET Membership system, and authenticate the user onto the site using forms authentication.</span></span>

<span data-ttu-id="ceeb7-131">Когда пользователь входит в систему, site. master изменяет правый верхний край страницы, выводит «Welcome [имя_пользователя]!».</span><span class="sxs-lookup"><span data-stu-id="ceeb7-131">When a user is logged-in, the Site.master changes the top-right of the page to output a "Welcome [username]!"</span></span> <span data-ttu-id="ceeb7-132">сообщение и готовит к просмотру ссылку "выход из системы" вместо "входа".</span><span class="sxs-lookup"><span data-stu-id="ceeb7-132">message and renders a "Log Off" link instead of a "Log On" one.</span></span> <span data-ttu-id="ceeb7-133">Щелкнув ссылку "Завершение сеанса", вы выйдете из системы для пользователя:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-133">Clicking the "Log Off" link logs out the user:</span></span>

![](secure-applications-using-authentication-and-authorization/_static/image4.png)

<span data-ttu-id="ceeb7-134">Приведенные выше функции входа, выхода и регистрации реализуются в классе AccountController, который был добавлен в проект Visual Studio при создании проекта.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-134">The above login, logout, and registration functionality is implemented within the AccountController class that was added to our project by Visual Studio when it created the project.</span></span> <span data-ttu-id="ceeb7-135">Пользовательский интерфейс для AccountController реализуется с помощью шаблонов представлений в каталоге \Виевс\аккаунт:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-135">The UI for the AccountController is implemented using view templates within the \Views\Account directory:</span></span>

![](secure-applications-using-authentication-and-authorization/_static/image5.png)

<span data-ttu-id="ceeb7-136">Класс AccountController использует систему проверки подлинности форм ASP.NET для выдаче зашифрованных файлов cookie проверки подлинности, а также API членства ASP.NET для хранения и проверки имен пользователей и паролей.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-136">The AccountController class uses the ASP.NET Forms Authentication system to issue encrypted authentication cookies, and the ASP.NET Membership API to store and validate usernames/passwords.</span></span> <span data-ttu-id="ceeb7-137">API членства ASP.NET является расширяемым и позволяет использовать любое хранилище учетных данных паролей.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-137">The ASP.NET Membership API is extensible and enables any password credential store to be used.</span></span> <span data-ttu-id="ceeb7-138">ASP.NET поставляется со встроенными реализациями поставщиков членства, которые хранят имена пользователей и пароли в базе данных SQL или в пределах Active Directory.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-138">ASP.NET ships with built-in membership provider implementations that store username/passwords within a SQL database, or within Active Directory.</span></span>

<span data-ttu-id="ceeb7-139">Мы можем настроить, какой поставщик членства должен использовать наше приложение NerdDinner, открыв файл Web. config в корне проекта и найдя в нем раздел &lt;членства&gt;.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-139">We can configure which membership provider our NerdDinner application should use by opening the "web.config" file at the root of the project and looking for the &lt;membership&gt; section within it.</span></span> <span data-ttu-id="ceeb7-140">Файл Web. config по умолчанию, добавленный при создании проекта, регистрирует поставщик членства SQL и настраивает его для использования строки подключения с именем "ApplicationServices" для указания расположения базы данных.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-140">The default web.config added when the project was created registers the SQL membership provider, and configures it to use a connection-string named "ApplicationServices" to specify the database location.</span></span>

<span data-ttu-id="ceeb7-141">Строка подключения "ApplicationServices" по умолчанию (которая указана в разделе &lt;connectionString&gt; в файле Web. config) настроена для использования экспресс-выпуска SQL.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-141">The default "ApplicationServices" connection string (which is specified within the &lt;connectionStrings&gt; section of the web.config file) is configured to use SQL Express.</span></span> <span data-ttu-id="ceeb7-142">Он указывает на базу данных SQL Express с именем ASPNETDB. MDF "в каталоге приложения" Application\_Data ".</span><span class="sxs-lookup"><span data-stu-id="ceeb7-142">It points to a SQL Express database named "ASPNETDB.MDF" under the application's "App\_Data" directory.</span></span> <span data-ttu-id="ceeb7-143">Если эта база данных не существует в первый раз, когда в приложении будет использоваться API членства, ASP.NET автоматически создаст базу данных и подготавливает в ней соответствующую схему базы данных членства:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-143">If this database doesn't exist the first time the Membership API is used within the application, ASP.NET will automatically create the database and provision the appropriate membership database schema within it:</span></span>

![](secure-applications-using-authentication-and-authorization/_static/image6.png)

<span data-ttu-id="ceeb7-144">Если вместо использования SQL Express требуется использовать полный экземпляр SQL Server (или подключиться к удаленной базе данных), нам нужно только обновить строку подключения "ApplicationServices" в файле Web. config и убедиться, что соответствующая схема членства был добавлен в базу данных, на которую он указывает.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-144">If instead of using SQL Express we wanted to use a full SQL Server instance (or connect to a remote database), all we'd need to-do is to update the "ApplicationServices" connection string within the web.config file and make sure that the appropriate membership schema has been added to the database it points at.</span></span> <span data-ttu-id="ceeb7-145">Вы можете запустить служебную программу "ASPNET\_регскл. exe" в каталоге \Windows\Microsoft.NET\Framework\v2.0.50727\, чтобы добавить соответствующую схему членства и другие службы приложений ASP.NET в базу данных.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-145">You can run the "aspnet\_regsql.exe" utility within the \Windows\Microsoft.NET\Framework\v2.0.50727\ directory to add the appropriate schema for membership and the other ASP.NET application services to a database.</span></span>

### <a name="authorizing-the-dinnerscreate-url-using-the-authorize-filter"></a><span data-ttu-id="ceeb7-146">Авторизация URL-адреса/диннерс/креате с помощью фильтра [авторизовать]</span><span class="sxs-lookup"><span data-stu-id="ceeb7-146">Authorizing the /Dinners/Create URL using the [Authorize] filter</span></span>

<span data-ttu-id="ceeb7-147">Нам не пришлось писать код для обеспечения безопасной реализации проверки подлинности и управления учетными записями для приложения NerdDinner.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-147">We didn't have to write any code to enable a secure authentication and account management implementation for the NerdDinner application.</span></span> <span data-ttu-id="ceeb7-148">Пользователи могут регистрировать новые учетные записи в нашем приложении, а также выполнять вход и выход сайта.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-148">Users can register new accounts with our application, and login/logout of the site.</span></span>

<span data-ttu-id="ceeb7-149">Теперь мы можем добавить логику авторизации в приложение и использовать состояние проверки подлинности и имена пользователей для управления тем, что они могут и не могут делать на сайте.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-149">Now we can add authorization logic to the application, and use the authentication status and username of visitors to control what they can and can't do within the site.</span></span> <span data-ttu-id="ceeb7-150">Начнем с добавления логики авторизации к методам действия "создать" для нашего класса Диннерсконтроллер.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-150">Let's begin by adding authorization logic to the "Create" action methods of our DinnersController class.</span></span> <span data-ttu-id="ceeb7-151">В частности, потребуется войти в систему пользователей, обращающихся к URL-адресу */диннерс/креате* .</span><span class="sxs-lookup"><span data-stu-id="ceeb7-151">Specifically, we will require that users accessing the */Dinners/Create* URL must be logged in.</span></span> <span data-ttu-id="ceeb7-152">Если они не вошли в систему, мы будем перенаправлять их на страницу входа, чтобы они могли выполнить вход.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-152">If they aren't logged in we'll redirect them to the login page so that they can sign-in.</span></span>

<span data-ttu-id="ceeb7-153">Реализовать эту логику довольно просто.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-153">Implementing this logic is pretty easy.</span></span> <span data-ttu-id="ceeb7-154">Все, что нам нужно, — добавить атрибут фильтра [авторизовать] к нашим методам создания действия, например:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-154">All we need to-do is to add an [Authorize] filter attribute to our Create action methods like so:</span></span>

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample1.cs)]

<span data-ttu-id="ceeb7-155">ASP.NET MVC поддерживает возможность создания фильтров действий, которые можно использовать для реализации повторно используемой логики, которая может быть декларативно применена к методам действий.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-155">ASP.NET MVC supports the ability to create "action filters" that can be used to implement re-usable logic that can be declaratively applied to action methods.</span></span> <span data-ttu-id="ceeb7-156">Фильтр [авторизовать] является одним из встроенных фильтров действий, предоставляемых ASP.NET MVC, и позволяет разработчику декларативно применять правила авторизации к методам действий и классам контроллеров.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-156">The [Authorize] filter is one of the built-in action filters provided by ASP.NET MVC, and it enables a developer to declaratively apply authorization rules to action methods and controller classes.</span></span>

<span data-ttu-id="ceeb7-157">При применении без каких-либо параметров (как и выше) фильтр [авторизовать] применяет, чтобы пользователь, выполняющий запрос метода действия, вошел в систему — и автоматически перенаправит браузер на URL-адрес входа, если они отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-157">When applied without any parameters (like above) the [Authorize] filter enforces that the user making the action method request must be logged in – and it will automatically redirect the browser to the login URL if they aren't.</span></span> <span data-ttu-id="ceeb7-158">При этом перенаправлении изначально запрошенный URL-адрес передается как аргумент QueryString (например:/аккаунт/Логон? ReturnUrl =% 2fDinners% 2fCreate).</span><span class="sxs-lookup"><span data-stu-id="ceeb7-158">When doing this redirect the originally requested URL is passed as a querystring argument (for example: /Account/LogOn?ReturnUrl=%2fDinners%2fCreate).</span></span> <span data-ttu-id="ceeb7-159">AccountController перенаправит пользователя обратно к первоначально запрошенному URL-адресу после входа.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-159">The AccountController will then redirect the user back to the originally requested URL once they login.</span></span>

<span data-ttu-id="ceeb7-160">Фильтр [авторизовать] позволяет указать свойство "Пользователи" или "роли", которое может использоваться, чтобы требовать, чтобы пользователь вошел в систему и в список разрешенных пользователей или член разрешенной роли безопасности.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-160">The [Authorize] filter optionally supports the ability to specify a "Users" or "Roles" property that can be used to require that the user is both logged in and within a list of allowed users or a member of an allowed security role.</span></span> <span data-ttu-id="ceeb7-161">Например, приведенный ниже код позволяет получить доступ к URL-адресу/диннерс/креате только для двух конкретных пользователей — "scottgu" и "биллг":</span><span class="sxs-lookup"><span data-stu-id="ceeb7-161">For example, the code below only allows two specific users, "scottgu" and "billg", to access the /Dinners/Create URL:</span></span>

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample2.cs)]

<span data-ttu-id="ceeb7-162">Внедрение конкретных имен пользователей в код, тем не менее, может оказаться довольно недоступным для обслуживания.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-162">Embedding specific user names within code tends to be pretty un-maintainable though.</span></span> <span data-ttu-id="ceeb7-163">Лучшим подходом является определение "ролей" более высокого уровня, с которыми проверяется код, а затем сопоставление пользователей с ролью с помощью базы данных или системы Active Directory (включение фактического списка сопоставлений пользователей во внешнем хранении из кода).</span><span class="sxs-lookup"><span data-stu-id="ceeb7-163">A better approach is to define higher-level "roles" that the code checks against, and then to map users into the role using either a database or active directory system (enabling the actual user mapping list to be stored externally from the code).</span></span> <span data-ttu-id="ceeb7-164">ASP.NET включает встроенный API управления ролями, а также встроенный набор поставщиков ролей (в том числе для SQL и Active Directory), которые могут помочь в этом сопоставлении пользователей и ролей.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-164">ASP.NET includes a built-in role management API as well as a built-in set of role providers (including ones for SQL and Active Directory) that can help perform this user/role mapping.</span></span> <span data-ttu-id="ceeb7-165">Затем можно обновить код, чтобы разрешить доступ к URL-адресу/диннерс/креате только пользователям с определенной ролью "admin":</span><span class="sxs-lookup"><span data-stu-id="ceeb7-165">We could then update the code to only allow users within a specific "admin" role to access the /Dinners/Create URL:</span></span>

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample3.cs)]

### <a name="using-the-useridentityname-property-when-creating-dinners"></a><span data-ttu-id="ceeb7-166">Использование свойства User.Identity.Name при создании диннерс</span><span class="sxs-lookup"><span data-stu-id="ceeb7-166">Using the User.Identity.Name property when Creating Dinners</span></span>

<span data-ttu-id="ceeb7-167">Можно получить имя пользователя запроса, вошедшего в систему, с помощью свойства User.Identity.Name, доступного в базовом классе контроллера.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-167">We can retrieve the username of the currently logged-in user of a request using the User.Identity.Name property exposed on the Controller base class.</span></span>

<span data-ttu-id="ceeb7-168">Ранее, когда мы реализовали версию метода действия Create () HTTP-POST, мы имели жесткую строку со свойством "Хостедби" компании Dinner.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-168">Earlier when we implemented the HTTP-POST version of our Create() action method we had hardcoded the "HostedBy" property of the Dinner to a static string.</span></span> <span data-ttu-id="ceeb7-169">Теперь можно обновить этот код, чтобы вместо этого использовать свойство User.Identity.Name, а также автоматически добавить RSVP для узла, создающего ужин:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-169">We can now update this code to instead use the User.Identity.Name property, as well as automatically add an RSVP for the host creating the Dinner:</span></span>

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample4.cs)]

<span data-ttu-id="ceeb7-170">Поскольку мы добавили атрибут [авторизовать] в метод Create (), ASP.NET MVC гарантирует, что метод действия выполняется только в том случае, если пользователь, посещающий URL-адрес/диннерс/креате, вошел в систему на сайте.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-170">Because we have added an [Authorize] attribute to the Create() method, ASP.NET MVC ensures that the action method only executes if the user visiting the /Dinners/Create URL is logged in on the site.</span></span> <span data-ttu-id="ceeb7-171">Таким образом, значение свойства User.Identity.Name всегда будет содержать допустимое имя пользователя.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-171">As such, the User.Identity.Name property value will always contain a valid username.</span></span>

### <a name="using-the-useridentityname-property-when-editing-dinners"></a><span data-ttu-id="ceeb7-172">Использование свойства User.Identity.Name при редактировании диннерс</span><span class="sxs-lookup"><span data-stu-id="ceeb7-172">Using the User.Identity.Name property when Editing Dinners</span></span>

<span data-ttu-id="ceeb7-173">Теперь добавим некоторую логику авторизации, запрещающую пользователей, чтобы они могли изменять только свойства диннерс, на которых они размещены.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-173">Let's now add some authorization logic that restricts users so that they can only edit the properties of dinners they themselves are hosting.</span></span>

<span data-ttu-id="ceeb7-174">Для этого мы сначала добавим вспомогательный метод "Ишостедби (username)" в наш объект Dinner (внутри разделяемого класса Dinner.cs, который мы создали ранее).</span><span class="sxs-lookup"><span data-stu-id="ceeb7-174">To help with this, we'll first add an "IsHostedBy(username)" helper method to our Dinner object (within the Dinner.cs partial class we built earlier).</span></span> <span data-ttu-id="ceeb7-175">Этот вспомогательный метод возвращает значение true или false в зависимости от того, совпадает ли заданное имя пользователя со свойством Хостедби компании и инкапсулирует логику, необходимую для сравнения строк с учетом регистра.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-175">This helper method returns true or false depending on whether a supplied username matches the Dinner HostedBy property, and encapsulates the logic necessary to perform a case-insensitive string comparison of them:</span></span>

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample5.cs)]

<span data-ttu-id="ceeb7-176">Затем мы добавим атрибут [авторизовать] к методам действия Edit () в рамках нашего класса Диннерсконтроллер.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-176">We'll then add an [Authorize] attribute to the Edit() action methods within our DinnersController class.</span></span> <span data-ttu-id="ceeb7-177">Это обеспечит, чтобы пользователи входили в систему для запроса URL-адреса */диннерс/едит/[ID]* .</span><span class="sxs-lookup"><span data-stu-id="ceeb7-177">This will ensure that users must be logged in to request a */Dinners/Edit/[id]* URL.</span></span>

<span data-ttu-id="ceeb7-178">Затем можно добавить код в методы правки, использующие вспомогательный метод компании Dinner. Ишостедби (username), чтобы убедиться, что вошедший в систему пользователь соответствует узлу компании Dinner.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-178">We can then add code to our Edit methods that uses the Dinner.IsHostedBy(username) helper method to verify that the logged-in user matches the Dinner host.</span></span> <span data-ttu-id="ceeb7-179">Если пользователь не является ведущим, будет отображено представление "Инвалидовнер" и завершен запрос.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-179">If the user is not the host, we'll display an "InvalidOwner" view and terminate the request.</span></span> <span data-ttu-id="ceeb7-180">Код для этого выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-180">The code to do this looks like below:</span></span>

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample6.cs)]

<span data-ttu-id="ceeb7-181">Затем можно щелкнуть правой кнопкой мыши каталог \Виевс\диннерс и выбрать команду меню Добавить представление&gt;, чтобы создать новое представление "Инвалидовнер".</span><span class="sxs-lookup"><span data-stu-id="ceeb7-181">We can then right-click on the \Views\Dinners directory and choose the Add-&gt;View menu command to create a new "InvalidOwner" view.</span></span> <span data-ttu-id="ceeb7-182">Мы будем заполнять его следующим сообщением об ошибке:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-182">We'll populate it with the below error message:</span></span>

[!code-aspx[Main](secure-applications-using-authentication-and-authorization/samples/sample7.aspx)]

<span data-ttu-id="ceeb7-183">Теперь, когда пользователь пытается изменить ужин, он не владеет, он получает сообщение об ошибке:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-183">And now when a user attempts to edit a dinner they don't own, they'll get an error message:</span></span>

![](secure-applications-using-authentication-and-authorization/_static/image7.png)

<span data-ttu-id="ceeb7-184">Можно повторить те же действия для методов действия Delete () в пределах контроллера, чтобы заблокировать разрешение на удаление диннерс, и убедиться, что только узел компании Dinner может удалить его.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-184">We can repeat the same steps for the Delete() action methods within our controller to lock down permission to delete Dinners as well, and ensure that only the host of a Dinner can delete it.</span></span>

### <a name="showinghiding-edit-and-delete-links"></a><span data-ttu-id="ceeb7-185">Отображение и скрытие ссылок "Правка" и "Удалить"</span><span class="sxs-lookup"><span data-stu-id="ceeb7-185">Showing/Hiding Edit and Delete Links</span></span>

<span data-ttu-id="ceeb7-186">Мы связываемся с методом действия Edit и Delete класса Диннерсконтроллер из нашего URL-адреса подробностей:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-186">We are linking to the Edit and Delete action method of our DinnersController class from our Details URL:</span></span>

![](secure-applications-using-authentication-and-authorization/_static/image8.png)

<span data-ttu-id="ceeb7-187">В настоящее время отображаются ссылки на действия Edit и DELETE независимо от того, является ли посетитель URL-адресом сведений узлом компании Dinner.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-187">Currently we are showing the Edit and Delete action links regardless of whether the visitor to the details URL is the host of the dinner.</span></span> <span data-ttu-id="ceeb7-188">Давайте изменим это, чтобы ссылки отображались только в том случае, если посетитель является владельцем компании Dinner.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-188">Let's change this so that the links are only displayed if the visiting user is the owner of the dinner.</span></span>

<span data-ttu-id="ceeb7-189">Метод действия Details () в нашей Диннерсконтроллер извлекает объект Dinner, а затем передает его в шаблон представления в качестве объекта модели:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-189">The Details() action method within our DinnersController retrieves a Dinner object and then passes it as the model object to our view template:</span></span>

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample8.cs)]

<span data-ttu-id="ceeb7-190">Мы можем обновить наш шаблон представления, чтобы условно Показать или скрыть ссылки Edit и DELETE с помощью вспомогательного метода Dinner. Ишостедби (), как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="ceeb7-190">We can update our view template to conditionally show/hide the Edit and Delete links by using the Dinner.IsHostedBy() helper method like below:</span></span>

[!code-aspx[Main](secure-applications-using-authentication-and-authorization/samples/sample9.aspx)]

#### <a name="next-steps"></a><span data-ttu-id="ceeb7-191">Next Steps</span><span class="sxs-lookup"><span data-stu-id="ceeb7-191">Next Steps</span></span>

<span data-ttu-id="ceeb7-192">Теперь посмотрим, как можно включить прошедшие проверку подлинности пользователей в RSVP для диннерс с помощью AJAX.</span><span class="sxs-lookup"><span data-stu-id="ceeb7-192">Let's now look at how we can enable authenticated users to RSVP for dinners using AJAX.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="ceeb7-193">[Назад](implement-efficient-data-paging.md)
> [Вперед](use-ajax-to-deliver-dynamic-updates.md)</span><span class="sxs-lookup"><span data-stu-id="ceeb7-193">[Previous](implement-efficient-data-paging.md)
[Next](use-ajax-to-deliver-dynamic-updates.md)</span></span>
