---
uid: mvc/overview/older-versions-1/nerddinner/secure-applications-using-authentication-and-authorization
title: Защита приложений с помощью проверки подлинности и авторизации | Документация Майкрософт
author: microsoft
description: На шаге 9 показано, как добавить проверку подлинности и авторизацию для обеспечения безопасности приложения NerdDinner, чтобы пользователи могли зарегистрироваться и войти на сайт для создания...
ms.author: riande
ms.date: 07/27/2010
ms.assetid: 9e4d5cac-b071-440c-b044-20b6d0c964fb
msc.legacyurl: /mvc/overview/older-versions-1/nerddinner/secure-applications-using-authentication-and-authorization
msc.type: authoredcontent
ms.openlocfilehash: 8d509c5f15bb4d5014e53b8dc2a736454238e72c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78486426"
---
# <a name="secure-applications-using-authentication-and-authorization"></a>Защита приложений с помощью проверки подлинности и авторизации

по [Майкрософт](https://github.com/microsoft)

[Скачать в формате PDF](http://aspnetmvcbook.s3.amazonaws.com/aspnetmvc-nerdinner_v1.pdf)

> Это шаг 9 из бесплатного [учебника по приложению "NerdDinner"](introducing-the-nerddinner-tutorial.md) , в котором рассматривается создание небольшого, но полного веб-приложения с использованием ASP.NET MVC 1.
> 
> На шаге 9 показано, как добавить проверку подлинности и авторизацию для защиты нашего приложения NerdDinner, чтобы пользователям было необходимо зарегистрировать сайт и войти на него, чтобы создать новый диннерс, и только пользователь, который размещает обед, сможет изменить его позже.
> 
> Если вы используете ASP.NET MVC 3, мы рекомендуем следовать руководствам по [Начало работы в MVC 3 или в приложении для](../../older-versions/getting-started-with-aspnet-mvc3/cs/intro-to-aspnet-mvc-3.md) [музыкального магазина MVC](../../older-versions/mvc-music-store/mvc-music-store-part-1.md) .

## <a name="nerddinner-step-9-authentication-and-authorization"></a>NerdDinner шаг 9. Проверка подлинности и авторизация

Сейчас наше приложение NerdDinner предоставляет всем посетителям сайта возможность создавать и изменять сведения о любом обеде. Давайте изменим это, чтобы пользователи могли регистрироваться на сайте и входить на него, чтобы создать новый диннерс, и добавить ограничение, чтобы его можно было изменить только у пользователя, размещающего обед.

Чтобы сделать это, мы будем использовать проверку подлинности и авторизацию для защиты нашего приложения.

### <a name="understanding-authentication-and-authorization"></a>Общие сведения о проверке подлинности и авторизации

*Проверка подлинности* — это процесс идентификации и проверки удостоверения клиента, обращающегося к приложению. Говоря более просто, это означает, что пользователь, который является конечным пользователем, посещает веб-сайт. ASP.NET поддерживает несколько способов проверки подлинности пользователей браузера. Для веб-приложений в Интернете наиболее распространенный способ проверки подлинности называется "Проверка подлинности с помощью форм". Проверка подлинности с помощью форм позволяет разработчику создать форму входа в HTML в своем приложении, а затем проверить имя пользователя и пароль, отправляемые конечным пользователем для базы данных или другого хранилища учетных данных пароля. Если задано правильное сочетание имени пользователя и пароля, разработчик может попросить ASP.NET выдать зашифрованный файл cookie HTTP, чтобы указать пользователя в будущих запросах. Мы будем использовать проверку подлинности с помощью форм в нашем приложении NerdDinner.

*Авторизация* — это процесс определения того, имеет ли прошедший проверку подлинности пользователя разрешение на доступ к определенному URL-адресу или ресурсу или выполнение какого-либо действия. Например, в нашем приложении NerdDinner мы хотим авторизовать, чтобы только пользователи, которые вошли в систему, могли получить доступ к URL-адресу */диннерс/креате* и создать новый диннерс. Мы также хотим добавить логику авторизации, чтобы только пользователь, который размещает обед, мог редактировать его — и запрещать доступ на редактирование всем остальным пользователям.

### <a name="forms-authentication-and-the-accountcontroller"></a>Проверка подлинности с помощью форм и AccountController

Шаблон проекта Visual Studio по умолчанию для ASP.NET MVC автоматически включает проверку подлинности на формах при создании новых приложений ASP.NET MVC. Он также автоматически добавляет в проект предварительно созданную реализацию страницы входа в учетную запись, что упрощает интеграцию безопасности в пределах сайта.

В верхней правой части веб-страницы Site. master по умолчанию отображается ссылка для входа в систему, когда пользователь, обращающийся к нему, не прошел проверку подлинности:

![](secure-applications-using-authentication-and-authorization/_static/image1.png)

Щелкните ссылку "вход", чтобы перейти на URL-адрес */аккаунт/Логон* :

![](secure-applications-using-authentication-and-authorization/_static/image2.png)

Посетители, которые не зарегистрировались, могут сделать это, щелкнув ссылку «Register» (зарегистрировать), которая переберет их на URL-адрес */аккаунт/регистер* и позволит им ввести сведения об учетной записи:

![](secure-applications-using-authentication-and-authorization/_static/image3.png)

Нажатие кнопки "зарегистрировать" приведет к созданию нового пользователя в системе членства в ASP.NET и проверке подлинности пользователя на сайте с использованием проверки подлинности с помощью форм.

Когда пользователь входит в систему, site. master изменяет правый верхний край страницы, выводит «Welcome [имя_пользователя]!». сообщение и готовит к просмотру ссылку "выход из системы" вместо "входа". Щелкнув ссылку "Завершение сеанса", вы выйдете из системы для пользователя:

![](secure-applications-using-authentication-and-authorization/_static/image4.png)

Приведенные выше функции входа, выхода и регистрации реализуются в классе AccountController, который был добавлен в проект Visual Studio при создании проекта. Пользовательский интерфейс для AccountController реализуется с помощью шаблонов представлений в каталоге \Виевс\аккаунт:

![](secure-applications-using-authentication-and-authorization/_static/image5.png)

Класс AccountController использует систему проверки подлинности форм ASP.NET для выдаче зашифрованных файлов cookie проверки подлинности, а также API членства ASP.NET для хранения и проверки имен пользователей и паролей. API членства ASP.NET является расширяемым и позволяет использовать любое хранилище учетных данных паролей. ASP.NET поставляется со встроенными реализациями поставщиков членства, которые хранят имена пользователей и пароли в базе данных SQL или в пределах Active Directory.

Мы можем настроить, какой поставщик членства должен использовать наше приложение NerdDinner, открыв файл Web. config в корне проекта и найдя в нем раздел &lt;членства&gt;. Файл Web. config по умолчанию, добавленный при создании проекта, регистрирует поставщик членства SQL и настраивает его для использования строки подключения с именем "ApplicationServices" для указания расположения базы данных.

Строка подключения "ApplicationServices" по умолчанию (которая указана в разделе &lt;connectionString&gt; в файле Web. config) настроена для использования экспресс-выпуска SQL. Он указывает на базу данных SQL Express с именем ASPNETDB. MDF "в каталоге приложения" Application\_Data ". Если эта база данных не существует в первый раз, когда в приложении будет использоваться API членства, ASP.NET автоматически создаст базу данных и подготавливает в ней соответствующую схему базы данных членства:

![](secure-applications-using-authentication-and-authorization/_static/image6.png)

Если вместо использования SQL Express требуется использовать полный экземпляр SQL Server (или подключиться к удаленной базе данных), нам нужно только обновить строку подключения "ApplicationServices" в файле Web. config и убедиться, что соответствующая схема членства был добавлен в базу данных, на которую он указывает. Вы можете запустить служебную программу "ASPNET\_регскл. exe" в каталоге \Windows\Microsoft.NET\Framework\v2.0.50727\, чтобы добавить соответствующую схему членства и другие службы приложений ASP.NET в базу данных.

### <a name="authorizing-the-dinnerscreate-url-using-the-authorize-filter"></a>Авторизация URL-адреса/диннерс/креате с помощью фильтра [авторизовать]

Нам не пришлось писать код для обеспечения безопасной реализации проверки подлинности и управления учетными записями для приложения NerdDinner. Пользователи могут регистрировать новые учетные записи в нашем приложении, а также выполнять вход и выход сайта.

Теперь мы можем добавить логику авторизации в приложение и использовать состояние проверки подлинности и имена пользователей для управления тем, что они могут и не могут делать на сайте. Начнем с добавления логики авторизации к методам действия "создать" для нашего класса Диннерсконтроллер. В частности, потребуется войти в систему пользователей, обращающихся к URL-адресу */диннерс/креате* . Если они не вошли в систему, мы будем перенаправлять их на страницу входа, чтобы они могли выполнить вход.

Реализовать эту логику довольно просто. Все, что нам нужно, — добавить атрибут фильтра [авторизовать] к нашим методам создания действия, например:

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample1.cs)]

ASP.NET MVC поддерживает возможность создания фильтров действий, которые можно использовать для реализации повторно используемой логики, которая может быть декларативно применена к методам действий. Фильтр [авторизовать] является одним из встроенных фильтров действий, предоставляемых ASP.NET MVC, и позволяет разработчику декларативно применять правила авторизации к методам действий и классам контроллеров.

При применении без каких-либо параметров (как и выше) фильтр [авторизовать] применяет, чтобы пользователь, выполняющий запрос метода действия, вошел в систему — и автоматически перенаправит браузер на URL-адрес входа, если они отсутствуют. При этом перенаправлении изначально запрошенный URL-адрес передается как аргумент QueryString (например:/аккаунт/Логон? ReturnUrl =% 2fDinners% 2fCreate). AccountController перенаправит пользователя обратно к первоначально запрошенному URL-адресу после входа.

Фильтр [авторизовать] позволяет указать свойство "Пользователи" или "роли", которое может использоваться, чтобы требовать, чтобы пользователь вошел в систему и в список разрешенных пользователей или член разрешенной роли безопасности. Например, приведенный ниже код позволяет получить доступ к URL-адресу/диннерс/креате только для двух конкретных пользователей — "scottgu" и "биллг":

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample2.cs)]

Внедрение конкретных имен пользователей в код, тем не менее, может оказаться довольно недоступным для обслуживания. Лучшим подходом является определение "ролей" более высокого уровня, с которыми проверяется код, а затем сопоставление пользователей с ролью с помощью базы данных или системы Active Directory (включение фактического списка сопоставлений пользователей во внешнем хранении из кода). ASP.NET включает встроенный API управления ролями, а также встроенный набор поставщиков ролей (в том числе для SQL и Active Directory), которые могут помочь в этом сопоставлении пользователей и ролей. Затем можно обновить код, чтобы разрешить доступ к URL-адресу/диннерс/креате только пользователям с определенной ролью "admin":

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample3.cs)]

### <a name="using-the-useridentityname-property-when-creating-dinners"></a>Использование свойства User.Identity.Name при создании диннерс

Можно получить имя пользователя запроса, вошедшего в систему, с помощью свойства User.Identity.Name, доступного в базовом классе контроллера.

Ранее, когда мы реализовали версию метода действия Create () HTTP-POST, мы имели жесткую строку со свойством "Хостедби" компании Dinner. Теперь можно обновить этот код, чтобы вместо этого использовать свойство User.Identity.Name, а также автоматически добавить RSVP для узла, создающего ужин:

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample4.cs)]

Поскольку мы добавили атрибут [авторизовать] в метод Create (), ASP.NET MVC гарантирует, что метод действия выполняется только в том случае, если пользователь, посещающий URL-адрес/диннерс/креате, вошел в систему на сайте. Таким образом, значение свойства User.Identity.Name всегда будет содержать допустимое имя пользователя.

### <a name="using-the-useridentityname-property-when-editing-dinners"></a>Использование свойства User.Identity.Name при редактировании диннерс

Теперь добавим некоторую логику авторизации, запрещающую пользователей, чтобы они могли изменять только свойства диннерс, на которых они размещены.

Для этого мы сначала добавим вспомогательный метод "Ишостедби (username)" в наш объект Dinner (внутри разделяемого класса Dinner.cs, который мы создали ранее). Этот вспомогательный метод возвращает значение true или false в зависимости от того, совпадает ли заданное имя пользователя со свойством Хостедби компании и инкапсулирует логику, необходимую для сравнения строк с учетом регистра.

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample5.cs)]

Затем мы добавим атрибут [авторизовать] к методам действия Edit () в рамках нашего класса Диннерсконтроллер. Это обеспечит, чтобы пользователи входили в систему для запроса URL-адреса */диннерс/едит/[ID]* .

Затем можно добавить код в методы правки, использующие вспомогательный метод компании Dinner. Ишостедби (username), чтобы убедиться, что вошедший в систему пользователь соответствует узлу компании Dinner. Если пользователь не является ведущим, будет отображено представление "Инвалидовнер" и завершен запрос. Код для этого выглядит следующим образом:

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample6.cs)]

Затем можно щелкнуть правой кнопкой мыши каталог \Виевс\диннерс и выбрать команду меню Добавить представление&gt;, чтобы создать новое представление "Инвалидовнер". Мы будем заполнять его следующим сообщением об ошибке:

[!code-aspx[Main](secure-applications-using-authentication-and-authorization/samples/sample7.aspx)]

Теперь, когда пользователь пытается изменить ужин, он не владеет, он получает сообщение об ошибке:

![](secure-applications-using-authentication-and-authorization/_static/image7.png)

Можно повторить те же действия для методов действия Delete () в пределах контроллера, чтобы заблокировать разрешение на удаление диннерс, и убедиться, что только узел компании Dinner может удалить его.

### <a name="showinghiding-edit-and-delete-links"></a>Отображение и скрытие ссылок "Правка" и "Удалить"

Мы связываемся с методом действия Edit и Delete класса Диннерсконтроллер из нашего URL-адреса подробностей:

![](secure-applications-using-authentication-and-authorization/_static/image8.png)

В настоящее время отображаются ссылки на действия Edit и DELETE независимо от того, является ли посетитель URL-адресом сведений узлом компании Dinner. Давайте изменим это, чтобы ссылки отображались только в том случае, если посетитель является владельцем компании Dinner.

Метод действия Details () в нашей Диннерсконтроллер извлекает объект Dinner, а затем передает его в шаблон представления в качестве объекта модели:

[!code-csharp[Main](secure-applications-using-authentication-and-authorization/samples/sample8.cs)]

Мы можем обновить наш шаблон представления, чтобы условно Показать или скрыть ссылки Edit и DELETE с помощью вспомогательного метода Dinner. Ишостедби (), как показано ниже:

[!code-aspx[Main](secure-applications-using-authentication-and-authorization/samples/sample9.aspx)]

#### <a name="next-steps"></a>Next Steps

Теперь посмотрим, как можно включить прошедшие проверку подлинности пользователей в RSVP для диннерс с помощью AJAX.

> [!div class="step-by-step"]
> [Назад](implement-efficient-data-paging.md)
> [Вперед](use-ajax-to-deliver-dynamic-updates.md)
