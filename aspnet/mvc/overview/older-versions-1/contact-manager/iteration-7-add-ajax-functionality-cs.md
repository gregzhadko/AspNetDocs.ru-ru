---
uid: mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
title: 'Итерации #7 – Добавление функций Ajax (C#) | Документация Майкрософт'
author: microsoft
description: В седьмой итерации мы повысить скорость реагирования и производительность приложения, добавляя поддержку Ajax.
ms.author: riande
ms.date: 02/20/2009
ms.assetid: f1b0809e-8909-444e-b6bb-a5cd1dea3f72
msc.legacyurl: /mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
msc.type: authoredcontent
ms.openlocfilehash: 7c8eb3d3688674dd2c220b4bd1b5982f2610d0eb
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65123845"
---
# <a name="iteration-7--add-ajax-functionality-c"></a>Итерации #7 – Добавление функций Ajax (C#)

по [Microsoft](https://github.com/microsoft)

[Скачать код](iteration-7-add-ajax-functionality-cs/_static/contactmanager_7_cs1.zip)

> В седьмой итерации мы повысить скорость реагирования и производительность приложения, добавляя поддержку Ajax.

## <a name="building-a-contact-management-aspnet-mvc-application-c"></a>Создание приложения управления контактами ASP.NET MVC (C#)

В этой серии руководств мы создаем всего приложения управления контактами от начала до конца. Приложение диспетчера контактов позволяет хранить контактные данные - имена, номера телефонов и адреса электронной почты — список людей.

Мы создаем приложение через несколько итераций. С каждой итерацией мы постепенно улучшить приложение. Этот подход с несколькими итерации предназначена для того, чтобы можно было понять причину для каждого изменения.

- Итерация #1 - Создание приложения. В первой итерации мы создадим Contact Manager простейшим способом невозможно. Мы добавили поддержку для основных операций базы данных: Создание, чтение, обновление и удаление (CRUD).

- #2 - итерация приложения красиво выглядеть. В этой итерации мы улучшить внешний вид приложения, изменив значение по умолчанию master страница представления ASP.NET MVC и каскадные таблицы стилей.

- Итерации #3 - Добавление проверки форм. В третьей итерации мы добавим проверки базовой форме. Мы запретить Отправка формы без завершения обязательные поля. Кроме того, мы проверяем, адреса электронной почты и номера телефонов.

- Итерация #4 - Создание слабых связей в приложении. В этой четвертой итерации мы воспользоваться преимуществами нескольких шаблонов дизайна программного обеспечения, чтобы упростить обслуживании и изменении приложения диспетчера контактов. Например мы выполнили рефакторинг наше приложение, чтобы использовать шаблон репозитория и шаблон внедрения зависимостей.

- Итерации #5 - Создание модульных тестов. В пятой итерации мы вам наше приложение проще обслуживании и изменении путем добавления модульных тестов. Мы макетирование наших классов модели данных и создания модульных тестов для контроллеров и логику проверки.

- Итерация #6 - использование управляемой тестами разработки. В этой шестой итерации мы добавляем новые функциональные возможности в наше приложение, сначала написание модульных тестов и написании кода в отношении модульные тесты. В этой итерации мы добавляем групп контактов.

- Итерации #7 - Добавление функций Ajax. В седьмой итерации мы повысить скорость реагирования и производительность приложения, добавляя поддержку Ajax.

## <a name="this-iteration"></a>Эта итерация

В этой итерации приложения диспетчера контактов мы выполнили рефакторинг наше приложение, чтобы использовать Ajax. Используя преимущества Ajax, мы ускорения нашего приложения. Можно избежать визуализации всей страницы, когда нам потребуется обновить только определенные области страницы.

Мы выполните рефакторинг нашего представления индекса, таким образом, чтобы мы кое t необходимость повторного отображения всей страницы, каждый раз, когда пользователь выберет новую группу контактов. Вместо этого при нажатии группе контактов, мы просто обновить список контактов и оставить только остальной части страницы.

Также мы изменим наш delete связать works способ. Вместо отображения на страницу подтверждения в отдельном, мы будем отображать диалоговое окно подтверждения JavaScript. Если вы подтвердите, что Вы действительно хотите удалить контакт, операция HTTP DELETE выполняется на сервере, чтобы удалить запись из базы данных.

Кроме того мы будет использовать jQuery для добавления эффектов анимации для нашего представления индекса. Мы будем отображать анимации, когда новый список контактов извлекается с сервера.

Наконец мы рассмотрим преимущества платформы AJAX для ASP.NET поддержка управление историей браузера. Мы создадим точек всякий раз, когда мы выполняем вызова Ajax для обновления списка контактов. Таким образом, браузер назад и вперед кнопки будет работать.

## <a name="why-use-ajax"></a>Зачем использовать Ajax?

Использование Ajax имеет множество преимуществ. Во-первых Добавление функциональности Ajax на приложения позволяет обеспечить лучшие впечатления. В обычном веб-приложения всей страницы должен учитываться на сервере каждый раз, пользователь выполняет действие. Каждый раз, когда выполняется действие блокировки браузера и пользователю необходимо дождаться всей страницы извлечь и впоследствии.

Это было бы интерфейс неприемлемыми в случае настольного приложения. Но в большинстве случаев мы жили с этой неприятной в случае веб-приложения, так как мы не знали, что мы можем сделать лучше. Мы подумали, что было ограничение веб-приложений, когда на самом деле он был только что ограничение наших imaginations.

В приложении Ajax нигде не t нужно привести к остановке для обновления страницы взаимодействие с пользователем. Вместо этого можно выполнить асинхронный запрос в фоновом режиме для обновления страницы. Нигде не t force пользователю, подождите, пока обновляется часть страницы.

Используя преимущества Ajax, можно повысить производительность приложения. Рассмотрим, как приложение Contact Manager прямо сейчас работает без функций Ajax. Если щелкнуть группу контактов, необходимо повторно всего индекса представления. Список контактов и список групп контактов должна быть получена с сервера базы данных. Все эти данные должны быть переданы по каналу связи с веб-сервера веб-браузер.

После мы добавлять функциональность Ajax на наше приложение, тем не менее, можно избежать повторное отображение всей страницы, когда пользователь щелкает группе контактов. Мы больше не придется взять групп, контактов из базы данных. Кроме того, мы кое необходимость t для передачи всего представления индекса по каналу связи. Используя преимущества Ajax, нам уменьшить объем работы, которую необходимо выполнять наш сервер базы данных и мы сократить объем сетевого трафика, требующегося наше приложение.

## <a name="don-t-be-afraid-of-ajax"></a>Дон t быть боится Ajax

Некоторые разработчики не с помощью Ajax, так как они беспокоиться о браузерах нижнего уровня. Они хотели бы убедиться, что веб-приложениям по-прежнему будет работать при обращении к в браузере, не поддерживает JavaScript. Поскольку Ajax зависит от JavaScript, некоторые разработчики не используют Ajax.

Тем не менее если вы с осторожностью относитесь реализация Ajax можно создавать приложения, которые работают с верхнего и нижнего. Наше приложение диспетчера контактов будет работать с обозревателями, поддерживающими JavaScript и браузеры, — нет.

Если вы используете приложение диспетчера контактов с помощью обозревателя, который поддерживает JavaScript вы получите удобства работы пользователя. Например если щелкнуть группу контактов, будет обновляться только в регионе со страницей, отображающей контакты.

Если, с другой стороны, вы используете приложение диспетчера контактов с помощью браузера, который не поддерживает JavaScript (или с отключает JavaScript) будет иметь немного менее предпочтителен взаимодействие с пользователем. Например если щелкнуть группу контактов, всего индекса представления должен быть отправлен обратно браузера для отображения соответствующий список контактов.

## <a name="adding-the-required-javascript-files"></a>Добавление файлов требуемого кода JavaScript

Нам потребуется использовать три файла JavaScript для добавления функциональных возможностей Ajax к нашему приложению. Все три эти файлы включены в папке Scripts нового приложения ASP.NET MVC.

Если вы планируете использовать Ajax на нескольких страницах приложения затем смысл включить необходимые файлы JavaScript в главную страницу приложения s представления. Таким образом, файлы JavaScript будут включены во всех страниц в приложении автоматически.

Добавьте следующий код JavaScript включает внутри &lt;head&gt; тега, на главной странице представления:

[!code-html[Main](iteration-7-add-ajax-functionality-cs/samples/sample1.html)]

## <a name="refactoring-the-index-view-to-use-ajax"></a>Рефакторинг в представление Index, использование Ajax

Позвольте s начать с изменения нашего представления индекса, таким образом, только если щелкнуть группу, контактные обновляет область представления, отображающий контактов. Красным прямоугольником на рис. 1 содержит области, нам нужно обновить.

[![Обновление только контакты](iteration-7-add-ajax-functionality-cs/_static/image1.jpg)](iteration-7-add-ajax-functionality-cs/_static/image1.png)

**Рис 01**: Обновление только контакты ([Просмотр полноразмерного изображения](iteration-7-add-ajax-functionality-cs/_static/image2.png))

Первым делом для отделения части представления, нам нужно обновить асинхронно в отдельном разделяемом (пользовательский элемент управления представления). В части представления индекса, который выводит таблицу контактов была перемещена в разделяемом в листинге 1.

**В листинге 1 - Views\Contact\ContactList.ascx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample2.aspx)]

Обратите внимание, что частично в листинге 1 другой модели, чем в представление Index. *Inherits* атрибут в &lt;% @ Page %&gt; директива указывает, что разделяемого наследует от ViewUserControl&lt;группы&gt; класса.

Обновленное представление индекса содержится в листинге 2.

**В листинге 2 - Views\Contact\Index.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample3.aspx)]

Существуют две вещи, которые вы должны заметить о обновленное представление в листинге 2. Во-первых Обратите внимание на то, что все содержимое перемещено в разделяемом заменяется вызов Html.RenderPartial(). Метод Html.RenderPartial() вызывается в том случае, когда представление Index сначала запрашивается для отображения начального набора контактов.

Во-вторых Обратите внимание на то, что Html.ActionLink(), используемый для отображения групп контактов были заменены Ajax.ActionLink(). Ajax.ActionLink() вызывается со следующими параметрами:

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample4.aspx)]

Первый параметр представляет текст, отображаемый для ссылки, второй параметр представляет значения маршрута, а третий параметр представляет параметры Ajax. В этом случае мы используем параметр UpdateTargetId Ajax указывал на HTML-код &lt;div&gt; тег, который необходимо обновить после завершения запроса Ajax. Нам нужно обновить &lt;div&gt; тег с новый список контактов.

Обновленный метод Index(), обратитесь в службу контроллера содержится в листинге 3.

**Листинг 3 - Controllers\ContactController.cs (метод Index)**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample5.cs)]

Обновление действия Index() условно возвращает одно из следующих действий. Если действие Index() вызывается с помощью запроса Ajax контроллер возвращает частичный. В противном случае действие Index() возвращает всю область.

Обратите внимание на то, что действие Index() не нужно возвращать столько данных, при вызове с помощью запроса Ajax. В контексте обычным запросом действие индекса возвращает список всех групп, контактов и выбранной группе контактов. В контексте Ajax-запросом действие Index() возвращает только выбранной группы. AJAX означает меньше работы на сервере базы данных.

В случае верхнего и нижнего работает нашего измененный индекс представления. Если браузер поддерживает JavaScript щелкните группу контактов, обновляется только в регионе представление, содержащее список контактов. Если, с другой стороны, ваш браузер не поддерживает JavaScript, все представление обновляется.

Нашего обновленный индекс представления есть одна проблема. Если щелкнуть группу контактов, не выделяется выбранной группы. Поскольку список групп отображаются за пределами региона, который обновляется при выполнении запроса Ajax, подходящую группу получить гаснет. Эта проблема будет устранена в следующем разделе.

## <a name="adding-jquery-animation-effects"></a>Добавление эффектов анимации jQuery

Как правило при щелчке ссылки на веб-странице, можно использовать индикатор браузера для обнаружения ли браузер активно ненужные обновленное содержимое. При выполнении запроса Ajax, с другой стороны, индикатор браузера не содержит никаких действий. Это может усложнить заботящихся пользователей. Как узнать, заморожена ли браузер?

Существует несколько способов, которые вы можете указать пользователю, что работа будет выполняться при выполнении запроса Ajax. Одним из подходов является отображение простой анимации. Например можно Исчезание область при начале Ajax-запросом, появление в регионе после выполнения запроса.

Мы будем использовать библиотеку jQuery, которая входит в состав платформы Microsoft ASP.NET MVC для создания эффектов анимации. Обновленное представление индекса содержится в листинге 4.

**Листинг 4 - Views\Contact\Index.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample6.aspx)]

Обратите внимание на то, что обновленное представление индекса содержит три новые функции JavaScript. Первые две функции позволяет скрывать и исчезать в список контактов, если щелкнуть группу контактные jQuery. Третья функция отображает сообщение об ошибке, когда результаты запроса Ajax ошибку (например, время ожидания сети истекло).

Первая функция также отвечает за выделение выбранной группы. Класс = выбранный атрибут добавляется к родительскому элементу (элемент LI) щелчке элемента. Опять же jQuery упрощает выбор правильного элемента и добавьте класс CSS.

Эти сценарии привязаны к связи группами с помощью параметра Ajax.ActionLink() AjaxOptions. Обновленные вызова метода Ajax.ActionLink() выглядит следующим образом:

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample7.aspx)]

## <a name="adding-browser-history-support"></a>Добавление поддержки журнал браузера

Как правило если щелкнуть ссылку, чтобы обновить страницу, журнал обозревателя обновляется. Таким образом, можно щелкнуть "Назад" браузера для перемещения назад во времени к предыдущему состоянию страницы. Например если вы выберите в группу друзей и нажмите кнопку в группу бизнеса, можно нажмите кнопку "Назад" браузера и перейти в состояние страницы, если был выбран в группу друзей.

К сожалению выполнение запроса Ajax не обновляются истории браузера. Если щелкнуть группу контактов и список совпадающих контактов возвращается с помощью Ajax-запросом, истории браузера не обновляется. Чтобы перейти к группе контактов, выбрав группу контактов нельзя использовать "Назад" браузера.

Чтобы пользователи могли работать с браузером обратно кнопку после выполнения запросов Ajax, необходимо выполнять немного больше работы. Необходимо воспользоваться преимуществами возможностей управления журнал браузера, встроенных в платформы AJAX для ASP.NET.

Содержимое журнала обозревателя AJAX для ASP.NET, необходимо выполнить три действия:

1. Включите журнал браузера, задав свойство enableBrowserHistory значение true.
2. Сохраните журнал точки, при изменении состояния представления путем вызова метода addHistoryPoint().
3. Восстановить состояние представления, когда возникает событие navigate.

Обновленное представление индекса содержится в листинге 5.

**В листинге 5 - Views\Contact\Index.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample8.aspx)]

В листинге 5 в функции pageInit() включить журнал браузера. Функция pageInit() также используется для настройки обработчик событий для перехода. Событие navigate возникает всякий раз, когда браузер: вперед и кнопка "Назад", вызывают состояние страницы для изменения.

Метод beginContactList() вызывается в том случае, если щелкнуть группу контактов. Этот метод создает новую точку предыдущего состояния путем вызова метода addHistoryPoint(). Идентификатор группы контактные щелчке добавляется в журнал.

Идентификатор группы извлекается из атрибута expando ссылку группе контактов. Ссылка отрисовывается с следующий вызов в Ajax.ActionLink().

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample9.aspx)]

Последний параметр, передаваемый Ajax.ActionLink() добавляет атрибут expando с именем groupid по ссылке (нижний регистр для совместимости XHTML).

Когда пользователь касается обратно в браузер или кнопка "вперед", возникает событие navigate и вызывается метод navigate(). Этот метод обновляет контактов, отображаемой на странице, чтобы оно соответствовало состоянию страницы, соответствующий точке журнал браузера, передаваемый в метод navigate.

## <a name="performing-ajax-deletes"></a>Удаляет выполнения Ajax

В настоящее время, чтобы удалить контакт, необходимо щелкнуть ссылку «Удалить» и нажмите кнопку «Удалить», отображаются на странице подтверждения удаления (см. рис. 2). Это может показаться массу запросов страниц, чтобы сделать что-то простое, например удаление записи базы данных.

[![Страница подтверждения удаления](iteration-7-add-ajax-functionality-cs/_static/image2.jpg)](iteration-7-add-ajax-functionality-cs/_static/image3.png)

**Рис. 02**: Страница подтверждения удаления ([Просмотр полноразмерного изображения](iteration-7-add-ajax-functionality-cs/_static/image4.png))

Это подмывает вас, чтобы пропустить страницу подтверждения удаления и удалить контакт непосредственно из окна просмотра индекса. Следует избегать искушению действовать, потому что при таком подходе приложению бреши в системе безопасности. Как правило Дон t требуется выполнить операцию HTTP GET, при вызове действие, которое изменяет состояние веб-приложения. При выполнении удаления, вы хотите выполнить запрос HTTP POST или лучше всего, операции HTTP DELETE.

Удалить ссылка содержится в частичной ContactList. Обновленная версия ContactList частичного содержится в листинге 6.

**В листинге 6 - Views\Contact\ContactList.ascx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample10.aspx)]

Ссылку «Удалить» отображается на следующий вызов в метод Ajax.ImageActionLink():

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample11.aspx)]

> [!NOTE] 
> 
> Ajax.ImageActionLink() не является стандартной частью платформы ASP.NET MVC. Ajax.ImageActionLink() является пользовательских вспомогательных методов, включенных в проект Contact Manager.

Параметр AjaxOptions имеет два свойства. Во-первых свойство подтверждение используется для отображения всплывающее диалоговое окно подтверждения JavaScript. Во-вторых свойство HttpMethod используется для выполнения операции HTTP DELETE.

Листинг 7 содержит новое действие AjaxDelete(), которая была добавлена к контроллеру контакта.

**Листинг 7 - Controllers\ContactController.cs (AjaxDelete)**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample12.cs)]

Действие AjaxDelete() дополнен атрибутом AcceptVerbs. Этот атрибут запрещает действие вызова за исключением любой операцией HTTP, отличный от операции HTTP DELETE. В частности не удается вызвать это действие с HTTP GET.

После удаления записи в базе данных, необходимо отобразить обновленный список контактов, не содержащего удаленной записи. Метод AjaxDelete() возвращает ContactList частичное и обновленный список контактов.

## <a name="summary"></a>Сводка

В этой итерации мы добавили функций Ajax в наше приложение диспетчера контактов. Мы использовали Ajax для повышения скорости реагирования и производительность приложения.

Во-первых мы оптимизировали представление Index, таким образом, щелкнув группу контактов не приводит к обновлению всего представления. Вместо этого щелкнув группу контактов только обновляет список контактов.

Затем мы использовали эффекты анимации jQuery Исчезание и появление список контактов. Добавление анимации в приложении Ajax можно использовать для предоставления пользователям приложения эквивалентным индикатор хода выполнения браузера.

Мы также добавили возможность журнал браузера к нашему приложению Ajax. Мы включили пользователю, выбирая браузер обратно кнопки для изменения состояния представления индекса.

Наконец мы создали удалить ссылку, которая поддерживает операции HTTP DELETE. Путем удаления Ajax, мы позволяют пользователям удалять записи базы данных без пользователя запрашивается страница подтверждения удаления дополнительных.

> [!div class="step-by-step"]
> [Назад](iteration-6-use-test-driven-development-cs.md)
> [Вперед](iteration-1-create-the-application-vb.md)
