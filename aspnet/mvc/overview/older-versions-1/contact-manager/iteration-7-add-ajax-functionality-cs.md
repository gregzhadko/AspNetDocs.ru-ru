---
uid: mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
title: '#7 итерации — Добавление функции AJAXC#() | Документация Майкрософт'
author: microsoft
description: В седьмой итерации мы улучшаем скорость реагирования и производительность нашего приложения, добавив поддержку AJAX.
ms.author: riande
ms.date: 02/20/2009
ms.assetid: f1b0809e-8909-444e-b6bb-a5cd1dea3f72
msc.legacyurl: /mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
msc.type: authoredcontent
ms.openlocfilehash: 7c8eb3d3688674dd2c220b4bd1b5982f2610d0eb
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78437736"
---
# <a name="iteration-7--add-ajax-functionality-c"></a>#7 итерации — Добавление функции AJAXC#()

по [Майкрософт](https://github.com/microsoft)

[Скачать код](iteration-7-add-ajax-functionality-cs/_static/contactmanager_7_cs1.zip)

> В седьмой итерации мы улучшаем скорость реагирования и производительность нашего приложения, добавив поддержку AJAX.

## <a name="building-a-contact-management-aspnet-mvc-application-c"></a>Создание приложения для управления контактами ASP.NET MVCC#()

В этой серии учебников мы создадим все приложение управления контактами от начала до конца. Приложение диспетчера контактов позволяет хранить контактные данные, имена телефонов и адреса электронной почты. список людей.

Мы создаем приложение для нескольких итераций. При каждой итерации мы постепенно улучшаем приложение. Цель этого нескольких итераций — позволить вам понять причину каждого изменения.

- Итерация #1 — Создайте приложение. В первой итерации мы создаем Диспетчер контактов проще всего. Добавлена поддержка основных операций с базой данных: создание, чтение, обновление и удаление (CRUD).

- Итерация #2 — сделайте приложение привлекательным. В этой итерации мы улучшаем внешний вид приложения путем изменения главной страницы ASP.NET представления MVC по умолчанию и каскадной таблицы стилей.

- Итерация #3 — Добавление проверки формы. В третьей итерации мы добавим проверку базовой формы. Мы запрещаем пользователям отправлять форму, не заполняя обязательные поля формы. Мы также проверяем адреса электронной почты и номера телефонов.

- Итерация #4 — сделайте приложение слабо связанным. В этой четвертой итерации мы используем преимущества нескольких шаблонов проектирования программного обеспечения, чтобы упростить обслуживание и изменение приложения Contact Manager. Например, мы выполним рефакторинг нашего приложения для использования шаблона репозитория и шаблона внедрения зависимостей.

- Итерация #5 — Создание модульных тестов. В пятой итерации мы сделаем наше приложение проще в обслуживании и изменении, добавляя модульные тесты. Мы размакетирования наши классы модели данных и создаем модульные тесты для наших контроллеров и логики проверки.

- Итерация #6 — Используйте разработку на основе тестирования. В этой шестой итерации мы добавим новые функции в наше приложение, создав модульные тесты в первую очередь и записав код в модульные тесты. В этой итерации мы добавляем группы контактов.

- Итерация #7 — Добавление функциональности AJAX. В седьмой итерации мы улучшаем скорость реагирования и производительность нашего приложения, добавив поддержку AJAX.

## <a name="this-iteration"></a>Эта итерация

В этой итерации приложения диспетчера контактов мы выполним рефакторинг нашего приложения, чтобы использовать AJAX. Используя преимущества AJAX, мы сделаем наше приложение более быстрым реагированием. Мы можем избежать отрисовки всей страницы, когда нам нужно обновить только определенный регион на странице.

Мы выполним рефакторинг нашего представления индекса, чтобы нам не нужно было повторно отображать всю страницу каждый раз, когда кто-то выбирает новую группу контактов. Вместо этого, когда кто-то щелкает контактную группу, мы просто обновляем список контактов и будем оставлять только остальную часть страницы.

Мы также изменим способ работы ссылки DELETE. Вместо отображения отдельной страницы подтверждения отобразится диалоговое окно подтверждения JavaScript. Если вы подтвердите, что хотите удалить контакт, на сервере будет выполнена операция HTTP DELETE для удаления записи Contact из базы данных.

Кроме того, мы будем использовать jQuery для добавления эффектов анимации в представление индекса. При выборке нового списка контактов с сервера будет отображаться анимация.

Наконец, мы будем использовать преимущества поддержки платформы ASP.NET AJAX для управления журналом браузера. При выполнении вызова Ajax для обновления списка контактов мы будем создавать точки предыдущих состояний. Таким образом, кнопки браузера назад и вперед будут работать.

## <a name="why-use-ajax"></a>Зачем использовать AJAX?

Использование AJAX дает множество преимуществ. Во-первых, Добавление функциональных возможностей AJAX в приложение приводит к повышению удобства работы пользователей. В обычных веб-приложениях вся страница должна быть отправлена обратно на сервер каждый раз, когда пользователь выполняет действие. При каждом выполнении действия браузер блокируется, и пользователь должен дождаться выборки и повторного вывода всей страницы.

Это неприемлемое взаимодействие в случае классического приложения. Но, традиционно, мы имели дело с неправильным пользовательским интерфейсом в случае веб-приложения, поскольку мы не знали, что мы можем улучшить. Мы считали, что это было ограничение веб-приложений, когда, фактически, это было лишь ограничение наших воображений.

В приложении AJAX вам не нужно приостанавливать взаимодействие с пользователем до остановки, чтобы обновить страницу. Вместо этого можно выполнить асинхронный запрос в фоновом режиме, чтобы обновить страницу. Пользователь не будет вынужден ждать, пока обновляется часть страницы.

Используя преимущества AJAX, вы также можете повысить производительность приложения. Рассмотрим, как приложение диспетчера контактов работает прямо сейчас без функциональности AJAX. При щелчке группы контактов необходимо повторно отобразить все представление индекса. Список контактов и список групп контактов необходимо получить с сервера базы данных. Все эти данные должны передаваться по сети между веб-сервером и веб-браузером.

Однако после добавления функциональных возможностей AJAX в наше приложение мы можем избежать повторного вывода всей страницы, когда пользователь щелкнет группу контактов. Больше не нужно завлекать группы контактов из базы данных. Нам также не нужно передавать все представление индекса по сети. Используя преимущества AJAX, мы уменьшаем объем работы, которую должен выполнить наш сервер базы данных, и уменьшая объем сетевого трафика, требуемого для нашего приложения.

## <a name="don-t-be-afraid-of-ajax"></a>Не беспокойтесь об Ajax

Некоторые разработчики не используют Ajax, так как они беспокоят браузеры прежних версий. Они хотят убедиться, что их веб-приложения будут работать при обращении к браузеру, который не поддерживает JavaScript. Поскольку AJAX зависит от JavaScript, некоторые разработчики не используют Ajax.

Тем не менее, если вы с осторожностью реализуете AJAX, то можете создавать приложения, работающие как с обозревателем верхнего уровня, так и с предыдущими версиями. Наше приложение диспетчера контактов будет работать с браузерами, поддерживающими JavaScript и браузеры, не имеющие.

Если вы используете приложение диспетчера контактов с браузером, поддерживающим JavaScript, вы получите более эффективное взаимодействие с пользователем. Например, если щелкнуть группу контактов, будут обновлены только области страницы, на которой отображаются контакты.

Если, с другой стороны, вы используете приложение диспетчера контактов с браузером, который не поддерживает JavaScript (или с отключенным JavaScript), у вас будет немного менее желательный пользовательский интерфейс. Например, если щелкнуть группу контактов, то все представление индекса должно быть отправлено обратно в браузер, чтобы отобразить соответствующий список контактов.

## <a name="adding-the-required-javascript-files"></a>Добавление необходимых файлов JavaScript

Для добавления функциональных возможностей AJAX в наше приложение необходимо использовать три файла JavaScript. Все три файла включены в папку Scripts нового приложения MVC ASP.NET.

Если вы планируете использовать AJAX на нескольких страницах в приложении, то имеет смысл включить необходимые файлы JavaScript на главную страницу представления приложения. Таким образом, файлы JavaScript будут автоматически включаться во все страницы приложения.

Добавьте следующий код JavaScript в тег &lt;Head&gt; главной страницы представления.

[!code-html[Main](iteration-7-add-ajax-functionality-cs/samples/sample1.html)]

## <a name="refactoring-the-index-view-to-use-ajax"></a>Рефакторинг представления индекса для использования Ajax

Давайте начнем с изменения нашего представления индекса, чтобы при щелчке группы контактов только обновить область представления, в которой отображаются контакты. Красный прямоугольник на рис. 1 содержит регион, который требуется обновить.

[![обновление только контактов](iteration-7-add-ajax-functionality-cs/_static/image1.jpg)](iteration-7-add-ajax-functionality-cs/_static/image1.png)

**Рис. 01**. обновление только контактов ([щелкните, чтобы просмотреть изображение с полным размером](iteration-7-add-ajax-functionality-cs/_static/image2.png))

Первым шагом является отделение части представления, которую требуется обновить асинхронно, в отдельную частичную часть (представление пользовательского элемента управления). Раздел представления индекса, в котором отображается таблица контактов, был перемещен в частичное содержание в листинге 1.

**Листинг 1. Виевс\контакт\контактлист.асккс**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample2.aspx)]

Обратите внимание, что часть в листинге 1 имеет другую модель, чем представление индекса. Атрибут *Inherits* в директиве &lt;% @ Page%&gt; указывает, что разделяемый класс наследуется от класса Виевусерконтрол&lt;Group&gt;.

Обновленное представление индекса содержится в листинге 2.

**Листинг 2. Виевс\контакт\индекс.аспкс**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample3.aspx)]

В листинге 2 следует обратить внимание на два момента. Во-первых, обратите внимание, что все содержимое, перемещенное в частичное, заменяется вызовом HTML. Рендерпартиал (). Метод HTML. Рендерпартиал () вызывается при первом запросе представления индекса для отображения начального набора контактов.

Во-вторых, обратите внимание, что HTML. ActionLink (), используемый для вывода групп контактов, был заменен на AJAX. ActionLink (). AJAX. ActionLink () вызывается со следующими параметрами:

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample4.aspx)]

Первый параметр представляет текст, отображаемый для ссылки, второй параметр представляет значения маршрута, а третий параметр представляет параметры AJAX. В этом случае мы используем параметр Упдатетаржетид AJAX для указания HTML-тега &lt;div&gt;, который нужно обновить после завершения запроса AJAX. Мы хотим обновить тег &lt;div&gt; с новым списком контактов.

Обновленный метод Index () контактного контроллера содержится в листинге 3.

**Листинг 3 — Контроллерс\контактконтроллер.КС (метод Index)**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample5.cs)]

Обновленное действие index () условно возвращает одно из двух действий. Если действие index () вызывается запросом Ajax, контроллер возвращает частичный результат. В противном случае действие index () возвращает все представление.

Обратите внимание, что действие index () не должно возвращать столько данных, сколько было вызвано запросом Ajax. В контексте обычного запроса действие индекса возвращает список всех групп контактов и выбранную группу контактов. В контексте запроса AJAX действие index () возвращает только выбранную группу. Ajax означает меньше работы на сервере базы данных.

Измененное представление индекса работает в случае с обозревателями верхнего и нижнего уровня. Если щелкнуть группу контактов и браузер поддерживает JavaScript, то обновляется только регион представления, содержащего список контактов. Если, с другой стороны, браузер не поддерживает JavaScript, то обновляется все представление.

В нашем обновленном представлении индекса есть одна проблема. Если щелкнуть группу контактов, выбранная группа не будет выделена. Так как список групп отображается за пределами региона, обновляемого во время запроса AJAX, правая группа не выделяется. Эта проблема будет исправлена в следующем разделе.

## <a name="adding-jquery-animation-effects"></a>Добавление эффектов анимации jQuery

Обычно при щелчке ссылки на веб-странице можно использовать индикатор выполнения браузера, чтобы определить, будет ли браузер получать обновленное содержимое. С другой стороны, при выполнении запроса AJAX индикатор выполнения обозревателя не показывает ход выполнения. Это может сделать пользователей нервной. Как узнать, закреплен ли браузер?

Существует несколько способов указать пользователю, что выполняется работа во время выполнения запроса AJAX. Одним из подходов является отображение простой анимации. Например, можно появление региона, когда начинается запрос Ajax и происходит исчезновение области по завершении запроса.

Для создания эффектов анимации мы будем использовать библиотеку jQuery, которая входит в состав платформы Microsoft ASP.NET MVC. Обновленное представление индекса содержится в листинге 4.

**Листинг 4. Виевс\контакт\индекс.аспкс**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample6.aspx)]

Обратите внимание, что обновленное представление индекса содержит три новые функции JavaScript. Первые две функции используют jQuery для исчезновения и исчезновения списка контактов при щелчке новой группы контактов. Третья функция отображает сообщение об ошибке, если запрос Ajax приводит к ошибке (например, время ожидания сети).

Первая функция также отвечает за выделение выбранной группы. Класс = выбранный атрибут добавляется к родительскому элементу (элементу LI) элемента, который щелкнули. Кроме того, jQuery позволяет легко выбрать нужный элемент и добавить класс CSS.

Эти скрипты связаны с ссылками группы с помощью параметра Ажаксоптионс AJAX. ActionLink (). Обновленный вызов метода Ajax. ActionLink () выглядит следующим образом:

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample7.aspx)]

## <a name="adding-browser-history-support"></a>Добавление поддержки журнала браузера

Обычно при щелчке ссылки для обновления страницы журнал браузера обновляется. Таким образом, можно нажать кнопку назад в браузере, чтобы вернуться назад к предыдущему состоянию страницы. Например, если щелкнуть группу контактов друзья, а затем выбрать группу бизнес-контактов, можно нажать кнопку назад в браузере, чтобы вернуться к состоянию страницы, когда была выбрана группа контактов друзья.

К сожалению, выполнение запроса AJAX не обновляет журнал браузера автоматически. Если щелкнуть группу контактов, а список соответствующих контактов будет получен с помощью запроса AJAX, то журнал браузера не обновляется. Нельзя использовать кнопку назад в браузере для перехода к группе контактов после выбора новой группы контактов.

Если вы хотите, чтобы пользователи могли использовать кнопку браузера назад после выполнения запросов AJAX, необходимо выполнить еще немного работы. Необходимо воспользоваться преимуществами функций управления журналом браузера, встроенных в платформу ASP.NET AJAX.

Журнал браузера ASP.NET AJAX необходимо выполнить три действия:

1. Включите журнал браузера, задав для свойства Енаблебровсерхистори значение true.
2. Сохранять точки журнала при изменении состояния представления путем вызова метода addHistoryPoint ().
3. Восстанавливает состояние представления при возникновении события перехода.

Обновленное представление индекса содержится в листинге 5.

**Листинг 5. Виевс\контакт\индекс.аспкс**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample8.aspx)]

В листинге 5 журнал браузера включен в функции Пажеинит (). Функция Пажеинит () также используется для настройки обработчика событий для события перехода. Событие перехода возникает при каждом изменении состояния страницы при нажатии кнопки браузера вперед или назад.

Метод Бегинконтактлист () вызывается при щелчке группы контактов. Этот метод создает новую точку журнала путем вызова метода addHistoryPoint (). Идентификатор группы контактов, которую вы щелкнули, добавляется в журнал.

Идентификатор группы извлекается из атрибута expando в ссылке на группу контактов. Ссылка отображается со следующим вызовом AJAX. ActionLink ().

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample9.aspx)]

Последний параметр, переданный в AJAX. ActionLink (), добавляет к ссылке атрибут expando с именем groupId (нижний регистр для совместимости с XHTML).

Когда пользователь нажимает кнопку «назад» или «вперед», вызывается событие «переход» и вызывается метод Navigate (). Этот метод обновляет контакты, отображаемые на странице, чтобы соответствовать состоянию страницы, соответствующему точке журнала браузера, переданной в метод Navigate.

## <a name="performing-ajax-deletes"></a>Выполнение удалений AJAX

В настоящее время для удаления контакта необходимо щелкнуть ссылку удалить, а затем нажать кнопку Удалить на странице подтверждения удаления (см. рис. 2). Это кажется большим количеством запросов страниц, что делает что-то вроде удаления записи базы данных.

[![страницы подтверждения удаления](iteration-7-add-ajax-functionality-cs/_static/image2.jpg)](iteration-7-add-ajax-functionality-cs/_static/image3.png)

**Рис. 02**. страница подтверждения удаления ([щелкните, чтобы просмотреть изображение с полным размером](iteration-7-add-ajax-functionality-cs/_static/image4.png))

Можно пропустить страницу подтверждения удаления и удалить контакт непосредственно из представления индекса. Следует избегать этого искушения, так как при таком подходе приложение будет открываться с учетом брешей в системе безопасности. Как правило, при вызове действия, изменяющего состояние веб-приложения, не нужно выполнять операцию HTTP GET. При выполнении операции удаления необходимо выполнить HTTP-запрос POST или еще более, чем операция HTTP DELETE.

Ссылка Delete содержится в ContactList частично. Обновленная версия частичного ContactList содержится в листинге 6.

**Листинг 6. Виевс\контакт\контактлист.асккс**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample10.aspx)]

Ссылка Delete визуализируется следующим вызовом метода Ajax. ImageActionLink ():

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample11.aspx)]

> [!NOTE] 
> 
> AJAX. ImageActionLink () не является стандартной частью платформы ASP.NET MVC. AJAX. ImageActionLink () — это пользовательские вспомогательные методы, включенные в проект диспетчера контактов.

Параметр Ажаксоптионс имеет два свойства. Во-первых, свойство Confirm используется для вывода диалогового окна подтверждения JavaScript. Во-вторых, свойство HttpMethod используется для выполнения операции HTTP DELETE.

В листинге 7 содержится новое действие Ажаксделете (), добавленное в контактный контроллер.

**Листинг 7 — Контроллерс\контактконтроллер.КС (Ажаксделете)**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample12.cs)]

Действие Ажаксделете () дополнено атрибутом Акцептвербс. Этот атрибут предотвращает вызов действия, за исключением любых операций HTTP, отличных от операции HTTP DELETE. В частности, нельзя вызвать это действие с помощью HTTP GET.

После удаления записи базы данных необходимо отобразить обновленный список контактов, не содержащий удаленную запись. Метод Ажаксделете () возвращает частичный ContactList и обновленный список контактов.

## <a name="summary"></a>Сводка

В этой итерации мы добавили функциональность AJAX в приложение диспетчера контактов. Мы использовали AJAX для улучшения скорости реагирования и производительности нашего приложения.

Во-первых, мы выполнили рефакторинг представления индекса, чтобы при щелчке группы контактов не было Обновлено все представление. Вместо этого при щелчке группы контактов обновляется только список контактов.

Далее мы использовали эффекты анимации jQuery для исчезновения и исчезновения списка контактов. Добавление анимации в приложение AJAX можно использовать для предоставления пользователям приложения эквивалентом индикатора выполнения браузера.

Мы также добавили поддержку журнала браузера в наше приложение AJAX. Мы включили пользователей, чтобы изменить состояние представления индекса, нажав кнопки назад и вперед.

Наконец, мы создали ссылку DELETE, которая поддерживает операции HTTP DELETE. Выполняя удаление AJAX, пользователи могут удалять записи базы данных, не требуя от пользователя запрашивать дополнительную страницу подтверждения удаления.

> [!div class="step-by-step"]
> [Назад](iteration-6-use-test-driven-development-cs.md)
> [Вперед](iteration-1-create-the-application-vb.md)
