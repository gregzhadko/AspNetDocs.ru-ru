---
uid: mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
title: 'Итерация #7 - Добавить функциональность Ajax (C) Документы Майкрософт'
author: rick-anderson
description: В седьмой итерации мы улучшаем отзывчивость и производительность нашего приложения, добавляя поддержку Ajax.
ms.author: riande
ms.date: 02/20/2009
ms.assetid: f1b0809e-8909-444e-b6bb-a5cd1dea3f72
msc.legacyurl: /mvc/overview/older-versions-1/contact-manager/iteration-7-add-ajax-functionality-cs
msc.type: authoredcontent
ms.openlocfilehash: 12d7348382bc55af049567922bd6963970a9421b
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81542317"
---
# <a name="iteration-7--add-ajax-functionality-c"></a>Итерация 7. Добавление функций Ajax (C#)

[корпорацией Майкрософт](https://github.com/microsoft)

[Скачать код](iteration-7-add-ajax-functionality-cs/_static/contactmanager_7_cs1.zip)

> В седьмой итерации мы улучшаем отзывчивость и производительность нашего приложения, добавляя поддержку Ajax.

## <a name="building-a-contact-management-aspnet-mvc-application-c"></a>Создание приложения управления контактами ASP.NET MVC (C)

В этой серии учебников мы создаем все приложение Управления Контактами от начала до конца. Приложение Contact Manager позволяет хранить контактную информацию - имена, номера телефонов и адреса электронной почты - для списка людей.

Мы строим приложение по нескольким итерациям. С каждой итерацией мы постепенно совершенствуем приложение. Цель этого подхода с множественной итерацией состоит в том, чтобы вы могли понять причину каждого изменения.

- Итерация #1 - Создайте приложение. В первой итерации мы создаем Контакт-менеджер самым простым способом. Мы добавляем поддержку для основных операций базы данных: Создание, чтение, обновление и удаление (CRUD).

- Итерация #2 - Сделать приложение хорошо выглядеть. В этой итерации мы улучшаем внешний вид приложения, изменяя страницу по умолчанию ASP.NET MVC просмотра и каскадный стиль листа.

- Итерация #3 - Добавить проверку формы. В третьей итерации мы добавляем базовую проверку формы. Мы не позволяем людям подавать форму без заполнения требуемых полей формы. Мы также проверяем адреса электронной почты и номера телефонов.

- Итерация #4 - Сделать приложение слабо связаны. В этой четвертой итерации мы воспользуемся несколькими шаблонами проектирования программного обеспечения, чтобы упростить обслуживание и изменение приложения Contact Manager. Например, мы рефакторизуем наше приложение, чтобы использовать шаблон репозитория и шаблон инъекций зависимостей.

- Итерация #5 - Создание модульных тестов. В пятой итерации мы упрощаем обслуживание и модификацию нашего приложения путем добавления модульных тестов. Мы издеваемся над нашими классами моделей данных и строим модульные тесты для наших контроллеров и логики проверки.

- Итерация #6 - Использование тест-ориентированной разработки. В этой шестой итерации мы добавляем новую функциональность в наше приложение, написав модульные тесты сначала и написав код против модульных тестов. В этой итерации мы добавляем контактные группы.

- Итерация #7 - Добавить функциональность Ajax. В седьмой итерации мы улучшаем отзывчивость и производительность нашего приложения, добавляя поддержку Ajax.

## <a name="this-iteration"></a>Эта итерация

В этой итерации приложения Contact Manager мы рефакторинг нашего приложения, чтобы использовать Ajax. Воспользовавшись Преимуществами Ajax, мы делаем наше приложение более отзывчивым. Мы можем избежать визуализации всей страницы, когда нам нужно обновить только определенный регион на странице.

Мы рефакторинг нашего индекса зрения так, что нам не нужно повторно отображать всю страницу, когда кто-то выбирает новую контактную группу. Вместо этого, когда кто-то нажимает на контактную группу, мы просто обновим список контактов и оставим остальную часть страницы в покое.

Мы также изменим способ работы нашей ссылки на удаление. Вместо того, чтобы отображать отдельную страницу подтверждения, мы отображаем диалог подтверждения JavaScript. Если вы подтверждаете, что хотите удалить контакт, против сервера выполняется операция HTTP DELETE для удаления записи контактов из базы данных.

Кроме того, мы воспользуемся j'ery, чтобы добавить эффекты анимации в наш индекс ный эффект. Мы отобразим анимацию, когда новый список контактов будет извлечен с сервера.

Наконец, мы воспользуемся ASP.NET поддержкой рамок AJAX для управления историей браузера. Мы будем создавать точки истории всякий раз, когда выполняем вызов Ajax для обновления списка контактов. Таким образом, браузер назад и вперед кнопки будут работать.

## <a name="why-use-ajax"></a>Зачем использовать Ajax?

Использование Ajax имеет много преимуществ. Во-первых, добавление функциональности Ajax в приложение приводит к улучшению пользовательского опыта. В обычном веб-приложении вся страница должна быть размещена обратно на сервер каждый раз, когда пользователь выполняет действие. Всякий раз, когда вы выполняете действие, браузер блокирует, и пользователь должен ждать, пока вся страница будет извлечена и повторно отображается.

Это было бы неприемлемым опытом в случае настольного приложения. Но, традиционно, мы жили с этим плохим опытом пользователя в случае веб-приложения, потому что мы не знали, что мы могли бы сделать лучше. Мы думали, что это ограничение веб-приложений, когда, в действительности, это было просто ограничение нашего воображения.

В приложении Ajax не нужно приостанавливать работу пользователя только для обновления страницы. Вместо этого можно выполнить асинхронный запрос в фоновом режиме для обновления страницы. Вы не заставите пользователя ждать, пока часть страницы будет обновлена.

Воспользовавшись преимуществами Ajax, вы также можете повысить производительность приложения. Рассмотрим, как приложение Contact Manager работает прямо сейчас без функциональности Ajax. При нажатии на контактную группу весь представление Индекса должно быть повторно отображено. Список контактов и список контактных групп должны быть извлечены с сервера базы данных. Все эти данные должны передаваться по проводу от веб-сервера до веб-браузера.

Однако после добавления функциональности Ajax в наше приложение мы можем избежать повторного отображения всей страницы, когда пользователь нажимает на контактную группу. Нам больше не нужно загоните контактные группы из базы данных. Нам также не нужно проталкивать весь вид Индекса по проводу. Воспользовавшись преимуществами Ajax, мы сокращаем объем работы, который должен выполнять наш сервер базы данных, и уменьшаем объем сетевого трафика, требуемого нашим приложением.

## <a name="don-t-be-afraid-of-ajax"></a>Не бойтесь Ajax

Некоторые разработчики избегают использования Ajax, потому что они беспокоятся о браузерах уровня downlevel. Они хотят убедиться, что их веб-приложения будут по-прежнему работать при доступе к браузеру, который не поддерживает JavaScript. Поскольку Ajax зависит от JavaScript, некоторые разработчики избегают использования Ajax.

Однако, если вы тщательно о том, как вы реализуете Ajax, то вы можете создавать приложения, которые работают как с уровня и низом браузеров. Наше приложение Contact Manager будет работать с браузерами, которые поддерживают JavaScript и браузеры, которые этого не делают.

Если вы используете приложение Contact Manager с браузером, который поддерживает JavaScript, то вы будете иметь лучший пользовательский опыт. Например, при нажатии на контактную группу будет обновлена только область страницы, отображающие контакты.

Если, с другой стороны, вы используете приложение Contact Manager с браузером, который не поддерживает JavaScript (или что JavaScript отключен), то вы будете иметь немного менее желательным пользовательский опыт. Например, при нажатии на контактную группу все представление Индекса должно быть отправлено обратно в браузер, чтобы отобразить соответствующий список контактов.

## <a name="adding-the-required-javascript-files"></a>Добавление требуемых файлов JavaScript

Для добавления функциональности Ajax в наше приложение нам необходимо использовать три файла JavaScript. Все три этих файла включены в папку скриптов нового приложения mVC ASP.NET.

Если вы планируете использовать Ajax на нескольких страницах в приложении, то имеет смысл включить необходимые файлы JavaScript в страницу просмотра приложения. Таким образом, файлы JavaScript будут автоматически включены на всех страницах приложения.

Добавьте следующий JavaScript &lt;&gt; включает в головную бирку страницы главной страницы просмотра:

[!code-html[Main](iteration-7-add-ajax-functionality-cs/samples/sample1.html)]

## <a name="refactoring-the-index-view-to-use-ajax"></a>Рефакторинг представления индекса для использования Ajax

Начнем с изменения представления Индекса таким образом, чтобы нажатие на контактную группу обновляло только область представления, отображающего контакты. Красная коробка на рисунке 1 содержит область, которую мы хотим обновить.

[![Обновление только контактов](iteration-7-add-ajax-functionality-cs/_static/image1.jpg)](iteration-7-add-ajax-functionality-cs/_static/image1.png)

**Рисунок 01**: Обновление только контактов[(Нажмите, чтобы просмотреть полноразмерное изображение](iteration-7-add-ajax-functionality-cs/_static/image2.png))

Первый шаг заключается в разделении части представления, которую мы хотим обновить асинхронно, на отдельный частичный (просмотр пользовательского управления). Раздел представления индекса, отображающие таблицу контактов, был перемещен в частичный в листинге 1.

**Список 1 - Просмотры /Контакт/Контакт-Лист.ascx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample2.aspx)]

Обратите внимание, что частичное в листинге 1 имеет иную модель, чем представление индекса. Атрибут *«Наследуемые»* в&gt; директиве &lt;% означает, что частичное наследство&lt;&gt; от класса ViewUserControl Group.

Обновленное представление индекса содержится в листинге 2.

**Список 2 - Просмотры »Контакт»Индекс.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample3.aspx)]

Есть две вещи, которые вы должны заметить об обновленном представлении в листинге 2. Во-первых, обратите внимание, что все содержимое, перемещенное в частичное, заменяется вызовом на Html.RenderPartial(). Метод Html.RenderPartial() вызывается при первом запросе представления индекса для отображения исходного набора контактов.

Во-вторых, обратите внимание, что Html.ActionLink() используется для отображения контактных групп был заменен на Ajax.ActionLink(). Ajax.ActionLink () называется со следующими параметрами:

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample4.aspx)]

Первый параметр представляет текст для отображения для ссылки, второй параметр представляет значения маршрута, а третий параметр представляет параметры Ajax. В этом случае мы используем опцию UpdateTargetId &lt;Ajax, чтобы указать на тег HTML div,&gt; который мы хотим обновить после завершения запроса Ajax. Мы хотим обновить &lt;&gt; тег div с новым списком контактов.

Обновленный метод индекса () контроллера контакта содержится в листинге 3.

**Список 3 - Контролеры/ContactController.cs (Метод индекса)**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample5.cs)]

Обновленное действие Индекса () условно возвращает одну из двух вещей. Если действие Index() вызывается запросом Ajax, то контроллер возвращает частичное. В противном случае действие Индекса () возвращает все представление.

Обратите внимание, что действию Index () не нужно возвращать как можно больше данных при вызове запроса Ajax. В контексте обычного запроса действие Индекса возвращает список всех контактных групп и выбранной контактной группы. В контексте запроса Ajax действие Index() возвращает только выбранную группу. Ajax означает меньше работы на сервере базы данных.

Наше измененное представление индекса работает в случае браузеров на уровне и уровнен. Если вы нажмете контактную группу, и ваш браузер поддерживает JavaScript, то обновляется только область представления, содержащая список контактов. Если, с другой стороны, ваш браузер не поддерживает JavaScript, то все представление обновляется.

У нашего обновленного представления индекса есть одна проблема. При нажатии на контактную группу выбранная группа не выделяется. Поскольку список групп отображается за пределами региона, который обновляется во время запроса Ajax, правильная группа не выделяется. Мы исправим эту проблему в следующем разделе.

## <a name="adding-jquery-animation-effects"></a>Добавление эффектов анимации j''ry

Обычно при нажатии на ссылку на веб-странице можно использовать панель прогресса браузера, чтобы определить, активно ли браузер извлечения обновленного содержимого. С другой стороны, при выполнении запроса Ajax в строке прогресса браузера не отображает никакого прогресса. Это может заставить пользователей нервничать. Как вы знаете, является ли браузер заморожен?

Существует несколько способов, которые можно указать пользователю, что работа выполняется при выполнении запроса Ajax. Один из подходов заключается в отображении простой анимации. Например, можно исчезнуть из региона, когда начинается запрос Ajax, и исчезать в регионе по завершении запроса.

Для создания анимационных эффектов мы воспользуемся библиотекой j'wery, которая включена в структуру Microsoft ASP.NET MVC. Обновленное представление индекса содержится в листинге 4.

**Список 4 - Просмотры »Контакт»Индекс.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample6.aspx)]

Обратите внимание, что обновленное представление индекса содержит три новые функции JavaScript. Первые две функции используют j's'query, чтобы исчезнуть и исчезнуть в списке контактов при нажатии на новую контактную группу. Третья функция отображает сообщение об ошибке, когда запрос Ajax приводит к ошибке (например, тайм-аут сети).

Первая функция также заботится о выделении выбранной группы. Выбранный атрибут класса добавляется к родительскому элементу (элементу LI) нажатого элемента. Опять же, j'c'еry упрощает выбор правильного элемента и добавление класса CSS.

Эти скрипты привязаны к групповым ссылкам с помощью параметра Ajax.ActionLink() AjaxOptions. Обновленный вызов метода Ajax.ActionLink() выглядит следующим образом:

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample7.aspx)]

## <a name="adding-browser-history-support"></a>Добавление поддержки истории браузера

Обычно при нажатии на ссылку для обновления страницы история браузера обновляется. Таким образом, вы можете нажать кнопку "Назад" браузера, чтобы вернуться назад во времени к предыдущему состоянию страницы. Например, если вы нажмете контактную группу «Друзья», а затем нажмете на контактную группу «Бизнес», можно нажать кнопку «Назад» браузера, чтобы перейти к состоянию страницы при выборе контактной группы «Друзья».

К сожалению, выполнение запроса Ajax не обновляет историю браузера автоматически. Если вы нажмете контактную группу, и список соответствующих контактов будет извлечен с помощью запроса Ajax, то история браузера не обновляется. Вы не можете использовать кнопку "Назад" браузера для навигации обратно в контактную группу после выбора новой контактной группы.

Если вы хотите, чтобы пользователи могли использовать кнопку "Назад" браузера после выполнения запросов Ajax, то вам нужно выполнить немного больше работы. Вы должны воспользоваться функциональностью управления историей браузера, построенной в ASP.NET AJAX Framework.

ASP.NET истории браузера AJAX, вам нужно сделать три вещи:

1. Включите историю браузера, установив свойство enableBrowserHistory на истину.
2. Сохранение моментов истории при изменении состояния представления, вызывая метод addHistoryPoint()
3. Восстановить состояние представления при поднятии события навигации.

Обновленное представление индекса содержится в листинге 5.

**Список 5 - Просмотры »Контакт»Индекс.aspx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample8.aspx)]

В листинге 5 история браузера включена в функции pageInit() . Функция pageInit() также используется для настройки обработчика событий для события навигации. Событие навигации возникает всякий раз, когда кнопка «Вперед или назад» приводит к изменению состояния страницы.

Метод BeginContactList() вызывается при нажатии контактной группы. Этот метод создает новую точку истории, вызывая метод addHistoryPoint() Идентификатор нажмите контактную группу добавляется в историю.

Идентификатор группы извлекается из атрибута expando на ссылке контактной группы. Ссылка отображается со следующим вызовом на Ajax.ActionLink().

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample9.aspx)]

Последний параметр, передаваемый на Ajax.ActionLink() добавляет атрибут expando, названный groupid, к ссылке (нижний регистр для совместимости XHTML).

Когда пользователь направляется в кнопку «Назад» или «Вперед», событие навигации повышается и вызывается метод навигации() Этот метод обновляет контакты, отображаемые на странице, чтобы соответствовать состоянию страницы, которая соответствует точке истории браузера, передаваемым методу навигации.

## <a name="performing-ajax-deletes"></a>Выполнение Ajax Удаляет

В настоящее время для того, чтобы удалить контакт, необходимо нажать на ссылку Удалить, а затем нажмите кнопку Удалить отображается на странице подтверждения удаления (см. Рисунок 2). Это кажется большим количеством запросов на страницы, чтобы сделать что-то простое, например, удалять запись базы данных.

[![Страница подтверждения удаления](iteration-7-add-ajax-functionality-cs/_static/image2.jpg)](iteration-7-add-ajax-functionality-cs/_static/image3.png)

**Рисунок 02**: Страница подтверждения удаления[(Нажмите, чтобы просмотреть полноразмерное изображение)](iteration-7-add-ajax-functionality-cs/_static/image4.png)

Заманчиво пропустить страницу подтверждения удаления и удалить контакт непосредственно из представления Индекса. Вы должны избегать этого искушения, потому что при таком подходе открывает приложение для дыр в безопасности. Как правило, вы не хотите выполнять операцию HTTP GET при входе в действие, которое изменяет состояние вашего веб-приложения. При выполнении удаления требуется выполнить http POST, или еще лучше, http DELETE операции.

Ссылка «Удалить» содержится в частичном контактном листе. Обновленная версия частичного контакта содержится в листинге 6.

**Список 6 - Просмотры /Контакт/КонтактЛист.ascx**

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample10.aspx)]

Ссылка «Удалить» отображается следующим вызовом метода Ajax.ImageActionLink()

[!code-aspx[Main](iteration-7-add-ajax-functionality-cs/samples/sample11.aspx)]

> [!NOTE] 
> 
> Ajax.ImageActionLink() не является стандартной частью ASP.NET mVC. Ajax.ImageActionLink() — это пользовательские методы помощи, включенные в проект «Контакт-менеджер».

Параметр AjaxOptions имеет два свойства. Во-первых, свойство «Подтверждение» используется для отображения диалога о подтверждении JavaScript всплывающих окно. Во-вторых, свойство HttpMethod используется для выполнения операции HTTP DELETE.

Список 7 содержит новое действие AjaxDelete(), добавленное в контроллер Контакта.

**Список 7 - Контролеры-КонтактКонтроллер.cs (AjaxDelete)**

[!code-csharp[Main](iteration-7-add-ajax-functionality-cs/samples/sample12.cs)]

Акция AjaxDelete() украшена атрибутом AcceptVerbs. Этот атрибут предотвращает вызов действия, за исключением любой операции HTTP, кроме операции HTTP DELETE. В частности, вы не можете вызвать это действие с HTTP GET.

После удаления записи базы данных необходимо отобразить обновленный список контактов, который не содержит удаленной записи. Метод AjaxDelete () возвращает Частичное и обновленный список контактов ContactList.

## <a name="summary"></a>Сводка

В этой итерации мы добавили функциональность Ajax в наше приложение Contact Manager. Мы использовали Ajax для повышения оперативности и производительности нашего приложения.

Во-первых, мы рефакторинг представления индекса, так что нажатие контактной группы не обновляет весь вид. Вместо этого нажатие на контактную группу обновляет список контактов только.

Далее, мы использовали j'wery анимационные эффекты, чтобы исчезнуть и исчезают в списке контактов. Добавление анимации в приложение Ajax может быть использовано для предоставления пользователям приложения эквивалента панели прогресса браузера.

Мы также добавили поддержку истории браузера в наше приложение Ajax. Мы позволили пользователям нажать кнопки «Назад и вперед» для изменения состояния представления Индекса.

Наконец, мы создали ссылку на удаление, которая поддерживает операции HTTP DELETE. Выполняя удаления Ajax, мы позволяем пользователям удалять записи баз данных, не требуя от пользователя запроса дополнительной страницы подтверждения удаления.

> [!div class="step-by-step"]
> [Назад](iteration-6-use-test-driven-development-cs.md)
> [Вперед](iteration-1-create-the-application-vb.md)
