---
uid: mvc/overview/getting-started/introduction/adding-search
title: Поиск | Документация Майкрософт
author: Rick-Anderson
description: ''
ms.author: riande
ms.date: 01/17/2019
ms.assetid: df001954-18bf-4550-b03d-43911a0ea186
msc.legacyurl: /mvc/overview/getting-started/introduction/adding-search
msc.type: authoredcontent
ms.openlocfilehash: be4e4d13e574b0fcb77d2d0fb8c6f58041b1ece2
ms.sourcegitcommit: 4e6d586faadbe4d9ef27122f86335ec9385134af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2020
ms.locfileid: "89044925"
---
# <a name="search"></a>Поиск

[!INCLUDE [consider RP](~/includes/razor.md)]

## <a name="adding-a-search-method-and-search-view"></a>Добавление метода поиска и представления поиска

В этом разделе вы добавите функцию поиска в `Index` метод действия, который позволяет искать фильмы по жанру или названию.

## <a name="prerequisites"></a>Обязательные условия

Чтобы сопоставить снимки экрана этого раздела, необходимо запустить приложение (F5) и добавить в базу данных следующие фильмы.

| Заголовок | Дата выпуска | Genre | Цена |
| ----- | ------------ | ----- | ----- |
| Ghostbusters | 6/8/1984 | Комедия | 6,99 |
| Ghostbusters II | 6/16/1989 | Комедия | 6,99 |
| Планета АПЕС | 3/27/1986 | Действие | 5,99 |

## <a name="updating-the-index-form"></a>Обновление формы индекса

Начните с обновления `Index` метода действия до существующего `MoviesController` класса. Вот этот код:

[!code-csharp[Main](adding-search/samples/sample1.cs?highlight=1,6-9)]

Первая строка `Index` метода создает следующий запрос [LINQ](https://msdn.microsoft.com/library/bb397926.aspx) для выбора фильмов:

[!code-csharp[Main](adding-search/samples/sample2.cs)]

Запрос определен на этом этапе, но еще не выполнялся для базы данных.

Если `searchString` параметр содержит строку, запрос фильмов изменяется для фильтрации по значению строки поиска с помощью следующего кода:

[!code-csharp[Main](adding-search/samples/sample3.cs)]

Приведенный выше код `s => s.Title` представляет собой [лямбда-выражение](https://msdn.microsoft.com/library/bb397687.aspx). Лямбда-выражения используются в запросах [LINQ](https://msdn.microsoft.com/library/bb397926.aspx) на основе методов в качестве аргументов методов стандартных операторов запросов, таких как метод [WHERE](https://msdn.microsoft.com/library/system.linq.enumerable.where.aspx) , используемый в приведенном выше коде. Запросы LINQ не выполняются, если они определены или изменяются путем вызова метода, такого как `Where` или `OrderBy` . Вместо этого выполнение запроса откладывается, что означает, что вычисление выражения откладывается до тех пор, пока его реализованное значение фактически не будет перебираться или [`ToList`](https://msdn.microsoft.com/library/bb342261.aspx) метод не будет вызван. В этом `Search` примере запрос выполняется в представлении *index. cshtml* . Дополнительные сведения об отложенном и немедленном выполнении запросов см. в разделе [Выполнение запроса](https://msdn.microsoft.com/library/bb738633.aspx).

> [!NOTE]
> Метод [Contains](https://msdn.microsoft.com/library/bb155125.aspx) выполняется в базе данных, а не в коде c#, приведенном выше. В базе данных [содержит](https://msdn.microsoft.com/library/bb155125.aspx) сопоставление с [SQL LIKE](https://msdn.microsoft.com/library/ms179859.aspx), в котором регистр не учитывается.

Теперь можно обновить `Index` представление, которое будет отображать форму пользователю.

Запустите приложение и перейдите по адресу */мовиес/индекс*. Добавьте в URL-адрес строку запроса, например `?searchString=ghost`. Отображаются отфильтрованные фильмы.

![сеарчкристр](adding-search/_static/image1.png)

Если изменить сигнатуру `Index` метода для параметра с именем `id` , `id` параметр будет соответствовать `{id}` заполнительу для маршрутов по умолчанию, заданных в файле * \_ старт\раутеконфиг.КС приложения* .

[!code-json[Main](adding-search/samples/sample4.txt)]

Исходный `Index` метод выглядит следующим образом:

[!code-csharp[Main](adding-search/samples/sample5.cs)]

Измененный `Index` метод будет выглядеть следующим образом:

[!code-csharp[Main](adding-search/samples/sample6.cs?highlight=1,3)]

Теперь можно передать заголовок поиска в качестве данных маршрута (сегмент URL-адреса) вместо значения строки запроса.

![](adding-search/_static/image2.png)

Тем не менее пользователи вряд ли будут каждый раз изменять URL-адрес для поиска фильмов. Итак, теперь вам необходимо добавить пользовательский интерфейс для удобства фильтрации фильмов. Если вы изменили сигнатуру `Index` метода, чтобы проверить, как передать параметр идентификатора, привязанного к маршруту, измените его обратно, чтобы метод задавал `Index` строковый параметр с именем `searchString` :

[!code-csharp[Main](adding-search/samples/sample7.cs)]

Откройте файл *виевс\мовиес\индекс.кштмл* и сразу после `@Html.ActionLink("Create New", "Create")` добавьте разметку формы, выделенную ниже:

[!code-cshtml[Main](adding-search/samples/sample8.cshtml?highlight=12-15)]

`Html.BeginForm`Вспомогательный объект создает открывающий `<form>` тег. `Html.BeginForm`Вспомогательная функция заставляет форму опубликовать себя, когда пользователь отправит форму, нажав кнопку **Фильтр** .

Visual Studio 2013 имеет хорошее улучшение при отображении и изменении файлов представления. При запуске приложения с открытым файлом представления Visual Studio 2013 вызывает правильный метод действия контроллера для отображения представления.

![](adding-search/_static/image3.png)

Откройте представление индекса в Visual Studio (как показано на рисунке выше), нажмите клавишу CTRL F5 или F5, чтобы запустить приложение, а затем попробуйте найти фильм.

![](adding-search/_static/image4.png)

`HttpPost`Перегрузка `Index` метода отсутствует. Это не требуется, так как метод не изменяет состояние приложения, просто отфильтровывая данные.

Можно добавить следующий метод `HttpPost Index`. В этом случае вызывающий элемент действия будет соответствовать `HttpPost Index` методу, и `HttpPost Index` метод будет выполняться, как показано на рисунке ниже.

[!code-csharp[Main](adding-search/samples/sample9.cs)]

![сеарчпостгхост](adding-search/_static/image5.png)

Тем не менее при добавлении этой версии `HttpPost` метода `Index` существует ограничение на общую реализацию. Допустим, вам необходимо добавить в закладки конкретный поиск или отправить друзьям ссылку, по которой они могут просмотреть аналогичный отфильтрованный список фильмов. Обратите внимание на то, что URL-адрес запроса HTTP POST совпадает с URL-адресом для запроса GET (localhost: XXXXX/Movies/index) — в самом URL-адресе отсутствует информация для поиска. Сейчас данные строки поиска отправляются на сервер в виде значения поля формы. Это означает, что вы не сможете записать эту информацию для поиска в закладки или отправить друзьям по URL-адресу.

Решение заключается в использовании перегрузки `BeginForm` , указывающей, что запрос POST должен добавить сведения для поиска в URL-адрес и направлять его в `HttpGet` версию `Index` метода. Замените существующий `BeginForm` метод без параметров на следующую разметку:

[!code-cshtml[Main](adding-search/samples/sample10.cshtml)]

![BeginFormPost_SM](adding-search/_static/image6.png)

Теперь при отправке поиска URL-адрес содержит строку запроса поиска. Поиск также переносится в метод `HttpGet Index`, даже если у вас определен метод `HttpPost Index`.

![индексвисжетурл](adding-search/_static/image7.png)

## <a name="adding-search-by-genre"></a>Добавление поиска по жанру

Если вы добавили `HttpPost` версию `Index` метода, удалите ее сейчас.

Далее предстоит добавить функцию, позволяющую пользователям искать фильмы по жанрам. Замените метод `Index` следующим кодом:

[!code-csharp[Main](adding-search/samples/sample11.cs)]

Эта версия `Index` метода принимает дополнительный параметр, а именно `movieGenre` . Первые несколько строк кода создают `List` объект для хранения жанров фильмов из базы данных.

Следующий код определяет запрос LINQ, который извлекает все жанры из базы данных.

[!code-csharp[Main](adding-search/samples/sample12.cs)]

Код использует `AddRange` метод универсальной `List` коллекции, чтобы добавить в список все отдельные жанры. (Без `Distinct` модификатора добавляются дубликаты жанров, например, в нашем примере комедия будет добавляться дважды). Затем в коде сохраняется список жанров в `ViewBag.MovieGenre` объекте. Хранение данных категорий (таких как жанры фильмов) в виде объекта [SelectList](https://msdn.microsoft.cus/library/system.web.mvc.selectlist(v=vs.108).aspx) в `ViewBag` , а доступ к данным категории в раскрывающемся списке является типичным подходом для приложений MVC.

В следующем коде показано, как проверить `movieGenre` параметр. Если он не пуст, код дополнительно ограничивает запрос фильмов, чтобы ограничить выбранные фильмы указанным жанром.

[!code-csharp[Main](adding-search/samples/sample13.cs)]

Как уже отмечалось ранее, запрос не выполняется в базе данных до тех пор, пока список фильмов не будет перебираться (что происходит в представлении после `Index` возврата метода действия).

## <a name="adding-markup-to-the-index-view-to-support-search-by-genre"></a>Добавление разметки в представление индекса для поддержки поиска по жанру

Добавьте `Html.DropDownList` вспомогательную функцию в файл *виевс\мовиес\индекс.кштмл* непосредственно перед `TextBox` вспомогательным модулем. Готовая разметка показана ниже:

[!code-cshtml[Main](adding-search/samples/sample14.cshtml?highlight=11)]

В приведенном ниже коде выполняется следующее:

[!code-cshtml[Main](adding-search/samples/sample15.cshtml)]

Параметр "Мовиеженре" предоставляет ключ для `DropDownList` вспомогательного метода для поиска `IEnumerable<SelectListItem>` в `ViewBag` . `ViewBag`Заполняется в методе действия:

[!code-csharp[Main](adding-search/samples/sample16.cs?highlight=10)]

Параметр «ALL» предоставляет метку параметра. Если вы проверите этот вариант в браузере, вы увидите, что его атрибут "value" пуст. Так как наш контроллер фильтрует только `if` строку или не является `null` пустой, при отправке пустого значения для `movieGenre` отображаются все жанры.

Можно также задать параметр, который будет выбран по умолчанию. Если вы хотите «комедия» в качестве параметра по умолчанию, измените код в контроллере следующим образом:

[!code-cshtml[Main](adding-search/samples/sample17.cshtml)]

Запустите приложение и перейдите по */мовиес/индекс*. Попробуйте поиск по жанру, по имени фильма и по обоим критериям.

![](adding-search/_static/image8.png)

В этом разделе вы создали метод действия поиска и представление, которые позволяют пользователям выполнять поиск по названию и жанру фильма. В следующем разделе вы узнаете, как добавить свойство в `Movie` модель и как добавить инициализатор, который будет автоматически создавать тестовую базу данных.

> [!div class="step-by-step"]
> [Назад](examining-the-edit-methods-and-edit-view.md)
> [Вперед](adding-a-new-field.md)
