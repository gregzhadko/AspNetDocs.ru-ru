---
uid: mvc/overview/getting-started/introduction/adding-a-new-field
title: Добавление нового поля | Документация Майкрософт
author: Rick-Anderson
description: ''
ms.author: riande
ms.date: 10/17/2013
ms.assetid: 4085de68-d243-4378-8a64-86236ea8d2da
msc.legacyurl: /mvc/overview/getting-started/introduction/adding-a-new-field
msc.type: authoredcontent
ms.openlocfilehash: 7018de3eab9d7cced72c76d0b74a79f7c8154f9d
ms.sourcegitcommit: 4e6d586faadbe4d9ef27122f86335ec9385134af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2020
ms.locfileid: "89045147"
---
# <a name="adding-a-new-field"></a>Добавление нового поля

по [Рик Андерсон (](https://twitter.com/RickAndMSFT)

[!INCLUDE [consider RP](~/includes/razor.md)]

В этом разделе вы будете использовать Entity Framework Code First Migrations для переноса некоторых изменений в классы модели, чтобы изменения применялись к базе данных.

По умолчанию при использовании Entity Framework Code First для автоматического создания базы данных, как это было сделано ранее в этом руководстве, Code First добавляет таблицу в базу данных, чтобы определить, синхронизирована ли схема базы данных с классами модели, из которых она была создана. Если они не синхронизированы, Entity Framework выдает ошибку. Это упрощает отслеживание проблем во время разработки, которые в противном случае могут быть найдены (путем маскировки ошибок) во время выполнения.

## <a name="setting-up-code-first-migrations-for-model-changes"></a>Настройка Code First Migrations для изменений модели

Перейдите к обозреватель решений. Щелкните правой кнопкой мыши файл *movies. mdf* и выберите **Удалить** , чтобы удалить базу данных фильмов. Если файл *movies. mdf* не отображается, щелкните значок **Показать все файлы** , показанный ниже в красном контуре.

![](adding-a-new-field/_static/image1.png)

Постройте приложение, чтобы убедиться в отсутствии ошибок.

В меню **Сервис** выберите **Диспетчер пакетов NuGet** , а затем **консоль диспетчера пакетов**.

![Добавить пакет man](adding-a-new-field/_static/image2.png)

В окне **консоли диспетчера пакетов** в `PM>` командной строке введите

Включение и миграция — ContextTypeName MvcMovie. Models. Мовиедбконтекст

![](adding-a-new-field/_static/image3.png)

Команда **включить-миграции** (показанная выше) создает файл *Configuration.CS* в новой папке *migrations* .

![](adding-a-new-field/_static/image4.png)

Visual Studio откроет файл *Configuration.CS* . Замените `Seed` метод в файле *Configuration.CS* следующим кодом:

[!code-csharp[Main](adding-a-new-field/samples/sample1.cs)]

Наведите указатель мыши на красную волнистую линию в разделе `Movie` и щелкните `Show Potential Fixes` , а затем выберите **Использование** **MvcMovie. Models;**

![](adding-a-new-field/_static/image5.png)

При этом добавляется следующая инструкция using:

[!code-csharp[Main](adding-a-new-field/samples/sample2.cs)]

> [!NOTE]
> 
> Code First Migrations вызывает `Seed` метод после каждой миграции (то есть вызывает **Обновление базы данных** в консоли диспетчера пакетов), и этот метод обновляет уже вставленные строки или вставляет их, если они еще не существуют.
> 
> Метод [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) в следующем коде выполняет операцию "Upsert":
> 
> [!code-csharp[Main](adding-a-new-field/samples/sample3.cs)]
> 
> Поскольку метод [SEED](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) выполняется при каждой миграции, вы не можете просто вставлять данные, так как добавляемые строки уже будут существовать после первой миграции, создающей базу данных. Операция "[Upsert](http://en.wikipedia.org/wiki/Upsert)" предотвращает ошибки, которые могут возникать при попытке вставить уже существующую строку, но переопределяет любые изменения данных, которые могли быть сделаны при тестировании приложения. При использовании тестовых данных в некоторых таблицах может быть нежелательно: в некоторых случаях при изменении данных во время тестирования необходимо сохранить изменения после обновления базы данных. В этом случае необходимо выполнить операцию условной вставки: вставить строку, если она еще не существует.   
> 
> Первый параметр, передаваемый методу [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) , указывает свойство, используемое для проверки, существует ли уже строка. Для этой цели можно использовать свойство тестовых данных видеофильмов, `Title` так как каждый заголовок в списке уникален:
> 
> [!code-csharp[Main](adding-a-new-field/samples/sample4.cs)]
> 
> В этом коде предполагается, что заголовки являются уникальными. Если вы вручную добавите повторяющееся название, вы получите следующее исключение при следующем выполнении миграции.   
> 
> *Последовательность содержит более одного элемента*  
> 
> Дополнительные сведения о методе [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) см. в разделе [использование метода AddOrUpdate EF 4,3](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/).

**Нажмите клавиши CTRL + SHIFT + B, чтобы выполнить сборку проекта.** (Если на этом этапе не выполняется сборка, следующие действия завершаются ошибкой.)

Следующим шагом является создание `DbMigration` класса для первоначальной миграции. При такой миграции создается новая база данных, поэтому файл *Movie. mdf* был удален на предыдущем шаге.

В окне **консоли диспетчера пакетов** введите команду, `add-migration Initial` чтобы создать первоначальную миграцию. Имя «Initial» является произвольным и используется для имени создаваемого файла миграции.

![](adding-a-new-field/_static/image6.png)

Code First Migrations создает другой файл класса в папке *migrations* (с именем *{датестамп} \_ Initial.CS* ), а этот класс содержит код, создающий схему базы данных. Имя файла миграции предварительно исправлено с меткой времени, помогающей в упорядочении. Изучите файл * \_ Initial.CS {датестамп}* , содержащий инструкции по созданию `Movies` таблицы для базы данных Movie. При обновлении базы данных в приведенных ниже инструкциях будет запущен файл * \_ Initial.CS {датестамп}* и создана схема базы данных. Затем будет выполнен метод **SEED** для заполнения базы данных тестовыми данными.

В **консоли диспетчера пакетов**введите команду, `update-database` чтобы создать базу данных, и запустите `Seed` метод.

![](adding-a-new-field/_static/image7.png)

Если появляется сообщение об ошибке, показывающее, что таблица уже существует и не может быть создана, возможно, приложение было запущено после удаления базы данных и перед выполнением `update-database` . В этом случае удалите файл *movies. mdf* еще раз и повторите `update-database` команду. Если вы по-прежнему получаете сообщение об ошибке, удалите папку и содержимое миграции, а затем начните с указания в верхней части этой страницы (которая удаляет файл *movies. mdf* , а затем переходит к включению-миграции). Если вы по-прежнему получаете ошибку, откройте обозреватель объектов SQL Server и удалите базу данных из списка.

Запустите приложение и перейдите по URL-адресу */Movies* . Отобразятся начальные данные.

![](adding-a-new-field/_static/image8.png)

## <a name="adding-a-rating-property-to-the-movie-model"></a>Добавление свойства Rating в модель Movie

Начните с добавления нового `Rating` свойства в существующий `Movie` класс. Откройте файл *моделс\мовие.КС* и добавьте `Rating` свойство следующим образом:

[!code-csharp[Main](adding-a-new-field/samples/sample5.cs)]

Теперь полный `Movie` класс выглядит следующим образом:

[!code-csharp[Main](adding-a-new-field/samples/sample6.cs?highlight=12)]

Постройте приложение (Ctrl + Shift + B).

Так как вы добавили в класс новое поле `Movie` , вам также нужно обновить *белый список* привязки, чтобы включить это новое свойство. Обновите `bind` атрибут для `Create` `Edit` методов действия и, чтобы включить `Rating` свойство:

[!code-csharp[Main](adding-a-new-field/samples/sample7.cs?highlight=1)]

Также необходимо обновить шаблоны представлений, чтобы реализовать отображение, создание и редактирование нового свойства `Rating` в представлении браузера.

Откройте файл *\виевс\мовиес\индекс.кштмл* и добавьте `<th>Rating</th>` заголовок столбца сразу после столбца **Price** . Затем добавьте `<td>` столбец рядом с концом шаблона, чтобы отобразить `@item.Rating` значение. Ниже показано, как выглядит обновленный шаблон представления *index. cshtml* :

[!code-cshtml[Main](adding-a-new-field/samples/sample8.cshtml?highlight=31-33,52-54)]

Затем откройте файл *\виевс\мовиес\креате.кштмл* и добавьте `Rating` поле со следующей выделенной разметкой. При этом текстовое поле подготавливается к просмотру, что позволяет указать рейтинг при создании нового фильма.

[!code-cshtml[Main](adding-a-new-field/samples/sample9.cshtml?highlight=9-15)]

Теперь вы обновили код приложения для поддержки нового `Rating` Свойства.

Запустите приложение и перейдите по URL-адресу */Movies* . Однако при этом вы увидите одну из следующих ошибок:

![](adding-a-new-field/_static/image9.png)  
  
Модель, которая является резервной моделью контекста "Мовиедбконтекст", изменилась с момента создания базы данных. Рекомендуется использовать Code First Migrations для обновления базы данных ( https://go.microsoft.com/fwlink/?LinkId=238269) .

![](adding-a-new-field/_static/image10.png)

Вы видите эту ошибку, так как обновленный `Movie` класс модели в приложении отличается от схемы `Movie` таблицы существующей базы данных. (В таблице базы данных отсутствует столбец `Rating`.)

Устранить эту ошибку можно несколькими способами:

1. Можно с помощью Entity Framework автоматически удалить и повторно создать базу данных на основе новой схемы класса модели. Этот подход удобен на ранних стадиях цикла разработки, когда все действия осуществляются с тестовой базой данных. В этом случае развитие модели и схемы базы данных осуществляется одновременно. Недостаток этого подхода заключается в том, что в базе данных теряются существующие данные — поэтому вы *не* хотите использовать этот подход в рабочей базе данных! При разработке приложения часто используется инициализатор для автоматического заполнения базы тестовыми данными. Дополнительные сведения об Entity Framework инициализаторах баз данных см. в разделе [ASP.NET MVC/Entity Framework Tutorial](../getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).
2. Можно явно изменить схему существующей базы данных в соответствии с новыми классами модели. Преимущество такого подхода состоит в том, что сохраняются все данные. Это изменение можно выполнить как вручную, так и с помощью соответствующего скрипта базы данных.
3. Можно обновить схему базы данных с помощью Code First Migrations.

В этом руководстве используется Code First Migrations.

Обновите метод SEED, чтобы он выдает значение для нового столбца. Откройте файл Migrations\Configuration.cs и добавьте поле рейтинга в каждый объект Movie.

[!code-csharp[Main](adding-a-new-field/samples/sample10.cs?highlight=6)]

Выполните сборку решения, а затем откройте окно **консоли диспетчера пакетов** и введите следующую команду:

`add-migration Rating`

`add-migration`Команда сообщает платформе миграции, что необходимо проверить текущую модель фильма с текущей схемой базы данных фильмов, и создать необходимый код для переноса базы данных в новую модель. *Оценка* имени является произвольной и используется для имени файла миграции. Полезно использовать понятное имя для шага миграции.

По завершении этой команды Visual Studio открывает файл класса, который определяет новый `DbMigration` производный класс, и в `Up` методе можно увидеть код, создающий новый столбец.

[!code-csharp[Main](adding-a-new-field/samples/sample11.cs)]

Выполните сборку решения, а затем введите `update-database` команду в окне **консоли диспетчера пакетов** .

На следующем рисунке показаны выходные данные в окне **консоли диспетчера пакетов** (Дата предустановленной *оценки* метки даты будет отличаться).

![](adding-a-new-field/_static/image11.png)

Повторно запустите приложение и перейдите по URL-адресу/movies. Можно увидеть новое поле рейтинг.

![](adding-a-new-field/_static/image12.png)

Щелкните ссылку **создать** , чтобы добавить новый фильм. Обратите внимание, что можно добавить оценку.

![7_CreateRioII](adding-a-new-field/_static/image13.png)

Нажмите кнопку **Создать**. Теперь новый фильм, включая рейтинг, отображается в списке фильмов:

![7_ourNewMovie_SM](adding-a-new-field/_static/image14.png)

Теперь, когда проект использует миграции, не нужно удалять базу данных при добавлении нового поля или при других обновлениях схемы. В следующем разделе будут внесены изменения в схему и использованы миграции для обновления базы данных.

Также следует добавить `Rating` поле в шаблоны представлений Правка, сведения и удалить.

Вы можете снова ввести команду "обновить базу данных" в окне **консоли диспетчера пакетов** , и код миграции не будет выполняться, так как схема соответствует модели. Однако при выполнении команды "обновить базу данных" `Seed` метод снова будет запущен, и если вы изменили какие-либо начальные данные, эти изменения будут потеряны, так как `Seed` метод операции Upsert данные. Дополнительные сведения о `Seed` методе см. в Dykstra)ном руководстве по [ASP.NET MVC и Entity Framework](../getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).

В этом разделе вы узнали, как можно изменить объекты модели и синхронизировать базу данных с изменениями. Вы также узнали, как заполнить созданную базу данных образцами данных, чтобы вы могли испытать сценарии. Это было просто краткое введение в Code First. Дополнительные сведения о теме см. в разделе [Создание модели данных Entity Framework для приложения ASP.NET MVC](../getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md) . Теперь рассмотрим, как можно добавить расширенную логику проверки к классам модели и обеспечить применение некоторых бизнес-правил.

> [!div class="step-by-step"]
> [Назад](adding-search.md)
> [Вперед](adding-validation.md)
