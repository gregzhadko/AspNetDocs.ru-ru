---
uid: mvc/overview/getting-started/introduction/adding-a-new-field
title: Добавление нового поля | Документация Майкрософт
author: Rick-Anderson
description: ''
ms.author: riande
ms.date: 10/17/2013
ms.assetid: 4085de68-d243-4378-8a64-86236ea8d2da
msc.legacyurl: /mvc/overview/getting-started/introduction/adding-a-new-field
msc.type: authoredcontent
ms.openlocfilehash: a5de73d93d0af21a3b59d6c21014810184292adb
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59379356"
---
# <a name="adding-a-new-field"></a>Добавление нового поля

по [Рик Андерсон]((https://twitter.com/RickAndMSFT))

[!INCLUDE [Tutorial Note](sample/code-location.md)]

В этом разделе используется Entity Framework Code First Migrations перенести некоторые изменения в классы моделей для применения изменений к базе данных.

По умолчанию при использовании Entity Framework Code First для автоматического создания базы данных, как это делалось ранее в этом учебнике, Code First добавляет таблицу в базу данных, которая позволяет отслеживать синхронизацию с классами модели, в которой она была создана из схемы базы данных. Если синхронизация нарушена, Entity Framework завершается ошибкой. Это упрощает для выявления проблем во время разработки, в противном случае только выявленных (по непонятные ошибки) во время выполнения.

## <a name="setting-up-code-first-migrations-for-model-changes"></a>Настройка Code First Migrations для изменения модели

Перейдите в обозревателе решений. Щелкните правой кнопкой мыши *Movies.mdf* файл и выберите **удалить** удаление базы данных фильмов. Если вы не видите *Movies.mdf* файл, щелкните **Показать все файлы** значок, показано ниже в красный контур.

![](adding-a-new-field/_static/image1.png)

Постройте приложение, чтобы убедиться в отсутствии ошибок.

Из **средства** меню, щелкните **диспетчер пакетов NuGet** и затем **консоль диспетчера пакетов**.

![Добавьте пакет Man](adding-a-new-field/_static/image2.png)

В **консоль диспетчера пакетов** окно при `PM>` окно командной строки введите

Enable-Migrations -ContextTypeName MvcMovie.Models.MovieDBContext

![](adding-a-new-field/_static/image3.png)

**Enable-Migrations** (как показано выше) команда создает *Configuration.cs* файл в новом *миграций* папки.

![](adding-a-new-field/_static/image4.png)

Visual Studio открывает *Configuration.cs* файла. Замените `Seed` метод в *Configuration.cs* файла следующим кодом:

[!code-csharp[Main](adding-a-new-field/samples/sample1.cs)]

Наведите указатель мыши на волнистую красную линию под `Movie` и нажмите кнопку `Show Potential Fixes` и нажмите кнопку **с помощью** **MvcMovie.Models;**

![](adding-a-new-field/_static/image5.png)

Это добавляет следующий оператор using:

[!code-csharp[Main](adding-a-new-field/samples/sample2.cs)]

> [!NOTE]
> 
> Code First Migrations вызовы `Seed` метод после каждой миграции (то есть вызов **обновления базы данных** в консоли диспетчера пакетов), и этот метод обновляет строки, которые уже были вставлены или вставляет их, если они еще не существует.
> 
> [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) операцией «вставки-обновления» выполняет метод в следующем коде:
> 
> [!code-csharp[Main](adding-a-new-field/samples/sample3.cs)]
> 
> Так как [начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод работает с каждой миграции, нельзя просто вставить данные, так как строки, вы пытаетесь добавить уже будут существует после первой миграции, который создает базу данных. "[Upsert](http://en.wikipedia.org/wiki/Upsert)" операция позволяет избежать ошибок, произойдет при попытке вставить строку, которая уже существует, но этот параметр переопределяет любые изменения данных, внесенные во время тестирования приложения. Тестовыми данными в некоторых таблицах вы не хотите, чтобы происходить: в некоторых случаях при изменении данных во время тестирования необходимым вам изменениям после обновления базы данных. В этом случае необходимо выполнить операцию вставки условного: вставить строку, только в том случае, если он еще не существует.   
> 
> Первый параметр, передаваемый [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) метод задает свойство, используемое для проверки, если строка уже существует. Для тестовых данных фильмов, вы предоставляете `Title` свойство может использоваться для этой цели, так как каждая книга из списка является уникальным:
> 
> [!code-csharp[Main](adding-a-new-field/samples/sample4.cs)]
> 
> Предполагается, что заголовки являются уникальными. Если вручную добавить дублирующийся заголовок, вы получите следующее исключение при очередном выполнении миграции.   
> 
> *Последовательность содержит более одного элемента*  
> 
> Дополнительные сведения о [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) метод, см. в разделе [Будьте внимательны с помощью метода AddOrUpdate 4.3 EF](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/)...


**Нажмите клавиши CTRL + SHIFT + B для сборки проекта.** (Ниже завершится ошибкой, если сборка не на этом этапе.)

Следующим шагом является создание `DbMigration` класс для первоначальной миграции. Этот вид миграции создает новую базу данных, поэтому вы удалили *movie.mdf* файл на предыдущем шаге.

В **консоль диспетчера пакетов** окно, введите команду `add-migration Initial` для создания первоначальной миграции. Имя «Начальный» является произвольным и используется для именования создан файл для миграции.

![](adding-a-new-field/_static/image6.png)

Code First Migrations создает еще один файл класса в *миграций* папку (с именем *{метки даты}\_Initial.cs* ), и этот класс содержит код, создающий схему базы данных. Имя файла миграции предварительно исправлена с меткой времени для облегчения упорядочения. Изучите *{метки даты}\_Initial.cs* файл, он содержит инструкции по созданию `Movies` таблицы для базы данных фильмов. При обновлении базы данных в инструкциях ниже, это *{метки даты}\_Initial.cs* файл будет выполняться и создать схему базы данных. Затем **начальное значение** метод выполняется для заполнения БАЗЫ данных тестовыми данными.

В **консоль диспетчера пакетов**, введите команду `update-database` для создания базы данных и запуска `Seed` метод.

![](adding-a-new-field/_static/image7.png)

Если отобразится сообщение об ошибке, указывающее таблицу, уже существует и не может быть создан, то, скорее всего вы запустили приложения после удаления базы данных и до выполнения `update-database`. В этом случае удалите *Movies.mdf* файл еще раз и повторите попытку `update-database` команды. Если вы по-прежнему возникает ошибка, удалите папку migrations и содержимое, а затем запустите с инструкциями в верхней части этой страницы (это delete *Movies.mdf* файл, а затем перейти к Enable-Migrations). Если вы по-прежнему возникает ошибка, откройте обозреватель объектов SQL Server и удалите базу данных из списка.

Запустите приложение и перейдите к */Movies* URL-адрес. Отображается начальные данные.

![](adding-a-new-field/_static/image8.png)

## <a name="adding-a-rating-property-to-the-movie-model"></a>Добавление свойства Rating в модель Movie

Начните с добавления нового `Rating` к существующему полю `Movie` класса. Откройте *Models\Movie.cs* файл и добавьте `Rating` свойство следующего вида:

[!code-csharp[Main](adding-a-new-field/samples/sample5.cs)]

Полный `Movie` класса сейчас выглядит аналогично следующему коду:

[!code-csharp[Main](adding-a-new-field/samples/sample6.cs?highlight=12)]

Постройте приложение (Ctrl + Shift + B).

Так как вы добавили новое поле `Movie` класса, также необходимо обновить привязки *в список разрешенных* , это новое свойство будут включены. Обновление `bind` для атрибута `Create` и `Edit` методы действий для включения `Rating` свойство:

[!code-csharp[Main](adding-a-new-field/samples/sample7.cs?highlight=1)]

Также необходимо обновить шаблоны представлений, чтобы реализовать отображение, создание и редактирование нового свойства `Rating` в представлении браузера.

Откройте *\Views\Movies\Index.cshtml* файл и добавьте `<th>Rating</th>` сразу после заголовка столбца **цена** столбца. Затем добавьте `<td>` столбца в конце шаблона для отображения `@item.Rating` значение. Ниже приведен какие обновленный *Index.cshtml* Просмотр шаблона выглядит как:

[!code-cshtml[Main](adding-a-new-field/samples/sample8.cshtml?highlight=31-33,52-54)]

Затем откройте *\Views\Movies\Create.cshtml* файл и добавьте `Rating` с выделенную ниже разметку. Это отрисовывает текстовое поле, можно указать оценку, если создается новый фильм.

[!code-cshtml[Main](adding-a-new-field/samples/sample9.cshtml?highlight=9-15)]

Теперь вы обновили код приложения, поддерживающие новое `Rating` свойство.

Запустите приложение и перейдите к */Movies* URL-адрес. При этом, однако вы увидите одно из следующих ошибок:

![](adding-a-new-field/_static/image9.png)  
  
Модель, поддерживающая контекст «MovieDBContext» изменилось с момента создания базы данных. Рассмотрите возможность использования Code First Migrations для обновления базы данных (https://go.microsoft.com/fwlink/?LinkId=238269).

![](adding-a-new-field/_static/image10.png)

Вы видите эту ошибку, так как обновленный `Movie` класс модели в приложение теперь отличается от схемы `Movie` таблицы в существующей базе данных. (В таблице базы данных отсутствует столбец `Rating`.)


Устранить эту ошибку можно несколькими способами:

1. Можно с помощью Entity Framework автоматически удалить и повторно создать базу данных на основе новой схемы класса модели. Этот подход удобен на ранних стадиях цикла разработки, когда все действия осуществляются с тестовой базой данных. В этом случае развитие модели и схемы базы данных осуществляется одновременно. Недостатком, однако является потеря существующих данных в базе данных, поэтому вы *не* хотите использовать этот подход на производственной базы данных! При разработке приложения часто используется инициализатор для автоматического заполнения базы тестовыми данными. Дополнительные сведения об инициализаторах базы данных Entity Framework, см. в разделе [учебник по ASP.NET MVC и Entity Framework](../getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).
2. Можно явно изменить схему существующей базы данных в соответствии с новыми классами модели. Преимущество такого подхода состоит в том, что сохраняются все данные. Это изменение можно выполнить как вручную, так и с помощью соответствующего скрипта базы данных.
3. Можно обновить схему базы данных с помощью Code First Migrations.


В этом руководстве используется Code First Migrations.

Обновите метод заполнения, таким образом, чтобы он предоставлял значение нового столбца. Откройте файл Migrations\Configuration.cs и добавьте поле оценки для каждого объекта фильма.

[!code-csharp[Main](adding-a-new-field/samples/sample10.cs?highlight=6)]

Выполните сборку решения, а затем откройте **консоль диспетчера пакетов** окна и введите следующую команду:

`add-migration Rating`

`add-migration` Команда указывает платформе миграции для проверки текущей модели фильма с текущей схемой базы данных фильмов и создать необходимый код для переноса базы данных в новую модель. Имя *Оценка* является произвольным и используется для имени файла переноса. Рекомендуется использовать понятное имя для этапов миграции.

По завершении этой команды Visual Studio открывает файл класса, который определяет новый `DbMigration` производного класса и в `Up` метода вы увидите код, создающий новый столбец.

[!code-csharp[Main](adding-a-new-field/samples/sample11.cs)]

Выполните сборку решения, а затем введите `update-database` в команду **консоль диспетчера пакетов** окна.

На следующем рисунке показаны выходные данные в **консоль диспетчера пакетов** окна (Метка даты атрибут As *Оценка* будет отличаться.)

![](adding-a-new-field/_static/image11.png)

Повторно запустите приложение и перейдите к /Movies URL-адрес. Вы увидите новое поле оценки.

![](adding-a-new-field/_static/image12.png)

Нажмите кнопку **Create New** ссылку, чтобы добавить новый фильм. Обратите внимание на то, что вы можете добавить оценку.

![7_CreateRioII](adding-a-new-field/_static/image13.png)

Нажмите кнопку **Создать**. Этот новый фильм, включая оценку, отображается в окне списка фильмов:

![7_ourNewMovie_SM](adding-a-new-field/_static/image14.png)

Теперь, когда проект использует миграций, не нужно будет удалить базу данных, при добавлении нового поля или в противном случае обновления схемы. В следующем разделе мы внести дополнительные изменения схемы и использовать миграции для обновления базы данных.

Также следует добавить `Rating` поле редактирования, подробности и удалить шаблоны представлений.

Можно ввести команду «update-database» в **консоль диспетчера пакетов** окно еще раз и без миграции кода будет выполнен, поскольку схема соответствует модели. Тем не менее, будет выполняться под управлением «update-database» `Seed` метод, и при изменении любого начального значения данных, изменения будут потеряны, поскольку `Seed` метод вставляет данные. Дополнительные сведения о `Seed` метод в том Дайкстра популярных [учебник по ASP.NET MVC и Entity Framework](../getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).

В этом разделе вы узнали, как можно изменять объекты модели и синхронизации базы данных с изменениями. Вы также узнали способ заполнения вновь созданную базу данных с демонстрационными данными, можно опробовать сценарии. Это было просто краткие сведения о Code First, см. в разделе [Создание модели данных Entity Framework для приложения ASP.NET MVC](../getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md) более полное руководство по этой теме. Теперь давайте взглянем на как можно добавить более широкие логику проверки в классы модели и включить некоторые бизнес-правила, которые будут применяться.

> [!div class="step-by-step"]
> [Назад](adding-search.md)
> [Вперед](adding-validation.md)
