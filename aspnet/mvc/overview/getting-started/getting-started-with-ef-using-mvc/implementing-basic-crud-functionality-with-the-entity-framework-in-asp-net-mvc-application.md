---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
title: Учебник. Реализация функции CRUD с помощью Entity Framework в ASP.NET MVC | Документация Майкрософт
description: Проверьте и настройте код создания, чтения, обновления и удаления (CRUD), который автоматически создает формирование шаблонов MVC в контроллерах и представлениях.
author: tdykstra
ms.author: riande
ms.date: 01/22/2019
ms.topic: tutorial
ms.assetid: a2f70ba4-83d1-4002-9255-24732726c4f2
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 9ed388543dd54d209ff2a0b92df4f7659962582c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471150"
---
# <a name="tutorial-implement-crud-functionality-with-the-entity-framework-in-aspnet-mvc"></a>Учебник. Реализация функции CRUD с помощью Entity Framework в ASP.NET MVC

В [предыдущем учебном курсе](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)было создано приложение MVC, которое хранит и отображает данные с помощью Entity Framework (EF) 6 и SQL Server LocalDB. В этом руководстве вы просматриваете и настраиваете код создания, чтения, обновления и удаления (CRUD), который автоматически создает формирование шаблонов MVC в контроллерах и представлениях.

> [!NOTE]
> Широко распространена практика реализации шаблона репозитория, позволяющего создать уровень абстракции между контроллером и уровнем доступа к данным. Чтобы упростить эти учебники и поучиться использовать EF 6, они не используют репозитории. Сведения о том, как реализовать репозитории, см. в статье [Схема содержимого для доступа к данным ASP.NET](../../../../whitepapers/aspnet-data-access-content-map.md).

Ниже приведены примеры создаваемых веб-страниц.

![Снимок экрана со страницей сведений об учащихся.](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image1.png)

![Снимок экрана со страницей создания учащихся.](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image2.png)

![Снимок экрана — страница удаления учащегося.](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image3.png)

Изучив это руководство, вы:

> [!div class="checklist"]
> * Создание страницы сведений
> * Обновление страницы Create
> * Обновление метода HttpPost Edit
> * Обновление страницы удаления
> * Закрытие подключений к базам данных
> * Обработка транзакций

## <a name="prerequisites"></a>предварительные требования

* [Создание Entity Framework модели данных](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)

## <a name="create-a-details-page"></a>Создание страницы сведений

Шаблонный код для `Index`ной страницы учащихся оставил свойство `Enrollments`, так как это свойство содержит коллекцию. На странице `Details` отобразится содержимое коллекции в таблице HTML.

В *контроллерс\студентконтроллер.КС*метод действия для представления `Details` использует метод [Find](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx) для получения одной `Student` сущности.

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample1.cs)]

Значение ключа передается в метод в качестве параметра `id` и берется из *данных маршрута* в гиперссылке **Details** на странице индекса.

### <a name="tip-route-data"></a>Совет. **Маршрутизация данных**

Данные маршрута — это данные, которые связыватель модели обнаружил в сегменте URL-адреса, указанном в таблице маршрутизации. Например, маршрут по умолчанию определяет сегменты `controller`, `action`и `id`:

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample2.cs?highlight=3)]

В следующем URL-адресе карта маршрута по умолчанию `Instructor` как `controller`, `Index` как `action` и 1 в качестве `id`. Это значения данных маршрута.

`http://localhost:1230/Instructor/Index/1?courseID=2021`

`?courseID=2021` — это значение строки запроса. Связыватель модели также будет работать при передаче `id` как значения строки запроса:

`http://localhost:1230/Instructor/Index?id=1&CourseID=2021`

URL-адреса создаются `ActionLink` инструкциями в представлении Razor. В следующем коде параметр `id` соответствует маршруту по умолчанию, поэтому `id` добавляется в данные маршрута.

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample3.cshtml)]

В следующем коде `courseID` не соответствует параметру в маршруте по умолчанию, поэтому он добавляется как строка запроса.

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample4.cshtml)]

### <a name="to-create-the-details-page"></a>Создание страницы сведений

1. Откройте *виевс\студент\детаилс.кштмл*.

   Каждое поле отображается с помощью вспомогательного метода `DisplayFor`, как показано в следующем примере:

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample5.cshtml)]

2. После поля `EnrollmentDate` и непосредственно перед закрывающим тегом `</dl>` Добавьте выделенный код для отображения списка регистраций, как показано в следующем примере:

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample6.cshtml?highlight=8-29)]

    Если после вставки кода появляется сообщение о неправильном отступе кода, нажмите клавиши **ctrl**+**K**, **CTRL**+**D** , чтобы его отформатировать.

    Этот код циклически обрабатывает сущности в свойстве навигации `Enrollments`. Для каждой сущности `Enrollment` в свойстве отображается название и оценка курса. Заголовок курса извлекается из `Course` сущности, которая хранится в свойстве навигации `Course` сущности `Enrollments`. Все эти данные извлекаются из базы данных автоматически, когда это необходимо. Иными словами, здесь используется отложенная загрузка. Вы не указали *безотлагательную загрузку* для свойства навигации `Courses`, поэтому регистрация не была получена в том же запросе, который получил учащихся. Вместо этого при первом обращении к свойству навигации `Enrollments` в базу данных отправляется новый запрос для получения данных. Дополнительные сведения о отложенной загрузке и безотлагательной загрузке см. в руководстве по [чтению связанных данных](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md) далее в этой серии.

3. Откройте страницу сведений, запустив программу (**Ctrl**+**F5**), выберите вкладку **students (учащиеся** ) и щелкните ссылку **Details (сведения** ) для Александр Carson. (Если нажать клавиши **Ctrl**+**F5** , когда открыт файл *Details. cshtml* , возникнет ошибка HTTP 400. Это связано с тем, что Visual Studio пытается запустить страницу сведений, но она не была достигнута по ссылке, указывающей учащегося для отображения. В этом случае удалите "учащийся/Details" из URL-адреса и повторите попытку или закройте браузер, щелкните проект правой кнопкой мыши и выберите " **просмотреть** > **представление в браузере**".)

    Вы увидите список курсов и оценок для выбранного учащегося.

4. Закройте браузер.

## <a name="update-the-create-page"></a>Обновление страницы Create

1. В *контроллерс\студентконтроллер.КС*замените метод действия <xref:System.Web.Mvc.HttpPostAttribute> `Create` следующим кодом. Этот код добавляет блок `try-catch` и удаляет `ID` из атрибута <xref:System.Web.Mvc.BindAttribute> для шаблона метода:

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample7.cs?highlight=3,5-6,13-18)]

    Этот код добавляет сущность `Student`, созданную связывателем модели MVC ASP.NET, в `Students` набор сущностей, а затем сохраняет изменения в базе данных. *Связыватель модели* относится к функции ASP.NET MVC, которая упрощает работу с данными, переданными в форме. Связыватель модели преобразует отправленные значения формы в типы CLR и передает их в метод действия в параметрах. В этом случае связыватель модели создает экземпляр `Student` сущности, используя значения свойств из коллекции `Form`.

    Вы удалили `ID` из атрибута BIND, так как `ID` является значением первичного ключа, которое SQL Server будет автоматически устанавливаться при вставке строки. Входные данные пользователя не задают значение `ID`.

    <a id="overpost"></a>

    ### <a name="security-warning---the-validateantiforgerytoken-attribute-helps-prevent-cross-site-request-forgery-attacks-it-requires-a-corresponding-htmlantiforgerytoken-statement-in-the-view-which-youll-see-later"></a>Предупреждение системы безопасности. атрибут `ValidateAntiForgeryToken` помогает предотвратить атаки [подделки межсайтовых запросов](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) . Для этого требуется соответствующая инструкция `Html.AntiForgeryToken()` в представлении, которая будет отображаться позже.

    Атрибут `Bind` является одним из способов защиты от *чрезмерного размещения* в сценариях создания. Например, предположим, что `Student` сущность содержит свойство `Secret`, которое не должно быть задано этой веб-страницей.

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample8.cs?highlight=7)]

    Даже если у вас нет поля `Secret` на веб-странице, злоумышленник может использовать такое средство, как [Fiddler](http://fiddler2.com/home), или написать некоторый код JavaScript для публикации значения `Secret`ной формы. Если атрибут <xref:System.Web.Mvc.BindAttribute> не ограничивает поля, используемые связывателем модели при создании экземпляра `Student`<em>,</em> связыватель модели выбирает это `Secret` значение формы и использует его для создания `Student` экземпляра сущности. Таким образом, какое бы значение ни задал злоумышленник для поля `Secret`, оно будет обновлено в базе данных. На следующем рисунке показано средство Fiddler, которое добавляет поле `Secret` (со значением "Перезапись") к отправленным значениям формы.

    ![](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image5.png)

    После этого значение "OverPost" будет успешно добавлено в свойство `Secret` вставленной строки, хотя вы не разрешали установку этого свойства на веб-странице.

    Лучше использовать параметр `Include` с атрибутом `Bind` для *список разрешений* полей. Можно также использовать параметр *`Exclude`, чтобы исключить поля из* списка запретов. Причина `Include` более безопасна в том, что при добавлении нового свойства в сущность новое поле не будет автоматически защищено списком `Exclude`.

    Чтобы предотвратить перенаправление в сценариях редактирования, сначала прочтите сущность из базы данных, а затем вызовите `TryUpdateModel`, передав в список явных разрешенных свойств. Это метод, используемый в этих учебниках.

    Альтернативный способ предотвратить перестановку, предпочитаемый многими разработчиками, — использовать модели представления вместо классов сущностей с привязкой модели. Включайте только те свойства, которые требуется обновлять в модели представления. После завершения связывателя модели MVC Скопируйте свойства модели представления в экземпляр сущности, при необходимости используя такие средства, как [автосопоставитель](http://automapper.org/). Использовать базу данных. Запись в экземпляре сущности, чтобы присвоить ее состояние без изменений, а затем задать свойство ("PropertyName"). Свойство изменено на true для каждого свойства сущности, включенного в модель представления. Этот метод подходит для сценариев редактирования и создания.

    В отличие от атрибута `Bind`, единственным изменением, внесенным в шаблонный код, является блок `try-catch`. Если во время сохранения изменений перехватывается исключение, производное от <xref:System.Data.DataException>, отображается сообщение об общей ошибке. Исключения <xref:System.Data.DataException> иногда связаны с внешними факторами, а не с ошибкой при программировании приложения, поэтому рекомендуется попробовать повторить выполненные действия снова. В этом примере такое поведение не реализовано, однако в рабочем приложении, как правило, исключения заносятся в журнал. Дополнительные сведения см. в разделе **Ведение журналов для анализа** статьи [Мониторинг и телеметрия (построение реальных облачных приложений для Azure)](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log).

    Код в *виевс\студент\креате.кштмл* похож на тот, который вы видели в *Details. cshtml*, за исключением того, что `EditorFor` и `ValidationMessageFor` вспомогательные методы используются для каждого поля, а не `DisplayFor`. Ниже приведен соответствующий код.

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample9.cshtml)]

    *Create. cshtml* также включает `@Html.AntiForgeryToken()`, который работает с атрибутом `ValidateAntiForgeryToken` в контроллере, чтобы помочь предотвратить атаки с [подделки межсайтовых запросов](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) .

    В *Create. cshtml*не требуется никаких изменений.

2. Запустите страницу, запустив программу, выбрав вкладку **учащиеся** , а затем щелкните **создать**.

3. Введите имена и недопустимую дату и нажмите кнопку **создать** , чтобы просмотреть сообщение об ошибке.

    Это проверка на стороне сервера, которую можно получить по умолчанию. В следующем учебнике вы узнаете, как добавлять атрибуты, создающие код для проверки на стороне клиента. В следующем выделенном коде показана проверка модели в методе **CREATE** .

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample10.cs?highlight=1)]

4. Измените дату на допустимую и щелкните **Create** (Создать), чтобы добавить нового учащегося на страницу **Index** (Указатель).

5. Закройте браузер.

## <a name="update-httppost-edit-method"></a>Обновление метода HttpPost Edit

1. Замените метод действия <xref:System.Web.Mvc.HttpPostAttribute> `Edit` следующим кодом:

   [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample11.cs)]

   > [!NOTE]
   > В *контроллерс\студентконтроллер.КС*метод `HttpGet Edit` (для которого без атрибута `HttpPost`) использует метод `Find` для получения выбранной `Student` сущности, как показано в методе `Details`. Изменять этот метод не нужно.

   Эти изменения реализуют рекомендации по обеспечению безопасности для предотвращения [перезаписи](#overpost), формирование шаблонов `Bind` и Добавление сущности, созданной связывателем модели, в набор сущностей с измененным флагом. Этот код больше не рекомендуется, так как атрибут `Bind` удаляет существующие данные в полях, не перечисленных в параметре `Include`. В будущем механизм формирования шаблонов контроллера MVC будет обновлен таким образом, чтобы он не создавал `Bind` атрибуты для методов редактирования.

   Новый код считывает существующую сущность и вызывает <xref:System.Web.Mvc.Controller.TryUpdateModel%2A>, чтобы обновить поля из данных, введенных пользователем, в отправленные данные формы. Автоматическое отслеживание изменений Entity Framework устанавливает флаг [EntityState. Modified](<xref:System.Data.EntityState.Modified>) для сущности. При вызове метода [savechanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) <xref:System.Data.EntityState.Modified> флаг приводит к тому, что Entity Framework создает инструкции SQL для обновления строки базы данных. [Конфликты параллелизма](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) пропускаются, и обновляются все столбцы строки базы данных, включая те, которые пользователь не изменил. (В более позднем учебнике показано, как обрабатывать конфликты параллелизма, и если требуется обновить отдельные поля в базе данных, можно задать для сущности значение [EntityState. без изменений](<xref:System.Data.EntityState.Unchanged>) и задать для отдельных полей значение [EntityState. Modified](<xref:System.Data.EntityState.Modified>).)

   Чтобы предотвратить перезапись, поля, которые должны быть обновлены на странице редактирования, список разрешений в параметрах `TryUpdateModel`. На данный момент другие поля не защищаются. Если включить в список поля, которые должен привязывать связыватель модели, это позволяет гарантировать, что при добавлении полей в модель данных в будущем они будут автоматически защищаться до тех пор, пока вы явно не добавите их сюда.

   В результате этих изменений сигнатура метода HttpPost Edit будет такой же, как и метод Edit HttpGet. Поэтому мы переименовали метод Едитпост.

   > [!TIP]
   >
   > **Состояния сущностей и методы присоединения и SaveChanges**
   >
   > Контекст базы данных отслеживает состояние синхронизации сущностей в памяти с соответствующими им строками в базе данных. Данные отслеживания определяют, что происходит при вызове метода `SaveChanges`. Например, при передаче новой сущности в метод [Add](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx) состояние этой сущности задается равным `Added`. Затем при вызове метода [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) контекст базы данных выдает команду SQL `INSERT`.
   >
   > Сущность может находиться в одном из следующих [состояний](xref:System.Data.EntityState):
   >
   > - `Added`. Сущность еще не существует в базе данных. Метод `SaveChanges` должен выдать инструкцию `INSERT`.
   > - `Unchanged`. С этой сущностью не нужно выполнять никакие действия с помощью метода `SaveChanges`. Это начальный статус сущности, который она имеет при чтении из базы данных.
   > - `Modified`. Были изменены значения некоторых или всех свойств сущности. Метод `SaveChanges` должен выдать инструкцию `UPDATE`.
   > - `Deleted`. Сущность отмечена для удаления. Метод `SaveChanges` должен выдать инструкцию `DELETE`.
   > - `Detached`. Сущность не отслеживается контекстом базы данных.
   >
   > В классическом приложении изменения состояния обычно осуществляются автоматически. В приложении типа Desktop вы читаете сущность и вносите изменения в некоторые значения ее свойств. В этом случае состояние сущности автоматически изменится на `Modified`. Затем при вызове `SaveChanges`Entity Framework создает инструкцию SQL `UPDATE`, которая обновляет только те фактические свойства, которые были изменены.
   >
   > Отключенная природа веб-приложений не допускает такой непрерывной последовательности. [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx) , считывающий сущность, удаляется после отрисовки страницы. При вызове метода действия `HttpPost` `Edit` выполняется новый запрос и создается новый экземпляр [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx), поэтому необходимо вручную задать для состояния сущности значение `Modified.` затем при вызове `SaveChanges`Entity Framework обновляет все столбцы строки базы данных, поскольку контекст не может определить, какие свойства были изменены.
   >
   > Если необходимо, чтобы инструкция SQL `Update` выполняла обновление только тех полей, которые пользователь фактически изменил, можно сохранить исходные значения каким-либо образом (например, скрытые поля), чтобы они были доступны при вызове метода `HttpPost` `Edit`. Затем можно создать `Student` сущность, используя исходные значения, вызвать метод `Attach` с исходной версией сущности, обновить значения сущности до новых значений, а затем вызвать `SaveChanges.` дополнительные сведения см. в разделе [состояния сущностей и SaveChanges](/ef/ef6/saving/change-tracking/entity-state) и [локальные данные](/ef/ef6/querying/local-data).

   Код HTML и Razor в *виевс\студент\едит.кштмл* аналогичен тому, что вы видели в *Create. cshtml*, и никаких изменений не требуется.

2. Запустите страницу, запустив программу, выбрав вкладку **students (учащиеся** ), а затем щелкнув гиперссылку **Edit (изменить** ).

3. Измените определенные данные и нажмите кнопку **Save** (Сохранить). Измененные данные отображаются на странице индекс.

4. Закройте браузер.

## <a name="update-the-delete-page"></a>Обновление страницы удаления

В *контроллерс\студентконтроллер.КС*код шаблона для метода `Delete` <xref:System.Web.Mvc.HttpGetAttribute> использует метод `Find` для получения выбранной сущности `Student`, как было показано в методах `Details` и `Edit`. Тем не менее, чтобы реализовать настраиваемое сообщение об ошибке при сбое вызова метода `SaveChanges`, необходимо добавить некоторые функции в этот метод и соответствующее ему представление.

Как и в случае с операциями обновления и создания, операции удаления требуют двух методов действия. Метод, который вызывается в ответ на запрос GET, отображает представление, которое дает пользователю возможность утверждать или отменять операцию удаления. Если пользователь подтверждает ее, создается запрос POST. В этом случае вызывается метод `HttpPost` `Delete`, а затем этот метод фактически выполняет операцию удаления.

Вы добавите блок `try-catch` в метод <xref:System.Web.Mvc.HttpPostAttribute> `Delete`, чтобы обрабатывались ошибки, которые могут возникнуть при обновлении базы данных. При возникновении ошибки метод <xref:System.Web.Mvc.HttpPostAttribute> `Delete` вызывает метод <xref:System.Web.Mvc.HttpGetAttribute> `Delete`, передавая ему параметр, указывающий, что произошла ошибка. Затем метод <xref:System.Web.Mvc.HttpGetAttribute> `Delete` отображает страницу подтверждения вместе с сообщением об ошибке, предоставляя пользователю возможность отменить операцию или повторить попытку.

1. Замените метод действия <xref:System.Web.Mvc.HttpGetAttribute> `Delete` следующим кодом, который управляет отчетами об ошибках:

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample12.cs?highlight=1,7-10)]

    Этот код принимает [необязательный параметр](https://msdn.microsoft.com/library/dd264739.aspx) , который указывает, был ли вызван метод после сбоя сохранения изменений. Этот параметр `false`, если метод `HttpGet` `Delete` вызывается без предыдущего сбоя. Если метод вызывается методом `HttpPost` `Delete` в ответ на ошибку обновления базы данных, параметр имеет значение `true` и в представление передается сообщение об ошибке.

2. Замените метод действия <xref:System.Web.Mvc.HttpPostAttribute> `Delete` (с именем `DeleteConfirmed`) следующим кодом, который выполняет фактическую операцию удаления и перехватывает все ошибки обновления базы данных.

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample13.cs)]

    Этот код извлекает выбранную сущность, а затем вызывает метод [Remove](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx) , чтобы задать для сущности состояние `Deleted`. При вызове `SaveChanges` создается команда SQL `DELETE`. Вы также изменили имя метода действия с `DeleteConfirmed` на `Delete`. Шаблонный код с именем `HttpPost` метод `Delete` `DeleteConfirmed`, чтобы присвоить методу `HttpPost` уникальную сигнатуру. (Среда CLR требует, чтобы перегруженные методы имели различные параметры метода.) Теперь, когда сигнатуры уникальны, можно придерживаться соглашения MVC и использовать одно и то же имя для методов `HttpPost` и `HttpGet` DELETE.

    Если повышение производительности в большом объеме приложения является приоритетным, можно избежать ненужного SQL-запроса для получения строки, заменив строки кода, вызывающие методы `Find` и `Remove`, следующим кодом:

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample14.cs)]

    Этот код создает экземпляр `Student` сущности, используя только значение первичного ключа, а затем устанавливает состояние сущности `Deleted`. Это все, что платформе Entity Framework необходимо для удаления сущности.

    Как уже отмечалось, метод `HttpGet` `Delete` не удаляет данные. При выполнении операции удаления в ответ на запрос GET (или, при выполнении любой операции изменения, операции создания или любой другой операции, которая изменяет данные) создается угроза безопасности. Дополнительные сведения см. в разделе [ASP.NET MVC Tip #46 — не используйте ссылки DELETE, так как они создают бреши в системе безопасности](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx) в блоге Стивен Вальтер.

3. В *виевс\студент\делете.кштмл*добавьте сообщение об ошибке между заголовком `h2` и заголовком `h3`, как показано в следующем примере:

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample15.cshtml?highlight=2)]

4. Запустите страницу, запустив программу, выбрав вкладку **учащиеся** , а затем щелкнув гиперссылку **Удалить** .

5. Выберите **Удалить** на странице с сообщением о **том, что вы действительно хотите удалить это?** .

    Страница индекса отображается без удаленного учащегося. (Вы увидите пример кода обработки ошибок в действии в [учебнике параллелизма](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md).)

## <a name="close-database-connections"></a>Закрытие подключений к базам данных

Чтобы закрыть подключения к базе данных и освободить ресурсы, которые они содержат как можно скорее, удалите экземпляр контекста по завершении. Именно поэтому шаблонный код предоставляет метод [Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx) в конце класса `StudentController` в *StudentController.CS*, как показано в следующем примере:

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample16.cs)]

Базовый класс `Controller` уже реализует интерфейс `IDisposable`, поэтому этот код просто добавляет переопределение в метод `Dispose(bool)` для явного удаления экземпляра контекста.

## <a name="handle-transactions"></a>Обработка транзакций

По умолчанию платформа Entity Framework реализует транзакции неявно. В сценариях, где вы вносите изменения в несколько строк или таблиц, а затем вызываете `SaveChanges`, Entity Framework автоматически гарантирует, что все изменения будут выполнены успешно или все они завершатся неудачей. Если ошибка происходит после того, как были выполнены некоторые изменения, эти изменения автоматически откатываются. Для сценариев, в которых требуется больший контроль&mdash;например, если требуется включить операции, выполняемые вне Entity Framework в транзакции&mdash;см. в разделе [Работа с транзакциями](/ef/ef6/saving/transactions).

## <a name="get-the-code"></a>Получение кода

[Скачать завершенный проект](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a>Дополнительные ресурсы

Теперь у вас есть полный набор страниц, которые выполняют простые операции CRUD для сущностей `Student`. Вы использовали вспомогательные методы MVC для создания элементов пользовательского интерфейса для полей данных. Дополнительные сведения о вспомогательных средствах MVC см. в разделе [Подготовка формы с помощью вспомогательных функций HTML](/previous-versions/aspnet/dd410596(v=vs.98)) (статья предназначена для MVC 3, но по-прежнему ОТНОСИТСЯ к MVC 5).

Ссылки на другие ресурсы EF 6 можно найти в [ASP.NET Data Access-Рекомендуемые ресурсы](../../../../whitepapers/aspnet-data-access-content-map.md).

## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Создание страницы сведений
> * Обновление страницы создания
> * Обновлен метод HttpPost Edit.
> * Обновление страницы удаления
> * Закрытие подключений к базам данных
> * Обработанные транзакции

Перейдите к следующей статье, чтобы узнать, как добавить в проект сортировку, фильтрацию и разбиение по страницам.
> [!div class="nextstepaction"]
> [Сортировка, фильтрация и разбиение на страницы](sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md)
