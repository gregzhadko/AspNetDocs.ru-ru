---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application
title: Учебник. Использование асинхронных и хранимых процедур с EF в приложении ASP.NET MVC
description: В этом учебнике показано, как реализовать асинхронную модель программирования и узнать, как использовать хранимые процедуры.
author: tdykstra
ms.author: riande
ms.date: 01/18/2019
ms.topic: tutorial
ms.assetid: 27d110fc-d1b7-4628-a763-26f1e6087549
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 5612f2f25d06feb904a205505ed8f048d2263266
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471390"
---
# <a name="tutorial-use-async-and-stored-procedures-with-ef-in-an-aspnet-mvc-app"></a>Учебник. Использование асинхронных и хранимых процедур с EF в приложении ASP.NET MVC

В предыдущих руководствах вы узнали, как считывать и обновлять данные с помощью синхронной модели программирования. В этом учебнике показано, как реализовать асинхронную модель программирования. Асинхронный код может помочь приложению работать лучше, поскольку он обеспечивает более эффективное использование ресурсов сервера.

В этом учебнике вы также узнаете, как использовать хранимые процедуры для операций вставки, обновления и удаления сущности.

Наконец, вы повторно развертываете приложение в Azure, а также все изменения базы данных, реализованные с момента первого развертывания.

На следующих рисунках изображены некоторые из страниц, с которыми вы будете работать.

![Страница «отделы»](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image1.png)

![Создать отдел](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image2.png)

Изучив это руководство, вы:

> [!div class="checklist"]
> * Дополнительные сведения о асинхронном коде
> * Создание контроллера отдела
> * Использование хранимых процедур
> * Развертывание в Azure

## <a name="prerequisites"></a>предварительные требования

* [Обновление связанных данных](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="why-use-asynchronous-code"></a>Зачем использовать асинхронный код

Веб-сервер имеет ограниченное число потоков, поэтому при высокой загрузке могут использоваться все доступные потоки. В таких случаях сервер не может обрабатывать новые запросы до тех пор, пока не будут высвобождены потоки. В синхронном коде многие потоки могут быть заняты, не выполняя при этом какие-либо операции и ожидая завершения ввода-вывода. В асинхронном коде в то время, когда процесс ожидает завершения ввода-вывода, его поток высвобождается и может использоваться сервером для обработки других запросов. В результате асинхронный код позволяет более эффективно использовать ресурсы сервера, а сервер — обрабатывать больше трафика без задержек.

В более ранних версиях .NET написание и тестирование асинхронного кода было сложным, подвержено ошибкам и сложно отлаживать. В .NET 4,5 написание, тестирование и отладка асинхронного кода настолько проще, что обычно следует писать асинхронный код, если нет причины отсутствия. Асинхронный код приводит к небольшому излишнему объему издержек, но в случае с низким трафиком снижается производительность, а в случае с большим трафиком потенциальное улучшение производительности является значительным.

Дополнительные сведения об асинхронном программировании см. [в разделе Использование асинхронной поддержки .NET 4.5 во избежание блокирующих вызовов](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices.md#async).

## <a name="create-department-controller"></a>Создание контроллера отдела

Создайте контроллер отдела так же, как и для предыдущих контроллеров, за исключением этого времени, установите флажок **использовать асинхронные действия контроллера** .

Следующие элементы показывают, что было добавлено в синхронный код для метода `Index`, чтобы сделать его асинхронным:

[!code-csharp[Main](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.cs?highlight=1,4)]

Для выполнения запроса Entity Frameworkной базы данных в асинхронном режиме были применены четыре изменения:

- Метод помечается ключевым словом `async`, которое указывает компилятору создавать обратные вызовы для частей тела метода и автоматически создавать возвращаемый объект `Task<ActionResult>`.
- Тип возвращаемого значения изменен с `ActionResult` на `Task<ActionResult>`. Тип `Task<T>` представляет текущую работу с результатом типа `T`.
- Ключевое слово `await` было применено к вызову веб-службы. Когда компилятор видит это ключевое слово, в фоновом режиме он разделяет метод на две части. Первая часть завершается операцией, которая запускается асинхронно. Вторая часть помещается в метод обратного вызова, который вызывается по завершении операции.
- Вызвана асинхронная версия метода расширения `ToList`.

Почему `departments.ToList` оператор изменен, но не `departments = db.Departments`? Причина заключается в том, что только инструкции, вызывающие отправку запросов или команд в базу данных, выполняются асинхронно. Инструкция `departments = db.Departments` настраивает запрос, но запрос не выполняется, пока не будет вызван метод `ToList`. Поэтому асинхронно выполняется только метод `ToList`.

В методе `Details` и `HttpGet` `Edit` и `Delete` метод `Find` — это тот, который вызывает отправку запроса в базу данных, так что это метод, который выполняется асинхронно:

[!code-csharp[Main](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.cs?highlight=7)]

В методах `Create`, `HttpPost Edit`и `DeleteConfirmed` это вызов метода `SaveChanges`, который вызывает выполнение команды, а не инструкции, такие как `db.Departments.Add(department)`, которые вызывают изменение только сущностей в памяти.

[!code-csharp[Main](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs?highlight=6)]

Откройте *виевс\департмент\индекс.кштмл*и замените код шаблона следующим кодом:

[!code-cshtml[Main](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cshtml?highlight=3,5,20-22,36-38)]

Этот код изменяет заголовок с index на Departments, перемещает имя администратора вправо и предоставляет полное имя администратора.

В представлениях создание, удаление, сведения и изменение измените заголовок поля `InstructorID` на "Администратор" так же, как и в поле "название отдела" в представлениях курсов.

В представлениях создание и изменение используйте следующий код:

[!code-cshtml[Main](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cshtml)]

В представлениях удаление и сведения используйте следующий код:

[!code-cshtml[Main](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cshtml)]

Запустите приложение и перейдите на вкладку **Departments (подразделения** ).

Все работает так же, как и на других контроллерах, но в этом контроллере все запросы SQL выполняются асинхронно.

При использовании асинхронного программирования с Entity Framework необходимо учитывать некоторые моменты.

- Асинхронный код не является потокобезопасным. Иными словами, не пытайтесь выполнять несколько операций параллельно, используя один и тот же экземпляр контекста.
- Если вы хотите использовать преимущества в производительности, которые обеспечивает асинхронный код, убедитесь, что все используемые пакеты библиотек (например, для разбиения на страницы) также используют асинхронный код при вызове любых методов Entity Framework, выполняющих запросы к базе данных.

## <a name="use-stored-procedures"></a>Использование хранимых процедур

Некоторые разработчики и администраторы баз данных предпочитают использовать хранимые процедуры для доступа к базам данным. В более ранних версиях Entity Framework можно получить данные с помощью хранимой процедуры, [выполнив необработанный SQL-запрос](advanced-entity-framework-scenarios-for-an-mvc-web-application.md), но нельзя указать EF использовать хранимые процедуры для операций обновления. В EF 6 можно легко настроить Code First для использования хранимых процедур.

1. В *дал\счулконтекст.КС*Добавьте выделенный код в метод `OnModelCreating`.

    [!code-csharp[Main](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs?highlight=9)]

    Этот код указывает Entity Framework использовать хранимые процедуры для операций вставки, обновления и удаления в сущности `Department`.
2. В консоли Управление пакетами введите следующую команду:

    `add-migration DepartmentSP`

    Откройте *миграцию\\&lt;метку времени&gt;\_DepartmentSP.CS* , чтобы увидеть код в методе `Up`, который создает хранимые процедуры INSERT, Update и DELETE:

    [!code-csharp[Main](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs?highlight=3-4,26-27,42-43)]
3. В консоли Управление пакетами введите следующую команду:

     `update-database`
4. Запустите приложение в режиме отладки, перейдите на вкладку **подразделения** и нажмите кнопку **создать**.
5. Введите данные для нового отдела и нажмите кнопку **создать**.

6. В Visual Studio просмотрите журналы в окне **вывод** , чтобы увидеть, что для вставки новой строки отдела использовалась хранимая процедура.

     ![Пакет обновления для отдела вставки](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image6.png)

Code First создает имена хранимых процедур по умолчанию. При использовании существующей базы данных может потребоваться настроить имена хранимых процедур, чтобы использовать хранимые процедуры, уже определенные в базе данных. Сведения о том, как это сделать, см. в разделе [Entity Framework Code First вставки, обновления и удаления хранимых процедур](https://msdn.microsoft.com/data/dn468673).

Если необходимо настроить создаваемые хранимые процедуры, можно изменить сформированный код для метода миграции `Up` метод, который создает хранимую процедуру. Таким образом, изменения отражаются при выполнении миграции и будут применены к рабочей базе данных, когда миграция выполняется автоматически в рабочей среде после развертывания.

Если вы хотите изменить существующую хранимую процедуру, созданную при предыдущей миграции, можно использовать команду Add-Migration, чтобы создать пустую миграцию, а затем вручную написать код, который вызывает метод [алтерсторедпроцедуре](https://msdn.microsoft.com/library/system.data.entity.migrations.dbmigration.alterstoredprocedure.aspx) .

## <a name="deploy-to-azure"></a>Развертывание в Azure

Для работы с этим разделом необходимо завершить необязательное **развертывание приложения в Azure** в руководстве по [миграции и развертыванию](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application.md) этой серии. Если возникли ошибки миграции, которые вы разрешили, удалив базу данных в локальном проекте, пропустите этот раздел.

1. В Visual Studio щелкните правой кнопкой мыши проект в **обозревателе решений** и выберите **Опубликовать** в контекстном меню.
2. Щелкните **Опубликовать**.

    Visual Studio развертывает приложение в Azure, и приложение откроется в браузере по умолчанию, работающем в Azure.
3. Протестируйте приложение, чтобы проверить его работоспособность.

    При первом запуске страницы, обращающейся к базе данных, Entity Framework выполняет все миграции `Up` методы, необходимые для обновления базы данных до текущей модели данных. Теперь можно использовать все веб-страницы, добавленные со времени последнего развертывания, включая страницы Отдела, добавленные в этом руководстве.

## <a name="get-the-code"></a>Получение кода

[Скачать завершенный проект](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a>Дополнительные ресурсы

Ссылки на другие ресурсы Entity Framework можно найти в [ресурсах, рекомендуемых для доступа к данным ASP.NET](../../../../whitepapers/aspnet-data-access-content-map.md).

## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Общие сведения о асинхронном коде
> * Создан контроллер отдела
> * Используемые хранимые процедуры
> * Развернуто в Azure

Перейдите к следующей статье, чтобы узнать, как справляться с конфликтами, когда несколько пользователей одновременно обновляют одну и ту же сущность.
> [!div class="nextstepaction"]
> [Обработка параллелизма](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)
