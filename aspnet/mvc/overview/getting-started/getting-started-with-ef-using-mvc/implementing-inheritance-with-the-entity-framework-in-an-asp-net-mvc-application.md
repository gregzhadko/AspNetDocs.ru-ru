---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application
title: Учебник. Реализация наследования с помощью EF в приложениях ASP.NET MVC 5
description: В этом учебнике демонстрируется, как реализовать наследование в модели данных.
author: tdykstra
ms.author: riande
ms.date: 01/21/2019
ms.topic: tutorial
ms.assetid: 08834147-77ec-454a-bb7a-d931d2a40dab
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 73a01ed47b0935a1a9734c197377470defb1fe36
ms.sourcegitcommit: 88fc80e3f65aebdf61ec9414810ddbc31c543f04
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2020
ms.locfileid: "76519392"
---
# <a name="tutorial-implement-inheritance-with-ef-in-an-aspnet-mvc-5-app"></a>Учебник. Реализация наследования с помощью EF в приложении ASP.NET MVC 5

В предыдущем учебном курсе были обработаны исключения параллелизма. В этом учебнике демонстрируется, как реализовать наследование в модели данных.

В объектно-ориентированном программировании можно использовать [наследование](http://en.wikipedia.org/wiki/Inheritance_(object-oriented_programming)) для упрощения [повторного использования кода](http://en.wikipedia.org/wiki/Code_reuse). В рамках этого учебника вы измените классы `Instructor` и `Student` таким образом, чтобы они были производными от базового класса `Person`, который содержит общие свойства для преподавателей и учащихся, такие как `LastName`. Изменения вносятся в коде, а не на веб-страницах, и автоматически отражаются в базе данных.

В этом учебнике рассмотрены следующие задачи.

> [!div class="checklist"]
> * Сведения о сопоставлении наследования с базой данных
> * Создание класса Person
> * Обновление Instructor и Student
> * Добавление пользователя в модель
> * Создание и обновление миграций
> * Тестирование реализации
> * Развертывание в Azure

## <a name="prerequisites"></a>Prerequisites

* [Обработка параллелизма](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="map-inheritance-to-database"></a>Сопоставление наследования с базой данных

Классы `Instructor` и `Student` в модели `School` данных имеют несколько свойств, которые идентичны:

![Student_and_Instructor_classes](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image1.png)

Предположим, что вам требуется исключить повторяющийся код для свойств, которые являются общими для сущностей `Instructor` и `Student`. Кроме того, вам может потребоваться написать службу, которая может форматировать имена как преподавателей, так и учащихся. Можно создать `Person` базовый класс, который содержит только общие свойства, а затем сделать сущности `Instructor` и `Student` производными от этого базового класса, как показано на следующем рисунке:

![Student_and_Instructor_classes_deriving_from_Person_class](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image2.png)

Структура наследования может быть представлена в базе данных несколькими способами. У вас может быть `Person` таблица, содержащая сведения о студентах и преподавателях в одной таблице. Некоторые из столбцов могут применяться только к преподавателям (`HireDate`), а только к учащимся (`EnrollmentDate`), к обеим (`LastName`, `FirstName`). Как правило, у вас должен быть столбец *дискриминатора* , указывающий, какой тип представляет каждая строка. Например, в столбце дискриминатора может указываться значение "Instructor" для преподавателей и "Student" для учащихся.

![Таблица на hierarchy_example](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image3.png)

Этот шаблон создания структуры наследования сущностей из одной таблицы базы данных называется наследованием типа «одна *таблица на иерархию* ».

В качестве альтернативы можно создать базу данных, которая будет иметь приближенный к структуре наследования вид. Например, можно иметь только поля имен в таблице `Person` и иметь отдельные `Instructor` и `Student` таблицы с полями даты.

![Таблица на type_inheritance](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image4.png)

Такая схема создания таблицы базы данных для каждого класса сущностей называется наследованием *типа «таблица на тип* » (TPT).

Кроме того, можно сопоставить все не являющиеся абстрактными типы с отдельными таблицами. Все свойства класса, включая унаследованные, сопоставляются со столбцами в соответствующей таблице. Такая модель называется наследованием типа "одна таблица на конкретный класс". Если вы реализовали наследование TPC для классов `Person`, `Student`и `Instructor`, как показано выше, таблицы `Student` и `Instructor` будут выглядеть иначе после реализации наследования, чем раньше.

Шаблоны наследования TPC и «подиерархия» обычно обеспечивают лучшую производительность в Entity Framework, чем шаблоны наследования TPT, поскольку TPT шаблоны могут привести к созданию сложных запросов JOIN.

В этом учебнике демонстрируется реализация модели наследования "одна таблица на иерархию". «ИЕРАРХИя» — это шаблон наследования по умолчанию в Entity Framework, поэтому все, что нужно сделать, — это создать `Person` класс, изменить классы `Instructor` и `Student`, производные от `Person`, добавить новый класс в `DbContext`и создать миграцию. (Сведения о том, как реализовать другие шаблоны наследования, см. в разделе [сопоставление наследования типа "Таблица-Тип" (TPT)](https://msdn.microsoft.com/data/jj591617#2.5) и [сопоставление наследования "Таблица — конкретный класс" (TPC)](https://msdn.microsoft.com/data/jj591617#2.6) в документации MSDN Entity Framework.)

## <a name="create-the-person-class"></a>Создание класса Person

В папке *Models* создайте *Person.CS* и замените код шаблона следующим кодом:

[!code-csharp[Main](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.cs)]

## <a name="update-instructor-and-student"></a>Обновление Instructor и Student

Теперь обновите *Instructor.CS* и *Student.CS* , чтобы унаследовать значения из *Person.SC*.

В *Instructor.CS*класс `Instructor` является производным от класса `Person` и удаляет поля ключа и имени. Код будет выглядеть следующим образом:

[!code-csharp[Main](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.cs)]

Внесите аналогичные изменения в *Student.CS*. Класс `Student` будет выглядеть, как в следующем примере:

[!code-csharp[Main](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

## <a name="add-person-to-the-model"></a>Добавление пользователя в модель

В *SchoolContext.CS*добавьте свойство `DbSet` для `Person` типа сущности:

[!code-csharp[Main](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

Это все, что требуется платформе Entity Framework для настройки наследования типа "одна таблица на иерархию". Как вы увидите, при обновлении базы данных у нее будет `Person`ная таблица вместо таблиц `Student` и `Instructor`.

## <a name="create-and-update-migrations"></a>Создание и обновление миграций

В консоли диспетчера пакетов (PMC) введите следующую команду:

`Add-Migration Inheritance`

Выполните команду `Update-Database` в PMC. На этом этапе команда завершится ошибкой, так как у нас есть существующие данные, которые не могут быть обработаны миграцией. Появляется сообщение об ошибке следующего вида:

> *Не удалось удалить объект "dbo. Instructor, так как на него ссылается ограничение внешнего ключа.*

Откройте *миграцию\&lt; timestamp&gt;\_Inheritance.CS* и замените метод `Up` следующим кодом:

[!code-csharp[Main](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

Этот код выполняет следующие задачи по обновлению базы данных:

- Удаляет ограничения внешнего ключа и индексы, которые указывают на таблицу Student.
- Переименовывает таблицу Instructor в Person и вносит изменения, необходимые для сохранения в ней данных из таблицы Student:

    - Добавляет допускающий значения NULL тип EnrollmentDate для учащихся.
    - Добавляет столбец дискриминатора, который указывает, представляет ли строка учащегося или преподавателя.
    - Изменяет тип HireDate на допускающий значения NULL, поскольку в строках для учащихся не будет указываться дата приема на работу.
    - Добавляет временное поле, которое будет использоваться для обновления внешних ключей, указывающих на учащихся. При копировании учащихся в таблицу Person будут получены новые значения первичного ключа.
- Копирует данные из таблицы Student в таблицу Person. При этом записям учащихся назначаются новые значения первичного ключа.
- Исправляет значения внешнего ключа, которые указывают на учащихся.
- Повторно создает ограничения внешнего ключа и индексы, которые после этого указывают на таблицу Person.

(Если вместо целочисленного типа первичного ключа используется GUID, значения первичного ключа для записей учащихся изменять не потребуется и некоторые из этих действий можно пропустить.)

Выполните команду `update-database` еще раз.

(В рабочей системе можно внести соответствующие изменения в метод down, если бы когда-либо пришлось использовать его для возврата к предыдущей версии базы данных. В этом учебнике не используется метод down.)

> [!NOTE]
> При переносе данных и внесении изменений в схему можно получить другие ошибки. Если вы получаете ошибки миграции, которые невозможно устранить, можно продолжить работу с руководством, изменив строку подключения в файле *Web. config* или удалив базу данных. Самый простой подход заключается в том, чтобы переименовать базу данных в файле *Web. config* . Например, измените имя базы данных на ContosoUniversity2, как показано в следующем примере:
>
> [!code-xml[Main](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.xml?highlight=2)]
>
> В новой базе данных нет данных для переноса, и выполнение команды `update-database` с большей вероятностью завершится без ошибок. Инструкции по удалению базы данных см. в статье [как удалить базу данных из Visual Studio 2012](http://romiller.com/2013/05/17/how-to-drop-a-database-from-visual-studio-2012/). Если вы пройдете этот подход для продолжения работы с учебником, пропустите шаг развертывания в конце этого руководства или разверните его на новом сайте и базе данных. При развертывании обновления на том же сайте, на котором вы уже выполняли развертывание, EF получит такую же ошибку при автоматическом запуске миграции. Если вы хотите устранить ошибку миграции, лучшим ресурсом является одна из Entity Framework форумов или StackOverflow.com.

## <a name="test-the-implementation"></a>Тестирование реализации

Запустите сайт и попробуйте использовать различные страницы. Все работает так же, как и раньше.

В **Обозреватель сервера** разверните **коннектионс\счулконтекст данных** , а затем **таблицы**, и вы увидите, что **таблицы учащихся** и **преподавателей** были заменены таблицей **Person** . Раскройте таблицу **Person** , и вы увидите, что в ней есть все столбцы, используемые в таблицах **учащихся** и **инструкторов** .

Щелкните таблицу Person правой кнопкой мыши и выберите команду **Показать данные таблицы**, чтобы просмотреть столбец дискриминатора.

На следующей схеме показана структура новой базы данных School:

![School_database_diagram](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image7.png)

## <a name="deploy-to-azure"></a>Развертывание в Azure

Для работы с этим разделом необходимо завершить необязательное **развертывание приложения в Azure** в [части 3, сортировки, фильтрации и разбиения по страницам](sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md) этой серии руководств. Если возникли ошибки миграции, которые вы разрешили, удалив базу данных в локальном проекте, пропустите этот шаг. также можно создать новый сайт и базу данных и выполнить развертывание в новой среде.

1. В Visual Studio щелкните правой кнопкой мыши проект в **обозревателе решений** и выберите **Опубликовать** в контекстном меню.

2. Нажмите кнопку **Опубликовать**.

    Веб-приложение откроется в браузере по умолчанию.

3. Протестируйте приложение, чтобы проверить его работоспособность.

    При первом запуске страницы, обращающейся к базе данных, Entity Framework выполняет все миграции `Up` методы, необходимые для обновления базы данных до текущей модели данных.

## <a name="get-the-code"></a>Получите код

[Скачать завершенный проект](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a>Дополнительные ресурсы

Ссылки на другие ресурсы Entity Framework можно найти в [ресурсах, рекомендуемых для доступа к данным ASP.NET](../../../../whitepapers/aspnet-data-access-content-map.md).

Дополнительные сведения об этой и других структурах наследования см. в разделе Шаблон наследования [TPT](https://msdn.microsoft.com/data/jj618293) и [Шаблон наследования «подтаблица](https://msdn.microsoft.com/data/jj618292) » на сайте MSDN. В рамках следующего учебника вы узнаете, как работать в нескольких сценариях Entity Framework с расширенными возможностями.

## <a name="next-steps"></a>Следующие шаги

В этом учебнике рассмотрены следующие задачи.

> [!div class="checklist"]
> * Узнали о сопоставлении наследования с базой данных
> * Создание класса Person
> * Обновление Instructor и Student
> * Пользователь добавлен в модель
> * Создание и обновление миграций
> * Тестирование реализации
> * Развернуто в Azure

Перейдите к следующей статье, чтобы узнать о разделах, которые помогут вам понять, когда вы выходите из основ разработки веб-приложений ASP.NET, использующих Entity Framework Code First.
> [!div class="nextstepaction"]
> [Дополнительные сценарии платформы Entity Framework](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)
