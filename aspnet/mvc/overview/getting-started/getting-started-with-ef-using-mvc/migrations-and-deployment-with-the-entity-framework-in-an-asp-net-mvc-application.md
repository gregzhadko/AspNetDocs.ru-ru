---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: Учебник. Использование миграций EF в приложении ASP.NET MVC и развертывание в Azure
author: tdykstra
description: В этом руководстве описано, как включить миграцию Code First и развернуть приложение в облаке в Azure.
ms.author: riande
ms.date: 01/16/2019
ms.topic: tutorial
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 989dd0f0e18b338be057b9c5657586eff996d8ea
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78499368"
---
# <a name="tutorial-use-ef-migrations-in-an-aspnet-mvc-app-and-deploy-to-azure"></a><span data-ttu-id="fe2ed-103">Учебник. Использование миграций EF в приложении ASP.NET MVC и развертывание в Azure</span><span class="sxs-lookup"><span data-stu-id="fe2ed-103">Tutorial: Use EF Migrations in an ASP.NET MVC app and deploy to Azure</span></span>

<span data-ttu-id="fe2ed-104">До сих пор пример веб-приложения Contoso университета работает локально в IIS Express на компьютере разработчика.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-104">So far the Contoso University sample web application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="fe2ed-105">Чтобы обеспечить доступ к реальному приложению для других пользователей через Интернет, необходимо развернуть его для поставщика услуг размещения веб-сайтов.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-105">To make a real application available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="fe2ed-106">В этом руководстве описано, как включить миграцию Code First и развернуть приложение в облаке в Azure.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-106">In this tutorial, you enable Code First migrations and deploy the application to the cloud in Azure:</span></span>

- <span data-ttu-id="fe2ed-107">Включите Code First Migrations.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-107">Enable Code First Migrations.</span></span> <span data-ttu-id="fe2ed-108">Функция миграции позволяет изменять модель данных и развертывать изменения в рабочей среде путем обновления схемы базы данных без необходимости удаления и повторного создания базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-108">The Migrations feature enables you to change the data model and deploy your changes to production by updating the database schema without having to drop and re-create the database.</span></span>
- <span data-ttu-id="fe2ed-109">Выполните развертывание в Azure.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-109">Deploy to Azure.</span></span> <span data-ttu-id="fe2ed-110">Этот шаг является необязательным. Вы можете продолжить работу с остальными учебниками без развертывания проекта.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-110">This step is optional; you can continue with the remaining tutorials without having deployed the project.</span></span>

<span data-ttu-id="fe2ed-111">Рекомендуется использовать процесс непрерывной интеграции с системой управления версиями для развертывания, но в этом учебнике эти темы не рассматриваются.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-111">We recommend that you use a continuous integration process with source control for deployment, but this tutorial does not cover those topics.</span></span> <span data-ttu-id="fe2ed-112">Дополнительные сведения см. в разделах [Управление исходным кодом](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) и [Непрерывная интеграция](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) [Создание облачных приложений в реальном мире с помощью Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-112">For more information, see the [source control](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) and [continuous integration](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) chapters of [Building Real-World Cloud Apps with Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span></span>

<span data-ttu-id="fe2ed-113">Изучив это руководство, вы:</span><span class="sxs-lookup"><span data-stu-id="fe2ed-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="fe2ed-114">Включение миграции Code First</span><span class="sxs-lookup"><span data-stu-id="fe2ed-114">Enable Code First migrations</span></span>
> * <span data-ttu-id="fe2ed-115">Развертывание приложения в Azure (необязательно)</span><span class="sxs-lookup"><span data-stu-id="fe2ed-115">Deploy the app in Azure (optional)</span></span>

## <a name="prerequisites"></a><span data-ttu-id="fe2ed-116">предварительные требования</span><span class="sxs-lookup"><span data-stu-id="fe2ed-116">Prerequisites</span></span>

- [<span data-ttu-id="fe2ed-117">Устойчивость подключений и перехват команд</span><span class="sxs-lookup"><span data-stu-id="fe2ed-117">Connection Resiliency and Command Interception</span></span>](connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="enable-code-first-migrations"></a><span data-ttu-id="fe2ed-118">Включение миграции Code First</span><span class="sxs-lookup"><span data-stu-id="fe2ed-118">Enable Code First migrations</span></span>

<span data-ttu-id="fe2ed-119">При разработке нового приложения ваша модель данных часто меняется, и при каждом таком изменении она нарушает синхронизацию с базой данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-119">When you develop a new application, your data model changes frequently, and each time the model changes, it gets out of sync with the database.</span></span> <span data-ttu-id="fe2ed-120">Вы настроили Entity Framework для автоматического удаления и повторного создания базы данных каждый раз при изменении модели данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-120">You have configured the Entity Framework to automatically drop and re-create the database each time you change the data model.</span></span> <span data-ttu-id="fe2ed-121">При добавлении, удалении или изменении классов сущностей или изменении класса `DbContext` при следующем запуске приложения он автоматически удаляет существующую базу данных, создает новую, которая соответствует модели, и заполняет ее тестовыми данными.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-121">When you add, remove, or change entity classes or change your `DbContext` class, the next time you run the application it automatically deletes your existing database, creates a new one that matches the model, and seeds it with test data.</span></span>

<span data-ttu-id="fe2ed-122">Этот способ для обеспечения синхронизации базы данных с моделью данных хорошо работает до развертывания приложения в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-122">This method of keeping the database in sync with the data model works well until you deploy the application to production.</span></span> <span data-ttu-id="fe2ed-123">Когда приложение выполняется в рабочей среде, обычно сохраняются данные, которые необходимо сохранить, и вы не хотите потерять все при каждом внесении изменений, например при добавлении нового столбца.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-123">When the application is running in production, it is usually storing data that you want to keep, and you don't want to lose everything each time you make a change such as adding a new column.</span></span> <span data-ttu-id="fe2ed-124">Функция [Code First migrations](https://msdn.microsoft.com/data/jj591621) решает эту проблему, позволяя Code First обновлять схему базы данных вместо удаления и повторного создания базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-124">The [Code First Migrations](https://msdn.microsoft.com/data/jj591621) feature solves this problem by enabling Code First to update the database schema instead of dropping and re-creating the database.</span></span> <span data-ttu-id="fe2ed-125">В этом руководстве вы развернете приложение и подготовите его к работе, чтобы включить миграцию.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-125">In this tutorial, you'll deploy the application, and to prepare for that you'll enable Migrations.</span></span>

1. <span data-ttu-id="fe2ed-126">Отключите инициализатор, который вы настроили ранее, закомментируйте или удалив элемент `contexts`, добавленный в файл Web. config приложения.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-126">Disable the initializer that you set up earlier by commenting out or deleting the `contexts` element that you added to the application Web.config file.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. <span data-ttu-id="fe2ed-127">Кроме того, в файле *Web. config* приложения измените имя базы данных в строке подключения на ContosoUniversity2.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-127">Also in the application *Web.config* file, change the name of the database in the connection string to ContosoUniversity2.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    <span data-ttu-id="fe2ed-128">Это изменение настраивает проект таким образом, чтобы первая миграция создавала новую базу данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-128">This change sets up the project so that the first migration creates a new database.</span></span> <span data-ttu-id="fe2ed-129">Это не обязательно, но позже вы увидите, почему это хорошая идея.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-129">This isn't required but you'll see later why it's a good idea.</span></span>
3. <span data-ttu-id="fe2ed-130">В меню **Инструменты** выберите **Диспетчер пакетов NuGet** > **Консоль диспетчера пакетов**.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-130">From the **Tools** menu, select **NuGet Package Manager** > **Package Manager Console**.</span></span>

1. <span data-ttu-id="fe2ed-131">В командной строке `PM>` введите следующие команды:</span><span class="sxs-lookup"><span data-stu-id="fe2ed-131">At the `PM>` prompt enter the following commands:</span></span>

    ```text
    enable-migrations
    add-migration InitialCreate
    ```

    <span data-ttu-id="fe2ed-132">Команда `enable-migrations` создает папку *migrations* в проекте ContosoUniversity и помещает в эту папку файл *Configuration.CS* , который можно изменить для настройки миграции.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-132">The `enable-migrations` command creates a *Migrations* folder in the ContosoUniversity project, and it puts in that folder a *Configuration.cs* file that you can edit to configure Migrations.</span></span>

    <span data-ttu-id="fe2ed-133">(Если вы пропустили приведенный выше шаг, чтобы изменить имя базы данных, миграция найдет существующую базу данных и автоматически выполнит команду `add-migration`.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-133">(If you missed the step above that directs you to change the database name, Migrations will find the existing database and automatically do the `add-migration` command.</span></span> <span data-ttu-id="fe2ed-134">Это просто означает, что вы не будете выполнять тестирование кода миграции перед развертыванием базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-134">That's okay, it just means you won't run a test of the migrations code before you deploy the database.</span></span> <span data-ttu-id="fe2ed-135">Позже при выполнении команды `update-database` ничего не произойдет, так как база данных уже существует.)</span><span class="sxs-lookup"><span data-stu-id="fe2ed-135">Later when you run the `update-database` command nothing will happen because the database already exists.)</span></span>

    <span data-ttu-id="fe2ed-136">Откройте файл *контосауниверсити\мигратионс\конфигуратион.КС* .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-136">Open the *ContosoUniversity\Migrations\Configuration.cs* file.</span></span> <span data-ttu-id="fe2ed-137">Подобно классу инициализатора, который вы видели ранее, класс `Configuration` включает метод `Seed`.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-137">Like the initializer class that you saw earlier, the `Configuration` class includes a `Seed` method.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    <span data-ttu-id="fe2ed-138">Цель метода [начального значения](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) заключается в возможности вставки или обновления тестовых данных после Code First создания или обновления базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-138">The purpose of the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is to enable you to insert or update test data after Code First creates or updates the database.</span></span> <span data-ttu-id="fe2ed-139">Метод вызывается при создании базы данных и при каждом обновлении схемы базы данных после изменения модели данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-139">The method is called when the database is created and every time the database schema is updated after a data model change.</span></span>

### <a name="set-up-the-seed-method"></a><span data-ttu-id="fe2ed-140">Настройка метода начального значения</span><span class="sxs-lookup"><span data-stu-id="fe2ed-140">Set up the Seed method</span></span>

<span data-ttu-id="fe2ed-141">При удалении и повторном создании базы данных для каждого изменения модели данных используется метод `Seed` класса инициализатора для вставки тестовых данных, поскольку после изменения каждой модели база данных удаляется и все проверочные данные теряются.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-141">When you drop and re-create the database for every data model change, you use the initializer class's `Seed` method to insert test data, because after every model change the database is dropped and all the test data is lost.</span></span> <span data-ttu-id="fe2ed-142">При использовании Code First Migrations тестовые данные сохранены после изменения базы данных, поэтому, как правило, не требуется включать данные тестирования в метод [SEED](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-142">With Code First Migrations, test data is retained after database changes, so including test data in the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is typically not necessary.</span></span> <span data-ttu-id="fe2ed-143">На самом деле вы не хотите, чтобы метод `Seed` вставил тестовые данные, если вы будете использовать миграции для развертывания базы данных в рабочей среде, так как метод `Seed` будет выполняться в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-143">In fact, you don't want the `Seed` method to insert test data if you'll be using Migrations to deploy the database to production, because the `Seed` method will run in production.</span></span> <span data-ttu-id="fe2ed-144">В этом случае необходимо, чтобы метод `Seed` вставил в базу данных только те данные, которые необходимы в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-144">In that case, you want the `Seed` method to insert into the database only the data that you need in production.</span></span> <span data-ttu-id="fe2ed-145">Например, может потребоваться, чтобы база данных включала фактические имена отделов в таблицу `Department`, когда приложение станет доступным в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-145">For example, you might want the database to include actual department names in the `Department` table when the application becomes available in production.</span></span>

<span data-ttu-id="fe2ed-146">В рамках этого руководства вы будете использовать миграции для развертывания, но метод `Seed` будет в любом случае вставлять тестовые данные, чтобы упростить просмотр работы функций приложения без необходимости вручную вставлять большой объем данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-146">For this tutorial, you'll be using Migrations for deployment, but your `Seed` method will insert test data anyway in order to make it easier to see how application functionality works without having to manually insert a lot of data.</span></span>

1. <span data-ttu-id="fe2ed-147">Замените содержимое файла *Configuration.CS* следующим кодом, который загружает тестовые данные в новую базу данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-147">Replace the contents of the *Configuration.cs* file with the following code, which loads test data into the new database.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    <span data-ttu-id="fe2ed-148">Метод [SEED](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) принимает объект контекста базы данных в качестве входного параметра, а код в методе использует этот объект для добавления новых сущностей в базу данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-148">The [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method takes the database context object as an input parameter, and the code in the method uses that object to add new entities to the database.</span></span> <span data-ttu-id="fe2ed-149">Для каждого типа сущности код создает коллекцию новых сущностей, добавляет их в соответствующее свойство [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) , а затем сохраняет изменения в базе данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-149">For each entity type, the code creates a collection of new entities, adds them to the appropriate [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) property, and then saves the changes to the database.</span></span> <span data-ttu-id="fe2ed-150">Не нужно вызывать метод [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) после каждой группы сущностей, как это сделано здесь, но это помогает узнать источник проблемы, если исключение возникает во время записи кода в базу данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-150">It isn't necessary to call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method after each group of entities, as is done here, but doing that helps you locate the source of a problem if an exception occurs while the code is writing to the database.</span></span>

    <span data-ttu-id="fe2ed-151">Некоторые инструкции, которые вставляют данные, используют метод [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) для выполнения операции "Upsert".</span><span class="sxs-lookup"><span data-stu-id="fe2ed-151">Some of the statements that insert data use the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method to perform an "upsert" operation.</span></span> <span data-ttu-id="fe2ed-152">Поскольку метод `Seed` выполняется каждый раз при выполнении команды `update-database`, как правило, после каждой миграции данные не могут быть просто вставлены, так как добавляемые строки уже будут существовать после первой миграции, создающей базу данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-152">Because the `Seed` method runs every time you execute the `update-database` command, typically after each migration, you can't just insert data, because the rows you are trying to add will already be there after the first migration that creates the database.</span></span> <span data-ttu-id="fe2ed-153">Операция "Upsert" предотвращает ошибки, которые могут возникать при попытке вставить уже существующую строку, но ***переопределяет*** любые изменения данных, которые могли быть сделаны при тестировании приложения.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-153">The "upsert" operation prevents errors that would happen if you try to insert a row that already exists, but it ***overrides*** any changes to data that you may have made while testing the application.</span></span> <span data-ttu-id="fe2ed-154">При использовании тестовых данных в некоторых таблицах может быть нежелательно: в некоторых случаях при изменении данных во время тестирования необходимо сохранить изменения после обновления базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-154">With test data in some tables you might not want that to happen: in some cases when you change data while testing you want your changes to remain after database updates.</span></span> <span data-ttu-id="fe2ed-155">В этом случае необходимо выполнить операцию условной вставки: вставить строку, если она еще не существует.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-155">In that case you want to do a conditional insert operation: insert a row only if it doesn't already exist.</span></span> <span data-ttu-id="fe2ed-156">Метод SEED использует оба подхода.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-156">The Seed method uses both approaches.</span></span>

    <span data-ttu-id="fe2ed-157">Первый параметр, передаваемый методу [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) , указывает свойство, используемое для проверки, существует ли уже строка.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-157">The first parameter passed to the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method specifies the property to use to check if a row already exists.</span></span> <span data-ttu-id="fe2ed-158">Для данных тестового учащегося, которые вы предоставляете, для этой цели можно использовать свойство `LastName`, так как каждое Последнее имя в списке является уникальным:</span><span class="sxs-lookup"><span data-stu-id="fe2ed-158">For the test student data that you are providing, the `LastName` property can be used for this purpose since each last name in the list is unique:</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    <span data-ttu-id="fe2ed-159">В этом коде предполагается, что последние имена являются уникальными.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-159">This code assumes that last names are unique.</span></span> <span data-ttu-id="fe2ed-160">Если вы вручную добавите учащийся с дубликатом фамилии, вы получите следующее исключение при следующем выполнении миграции:</span><span class="sxs-lookup"><span data-stu-id="fe2ed-160">If you manually add a student with a duplicate last name, you'll get the following exception the next time you perform a migration:</span></span>

    <span data-ttu-id="fe2ed-161">**Последовательность содержит более одного элемента**</span><span class="sxs-lookup"><span data-stu-id="fe2ed-161">**Sequence contains more than one element**</span></span>

    <span data-ttu-id="fe2ed-162">Дополнительные сведения об обработке избыточных данных, таких как два учащихся с именем "Александр Carson", см. в разделе [Заполнение и отладка Entity Framework (EF) баз данных](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) в блоге Рик Андерсон (.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-162">For information about how to handle redundant data such as two students named "Alexander Carson", see [Seeding and Debugging Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) on Rick Anderson's blog.</span></span> <span data-ttu-id="fe2ed-163">Дополнительные сведения о методе `AddOrUpdate` см. в разделе о [методе EF 4,3 AddOrUpdate](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) в блоге Юлия Лерман.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-163">For more information about the `AddOrUpdate` method, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

    <span data-ttu-id="fe2ed-164">Код, создающий `Enrollment` сущности, предполагает, что у вас есть `ID` значение в сущностях в коллекции `students`, хотя это свойство не было задано в коде, который создает коллекцию.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-164">The code that creates `Enrollment` entities assumes you have the `ID` value in the entities in the `students` collection, although you didn't set that property in the code that creates the collection.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    <span data-ttu-id="fe2ed-165">Здесь можно использовать свойство `ID`, так как значение `ID` задается при вызове `SaveChanges` для коллекции `students`.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-165">You can use the `ID` property here because the `ID` value is set when you call `SaveChanges` for the `students` collection.</span></span> <span data-ttu-id="fe2ed-166">EF автоматически получает значение первичного ключа при вставке сущности в базу данных и обновляет свойство `ID` сущности в памяти.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-166">EF automatically gets the primary key value when it inserts an entity into the database, and it updates the `ID` property of the entity in memory.</span></span>

    <span data-ttu-id="fe2ed-167">Код, добавляющий каждую сущность `Enrollment` в набор сущностей `Enrollments`, не использует метод `AddOrUpdate`.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-167">The code that adds each `Enrollment` entity to the `Enrollments` entity set doesn't use the `AddOrUpdate` method.</span></span> <span data-ttu-id="fe2ed-168">Он проверяет, существует ли сущность, и вставляет сущность, если она не существует.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-168">It checks if an entity already exists and inserts the entity if it doesn't exist.</span></span> <span data-ttu-id="fe2ed-169">Этот подход позволит сохранить изменения, внесенные в уровень регистрации, с помощью пользовательского интерфейса приложения.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-169">This approach will preserve changes you make to an enrollment grade by using the application UI.</span></span> <span data-ttu-id="fe2ed-170">Код выполняет цикл по каждому элементу [списка](https://msdn.microsoft.com/library/6sh2ey19.aspx) `Enrollment`и если регистрация не найдена в базе данных, она добавляет регистрацию в базу данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-170">The code loops through each member of the `Enrollment`[List](https://msdn.microsoft.com/library/6sh2ey19.aspx) and if the enrollment is not found in the database, it adds the enrollment to the database.</span></span> <span data-ttu-id="fe2ed-171">При первом обновлении базы данных она будет пустой, поэтому она добавит каждую регистрацию.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-171">The first time you update the database, the database will be empty, so it will add each enrollment.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]

2. <span data-ttu-id="fe2ed-172">Создайте проект.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-172">Build the project.</span></span>

### <a name="execute-the-first-migration"></a><span data-ttu-id="fe2ed-173">Выполнение первой миграции</span><span class="sxs-lookup"><span data-stu-id="fe2ed-173">Execute the first migration</span></span>

<span data-ttu-id="fe2ed-174">При выполнении команды `add-migration` выполняется миграция кода, который создал бы базу данных с нуля.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-174">When you executed the `add-migration` command, Migrations generated the code that would create the database from scratch.</span></span> <span data-ttu-id="fe2ed-175">Этот код также находится в папке *migrations* в файле с именем *&lt;timestamp&gt;\_InitialCreate.CS*.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-175">This code is also in the *Migrations* folder, in the file named *&lt;timestamp&gt;\_InitialCreate.cs*.</span></span> <span data-ttu-id="fe2ed-176">Метод `Up` класса `InitialCreate` создает таблицы базы данных, соответствующие наборам сущностей модели данных, а метод `Down` удаляет их.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-176">The `Up` method of the `InitialCreate` class creates the database tables that correspond to the data model entity sets, and the `Down` method deletes them.</span></span>

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

<span data-ttu-id="fe2ed-177">Функция миграций вызывает метод `Up`, чтобы реализовать изменения модели данных для миграции.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-177">Migrations calls the `Up` method to implement the data model changes for a migration.</span></span> <span data-ttu-id="fe2ed-178">При вводе команды для отката обновления функция миграций вызывает метод `Down`.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-178">When you enter a command to roll back the update, Migrations calls the `Down` method.</span></span>

<span data-ttu-id="fe2ed-179">Это первоначальный перенос, созданный при вводе команды `add-migration InitialCreate`.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-179">This is the initial migration that was created when you entered the `add-migration InitialCreate` command.</span></span> <span data-ttu-id="fe2ed-180">Параметр (`InitialCreate` в примере) используется для имени файла и может быть любым. Обычно вы выбираете слово или фразу, которая суммирует данные, выполняемые при миграции.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-180">The parameter (`InitialCreate` in the example) is used for the file name and can be whatever you want; you typically choose a word or phrase that summarizes what is being done in the migration.</span></span> <span data-ttu-id="fe2ed-181">Например, вы можете присвоить более поздней миграции имя &quot;AddDepartmentTable&quot;.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-181">For example, you might name a later migration &quot;AddDepartmentTable&quot;.</span></span>

<span data-ttu-id="fe2ed-182">Если вы создали первоначальную миграцию, когда база данных уже существовала, код для создания базы данных формируется, но выполнять его не требуется, так как база данных уже соответствует модели данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-182">If you created the initial migration when the database already exists, the database creation code is generated but it doesn't have to run because the database already matches the data model.</span></span> <span data-ttu-id="fe2ed-183">Однако при развертывании приложения в другой среде, где база данных еще не существует, этот код будет выполняться для создания базы данных, поэтому рекомендуется сначала его протестировать.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-183">When you deploy the app to another environment where the database doesn't exist yet, this code will run to create your database, so it's a good idea to test it first.</span></span> <span data-ttu-id="fe2ed-184">Вот почему вы изменили имя базы данных в строке подключения ранее&mdash;так, что миграция может создать новую с нуля.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-184">That's why you changed the name of the database in the connection string earlier&mdash;so that migrations can create a new one from scratch.</span></span>

1. <span data-ttu-id="fe2ed-185">В окне **Консоль диспетчера пакетов** введите следующую команду:</span><span class="sxs-lookup"><span data-stu-id="fe2ed-185">In the **Package Manager Console** window, enter the following command:</span></span>

    `update-database`

    <span data-ttu-id="fe2ed-186">Команда `update-database` запускает метод `Up` для создания базы данных, а затем запускает метод `Seed` для заполнения базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-186">The `update-database` command runs the `Up` method to create the database and then it runs the `Seed` method to populate the database.</span></span> <span data-ttu-id="fe2ed-187">Этот процесс будет выполняться автоматически в рабочей среде после развертывания приложения, как показано в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-187">The same process will run automatically in production after you deploy the application, as you'll see in the following section.</span></span>
2. <span data-ttu-id="fe2ed-188">Используйте **Обозреватель сервера** , чтобы проверить базу данных, как в первом руководстве, и запустить приложение, чтобы убедиться, что все по-прежнему работает так же, как и раньше.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-188">Use **Server Explorer** to inspect the database as you did in the first tutorial, and run the application to verify that everything still works the same as before.</span></span>

## <a name="deploy-to-azure"></a><span data-ttu-id="fe2ed-189">Развертывание в Azure</span><span class="sxs-lookup"><span data-stu-id="fe2ed-189">Deploy to Azure</span></span>

<span data-ttu-id="fe2ed-190">Пока приложение запущено локально в IIS Express на компьютере разработчика.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-190">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="fe2ed-191">Чтобы сделать его доступным для других пользователей через Интернет, необходимо развернуть его для поставщика услуг размещения веб-сайтов.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-191">To make it available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="fe2ed-192">В этом разделе руководства вы развернете его в Azure.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-192">In this section of the tutorial, you'll deploy it to Azure.</span></span> <span data-ttu-id="fe2ed-193">Этот раздел является необязательным. Вы можете пропустить это и продолжить выполнение приведенного ниже руководства. Кроме того, вы можете адаптировать инструкции в этом разделе для другого поставщика услуг размещения по своему усмотрению.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-193">This section is optional; you can skip this and continue with the following tutorial, or you can adapt the instructions in this section for a different hosting provider of your choice.</span></span>

### <a name="use-code-first-migrations-to-deploy-the-database"></a><span data-ttu-id="fe2ed-194">Использование Code First миграций для развертывания базы данных</span><span class="sxs-lookup"><span data-stu-id="fe2ed-194">Use Code First migrations to deploy the database</span></span>

<span data-ttu-id="fe2ed-195">Чтобы развернуть базу данных, используйте Code First Migrations.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-195">To deploy the database, you'll use Code First Migrations.</span></span> <span data-ttu-id="fe2ed-196">При создании профиля публикации, который используется для настройки параметров развертывания из Visual Studio, необходимо установить флажок **обновить базу данных**.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-196">When you create the publish profile that you use to configure settings for deploying from Visual Studio, you'll select a check box labeled **Update Database**.</span></span> <span data-ttu-id="fe2ed-197">Этот параметр приводит к тому, что процесс развертывания автоматически настраивает файл *Web. config* приложения на целевом сервере, чтобы Code First использует класс инициализатора `MigrateDatabaseToLatestVersion`.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-197">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>

<span data-ttu-id="fe2ed-198">Visual Studio не выполняет никаких действий с базой данных во время процесса развертывания, пока выполняется копирование проекта на целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-198">Visual Studio doesn't do anything with the database during the deployment process while it is copying your project to the destination server.</span></span> <span data-ttu-id="fe2ed-199">При запуске развернутого приложения и доступе к базе данных в первый раз после развертывания Code First проверяет, соответствует ли база данных модели данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-199">When you run the deployed application and it accesses the database for the first time after deployment, Code First checks if the database matches the data model.</span></span> <span data-ttu-id="fe2ed-200">В случае несоответствия Code First автоматически создает базу данных (если она еще не существует) или обновляет схему базы данных до последней версии (если база данных существует, но не соответствует модели).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-200">If there's a mismatch, Code First automatically creates the database (if it doesn't exist yet) or updates the database schema to the latest version (if a database exists but doesn't match the model).</span></span> <span data-ttu-id="fe2ed-201">Если приложение реализует метод миграции `Seed`, метод выполняется после создания базы данных или обновления схемы.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-201">If the application implements a Migrations `Seed` method, the method runs after the database is created or the schema is updated.</span></span>

<span data-ttu-id="fe2ed-202">При миграции `Seed` метод вставляет проверочные данные.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-202">Your Migrations `Seed` method inserts test data.</span></span> <span data-ttu-id="fe2ed-203">При развертывании в рабочей среде потребуется изменить метод `Seed`, чтобы он вставил только те данные, которые необходимо вставить в рабочую базу данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-203">If you were deploying to a production environment, you would have to change the `Seed` method so that it only inserts data that you want to be inserted into your production database.</span></span> <span data-ttu-id="fe2ed-204">Например, в текущей модели данных может возникнуть необходимость в реальных курсах, но вымышленных учащихся в базе данных разработки.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-204">For example, in your current data model you might want to have real courses but fictional students in the development database.</span></span> <span data-ttu-id="fe2ed-205">Вы можете написать `Seed` метод для загрузки в процессе разработки, а затем закомментировать вымышленные учащиеся перед развертыванием в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-205">You can write a `Seed` method to load both in development, and then comment out the fictional students before you deploy to production.</span></span> <span data-ttu-id="fe2ed-206">Кроме того, можно написать `Seed` метод для загрузки только курсов и ввести вымышленные учащиеся в тестовой базе данных вручную с помощью пользовательского интерфейса приложения.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-206">Or you can write a `Seed` method to load only courses, and enter the fictional students in the test database manually by using the application's UI.</span></span>

### <a name="get-an-azure-account"></a><span data-ttu-id="fe2ed-207">Получение учетной записи Azure</span><span class="sxs-lookup"><span data-stu-id="fe2ed-207">Get an Azure account</span></span>

<span data-ttu-id="fe2ed-208">Вам потребуется учетная запись Azure.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-208">You'll need an Azure account.</span></span> <span data-ttu-id="fe2ed-209">Если у вас ее еще нет, но у вас есть подписка Visual Studio, вы можете [активировать преимущества подписки](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-209">If you don't already have one, but you do have a Visual Studio subscription, you can [activate your subscription benefits](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span></span> <span data-ttu-id="fe2ed-210">В противном случае можно создать бесплатную пробную учетную запись всего за несколько минут.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-210">Otherwise, you can create a free trial account in just a couple of minutes.</span></span> <span data-ttu-id="fe2ed-211">Дополнительные сведения см. в разделе [Бесплатная пробная версия Azure](https://azure.microsoft.com/free/).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-211">For details, see [Azure Free Trial](https://azure.microsoft.com/free/).</span></span>

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a><span data-ttu-id="fe2ed-212">Создание веб-сайта и базы данных SQL в Azure</span><span class="sxs-lookup"><span data-stu-id="fe2ed-212">Create a web site and a SQL database in Azure</span></span>

<span data-ttu-id="fe2ed-213">Ваше веб-приложение в Azure будет работать в общей среде размещения. Это означает, что она выполняется на виртуальных машинах, которые являются общими для других клиентов Azure.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-213">Your web app in Azure will run in a shared hosting environment, which means it runs on virtual machines (VMs) that are shared with other Azure clients.</span></span> <span data-ttu-id="fe2ed-214">Общая среда внешнего размещения – это недорогой способ начать работу в облачной среде.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-214">A shared hosting environment is a low-cost way to get started in the cloud.</span></span> <span data-ttu-id="fe2ed-215">Если позднее ваш веб-трафик увеличится, приложение можно масштабировать по необходимости, запуская его на выделенных виртуальных машинах.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-215">Later, if your web traffic increases, the application can scale to meet the need by running on dedicated VMs.</span></span> <span data-ttu-id="fe2ed-216">Дополнительные сведения о ценах на службу приложений Azure см. в статье [цены на службу приложений](https://azure.microsoft.com/pricing/details/app-service/).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-216">To learn more about Pricing Options for Azure App Service, read [App Service pricing](https://azure.microsoft.com/pricing/details/app-service/).</span></span>

<span data-ttu-id="fe2ed-217">Вы развернете базу данных в базе данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-217">You'll deploy the database to Azure SQL database.</span></span> <span data-ttu-id="fe2ed-218">База данных SQL — это облачная служба реляционной базы данных, построенная на основе технологий SQL Server.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-218">SQL database is a cloud-based relational database service that is built on SQL Server technologies.</span></span> <span data-ttu-id="fe2ed-219">Средства и приложения, работающие с SQL Server также работают с базой данных SQL.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-219">Tools and applications that work with SQL Server also work with SQL database.</span></span>

1. <span data-ttu-id="fe2ed-220">В [портал управления Azure](https://portal.azure.com)выберите **создать ресурс** на левой вкладке, а затем выберите **Просмотреть все** в **новой** панели (или в *колонке*), чтобы просмотреть все доступные ресурсы.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-220">In the [Azure Management Portal](https://portal.azure.com), choose **Create a resource** in the left tab and then choose **See all** on the **New** pane (or *blade*) to see all available resources.</span></span> <span data-ttu-id="fe2ed-221">Выберите **веб-приложение + SQL** в разделе **веб** в колонке **все** .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-221">Choose **Web App + SQL** in the **Web** section of the **Everything** blade.</span></span> <span data-ttu-id="fe2ed-222">Наконец, выберите **создать**.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-222">Finally, choose **Create**.</span></span>

    ![Создание ресурса на портале Azure](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/create-azure-resource.png)

   <span data-ttu-id="fe2ed-224">Откроется форма для создания нового **нового ресурса веб-приложения + SQL** .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-224">The form to create a new **New Web App + SQL** resource opens.</span></span>

2. <span data-ttu-id="fe2ed-225">Введите строку в поле **имя приложения** , чтобы использовать его в качестве уникального URL-адреса для приложения.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-225">Enter a string in the **App name** box to use as the unique URL for your application.</span></span> <span data-ttu-id="fe2ed-226">Полный URL-адрес будет содержать то, что вы вводите здесь, а также домен по умолчанию служб приложений Azure (. azurewebsites.net).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-226">The complete URL will consist of what you enter here plus the default domain of Azure App Services (.azurewebsites.net).</span></span> <span data-ttu-id="fe2ed-227">Если **имя приложения** уже занято, мастер выводит сообщение с красным *названием приложение недоступно* .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-227">If the **App name** is already taken, the Wizard notifies you with a red *The app name is not available* message.</span></span> <span data-ttu-id="fe2ed-228">Если **имя приложения** доступно, отображается зеленая галочка.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-228">If the **App name** is available, you see a green checkmark.</span></span>

3. <span data-ttu-id="fe2ed-229">В поле **Подписка** выберите подписку Azure, в которой должна находиться **служба приложений** .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-229">In the **Subscription** box, choose the Azure Subscription in which you want the **App Service** to reside.</span></span>

4. <span data-ttu-id="fe2ed-230">В текстовом поле **Группа ресурсов** выберите группу ресурсов или создайте новую.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-230">In the **Resource Group** text box, choose a Resource Group or create a new one.</span></span> <span data-ttu-id="fe2ed-231">Этот параметр указывает центр обработки данных, в котором будет выполняться веб-сайт.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-231">This setting specifies which data center your web site will run in.</span></span> <span data-ttu-id="fe2ed-232">Дополнительные сведения о группах ресурсов см. в разделе [группы ресурсов](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-232">For more information about Resource Groups, see [Resource groups](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span></span>

5. <span data-ttu-id="fe2ed-233">Создайте новый **план службы приложений** , щелкнув *раздел служба приложений*, **создавайте новые**и заполните **план службы приложений** (это может быть то же имя, что и служба приложений), **Расположение**и **ценовая** Категория (бесплатный вариант).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-233">Create a new **App Service Plan** by clicking the *App Service section*, **Create New**, and fill in **App Service plan** (can be same name as App Service), **Location**, and **Pricing tier** (there is a free option).</span></span>

6. <span data-ttu-id="fe2ed-234">Щелкните **база данных SQL**, а затем выберите **создать новую базу** данных или выбрать существующую.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-234">Click **SQL Database**, and then choose **Create a new database** or select an existing database.</span></span>

7. <span data-ttu-id="fe2ed-235">В поле **имя** введите имя базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-235">In the **Name** box, enter a name for your database.</span></span>
8. <span data-ttu-id="fe2ed-236">Щелкните поле **целевой сервер** , а затем выберите **создать новый сервер**.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-236">Click the **Target Server** box, and then select **Create a new server**.</span></span> <span data-ttu-id="fe2ed-237">Кроме того, если ранее был создан сервер, можно выбрать этот сервер из списка доступных серверов.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-237">Alternatively, if you previously created a server, you can select that server from list of available servers.</span></span>
9. <span data-ttu-id="fe2ed-238">Выберите **категорию ценовая** Категория и щелкните *Free (бесплатный*).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-238">Choose **Pricing tier** section, choose *Free*.</span></span> <span data-ttu-id="fe2ed-239">Если требуются дополнительные ресурсы, базу данных можно масштабировать в любое время.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-239">If additional resources are needed, the database can be scaled up at any time.</span></span> <span data-ttu-id="fe2ed-240">Дополнительные сведения о ценах на SQL Azure см. на странице [цен на базу данных SQL Azure](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-240">To learn more on Azure SQL Pricing, see [Azure SQL Database pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span></span>
10. <span data-ttu-id="fe2ed-241">При необходимости измените [Параметры сортировки](/sql/relational-databases/collations/collation-and-unicode-support) .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-241">Modify [collation](/sql/relational-databases/collations/collation-and-unicode-support) as needed.</span></span>
11. <span data-ttu-id="fe2ed-242">Введите **имя пользователя администратора SQL** и **пароль администратора SQL**.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-242">Enter an administrator **SQL Admin Username** and **SQL Admin Password**.</span></span>

    - <span data-ttu-id="fe2ed-243">Если выбран **новый сервер базы данных SQL**, определите новое имя и пароль, которые будут использоваться позже при доступе к базе данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-243">If you selected **New SQL Database server**, define a new name and password that you'll use later when you access the database.</span></span>
    - <span data-ttu-id="fe2ed-244">Если вы выбрали ранее созданный сервер, введите учетные данные для этого сервера.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-244">If you selected a server that you created previously, enter credentials for that server.</span></span>

12. <span data-ttu-id="fe2ed-245">Сбор данных телеметрии можно включить для службы приложений с помощью Application Insights.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-245">Telemetry collection can be enabled for App Service using Application Insights.</span></span> <span data-ttu-id="fe2ed-246">При небольшом объеме настройки Application Insights собирает ценные сведения о событиях, исключениях, зависимостях, запросах и трассировках.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-246">With little configuration, Application Insights collects valuable event, exception, dependency, request, and trace information.</span></span> <span data-ttu-id="fe2ed-247">Дополнительные сведения о Application Insights см. в разделе [Azure Monitor](https://azure.microsoft.com/services/monitor/).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-247">To learn more about Application Insights, see [Azure Monitor](https://azure.microsoft.com/services/monitor/).</span></span>
13. <span data-ttu-id="fe2ed-248">Щелкните **создать** внизу, чтобы указать, что все готово.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-248">Click **Create** at the bottom to indicate that you're finished.</span></span>

    <span data-ttu-id="fe2ed-249">Портал управления возвращается на страницу панели мониторинга, а область **уведомлений** в верхней части страницы показывает, что сайт создается.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-249">The Management Portal returns to the Dashboard page, and the **Notifications** area at the top of the page shows that the site is being created.</span></span> <span data-ttu-id="fe2ed-250">Через некоторое время (обычно меньше минуты) имеется уведомление о том, что развертывание прошло.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-250">After a while (typically less than a minute), there's a notification that the Deployment succeeded.</span></span> <span data-ttu-id="fe2ed-251">На панели навигации слева в разделе **службы приложений** появится новая служба приложений, а в разделе **базы данных SQL** появится новая база данных SQL.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-251">In the navigation bar at the left, the new App Service appears in the **App Services** section and the new SQL database appears in the **SQL databases** section.</span></span>

### <a name="deploy-the-app-to-azure"></a><span data-ttu-id="fe2ed-252">Развертывание приложения в Azure</span><span class="sxs-lookup"><span data-stu-id="fe2ed-252">Deploy the app to Azure</span></span>

1. <span data-ttu-id="fe2ed-253">В Visual Studio щелкните правой кнопкой мыши проект в **обозревателе решений** и выберите **Опубликовать** в контекстном меню.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-253">In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.</span></span>

2. <span data-ttu-id="fe2ed-254">На странице **Выбор целевого объекта публикации** выберите **служба приложений** , а затем щелкните **существующие**и нажмите кнопку **опубликовать**.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-254">On the **Pick a publish target** page, choose **App Service** and then **Select Existing**, and then choose **Publish**.</span></span>

    ![Выбор целевой страницы публикации](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/publish-select-existing-azure-app-service.png)

3. <span data-ttu-id="fe2ed-256">Если вы ранее не добавили подписку Azure в Visual Studio, выполните действия на экране.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-256">If you haven't previously added your Azure subscription in Visual Studio, perform the steps on the screen.</span></span> <span data-ttu-id="fe2ed-257">Эти действия позволяют Visual Studio подключиться к подписке Azure, чтобы список **служб приложений** включал ваш веб-сайт.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-257">These steps enable Visual Studio to connect to your Azure subscription so that the list of **App Services** will include your web site.</span></span>

4. <span data-ttu-id="fe2ed-258">На странице **служба приложений** выберите **подписку** , в которую вы добавили службу приложений.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-258">On the **App Service** page, select the **Subscription** you added the App Service to.</span></span> <span data-ttu-id="fe2ed-259">В разделе **вид**выберите **Группа ресурсов**.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-259">Under **View**, select **Resource Group**.</span></span> <span data-ttu-id="fe2ed-260">Разверните группу ресурсов, в которую вы добавили службу приложений, а затем выберите службу приложений.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-260">Expand the resource group you added the App Service to, and then select the App Service.</span></span> <span data-ttu-id="fe2ed-261">Нажмите кнопку **ОК** , чтобы опубликовать приложение.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-261">Choose **OK** to publish the app.</span></span>

5. <span data-ttu-id="fe2ed-262">В окне **Вывод** указывается, какие действия по развертыванию были выполнены, а также сообщается об успешном завершении развертывания.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-262">The **Output** window shows what deployment actions were taken and reports successful completion of the deployment.</span></span>

6. <span data-ttu-id="fe2ed-263">После успешного развертывания браузер по умолчанию автоматически открывается по URL-адресу развернутого сайта.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-263">Upon successful deployment, the default browser automatically opens to the URL of the deployed web site.</span></span>

    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/cloud-app-browser.png)

    <span data-ttu-id="fe2ed-265">Теперь приложение выполняется в облаке.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-265">Your app is now running in the cloud.</span></span>

<span data-ttu-id="fe2ed-266">На этом этапе база данных *SchoolContext* была создана в базе данных SQL Azure, так как вы выбрали **Execute Code First migrations (выполняется при запуске приложения)** .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-266">At this point, the *SchoolContext* database has been created in the Azure SQL database because you selected **Execute Code First Migrations (runs on app start)**.</span></span> <span data-ttu-id="fe2ed-267">Файл *Web. config* на развернутом веб-сайте был изменен таким образом, чтобы инициализатор [мигратедатабасетолатестверсион](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) выполнялся в первый раз, когда код считывает или записывает данные в базе данных (что происходит при выборе вкладки **students** ):</span><span class="sxs-lookup"><span data-stu-id="fe2ed-267">The *Web.config* file in the deployed web site has been changed so that the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer runs the first time your code reads or writes data in the database (which happened when you selected the **Students** tab):</span></span>

![Фрагмент файла Web. config](https://asp.net/media/4367421/mig.png)

<span data-ttu-id="fe2ed-269">Процесс развертывания также создал новую строку подключения *(SchoolContext\_датабасепублиш*) для Code First migrations, которая используется для обновления схемы базы данных и заполнения базы данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-269">The deployment process also created a new connection string *(SchoolContext\_DatabasePublish*) for Code First Migrations to use for updating the database schema and seeding the database.</span></span>

![Строка подключения в файле Web. config](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

<span data-ttu-id="fe2ed-271">Развернутая версия файла Web. config можно найти на компьютере в *контосауниверсити\обж\релеасе\паккаже\паккажетмп\веб.конфиг*. Доступ к развернутому файлу *Web. config* можно получить с помощью протокола FTP.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-271">You can find the deployed version of the Web.config file on your own computer in *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. You can access the deployed *Web.config* file itself by using FTP.</span></span> <span data-ttu-id="fe2ed-272">Инструкции см. в статье [развертывание кода с помощью Visual Studio в ASP.NET Web Deployment](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-272">For instructions, see [ASP.NET Web Deployment using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span></span> <span data-ttu-id="fe2ed-273">Следуйте инструкциям, которые начинаются с "для использования средства FTP, требуются три вещи: URL-адрес FTP, имя пользователя и пароль".</span><span class="sxs-lookup"><span data-stu-id="fe2ed-273">Follow the instructions that start with "To use an FTP tool, you need three things: the FTP URL, the user name, and the password."</span></span>

> [!NOTE]
> <span data-ttu-id="fe2ed-274">Веб-приложение не реализует безопасность, поэтому любой пользователь, который найдет URL-адрес, может изменить данные.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-274">The web app doesn't implement security, so anyone who finds the URL can change the data.</span></span> <span data-ttu-id="fe2ed-275">Инструкции по обеспечению безопасности веб-сайта см. в статье [развертывание безопасного приложения ASP.NET MVC с членством, OAuth и база данных SQL в Azure](/aspnet/core/security/authorization/secure-data).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-275">For instructions on how to secure the web site, see [Deploy a Secure ASP.NET MVC app with Membership, OAuth, and SQL database to Azure](/aspnet/core/security/authorization/secure-data).</span></span> <span data-ttu-id="fe2ed-276">Вы можете запретить другим пользователям использовать сайт, останавливая службу с помощью портал управления или **Обозреватель сервера** в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-276">You can prevent other people from using the site by stopping the service using the Azure Management Portal or **Server Explorer** in Visual Studio.</span></span>

![Пункт меню "закрыть службу приложений"](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/server-explorer-stop-app-service.png)

## <a name="advanced-migrations-scenarios"></a><span data-ttu-id="fe2ed-278">Сценарии расширенной миграции</span><span class="sxs-lookup"><span data-stu-id="fe2ed-278">Advanced migrations scenarios</span></span>

<span data-ttu-id="fe2ed-279">При развертывании базы данных с автоматическим запуском миграций, как показано в этом руководстве, и при развертывании на веб-сайт, работающий на нескольких серверах, можно получить несколько серверов, пытающихся одновременно запустить миграцию.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-279">If you deploy a database by running migrations automatically as shown in this tutorial, and you are deploying to a web site that runs on multiple servers, you could get multiple servers trying to run migrations at the same time.</span></span> <span data-ttu-id="fe2ed-280">Миграции являются атомарными, поэтому если два сервера пытаются выполнить одну и ту же миграцию, одна из них будет успешно выполнена, а другая завершится неудачей (при условии, что операции не могут быть выполнены дважды).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-280">Migrations are atomic, so if two servers try to run the same migration, one will succeed and the other will fail (assuming the operations can't be done twice).</span></span> <span data-ttu-id="fe2ed-281">В этом случае, если вы хотите избежать этих проблем, можно вызвать миграции вручную и настроить собственный код так, чтобы он выводился только один раз.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-281">In that scenario if you want to avoid those issues, you can call migrations manually and set up your own code so that it only happens once.</span></span> <span data-ttu-id="fe2ed-282">Дополнительные сведения см. в статьях [Запуск и создание сценариев миграции из кода](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) в блоге Роуэн Миллер и [Migrate. exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (для выполнения миграций из командной строки).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-282">For more information, see [Running and Scripting Migrations from Code](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) on Rowan Miller's blog and [Migrate.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (for executing migrations from the command line).</span></span>

<span data-ttu-id="fe2ed-283">Сведения о других сценариях миграции см. в статье [переходы по презентациям](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-283">For information about other migrations scenarios, see [Migrations Screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span></span>

## <a name="update-specific-migration"></a><span data-ttu-id="fe2ed-284">Обновление конкретной миграции</span><span class="sxs-lookup"><span data-stu-id="fe2ed-284">Update specific migration</span></span>

`update-database -target MigrationName`

<span data-ttu-id="fe2ed-285">Команда `update-database -target MigrationName` выполняет целевую миграцию.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-285">The `update-database -target MigrationName` command runs the targeted migration.</span></span>

## <a name="ignore-migration-changes-to-database"></a><span data-ttu-id="fe2ed-286">Игнорировать изменения миграции для базы данных</span><span class="sxs-lookup"><span data-stu-id="fe2ed-286">Ignore migration changes to database</span></span>

`Add-migration MigrationName -ignoreChanges`

<span data-ttu-id="fe2ed-287">`ignoreChanges` создает пустую миграцию с текущей моделью в виде моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-287">`ignoreChanges` creates an empty migration with the current model as a snapshot.</span></span>

## <a name="code-first-initializers"></a><span data-ttu-id="fe2ed-288">Инициализаторы Code First</span><span class="sxs-lookup"><span data-stu-id="fe2ed-288">Code First initializers</span></span>

<span data-ttu-id="fe2ed-289">В разделе Deployment (развертывание) вы видели используемый инициализатор [мигратедатабасетолатестверсион](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) .</span><span class="sxs-lookup"><span data-stu-id="fe2ed-289">In the deployment section, you saw the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer being used.</span></span> <span data-ttu-id="fe2ed-290">Code First также предоставляет другие инициализаторы, включая [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (по умолчанию), [дропкреатедатабасеифмоделчанжес](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (который вы использовали ранее) и [дропкреатедатабасеалвайс](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-290">Code First also provides other initializers, including [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (the default), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (which you used earlier) and [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span></span> <span data-ttu-id="fe2ed-291">Инициализатор `DropCreateAlways` может быть полезен при настройке условий для модульных тестов.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-291">The `DropCreateAlways` initializer can be useful for setting up conditions for unit tests.</span></span> <span data-ttu-id="fe2ed-292">Можно также написать собственные инициализаторы, и вы можете вызвать инициализатор явным образом, если вы не хотите ждать, пока приложение не закончит чтение или запись в базу данных.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-292">You can also write your own initializers, and you can call an initializer explicitly if you don't want to wait until the application reads from or writes to the database.</span></span>

<span data-ttu-id="fe2ed-293">Дополнительные сведения о инициализаторах см. в разделе Основные сведения об инициализаторах [баз данных в Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) и главе 6 [программного программирования книги Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) Джулия Лерман и Роуэн Миллер.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-293">For more information about initializers, see [Understanding Database Initializers in Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) and chapter 6 of the book [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julie Lerman and Rowan Miller.</span></span>

## <a name="get-the-code"></a><span data-ttu-id="fe2ed-294">Получение кода</span><span class="sxs-lookup"><span data-stu-id="fe2ed-294">Get the code</span></span>

[<span data-ttu-id="fe2ed-295">Скачать завершенный проект</span><span class="sxs-lookup"><span data-stu-id="fe2ed-295">Download the Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="fe2ed-296">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="fe2ed-296">Additional resources</span></span>

<span data-ttu-id="fe2ed-297">Ссылки на другие ресурсы Entity Framework можно найти в [материалах, рекомендуемых для доступа к данным ASP.NET](xref:whitepapers/aspnet-data-access-content-map).</span><span class="sxs-lookup"><span data-stu-id="fe2ed-297">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](xref:whitepapers/aspnet-data-access-content-map).</span></span>

## <a name="next-steps"></a><span data-ttu-id="fe2ed-298">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="fe2ed-298">Next steps</span></span>

<span data-ttu-id="fe2ed-299">Изучив это руководство, вы:</span><span class="sxs-lookup"><span data-stu-id="fe2ed-299">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="fe2ed-300">Включенные Code First миграции</span><span class="sxs-lookup"><span data-stu-id="fe2ed-300">Enabled Code First migrations</span></span>
> * <span data-ttu-id="fe2ed-301">Развертывание приложения в Azure (необязательно)</span><span class="sxs-lookup"><span data-stu-id="fe2ed-301">Deployed the app in Azure (optional)</span></span>

<span data-ttu-id="fe2ed-302">Перейдите к следующей статье, чтобы узнать, как создать более сложную модель данных для приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="fe2ed-302">Advance to the next article to learn how to create a more complex data model for an ASP.NET MVC Application.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="fe2ed-303">Создание более сложной модели данных</span><span class="sxs-lookup"><span data-stu-id="fe2ed-303">Create a more complex data model</span></span>](creating-a-more-complex-data-model-for-an-asp-net-mvc-application.md)
