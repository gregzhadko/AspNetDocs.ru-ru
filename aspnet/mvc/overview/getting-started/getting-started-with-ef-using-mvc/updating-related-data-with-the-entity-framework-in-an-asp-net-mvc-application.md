---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application
title: Руководство. обновление связанных данных с помощью EF в приложении ASP.NET MVC
description: В этом учебнике вы обновите связанные данные. Для большинства связей это можно сделать, обновив поля внешнего ключа или свойства навигации.
author: tdykstra
ms.author: riande
ms.date: 01/19/2019
ms.topic: tutorial
ms.assetid: 7ba88418-5d0a-437d-b6dc-7c3816d4ec07
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 4d5f6447fdccefdcdf9497a9e94f23243302a0e1
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78499302"
---
# <a name="tutorial-update-related-data-with-ef-in-an-aspnet-mvc-app"></a>Руководство. обновление связанных данных с помощью EF в приложении ASP.NET MVC

В предыдущем учебнике отображаются связанные данные. В этом учебнике вы обновите связанные данные. Для большинства связей это можно сделать, обновив поля внешнего ключа или свойства навигации. Для связей "многие ко многим" Entity Framework не предоставляет таблицу соединений напрямую, поэтому вы добавляете и удаляете сущности в соответствующих свойствах навигации.

На следующих рисунках изображены некоторые из страниц, с которыми вы будете работать.

![Course_create_page](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image1.png)

![Instructor_edit_page_with_courses](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image2.png)

![Изменение инструкторов с помощью курсов](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image3.png)

Изучив это руководство, вы:

> [!div class="checklist"]
> * Настройка страниц курсов
> * Страница добавления Office в инструкторы
> * Страница добавления курсов в инструкторы
> * Обновление Делетеконфирмед
> * Добавление расположения кабинета и курсов на страницу создания

## <a name="prerequisites"></a>предварительные требования

* [Чтение связанных данных](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="customize-courses-pages"></a>Настройка страниц курсов

Создаваемая сущность курса должна иметь связь с существующей кафедрой. Чтобы упростить эту задачу, шаблонный код включает методы контроллеров, а также представления "Create" (Создание) и "Edit" (Редактирование) с раскрывающимся списком для выбора кафедры. Раскрывающийся список задает `Course.DepartmentID` свойство внешнего ключа, и это все Entity Framework потребности для загрузки свойства навигации `Department` с соответствующей сущностью `Department`. Вы будете использовать этот шаблонный код, немного его изменив, чтобы добавить обработку ошибок и сортировку раскрывающегося списка.

В *CourseController.CS*удалите четыре метода `Create` и `Edit` и замените их следующим кодом:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.cs?highlight=3,11-12,19-25,40,44,46,48-78)]

Добавьте в начало файла следующую инструкцию `using`:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.cs)]

Метод `PopulateDepartmentsDropDownList` возвращает список всех отделов, отсортированных по имени, создает коллекцию `SelectList` для раскрывающегося списка и передает коллекцию в представление в свойстве `ViewBag`. Этот метод принимает необязательный параметр `selectedDepartment`, позволяющий вызывающему коду указать элемент, который будет выбран при отрисовке раскрывающегося списка. Представление передаст имя `DepartmentID` вспомогательному элементу [DropDownList](../../older-versions/working-with-the-dropdownlist-box-and-jquery/using-the-dropdownlist-helper-with-aspnet-mvc.md) , а вспомогательное приложение — искать в объекте `ViewBag` для `SelectList` с именем `DepartmentID`.

Метод `HttpGet` `Create` вызывает метод `PopulateDepartmentsDropDownList`, не устанавливая выбранный элемент, так как для нового курса этот отдел еще не установлен:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

Метод `HttpGet` `Edit` задает выбранный элемент на основе идентификатора отдела, который уже назначен для изменяемого курса.

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs?highlight=12)]

Методы `HttpPost` для `Create` и `Edit` также содержат код, который задает выбранный элемент при повторном отображении страницы после ошибки:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs?highlight=6)]

Этот код гарантирует, что при повторном отображении страницы для отображения сообщения об ошибке выбранный отдел останется выбранным.

Представления курсов уже обрабатываются с помощью раскрывающихся списков для поля "Отдел", но не требуется заголовку DepartmentID для этого поля, поэтому сделайте следующее выделенное изменение в файле *виевс\каурсе\креате.кштмл* , чтобы изменить заголовок.

[!code-cshtml[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cshtml?highlight=43)]

Внесите те же изменения в *виевс\каурсе\едит.кштмл*.

Как правило, механизм формирования шаблонов не формирует первичный ключ, поскольку значение ключа создается базой данных и не может быть изменено и не является значимым значением для отображения пользователям. Для сущностей Course шаблон включает текстовое поле для поля `CourseID`, поскольку оно понимает, что атрибут `DatabaseGeneratedOption.None` означает, что пользователь должен иметь возможность ввести значение первичного ключа. Но это не понимает, так как число является значимым для просмотра в других представлениях, поэтому его необходимо добавить вручную.

В *виевс\каурсе\едит.кштмл*добавьте поле номера курса перед полем **Title** . Так как это первичный ключ, он отображается, но его нельзя изменить.

[!code-cshtml[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cshtml)]

В представлении редактирования уже есть скрытое поле (`Html.HiddenFor` вспомогательное приложение) для номера курса. Добавление вспомогательного метода *HTML. лабелфор* не устраняет потребность в скрытом поле, так как не приводит к включению номера курса в отправленные данные, когда пользователь нажимает кнопку **сохранить** на странице Правка.

В *виевс\каурсе\делете.кштмл* и *виевс\каурсе\детаилс.кштмл*измените заголовок названия отдела с "имя" на "Отдел" и добавьте поле "номер курса" перед полем " **название** ".

[!code-cshtml[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cshtml?highlight=2,9-15)]

Запустите страницу **создать** (откройте страницу "Индекс курса" и щелкните **создать**) и введите данные для нового курса:

| Значение | Параметр |
| ----- | ------- |
| Number | Введите *1000*. |
| Title | Введите *в*этом случае. |
| Баллы | Введите *4*. |
|отдел; | Выберите **математика**. |

Нажмите кнопку **Создать**. Откроется страница индекс курса с новым курсом, добавленным в список. Название кафедры в списке страницы индекса поступает из свойства навигации, показывая, что связь установлена правильно.

Откройте страницу **редактирования** (откройте страницу "Индекс курса" и щелкните **изменить** в курсе).

Измените данные на странице и нажмите кнопку **Save** (Сохранить). Отобразится страница индекса курса с обновленными данными курса.

## <a name="add-office-to-instructors-page"></a>Страница добавления Office в инструкторы

При редактировании записи преподавателя может потребоваться обновить назначенный преподавателю кабинет. Сущность `Instructor` имеет связь "один к нулю" или "одна к одному" с сущностью `OfficeAssignment`, что означает, что необходимо выполнять следующие ситуации:

- Если пользователь очищает назначение Office и изначально имел значение, необходимо удалить и удалить сущность `OfficeAssignment`.
- Если пользователь вводит значение назначения Office и изначально был пустым, необходимо создать новую сущность `OfficeAssignment`.
- Если пользователь изменяет значение назначения Office, необходимо изменить значение в существующей сущности `OfficeAssignment`.

Откройте *InstructorController.CS* и взгляните на метод `HttpGet` `Edit`:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample9.cs)]

Шаблон кода здесь не нужен. Настраивает данные для раскрывающегося списка, но вам понадобится текстовое поле. Замените этот метод следующим кодом:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample10.cs?highlight=7-10)]

Этот код удаляет оператор `ViewBag` и добавляет безотлагательную загрузку для связанной сущности `OfficeAssignment`. Вы не можете выполнить безотлагательную загрузку с помощью метода `Find`, поэтому вместо выбора инструктора используются методы `Where` и `Single`.

Замените метод `HttpPost` `Edit` следующим кодом. который обрабатывает обновления назначений Office:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample11.cs)]

Для ссылки на `RetryLimitExceededException` требуется инструкция `using`. чтобы добавить его, наведите указатель мыши на `RetryLimitExceededException`. Появится следующее сообщение: ![ повторить попытку сообщения об исключении](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image13.png)

Выберите **Показывать возможные исправления**, а затем **с помощью System. Data. Entity. Infrastructure** .

![Устранить исключение повторных попыток](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image14.png)

Код делает следующее:

- Изменяет имя метода на `EditPost`, поскольку сигнатура теперь совпадает с методом `HttpGet` (атрибут `ActionName` указывает, что URL-адрес/едит/по-прежнему используется).
- Получает текущую сущность `Instructor` из базы данных, используя безотложную загрузку для свойства навигации `OfficeAssignment`. Это то же самое, что и в методе `HttpGet` `Edit`.
- Обновляет извлеченную сущность `Instructor`, используя значения из связывателя модели. Использование перегрузки [трюпдатемодел](https://msdn.microsoft.com/library/dd470908(v=vs.108).aspx) позволяет *список разрешений* свойства, которые необходимо включить. Это предотвращает избыточное размещение, как описано во [втором учебнике](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application.md).

    [!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample12.cs)]
- Если расположение офиса пусто, присваивает свойству `Instructor.OfficeAssignment` значение null, чтобы связанная строка в таблице `OfficeAssignment` была удалена.

    [!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample13.cs)]
- Сохраняет изменения в базу данных.

В *виевс\инструктор\едит.кштмл*после элементов `div` для поля **Дата найма** добавьте новое поле для редактирования расположения офиса:

[!code-cshtml[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample14.cshtml)]

Запустите страницу (выберите вкладку **инструкторы** и нажмите кнопку **изменить** на инструкторе). Измените значение **Office Location** (Расположение кабинета) и нажмите кнопку **Save** (Сохранить).

## <a name="add-courses-to-instructors-page"></a>Страница добавления курсов в инструкторы

Преподаватели могут вести любое число курсов. Теперь вы улучшите страницу редактирования инструкторов, добавив возможность изменения назначений курсов с помощью группы флажков.

Отношение между сущностями `Course` и `Instructor` является "многие ко многим". Это означает, что у вас нет прямого доступа к свойствам внешнего ключа, которые находятся в таблице соединение. Вместо этого можно добавлять и удалять сущности в свойстве навигации `Instructor.Courses`.

Пользовательский интерфейс, позволяющий изменить назначенные для преподавателя курсы, представляет собой группу флажков. Отображается флажок для каждого курса в базе данных, а флажки для курсов, назначенных данному преподавателю, установлены. Пользователь может устанавливать и снимать флажки, изменяя назначения курсов. Если количество курсов было гораздо больше, вы, вероятно, захотите использовать другой метод представления данных в представлении, но для создания или удаления связей следует использовать один и тот же метод управления свойствами навигации.

Чтобы предоставить данные в представлении для списка флажков, нужно использовать класс модели представления. Создайте *AssignedCourseData.CS* в папке *ViewModels* и замените имеющийся код следующим кодом:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample15.cs)]

В *InstructorController.CS*замените метод `HttpGet` `Edit` следующим кодом. Изменения выделены.

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample16.cs?highlight=9,12,20-35)]

Код добавляет безотложную загрузку для свойства навигации `Courses` и вызывает новый метод `PopulateAssignedCourseData` для предоставления сведений массиву флажков с помощью класса модели представления `AssignedCourseData`.

Код в методе `PopulateAssignedCourseData` считывает все `Course` сущности, чтобы загрузить список курсов с помощью класса модели представления. Для каждого курса код проверяет, существует ли этот курс в свойстве навигации `Courses` преподавателя. Чтобы создать эффективный поиск при проверке того, назначен ли курс инструктору, курсы, назначенные преподавателю, помещаются в коллекцию наборов [хэширования](https://msdn.microsoft.com/library/bb359438.aspx) . Для курсов, назначенных преподавателем, свойству `Assigned` присвоено значение `true`. Представление будет использовать это свойство, чтобы определить, какие флажки нужно отображать как выбранные. Наконец, список передается в представление в свойстве `ViewBag`.

Добавьте код, выполняемый, когда пользователь нажимает кнопку **Save** (Сохранить). Замените метод `EditPost` следующим кодом, который вызывает новый метод, который обновляет свойство навигации `Courses` сущности `Instructor`. Изменения выделены.

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample17.cs?highlight=3,11,25,37,40-68)]

Сигнатура метода теперь отличается от метода `HttpGet` `Edit`, поэтому имя метода меняется с `EditPost` обратно на `Edit`.

Так как представление не содержит коллекцию сущностей `Course`, связыватель модели не может автоматически обновить свойство навигации `Courses`. Вместо того чтобы использовать связыватель модели для обновления свойства навигации `Courses`, это можно сделать в новом методе `UpdateInstructorCourses`. Поэтому нужно исключить свойство `Courses` из привязки модели. Это не требует внесения каких-либо изменений в код, вызывающий [трюпдатемодел](https://msdn.microsoft.com/library/dd470908(v=vs.98).aspx) , так как используется перегрузка *список разрешений* , а `Courses` нет в списке включения.

Если флажки не выбраны, код в `UpdateInstructorCourses` инициализирует `Courses` свойство навигации пустой коллекцией:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample18.cs)]

После этого код в цикле проходит по всем курсам в базе данных и сравнивает каждый из них с теми, которые сейчас назначены преподавателю, в противоположность тем, которые были выбраны в представлении. Чтобы упростить эффективную подстановку, последние две коллекции хранятся в объектах `HashSet`.

Если флажок для курса был установлен, но курс отсутствует в свойстве навигации `Instructor.Courses`, этот курс добавляется в коллекцию в свойстве навигации.

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample19.cs)]

Если флажок для курса не был установлен, но курс присутствует в свойстве навигации `Instructor.Courses`, этот курс удаляется из свойства навигации.

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample20.cs)]

В *виевс\инструктор\едит.кштмл*добавьте поле **Courses** с массивом флажков, добавив следующий код сразу после элементов `div` для поля `OfficeAssignment` и перед элементом `div` для кнопки **сохранить** :

[!code-cshtml[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample21.cshtml)]

После вставки кода, если разрывы строк и отступы не выглядят так, как показано здесь, вручную исправьте все, чтобы оно выглядело так, как вы видите здесь. Выравнивать отступы необязательно, однако строки `@</tr><tr>`, `@:<td>`, `@:</td>` и `@</tr>` должны находиться на одной строке, как показано здесь. В противном случае возникает ошибка времени выполнения.

Этот код создает таблицу HTML с тремя столбцами. Каждый столбец содержит флажок, за которым идет заголовок с номером и названием курса. Все флажки имеют одно и то же имя ("selectedCourses"), которое информирует связыватель модели о том, что они должны рассматриваться как группа. Для атрибута `value` каждого флажка задано значение `CourseID.` при публикации страницы, связыватель модели передает массив контроллеру, который состоит из `CourseID` значений только выбранных флажков.

При первоначальном отображении флажков, которые предназначены для курсов, назначенных преподавателю, имеют `checked` атрибуты, которые выбирают их (отображает отмеченные).

После изменения назначений курсов необходимо проверить изменения при возврате сайта на страницу `Index`. Поэтому необходимо добавить столбец в таблицу на этой странице. В этом случае вам не нужно использовать объект `ViewBag`, так как отображаемая информация уже находится в свойстве навигации `Courses` сущности `Instructor`, которую вы передаете на страницу в качестве модели.

В *виевс\инструктор\индекс.кштмл*добавьте заголовок **курсов** сразу после заголовка **Office** , как показано в следующем примере:

[!code-cshtml[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample22.cshtml?highlight=6)]

Затем добавьте новую ячейку сведений сразу после ячейки сведений о местонахождении Office:

[!code-cshtml[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample23.cshtml?highlight=7-14)]

Чтобы просмотреть курсы, назначенные каждому инструктору, выполните страницу " **индекс инструктора** ".

Щелкните **изменить** на лекторе, чтобы открыть страницу изменение.

Измените некоторые назначения курсов и нажмите кнопку **сохранить**. Вносимые вами изменения отражаются на странице индекса.

 Примечание. подход, сделанный здесь для изменения данных курса преподавателя, хорошо работает при наличии ограниченного числа курсов. Для коллекций большего размера следовало бы применять другой пользовательский интерфейс и другой метод обновления.

## <a name="update-deleteconfirmed"></a>Обновление Делетеконфирмед

В *InstructorController.CS*удалите метод `DeleteConfirmed` и вставьте следующий код на его место.

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample24.cs?highlight=5-8,12-18)]

Этот код вносит следующие изменения:

- Если лектор назначен в качестве администратора любого отдела, удаляет назначение преподавателя из этого отдела. Без этого кода вы получите ошибку ссылочной целостности при попытке удалить лектора, который был назначен в качестве администратора отдела.

Этот код не обрабатывает сценарий одного преподавателя, назначенного в качестве администратора для нескольких отделов. В последнем учебном курсе вы добавите код, который предотвращает выполнение этого сценария.

## <a name="add-office-location-and-courses-to-the-create-page"></a>Добавление расположения кабинета и курсов на страницу создания

В *InstructorController.CS*удалите методы `HttpGet` и `HttpPost` `Create`, а затем добавьте следующий код в их место:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample25.cs)]

Этот код аналогичен тому, который вы видели для методов редактирования, за исключением того, что изначально не выбраны курсы. Метод `HttpGet` `Create` вызывает метод `PopulateAssignedCourseData`, не так как в нем могут быть выбраны курсы, но чтобы предоставить пустую коллекцию для цикла `foreach` в представлении (в противном случае код представления выдаст исключение null reference).

Метод Create HttpPost добавляет каждый выбранный курс в свойство навигации по курсам перед кодом шаблона, который проверяет наличие ошибок проверки и добавляет новый лектор в базу данных. Курсы добавляются, даже если существуют ошибки модели, поэтому при возникновении ошибок модели (например, пользователь с ключом "Недопустимая дата"), поэтому при повторном отображении страницы с сообщением об ошибке все выбранные параметры курса восстанавливаются автоматически.

Обратите внимание, что для добавления курсов в свойство навигации `Courses` нужно инициализировать это свойство как пустую коллекцию:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample26.cs)]

Это можно сделать не только в коде контроллера, но и в модели Instructor, изменив метод получения свойств для автоматического создания коллекции, если она не существует, как показано в следующем примере:

[!code-csharp[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample27.cs)]

При подобном изменении свойства `Courses` можно удалить код явной инициализации свойства в контроллере.

В *виевс\инструктор\креате.кштмл*добавьте текстовое поле "Расположение офиса" и флажок "курс" после поля "Дата найма" и перед кнопкой " **Отправить** ".

[!code-cshtml[Main](updating-related-data-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample28.cshtml)]

После вставки кода исправьте разрывы строк и отступы, как это было сделано ранее на странице Редактирование.

Запустите страницу Создание и добавьте инструктор.

<a id="transactions"></a>

## <a name="handling-transactions"></a>Обработка транзакций

Как описано в [руководстве по работе с базовыми ФУНКЦИЯМИ CRUD](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application.md), по умолчанию Entity Framework неявно реализует транзакции. Для сценариев, в которых требуется больший контроль, например, если вы хотите включить операции, выполняемые вне Entity Framework в транзакции, см. статью [Работа с транзакциями](https://msdn.microsoft.com/data/dn456843) в MSDN.

## <a name="get-the-code"></a>Получение кода

[Скачать завершенный проект](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a>Дополнительные ресурсы

Ссылки на другие ресурсы Entity Framework можно найти в [материалах, рекомендуемых для доступа к данным ASP.NET](../../../../whitepapers/aspnet-data-access-content-map.md).

## <a name="next-step"></a>Следующий шаг

Изучив это руководство, вы:

> [!div class="checklist"]
> * Страницы настроенных курсов
> * Страница добавления Office в инструкторы
> * Добавлены курсы на страницу инструкторов
> * Обновленный Делетеконфирмед
> * Добавление расположения и курсов Office на страницу создания

Перейдите к следующей статье, чтобы узнать, как реализовать асинхронную модель программирования.
> [!div class="nextstepaction"]
> [Асинхронная модель программирования](async-and-stored-procedures-with-the-entity-framework-in-an-asp-net-mvc-application.md)
