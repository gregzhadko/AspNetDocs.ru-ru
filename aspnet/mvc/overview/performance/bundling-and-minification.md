---
uid: mvc/overview/performance/bundling-and-minification
title: Объединение и минификации | Документация Майкрософт
author: Rick-Anderson
description: Объединение и минификации — это два метода, которые можно использовать в ASP.NET 4,5 для повышения времени загрузки запросов. Объединение и минификации улучшает время загрузки по редуЦин...
ms.author: riande
ms.date: 08/23/2012
ms.assetid: 5894dc13-5d45-4dad-8096-136499120f1d
msc.legacyurl: /mvc/overview/performance/bundling-and-minification
msc.type: authoredcontent
ms.openlocfilehash: 61bfe5dbac04b57e1461183b66ead2f01fe0734c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78432954"
---
# <a name="bundling-and-minification"></a>Объединение и минификация

по [Рик Андерсон (](https://twitter.com/RickAndMSFT)

> Объединение и минификации — это два метода, которые можно использовать в ASP.NET 4,5 для повышения времени загрузки запросов. Объединение и минификации увеличивает время загрузки, уменьшая количество запросов к серверу и уменьшая размер запрошенных ресурсов (например, CSS и JavaScript).

Большинство текущих основных браузеров ограничивают число [одновременных подключений](http://www.browserscope.org/?category=network) на каждое имя узла до шести. Это означает, что пока обрабатывается шесть запросов, дополнительные запросы ресурсов на узле помещаются в очередь браузера. На приведенном ниже рисунке вкладки сети средств разработчика F12 в IE показывают время для ресурсов, необходимых для представления примера приложения.

![Б/М](bundling-and-minification/_static/image1.png)

Серые полосы показывают время, в течение которого запрос находится в очереди браузером, ожидающим шесть ограничений на подключение. Желтая полоса — это время запроса к первому байту, то есть время, затраченное на отправку запроса и получение первого ответа от сервера. Синие полосы показывают время, затраченное на получение данных ответа с сервера. Вы можете дважды щелкнуть ресурс, чтобы получить подробные сведения о времени. Например, на следующем рисунке показаны сведения о времени загрузки файла */Scripts/MyScripts/JavaScript6.js* .

![](bundling-and-minification/_static/image2.png)

На предыдущем рисунке показано событие **запуска** , которое дает время, в течение которого запрос был поставлен в очередь из-за ограничения числа одновременных подключений в браузере. В этом случае запрос был поставлен в очередь на 46 миллисекунд ожидания завершения другого запроса.

## <a name="bundling"></a>Объединения

Объединение — это новая функция в ASP.NET 4,5, которая упрощает объединение нескольких файлов в один файл. Можно создать CSS, JavaScript и другие пакеты. Меньшее число файлов означает меньшее количество HTTP-запросов и может повысить производительность первой загрузки страницы.

На следующем рисунке показано одно и то же представление времени для представления About, показанное ранее, но на этот раз с помощью объединения и минификации.

![](bundling-and-minification/_static/image3.png)

## <a name="minification"></a>Минификации

Минификации выполняет различные оптимизации кода для сценариев или CSS, таких как удаление ненужных пробелов и комментариев, а также сокращение имен переменных до одного символа. Рассмотрим следующую функцию JavaScript.

[!code-javascript[Main](bundling-and-minification/samples/sample1.js)]

После минификации функция уменьшается до следующего:

[!code-javascript[Main](bundling-and-minification/samples/sample2.js)]

Помимо удаления комментариев и ненужных пробелов, следующие параметры и имена переменных были переименованы (сокращены) следующим образом:

| **Original** | **Название** |
| --- | --- |
| imageTagAndImageID | n |
| imageContext | t |
| имажеелемент | i |

## <a name="impact-of-bundling-and-minification"></a>Влияние объединения и минификации

В следующей таблице приведены некоторые важные различия между выводом списка всех активов по отдельности и использованием объединения и минификации (B/M) в образце программы.

|  | **Использование B/M** | **Без B/M** | **Изменение** |
| --- | --- | --- | --- |
| **Запросы файлов** | 9 | 34 | 256% |
| **Отправлено КБ** | 3.26 | 11.92 | 266% |
| **Получено КБ** | 388.51 | 530 | 36% |
| **Время загрузки** | 510 МС | 780 МС | 53% |

Отправленные байты были значительно сокращены с объединением, так как браузеры довольно подробно используют заголовки HTTP, которые они применяют к запросам. Сокращение полученных байтов не так велико, так как самые большие файлы (*скрипты\\жкуери-УИ-1.8.11. min. js* и *Scripts\\жкуери-1.7.1. min. js*) уже являются минифицированные. Примечание. временные показатели в образце программы использовали средство [Fiddler](http://www.fiddler2.com/fiddler2/) для имитации скорости сети. (В меню **правила** Fiddler выберите **производительность** , а затем — **Эмуляция скорости модема**.)

## <a name="debugging-bundled-and-minified-javascript"></a>Отладка пакетов и Минифицированные JavaScript

Отладку JavaScript можно выполнить в среде разработки (где [элементу компиляции](https://msdn.microsoft.com/library/s10awwz0.aspx) в файле *Web. config* присваивается значение `debug="true"`), так как файлы JavaScript не упакованы или не минифицированные. Также можно выполнить отладку сборки выпуска, в которой файлы JavaScript объединены в пакеты и минифицированные. Используя средства разработчика F12 для IE, вы отлаживать функцию JavaScript, включенную в пакет минифицированные, с помощью следующего подхода:

1. Перейдите на вкладку **Скрипт** , а затем нажмите кнопку **начать отладку** .
2. Выберите набор, содержащий функцию JavaScript, которую необходимо отладить, с помощью кнопки активы.  
    ![](bundling-and-minification/_static/image4.png)
3. Отформатируйте минифицированные JavaScript, нажав **кнопку конфигурация** ![](bundling-and-minification/_static/image5.png)и выбрав **Формат JavaScript**.
4. В поле Ввод **скрипта поиска** выберите имя функции, которую требуется отладить. На следующем рисунке **аддалттоимг** был введен в поле ввода **скрипта поиска** .  
    ![](bundling-and-minification/_static/image6.png)

Дополнительные сведения об отладке с помощью средств разработчика F12 см. в статье MSDN [использование средства для разработчиков F12 для отладки ошибок JavaScript](https://msdn.microsoft.com/library/ie/gg699336(v=vs.85).aspx).

## <a name="controlling-bundling-and-minification"></a>Управление объединением и минификации

Объединение и минификации включаются или отключаются путем установки значения атрибута Debug в [элементе compilation](https://msdn.microsoft.com/library/s10awwz0.aspx) в файле *Web. config* . В следующем XML `debug` имеет значение true, поэтому объединение и минификации отключено.

[!code-xml[Main](bundling-and-minification/samples/sample3.xml?highlight=2)]

Чтобы включить объединение и минификации, задайте для `debug` значение false. Параметр *Web. config* можно переопределить с помощью свойства `EnableOptimizations` в классе `BundleTable`. Следующий код включает объединение и минификации и переопределяет любой параметр в файле *Web. config* .

[!code-csharp[Main](bundling-and-minification/samples/sample4.cs?highlight=7)]

> [!NOTE]
> Если `EnableOptimizations` не `true` или атрибут Debug в [элементе compilation](https://msdn.microsoft.com/library/s10awwz0.aspx) в файле *Web. config* имеет значение `false`, файлы не будут объединены или минифицированные. Кроме того, не будет использоваться минимальная версия файлов, будут выбраны полные отладочные версии. `EnableOptimizations` переопределяет атрибут Debug в [элементе compilation](https://msdn.microsoft.com/library/s10awwz0.aspx) файла *Web. config*

## <a name="using-bundling-and-minification-with-aspnet-web-forms-and-web-pages"></a>Использование объединения и минификации с веб-формами ASP.NET и веб-страницами

- Для веб-страниц см. запись блога [Добавление веб-оптимизации на сайт веб-страниц](https://docs.microsoft.com/archive/blogs/rickandy/adding-web-optimization-to-a-web-pages-site).
- Сведения о веб-формах см. в записи блога [Добавление объединения и минификации в веб-формы](https://docs.microsoft.com/archive/blogs/rickandy/adding-bundling-and-minification-to-web-forms).

## <a name="using-bundling-and-minification-with-aspnet-mvc"></a>Использование объединения и минификации с ASP.NET MVC

В этом разделе мы создадим проект ASP.NET MVC для изучения объединения и минификации. Сначала создайте новый Интернет-проект ASP.NET MVC с именем **мвкбм** , не изменяя значения по умолчанию.

Откройте *\\приложения \_запустите\\файл BundleConfig.CS* и изучите метод `RegisterBundles`, который используется для создания, регистрации и настройки пакетов. В следующем коде показана часть метода `RegisterBundles`.

[!code-csharp[Main](bundling-and-minification/samples/sample5.cs)]

Приведенный выше код создает новый пакет JavaScript с именем *~/бундлес/жкуери* , который включает все подходящие (то есть Debug или минифицированные, но не. *всдок*) файлы в папке *Scripts* , соответствующие подстановочной строке "~/скриптс/жкуери-{версион}.ЖС". Для ASP.NET MVC 4 это означает с отладочной конфигурацией, файл *жкуери-1.7.1. js* будет добавлен в пакет. В конфигурации выпуска будет добавлен *жкуери-1.7.1. min. js* . Платформа объединения использует несколько общих соглашений, таких как:

- При наличии *филекс. min. js* и *филекс. js* выбирается файл ". min" для выпуска.
- Выбор версии, отличной от ". min", для отладки.
- Пропуск файлов "-всдок" (например, *жкуери-1.7.1-всдок. js*), которые используются только технологией IntelliSense.

Подстановочные знаки `{version}`, показанные выше, используются для автоматического создания пакета jQuery с соответствующей версией jQuery в папке *Scripts* . В этом примере использование подстановочных знаков предоставляет следующие преимущества:

- Позволяет использовать NuGet для обновления до более новой версии jQuery, не изменяя предыдущий код объединения или ссылки jQuery на страницах представления.
- Автоматически выбирает полную версию для конфигураций отладки и версию ". min" для сборок выпуска.

## <a name="using-a-cdn"></a>Использование CDN

 Следующий код заменяет локальный пакет jQuery на пакет CDN jQuery.

[!code-csharp[Main](bundling-and-minification/samples/sample6.cs)]

В приведенном выше коде jQuery будет запрашиваться из CDN в режиме выпуска, а отладочная версия jQuery будет выбрана локально в режиме отладки. При использовании CDN необходимо использовать резервный механизм в случае сбоя запроса CDN. Следующий фрагмент разметки из конца файла макета показывает скрипт, добавленный в запрос jQuery, в случае сбоя CDN.

[!code-cshtml[Main](bundling-and-minification/samples/sample7.cshtml?highlight=5-13)]

## <a name="creating-a-bundle"></a>Создание пакета

Класс [пакета](https://msdn.microsoft.com/library/system.web.optimization.bundle(v=VS.110).aspx) `Include` метод принимает массив строк, где каждая строка является виртуальным путем к ресурсу. В следующем коде из метода `RegisterBundles` в *приложении\\\_Start\\файл BundleConfig.CS* показано, как добавить несколько файлов в пакет:

[!code-csharp[Main](bundling-and-minification/samples/sample8.cs)]

Для добавления всех файлов в каталоге (и при необходимости всех подкаталогов), соответствующих шаблону поиска, предоставляется метод `IncludeDirectory` класса [пакета](https://msdn.microsoft.com/library/system.web.optimization.bundle(v=VS.110).aspx) . Класс [пакета](https://msdn.microsoft.com/library/system.web.optimization.bundle(v=VS.110).aspx) `IncludeDirectory` API показан ниже:

[!code-csharp[Main](bundling-and-minification/samples/sample9.cs)]

В представлениях, использующих метод Render (`Styles.Render` для CSS и `Scripts.Render` для JavaScript), используются ссылки на пакеты. Следующая разметка из файла *views\\shared\\\_Layout. cshtml* показывает, как представления Интернет по умолчанию ASP.NET Internet Project ссылаются на пакеты CSS и JavaScript.

[!code-cshtml[Main](bundling-and-minification/samples/sample10.cshtml?highlight=5-6,11)]

Обратите внимание, что методы рендеринга принимают массив строк, поэтому можно добавить несколько пакетов в одной строке кода. Как правило, необходимо использовать методы рендеринга, которые создают необходимый HTML-код для ссылки на ресурс. Можно использовать метод `Url`, чтобы создать URL-адрес ресурса без разметки, необходимой для ссылки на ресурс. Предположим, что вы хотите использовать новый [асинхронный](http://www.whatwg.org/specs/web-apps/current-work/#attr-script-async) атрибут HTML5. В следующем коде показано, как сослаться на Modernizr с помощью метода `Url`.

[!code-cshtml[Main](bundling-and-minification/samples/sample11.cshtml?highlight=11)]

## <a name="using-the--wildcard-character-to-select-files"></a>Использование подстановочного знака "\*" для выбора файлов

Виртуальный путь, указанный в методе `Include` и шаблоне поиска в методе `IncludeDirectory`, может принимать один символ-шаблон "\*" в качестве префикса или суффикса в последнем сегменте пути. В строке поиска учитывается регистр. Метод `IncludeDirectory` позволяет выполнять поиск в подкаталогах.

Рассмотрим проект со следующими файлами JavaScript:

- *Сценарии\\Common\\Аддалттоимг. js*
- *Сценарии\\Common\\Тоггледив. js*
- *Сценарии\\Common\\Тогглеимг. js*
- *Сценарии\\Common\\Sub1\\Тогглелинкс. js*

![dir ин](bundling-and-minification/_static/image7.png)

В следующей таблице приведены файлы, добавленные в пакет с помощью подстановочного знака, как показано ниже.

| **Call** | **Добавлено файлов или вызвано исключение** |
| --- | --- |
| Include ("~/Скриптс/Коммон/\*. js") | *Аддалттоимг. js*, *тоггледив. js*, *тогглеимг. js* |
| Include ("~/Скриптс/Коммон/т\*. js") | Недопустимое исключение шаблона. Подстановочный знак допускается только для префикса или суффикса. |
| Include ("~/Скриптс/Коммон/\*OG.\*") | Недопустимое исключение шаблона. Допускается только один подстановочный знак. |
| Include ("~/Скриптс/Коммон/т\*") | *Тоггледив. js*, *тогглеимг. js* |
| Include ("~/Скриптс/Коммон/\*") | Недопустимое исключение шаблона. Недопустимый сегмент нестрогого шаблона. |
| Инклудедиректори ("~/Скриптс/Коммон", "T\*") | *Тоггледив. js*, *тогглеимг. js* |
| Инклудедиректори ("~/Скриптс/Коммон", "T\*", true) | *Тоггледив. js*, *тогглеимг. js*, *тогглелинкс. js* |

Явное добавление каждого файла в пакет, как правило, является предпочтительным по сравнению с загрузкой файлов по шаблону по следующим причинам.

- Добавление скриптов по умолчанию для их загрузки в алфавитном порядке, которое обычно не требуется. Файлы CSS и JavaScript часто приходится добавлять в конкретный (не алфавитный) порядок. Вы можете уменьшить этот риск, добавив пользовательскую реализацию [ибундлеордерер](https://msdn.microsoft.com/library/system.web.optimization.ibundleorderer(VS.110).aspx) , но явно добавлять каждый файл с ошибками менее вероятно. Например, вы можете добавить новые ресурсы в папку в будущем, что может потребовать изменения реализации [ибундлеордерер](https://msdn.microsoft.com/library/system.web.optimization.ibundleorderer(VS.110).aspx) .
- Просмотр конкретных файлов, добавленных в каталог с использованием подстановочных знаков, может включаться во все представления, ссылающиеся на этот пакет. Если скрипт для представления добавляется в пакет, может возникнуть ошибка JavaScript для других представлений, ссылающихся на пакет.
- Файлы CSS, которые импортируют другие файлы, приводят к тому, что импортированные файлы дважды загружаются. Например, следующий код создает пакет с большинством файлов CSS темы пользовательского интерфейса jQuery, загруженных дважды. 

    [!code-csharp[Main](bundling-and-minification/samples/sample12.cs)]

  Селектор подстановочного знака "\*. CSS" помещает в каждый файл CSS в папке, включая *содержимое\\темы\\базовому файлу\\jQuery. UI. ALL. CSS* . Файл *jQuery. UI. ALL. CSS* импортирует другие файлы CSS.

## <a name="bundle-caching"></a>Кэширование пакета

Пакеты задают заголовок HTTP Expires по истечении одного года из при создании пакета. При переходе к ранее просмотренной странице Fiddler показывает, что IE не выполняет условный запрос для пакета, то есть нет HTTP-запросов GET из IE для пакетов и ответов HTTP 304 с сервера. Можно принудительно настроить в IE условный запрос для каждого пакета с помощью клавиши F5 (в результате чего HTTP-ответ 304 для каждого пакета). Можно принудительно выполнить полное обновление с помощью команды ^ F5 (в результате чего HTTP 200 отклика для каждого пакета).

На следующем рисунке показана вкладка **кэширование** панели отклика Fiddler:

![изображение кэширования Fiddler](bundling-and-minification/_static/image8.png)

Запрос   
`http://localhost/MvcBM_time/bundles/AllMyScripts?v=r0sLDicvP58AIXN_mc3QdyVvVj5euZNzdsa2N1PKvb81`  
 предназначен для пакета **аллмискриптс** и содержит пару строк запроса **v = R0sLDicvP58AIXN\\\_mc3QdyVvVj5euZNzdsa2N1PKvb81**. Строка запроса **v** имеет маркер значения, который является уникальным идентификатором, используемым для кэширования. Пока пакет не изменится, приложение ASP.NET запросит пакет **аллмискриптс** с помощью этого маркера. Если какой-либо файл в пакете изменится, платформа оптимизации ASP.NET создаст новый маркер, гарантируя, что запросы в браузере для пакета будут получать последнюю версию пакета.

При запуске средств разработчика IE9 F12 и переходе к ранее загруженной странице IE неправильно отображает условные запросы GET для каждого пакета и сервер, возвращающий HTTP 304. Вы можете прочитать, почему у IE9 есть проблемы с определением условного запроса в записи блога [с помощью CDN и истечения срока действия для улучшения производительности веб-сайта](https://blogs.msdn.com/b/rickandy/archive/2011/05/21/using-cdns-to-improve-web-site-performance.aspx).

## <a name="less-coffeescript-scss-sass-bundling"></a>"Меньше, CoffeeScript, SCSS," — объединение "Sasser".

Платформа для объединения и минификации предоставляет механизм для обработки промежуточных языков, таких как [SCSS](http://sass-lang.com/), [Sasser](http://sass-lang.com/), [less](http://www.dotlesscss.org/) или [CoffeeScript](http://coffeescript.org/), и применения преобразований, таких как минификации, к результирующему набору. Например, чтобы добавить файлы [. less](http://www.dotlesscss.org/) в проект MVC 4:

1. Создайте папку для содержимого меньшего объема. В следующем примере используется папка *Content\\милесс* .
2. Добавьте в проект неограниченный пакет NuGet [без](http://www.dotlesscss.org/) **точки** .  
    ![установки NuGet](bundling-and-minification/_static/image9.png)
3. Добавьте класс, реализующий интерфейс [ибундлетрансформ](https://msdn.microsoft.com/library/system.web.optimization.ibundletransform(VS.110).aspx) . Для преобразования. less добавьте в проект следующий код.

    [!code-csharp[Main](bundling-and-minification/samples/sample13.cs)]
4. Создайте пакет из МЕНЬШЕго числа файлов с помощью `LessTransform` и преобразования [кссминифи](https://msdn.microsoft.com/library/system.web.optimization.cssminify(VS.110).aspx) . Добавьте следующий код в метод `RegisterBundles` в файле *App\\_Start\\BundleConfig.CS* .

    [!code-csharp[Main](bundling-and-minification/samples/sample14.cs)]
5. Добавьте следующий код в все представления, которые ссылаются на пакет меньшего объема.

    [!code-cshtml[Main](bundling-and-minification/samples/sample15.cshtml)]

## <a name="bundle-considerations"></a>Рекомендации по пакетам

Хорошим соглашением при создании пакетов является включение "пакета" в качестве префикса в имя пакета. Это предотвратит возможный [конфликт маршрутизации](https://forums.asp.net/post/5012037.aspx).

После обновления одного файла в пакете создается новый маркер для параметра строки запроса пакета, и при следующем запросе к странице, содержащей пакет, необходимо скачать полный пакет. В традиционной разметке, где каждый ресурс указан отдельно, будет загружен только измененный файл. Активы, которые часто меняются, могут быть нехорошими кандидатами для объединения.

Объединение и минификации в первую очередь повышает время загрузки первого запроса страницы. После запроса веб-страницы браузер кэширует ресурсы (JavaScript, CSS и изображения), поэтому объединение и минификации не обеспечивает никакого увеличения производительности при запросе той же страницы или страниц на том же сайте, запрашивающих одни и те же ресурсы. Если вы не настроили заголовок срока действия в своих активах и не используете объединение и минификации, эвристика обновления браузеров пометит ресурсы как устаревшие через несколько дней, и браузер потребует запрос на проверку для каждого ресурса. В этом случае объединение и минификации обеспечивают увеличение производительности после первого запроса страницы. Дополнительные сведения см. в блоге [с использованием CDN и истечении срока действия для улучшения производительности веб-сайта](https://blogs.msdn.com/b/rickandy/archive/2011/05/21/using-cdns-to-improve-web-site-performance.aspx).

Ограничение в браузерах для шести одновременных подключений на каждое имя узла можно уменьшить с помощью [CDN](https://blogs.msdn.com/b/rickandy/archive/2011/05/21/using-cdns-to-improve-web-site-performance.aspx). Так как CDN будет иметь имя узла, отличное от узла размещения, запросы активов из сети CDN не будут учитываться в течение шести одновременных подключений к среде размещения. CDN также может обеспечить общее кэширование пакета и преимущества пограничных кэширования.

Пакеты должны быть секционированы по страницам, которым они необходимы. Например, шаблон ASP.NET MVC по умолчанию для Интернет-приложения создает набор проверки jQuery отдельно от jQuery. Так как созданные представления по умолчанию не имеют входных данных и не имеют значений, они не включают в себя набор проверки.

Пространство имен `System.Web.Optimization` реализовано в *System. Web. Optimization. dll*. Она использует библиотеку "минификации *" ("* *Antlr3. Runtime. dll*") для возможностей, которые в свою очередь используют.

*Я использую Twitter, чтобы быстро отправлять сообщения и обмениваться ссылками. Мой обработчик Twitter*: [@RickAndMSFT](http://twitter.com/RickAndMSFT)

## <a name="additional-resources"></a>Дополнительные ресурсы

- Видео.[объединение и оптимизация](https://channel9.msdn.com/Events/aspConf/aspConf/Bundling-and-Optimizing) с помощью [Говард Дайеркинг](https://twitter.com/#!/howard_dierking)
- [Добавление веб-оптимизации на сайт веб-страниц](https://blogs.msdn.com/b/rickandy/archive/2012/08/15/adding-web-optimization-to-a-web-pages-site.aspx).
- [Добавление в веб-формы объединения и минификации](https://blogs.msdn.com/b/rickandy/archive/2012/08/14/adding-bundling-and-minification-to-web-forms.aspx).
- [Влияние на производительность объединения и минификации при просмотре веб-страниц](https://blogs.msdn.com/b/henrikn/archive/2012/06/17/performance-implications-of-bundling-and-minification-on-http.aspx) с помощью [хенрик F Nielsen](http://en.wikipedia.org/wiki/Henrik_Frystyk_Nielsen) [@frystyk](https://twitter.com/frystyk)
- [Использование CDN и истечения срока действия для повышения производительности веб-сайта](https://blogs.msdn.com/b/rickandy/archive/2011/05/21/using-cdns-to-improve-web-site-performance.aspx) на основе рик Андерсон ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)
- [Уменьшение времени приема-передачи (время кругового пути)](https://developers.google.com/speed/docs/best-practices/rtt)

## <a name="contributors"></a>участники;

- Хао кунг
- [Говард Дайеркинг](https://twitter.com/#!/howard_dierking)
- (Diana Лароуз
