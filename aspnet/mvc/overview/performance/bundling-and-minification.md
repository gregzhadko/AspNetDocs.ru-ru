---
uid: mvc/overview/performance/bundling-and-minification
title: Объединение и Минификация | Документация Майкрософт
author: Rick-Anderson
description: Объединение и Минификация существуют два следующих способа можно использовать в ASP.NET 4.5 для улучшения времени загрузки запроса. Объединение и Минификация повышает время загрузки, reducin...
ms.author: riande
ms.date: 08/23/2012
ms.assetid: 5894dc13-5d45-4dad-8096-136499120f1d
msc.legacyurl: /mvc/overview/performance/bundling-and-minification
msc.type: authoredcontent
ms.openlocfilehash: 79d6b38c6464a749db9cd6d35e1f277b0adf2a02
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65129423"
---
# <a name="bundling-and-minification"></a>Объединение и минификация

по [Рик Андерсон]((https://twitter.com/RickAndMSFT))

> Объединение и Минификация существуют два следующих способа можно использовать в ASP.NET 4.5 для улучшения времени загрузки запроса. Объединение и Минификация повышает время загрузки, уменьшая количество запросов к серверу и уменьшения размера запрошенных ресурсов (например, CSS и JavaScript.)

Большая часть текущего поддерживаются основные браузеры ограничить число [одновременных подключений](http://www.browserscope.org/?category=network) для каждого имени узла до шести. Это означает, что при обработке шесть запросов, дополнительные запросы на получение ресурсов на узле будут помещаться в очередь с помощью браузера. В приведенном ниже рисунке вкладки сети средства разработчика IE F12 схеме также показано время для активы, необходимые представления About примера приложения.

![B В МИНУТУ](bundling-and-minification/_static/image1.png)

Серые линии, расположенные отобразить время, запрос помещается в очередь с помощью браузера, Ожидание лимит шесть подключений. Желтая полоска — это время запроса до получения первого байта, то есть время, необходимое для отправки запроса и получения первого ответа от сервера. Синие полосы представляют время, необходимое для получения данных ответа от сервера. Вы можете дважды щелкнуть ресурс, чтобы получить подробные сведения о времени. Например, на следующем рисунке показана времени исполнения для загрузки */Scripts/MyScripts/JavaScript6.js* файла.

![](bundling-and-minification/_static/image2.png)

На предыдущем рисунке показана **запуск** событие, которое содержит время запроса в очередь из-за браузер ограничить число одновременных подключений. В этом случае запрос был поставлен в очередь 46 миллисекунд ожидания завершения другого запроса.

## <a name="bundling"></a>Объединение

Объединение — это новая функция в ASP.NET 4.5, который упрощает процесс соединить или объединить несколько файлов в один файл. Можно создать CSS, JavaScript и другие пакеты. Меньшее количество файлов означает, что меньшее количество HTTP-запросов и что может повысить производительность загрузки первой страницы.

Ниже приведен одинаковое представление о времени представлению About, показанный ранее, но на этот раз с помощью объединения и минификации включена.

![](bundling-and-minification/_static/image3.png)

## <a name="minification"></a>Минификация

Минификация выполняет различные оптимизации кода различных сценариев или css, например, удаляя ненужные пробелы и комментарии и сокращать имена переменных в один символ. Рассмотрим следующую функцию JavaScript.

[!code-javascript[Main](bundling-and-minification/samples/sample1.js)]

После минификации функция уменьшается до следующее:

[!code-javascript[Main](bundling-and-minification/samples/sample2.js)]

Помимо удаления комментариев и ненужные пробелы, следующие параметры и имена переменных были переименованы (сокращено) следующим образом:

| **Исходный текст** | **Переименован** |
| --- | --- |
| imageTagAndImageID | n |
| imageContext | t |
| imageElement | i |

## <a name="impact-of-bundling-and-minification"></a>Влияние объединение и Минификация

Ниже приведены несколько важных различий между все ресурсы по отдельности и объединение и Минификация (B/M) в пример программы.

|  | **С помощью B в минуту** | **Без B в минуту** | **Изменение** |
| --- | --- | --- | --- |
| **Файл запросов** | 9 | 34 | 256% |
| **Отправлено КБ** | 3.26 | 11.92 | 266% |
| **Получено КБ** | 388.51 | 530 | 36% |
| **Время загрузки** | 510 MS | 780 MS | 53% |

Число отправленных байт было значительное сокращение с объединением как обозреватели являются довольно подробного с заголовками HTTP, которые они применяются к запросам. Сокращения полученные байты не имеет такой же размер поскольку самые большие файлы (*сценарии\\jquery-ui-1.8.11.min.js* и *скрипты\\jquery-1.7.1.min.js*) уже минифицированы . Примечание. Затраты времени на пример программы, используемой [Fiddler](http://www.fiddler2.com/fiddler2/) средство имитации медленной сети. (Из Fiddler **правила** меню, выберите **производительности** затем **имитировать скоростей**.)

## <a name="debugging-bundled-and-minified-javascript"></a>Отладка объединенного в пакет и уменьшенными JavaScript

Это можно легко выполнять отладку JavaScript в среде разработки (где [элемент compilation](https://msdn.microsoft.com/library/s10awwz0.aspx) в *Web.config* задан как `debug="true"` ) потому, что файлы JavaScript не объединены или уменьшено. Также можно выполнять отладку сборки выпуска где объединенными и уменьшенными файлов JavaScript. С помощью средств разработчика IE F12, отладке функцию JavaScript, включенные в минифицированные пакет, используя следующий подход:

1. Выберите **сценарий** , а затем — **начать отладку** кнопки.
2. Выберите пакет, в котором необходимо выполнить отладку с помощью кнопки активы функция JavaScript.  
    ![](bundling-and-minification/_static/image4.png)
3. Формат минифицированные JavaScript, выбрав **Configuration кнопка** ![](bundling-and-minification/_static/image5.png), а затем выбрав **формата JavaScript**.
4. В **сценария поиска** поле ввода, выберите имя функции, необходимо выполнить отладку. На следующем рисунке **AddAltToImg** была введена в **сценария поиска** поле ввода.  
    ![](bundling-and-minification/_static/image6.png)

Дополнительные сведения об отладке с помощью средств разработчика F12, см. в статье MSDN [с помощью средств разработчика F12 для отладки ошибок JavaScript](https://msdn.microsoft.com/library/ie/gg699336(v=vs.85).aspx).

## <a name="controlling-bundling-and-minification"></a>Управление объединение и Минификация

Объединение и Минификация включен или отключен, установив значение атрибута отладки в [элемент compilation](https://msdn.microsoft.com/library/s10awwz0.aspx) в *Web.config* файл. В следующем XML `debug` установлено значение true, объединение и Минификация отключено.

[!code-xml[Main](bundling-and-minification/samples/sample3.xml?highlight=2)]

Чтобы включить объединение и Минификация, задайте `debug` значение «false». Можно переопределить *Web.config* параметра `EnableOptimizations` свойство `BundleTable` класса. Следующий код включает объединение и Минификация и переопределяет все параметры в *Web.config* файл.

[!code-csharp[Main](bundling-and-minification/samples/sample4.cs?highlight=7)]

> [!NOTE]
> Если не `EnableOptimizations` — `true` или атрибута отладки в [элемент compilation](https://msdn.microsoft.com/library/s10awwz0.aspx) в *Web.config* задан как `false`, файлы не будет объединено или уменьшено. Кроме того не будет использоваться .min версию файлов, полный отладочных версий будут выбраны. `EnableOptimizations` переопределяет атрибут debug в [элемент compilation](https://msdn.microsoft.com/library/s10awwz0.aspx) в *Web.config* файла

## <a name="using-bundling-and-minification-with-aspnet-web-forms-and-web-pages"></a>С помощью объединения и Минификации с веб-форм ASP.NET и веб-страниц

- Для веб-страниц см. в записи блога [Добавление веб-оптимизация на сайт веб-страниц](https://blogs.msdn.com/b/rickandy/archive/2012/08/15/adding-web-optimization-to-a-web-pages-site.aspx).
- Веб-формы, см. в записи блога [добавление объединения и Минификации в веб-формы](https://blogs.msdn.com/b/rickandy/archive/2012/08/14/adding-bundling-and-minification-to-web-forms.aspx).

## <a name="using-bundling-and-minification-with-aspnet-mvc"></a>С помощью объединения и Минификации с ASP.NET MVC

В этом разделе мы создадим ASP.NET MVC проекта изучаемый объединения и минификации. Во-первых, создайте новый проект ASP.NET MVC Интернета с именем **MvcBM** не изменяя значения по умолчанию.

Откройте *приложения\\\_запустить\\BundleConfig.cs* файл и просмотрите `RegisterBundles` метод, который используется для создания, регистрации и настройки пакетов. В следующем коде показано часть `RegisterBundles` метод.

[!code-csharp[Main](bundling-and-minification/samples/sample5.cs)]

Приведенный выше код создает новый набор JavaScript с именем *~/bundles/jquery* , включает в себя соответствующие (это отладки или уменьшено, но не. *vsdoc*) файлы в *сценариев* , соответствующие подстановочному знаку строки «~/Scripts/jquery-{version} .js». Для ASP.NET MVC 4, это означает, с помощью конфигурации отладки, файле *jquery-1.7.1.js* будут добавлены к пакету. В конфигурации выпуска *jquery-1.7.1.min.js* будут добавлены. Объединение framework соглашениям несколько распространенных такие как:

- Выбрав файл «.min» для выпуске *FileX.min.js* и *FileX.js* существует.
- Выбор версии не «.min» для отладки.
- Пропуск «-vsdoc» файлы (такие как *jquery-1.7.1-vsdoc.js*), которые используются только технологией IntelliSense.

`{version}` Выше сопоставление шаблонов используется для автоматического создания пакета jQuery с соответствующей версией jQuery в вашей *сценариев* папки. В этом примере с помощью подстановочного знака предоставляет следующие преимущества:

- Позволяет использовать NuGet для обновления до более новой версии jQuery, без изменения предыдущий код, объединения или jQuery ссылки на страницы представления.
- Автоматически выбирает полной версии для конфигураций отладки и версии «.min» для выпуска построения.

## <a name="using-a-cdn"></a>Использование CDN

 Следующий код заменяет пакет jQuery локальный пакет jQuery CDN.

[!code-csharp[Main](bundling-and-minification/samples/sample6.cs)]

В приведенном выше коде jQuery будет запрашиваться из сети CDN, а в выпуске режим и отладочная версия jQuery, полученных в результате локально в режиме отладки. При использовании CDN, в случае сбоя запроса CDN необходимо резервный механизм. В конце сценария показан файл макета, добавлен в запрос, что jQuery должен "fail" CDN на фрагмент следующую разметку.

[!code-cshtml[Main](bundling-and-minification/samples/sample7.cshtml?highlight=5-13)]

## <a name="creating-a-bundle"></a>Создавая набор

[Пакета](https://msdn.microsoft.com/library/system.web.optimization.bundle(v=VS.110).aspx) класс `Include` метод принимает массив строк, где каждая строка представляет виртуальный путь к ресурсу. В следующем коде из `RegisterBundles` метод в *приложения\\\_запустить\\BundleConfig.cs* файла показано, каким образом несколько файлы добавляются в пакет:

[!code-csharp[Main](bundling-and-minification/samples/sample8.cs)]

[Пакета](https://msdn.microsoft.com/library/system.web.optimization.bundle(v=VS.110).aspx) класс `IncludeDirectory` метод предоставляется для добавления всех файлов в каталог (и при необходимости все подкаталоги), в которых соответствуют шаблону поиска. [Пакета](https://msdn.microsoft.com/library/system.web.optimization.bundle(v=VS.110).aspx) класс `IncludeDirectory` API приведен ниже:

[!code-csharp[Main](bundling-and-minification/samples/sample9.cs)]

Пакеты указываются в представления, используя метод Render (`Styles.Render` для CSS и `Scripts.Render` для JavaScript). Следующая разметка из *представления\\Shared\\\_Layout.cshtml* -файл, показывающий, как представления по умолчанию для проекта ASP.NET internet ссылки на пакеты, CSS и JavaScript.

[!code-cshtml[Main](bundling-and-minification/samples/sample10.cshtml?highlight=5-6,11)]

Обратите внимание, что методы отрисовки принимает массив строк, поэтому можно добавить несколько пакетов в одну строку кода. Можно использовать методы отрисовки, которые создают необходимые HTML-код для ссылки на ресурс. Можно использовать `Url` метод для генерации URL-адрес ресурса без разметки, необходимые для указания ресурса. Предположим, что требуется для использования нового HTML5 [async](http://www.whatwg.org/specs/web-apps/current-work/#attr-script-async) атрибута. Ниже показано, как ссылка с использованием modernizr `Url` метод.

[!code-cshtml[Main](bundling-and-minification/samples/sample11.cshtml?highlight=11)]

## <a name="using-the--wildcard-character-to-select-files"></a>С помощью "\*" подстановочный знак для выбора файлов

Виртуальный путь, указанный в `Include` метод и поиск шаблонов в `IncludeDirectory` метод может принимать одно "\*" подстановочный знак в качестве префикса или суффикса в последнем сегменте пути. Строка поиска не учитывает регистр. `IncludeDirectory` Метод имеет возможность поиска в подкаталогах.

Рассмотрим проект, содержащий следующие файлы JavaScript:

- *Сценарии\\распространенных\\AddAltToImg.js*
- *Сценарии\\распространенных\\ToggleDiv.js*
- *Сценарии\\распространенных\\ToggleImg.js*
- *Сценарии\\распространенных\\Sub1\\ToggleLinks.js*

![dir imag](bundling-and-minification/_static/image7.png)

В следующей таблице показаны файлы, добавленные в пакет, используя подстановочный знак, как показано:

| **Call** | **Файлы, добавленные или исключение, вызываемое** |
| --- | --- |
| Включить («~/Scripts/Common/\*.js ") | *AddAltToImg.js*, *ToggleDiv.js*, *ToggleImg.js* |
| Включить («~/Scripts/Common/T\*.js ") | Недопустимый шаблон исключение. Подстановочный знак можно использовать только в префиксе или суффиксе. |
| Включить («~/Scripts/Common/\*og.\*") | Недопустимый шаблон исключение. Допускается только один подстановочный знак. |
| Включить («~/Scripts/Common/T\*») | *ToggleDiv.js*, *ToggleImg.js* |
| Включить («~/Scripts/Common/\*») | Недопустимый шаблон исключение. Недопустимый сегмент чисто подстановочный знак. |
| IncludeDirectory ("~/Scripts/Common", "T\*") | *ToggleDiv.js*, *ToggleImg.js* |
| IncludeDirectory ("~/Scripts/Common", "T\*", true) | *ToggleDiv.js*, *ToggleImg.js*, *ToggleLinks.js* |

Прямого добавления каждого файла к пакету используется как предпочтительная через подстановочный знак загрузку файлов по следующим причинам:

- Добавление скриптов по умолчанию подстановочный знак, загружая их в алфавитном порядке, что обычно не нужны. Файлы CSS и JavaScript часто должны быть добавлены в определенном порядке (не являющиеся буквами). Можно снизить эту угрозу, добавив пользовательский [IBundleOrderer](https://msdn.microsoft.com/library/system.web.optimization.ibundleorderer(VS.110).aspx) реализации, но прямого добавления каждый файл занимает менее подвержен ошибкам. Например, можно добавить новые ресурсы в папку в будущем, которые может потребоваться изменить ваш [IBundleOrderer](https://msdn.microsoft.com/library/system.web.optimization.ibundleorderer(VS.110).aspx) реализации.
- Представление определенных файлов, добавлен в каталог, с помощью подстановочных загрузки могут быть включены во всех представлениях, ссылающиеся на этом наборе. Если определенный сценарий представление добавляется к пакету, может появиться ошибка JavaScript в других представлениях, которые ссылаются на пакет.
- Файлы CSS, импорт других файлов привести импортированных файлов, загруженных в два раза. Например следующий код создает пакет с большую часть файлов CSS тему пользовательского интерфейса jQuery, загрузить дважды. 

    [!code-csharp[Main](bundling-and-minification/samples/sample12.cs)]

  Селектор подстановочному знаку "\*.css» привносит в каждом файле CSS в папке, включая *содержимого\\темы\\базового\\jquery.ui.all.css* файла. *Jquery.ui.all.css* файл импортирует другие файлы CSS.

## <a name="bundle-caching"></a>Объединить кэширования

Пакеты задать один год истечения срока действия заголовка HTTP из при создании пакета. После перехода на предыдущую страницу, время IE не выполняет условного запроса для пакета, отображается в Fiddler, существует не HTTP-запросы GET из браузера Internet Explorer для пакетов и ответов HTTP 304 с сервера. Вы можете принудительно IE, чтобы условного запроса для каждого пакета с помощью клавиши F5 (что в ответе HTTP 304 для каждого пакета). Можно принудительно полное обновление, используя ^ F5 (в результате чего ответ HTTP 200 для каждого пакета.)

На следующем рисунке показана **кэширование** вкладку на панели response Fiddler:

![Fiddler кэширования изображений](bundling-and-minification/_static/image8.png)

Запрос   
`http://localhost/MvcBM_time/bundles/AllMyScripts?v=r0sLDicvP58AIXN_mc3QdyVvVj5euZNzdsa2N1PKvb81`  
 — для пакета **AllMyScripts** и содержит пару строка запроса **v = r0sLDicvP58AIXN\\\_mc3QdyVvVj5euZNzdsa2N1PKvb81**. Строка запроса **v** имеет значение маркера, то есть уникальный идентификатор, используемый для кэширования. До тех пор, пока пакет не изменяется, приложение ASP.NET будет запрашивать **AllMyScripts** пакета с помощью этого токена. При изменении любого файла в пакете, платформа для оптимизации ASP.NET создаст новый маркер, гарантируя, что запросы браузера для пакета будут получены последнюю пакета.

Если вы запускаете в средствах разработчика IE9 F12 и перейдите на страницу ранее загруженную, IE некорректно показывает условного запросы GET к каждый пакет и сервером, возвращая HTTP 304. Можно прочитать, почему IE9 имеет недостатков, определение условного запроса был создан в записи блога [с помощью CDN и Expires для повышения производительности веб-сайт](https://blogs.msdn.com/b/rickandy/archive/2011/05/21/using-cdns-to-improve-web-site-performance.aspx).

## <a name="less-coffeescript-scss-sass-bundling"></a>МЕНЕЕ CoffeeScript, SCSS, Sass, объединение.

Объединение и Минификация платформа предоставляет механизм для обработки промежуточные языки, такие как [SCSS](http://sass-lang.com/), [Sass](http://sass-lang.com/), [меньше](http://www.dotlesscss.org/) или [Coffeescript ](http://coffeescript.org/)и применение преобразований, таких как минификации в результирующий набор. Например, чтобы добавить [.less](http://www.dotlesscss.org/) файлы в проект MVC 4:

1. Создайте папку для меньше содержимого. В следующем примере используется *содержимого\\MyLess* папки.
2. Добавить [.less](http://www.dotlesscss.org/) пакет NuGet **краткую** в проект.  
    ![Без точки установки NuGet](bundling-and-minification/_static/image9.png)
3. Добавьте класс, реализующий [IBundleTransform](https://msdn.microsoft.com/library/system.web.optimization.ibundletransform(VS.110).aspx) интерфейс. Для преобразования .less добавьте следующий код в проект.

    [!code-csharp[Main](bundling-and-minification/samples/sample13.cs)]
4. Создание пакета меньше файлов с `LessTransform` и [CssMinify](https://msdn.microsoft.com/library/system.web.optimization.cssminify(VS.110).aspx) преобразования. Добавьте следующий код, чтобы `RegisterBundles` метод в *приложения\\_запуск\\BundleConfig.cs* файла.

    [!code-csharp[Main](bundling-and-minification/samples/sample14.cs)]
5. Добавьте следующий код ко всем представлениям, на которые ссылается на меньше пакета.

    [!code-cshtml[Main](bundling-and-minification/samples/sample15.cshtml)]

## <a name="bundle-considerations"></a>Рекомендации по пакета

Хорошее соглашение следовать при создании пакетов является включение «объединить» как префикс в имени пакета. Это не позволит возможного [маршрутизации конфликт](https://forums.asp.net/post/5012037.aspx).

После обновления один файл в пакете, для параметра строки запроса пакета создается новый маркер и полного пакета необходимо загрузить следующий раз, клиент запрашивает страницу, содержащую пакет. В традиционных разметки, где перечислены каждого ресурса по отдельности будет загружаться только измененный файл. Ресурсы, которые часто изменяются, не могут быть хорошими кандидатами для объединения.

Объединение и Минификация в основном улучшить время загрузки первого запроса страницы. Когда веб-страницы был запрошен, обозреватель кэширует ресурсы (JavaScript, CSS и изображения), объединение и Минификация насыщенный любое увеличение производительности при запросе той же странице, или страниц на том же сайте, запрашивает эти ресурсы. Если не задан заголовок правильно на средствах, истечения срока действия и не используйте объединение и Минификация, эвристики актуальность браузеры пометит ресурсы устаревшей через несколько дней и браузер будет требовать запроса на проверку для каждого ресурса. Таким образом объединение и Минификация обеспечивают повышение производительности после первого запроса страницы. Дополнительные сведения см. в записи [с помощью CDN и Expires для повышения производительности веб-сайт](https://blogs.msdn.com/b/rickandy/archive/2011/05/21/using-cdns-to-improve-web-site-performance.aspx).

Ограничение браузера шесть одновременных подключений для каждого имени узла можно избежать, используя [CDN](https://blogs.msdn.com/b/rickandy/archive/2011/05/21/using-cdns-to-improve-web-site-performance.aspx). Поскольку CDN будет иметь разные имени узла, чем сайта размещения, запросы актива из сети CDN не учитываются для шести ограничение одновременных подключений к среде размещения. CDN можно также предоставить общие кэширование пакетов и пограничные преимущества.

Пакеты должны быть секционированы по страницам, где они необходимы. Например шаблон ASP.NET MVC для веб-приложение по умолчанию создает набор проверки jQuery, отдельно от jQuery. Так как не публиковать значения по умолчанию представления, созданные у отсутствуют входные данные, они не включают проверки пакета.

`System.Web.Optimization` Пространство имен реализуется в *System.Web.Optimization.dll*. При этом используется библиотека WebGrease (*WebGrease.dll*) для добавления поддержки возможностей минификации, который в свою очередь использует *Antlr3.Runtime.dll*.

*Я использую Twitter для быстрого сообщения и поделиться им ссылки. Мой дескриптор Twitter —*: [@RickAndMSFT](http://twitter.com/RickAndMSFT)

## <a name="additional-resources"></a>Дополнительные ресурсы

- Видео:[объединение и оптимизация](https://channel9.msdn.com/Events/aspConf/aspConf/Bundling-and-Optimizing) по [Говард Дайеркинг](https://twitter.com/#!/howard_dierking)
- [Добавление веб-оптимизация на сайт веб-страниц](https://blogs.msdn.com/b/rickandy/archive/2012/08/15/adding-web-optimization-to-a-web-pages-site.aspx).
- [Добавление объединения и Минификации в веб-формы](https://blogs.msdn.com/b/rickandy/archive/2012/08/14/adding-bundling-and-minification-to-web-forms.aspx).
- [Последствия для производительности объединение и Минификация в Интернете](https://blogs.msdn.com/b/henrikn/archive/2012/06/17/performance-implications-of-bundling-and-minification-on-http.aspx) по [Nielsen Хенрик F](http://en.wikipedia.org/wiki/Henrik_Frystyk_Nielsen) [@frystyk](https://twitter.com/frystyk)
- [С помощью CDN и истечения срока действия для повышения производительности веб-сайте](https://blogs.msdn.com/b/rickandy/archive/2011/05/21/using-cdns-to-improve-web-site-performance.aspx) по Рик Андерсон [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)
- [Свести к минимуму время приема-Передачи (время кругового пути)](https://developers.google.com/speed/docs/best-practices/rtt)

## <a name="contributors"></a>Авторы

- Поздравить хао
- [Говард Дайеркинг](https://twitter.com/#!/howard_dierking)
- Diana LaRose
