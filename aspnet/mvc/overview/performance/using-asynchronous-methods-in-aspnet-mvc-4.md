---
uid: mvc/overview/performance/using-asynchronous-methods-in-aspnet-mvc-4
title: Использование асинхронных методов в ASP.NET MVC 4 | Документация Майкрософт
author: Rick-Anderson
description: Этом учебнике описываются основы создания асинхронных MVC веб-приложения ASP.NET с помощью Visual Studio Express 2012 для Web, который является бесплатной ve...
ms.author: riande
ms.date: 06/06/2012
ms.assetid: a56572ba-81c3-47af-826d-941e9c4775ec
msc.legacyurl: /mvc/overview/performance/using-asynchronous-methods-in-aspnet-mvc-4
msc.type: authoredcontent
ms.openlocfilehash: 20f8d6f459cefc6c1a2e7d5f64c6df4199f8ad24
ms.sourcegitcommit: 289e051cc8a90e8f7127e239fda73047bde4de12
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/25/2019
ms.locfileid: "58424473"
---
<a name="using-asynchronous-methods-in-aspnet-mvc-4"></a>Использование асинхронных методов в ASP.NET MVC 4
====================
по [Рик Андерсон]((https://twitter.com/RickAndMSFT))

> Этот учебник поможет основы создания асинхронных приложений веб-ASP.NET MVC с использованием [Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/11), который является бесплатной версии Microsoft Visual Studio. Можно также использовать [Visual Studio 2012](https://www.microsoft.com/visualstudio/11).
> 
> Полный пример приведен в этом руководстве на сайте github  [https://github.com/RickAndMSFT/Async-ASP.NET/](https://github.com/RickAndMSFT/Async-ASP.NET/)


ASP.NET MVC 4 [Controller](https://msdn.microsoft.com/library/system.web.mvc.controller(VS.108).aspx) класс в сочетании [.NET 4.5](https://msdn.microsoft.com/library/w0x726c2(VS.110).aspx) позволяет написать асинхронные методы действия, которые возвращают объект типа [задачи&lt;ActionResult&gt; ](https://msdn.microsoft.com/library/dd321424(VS.110).aspx). .NET Framework 4 появилась асинхронного программирования концепция, называемая [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) и ASP.NET MVC 4 поддерживает [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx). Задачи представляются **задачи** типа и связанных типов в [System.Threading.Tasks](https://msdn.microsoft.com/library/system.threading.tasks.aspx) пространства имен. .NET Framework 4.5 основан на этой асинхронной поддержки за счет [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) и [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевые слова, которые делают работу с [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) гораздо проще, чем предыдущие объектов асинхронные подходы. [Await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) ключевое слово является синтаксическое сокращение, которое указывает, которого фрагмент кода асинхронно ожидает на другие части кода. [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевое слово представляет подсказку, которая позволяет пометить методы как асинхронные методы на основе задач. Сочетание **await**, **async**и **задачи** объекта значительно упрощает написание асинхронного кода в .NET 4.5. Новая модель для асинхронных методов называется *асинхронную модель на основе задач* (**КОСНИТЕСЬ**). Предполагается, что у вас есть некоторый опыт работы с асинхронного программирования при помощи [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) и [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевые слова и [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) пространства имен.

Дополнительные сведения об использовании [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) и [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевые слова и [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) пространства имен, см. в следующих ресурсах.

- [Технический документ. Асинхронность в .NET](https://go.microsoft.com/fwlink/?LinkId=204844)
- [Часто задаваемые вопросы о Async/Await](https://blogs.msdn.com/b/pfxteam/archive/2012/04/12/10293335.aspx)
- [Асинхронное программирование в Visual Studio](https://msdn.microsoft.com/vstudio/gg316360)

## <a id="HowRequestsProcessedByTP"></a>  Порядок обработки запросов пулом потоков

На веб-сервере в .NET Framework поддерживается пул потоков, которые используются для обслуживания запросов ASP.NET. Когда запрос прибывает, поток из пула отправляется для обработки этого запроса. Если запрос обрабатывается синхронно, поток, который обрабатывает запрос является занятости во время запрос обрабатывается, и что поток не может обслуживать другой запрос.   
  
Это может оказаться проблемой, так как пул потоков можно сделать достаточно велик для хранения множества занятых потоков. Однако количество потоков в пуле потоков ограничено (максимум для .NET 4.5 по умолчанию — 5000). В больших приложениях с высокой степенью параллелизма длительных запросов может препятствовать все доступные потоки. Это состояние называется нехватка потоков. При наступлении такой ситуации веб-сервер помещает запросы в очередь. При переполнении очереди запросов веб-сервер отклоняет запросы с состоянием HTTP 503 (сервер перегружен). Пул потоков CLR имеет ограничения на новый поток вставки. Если параллелизм множественными (то есть веб-сайт может неожиданно получить большое количество запросов) и все доступные потоки запросов заняты из-за вызовов серверной части с высокой задержкой, скорость внедрения ограниченной потока могут сделать очень плохо отвечать приложение. Кроме того каждый новый поток, добавляемые в пул потоков имеет издержки (например, 1 МБ памяти). Веб-приложения с помощью синхронных методов вызовы между службами высокой задержкой, где пул потоков возрастает до .NET 4.5 по умолчанию более 5, 000 потоков займут около 5 ГБ больше памяти, чем приложение с такой же запросов на обслуживание с помощью асинхронные методы и 50 потоков. При выполнении асинхронной работы, не всегда используется поток. Например, при выполнении запроса асинхронной веб-службы ASP.NET не будет использовать все потоки между **async** вызова метода и **await**. Используя пул потоков для обслуживания запросов с высокой задержкой может привести к большой объем памяти и неэффективного использования серверного оборудования.

## <a name="processing-asynchronous-requests"></a>Обработка асинхронных запросов

В веб-приложение, которое видит большое количество одновременных запросов при запуске или имеет множественными нагрузки (где степень параллелизма можно повысить внезапно) делая асинхронных вызовов веб-службы увеличивает скорость реагирования приложения. Асинхронный запрос обрабатывается тем же количество времени для обработки как синхронный запрос. Если запрос выполняет вызов веб-службы требует две секунды для выполнения, запрос занимает две секунды ли она выполняется синхронно или асинхронно. Тем не менее при асинхронном вызове, поток не заблокирован для ответов на другие запросы во время ожидания выполнения первого запроса. Поэтому асинхронные запросы предупреждают роста пула очереди и поток запроса при наличии множества параллельных запросов, которые вызывают длительные операции.

## <a id="ChoosingSyncVasync"></a>  Выбор синхронного или асинхронного метода действия

В этом разделе перечислены рекомендации, когда использовать синхронные или асинхронные методы действия. Это только рекомендации; Проверьте каждое приложение, чтобы определить, является ли асинхронные методы повышения производительности.

В общем случае используйте синхронные методы для следующих условий:

- Операции являются простыми или коротким циклом выполнения.
- Простота является более важным, чем эффективность.
- Операции основном являются операциями ЦП вместо операции, включающие широко используется диск или сетевые ресурсы. Использование асинхронных методов действия в операциях ЦП не дает преимущества и приводит к дополнительной нагрузки.

  В общем случае используйте асинхронные методы для следующих условий:

- Вы вызываете служб, которые могут быть использованы через асинхронных методов, и вы используете .NET 4.5 или более поздней.
- Операции являются сети или ввода вывода вместо ЦП.
- Параллелизм имеет большее, чем простота кода.
- Вы хотите предоставить механизм, который позволяет пользователям отменить длительные запрос.
- При переключении потоков преимущество перевешивает стоимость переключения контекста. В общем случае следует метод асинхронной Если синхронный метод ожидает потока запроса ASP.NET при не выполняют никакой работы. Путем вызова асинхронного потока запросов ASP.NET не остановлен во время ожидания запроса веб-службы завершить не выполняют никакой работы.
- Тестирование показало, что блокировка операций приводит к ухудшению производительности сайта и что IIS может обслуживать большее количество запросов с помощью асинхронных методов для этих заблокированных вызовов.

  Загружаемый пример показано, как эффективно использовать асинхронные методы действия. Предоставленный образец была разработана для представлена простая демонстрация асинхронного программирования в ASP.NET MVC 4 с помощью .NET 4.5. Образец не является эталонную архитектуру для асинхронного программирования в ASP.NET MVC. Программа-пример вызывает [веб-API ASP.NET](../../../web-api/index.md) методы, которые в свою очередь вызывают [Task.Delay](https://msdn.microsoft.com/library/hh139096(VS.110).aspx) для имитации вызовов длительных веб-службы. Большинство приложений не продемонстрируют такие очевидные преимущества для использования асинхронных методов действия.   
  
Несколько приложений требуют все методы действия были асинхронными. Часто преобразование нескольких синхронных методов действия в асинхронных методов обеспечивает наилучший прирост эффективности для требуемого объема работ.

## <a id="SampleApp"></a>  Пример приложения

Можно загрузить пример приложения из [ https://github.com/RickAndMSFT/Async-ASP.NET/ ](https://github.com/RickAndMSFT/Async-ASP.NET) на [GitHub](https://github.com/) сайта. Хранилище состоит из трех проектов:

- *Mvc4Async*: Проект ASP.NET MVC 4, который содержит код, используемый в этом руководстве. Он выполняет вызовы веб-API **WebAPIpgw** службы.
- *WebAPIpgw*: Проект веб-API ASP.NET MVC 4, который реализует `Products, Gizmos and Widgets` контроллеров. Он предоставляет данные для *WebAppAsync* проекта и *Mvc4Async* проекта.
- *WebAppAsync*: Используемый в другой учебник, в проект веб-форм ASP.NET.

## <a id="GizmosSynch"></a>  Элементы синхронный метод действия

 В следующем коде показан `Gizmos` синхронный метод действия, используемый для отображения списка элементы. (В этой статье gizmo — это вымышленная механические устройство). 

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample1.cs)]

В следующем коде показан `GetGizmos` метода gizmo службы.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample2.cs)]

`GizmoService GetGizmos` Метод передает URI в службе ASP.NET Web API HTTP, который возвращает список элементы данных. *WebAPIpgw* проект содержит реализацию веб-API `gizmos, widget` и `product` контроллеров.  
На следующем рисунке представление элементы из образца проекта.

![Элементы](using-asynchronous-methods-in-aspnet-mvc-4/_static/image1.png)

## <a id="CreatingAsynchGizmos"></a>  Создание метода действия асинхронные элементы

В образце используется новый [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) и [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) ключевые слова (доступный в .NET 4.5 и Visual Studio 2012) позволяет вести сложных преобразований, необходимых для компилятора Асинхронное программирование. Компилятор позволяет писать код, используя конструкции потока синхронной управления C#, и компилятор автоматически применяет преобразования, необходимые для использования обратных вызовов, чтобы избежать блокировки потоков.

В следующем коде показан `Gizmos` синхронного метода и `GizmosAsync` асинхронного метода. Если браузер поддерживает [HTML 5 `<mark>` элемент](http://www.w3.org/wiki/HTML/Elements/mark), вы сможете увидеть изменения в `GizmosAsync` в выделение желтым цветом.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample3.cs)]

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample4.cs?highlight=1,3,5)]

 Следующие изменения были применены к Разрешить `GizmosAsync` асинхронным.

- Метод помечен атрибутом [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевое слово, которое указывает компилятору создавать обратные вызовы для частей тела и автоматически создавать `Task<ActionResult>` возвращаемый.
- &quot;Async&quot; добавленный к имени метода. Добавление «Async» не является обязательным, но является соглашением, при написании асинхронных методов.
- Возвращаемый тип был изменен с `ActionResult` для `Task<ActionResult>`. Тип возвращаемого значения `Task<ActionResult>` представляет текущую операцию и предоставляет этот метод с дескриптором, через который ожидает завершения асинхронной операции. В этом случае вызывающий объект является веб-службы. `Task<ActionResult>` представляет текущие работать с результатом `ActionResult.`
- [Await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) ключевое слово была применена для вызова веб-службы.
- Был вызван асинхронный веб-API службы (`GetGizmosAsync`).

Внутри элемента `GetGizmosAsync` другого асинхронного метода, основной метод `GetGizmosAsync` вызывается. `GetGizmosAsync` немедленно возвращает `Task<List<Gizmo>>` со временем, завершается, если данные недоступны. Так как не нужно ничего делать, пока не получится gizmo данные, код ожидает завершения задачи (с помощью **await** ключевое слово). Можно использовать **await** ключевое слово только в методы, помеченные **async** ключевое слово.

**Await** ключевое слово не блокирует поток до завершения задачи. Он регистрирует остальную метода как обратный вызов в задаче и немедленно возвращает. После завершения выполнения ожидающей задачи в конечном счете, он этот обратный вызов и таким образом возобновить выполнение метод справа, где она была остановлена. Дополнительные сведения об использовании [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) и [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевые слова и [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) пространства имен, см. в разделе [ссылки async](https://docs.microsoft.com/dotnet/csharp/language-reference/keywords/async).

В следующем коде показан `GetGizmos` и `GetGizmosAsync` методы.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample5.cs)]

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample6.cs?highlight=1,4-8)]

 Асинхронные изменения аналогичны внесенные **GizmosAsync** выше. 

- Подпись метода, аннотированных в [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевое слово, возвращаемый тип был изменен на `Task<List<Gizmo>>`, и *Async* добавленный к имени метода.
- Асинхронный [HttpClient](https://msdn.microsoft.com/library/system.net.http.httpclient(VS.110).aspx) класс используется вместо [WebClient](https://msdn.microsoft.com/library/system.net.webclient.aspx) класса.
- [Await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) ключевое слово была применена к [HttpClient](https://msdn.microsoft.com/library/system.net.http.httpclient(VS.110).aspx) асинхронных методов.

На следующем рисунке представление асинхронных gizmo.

![async](using-asynchronous-methods-in-aspnet-mvc-4/_static/image2.png)

Браузеры представлением данных элементы идентична представлениям, созданным синхронный вызов. Единственное различие — это асинхронная версия может быть более высокую производительность при больших нагрузках.

## <a id="Parallel"></a>  Параллельное выполнение нескольких операций

Асинхронные методы действия имеют значительное преимущество синхронных методов, когда действие должно выполнить несколько независимых операций. В приведенном примере модуль синхронного метода `PWG`(для продуктов, мини-приложения и элементы) отображаются результаты трех вызовов веб-служб для получения списка продуктов, мини-приложения и элементы. [Веб-API ASP.NET](../../../web-api/index.md) проект, который предоставляет эти службы использует [Task.Delay](https://msdn.microsoft.com/library/hh139096(VS.110).aspx) чтобы имитировать задержки или медленные вызовы методов. Когда для задержки задано значение 500 миллисекунд, асинхронный `PWGasync` метод принимает немного более чем 500 мс до завершения во время синхронного `PWG` имеет версию, чем 1 500 миллисекунд. Синхронный `PWG` метод показан в следующем коде.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample7.cs)]

Асинхронный `PWGasync` метод показан в следующем коде.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample8.cs?highlight=1,3,12)]

На следующем рисунке показаны представления, возвращаемого из **PWGasync** метод.

![pwgAsync](using-asynchronous-methods-in-aspnet-mvc-4/_static/image3.png)

## <a id="CancelToken"></a>  Использование токена отмены

Асинхронные методы действия возвращение `Task<ActionResult>`являются можно отменить; они принимают [CancellationToken](https://msdn.microsoft.com/library/system.threading.cancellationtoken(VS.110).aspx) параметр, если оно предоставлено с [AsyncTimeout](https://msdn.microsoft.com/library/system.web.mvc.asynctimeoutattribute(VS.108).aspx) атрибута. В следующем коде показан `GizmosCancelAsync` метод с временем ожидания в миллисекундах 150.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample9.cs?highlight=1-3,5,10)]

В следующем коде показано GetGizmosAsync перегрузка, принимающая [CancellationToken](https://msdn.microsoft.com/library/system.threading.cancellationtoken(VS.110).aspx) параметра.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample10.cs)]

В примере приложения, выбрав *Демонстрация токена отмены* связать вызовы `GizmosCancelAsync` метод и демонстрирует отмены асинхронного вызова.

## <a id="ServerConfig"></a>  Конфигурация сервера для вызовов веб-службы высокого уровня параллелизма и высокий уровень задержки

Чтобы воспользоваться преимуществами асинхронных веб-приложения, может потребоваться внести некоторые изменения в конфигурации сервера по умолчанию. Имейте в виду при настройке и нагрузочное тестирование асинхронных веб-приложения следующее.

- Windows 7, Windows Vista и все клиентские операционные системы Windows иметь не более 10 одновременных запросов. Вам потребуется операционной системы Windows Server, чтобы ознакомиться с преимуществами асинхронных методов в условиях высокой нагрузки.
- Зарегистрируйте .NET 4.5 с IIS из командной строки с повышенными правами:  
  %windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet\_regiis -i  
  См. в разделе [средство регистрации ASP.NET IIS (Aspnet\_regiis.exe)](https://msdn.microsoft.com/library/k6h9cz8h.aspx)
- Может потребоваться увеличить [HTTP.sys](https://www.iis.net/learn/get-started/introduction-to-iis/introduction-to-iis-architecture) предел очереди из значения по умолчанию 1000 до 5000. Если для параметра установлено слишком низкое, может появиться [HTTP.sys](https://www.iis.net/learn/get-started/introduction-to-iis/introduction-to-iis-architecture) отклонять запросы с состоянием HTTP 503. Изменение предел очереди HTTP.sys.

    - Откройте диспетчер IIS и перейдите в область пулов приложений.
    - Щелкните правой кнопкой целевой пул приложений и выберите **Дополнительные параметры**.  
        ![Дополнительно](using-asynchronous-methods-in-aspnet-mvc-4/_static/image4.png)
    - В **Дополнительные параметры** » диалогового окна «Изменение *длина очереди* от 1000 до 5 000.  
        ![Длина очереди](using-asynchronous-methods-in-aspnet-mvc-4/_static/image5.png)  
  
  Обратите внимание, на рисунках выше, .NET framework указана как v4.0, несмотря на то, что пул приложений используется .NET 4.5. Чтобы понять это несоответствие, см. в следующих:

    - [Управление версиями .NET и многоплатформенного нацеливания - .NET 4.5 является обновлением на месте для .NET 4.0](http://www.hanselman.com/blog/NETVersioningAndMultiTargetingNET45IsAnInplaceUpgradeToNET40.aspx)
    - [Настройка приложения IIS или пул приложений для использования ASP.NET 3.5, а не 2.0](http://www.hanselman.com/blog/HowToSetAnIISApplicationOrAppPoolToUseASPNET35RatherThan20.aspx)
    - [Версии и зависимости платформы .NET Framework](https://msdn.microsoft.com/library/bb822049(VS.110).aspx)
- Если приложение использует веб-служб или System.NET для взаимодействия с серверной части по протоколу HTTP вам может потребоваться увеличить [connectionManagement/maxconnection](https://msdn.microsoft.com/library/fb6y0fyc(VS.110).aspx) элемент. Для приложений ASP.NET это ограничено с помощью функции автоматической настройки в 12 раз число ЦП. Это означает, что в quad-proc, можно иметь не более 12 \* 4 = 48 одновременных подключений к IP-адрес конечной точки. Так как это привязывается к [autoConfig](https://msdn.microsoft.com/library/7w2sway1(VS.110).aspx), самый простой способ увеличить `maxconnection` в ASP.NET является установка приложения [System.Net.ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit(VS.110).aspx) в обработчике из `Application_Start` метод в *global.asax* файл. Ознакомьтесь с примером загрузить пример.
- В .NET 4.5, по умолчанию 5000 для [MaxConcurrentRequestsPerCPU](https://blogs.msdn.com/tmarq/archive/2007/07/21/asp-net-thread-usage-on-iis-7-0-and-6-0.aspx) будет прекрасно работать.
