---
uid: aspnet/overview/developing-apps-with-windows-azure/maintainable-azure-websites-managing-change-and-scale
title: 'Практическое занятие. обслуживаемые веб-сайты Azure: Управление изменениями и масштабированием | Документация Майкрософт'
author: rick-anderson
description: В этом лабораторном занятии вы узнаете, как Microsoft Azure упрощает создание и развертывание веб-сайтов в рабочей среде.
ms.author: riande
ms.date: 07/16/2014
ms.assetid: ecfd0eb4-c4ad-44e6-9db9-a2a66611ff6a
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/maintainable-azure-websites-managing-change-and-scale
msc.type: authoredcontent
ms.openlocfilehash: c88bae40a8aa092037c0b359ee391acaf161cf10
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78506376"
---
# <a name="hands-on-lab-maintainable-azure-websites-managing-change-and-scale"></a>Практическое занятие. обслуживаемые веб-сайты Azure: Управление изменениями и масштабированием

по [веб-Camp командам](https://twitter.com/webcamps)

[Скачать обучающий комплект Web Camp](https://aka.ms/webcamps-training-kit)

> Microsoft Azure позволяет легко создавать и развертывать веб-сайты в рабочей среде. Но вы не делаете это, когда ваше приложение активно, вы только начинаете работу! Вам потребуется выполнить обработку измененных требований, обновление базы данных, масштабирование и многое другое. К счастью, в службе приложений Azure было рассмотрено множество функций, которые помогут обеспечить бесперебойную работу сайтов.
>
> Azure предлагает безопасные и гибкие возможности разработки, развертывания и масштабирования веб-приложений любого размера. Используйте существующие средства для создания и развертывания приложений, не загружая управляющую инфраструктуру.
>
> Самостоятельное предоставление рабочего веб-приложения за несколько минут путем простого развертывания содержимого, созданного с помощью любимого средства разработки. Вы можете развернуть существующий сайт непосредственно из системы управления версиями с поддержкой **git**, **GitHub**, **BitBucket**, **TFS**и даже **Dropbox**. Развертывайте непосредственно из предпочтительной среды IDE или из сценариев с помощью **PowerShell** в Windows или в средствах **CLI** , работающих в любой операционной системе. После развертывания постоянно обновляйте сайты благодаря поддержке непрерывного развертывания.
>
> Azure предоставляет масштабируемые, надежные облачные решения для хранения, резервного копирования и восстановления любых данных, большие или небольшие. При развертывании приложений в рабочей среде службы хранилища, такие как таблицы, большие двоичные объекты и базы данных SQL, помогают масштабировать приложение в облаке.
>
> При использовании баз данных SQL важно иметь актуальную версию эффективной базы данных при развертывании новых версий приложения. Благодаря **Entity Framework Code First migrations**, разработка и развертывание модели данных были упрощены для обновления сред в течение нескольких минут. В этой практической лабораторной работе будут показаны различные темы, которые могут возникнуть при развертывании веб-приложения в рабочих средах в Microsoft Azure.
>
> Все примеры кода и фрагментов включены в комплект обучающих курсов Web Camp, доступный по адресу [https://aka.ms/webcamps-training-kit](https://aka.ms/webcamps-training-kit).
>
> Более подробное описание этой статьи см. в статье [создание реальных облачных приложений с помощью электронной книги Azure](building-real-world-cloud-apps-with-windows-azure/introduction.md).

<a id="Overview"></a>
## <a name="overview"></a>Обзор

<a id="Objectives"></a>
### <a name="objectives"></a>Цели

В этой практической лабораторной работе вы узнаете, как выполнять следующие задачи:

- Включение миграции Entity Framework с помощью существующей модели
- Соответствующим образом обновите объектную модель и базу данных с помощью Entity Framework миграции
- Развертывание в службе приложений Azure с помощью Git
- Откат к предыдущему развертыванию с помощью портала управления Azure
- Использование службы хранилища Azure для масштабирования веб-приложения
- Настройка автоматического масштабирования для веб-приложения с помощью портал управления Azure
- Создание и Настройка проекта нагрузочного теста в Visual Studio

<a id="Prerequisites"></a>
### <a name="prerequisites"></a>предварительные требования

Для выполнения этой практической лабораторной работы требуется следующее:

- [Visual Studio Express 2013 для Web](https://www.microsoft.com/visualstudio/) или более поздней версии
- [Пакет Azure SDK для .NET 2,2](https://www.microsoft.com/windowsazure/sdk/)
- [Система управления версиями GIT](http://git-scm.com/download)
- Подписка на Microsoft Azure

    - Зарегистрируйтесь для получения [бесплатной пробной версии](https://aka.ms/watk-freetrial)
    - Если вы используете Visual Studio Professional, Test Professional, Premium или Ultimate с MSDN или подписчиком MSDN Platforms, активируйте [преимущества MSDN](https://aka.ms/watk-msdn) сейчас, чтобы приступить к разработке и тестированию в Azure.
    - Участники [BizSpark](https://aka.ms/watk-bizspark) автоматически получают преимущества Azure через подписки Visual Studio Ultimate с подпиской MSDN
    - Участники программы [Microsoft Partner Network](https://aka.ms/watk-mpn) Cloud Essentials бесплатно получают ежемесячные кредиты в Azure

<a id="Setup"></a>
### <a name="setup"></a>Настройка

Чтобы выполнить упражнения в этой практической лабораторной работе, сначала необходимо настроить среду.

1. Откройте проводник Windows и перейдите к **исходной** папке лаборатории.
2. Щелкните **Setup. cmd** правой кнопкой мыши и выберите **Запуск от имени администратора** , чтобы запустить процесс установки, который будет настраивать среду и установить фрагменты кода Visual Studio для этой лабораторной работы.
3. Если отображается диалоговое окно Контроль учетных записей пользователей, подтвердите действие для продолжения.

> [!NOTE]
> Убедитесь, что проверены все зависимости для этой лабораторной работы перед запуском программы установки.

<a id="CodeSnippets"></a>
### <a name="using-the-code-snippets"></a>Использование фрагментов кода

На протяжении всего лабораторного документа вы получите инструкции по вставке блоков кода. Для удобства большая часть этого кода предоставляется как Visual Studio Code фрагменты, к которым можно получить доступ из Visual Studio 2013, чтобы не добавлять их вручную.

> [!NOTE]
> Каждое упражнение сопровождается начальным решением, расположенным в **начальной** папке упражнения, которое позволяет выполнять каждое упражнение независимо от других. Имейте в виду, что фрагменты кода, добавленные во время упражнения, отсутствуют в этих начальных решениях и могут не работать, пока вы не завершите упражнение. В исходном коде для упражнения также будет найдена **Конечная** папка, содержащая решение Visual Studio с кодом, полученным в результате выполнения шагов в соответствующем упражнении. Эти решения можно использовать в качестве руководства, если вам нужна дополнительная помощь во время работы с этой практической лабораторной работой.

---

<a id="Exercises"></a>
## <a name="exercises"></a>Полнят

Эта практическая лабораторная работа включает в себя следующие упражнения:

1. [Использование Entity Framework миграций](#Exercise1)
2. [Развертывание веб-приложения для промежуточного хранения](#Exercise2)
3. [Выполнение отката развертывания в рабочей среде](#Exercise3)
4. [Масштабирование с помощью службы хранилища Azure](#Exercise4)
5. [Использование автомасштабирования для веб-приложений](#Exercise5) (необязательно для выпуска Visual Studio 2013 Ultimate)

Предполагаемое время выполнения этой лабораторной работы: **75 минут**

> [!NOTE]
> При первом запуске Visual Studio необходимо выбрать одну из предварительно определенных коллекций параметров. Каждая предопределенная коллекция разработана для соответствия определенному стилю разработки и определяет макеты окон, поведение редактора, фрагменты кода IntelliSense и параметры диалоговых окон. Процедуры в этом лабораторном занятии описывают действия, необходимые для выполнения данной задачи в Visual Studio при использовании коллекции **общих параметров разработки** . При выборе другой коллекции параметров для среды разработки могут возникнуть различия в действиях, которые необходимо учитывать.

<a id="Exercise1"></a>
### <a name="exercise-1-using-entity-framework-migrations"></a>Упражнение 1. использование Entity Framework миграций

При разработке приложения модель данных может изменяться со временем. Эти изменения могут повлиять на существующую модель в базе данных (если создается новая версия), и важно иметь актуальную версию базы данных, чтобы предотвратить возникновение ошибок.

Чтобы упростить отслеживание этих изменений в модели, **Entity Framework Code First migrations** автоматически обнаруживать изменения, сравнивающие модель с схемой базы данных, и создает конкретный код для обновления базы данных, создавая новые *версии* базы данных.

В этом упражнении показано, как включить **миграцию** для приложения и как можно легко обнаружить и создать изменения для обновления баз данных.

<a id="Ex1Task1"></a>
#### <a name="task-1--enabling-migrations"></a>Задача 1. Включение миграции

В этой задаче будут рассмотрены шаги по включению **Entity Framework Code First migrations** в базу данных " **Викторина** ", изменение модели и понимание того, как эти изменения отражаются в базе данных.

1. Откройте Visual Studio и откройте файл решения **жееккуиз. sln** из **Source\Ex1-UsingEntityFrameworkMigrations\Begin**.
2. Создайте решение, чтобы скачать и установить зависимости пакета **NuGet** . Для этого щелкните решение правой кнопкой мыши и выберите пункт **построить решение** или нажмите клавиши **CTRL + SHIFT + B**.
3. В меню **Сервис** в Visual Studio выберите **Диспетчер пакетов NuGet**, а затем щелкните **консоль диспетчера пакетов**.
4. В **консоли диспетчера пакетов**введите следующую команду и нажмите клавишу **Ввод**. Будет создана начальная миграция на основе существующей модели.

    [!code-powershell[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample1.ps1)]

    ![Включение миграции](maintainable-azure-websites-managing-change-and-scale/_static/image1.png "Включение миграций")

    *Включение миграции*

    > [!NOTE]
    > Эта команда добавляет папку **миграций** в проект проекта по проекту, который содержит файл с именем **Configuration.CS**. Класс **конфигурации** позволяет настроить работу миграций в контексте.
5. При включенных миграции необходимо обновить класс **конфигурации** , чтобы заполнить базу данных начальными **данными, необходимыми для этого.** В разделе **Миграция**замените файл **Configuration.CS** файлом, который находится в папке **саурце\ассетс** этой лабораторной работы.

    > [!NOTE]
    > Поскольку **Миграция** будет вызывать метод **начального значения** при каждом обновлении базы данных, необходимо убедиться, что записи не дублируются в базе данных. Метод **AddOrUpdate** поможет предотвратить дублирование данных.
6. Чтобы добавить начальную миграцию, введите следующую команду и нажмите клавишу **Ввод**.

    > [!NOTE]
    > Убедитесь, что в экземпляре LocalDB нет базы данных с именем &quot;Жееккуизпрод&quot;.

    [!code-powershell[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample2.ps1)]

    ![Добавление миграции базовой схемы](maintainable-azure-websites-managing-change-and-scale/_static/image2.png "Добавление миграции базовой схемы")

    *Добавление миграции базовой схемы*

    > [!NOTE]
    > **Добавление и миграция** приведет к формированию новой миграции на основе изменений, внесенных в модель с момента создания последней миграции. В этом случае, поскольку это первый перенос проекта, он добавляет скрипты для создания всех таблиц, определенных в классе **тривиаконтекст** .
7. Выполните миграцию, чтобы обновить базу данных, выполнив следующую команду. Для этой команды будет указан флаг **verbose** для просмотра инструкций SQL, применяемых к целевой базе данных.

    [!code-powershell[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample3.ps1)]

    ![Создание начальной базы данных](maintainable-azure-websites-managing-change-and-scale/_static/image3.png "Создание начальной базы данных")

    *Создание начальной базы данных*

    > [!NOTE]
    > **Update — база данных** будет применять все незавершенные миграции к базе данных. В этом случае она создаст базу данных, используя строку подключения, определенную в файле Web. config.
8. Перейдите в меню " **вид** " и откройте **Обозреватель объектов SQL Server**.

    ![Открыть в обозреватель объектов SQL Server](maintainable-azure-websites-managing-change-and-scale/_static/image4.png "Открыть в обозреватель объектов SQL Server")

    *Открыть в обозреватель объектов SQL Server*
9. В окне **Обозреватель объектов SQL Server** подключитесь к экземпляру LocalDB, щелкнув правой кнопкой мыши узел **SQL Server** и выбрав пункт **Добавить SQL Server...** .

    ![Добавление SQL Server экземпляра](maintainable-azure-websites-managing-change-and-scale/_static/image5.png "Добавление SQL Server экземпляра")

    *Добавление SQL Server экземпляра в обозреватель объектов SQL Server*
10. Задайте **имя сервера** *(LocalDB) \V11.0* и оставьте **проверку подлинности Windows** в качестве режима проверки подлинности. Чтобы продолжить, щелкните **Подключить** .

    ![Подключение к LocalDB](maintainable-azure-websites-managing-change-and-scale/_static/image6.png "Подключение к LocalDB")

    *Подключение к LocalDB*
11. Откройте базу данных **жееккуизпрод** и разверните узел **таблицы** . Как видите, команда **Update-Database** создала все таблицы, определенные в классе **тривиаконтекст** . Нахождение **dbo. Тривиакуестионс** таблицу и откройте узел столбцы. В следующей задаче вы добавите новый столбец в эту таблицу и обновите базу данных с помощью **миграции**.

    ![Столбцы вопросов Trivia](maintainable-azure-websites-managing-change-and-scale/_static/image7.png "Столбцы вопросов Trivia")

    *Столбцы вопросов Trivia*

<a id="Ex1Task2"></a>
#### <a name="task-2--updating-database-schema-using-migrations"></a>Задача 2. обновление схемы базы данных с помощью миграций

В этой задаче вы будете использовать **Entity Framework Code First migrations** для обнаружения изменений в модели и создания кода, необходимого для обновления базы данных. Сущность **тривиакуестионс** будет обновлена путем добавления в нее нового свойства. Затем предстоит выполнить команды для создания новой миграции, чтобы включить новый столбец в таблицу.

1. В **Обозреватель решений**дважды щелкните файл **TriviaQuestion.CS** , расположенный в папке **Models** .
2. Добавьте новое свойство с именем " **Указание**", как показано в следующем фрагменте кода.

    [!code-csharp[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample4.cs)]
3. В **консоли диспетчера пакетов**введите следующую команду и нажмите клавишу **Ввод**. Будет создана новая миграция, отражающая изменение в нашей модели.

    [!code-powershell[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample5.ps1)]

    ![Добавление и миграция](maintainable-azure-websites-managing-change-and-scale/_static/image8.png "Добавление и миграция")

    *Добавление и миграция*

    > [!NOTE]
    > Файл миграции состоит из двух методов: **вверх** и **вниз**.
    >
    > - Метод **up** будет использоваться для указания изменений, которые должна применить Текущая версия нашего приложения к базе данных.
    > - **Стрелка вниз** используется для отмены изменений, добавленных в метод **up** .
    >
    > Когда база данных выполняет миграцию, она запускает все миграции в порядке отметок времени и только те, которые не использовались с момента последнего обновления (\_таблица Мигратионхистори отслеживает, какие миграции были применены). Метод **up** всех миграций будет вызван и внесет изменения, указанные в базе данных. Если мы решили вернуться к предыдущей миграции, будет вызван метод **Down** для возврата изменений в обратном порядке.
4. В **консоли диспетчера пакетов**введите следующую команду и нажмите клавишу **Ввод**.

    [!code-powershell[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample6.ps1)]
5. Выходные данные команды **Update-Database** создавали инструкцию SQL **ALTER TABLE** для добавления нового столбца в таблицу **тривиакуестионс** , как показано на рисунке ниже.

    ![Добавление созданного столбца инструкции SQL](maintainable-azure-websites-managing-change-and-scale/_static/image9.png "Добавление созданного столбца инструкции SQL")

    *Добавление созданного столбца инструкции SQL*
6. В **Обозреватель объектов SQL Server**обновите **dbo. Тривиакуестионс** таблицу и убедитесь, что новый столбец **подсказок** отображается.

    ![Отображение нового столбца подсказок](maintainable-azure-websites-managing-change-and-scale/_static/image10.png "Отображение нового столбца подсказок")

    *Отображение нового столбца подсказок*
7. Вернувшись в редактор **TriviaQuestion.CS** , добавьте ограничение **StringLength** *к свойству* указания, как показано в следующем фрагменте кода.

    [!code-csharp[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample7.cs)]
8. В **консоли диспетчера пакетов**введите следующую команду и нажмите клавишу **Ввод**.

    [!code-powershell[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample8.ps1)]
9. В **консоли диспетчера пакетов**введите следующую команду и нажмите клавишу **Ввод**.

    [!code-powershell[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample9.ps1)]
10. Выходные данные команды **Update-Database** создавали инструкцию SQL **ALTER TABLE** для обновления типа столбца *подсказок* таблицы **тривиакуестионс** , как показано на рисунке ниже.

    ![Инструкция SQL ALTER COLUMN Generated](maintainable-azure-websites-managing-change-and-scale/_static/image11.png "Инструкция SQL ALTER COLUMN Generated")

    *Инструкция SQL ALTER COLUMN Generated*
11. В **Обозреватель объектов SQL Server**обновите **dbo. Тривиакуестионс** таблица и проверьте, что тип столбца **подсказки** — **nvarchar (150)** .

    ![Отображение нового ограничения](maintainable-azure-websites-managing-change-and-scale/_static/image12.png "Отображение нового ограничения")

    *Отображение нового ограничения*

<a id="Exercise2"></a>
### <a name="exercise-2-deploying-a-web-app-to-staging"></a>Упражнение 2. Развертывание веб-приложения для промежуточного хранения

**Веб-приложения в службе приложений Azure** позволяют выполнять промежуточную публикацию. Поэтапная публикация создает слот промежуточного сайта для каждого рабочего сайта по умолчанию и позволяет поменять местами эти слоты без простоя. Это действительно полезно для проверки изменений перед выпуском в общедоступной, постепенной интеграции содержимого сайта и отката, если изменения не работают должным образом.

В этом упражнении вы развернете приложение " **головоломка** " в промежуточной среде веб-приложения с помощью системы управления версиями Git. Для этого необходимо создать веб-приложение и подготовить необходимые компоненты на портале управления, настроить репозиторий **Git** и отправить исходный код приложения с локального компьютера в промежуточный слот. Вы также обновите рабочую базу данных с помощью **Code First migrations** , созданного в предыдущем упражнении. Затем приложение будет выполняться в этой тестовой среде для проверки его работы. Если вы удовлетворены работой в соответствии с ожиданиями, вы сможете повысить уровень приложения до рабочей среды.

> [!NOTE]
> Чтобы включить промежуточную публикацию, веб-приложение должно работать в **стандартном режиме**. Обратите внимание, что при переходе веб-приложения в стандартный режим будут взиматься дополнительные расходы. Дополнительные сведения о ценах см. на странице [цен на службу приложений](https://azure.microsoft.com/pricing/details/app-service/).

<a id="Ex2Task1"></a>
#### <a name="task-1--creating-a-web-app-in-azure-app-service"></a>Задача 1. Создание веб-приложения в службе приложений Azure

В этой задаче вы создадите веб-приложение в **службе приложений Azure** на портале управления. Вы также настроите **базу данных SQL** для хранения данных приложения и настроите локальный репозиторий Git для системы управления версиями.

1. Перейдите на [портал управления Azure](https://manage.windowsazure.com) и выполните вход с помощью учетная запись Майкрософт, связанного с вашей подпиской.

    ![Вход на портал управления Azure](maintainable-azure-websites-managing-change-and-scale/_static/image13.png)

    *Вход на портал управления Azure*
2. Щелкните **создать** на панели команд в нижней части страницы.

    ![Создание нового веб-приложения](maintainable-azure-websites-managing-change-and-scale/_static/image14.png "Создание нового веб-приложения")

    *Создание нового веб-приложения*
3. Щелкните **Вычисление**, **веб-сайт** , а затем **настраиваемое создание**.

    ![Создание нового веб-приложения с помощью настраиваемого создания](maintainable-azure-websites-managing-change-and-scale/_static/image15.png "Создание нового веб-приложения с помощью настраиваемого создания")

    *Создание нового веб-приложения с помощью настраиваемого создания*
4. В диалоговом окне **новый веб-сайт — настраиваемое создание** укажите доступный **URL-адрес** (например, "сотрудник *-Викторина*"), выберите расположение в раскрывающемся списке **регион** и выберите **создать новую базу данных SQL** в раскрывающемся списке **база данных** . Наконец, установите флажок **опубликовать из системы управления версиями** и нажмите кнопку **Далее**.

    ![Настройка нового веб-приложения](maintainable-azure-websites-managing-change-and-scale/_static/image16.png)

    *Настройка нового веб-приложения*
5. Укажите следующие сведения для параметров базы данных.

   - В текстовом поле **имя** введите имя базы данных (например, *жееккуиз\_DB*).
   - В раскрывающемся **списке сервер** выберите **новый сервер базы данных SQL**. Кроме того, можно выбрать существующий сервер.
   - В полях **имя пользователя базы данных** и **пароль базы данных** введите имя пользователя и пароль администратора для сервера базы данных SQL. Если вы выбрали уже созданный сервер, появится запрос на ввод пароля.

     ![Указание параметров базы данных](maintainable-azure-websites-managing-change-and-scale/_static/image17.png)

     *Указание параметров базы данных*
6. Чтобы продолжить, нажмите кнопку **Далее** .
7. Выберите **локальный репозиторий Git** для использования системы управления версиями и нажмите кнопку **Далее**.

    > [!NOTE]
    > Может появиться запрос на ввод учетных данных развертывания (имя пользователя и пароль).

    ![Создание репозитория Git](maintainable-azure-websites-managing-change-and-scale/_static/image18.png)

    *Создание репозитория Git*
8. Дождитесь создания нового веб-приложения.

    > [!NOTE]
    > По умолчанию Azure предоставляет домены на сайте *azurewebsites.NET* , но также дает возможность задать личные домены с помощью портала управления Azure. Однако вы можете управлять только пользовательскими доменами, если вы используете определенные режимы службы приложений Azure.
    >
    > Служба приложений Azure доступна в выпусках Free, Shared, Basic, Standard и Premium. В режиме "бесплатный" и "общий" все веб-приложения работают в среде с несколькими клиентами и имеют квоты для ЦП, памяти и использования сети. Максимальное количество бесплатных приложений может отличаться в зависимости от вашего плана. В стандартном режиме вы выбираете, какие приложения выполняются на выделенных виртуальных машинах, соответствующих стандартным ресурсам вычислений Azure. Конфигурацию режима веб-приложения можно найти в меню **масштаб** веб-приложения.
    >
    > ![Режимы службы приложений Azure](maintainable-azure-websites-managing-change-and-scale/_static/image19.png "Режимы службы приложений Azure")
    >
    > Если вы используете режим " **Общий** " или " **стандартный** ", вы сможете управлять личными доменами для веб-приложения, перейдя в меню " **Настройка** " приложения и выбрав пункт " **Управление доменами** " в разделе " *имена доменов*".
    >
    > ![Управление доменами](maintainable-azure-websites-managing-change-and-scale/_static/image20.png "Управление доменами")
    >
    > ![Управление пользовательскими доменами](maintainable-azure-websites-managing-change-and-scale/_static/image21.png "Управление пользовательскими доменами")
9. После создания веб-приложения щелкните ссылку в столбце **URL-адрес** , чтобы проверить, работает ли новое веб-приложение.

    ![Обзор нового веб-приложения](maintainable-azure-websites-managing-change-and-scale/_static/image22.png)

    *Обзор нового веб-приложения*

    ![веб-приложение работает](maintainable-azure-websites-managing-change-and-scale/_static/image23.png)

    *веб-приложение работает*

<a id="Ex2Task2"></a>
#### <a name="task-2--creating-the-production-sql-database"></a>Задача 2. Создание рабочей базы данных SQL

В этой задаче вы будете использовать **Entity Framework Code First migrations** , чтобы создать базу данных, предназначенную для экземпляра **базы данных SQL Azure** , созданного в предыдущей задаче.

1. В портал управления перейдите к веб-приложению, созданному в предыдущей задаче, и перейдите на соответствующую **панель мониторинга**.
2. На странице **панель мониторинга** щелкните ссылку **просмотреть строки подключения** в разделе **краткий обзор** .

    ![Просмотр строк подключения](maintainable-azure-websites-managing-change-and-scale/_static/image24.png "Просмотр строк подключения")

    *Просмотр строк подключения*
3. Скопируйте значение **строки подключения** и закройте диалоговое окно.

    ![Строка подключения в портал управления Azure](maintainable-azure-websites-managing-change-and-scale/_static/image25.png "Строка подключения в портал управления Azure")

    *Строка подключения в портал управления Azure*
4. Щелкните " **базы данных SQL** ", чтобы просмотреть список баз данных SQL в Azure.

    ![Меню базы данных SQL](maintainable-azure-websites-managing-change-and-scale/_static/image26.png "Меню базы данных SQL")

    *Меню базы данных SQL*
5. Выберите базу данных, созданную в предыдущей задаче, и щелкните сервер.

    ![Сервер базы данных SQL](maintainable-azure-websites-managing-change-and-scale/_static/image27.png "Сервер базы данных SQL")

    *Сервер базы данных SQL*
6. На странице **быстрое начало** сервера щелкните **настроить**.

    ![Меню настройки](maintainable-azure-websites-managing-change-and-scale/_static/image28.png "Меню настройки")

    *Меню настройки*
7. В разделе **Разрешенные IP-адреса** нажмите кнопку **Добавить в раздел разрешенные IP-адреса** , чтобы разрешить вашему IP-адресу подключаться к серверу базы данных SQL.

    ![Разрешенные IP-адреса](maintainable-azure-websites-managing-change-and-scale/_static/image29.png "Разрешенные IP-адреса")

    *Разрешенные IP-адреса*
8. Чтобы завершить шаг, нажмите кнопку **Сохранить** в нижней части страницы.
9. Вернитесь в Visual Studio.
10. В **консоли диспетчера пакетов**выполните следующую команду, заменив заполнитель *[a-Connection-String]* строкой подключения, скопированной из Azure.

    [!code-powershell[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample10.ps1)]

    ![Обновление базы данных, предназначенной для базы данных SQL Windows Azure](maintainable-azure-websites-managing-change-and-scale/_static/image30.png "Обновление базы данных, предназначенной для базы данных SQL Windows Azure")

    *Обновление базы данных, предназначенной для базы данных SQL Azure*

<a id="Ex2Task3"></a>
#### <a name="task-3--deploying-geek-quiz-to-staging-using-git"></a>Задача 3. Развертывание головоломки для подготовки к промежуточному хранению с помощью Git

В этой задаче будет включена промежуточная публикация в веб-приложении. Затем вы будете использовать Git для публикации приложения для головоломки на основе вашего локального компьютера в промежуточную среду веб-приложения.

1. Вернитесь на портал и щелкните имя веб-приложения в столбце **имя** , чтобы отобразить страницы управления.

    ![Открытие страниц управления веб-приложениями](maintainable-azure-websites-managing-change-and-scale/_static/image31.png)

    *Открытие страниц управления веб-приложениями*
2. Перейдите на страницу **шкалы** . В разделе **Общие** выберите **стандартный** для конфигурации и нажмите кнопку **сохранить** на панели команд.

    > [!NOTE]
    > Чтобы запустить все веб-приложения в текущем регионе и подписке в **стандартном** режиме, оставьте флажок **выбрать все** , установленный в конфигурации **Выбор сайтов** . В противном случае снимите флажок " **выбрать все** ".

    ![Обновление веб-приложения до стандартного режима](maintainable-azure-websites-managing-change-and-scale/_static/image32.png "Обновление веб-приложения до стандартного режима")

    *Обновление веб-приложения до стандартного режима*
3. Нажмите кнопку **Да** , чтобы подтвердить изменения.

    ![Подтверждение изменения в стандартном режиме](maintainable-azure-websites-managing-change-and-scale/_static/image33.png "Продолжение изменения режима веб-приложения")

    *Подтверждение изменения в стандартном режиме*
4. Перейдите на страницу **панели мониторинга** и щелкните **включить промежуточную публикацию** в разделе **краткий обзор** .

    ![Включение промежуточной публикации](maintainable-azure-websites-managing-change-and-scale/_static/image34.png "Включение промежуточной публикации")

    *Включение промежуточной публикации*
5. Нажмите кнопку **Да** , чтобы включить промежуточную публикацию.

    ![Подтверждение промежуточной публикации](maintainable-azure-websites-managing-change-and-scale/_static/image35.png "Нажмите кнопку Да, чтобы включить промежуточную публикацию")

    *Подтверждение промежуточной публикации*
6. В списке веб-приложений разверните метку слева от имени веб-приложения, чтобы отобразить промежуточный слот сайта. Он содержит имя веб-приложения, за которым следует ***(промежуточное хранение)***. Щелкните промежуточный сайт, чтобы открыть страницу управления.

    ![Переход к промежуточному веб-приложению](maintainable-azure-websites-managing-change-and-scale/_static/image36.png "Переход к промежуточному веб-приложению")

    *Переход к промежуточному приложению*
7. Обратите внимание, что страница управления выглядит как любая другая страница управления веб-приложением. Перейдите на страницу **развертывания** и скопируйте значение **URL-адреса Git** . Он будет использоваться позже в этом упражнении.

    ![Копирование значения URL-адреса Git](maintainable-azure-websites-managing-change-and-scale/_static/image37.png)

    *Копирование значения URL-адреса Git*
8. Откройте новую консоль **Git Bash** и выполните следующие команды. Измените заполнитель *[My-Application-path]* на путь к решению **жееккуиз** , расположенному в папке **Source\Ex1-DeployingWebSiteToStaging\Begin** этой лабораторной работы.

    [!code-console[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample11.cmd)]

    ![Инициализация Git и первая фиксация](maintainable-azure-websites-managing-change-and-scale/_static/image38.png)

    *Инициализация Git и первая фиксация*
9. Выполните следующую команду, чтобы отправить веб-приложение в удаленный репозиторий **Git** . Замените заполнитель URL-адресом, полученным на портале управления. Вам будет предложено ввести пароль развертывания.

    [!code-console[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample12.cmd)]

    ![Принудительная отправка в Windows Azure](maintainable-azure-websites-managing-change-and-scale/_static/image39.png)

    *Отправка в Azure*

    > [!NOTE]
    > При развертывании содержимого на узле FTP или в репозитории GIT веб-приложения необходимо пройти проверку подлинности с помощью **учетных данных развертывания** , созданных на **быстрое начало** или на страницах управления **панели мониторинга** веб-приложения. Если вы не знакомы с учетными данными развертывания, их можно легко сбросить с помощью портала управления. Откройте страницу **панели мониторинга** веб-приложения и щелкните ссылку **сбросить учетные данные развертывания** . Укажите новый пароль и нажмите кнопку **ОК**. Учетные данные развертывания допустимы для использования со всеми веб-приложениями, связанными с вашей подпиской.
10. Чтобы убедиться, что веб-приложение успешно отправлено в Azure, вернитесь на портал управления и щелкните **веб-сайты**.
11. Откройте веб-приложение и разверните запись, чтобы отобразить слот промежуточного сайта. Щелкните его **имя** , чтобы открыть страницу управления.
12. Щелкните **развертывания** , чтобы просмотреть **журнал развертывания**. Убедитесь, что имеется **активное развертывание** с *&quot;начальной фиксацией&quot;* .

    ![Активное развертывание](maintainable-azure-websites-managing-change-and-scale/_static/image40.png)

    *Активное развертывание*
13. Наконец, нажмите кнопку **Обзор** на панели команд, чтобы перейти к веб-приложению.

    ![Обзор веб-приложения](maintainable-azure-websites-managing-change-and-scale/_static/image41.png)

    *Обзор веб-приложения*
14. Если приложение успешно развернуто, вы увидите страницу входа в викторину.

    > [!NOTE]
    > URL-адрес развернутого приложения содержит имя веб-приложения, за которым следует *промежуточное хранение*.

    ![Приложение, выполняющееся в промежуточной среде](maintainable-azure-websites-managing-change-and-scale/_static/image42.png)

    *Приложение, выполняющееся в промежуточной среде*
15. Если вы хотите изучить приложение, нажмите кнопку **Регистрация** , чтобы зарегистрировать нового пользователя. Заполните сведения об учетной записи, введя имя пользователя, адрес электронной почты и пароль. Затем в приложении отображается первый вопрос головоломки. Ответьте на несколько вопросов, чтобы убедиться, что она работает правильно.

    ![Приложение готово к использованию](maintainable-azure-websites-managing-change-and-scale/_static/image43.png)

    *Приложение готово к использованию*

<a id="Ex2Task4"></a>
#### <a name="task-4--promoting-the-web-app-to-production"></a>Задача 4. повышение уровня веб-приложения до рабочей среды

Теперь, убедившись, что веб-приложение правильно работает в промежуточной среде, вы можете повысить его уровень до рабочей среды. В этой задаче слот промежуточного сайта будет заменен слотом рабочего сайта.

1. Вернитесь на портал управления и выберите слот промежуточного сайта. Нажмите кнопку **поменять местами** на панели команд.

    ![Переключение на рабочую среду](maintainable-azure-websites-managing-change-and-scale/_static/image44.png)

    *Переключение на рабочую среду*
2. Нажмите кнопку **Да** в диалоговом окне подтверждения, чтобы продолжить операцию переключения. Azure немедленно заменит содержимое рабочего сайта содержимым промежуточного сайта.

    > [!NOTE]
    > Некоторые параметры из промежуточной версии будут автоматически скопированы в рабочую версию (например, переопределения строк подключения, сопоставления обработчиков и т. д.), но другие параметры не изменятся (например, конечные точки DNS, SSL-привязки и т. д.).

    ![Подтверждение операции переключения](maintainable-azure-websites-managing-change-and-scale/_static/image45.png)

    *Подтверждение операции переключения*
3. После завершения переключения выберите Рабочий слот и нажмите кнопку **Обзор** на панели команд, чтобы открыть рабочий сайт. Обратите внимание на URL-адрес в адресной строке.

    > [!NOTE]
    > Возможно, потребуется обновить браузер, чтобы очистить кэш. В Internet Explorer это можно сделать, нажав клавиши **CTRL + R**.

    ![Веб-приложение, работающее в рабочей среде](maintainable-azure-websites-managing-change-and-scale/_static/image46.png)
4. В консоли **GitBash** обновите удаленный URL-адрес для локального репозитория Git, чтобы он был предназначен для рабочего слота. Для этого выполните следующую команду, заменив заполнители именем пользователя развертывания и именем своего веб-приложения.

    > [!NOTE]
    > В следующих упражнениях вы отправите изменения на рабочий сайт, а не на промежуточное хранение только для простоты лабораторий. В реальном сценарии рекомендуется проверять изменения в промежуточной среде перед повышением уровня рабочей среды.

    [!code-console[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample13.cmd)]

<a id="Exercise3"></a>
### <a name="exercise-3-performing-deployment-rollback-in-production"></a>Упражнение 3. Выполнение отката развертывания в рабочей среде

Существуют сценарии, в которых нет промежуточного слота для выполнения оперативного переключения между промежуточным и рабочим режимом, например, при работе в режиме " **бесплатный** " или " **Общий** ". В этих сценариях вы должны протестировать приложение в среде тестирования локально или на удаленном сайте перед развертыванием в рабочую среду. Однако возможно, что на рабочем сайте может возникнуть ошибка, не определенная на этапе тестирования. В этом случае важно иметь механизм, позволяющий легко переключаться на предыдущую и стабильную версию приложения как можно быстрее.

В **службе приложений Azure**непрерывное развертывание из системы управления версиями делает это возможным благодаря действию **повторного развертывания** , доступному на портале управления. Azure отслеживает развертывания, связанные с фиксациями, отправленными в репозиторий, и предоставляет возможность повторного развертывания приложения с помощью любого из предыдущих развертываний в любое время.

В этом упражнении будет выполнено изменение кода в приложении " **головоломка** ", которое намеренно внедряет *ошибку*. Вы развернете приложение в рабочей среде, чтобы увидеть ошибку, а затем будете использовать функцию повторного развертывания, чтобы вернуться к предыдущему состоянию.

<a id="Ex3Task1"></a>
#### <a name="task-1--updating-the-geek-quiz-application"></a>Задача 1. Обновление приложения для головоломки

В этой задаче предстоит выполнить рефакторинг небольшой части кода класса **тривиаконтроллер** , чтобы извлечь часть логики, которая извлекает выбранный параметр головоломки из базы данных в новый метод.

1. Переключитесь на экземпляр Visual Studio с помощью решения **жееккуиз** из предыдущего упражнения.
2. В **Обозреватель решений**откройте файл **TriviaController.CS** в папке **Controllers** .
3. Перейдите к методу **стореасинк** и выберите код, выделенный на следующем рисунке.

    ![Выбор кода](maintainable-azure-websites-managing-change-and-scale/_static/image47.png)

    *Выбор кода*
4. Щелкните правой кнопкой мыши выделенный код, разверните меню **Рефакторинг** и выберите пункт **извлечь метод...** .

    ![Извлечение кода как нового метода](maintainable-azure-websites-managing-change-and-scale/_static/image48.png)

    *Выбор метода извлечения*
5. В диалоговом окне **Извлечение метода** назовите новый метод *матчесоптион* и нажмите кнопку **ОК**.

    ![Указание имени метода](maintainable-azure-websites-managing-change-and-scale/_static/image49.png)

    *Указание имени для извлеченного метода*
6. Затем выбранный код извлекается в метод **матчесоптион** . Полученный код показан в следующем фрагменте кода.

    [!code-csharp[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample14.cs)]
7. Нажмите клавиши **CTRL + S** , чтобы сохранить изменения.

<a id="Ex3Task2"></a>
#### <a name="task-2--redeploying-the-geek-quiz-application"></a>Задача 2. повторное развертывание приложения для головоломки

Теперь изменения, внесенные в предыдущей задаче, будут отправлены в репозиторий, что приведет к активации нового развертывания в рабочей среде. Затем вы устранятьи проблемы с помощью **средств разработки F12** , предоставляемых Internet Explorer, а затем выполните откат к предыдущему развертыванию на портале управления Azure.

1. Откройте новую консоль **Git Bash** , чтобы развернуть обновленное приложение в службе приложений Azure.
2. Выполните следующие команды, чтобы отправить изменения в Azure. Замените заполнитель *[My-Application-path]* на путь к решению **жееккуиз** . Вам будет предложено ввести пароль развертывания.

    [!code-console[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample15.cmd)]

    ![Принудительная отправка оптимизированного кода в Azure](maintainable-azure-websites-managing-change-and-scale/_static/image50.png)

    *Принудительная отправка оптимизированного кода в Azure*
3. Откройте Internet Explorer и перейдите к своему веб-приложению (например, `http://<your-web-site>.azurewebsites.net`). Войдите в систему, используя ранее созданные учетные данные.
4. Нажмите клавишу **F12** , чтобы запустить средства разработки, перейдите на вкладку **сеть** и нажмите кнопку **Воспроизведение** , чтобы начать запись.

    ![Запуск записи в сеть](maintainable-azure-websites-managing-change-and-scale/_static/image51.png "Запуск записи в сеть")

    *Запуск записи в сеть*
5. Выберите любой вариант головоломки. Вы увидите, что ничего не происходит.
6. В окне **F12** запись, СООТВЕТСТВУЮЩая HTTP-запросу POST, показывает результат HTTP **500** .

    ![Ошибка HTTP 500](maintainable-azure-websites-managing-change-and-scale/_static/image52.png)

    *Ошибка HTTP 500*
7. Перейдите на вкладку **консоль** . В журнал заносится ошибка с описанием причины.

    ![Зарегистрированная ошибка](maintainable-azure-websites-managing-change-and-scale/_static/image53.png)

    *Зарегистрированная ошибка*
8. Нахождение подробной части ошибки. Очевидно, что эта ошибка вызвана оптимизацией кода, которую Вы зафиксировали на предыдущих шагах.

    `Details: LINQ to Entities does not recognize the method 'Boolean MatchesOption ...`.
9. Не закрывайте браузер.
10. В новом экземпляре браузера перейдите на [портал управления Azure](https://manage.windowsazure.com) и выполните вход с помощью учетная запись Майкрософт, связанного с вашей подпиской.
11. Выберите **сайты** и щелкните веб-приложение, созданное в упражнении 2.
12. Перейдите на страницу **развертывания** . Обратите внимание, что все выполненные фиксации перечислены в журнале развертывания.

    ![Список существующих развертываний](maintainable-azure-websites-managing-change-and-scale/_static/image54.png)

    *Список существующих развертываний*
13. Выберите предыдущую фиксацию и нажмите кнопку **Повторное развертывание** на панели команд.

    ![Повторное развертывание предыдущей фиксации](maintainable-azure-websites-managing-change-and-scale/_static/image55.png)

    *Повторное развертывание предыдущей фиксации*
14. При появлении запроса на подтверждение щелкните **Yes**(Да).

    ![Подтверждение повторного развертывания](maintainable-azure-websites-managing-change-and-scale/_static/image56.png)
15. После завершения развертывания переключитесь обратно на экземпляр браузера с помощью веб-приложения и нажмите клавиши **CTRL + F5**.
16. Щелкните любой из параметров. Теперь будет отображена анимация отражения, и отобразится результат (*правильно или неправильно*).
17. Используемых Перейдите в консоль **Git Bash** и выполните следующие команды, чтобы вернуться к предыдущей фиксации.

    > [!NOTE]
    > Эти команды создают новую фиксацию, которая отменяет все изменения в репозитории Git, которые были сделаны в результате неудачной фиксации. Azure выполнит повторное развертывание приложения с помощью новой фиксации.

    [!code-console[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample16.cmd)]

<a id="Exercise4"></a>
### <a name="exercise-4-scaling-using-azure-storage"></a>Упражнение 4. масштабирование с помощью службы хранилища Azure

**Большие двоичные объекты** — это самый простой способ хранения больших объемов неструктурированных текстовых или двоичных данных, таких как видео, аудио и изображения. Перемещение статического содержимого приложения в хранилище помогает масштабировать приложение путем обслуживания изображений или документов непосредственно в браузере.

В этом упражнении вы переместит статическое содержимое приложения в контейнер больших двоичных объектов. Затем вы настроите приложение, чтобы добавить **правило переопределения URL-адресов ASP.NET** в **файле Web. config** для перенаправления содержимого в контейнер больших двоичных объектов.

<a id="Ex4Task1"></a>
#### <a name="task-1--creating-an-azure-storage-account"></a>Задача 1. Создание учетной записи хранения Azure

В этой задаче вы узнаете, как создать новую учетную запись хранения с помощью портала управления.

1. Перейдите на [портал управления Azure](https://manage.windowsazure.com) и выполните вход с помощью учетная запись Майкрософт, связанного с вашей подпиской.
2. Выберите " **создать" | Службы данных | Хранилище | Быстрое создание** , чтобы начать создание новой учетной записи хранения. Введите уникальное имя учетной записи и выберите **регион** из списка. Чтобы продолжить, щелкните **создать учетную запись хранения** .

    ![Создание новой учетной записи хранения](maintainable-azure-websites-managing-change-and-scale/_static/image57.png "Создание новой учетной записи хранения")

    *Создание новой учетной записи хранения*
3. В разделе " **хранилище** " дождитесь, пока состояние новой учетной записи хранения изменится на "в *сети* ", чтобы продолжить выполнение следующего шага.

    ![Учетная запись хранения создана](maintainable-azure-websites-managing-change-and-scale/_static/image58.png "Учетная запись хранения создана")

    *Учетная запись хранения создана*
4. Щелкните имя учетной записи хранения, а затем щелкните ссылку на **панель мониторинга** в верхней части страницы. На странице **панель мониторинга** представлены сведения о состоянии учетной записи и конечных точек службы, которые могут использоваться в приложениях.

    ![Отображение панели мониторинга учетной записи хранения](maintainable-azure-websites-managing-change-and-scale/_static/image59.png "Отображение панели мониторинга учетной записи хранения")

    *Отображение панели мониторинга учетной записи хранения*
5. Нажмите кнопку **Управление ключами доступа** на панели навигации.

    ![Кнопка "Управление ключами доступа"](maintainable-azure-websites-managing-change-and-scale/_static/image60.png "Кнопка "Управление ключами доступа"")

    *Кнопка "Управление ключами доступа"*
6. В диалоговом окне **Управление ключами доступа** скопируйте **имя учетной записи хранения** и **первичный ключ доступа** , которые понадобятся вам в следующем упражнении. Затем закройте диалоговое окно.

    ![Диалоговое окно «Управление ключом доступа»](maintainable-azure-websites-managing-change-and-scale/_static/image61.png "Диалоговое окно «Управление ключом доступа»")

    *Диалоговое окно «Управление ключом доступа»*

<a id="Ex4Task2"></a>
#### <a name="task-2--uploading-an-asset-to-azure-blob-storage"></a>Задача 2. Передача ресурса в хранилище BLOB-объектов Azure

В этой задаче вы будете использовать окно обозреватель сервера из Visual Studio для подключения к учетной записи хранения. Затем вы создадите контейнер больших двоичных объектов и загрузили файл с логотипом "головоломка" в контейнер.

1. Переключитесь на экземпляр Visual Studio с помощью решения **жееккуиз** из предыдущего упражнения.
2. В строке меню выберите **вид** и щелкните **Обозреватель сервера**.
3. В **Обозреватель сервера**щелкните правой кнопкой мыши узел **Azure** и выберите **подключиться к Azure..** .. Войдите с помощью учетная запись Майкрософт, связанного с вашей подпиской.

    ![Подключение к Windows Azure](maintainable-azure-websites-managing-change-and-scale/_static/image62.png)

    *Подключение к Azure*
4. Разверните узел **Azure** , щелкните правой кнопкой мыши **хранилище** и выберите **подключить внешнее хранилище.** ...
5. В диалоговом окне **Добавление новой учетной записи хранения** введите **имя учетной** записи и **ключ учетной записи** , полученные в предыдущей задаче, и нажмите кнопку **ОК**.

    ![Диалоговое окно "Добавление новой учетной записи хранения"](maintainable-azure-websites-managing-change-and-scale/_static/image63.png)

    *Диалоговое окно "Добавление новой учетной записи хранения"*
6. Ваша учетная запись хранения должна отображаться в узле " **хранилище** ". Разверните учетную запись хранения, щелкните правой кнопкой мыши **BLOB-объекты** и выберите **создать контейнер BLOB-объектов.**

    ![Создание контейнера больших двоичных объектов](maintainable-azure-websites-managing-change-and-scale/_static/image64.png "Создание контейнера больших двоичных объектов")

    *Создание контейнера больших двоичных объектов*
7. В диалоговом окне **Создание контейнера больших двоичных объектов** введите имя для контейнера больших двоичных объектов и нажмите кнопку **ОК**.

    ![Диалоговое окно "Создание контейнера больших двоичных объектов"](maintainable-azure-websites-managing-change-and-scale/_static/image65.png "Диалоговое окно "Создание контейнера больших двоичных объектов"")

    *Диалоговое окно "Создание контейнера больших двоичных объектов"*
8. Новый контейнер больших двоичных объектов должен быть добавлен в узел **BLOB-объектов** . Измените разрешения доступа в контейнере, чтобы сделать контейнер открытым. Для этого щелкните правой кнопкой мыши контейнер **изображения** и выберите пункт **свойства**.

    ![свойства контейнера изображений](maintainable-azure-websites-managing-change-and-scale/_static/image66.png "свойства контейнера изображений")

    *Свойства контейнера изображений*
9. В окне **Свойства** установите **общий доступ на чтение** к **контейнеру**.

    ![Изменение свойства общего доступа для чтения](maintainable-azure-websites-managing-change-and-scale/_static/image67.png "Изменение свойства общего доступа для чтения")

    *Изменение свойства общего доступа для чтения*
10. При появлении запроса в случае, если вы уверены, что хотите изменить свойство общего доступа, нажмите кнопку **Да**.

    ![Предупреждение Microsoft Visual Studio](maintainable-azure-websites-managing-change-and-scale/_static/image68.png "Предупреждение Microsoft Visual Studio")

    *Предупреждение Microsoft Visual Studio*
11. В **Обозреватель сервера**щелкните правой кнопкой мыши контейнер BLOB-объектов **Images** и выберите пункт **Просмотр контейнера больших двоичных объектов**.

    ![Просмотр контейнера больших двоичных объектов](maintainable-azure-websites-managing-change-and-scale/_static/image69.png "Просмотр контейнера больших двоичных объектов")

    *Просмотр контейнера больших двоичных объектов*
12. Контейнер изображений должен открываться в новом окне, и условные обозначения без записей должны отображаться. Щелкните значок **отправки** , чтобы отправить файл в контейнер больших двоичных объектов.

    ![Контейнер изображений без записей](maintainable-azure-websites-managing-change-and-scale/_static/image70.png "Контейнер изображений без записей")

    *Контейнер изображений без записей*
13. В диалоговом окне **Отправка большого двоичного объекта** перейдите в папку **Assets** лаборатории. Выберите файл **лого-БиГ. png** и нажмите кнопку **Открыть**.
14. Дождитесь отправки файла. После завершения передачи файл должен быть указан в контейнере Images. Щелкните правой кнопкой мыши запись файла и выберите **Копировать URL-адрес**.

    ![Копировать URL-адрес большого двоичного объекта](maintainable-azure-websites-managing-change-and-scale/_static/image71.png "Копировать URL-адрес файла большого двоичного объекта")

    *Копировать URL-адрес большого двоичного объекта*
15. Откройте Internet Explorer и вставьте URL-адрес. В браузере должен отображаться следующий рисунок.

    ![изображение лого-БиГ. png из хранилища BLOB-объектов Windows](maintainable-azure-websites-managing-change-and-scale/_static/image72.png "изображение лого-БиГ. png из хранилища")

    *изображение лого-БиГ. png из хранилища BLOB-объектов Azure*

<a id="Ex4Task3"></a>
#### <a name="task-3--updating-the-solution-to-consume-static-content-from-azure-blob-storage"></a>Задача 3. Обновление решения для использования статического содержимого из хранилища BLOB-объектов Azure

В этой задаче вы настроите решение **жееккуиз** для использования изображения, отправленного в хранилище BLOB-объектов Azure (вместо образа, расположенного в веб – приложении), добавив в файл **Web. config** правило перезаписи URL-адресов ASP.NET.

1. В Visual Studio откройте файл **Web. config** в проекте **жееккуиз** и выберите элемент **&lt;System.&gt;** .
2. Добавьте следующий код, чтобы добавить правило переопределения URL-адресов, обновив заполнитель именем учетной записи хранения.

    (Фрагмент кода — *вебситесинпродуктион-EX4-урлревритеруле*)

    [!code-xml[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample17.xml)]

    > [!NOTE]
    > Переписывание URL-адресов — это процесс перехвата входящего веб-запроса и перенаправления запроса другому ресурсу. Правила переопределения URL-адресов сообщают подсистеме перезаписи о необходимости перенаправления запроса, а также место, где они должны перенаправляться. Правило перезаписи состоит из двух строк: шаблона для поиска в запрошенном URL-адресе (обычно с помощью регулярных выражений) и строки для замены шаблона, если он найден. Дополнительные сведения см. [в разделе перезапись URL-адресов в ASP.NET](https://msdn.microsoft.com/library/ms972974.aspx).
3. Нажмите клавиши **CTRL + S** , чтобы сохранить изменения.
4. Откройте новую консоль **Git Bash** , чтобы развернуть обновленное приложение в службе приложений Azure.
5. Выполните следующие команды, чтобы отправить изменения в Azure. Замените заполнитель *[My-Application-path]* на путь к решению **жееккуиз** . Вам будет предложено ввести пароль развертывания.

    [!code-console[Main](maintainable-azure-websites-managing-change-and-scale/samples/sample18.cmd)]

    ![Развертывание обновления в Azure](maintainable-azure-websites-managing-change-and-scale/_static/image73.png)

    *Развертывание обновления в Azure*

<a id="Ex4Task4"></a>
#### <a name="task-4--verification"></a>Задача 4 — Проверка

В этой задаче вы будете использовать **Internet Explorer** для просмотра приложения " **викторина по владению** " и проверки того, что правило переопределения URL-адресов для образов работает и вы будете перенаправлены к образу, размещенному в **хранилище больших двоичных объектов Azure**.

1. Откройте Internet Explorer и перейдите к своему веб-приложению (например, `http://<your-web-site>.azurewebsites.net`). Войдите в систему, используя ранее созданные учетные данные.

    ![Отображение веб-приложения «викторина» с изображением](maintainable-azure-websites-managing-change-and-scale/_static/image74.png "Отображение веб-приложения «викторина» с изображением")

    *Отображение веб-приложения «викторина» с изображением*
2. Нажмите клавишу **F12** , чтобы запустить средства разработки, перейдите на вкладку **сеть** и начните запись.

    ![Запуск записи в сеть](maintainable-azure-websites-managing-change-and-scale/_static/image75.png "Запуск записи в сеть")

    *Запуск записи в сеть*
3. Нажмите клавиши **CTRL + F5** , чтобы обновить веб-страницу.
4. После завершения загрузки страницы вы увидите HTTP-запрос к **/ИМГ/лого-БиГ.ПНГ** URL с результатом HTTP **301** (перенаправление), а другой запрос URL-адреса `http://[YOUR-STORAGE-ACCOUNT].blob.core.windows.net/images/logo-big.png` с результатом HTTP **200** .

    ![Проверка перенаправления URL-адреса](maintainable-azure-websites-managing-change-and-scale/_static/image76.png "Отображение перенаправления в средствах разработки")

    *Проверка перенаправления URL-адреса*

<a id="Exercise5"></a>
### <a name="exercise-5-using-autoscale-for-web-apps"></a>Упражнение 5. Использование автомасштабирования для веб-приложений

> [!NOTE]
> Это упражнение не является обязательным, так как для него требуется поддержка веб-нагрузки &amp; тестирования производительности, которая доступна только для **выпуска Visual Studio 2013 Ultimate**. Дополнительные сведения о конкретных функциях Visual Studio 2013 см. [здесь](https://www.microsoft.com/visualstudio/eng/products/compare).

**Веб-приложения службы приложений Azure** предоставляют функцию автомасштабирования для веб-приложений, выполняемых в **стандартном режиме**. Автомасштабирование позволяет Azure автоматически масштабировать число экземпляров веб-приложения в зависимости от нагрузки. Если включен Автомасштабирование, Azure проверяет ЦП веб-приложения каждые пять минут и добавляет экземпляры в тот момент, когда это необходимо. Если загрузка ЦП мала, Azure будет удалять экземпляры каждые два часа, чтобы гарантировать, что производительность веб-приложения не будет снижена.

В этом упражнении предстоит выполнить шаги, необходимые для настройки функции **автомасштабирования** для веб-приложения " **Викторина** ". Вы проверите эту функцию, выполнив нагрузочный тест Visual Studio, чтобы создать достаточно нагрузки на ЦП для приложения, чтобы активировать обновление экземпляра.

<a id="Ex5Task1"></a>
#### <a name="task-1--configuring-autoscale-based-on-the-cpu-metric"></a>Задача 1. Настройка автомасштабирования на основе метрики ЦП

В этой задаче вы будете использовать портал управления Azure, чтобы включить функцию автомасштабирования для веб-приложения, созданного в упражнении 2.

1. На [портале управления Azure](https://manage.windowsazure.com/)выберите веб **-сайты** и щелкните веб-приложение, созданное в упражнении 2.
2. Перейдите на страницу **шкалы** . В разделе **емкость** выберите **ЦП** для параметра **Масштаб по конфигурации метрик** .

    > [!NOTE]
    > При масштабировании по ЦП Azure динамически корректирует количество экземпляров, используемых приложением при изменении загрузки ЦП.

    ![Выбор для масштабирования по ЦП](maintainable-azure-websites-managing-change-and-scale/_static/image77.png "Выбор метрики ЦП для автоматического масштабирования")

    *Выбор для масштабирования по ЦП*
3. Измените конфигурацию **целевого процессора** на **20**-**40** %.

    > [!NOTE]
    > Этот диапазон представляет среднюю загрузку ЦП для веб-приложения. Azure добавит или удалите экземпляры для сохранения веб-приложения в этом диапазоне. Минимальное и максимальное число экземпляров, используемых для масштабирования, задается в конфигурации **количества экземпляров** . Azure никогда не выйдет за этот предел.
    >
    > Значения **целевого ЦП** по умолчанию изменяются только для целей этого лабораторного занятия. Настраивая диапазон ЦП мелкими значениями, вы увеличиваете вероятность запуска автоматического масштабирования при помещении средней нагрузки в приложение.

    ![Изменение целевого ЦП на значение от 20 до 40%](maintainable-azure-websites-managing-change-and-scale/_static/image78.png "Изменение целевого ЦП на значение от 20 до 40%")

    *Изменение целевого ЦП на значение от 20 до 40%*
4. Нажмите кнопку **сохранить** на панели команд, чтобы сохранить изменения.

<a id="Ex5Task2"></a>
#### <a name="task-2--load-testing-with-visual-studio"></a>Задача 2. нагрузочное тестирование с помощью Visual Studio

Теперь, когда **Автомасштабирование** настроено, вы создадите **проект веб-тестов производительности и нагрузочного теста** в Visual Studio для создания некоторой нагрузки на ЦП веб-приложения.

1. Откройте **Visual Studio Ultimate 2013** и выберите **файл | Создать | Проект...** для запуска нового решения.

    ![Создание нового проекта](maintainable-azure-websites-managing-change-and-scale/_static/image79.png "Создание нового проекта")

    *Создание нового проекта*
2. В диалоговом окне **Новый проект** выберите **проект веб-тесты производительности и нагрузочного теста** в **визуальном C# элементе |** Вкладка "тест". Убедитесь, что выбрано **.NET Framework 4,5** , назовите проект *вебандлоадтестпрожект*, выберите **Расположение** и нажмите кнопку " **ОК**".

    ![Создание нового проекта веб-теста и тестовой нагрузки](maintainable-azure-websites-managing-change-and-scale/_static/image80.png "Создание нового проекта веб-теста и тестовой нагрузки")

    *Создание нового проекта веб-теста и тестовой нагрузки*
3. Щелкните правой кнопкой **мыши узел веб-test1 в** веб- **test1. webtest** и выберите команду **Добавить запрос**.

    ![Добавление запроса в test1](maintainable-azure-websites-managing-change-and-scale/_static/image81.png "Добавление запроса в test1")

    *Добавление запроса в test1*
4. В окне **Свойства** нового узла запроса обновите свойство **URL** , чтобы оно указывало на URL веб-приложения (например, *[http://geek-quiz.azurewebsites.net/](http://geek-quiz.azurewebsites.net/)* ).

    ![Изменение свойства URL-адреса](maintainable-azure-websites-managing-change-and-scale/_static/image82.png "Изменение свойства URL-адреса")

    *Изменение свойства URL-адреса*
5. В окне веб- **теста. webtest** щелкните правой кнопкой мыши элемент веб **test1** и выберите команду **Добавить цикл...** .

    ![Добавление цикла в test1](maintainable-azure-websites-managing-change-and-scale/_static/image83.png "Добавление цикла в test1")

    *Добавление цикла в test1*
6. В диалоговом окне **Добавление условного правила и элементы в цикл** выберите правило **цикл по** элементам и измените следующие свойства.

   1. **Завершающее значение:** 1000
   2. **Имя параметра контекста:** Итераци
   3. **Значение приращения:** 1

      ![Выбор правила цикла for и обновление свойств](maintainable-azure-websites-managing-change-and-scale/_static/image84.png "Выбор правила цикла for и обновление свойств")

      *Выбор правила цикла for и обновление свойств*
7. В разделе **элементы в цикле** выберите созданный ранее запрос, который будет первым и последним элементом цикла. Чтобы продолжить, нажмите кнопку **ОК** .

    ![Выбор первого и последнего элементов цикла](maintainable-azure-websites-managing-change-and-scale/_static/image85.png "Выбор первого и последнего элементов цикла")

    *Выбор первого и последнего элементов цикла*
8. В **Обозреватель решений**щелкните правой кнопкой мыши проект **вебандлоадтестпрожект** , разверните меню **Добавить** и выберите пункт **нагрузочный тест...** .

    ![Добавление нагрузочного теста в проект Вебандлоадтестпрожект](maintainable-azure-websites-managing-change-and-scale/_static/image86.png "Добавление нагрузочного теста в проект Вебандлоадтестпрожект")

    *Добавление нагрузочного теста в проект Вебандлоадтестпрожект*
9. В диалоговом окне **создание мастер тестовой нагрузки** нажмите кнопку **Далее**.

    ![Новые мастер тестовой нагрузки](maintainable-azure-websites-managing-change-and-scale/_static/image87.png "Новые мастер тестовой нагрузки")

    *Новые мастер тестовой нагрузки*
10. На странице **сценарий** выберите **не использовать время обработки** и нажмите кнопку **Далее**.

    ![Выбор не для использования времени на обдумывание](maintainable-azure-websites-managing-change-and-scale/_static/image88.png "Выбор не для использования времени на обдумывание")

    *Выбор не для использования времени на обдумывание*
11. На странице **шаблон нагрузки** убедитесь, что выбран параметр **постоянная нагрузка** . Измените значение параметра **Счетчик пользователей** на **250** пользователей и нажмите кнопку **Далее**.

    ![Изменение числа пользователей на 250](maintainable-azure-websites-managing-change-and-scale/_static/image89.png "Изменение числа пользователей на 250")

    *Изменение числа пользователей на 250*
12. На странице **модель тестового набора** выберите в **зависимости от последовательного порядка тестов** и нажмите кнопку **Далее**.

    ![Выбор модели тестового набора](maintainable-azure-websites-managing-change-and-scale/_static/image90.png "Выбор модели тестового набора")

    *Выбор модели тестового набора*
13. На странице **модель тестового набора** нажмите кнопку **Добавить...** , чтобы добавить тест в набор.

    ![Добавление теста в тестовый набор](maintainable-azure-websites-managing-change-and-scale/_static/image91.png "Добавление теста в тестовый набор")

    *Добавление теста в тестовый набор*
14. В диалоговом окне **Добавление тестов** дважды щелкните элемент веб **test1** , чтобы добавить тест в список **Выбранные тесты** . Чтобы продолжить, нажмите кнопку **ОК** .

    ![Добавление теста веб-test1](maintainable-azure-websites-managing-change-and-scale/_static/image92.png "Добавление теста веб-test1")

    *Добавление теста веб-test1*
15. Вернитесь на страницу " **тестовый набор** " и нажмите кнопку **Далее**.

    ![Завершение страницы тестового набора](maintainable-azure-websites-managing-change-and-scale/_static/image93.png "Завершение страницы тестового набора")

    *Завершение страницы тестового набора*
16. На странице **сетевой профиль** нажмите кнопку **Далее**.

    ![Нажатие кнопки "Далее" на странице "смешанный сетевой профиль"](maintainable-azure-websites-managing-change-and-scale/_static/image94.png "Нажатие кнопки "Далее" на странице "смешанный сетевой профиль"")

    *Нажатие кнопки "Далее" на странице "смешанный сетевой профиль"*
17. На странице **набор браузеров** выберите **Internet Explorer 10,0** в качестве типа браузера и нажмите кнопку **Далее**.

    ![Выбор типа браузера](maintainable-azure-websites-managing-change-and-scale/_static/image95.png "Выбор типа браузера")

    *Выбор типа браузера*
18. На странице **наборы счетчиков** нажмите кнопку **Далее**.

    ![Нажатие кнопки "Далее" на странице "наборы счетчиков"](maintainable-azure-websites-managing-change-and-scale/_static/image96.png "Нажатие кнопки "Далее" на странице "наборы счетчиков"")

    *Нажатие кнопки "Далее" на странице "наборы счетчиков"*
19. На странице **Параметры запуска** задайте для параметра **Длительность нагрузочного теста** значение **5 минут** и нажмите кнопку **Готово**.

    ![Задание длительности нагрузочного теста в 5 минут](maintainable-azure-websites-managing-change-and-scale/_static/image97.png "Задание длительности нагрузочного теста в 5 минут")

    *Задание длительности нагрузочного теста в 5 минут*
20. В **Обозреватель решений**дважды щелкните файл **Local. Settings** , чтобы просмотреть параметры тестирования. По умолчанию Visual Studio использует локальный компьютер для выполнения тестов.

    > [!NOTE]
    > Кроме того, можно настроить тестовый проект для выполнения нагрузочных тестов в облаке с помощью **Azure Test Plans**. Azure Test Plans предоставляет облачную службу нагрузочного тестирования, которая имитирует более реалистичную нагрузку, избегая локальных ограничений среды, таких как емкость ЦП, доступная память и пропускная способность сети. Дополнительные сведения об использовании Azure Test Plans для выполнения нагрузочных тестов см. в разделе [сценарии нагрузочного тестирования](/azure/devops/test/load-test/overview?view=vsts).

    ![Параметры тестирования](maintainable-azure-websites-managing-change-and-scale/_static/image98.png)

<a id="Ex5Task3"></a>
#### <a name="task-3--autoscale-verification"></a>Задача 3 — Проверка автомасштабирования

Теперь вы сможете выполнить нагрузочный тест, созданный в предыдущей задаче, и увидеть, как веб-приложение работает под нагрузкой.

1. В **Обозреватель решений**дважды щелкните **LoadTest1. loadtest** , чтобы открыть нагрузочный тест.

    ![Открытие LoadTest1. loadtest](maintainable-azure-websites-managing-change-and-scale/_static/image99.png "Открытие LoadTest1. loadtest")

    *Открытие LoadTest1. loadtest*
2. В окне **LoadTest1. loadtest** нажмите первую кнопку на панели элементов, чтобы запустить нагрузочный тест.

    ![Выполнение нагрузочного теста](maintainable-azure-websites-managing-change-and-scale/_static/image100.png "Выполнение нагрузочного теста")

    *Выполнение нагрузочного теста*
3. Дождитесь завершения нагрузочного теста.

    > [!NOTE]
    > Нагрузочный тест имитирует нескольких пользователей, которые одновременно отправляют запросы в веб-приложение. При выполнении теста можно отслеживать доступные счетчики, чтобы обнаружить ошибки, предупреждения или другие сведения, связанные с выполнением нагрузочного теста.

    ![Нагрузочный тест выполнен](maintainable-azure-websites-managing-change-and-scale/_static/image101.png "Ожидание завершения нагрузочного теста")

    *Нагрузочный тест выполнен*
4. После завершения теста вернитесь на портал управления и перейдите к странице " **масштаб** " веб-приложения. В разделе **Capacity (емкость** ) на диаграмме должно быть показано, что новый экземпляр был автоматически развернут.

    ![Новый экземпляр автоматически развернут](maintainable-azure-websites-managing-change-and-scale/_static/image102.png)

    *Новый экземпляр автоматически развернут*

    > [!NOTE]
    > Для отображения изменений на диаграмме может потребоваться несколько минут (для обновления страницы нажмите клавиши **CTRL + F5** периодически). Если изменения не отображаются, можно попробовать выполнить следующие действия.
    >
    > - Увеличение длительности нагрузочного теста (например, **10 минут**)
    > - Сократите максимальное и минимальное значения целевого диапазона **ЦП** в конфигурации автомасштабирования веб-приложения.
    > - Запустите нагрузочный тест в облаке с **Azure Test Plans**. Дополнительные сведения см. [здесь](/azure/devops/test/load-test/index?view=vsts).

---

<a id="Summary"></a>
## <a name="summary"></a>Сводка

В этой практической лабораторной работе вы узнали, как настроить и развернуть приложение в рабочих веб-приложениях в Azure. Вы начали с обнаружения и обновления баз данных с помощью **Entity Framework Code First migrations**, а затем продолжаете развертывание новых версий сайта с помощью **Git** и выполняет откат до последней стабильной версии сайта. Кроме того, вы узнали, как масштабировать приложение с помощью хранилища для перемещения статического содержимого в контейнер больших двоичных объектов.
