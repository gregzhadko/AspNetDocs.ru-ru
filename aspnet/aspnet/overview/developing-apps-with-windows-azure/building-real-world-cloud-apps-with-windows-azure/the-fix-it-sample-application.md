---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/the-fix-it-sample-application
title: Приложение. пример приложения для устранения проблем (создание облачных приложений в реальном мире с помощью Azure) | Документация Майкрософт
author: MikeWasson
description: Создание реальных облачных приложений с помощью электронной книги Azure основано на презентации, разработанной Скотт Гатри (. В нем объясняются 13 шаблонов и методик, которые могут...
ms.author: riande
ms.date: 06/12/2014
ms.assetid: 1bc333c5-f096-4ea7-b170-779accc21c1a
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/the-fix-it-sample-application
msc.type: authoredcontent
ms.openlocfilehash: e6fda47babd3c2505315f42667c45f09482218c2
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74583747"
---
# <a name="appendix-the-fix-it-sample-application-building-real-world-cloud-apps-with-azure"></a>Приложение. пример приложения для решения проблем (создание облачных приложений в реальном мире с помощью Azure)

[Майк Уоссон](https://github.com/MikeWasson), [Рик Андерсон (]((https://twitter.com/RickAndMSFT)), том [Dykstra)](https://github.com/tdykstra)

[Скачайте проект Fix It](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4)

> **Создание реальных облачных приложений с помощью** электронной книги Azure основано на презентации, разработанной Скотт Гатри (. В нем объясняются 13 шаблонов и методик, которые могут помочь в успешной разработке веб-приложений для облака. Сведения о электронной книге см. [в первой главе](introduction.md).

Это приложение для создания реальных облачных приложений с помощью электронной книги Azure содержит следующие разделы, содержащие дополнительные сведения о загружаемом образце приложения Fix it, которое можно скачать:

- [Известные проблемы](#knownissues)
- [Рекомендации](#bestpractices)
- [Запуск приложения из Visual Studio на локальном компьютере](#run-in-vs)
- [Развертывание базового приложения в веб-приложениях службы приложений Azure с помощью сценариев Windows PowerShell](#deploybase)
- [Устранение неполадок сценариев Windows PowerShell](#troubleshooting)
- [Развертывание приложения с обработкой очереди в веб-приложениях службы приложений Azure и в облачной службе Azure](#deployqueues)

<a id="knownissues"></a>
## <a name="known-issues"></a>Известные проблемы

Первоначально разработанное ИТ-приложение было разработано для того, чтобы продемонстрировать как можно скорее некоторые закономерности, представленные в этой электронной книге. Тем не менее, поскольку электронная книга состоит только из создания реальных приложений, мы подчиняются исправлению и тестированию кода в процессе проверки и тестирования, как это делается для выпущенного программного обеспечения. Мы обнаружили ряд проблем и, как и в реальных приложениях, некоторые из них исправлены, и некоторые из них были отложены в более поздней версии.

В следующем списке приведены проблемы, которые следует решить в рабочем приложении, но по одной причине или другой мы решили не обращаться к первоначальному выпуску примера приложения Fix ИТ.

### <a name="security"></a>по безопасности

- Убедитесь, что невозможно назначить задачу несуществующему владельцу.
- Убедитесь, что вы можете просматривать и изменять только те задачи, которые были созданы или назначены вам.
- Используйте протокол HTTPS для страниц входа и файлов cookie проверки подлинности.
- Укажите предельное время для файлов cookie проверки подлинности.

### <a name="input-validation"></a>Проверка входных данных

Как правило, в рабочем приложении выполняется дополнительная проверка входных данных, чем в приложении Fix ИТ. Например, размер изображения и размер файла изображения, допустимые для отправки, должны быть ограничены.

### <a name="administrator-functionality"></a>Функциональность администратора

Администратор должен иметь возможность смены владельца существующих задач. Например, создатель задачи может покинуть компанию, не покидая полномочий для обслуживания задачи, если только не включен административный доступ.

### <a name="queue-message-processing"></a>Обработка сообщений очереди

Обработка сообщений в очереди в ИТ-приложении призвана быть простой, чтобы продемонстрировать рабочий шаблон, ориентированный на очередь, с минимальным объемом кода. Этот простой код не подходит для реального рабочего приложения.

- Код не гарантирует, что каждое сообщение очереди будет обрабатываться не чаще одного раза. При получении сообщения из очереди существует период времени ожидания, в течение которого сообщение невидимо для других прослушивателей очереди. Если время ожидания истекает до удаления сообщения, сообщение снова становится видимым. Таким образом, если экземпляр рабочей роли тратит длительное время на обработку сообщения, то такое же сообщение может быть обработано дважды, что приведет к дублированию задачи в базе данных. Дополнительные сведения об этой ошибке см. [в статье Использование очередей службы хранилища Azure](https://msdn.microsoft.com/library/ff803365.aspx#sec7).
- Логика опроса очереди может быть более экономичной, при этом выполняется пакетирование извлечения сообщений. Каждый раз при вызове [CloudQueue. GetMessageAsync](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.getmessageasync.aspx)взимается транзакция. Вместо этого можно вызвать метод [CloudQueue. жетмессажесасинк](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.getmessagesasync.aspx) (Обратите внимание на ")", который получает несколько сообщений в одной транзакции. Затраты на транзакции для очередей службы хранилища Azure очень низкие, поэтому в большинстве случаев влияние на затраты не является существенным.
- Строгий цикл в коде обработки сообщений очереди вызывает сходство ЦП, при котором многоядерные виртуальные машины не используются эффективно. Лучше использовать параллелизм задач для параллельного выполнения нескольких асинхронных задач.
- Очередь — обработка сообщений имеет только элементарную обработку исключений. Например, код не обрабатывает [подозрительные сообщения](https://msdn.microsoft.com/library/ms789028.aspx). (Когда обработка сообщений вызывает исключение, необходимо зарегистрировать ошибку и удалить сообщение, либо Рабочая роль будет пытаться обработать ее снова, и цикл будет продолжаться неограниченно долго.)

### <a name="sql-queries-are-unbounded"></a>Запросы SQL не ограничены

Текущее исправление код ИТ не ограничивает количество строк, которые могут возвращать запросы страниц индекса. При входе большого объема задач в базу данных размер полученных списков может вызвать проблемы с производительностью. Решение заключается в реализации разбиения на страницы. Пример см. в разделе [Сортировка, фильтрация и разбиение на страницы с помощью Entity Framework в приложении ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md).

### <a name="view-models-recommended"></a>Просмотреть рекомендованные модели

Приложение для устранения проблем использует класс сущности Фикситтаск для передачи информации между контроллером и представлением. Рекомендуется использовать модель представления. Модель предметной области (например, класс сущности Фикситтаск) разработана на основе того, что необходимо для сохраняемости данных, а модель представления может быть разработана для представления данных. Дополнительные сведения см. в статье [12 ASP.NET](https://codeclimber.net.nz/archive/2009/10/27/12-asp.net-mvc-best-practices.aspx). рекомендации по MVC.

### <a name="secure-image-blob-recommended"></a>Рекомендуется использовать защищенный BLOB-объект образа

Приложение для устранения проблем сохраняет загруженные изображения как открытые, то есть все, кто находит URL-адрес, может получить доступ к изображениям. Образы могут быть защищены, а не общедоступными.

### <a name="no-powershell-automation-scripts-for-queues"></a>Нет скриптов автоматизации PowerShell для очередей

Примеры сценариев автоматизации PowerShell были написаны только для базовой версии исправления, которая полностью работает в веб-приложениях службы приложений Azure. Мы не предоставили скрипты для настройки и развертывания в веб-приложении и среде облачной службы, требуемой для обработки очереди.

### <a name="special-handling-for-html-codes-in-user-input"></a>Специальная обработка HTML-кодов в вводимых пользователем данных

ASP.NET автоматически предотвращает множество способов, с помощью которых злоумышленники могут попытаться выполнять атаки с использованием межузловых сценариев, вводя сценарии в текстовые поля ввода пользователя. И вспомогательный метод `DisplayFor` MVC, используемый для вывода заголовков задач и заметок, автоматически кодирует значения, отправляемые в браузер. Но в рабочем приложении может потребоваться принять дополнительные меры. Дополнительные сведения см. [в разделе Проверка запросов в ASP.NET](https://msdn.microsoft.com/library/hh882339.aspx).

<a id="bestpractices"></a>
## <a name="best-practices"></a>Рекомендации

Ниже приведены некоторые проблемы, которые были исправлены после обнаружения в ходе проверки кода и тестирования исходной версии приложения Fix ИТ. Некоторые из них были вызваны тем, что первоначальный программист не знает о конкретной рекомендации, а некоторые просто потому, что код был написан быстро и не предназначался для выпущенного программного обеспечения. Здесь мы перечислением проблем, которые мы узнали из этой проверки и тестирования, которые могут оказаться полезными для других пользователей, которые также разрабатывают веб-приложения.

### <a name="dispose-the-database-repository"></a>Удаление репозитория базы данных

Класс `FixItTaskRepository` должен ликвидировать экземпляр Entity Framework `DbContext`. Мы сделали это, реализовав `IDisposable` в классе `FixItTaskRepository`:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample1.cs)]

Обратите внимание, что AutoFac будет автоматически удалять экземпляр `FixItTaskRepository`, поэтому нам не нужно явно его удалять.

Другой вариант — удалить `DbContext` переменную-член из `FixItTaskRepository`, а вместо этого создать локальную переменную `DbContext` в каждом методе репозитория в операторе `using`. Например:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample2.cs)]

### <a name="register-singletons-as-such-with-di"></a>Регистрация одноэлементных экземпляров с помощью DI

Поскольку требуется только один экземпляр класса `PhotoService` и `Logger`, эти классы должны быть [зарегистрированы как отдельные экземпляры для внедрения зависимостей](https://code.google.com/p/autofac/wiki/InstanceScope) в *DependenciesConfig.CS*:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample3.cs?highlight=1,3)]

### <a name="security-dont-show-error-details-to-users"></a>Безопасность: не показывать сведения об ошибках пользователям

В исходном приложении для ИТ-приложений не была Общая страница ошибки, и можно просто позволить всем исключениям передаваться в пользовательский интерфейс, поэтому некоторые исключения, такие как ошибки подключения к базе данных, могут привести к отображению полной трассировки стека в браузере. Подробные сведения об ошибках иногда могут способствовать атакам злоумышленников. Решением является запись сведений об исключении в журнал и отображение страницы ошибки для пользователя, не включающего в себя подробности ошибки. Приложение для устранения проблем уже записывается в журнал. чтобы отобразить страницу ошибки, мы добавили `<customErrors mode=On>` в файл Web. config.

[!code-xml[Main](the-fix-it-sample-application/samples/sample4.xml?highlight=2)]

По умолчанию это приводит к тому, что *виевс\шаред\еррор.кштмл* будет отображаться для ошибок. Можно настроить *Error. cshtml* или создать собственное представление страницы ошибок и добавить атрибут `defaultRedirect`. Для конкретных ошибок можно также указать различные страницы ошибок.

### <a name="security-only-allow-a-task-to-be-edited-by-its-creator"></a>Безопасность: разрешить изменение задачи только создателем

На странице указатель панели мониторинга отображаются только задачи, созданные вошедшим в систему пользователем, но злоумышленник может создать URL-адрес с ИДЕНТИФИКАТОРом для задачи другого пользователя. Мы добавили код в *DashboardController.CS* , чтобы вернуть 404 в этом случае:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample5.cs?highlight=9-14,24-29)]

### <a name="dont-swallow-exceptions"></a>Не проглотить исключения

Первоначальное приложение для устранения проблем возвращало значение NULL после регистрации исключения, полученного из SQL-запроса:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample6.cs?highlight=4)]

Таким образом, он будет выглядеть так, как если бы запрос был завершен, но не возвращал какие бы то ни было строки. Решение заключается в повторном создании исключения после перехвата и записи в журнал:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample7.cs)]

### <a name="catch-all-exceptions-in-worker-roles"></a>Перехватывать все исключения в рабочих ролях

Любые необработанные исключения в рабочей роли приведут к перезапуску виртуальной машины, поэтому необходимо заключить все действия в блок try-catch и обрабатывать все исключения.

### <a name="specify-length-for-string-properties-in-entity-classes"></a>Укажите длину строковых свойств в классах сущностей

Чтобы отобразить простой код, исходная версия ИТ-приложения не указывала значения длины для полей сущности Фикситтаск, и в результате они были определены как varchar (max) в базе данных. В результате пользовательский интерфейс принимает практически любой объем входных данных. Задание длины задает ограничения, которые применяются как к пользовательскому вводу на веб-странице, так и к размеру столбца в базе данных:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample8.cs?highlight=4,7,10,12,14)]

### <a name="mark-private-members-as-readonly-when-they-arent-expected-to-change"></a>Помечайте закрытые члены как доступные только для чтения, если их не требуется изменять

Например, в классе `DashboardController` создается экземпляр `FixItTaskRepository`, который не должен изменяться, поэтому мы определили его как [ReadOnly](https://msdn.microsoft.com/library/acdd6hb7.aspx).

[!code-csharp[Main](the-fix-it-sample-application/samples/sample9.cs?highlight=3)]

### <a name="use-listany-instead-of-listcount-gt-0"></a>Использовать список. Any () вместо List. Count () &gt; 0

Если вас интересует, что один или несколько элементов в списке соответствуют указанным критериям, используйте метод [ANY](https://msdn.microsoft.com/library/bb534972.aspx) , так как он возвращается сразу после того, как элемент подбирает критерий, тогда как метод `Count` всегда должен выполнять итерацию по каждому элементу. Файл панели мониторинга *index. cshtml* изначально имел следующий код:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample10.cshtml)]

Мы изменили его на следующее:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample11.cshtml?highlight=1)]

### <a name="generate-urls-in-mvc-views-using-mvc-helpers"></a>Создание URL-адресов в представлениях MVC с помощью вспомогательных функций MVC

Для кнопки **создать устранить проблему** на домашней странице в приложении для ИТ-приложений жестко закодирован элемент привязки:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample12.cshtml)]

Для ссылок представлений и действий лучше использовать вспомогательный метод HTML [URL. Action](https://msdn.microsoft.com/library/system.web.mvc.urlhelper.action.aspx) , например:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample13.cshtml)]

### <a name="use-taskdelay-instead-of-threadsleep-in-worker-role"></a>Используйте Task. Delay вместо Thread. Сон в рабочей роли

Шаблон New-Project помещает `Thread.Sleep` в образец кода для рабочей роли, но в результате чего поток переходит в спящий режим, чтобы пул потоков мог порождать дополнительные ненужные потоки. Это можно избежать, используя вместо этого [Task. Delay](https://msdn.microsoft.com/library/hh139096.aspx) .

[!code-csharp[Main](the-fix-it-sample-application/samples/sample14.cs?highlight=11)]

### <a name="avoid-async-void"></a>Избегайте асинхронного void

Если асинхронному методу не требуется возвращать значение, возвращается `Task` тип, а не `void`.

Этот пример относится к классу `FixItQueueManager`:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample15.cs)]

`async void` следует использовать только для обработчиков событий верхнего уровня. Если метод определен как `async void`, вызывающий объект не может **ожидать** метод или перехватывать любые исключения, которые вызывает метод. Дополнительные сведения см. в статье рекомендации [по асинхронному программированию](https://msdn.microsoft.com/magazine/jj991977.aspx).

### <a name="use-a-cancellation-token-to-break-from-worker-role-loop"></a>Использование токена отмены для прерывания работы цикла рабочей роли

Как правило, метод **Run** в рабочей роли содержит бесконечный цикл. При остановке рабочей роли вызывается метод [RoleEntryPoint. OnStop](https://msdn.microsoft.com/library/windowsazure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) . Этот метод следует использовать для отмены работы, выполняемой внутри метода **Run** , и корректного выхода. В противном случае процесс может завершиться в середине операции.

### <a name="opt-out-of-automatic-mime-sniffing-procedure"></a>Отказаться от автоматического сканирования MIME

В некоторых случаях Internet Explorer сообщает тип MIME, отличный от типа, указанного веб-сервером. Например, если Internet Explorer находит HTML-содержимое в файле, который доставляется с содержимым заголовка HTTP-ответа, Type: text/plain, Internet Explorer определяет, что содержимое должно быть визуализировано как HTML. Увы, это «сканирование MIME» также может привести к проблемам безопасности серверов, на которых размещается ненадежное содержимое. Для борьбы с этой проблемой в Internet Explorer 8 внесено несколько изменений в код определения типа MIME, и разработчики приложений могут [отказаться от СКАНИРОВАНИЯ MIME](https://blogs.msdn.com/b/ie/archive/2008/07/02/ie8-security-part-v-comprehensive-protection.aspx). Следующий код был добавлен в файл *Web. config* .

[!code-xml[Main](the-fix-it-sample-application/samples/sample16.xml?highlight=2-7)]

### <a name="enable-bundling-and-minification"></a>Включение объединения и минификации

Когда Visual Studio создает новый веб-проект, объединение и минификации файлов JavaScript по умолчанию отключено. Мы добавили строку кода в BundleConfig.cs:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample17.cs?highlight=9)]

### <a name="set-an-expiration-time-out-for-authentication-cookies"></a>Установка времени ожидания истечения срока действия для файлов cookie проверки подлинности

По умолчанию срок действия файлов cookie для проверки подлинности истекает через две недели. Более короткое время является более безопасным. Этот параметр можно изменить в *StartupAuth.CS*.

[!code-csharp[Main](the-fix-it-sample-application/samples/sample18.cs?highlight=4-5)]

<a id="run-in-vs"></a>
## <a name="how-to-run-the-app-from-visual-studio-on-your-local-computer"></a>Запуск приложения из Visual Studio на локальном компьютере

Существует два способа запустить приложение для устранения проблем:

- Запустите базовое приложение, которое записывает новые задачи непосредственно в базу данных SQL.
- Запустите приложение, используя очередь и серверную службу, чтобы создать задачи. Шаблон очереди описан в разделе [рабочий шаблон, ориентированный на очередь](queue-centric-work-pattern.md).

<a id="runbase"></a>
### <a name="run-the-base-application"></a>Запуск базового приложения

1. Установите [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=button+cta&utm_content=download+vs2017).
2. Установите [пакет Azure SDK для .NET для Visual Studio](https://azure.microsoft.com/downloads/).
3. Скачайте ZIP-файл из [коллекции кода MSDN](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4).
4. В проводнике щелкните правой кнопкой мыши ZIP-файл и выберите пункт Свойства, а затем в окно свойств нажмите кнопку Разблокировать.
5. Распакуйте файл.
6. Дважды щелкните файл sln, чтобы запустить Visual Studio.
7. В меню **Сервис** выберите **Диспетчер пакетов NuGet**, а затем — **консоль диспетчера пакетов**.
8. В консоли диспетчера пакетов (PMC) нажмите кнопку восстановить.
9. Закройте Visual Studio.
10. Запустите [эмулятор хранения Azure](/azure/storage/common/storage-use-emulator).
11. Перезапустите Visual Studio, открыв файл решения, который вы закрыли на предыдущем шаге.
12. Убедитесь, что проект FixIt установлен в качестве запускаемого проекта, и нажмите клавиши CTRL + F5, чтобы запустить проект.

<a id="queueslocal"></a>
### <a name="run-the-application-with-queue-processing"></a>Запуск приложения с обработкой очереди

1. Следуйте указаниям по [запуску базового приложения](#runbase), а затем закройте браузер и закройте Visual Studio.
2. Запустите Visual Studio с правами администратора. (Вы будете использовать эмулятор вычислений Azure, для которого требуются права администратора).
3. В файле *Web. config* приложения в проекте *мификсит* (веб-проекте) измените значение `appSettings/UseQueues` на "true":

    [!code-console[Main](the-fix-it-sample-application/samples/sample19.cmd?highlight=3)]
4. Если [эмулятор хранения Azure](https://msdn.microsoft.com/library/windowsazure/hh403989.aspx) еще не запущен, запустите его снова.
5. Одновременно запустите веб-проект FixIt и проект Мификситклаудсервице.

    С помощью Visual Studio:

   1. Нажмите клавишу **F5** , чтобы запустить проект Fixit.
   2. В **Обозреватель решений**щелкните правой кнопкой мыши проект мификситклаудсервице и выберите **Отладка** > **запустить новый экземпляр**.

    Использование Visual Studio 2013 Express для Web:

   3. В обозреватель решений щелкните правой кнопкой мыши решение FixIt и выберите пункт **Свойства**.
   4. Выберите **Несколько запускаемых проектов**.
   5. В раскрывающемся списке **действие** в разделе Мификсит and Мификситклаудсервице выберите **Start**.
   6. Нажмите кнопку **ОК**.
   7. Нажмите клавишу **F5** , чтобы запустить оба проекта.

      При запуске проекта Мификситклаудсервице Visual Studio запускает эмулятор вычислений Azure. В зависимости от конфигурации брандмауэра может потребоваться разрешить эмулятор через брандмауэр.

<a id="deploybase"></a>
## <a name="how-to-deploy-the-base-app-to-azure-app-service-web-apps-by-using-the-windows-powershell-scripts"></a>Развертывание базового приложения в веб-приложениях службы приложений Azure с помощью сценариев Windows PowerShell

Чтобы проиллюстрировать шаблон " [автоматизировать все](automate-everything.md) ", предоставляется приложение для устранения проблем с сценариями, которые настроили среду в Azure и развертывают проект в новой среде. В следующих инструкциях объясняется, как использовать скрипты.

Если вы хотите работать в Azure без использования очередей и внесли изменения для локального выполнения с очередями, убедитесь, что для параметра Усекуеуес appSetting возвращено значение false, прежде чем продолжить выполнение следующих инструкций.

В этих инструкциях предполагается, что вы уже скачали и запустили решение для устранения проблем в локальной среде, а также у вас есть учетная запись Azure или есть подписка Azure, для которой разрешено управление.

1. Установите консоль **Azure PowerShell** . Инструкции см. [в разделе Установка и настройка Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview?view=azurermps-4.3.1).

    Эта настроенная консоль настроена для работы с подпиской Azure. Модуль Azure устанавливается в каталог *Program Files* и автоматически импортируется при каждом использовании консоли Azure PowerShell.

    Если вы предпочитаете работать в другой основной программе, такой как интегрированная среда сценариев Windows PowerShell, обязательно используйте командлет [Import-Module](https://go.microsoft.com/fwlink/?LinkID=141553) , чтобы импортировать модуль Azure, или используйте команду в модуле Azure, чтобы активировать автоматический импорт модуля.
2. Запустите Azure PowerShell с параметром **Запуск от имени администратора** .
3. Выполните командлет [Set-ExecutionPolicy](https://go.microsoft.com/fwlink/p/?linkid=293941) , чтобы задать для политики выполнения Azure PowerShell значение `RemoteSigned`. Введите **Y** (да), чтобы завершить изменение политики.

    [!code-console[Main](the-fix-it-sample-application/samples/sample20.cmd)]

    Этот параметр позволяет выполнять локальные сценарии, не имеющие цифровой подписи. (Можно также задать для политики выполнения значение `Unrestricted`, что позволит устранить необходимость в выполнении шага разблокировки позже, но это не рекомендуется в целях безопасности.)
4. Выполните командлет `Add-AzureAccount`, чтобы настроить PowerShell с учетными данными для вашей учетной записи.

    [!code-console[Main](the-fix-it-sample-application/samples/sample21.cmd)]

    Срок действия этих учетных данных истекает через определенный промежуток времени, и необходимо повторно запустить командлет `Add-AzureAccount`. При записи этой электронной книги предельное время до истечения срока действия учетных данных составляет 12 часов.
5. Если у вас несколько подписок, используйте командлет Select-AzureSubscription, чтобы указать подписку, в которой нужно создать тестовую среду.
6. Импортируйте сертификат управления для той же подписки Azure с помощью командлетов `Get-AzurePublishSettingsFile` и `Import-AzurePublishSettingsFile`. Первый из этих командлетов загружает файл сертификата, а во втором — расположение этого файла, чтобы импортировать его. > [!IMPORTANT]
   > Сохраните скачанный файл в надежном месте или удалите его после завершения работы с ним, так как он содержит сертификат, который можно использовать для управления службами Azure.

    [!code-console[Main](the-fix-it-sample-application/samples/sample22.cmd)]

    Сертификат используется для вызова REST API, который определяет IP-адрес компьютера разработки, чтобы задать правило брандмауэра на сервере базы данных SQL.
7. Запустите командлет [Set-Location](https://go.microsoft.com/fwlink/p/?linkid=293912) (псевдонимы `cd`, `chdir`и `sl`) для перехода к каталогу, содержащему скрипты. (Они находятся в папке *службы автоматизации* в папке Fix ИТ Solution.) Если любое из имен каталогов содержит пробелы, укажите путь в кавычках. Например, чтобы перейти к каталогу `c:\Sample Apps\FixIt\Automation`, можно ввести следующую команду:

    [!code-console[Main](the-fix-it-sample-application/samples/sample23.cmd)]
8. Чтобы разрешить Windows PowerShell выполнять эти сценарии, используйте командлет [Unblock-File](https://go.microsoft.com/fwlink/p/?linkid=294021) . (Сценарии заблокированы, так как они были скачаны из Интернета.)

    > [!WARNING]
    > Безопасность. перед запуском `Unblock-File` для любого скрипта или исполняемого файла откройте файл в блокноте, проверьте команды и убедитесь, что они не содержат вредоносного кода.

    Например, следующая команда выполняет командлет `Unblock-File` для всех скриптов в текущем каталоге.

    [!code-console[Main](the-fix-it-sample-application/samples/sample24.cmd)]
9. Чтобы создать веб-приложение для базового (без обработки очередей), исправьте приложение ИТ, запустите сценарий создания среды.

    Обязательный параметр `Name` указывает имя базы данных и также используется для учетной записи хранения, создаваемой сценарием. Имя должно быть глобально уникальным в пределах домена azurewebsites.net. При указании неуникального имени, например Fixit или Test (или даже в примере фикситдемо), командлет `New-AzureWebsite` завершается с внутренней ошибкой, которая сообщает о конфликте. Сценарий преобразует имя в нижний регистр в соответствии с требованиями к имени для веб-приложений, учетных записей хранения и баз данных.

    Обязательный параметр `SqlDatabasePassword` указывает пароль для учетной записи администратора, которая будет создана для базы данных SQL. Не включайте специальные символы XML в пароль (&amp; &lt; &gt;;). Это ограничение способа написания сценариев, а не ограничения Azure.

    Например, если вы хотите создать веб-приложение с именем "фикситдемо" и использовать пароль администратора SQL Server "Passw0rd1", можно ввести следующую команду:

    [!code-console[Main](the-fix-it-sample-application/samples/sample25.cmd)]

    Имя должно быть уникальным в домене azurewebsites.net, а пароль должен соответствовать требованиям к базе данных SQL для сложности пароля. (Пример Passw0rd1 соответствует требованиям.)

    Обратите внимание, что команда начинается с ".\". Чтобы предотвратить вредоносное выполнение сценариев, Windows PowerShell требует указать полный путь к файлу скрипта при выполнении скрипта. Можно использовать точку для указания текущего каталога (".\") или укажите полный путь, например:

    [!code-console[Main](the-fix-it-sample-application/samples/sample26.cmd)]

    Для получения дополнительных сведений о скрипте используйте командлет `Get-Help`.

    [!code-console[Main](the-fix-it-sample-application/samples/sample27.cmd)]

    Для фильтрации возвращаемой справки можно использовать параметры `Detailed`, `Full`, `Parameters`и `Examples` командлета Get-Help.

    Если сценарий завершается ошибкой или создает ошибки, например "New-AzureWebsite: Call Set-AzureSubscription и SELECT-AzureSubscription First", возможно, вы не завершили настройку Azure PowerShell.

    После завершения сценария можно использовать портал управления Azure, чтобы просмотреть созданные ресурсы, как показано в главе [Автоматизация всех](automate-everything.md) .
10. Чтобы развернуть проект FixIt в новой среде Azure, используйте скрипт *AzureWebsite. ps1* . Например:

    [!code-console[Main](the-fix-it-sample-application/samples/sample28.cmd)]

    После завершения развертывания браузер откроется с исправлением, которое выполняется в Azure.

<a id="troubleshooting"></a>
## <a name="troubleshooting-the-windows-powershell-scripts"></a>Устранение неполадок сценариев Windows PowerShell

Наиболее распространенные ошибки, возникающие при выполнении этих сценариев, связаны с разрешениями. Убедитесь, что `Add-AzureAccount` и `Import-AzurePublishSettingsFile` были успешными и использовали их для одной и той же подписки Azure. Даже если `Add-AzureAccount` был успешным, может потребоваться запустить его снова. Разрешения, добавленные `Add-AzureAccount` сроком действия, истекает через 12 часов.

### <a name="object-reference-not-set-to-an-instance-of-an-object"></a>ссылка на объект не указывает на экземпляр объекта.

Если скрипт возвращает ошибки, например "ссылка на объект не задана экземпляром объекта", это означает, что Windows PowerShell не удается найти объект для обработки (это исключение null reference), запустите командлет `Add-AzureAccount` и повторите сценарий.

[!code-console[Main](the-fix-it-sample-application/samples/sample29.cmd)]

### <a name="internalerror-the-server-encountered-an-internal-error"></a>Интерналеррор: произошла внутренняя ошибка на сервере.

Командлет `New-AzureWebsite` Возвращает внутреннюю ошибку, если имя не является уникальным в домене azurewebsites.net. Чтобы устранить эту ошибку, используйте другое значение для имени, которое находится в параметре Name параметра *Нев-азуревебситинв. ps1*.

[!code-console[Main](the-fix-it-sample-application/samples/sample30.cmd)]

### <a name="restarting-the-script"></a>Перезапуск скрипта

Если необходимо перезапустить сценарий *Нев-азуревебситинв. ps1* , так как он не был выполнен до вывода сообщения "сценарий завершен", может потребоваться удалить ресурсы, созданные сценарием до его остановки. Например, если скрипт уже создал веб-приложение Контософикситдемо и вы повторно запускаете сценарий с тем же именем, сценарий завершится ошибкой, так как имя уже используется.

Чтобы определить, какие ресурсы сценарий создал перед остановкой, используйте следующие командлеты:

- `Get-AzureWebsite`
- `Get-AzureSqlDatabaseServer`
- `Get-AzureSqlDatabase`: для запуска этого командлета выполните вертикальное имя сервера базы данных, чтобы `Get-AzureSqlDatabase`: `Get-AzureSqlDatabaseServer | Get-AzureSqlDatabase.`

Чтобы удалить эти ресурсы, используйте следующие команды. Обратите внимание, что при удалении сервера базы данных автоматически удаляются базы данных, связанные с сервером.

- `Get-AzureWebsite -Name <WebsiteName> | Remove-AzureWebsite`
- `Get-AzureSqlDatabase -Name <DatabaseName> -ServerName <DatabaseServerName> | Remove-SqlAzureDatabase`
- `Get-AzureSqlDatabaseServer | Remove-AzureSqlDatabaseServer`

<a id="deployqueues"></a>
## <a name="how-to-deploy-the-app-with-queue-processing-to-azure-app-service-web-apps-and-an-azure-cloud-service"></a>Развертывание приложения с обработкой очереди в веб-приложениях службы приложений Azure и в облачной службе Azure

Чтобы включить очереди, внесите следующее изменение в файл Мификсит\веб.Конфиг. В разделе `appSettings`измените значение `UseQueues` на "true":

[!code-xml[Main](the-fix-it-sample-application/samples/sample31.xml)]

Затем разверните приложение MVC в веб-приложении в службе приложений Azure, как описано [выше](#deploybase).

Затем создайте новую облачную службу Azure. Скрипты, входящие в состав приложения для устранения проблем, не создают и не развертывают облачную службу, поэтому для этого необходимо использовать портал Azure. На портале щелкните **создать** -- **COMPUTE** — **облачная служба** -- **Быстрое создание**, а затем введите URL-адрес и расположение центра обработки данных. Используйте тот же центр обработки данных, в котором развернуто веб-приложение.

![](the-fix-it-sample-application/_static/image1.png)

Перед развертыванием облачной службы необходимо обновить некоторые файлы конфигурации.

В Мификсит. Воркерроле\апп.конфиг в разделе `connectionStrings`замените значение строки подключения `appdb` фактической строкой подключения для базы данных SQL. Строку подключения можно получить на портале. На портале щелкните **базы данных sql** - **аппдб** - **Просмотр строк подключения к базе данных SQL для ADO .NET, ODBC, PHP и JDBC**. Скопируйте строку подключения ADO.NET и вставьте значение в файл App. config. Замените "{ваш\_пароль\_здесь}" паролем базы данных. (Если вы использовали сценарии для развертывания приложения MVC, вы указали пароль базы данных в параметре скрипта `SqlDatabasePassword`.)

Результат должен выглядеть следующим образом:

[!code-xml[Main](the-fix-it-sample-application/samples/sample32.xml)]

В том же файле Мификсит. Воркерроле\апп.конфиг в разделе `appSettings`замените два значения заполнителя для учетной записи хранения Azure.

[!code-xml[Main](the-fix-it-sample-application/samples/sample33.xml?highlight=2-3)]

Ключ доступа можно получить на портале. См. раздел [Управление учетными записями хранения](https://docs.microsoft.com/azure/storage/common/storage-create-storage-account).

В Мификситклаудсервице\сервицеконфигуратион.Клауд.кскфг замените два значения заполнителей для учетной записи хранения Azure.

[!code-xml[Main](the-fix-it-sample-application/samples/sample34.xml?highlight=3)]

Теперь все готово к развертыванию облачной службы. В обозревателе решений щелкните правой кнопкой мыши проект Мификситклаудсервице и выберите **опубликовать**. Дополнительные сведения см. в разделе "[развертывание приложения в Azure](https://www.windowsazure.com/develop/net/tutorials/multi-tier-web-site/2-download-and-run/#deployAz)", который входит в часть 2 [этого руководства](https://code.msdn.microsoft.com/Windows-Azure-Multi-Tier-eadceb36).

> [!div class="step-by-step"]
> [Назад](more-patterns-and-guidance.md)
