---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/the-fix-it-sample-application
title: 'Приложение: Исправление его пример приложения (Строительство реальных облачных приложений с Azure) Документы Майкрософт'
author: MikeWasson
description: Создание облачных приложений реального мира с электронной книгой Azure основано на презентации, разработанной Скоттом Гатри. Это объясняет 13 моделей и практик, которые могут он ...
ms.author: riande
ms.date: 06/12/2014
ms.assetid: 1bc333c5-f096-4ea7-b170-779accc21c1a
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/the-fix-it-sample-application
msc.type: authoredcontent
ms.openlocfilehash: 896196bdb6a6b0d12a6c798ead510e37dd38a9fc
ms.sourcegitcommit: ce28244209db8615bc9bdd576a2e2c88174d318d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2020
ms.locfileid: "80675637"
---
# <a name="appendix-the-fix-it-sample-application-building-real-world-cloud-apps-with-azure"></a>Приложение: Приложение Fix It Sample (создание облачных приложений в реальном мире с помощью Azure)

[Майк Уоссон](https://github.com/MikeWasson), [Рик Андерсон](https://twitter.com/RickAndMSFT), [Том Дайкстра](https://github.com/tdykstra)

[Скачать Проект Исправление](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4)

> **Создание облачных приложений реального мира с** электронной книгой Azure основано на презентации, разработанной Скоттом Гатри. В нем изушатся 13 шаблонов и практик, которые могут помочь вам успешно разрабатывать веб-приложения для облака. Для получения информации об электронной книге, [см.](introduction.md)

Это приложение к созданию облачных приложений Real World с электронной книгой Azure содержит следующие разделы, которые содержат дополнительную информацию о примере приложения Fix It, которое можно загрузить:

- [Известные проблемы](#knownissues)
- [Рекомендации](#bestpractices)
- [Как запустить приложение из Visual Studio на локальном компьютере](#run-in-vs)
- [Как развернуть базовое приложение в Web Apps Службы приложений Azure с помощью скриптов Windows PowerShell](#deploybase)
- [Устранение неполадок скриптов Windows PowerShell](#troubleshooting)
- [Как развернуть приложение с обработкой очередей в Web Apps App Apps и облачную службу Azure](#deployqueues)

<a id="knownissues"></a>
## <a name="known-issues"></a>Известные проблемы

Приложение Fix It было первоначально разработано для того, чтобы проиллюстрировать как можно проще некоторые из шаблонов, представленных в этой электронной книге. Однако, поскольку электронная книга посвящена созданию реальных приложений, мы подвергли код Fix It процессу обзора и тестирования, аналогичному тому, что мы сделали бы для выпущенного программного обеспечения. Мы нашли ряд проблем, и, как и в любом реальном приложении, некоторые из них мы исправили, а некоторые из них мы отложили на более поздний выпуск.

Следующий список включает в себя вопросы, которые должны быть рассмотрены в производственном приложении, но по той или иной причине мы решили не рассматривать в первоначальном выпуске приложения Fix It образца.

### <a name="security"></a>Безопасность

- Убедитесь, что вы не можете назначить задачу несуществующему владельцу.
- Убедитесь, что вы можете просматривать и изменять только созданные или назначенные вам задачи.
- Используйте HTTPS для страниц и файлов cookie для проверки подлинности.
- Укажите ограничение по времени для файлов cookie аутентификации.

### <a name="input-validation"></a>Проверка входных данных

В целом, производственное приложение будет делать больше входная проверка, чем приложение Fix It. Например, размер изображения / размер файла изображения, разрешенный для загрузки, должен быть ограничен.

### <a name="administrator-functionality"></a>Функциональность администратора

Администратор должен иметь возможность менять право собственности на существующие задачи. Например, создатель задачи может покинуть компанию, не оставляя ни у кого полномочий на поддержание задачи, если не будет включен административный доступ.

### <a name="queue-message-processing"></a>Обработка сообщений очереди

Обработка сообщений очереди в приложении Fix It была разработана, чтобы быть простой, чтобы проиллюстрировать шаблон работы, ориентированный на очередь, с минимальным количеством кода. Этот простой код не будет достаточным для фактического производственного приложения.

- Код не гарантирует, что каждое сообщение очереди будет обработано не более одного раза. Когда вы получаете сообщение из очереди, есть период тайм-аута, в течение которого сообщение невидимо для других слушателей очереди. Если тайм-аут истекает до удаления сообщения, сообщение становится снова видимым. Таким образом, если пример роли работника тратит долгое время на обработку сообщения, теоретически одно и то же сообщение может быть обработано дважды, что приводит к дубликату задачи в базе данных. Для получения дополнительной информации об этой проблеме [см.](https://msdn.microsoft.com/library/ff803365.aspx#sec7)
- Логика опроса очереди может быть более рентабельной путем пакетирования поиска сообщений. Каждый раз, когда вы звоните [в Cloud'ueue.GetMessageAsync,](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.getmessageasync.aspx)стоимость транзакции. Вместо этого можно вызвать [Cloud'U.GetMessagesAsync](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.getmessagesasync.aspx) (обратите внимание на множественное число 's'), которое получает несколько сообщений в одной транзакции. Транзакционные затраты для очередей хранения azure очень низки, поэтому влияние на затраты не является существенным в большинстве сценариев.
- Плотный цикл в коде обработки сообщений очереди вызывает сродство процессора, который не использует многоядерные VMs эффективно. Более совершенная конструкция будет использовать параллельность задач для параллельного выполнения нескольких задач async.
- Обработка сообщений очереди имеет только элементарную обработку исключений. Например, код не обрабатывает [ядовитые сообщения.](https://msdn.microsoft.com/library/ms789028.aspx) (Когда обработка сообщений вызывает исключение, необходимо войти в ошибку и удалить сообщение, или роль работника попытается обработать ее снова, и цикл будет продолжаться бесконечно.)

### <a name="sql-queries-are-unbounded"></a>Запросы S'L не ограничены

Текущий код Fix It не ограничивает количество строк, которые могут вернуть запросы для страниц Индекса. Если большой объем задач вводится в базу данных, размер полученных списков может вызвать проблемы с производительностью. Решение заключается в реализации paging. Например, в [приложении ASP.NET MVC сортировка, фильтрация и paging с помощью системы Entity.](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md)

### <a name="view-models-recommended"></a>Рекомендуемые модели

Приложение Fix It использует класс сущности FixItTask для передачи информации между контроллером и представлением. Наилучшей практикой является использование моделей представлений. Модель домена (например, класс сущности FixItTask) разработана вокруг того, что необходимо для сохранения данных, в то время как модель представления может быть разработана для представления данных. Для получения дополнительной информации см [ASP.NET.](https://codeclimber.net.nz/archive/2009/10/27/12-asp.net-mvc-best-practices.aspx)

### <a name="secure-image-blob-recommended"></a>Безопасная капля изображения рекомендуется

Приложение Fix It хранит загруженные изображения как общедоступные, что означает, что любой, кто найдет URL- Изображения могут быть защищены, а не общественности.

### <a name="no-powershell-automation-scripts-for-queues"></a>Нет скриптов автоматизации PowerShell для очередей

Примеры скриптов автоматизации PowerShell были написаны только для базовой версии Fix It, которая полностью работает в Web Apps Apps App. Мы не предоставили скрипты для настройки и развертывания в веб-приложении плюс среду облачных служб, необходимую для обработки очередей.

### <a name="special-handling-for-html-codes-in-user-input"></a>Специальная обработка HTML-кодов при вхотвом пользовательском ввода

ASP.NET автоматически предотвращает множество способов, с помощью которых вредоносные пользователи могут совершать попытки атак на кросс-сайт ы, вводя сценарий в текстовые ящики пользователей. А помощник `DisplayFor` MVC, используемый для отображения названий задач и заметок, автоматически кодирует значения, которые он отправляет в браузер. Но в производственном приложении вы можете принять дополнительные меры. Для получения дополнительной информации смотрите [проверку запроса в ASP.NET](https://msdn.microsoft.com/library/hh882339.aspx).

<a id="bestpractices"></a>
## <a name="best-practices"></a>Рекомендации

Ниже приведены некоторые проблемы, которые были исправлены после обнаружения в обзоре кода и тестировании оригинальной версии приложения Fix It. Некоторые из них были вызваны тем, что исходный кодер не знал о конкретной наилучшей практике, некоторые просто потому, что код был написан быстро и не был предназначен для выпущенного программного обеспечения. Мы перечисляем проблемы здесь в случае, если есть что-то мы узнали из этого обзора и тестирования, которые могут быть полезны для других, которые также разрабатывают веб-приложения.

### <a name="dispose-the-database-repository"></a>Распоряжаться репозиторием базы данных

Класс `FixItTaskRepository` должен распоряжаться экземпляром Entity Framework. `DbContext` Мы сделали это, `IDisposable` реализовав в `FixItTaskRepository` классе:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample1.cs)]

Обратите внимание, что AutoFac будет автоматически распоряжаться `FixItTaskRepository` экземпляром, поэтому нам не нужно явно распоряжаться им.

Другим вариантом является `DbContext` удаление `FixItTaskRepository`переменной участника из, и вместо этого создать локальную `DbContext` переменную в каждом методе репозитория внутри `using` оператора. Пример:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample2.cs)]

### <a name="register-singletons-as-such-with-di"></a>Регистрация синглтонов как таковых с DI

Поскольку требуется `PhotoService` только `Logger` один экземпляр класса и класса, эти классы должны быть [зарегистрированы в качестве единичных экземпляров для инъекций зависимости](https://code.google.com/p/autofac/wiki/InstanceScope) в *DependenciesConfig.cs:*

[!code-csharp[Main](the-fix-it-sample-application/samples/sample3.cs?highlight=1,3)]

### <a name="security-dont-show-error-details-to-users"></a>Безопасность: Не показывать пользователям сведения об ошибках

Оригинальное приложение Fix It не имеет общей страницы ошибки и просто позволить всем исключениям пополнять сярвый к интерфейсу, поэтому некоторые исключения, такие как ошибки соединения базы данных, могут привести к отображению полного стека следова в браузере. Подробная информация об ошибках иногда может способствовать атакам злоумышленников. Решение состоит в том, чтобы войти в данные об исключении и отобразить страницу ошибки пользователю, которая не содержит сведений об ошибках. Приложение Fix It уже было журналом, и для отображения страницы ошибки мы добавили `<customErrors mode=On>` в файл Web.config.

[!code-xml[Main](the-fix-it-sample-application/samples/sample4.xml?highlight=2)]

По умолчанию это приводит к отображению для ошибок *для ошибок.* Вы можете настроить *Error.cshtml* или создать свой собственный `defaultRedirect` вид страницы ошибки и добавить атрибут. Вы также можете указать различные страницы ошибок для конкретных ошибок.

### <a name="security-only-allow-a-task-to-be-edited-by-its-creator"></a>Безопасность: разрешить редактировать задачу только ее создателю

Страница Индекса dashboard отображает только задачи, созданные зарегистрированным пользователем, но злоумышленник может создать URL-адрес с идентификатором для задачи другого пользователя. Мы добавили код в *DashboardController.cs,* чтобы вернуть 404 в этом случае:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample5.cs?highlight=9-14,24-29)]

### <a name="dont-swallow-exceptions"></a>Не глотайте исключения

Исходное приложение Fix It только что вернулось недействительным после регистрации исключения, которое возникло в результате запроса S'L:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample6.cs?highlight=4)]

Это позволит пользователю выглядеть так, как будто запрос удался, но просто не вернул строки. Решение заключается в повторном броске исключения после ловли и регистрации:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample7.cs)]

### <a name="catch-all-exceptions-in-worker-roles"></a>Поймать все исключения в роли работника

Любые необработанные исключения в роли работника приведут к переработке VM, поэтому вы хотите обернуть все, что вы делаете, в блок try-catch и обрабатывать все исключения.

### <a name="specify-length-for-string-properties-in-entity-classes"></a>Указать длину свойств строкви в классах сущностей

Для отображения простого кода в исходной версии приложения Fix It не были указаны длины для полей сущности FixItTask, и в результате они были определены как varchar(max) в базе данных. В результате, UI будет принимать почти любое количество входных. Определение длин устанавливает ограничения, которые применяются как к вводе пользователем в веб-страницу, так и к размеру столбца в базе данных:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample8.cs?highlight=4,7,10,12,14)]

### <a name="mark-private-members-as-readonly-when-they-arent-expected-to-change"></a>Отметьте частных членов как только для того, чтобы они не менялись

Например, в `DashboardController` классе `FixItTaskRepository` создается экземпляр, который не должен изменяться, поэтому мы определили его как [только что читаемый.](https://msdn.microsoft.com/library/acdd6hb7.aspx)

[!code-csharp[Main](the-fix-it-sample-application/samples/sample9.cs?highlight=3)]

### <a name="use-listany-instead-of-listcount-gt-0"></a>Используйте список. Любой () вместо списка. Граф () &gt; 0

Если вы заботитесь только о том, соответствует ли один или несколько элементов в списке указанным критериям, используйте `Count` [любой](https://msdn.microsoft.com/library/bb534972.aspx) метод, потому что он возвращается, как только элемент, соответствующий критериям, найден, в то время как метод всегда должен итерировать сяпотворство через каждый элемент. Файл *Dashboard Index.cshtml* изначально имел этот код:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample10.cshtml)]

Мы изменили его на это:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample11.cshtml?highlight=1)]

### <a name="generate-urls-in-mvc-views-using-mvc-helpers"></a>Создание URL-адресов в представлениях MVC с помощью помощников MVC

Для **кнопки «Создать исправление на** главной странице» приложение Fix It жестко закодировано якорным элементом:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample12.cshtml)]

Для таких ссылок View/Action лучше использовать, например, помощник [URL.Action](https://msdn.microsoft.com/library/system.web.mvc.urlhelper.action.aspx) HTML:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample13.cshtml)]

### <a name="use-taskdelay-instead-of-threadsleep-in-worker-role"></a>Используйте Task.Delay вместо Thread.Sleep в роли работника

Шаблон нового проекта `Thread.Sleep` помещает в пример кода для роли работника, но причинение засну чего потока может привести к тому, что пул потоков порождает дополнительные ненужные потоки. Вы можете избежать этого, используя [Task.Delay](https://msdn.microsoft.com/library/hh139096.aspx) вместо этого.

[!code-csharp[Main](the-fix-it-sample-application/samples/sample14.cs?highlight=11)]

### <a name="avoid-async-void"></a>Избегайте async недействительным

Если методу async не нужно возвращать значение, `Task` верните `void`тип, а не.

Этот пример из `FixItQueueManager` класса:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample15.cs)]

Вы должны `async void` использовать только для обработчиков событий верхнего уровня. Если вы определяете `async void`метод как, абонент не может **ждать** метода или поймать любые исключения метод бросает. Для получения дополнительной информации [см.](https://msdn.microsoft.com/magazine/jj991977.aspx)

### <a name="use-a-cancellation-token-to-break-from-worker-role-loop"></a>Используйте маркер отмены, чтобы выйти из цикла роли работника

Как правило, метод **выполнения** роли работника содержит бесконечный цикл. Когда роль работника останавливается, вызывается метод [RoleEntryPoint.OnStop.](https://msdn.microsoft.com/library/windowsazure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) Этот метод следует использовать для отмены работы, проводимой внутри метода **Run,** и изящного выхода. В противном случае процесс может быть завершен в середине операции.

### <a name="opt-out-of-automatic-mime-sniffing-procedure"></a>Отказаться от автоматической процедуры нюхания MIME

В некоторых случаях Internet Explorer сообщает тип MIME, отличайся от типа, указанного веб-сервером. Например, если Internet Explorer находит HTML-контент в файле, доставляемом с помощью заголовка ответа HTTP Content-Type: text/plain, Internet Explorer определяет, что содержимое должно отображаться как HTML. К сожалению, это "MIME-нюхать" также может привести к проблемам безопасности для серверов хостинг атлимированный контент. Для борьбы с этой проблемой Internet Explorer 8 внес ряд изменений в код определения типа MIME и позволяет разработчикам приложений [отказаться от miME-нюхать.](https://blogs.msdn.com/b/ie/archive/2008/07/02/ie8-security-part-v-comprehensive-protection.aspx) Следующий код был добавлен в файл *Web.config.*

[!code-xml[Main](the-fix-it-sample-application/samples/sample16.xml?highlight=2-7)]

### <a name="enable-bundling-and-minification"></a>Включить комплектацию и минификацию

Когда Visual Studio создает новый веб-проект, комплектация и минификация файлов JavaScript не включены по умолчанию. Мы добавили строку кода в BundleConfig.cs:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample17.cs?highlight=9)]

### <a name="set-an-expiration-time-out-for-authentication-cookies"></a>Установить тайм-аут истечения для файлов cookie аутентификации

По умолчанию срок действия файлов cookie аутентификации истекает через две недели. Более короткое время является более безопасным. Вы можете изменить эту настройку в *StartupAuth.cs:*

[!code-csharp[Main](the-fix-it-sample-application/samples/sample18.cs?highlight=4-5)]

<a id="run-in-vs"></a>
## <a name="how-to-run-the-app-from-visual-studio-on-your-local-computer"></a>Как запустить приложение из Visual Studio на локальном компьютере

Существует два способа запуска приложения Fix It:

- Запустите базовое приложение, которое записывает новые задачи непосредственно в базу данных S'L.
- Запустите приложение с помощью очереди плюс бэкэнд-сервис для создания задач. Шаблон очереди описан в главе [Шаблон работы очереди.](queue-centric-work-pattern.md)

<a id="runbase"></a>
### <a name="run-the-base-application"></a>Выполнить базовое приложение

1. Установка [Визуальной студии 2017](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=button+cta&utm_content=download+vs2017).
2. Установите [Azure SDK для .NET для визуальной студии.](https://azure.microsoft.com/downloads/)
3. Скачать файл .zip из [галереи кода MSDN](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4).
4. В File Explorer, право йн-нажмите файл .zip и нажмите Свойства, а затем в окне свойства нажмите Разблокировать.
5. Отстегните файл.
6. Дважды щелкните файл .sln для запуска Visual Studio.
7. Из меню **Инструменты,** нажмите **NuGet менеджер пакета**, а затем **консоль менеджер пакетов**.
8. В консоли менеджера пакетов (PMC) щелкните Restore.
9. Закройте Visual Studio.
10. Запустите [эмулятор хранения Azure.](/azure/storage/common/storage-use-emulator)
11. Перезапустите Visual Studio, открыв файл решения, который вы закрыли на предыдущем этапе.
12. Убедитесь, что проект FixIt установлен в качестве стартап-проекта, а затем нажмите CTRL-F5 для запуска проекта.

<a id="queueslocal"></a>
### <a name="run-the-application-with-queue-processing"></a>Запуск приложения с обработкой очередей

1. Следуйте указаниям для [запуска базового приложения,](#runbase)а затем закройте браузер и закройте Visual Studio.
2. Запустите Visual Studio с привилегий администратора. (Вы будете использовать эмулятор вычислений Azure, что требует привилегий администратора.)
3. В файле приложения *Web.config* в проекте *MyFixIt* (веб-проект) изменяйте значение `appSettings/UseQueues` на "истинное":

    [!code-console[Main](the-fix-it-sample-application/samples/sample19.cmd?highlight=3)]
4. Если [эмулятор хранения Azure](https://msdn.microsoft.com/library/windowsazure/hh403989.aspx) все еще не работает, запустите его снова.
5. Запустите веб-проект FixIt и проект MyFixItCloudService одновременно.

    Использование визуальной студии:

   1. Нажмите **F5** для запуска проекта FixIt.
   2. В **Solution Explorer**, правой кнопкой мыши myFixItCloudService проекта, а затем нажмите **Debug** > Начать**новый экземпляр**.

    Использование Visual Studio 2013 Экспресс для Интернета:

   3. В Solution Explorer, правой кнопкой мыши fixIt решение и выберите **Свойства**.
   4. Выберите **несколько проектов запуска.**
   5. В списке **действий** по выпадению акций под MyFixIt и MyFixItCloudService выберите **Start**.
   6. Нажмите кнопку **ОК**.
   7. Нажмите клавишу **F5**, чтобы запустить оба проекта.

      При запуске проекта MyFixItCloudService Visual Studio запускает эмулятор вычислений Azure. В зависимости от конфигурации брандмауэра может потребоваться пропустить эмулятор через брандмауэр.

<a id="deploybase"></a>
## <a name="how-to-deploy-the-base-app-to-azure-app-service-web-apps-by-using-the-windows-powershell-scripts"></a>Как развернуть базовое приложение в Web Apps Службы приложений Azure с помощью скриптов Windows PowerShell

Чтобы проиллюстрировать шаблон [«Автоматизировать все»,](automate-everything.md) приложение Fix It снабжено скриптами, которые настраивают среду в Azure и развертывают проект в новую среду. Следующие инструкции объясняют, как использовать скрипты.

Если вы хотите работать в Azure без использования очередей, и вы внесли изменения для локального выполнения очередей, убедитесь, что вы установите значение приложения Use'uиты Настройка обратно в ложное, прежде чем приступить к следующим инструкциям.

Эти инструкции предполагают, что вы уже загрузили и запустите решение Fix It локально, а также что у вас есть учетная запись Azure или подписка Azure, которую вы уполномочены управлять.

1. Установите консоль **Azure PowerShell.** Инструкции см. в статье [Приступая к работе с командлетами Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview?view=azurermps-4.3.1).

    Эта настраиваемая консоль настроена на работу с подпиской Azure. Модуль Azure устанавливается в *каталоге программных файлов* и автоматически импортируется при каждом использовании консоли Azure PowerShell.

    Если вы предпочитаете работать в другой программе, такой как Windows PowerShell ISE, обязательно воспользуйтесь смдлетом [Импорт-Модуль](https://go.microsoft.com/fwlink/?LinkID=141553) для импорта модуля Azure или используйте команду в модуле Azure для автоматического импорта модуля.
2. Запустите Azure PowerShell с **опцией администратора Run.**
3. Запустите cmdlet [Set-ExecutionPolicy,](https://go.microsoft.com/fwlink/p/?linkid=293941) чтобы настроить политику `RemoteSigned`выполнения Azure PowerShell. Введите **Y** (для Yes) для завершения изменения политики.

    [!code-console[Main](the-fix-it-sample-application/samples/sample20.cmd)]

    Эта настройка позволяет запускать локальные скрипты, которые не подписаны в цифровом виде. (Вы также можете установить `Unrestricted`политику выполнения, которая устранила бы необходимость разблокировать шаг позже, но это не рекомендуется по соображениям безопасности.)
4. Запустите `Add-AzureAccount` cmdlet, чтобы настроить PowerShell с учетными данными для вашей учетной записи.

    [!code-console[Main](the-fix-it-sample-application/samples/sample21.cmd)]

    Эти учетные данные истекают через некоторое время, и вы должны повторно запустить `Add-AzureAccount` cmdlet. По мере того как эта электронная книга пишется, ограничение времени прежде чем учетные данные истекают 12 часов.
5. Если у вас несколько подписок, используйте cmdlet Select-AzureSubscription, чтобы указать подписку, в которой вы хотите создать тестовую среду.
6. Импортировать сертификат управления для той же `Get-AzurePublishSettingsFile` подписки Azure, используя и `Import-AzurePublishSettingsFile` cmdlets. Первый из этих cmdlets загружает файл сертификата, а во втором вы указываете местоположение этого файла для его импорта. > [!IMPORTANT]
   > Храните загруженный файл в безопасном месте или удалите его, когда вы закончите с ним, потому что он содержит сертификат, который может быть использован для управления службами Azure.

    [!code-console[Main](the-fix-it-sample-application/samples/sample22.cmd)]

    Сертификат используется для вызова REST API, который обнаруживает IP-адрес машины разработки, чтобы установить правило брандмауэра на сервере базы данных S'L.
7. Выполнить [cmdlet Set-Location](https://go.microsoft.com/fwlink/p/?linkid=293912) (псевдонимы `chdir`, `sl` `cd`и) для навигации по каталогу, который содержит сценарии. (Они расположены в папке *Автоматизация* в папке решения Fix It.) Поместите путь в кавычки, если какое-либо из имен каталога содержит пробелы. Например, для навигации по каталогу `c:\Sample Apps\FixIt\Automation` можно ввести следующую команду:

    [!code-console[Main](the-fix-it-sample-application/samples/sample23.cmd)]
8. Чтобы позволить Windows PowerShell запускать эти скрипты, используйте [cmdlet Unblock-File.](https://go.microsoft.com/fwlink/p/?linkid=294021) (Скрипты заблокированы, потому что они были загружены из Интернета.)

    > [!WARNING]
    > Безопасность - `Unblock-File` Перед запуском любого скрипта или исполняемого файла, откройте файл в блокноте, изучите команды и убедитесь, что они не содержат вредоносного кода.

    Например, следующая команда `Unblock-File` запускает cmdlet на всех скриптах в текущем каталоге.

    [!code-console[Main](the-fix-it-sample-application/samples/sample24.cmd)]
9. Чтобы создать веб-приложение для базового (без обработки очередей) Исправить его приложение, запустите сценарий создания среды.

    Необходимый `Name` параметр определяет имя базы данных, а также используется для учетной записи хранилища, которую создает скрипт. Имя должно быть глобально уникальным в azurewebsites.net домене. Если вы укажете имя, которое не является уникальным, как Fixit или `New-AzureWebsite` Test (или даже как в примере, fixitdemo), cmdlet не справляется с внутренней ошибкой, которая сообщает о конфликте. Скрипт преобразует имя во все нижние кейсы в соответствии с требованиями к именам для веб-приложений, учетных записей хранения данных и баз данных.

    Необходимый `SqlDatabasePassword` параметр определяет пароль для учетной записи администрирования, которая будет создана для базы данных S'L. Не включайте в пароль специальные&amp; &lt; &gt; символы XML (;). Это ограничение способа написания скриптов, а не ограничение Azure.

    Например, если вы хотите создать веб-приложение под названием "fixitdemo" и использовать пароль администратора сервера S'L "Passw0rd1", вы можете ввести следующую команду:

    [!code-console[Main](the-fix-it-sample-application/samples/sample25.cmd)]

    Имя должно быть уникальным в домене azurewebsites.net, а пароль должен соответствовать требованиям базы данных s'L для сложности пароля. (Пример Passw0rd1 соответствует требованиям.)

    Обратите внимание, что команда начинается с ". \". Чтобы предотвратить вредоносное исполнение скриптов, Windows PowerShell требует, чтобы вы предоставили полностью квалифицированный путь к файлу скрипта при запуске скрипта. Вы можете использовать точку для обозначения\"текущего каталога (". ) или обеспечить полностью квалифицированный путь, например:

    [!code-console[Main](the-fix-it-sample-application/samples/sample26.cmd)]

    Для получения дополнительной информации `Get-Help` о скрипте используйте cmdlet.

    [!code-console[Main](the-fix-it-sample-application/samples/sample27.cmd)]

    Вы можете `Detailed` `Full`использовать, `Parameters`и `Examples` параметры Get-Help cmdlet для фильтрации справки, которая возвращается.

    Если скрипт не работает или генерирует ошибки, такие как "New-AzureWebsite: Call Set-AzureSubscription и Select-AzureSubscription first", возможно, вы не завершили конфигурацию Azure PowerShell.

    После завершения скрипта можно использовать портал управления Azure для просмотра созданных ресурсов, как показано в главе [«Автоматизировать все».](automate-everything.md)
10. Для развертывания проекта FixIt в новой среде Azure используйте скрипт *AzureWebsite.ps1.* Пример:

    [!code-console[Main](the-fix-it-sample-application/samples/sample28.cmd)]

    Когда развертывание завершено, браузер открывается с Fix It, работающим в Azure.

<a id="troubleshooting"></a>
## <a name="troubleshooting-the-windows-powershell-scripts"></a>Устранение неполадок скриптов Windows PowerShell

Наиболее распространенные ошибки, возникающие при запуске этих скриптов, связаны с разрешениями. Убедитесь, `Add-AzureAccount` `Import-AzurePublishSettingsFile` что и были успешными, и что вы использовали их для той же подписки Azure. Даже `Add-AzureAccount` если был успешным, вы, возможно, придется запустить его снова. Разрешения, добавленные, `Add-AzureAccount` истекают через 12 часов.

### <a name="object-reference-not-set-to-an-instance-of-an-object"></a>Ссылка на объект не указывает на экземпляр объекта.

Если скрипт возвращает ошибки, такие как "Объектная ссылка, не установленная на экземпляр объекта", что означает, что Windows `Add-AzureAccount` PowerShell не может найти объект для обработки (это исключение с нулевым), запустите cmdlet и попробуйте сценарий еще раз.

[!code-console[Main](the-fix-it-sample-application/samples/sample29.cmd)]

### <a name="internalerror-the-server-encountered-an-internal-error"></a>Внутренняя ошибка: Сервер столкнулся с внутренней ошибкой.

Cmdlet `New-AzureWebsite` возвращает внутреннюю ошибку, когда имя не является уникальным в домене azurewebsites.net. Чтобы устранить ошибку, используйте другое значение для имени, которое находится в параметре имени *New-AzureWebsiteEnv.ps1*.

[!code-console[Main](the-fix-it-sample-application/samples/sample30.cmd)]

### <a name="restarting-the-script"></a>Перезапуск скрипта

Если вам необходимо перезапустить скрипт *New-AzureWebsiteEnv.ps1,* поскольку он не сработал до того, как он распечатал сообщение "Сценарий завершен", может потребоваться удалить ресурсы, созданные скриптом до его остановки. Например, если скрипт уже создал веб-приложение ContosoFixItDemo и вы снова запустите сценарий с тем же именем, скрипт не удастся, потому что имя используется.

Чтобы определить, какие ресурсы создал сценарий до его остановки, используйте следующие cmdlets:

- `Get-AzureWebsite`
- `Get-AzureSqlDatabaseServer`
- `Get-AzureSqlDatabase`: Чтобы запустить этот cmdlet, труба имя сервера базы `Get-AzureSqlDatabase`данных:`Get-AzureSqlDatabaseServer | Get-AzureSqlDatabase.`

Чтобы удалить эти ресурсы, используйте следующие команды. Обратите внимание, что при удалении сервера базы данных вы автоматически удаляете базы данных, связанные с сервером.

- `Get-AzureWebsite -Name <WebsiteName> | Remove-AzureWebsite`
- `Get-AzureSqlDatabase -Name <DatabaseName> -ServerName <DatabaseServerName> | Remove-SqlAzureDatabase`
- `Get-AzureSqlDatabaseServer | Remove-AzureSqlDatabaseServer`

<a id="deployqueues"></a>
## <a name="how-to-deploy-the-app-with-queue-processing-to-azure-app-service-web-apps-and-an-azure-cloud-service"></a>Как развернуть приложение с обработкой очередей в Web Apps App Apps и облачную службу Azure

Чтобы включить очереди, внести следующие изменения в файл MyFixIt-Web.config. Под, `appSettings`изменить значение `UseQueues` к "истинному":

[!code-xml[Main](the-fix-it-sample-application/samples/sample31.xml)]

Затем развернуть приложение MVC в веб-приложении в Azure App Service, как описано [ранее.](#deploybase)

Затем создайте новый облачный сервис Azure. Скрипты, включенные в приложение Fix It, не создают и не развертывают облачный сервис, поэтому для этого необходимо использовать портал Azure. На портале нажмите **New** -- **Compute** — **Облачный сервис** -- **Быстро создает,** а затем вводит URL-адрес и местоположение центра обработки данных. Используйте тот же центр обработки данных, где вы развернули веб-приложение.

![](the-fix-it-sample-application/_static/image1.png)

Прежде чем развернуть облачный сервис, необходимо обновить некоторые файлы конфигурации.

В MyFixIt.WorkerRole-app.appig, `connectionStrings`под , заменить значение строки `appdb` соединения с фактической строки соединения для базы данных S'L. Вы можете получить строку соединения с портала. На портале нажмите на строки - **appdb-приложений** -  **S'L Database**для**ADO .Net, ODBC, PHP и JDBC.** Копируйте строку ADO.NET соединения и вставьте значение в файл app.config. Замените пароль\_\_здесь на пароль базы данных. (Предполагая, что вы использовали скрипты для развертывания приложения MVC, вы указали пароль базы данных в параметре `SqlDatabasePassword` скрипта.)

Результат должен выглядеть следующим образом:

[!code-xml[Main](the-fix-it-sample-application/samples/sample32.xml)]

В том же файле MyFixIt.WorkerRole'app.app.appig под `appSettings`заменой двух значений заполнителя для учетной записи хранения Azure.

[!code-xml[Main](the-fix-it-sample-application/samples/sample33.xml?highlight=2-3)]

Ключ доступа можно получить на портале. [Узнайте, как управлять учетными записями хранения данных.](https://docs.microsoft.com/azure/storage/common/storage-create-storage-account)

В MyFixItCloudService-ServiceConfiguration.Cloud.cscfg замените те же значения двух заполнителей для учетной записи хранения Azure.

[!code-xml[Main](the-fix-it-sample-application/samples/sample34.xml?highlight=3)]

Теперь вы готовы к развертыванию облачного сервиса. В solution Explore, правой кнопкой мыши на myFixItCloudService проекта и выберите **Опубликовать**. Для получения дополнительной информации [this tutorial](https://code.msdn.microsoft.com/Windows-Azure-Multi-Tier-eadceb36)см.[Deploy the Application to Azure](https://www.windowsazure.com/develop/net/tutorials/multi-tier-web-site/2-download-and-run/#deployAz)

> [!div class="step-by-step"]
> [Назад](more-patterns-and-guidance.md)
