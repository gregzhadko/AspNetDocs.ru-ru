---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/the-fix-it-sample-application
title: Приложение. Исправление пример приложения (Создание реальных облачных приложений с помощью Azure) | Документация Майкрософт
author: MikeWasson
description: Создание реальных облачных приложений в условиях электронная книга основана на презентацию, разработанная Скоттом Гатри. Здесь объясняется, 13 шаблонов и практических рекомендаций, которые он может...
ms.author: riande
ms.date: 06/12/2014
ms.assetid: 1bc333c5-f096-4ea7-b170-779accc21c1a
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/the-fix-it-sample-application
msc.type: authoredcontent
ms.openlocfilehash: a73fac6107be45455465b506a019bcc9a41b1deb
ms.sourcegitcommit: 289e051cc8a90e8f7127e239fda73047bde4de12
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/25/2019
ms.locfileid: "58425526"
---
<a name="appendix-the-fix-it-sample-application-building-real-world-cloud-apps-with-azure"></a>Приложение. Исправление пример приложения (Создание реальных облачных приложений с помощью Azure)
====================
по [Майк Уоссон](https://github.com/MikeWasson), [Рик Андерсон]((https://twitter.com/RickAndMSFT)), [том Дайкстра](https://github.com/tdykstra)

[Загрузите исправление, его проекта](http://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4)

> **Создание реальных облачных приложений в условиях Azure** электронная книга основана на презентацию, разработанная Скоттом Гатри. Здесь объясняется 13 шаблоны и рекомендации, которые помогут вам быть в успешном развертывании веб-приложений для облака. Сведения о книге, см. в разделе [первой главы](introduction.md).

В этом приложении для создание реальных облачных приложений в условиях электронная книга содержит следующие разделы, предоставляющие дополнительные сведения о Fix It примера приложения, который можно загрузить.

- [Известные проблемы](#knownissues)
- [Рекомендации](#bestpractices)
- [Как запустить приложение из Visual Studio на локальном компьютере](#run-in-vs)
- [Развертывание базового приложения на веб-приложениях службы приложений Azure с помощью сценариев Windows PowerShell](#deploybase)
- [Устранение неполадок сценариев Windows PowerShell](#troubleshooting)
- [Как развернуть приложение с очередью, обработку для веб-приложениях службы приложений Azure и в облачной службе Azure](#deployqueues)

<a id="knownissues"></a>
## <a name="known-issues"></a>Известные проблемы

Приложение Fix It было разработано в качестве примера просто максимально некоторые шаблоны, представленные в этой электронной книги. Тем не менее так как в книге рассматривается построение реальных приложений, мы распространяется кода Fix It для проверки и тестирования процесс аналогичен мы бы сделать для версии программного обеспечения. Мы обнаружили несколько проблем и как и в случае с любым приложением реального мира, некоторые из них мы исправили и некоторые из них мы откладывается до более поздней версии.

Ниже перечислены проблемы, которые должны быть решены в рабочем приложении, но для той или иной, которые мы решили не адрес в первоначальном выпуске примера приложения ее исправить.

### <a name="security"></a>Безопасность

- Убедитесь в том, что нельзя назначить задачи владельца не существует.
- Убедитесь, что вы можете только просматривать и изменять задач, созданных или назначенных вам.
- Используйте HTTPS для страниц входа в систему и файлы cookie проверки подлинности.
- Укажите время, выделенное для файлов cookie проверки подлинности.

### <a name="input-validation"></a>Проверка входных данных

Как правило, делается рабочего приложения более проверкой ввода, чем приложения ее исправить. Например, размер образа / image допустимый размер файла для загрузки, должны быть ограничены.

### <a name="administrator-functionality"></a>Функциональные возможности администратора

Администратор должен иметь возможность изменить владельца на существующие задачи. Например создателя задачи может покинуть компанию, оставляя никто с полномочиями для поддержания задачи, пока не будет включен доступ с правами администратора.

### <a name="queue-message-processing"></a>Обработка сообщений в очереди

Сообщение очереди, обработки в приложении Fix It была разработана для быть упрощен с целью демонстрации основе очередей рабочий шаблон с помощью минимального количества кода. Этот простой код не подходить для приложения производства.

- Код не гарантирует, что каждое сообщение очереди будет обрабатываться не более одного раза. При получении сообщения из очереди, то есть период ожидания, во время которого сообщение остается невидимым для других прослушивателей очередей. Если время ожидания истекает до сообщение удаляется, то сообщение снова становится видимым. Таким образом Если в экземпляр рабочей роли тратит много времени обработки сообщения, это теоретически возможно для того же сообщения будут обработаны дважды, приводит к повторяющиеся задачи в базе данных. Дополнительные сведения об этой проблеме см. в разделе [очереди службы хранилища Azure с помощью](https://msdn.microsoft.com/library/ff803365.aspx#sec7).
- Логика опроса очереди может быть более экономичным, пакетное выполнение извлечения сообщения. Каждый раз при вызове [CloudQueue.GetMessageAsync](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.getmessageasync.aspx), оплачивается транзакции. Вместо этого можно вызвать [CloudQueue.GetMessagesAsync](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.getmessagesasync.aspx) (Обратите внимание, plural "), которая получает несколько сообщений в одной транзакции. Затраты на транзакции для очереди службы хранилища Azure являются очень мало, поэтому влияние на затраты, не является существенным в большинстве сценариев.
- Непрерывном цикле в коде обработки сообщения очереди вызывает сходство ЦП, который не использует виртуальные машины несколькими ядрами эффективно. Параллелизм задач лучше использовать для параллельного выполнения нескольких асинхронных задач.
- Обработка сообщений очереди предусмотрена обработка только элементарные исключение. Например, код не может обработать [сообщения о сбое](https://msdn.microsoft.com/library/ms789028.aspx). (При обработке сообщений возникает исключение, необходимо записать ошибку в журнал и удалить сообщение, или рабочей роли будет пытаться обрабатывать ее снова, и цикл продолжается неограниченно долго.)

### <a name="sql-queries-are-unbounded"></a>SQL-запросы не ограничены

Текущий код Fix It размещает отсутствие ограничений на количество строк, то запросы для страниц индексов могут возвращать. Если большое количество задач вводится в базу данных, размер полученных итоговый списков могут вызывать проблемы производительности. Рекомендуется реализовать разбиение по страницам. Например, см. в разделе [сортировку, фильтрацию и разбиение по страницам с Entity Framework в приложении MVC ASP.NET](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md).

### <a name="view-models-recommended"></a>Просмотр моделей рекомендуется

Приложение Fix It использует класс сущностей FixItTask для передачи сведений между контроллером и представлением. Мы рекомендуем использовать модели представления. Модель предметной области (например, класс сущности FixItTask) разработано на основе необходимых для сохранения данных, а модель представления может разрабатываться для представления данных. Дополнительные сведения см. в разделе [12 ASP.NET MVC рекомендаций](http://codeclimber.net.nz/archive/2009/10/27/12-asp.net-mvc-best-practices.aspx).

### <a name="secure-image-blob-recommended"></a>Большой двоичный объект безопасный образ рекомендуется

Магазины приложений Fix It Отправить изображения как открытые, это означает, что любой кто найдет этот URL-адрес можно получить доступ к изображения. Изображения можно было защитить, а не общедоступным.

### <a name="no-powershell-automation-scripts-for-queues"></a>Скрипты автоматизации не PowerShell для очередей

Примеры сценариев PowerShell автоматизации были написаны только для базовой версии Fix It, полностью выполняется в веб-приложениях службы приложений Azure. Мы не указали скрипты для установки и развертывания веб-приложения, а также среду облачной службы, необходимые для обработки очередей.

### <a name="special-handling-for-html-codes-in-user-input"></a>Специальная обработка кодов HTML в ввод данных пользователем

ASP.NET автоматически предотвращает множество способов, в которых пользователи-злоумышленники могут попытаться атаки с использованием межузловых сценариев, введя скрипт в поля ввода текста пользователем. И MVC `DisplayFor` вспомогательный метод, используемый для отображения задач названия и заметки о автоматически кодирует в HTML значения, отправляемых в браузер. Однако в рабочем приложении может потребоваться принять дополнительные меры. Дополнительные сведения см. в разделе [проверки запросов в ASP.NET](https://msdn.microsoft.com/library/hh882339.aspx).

<a id="bestpractices"></a>
## <a name="best-practices"></a>Рекомендации

Ниже приведены некоторые проблемы, появившиеся после, обнаруженных при проверке кода и тестирование исходная версия приложения ее исправить. Некоторые были вызваны исходного автору кода, не определенного рекомендуется учитывать некоторые просто потому, что код написан на быстро и не был предназначен для версии программного обеспечения. Мы выводе содержимого причины проблем здесь есть то, что мы узнали из этого проверки и тестирования, будут полезны другим пользователям, которые также при разработке веб-приложений.

### <a name="dispose-the-database-repository"></a>Dispose хранилище базы данных

`FixItTaskRepository` Класса должно быть освобождено Entity Framework `DbContext` экземпляра. Мы сделали это, реализовав `IDisposable` в `FixItTaskRepository` класса:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample1.cs)]

Обратите внимание, что автоматически удаляет AutoFac `FixItTaskRepository` экземпляра, поэтому нам не нужно явно удалять его.

Другой вариант заключается в удалении `DbContext` переменной-члена из `FixItTaskRepository`и вместо этого создайте локальную `DbContext` переменных в пределах каждого метода репозитория внутри `using` инструкции. Пример:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample2.cs)]

### <a name="register-singletons-as-such-with-di"></a>Таким образом зарегистрировать одноэлементные экземпляры с помощью внедрения Зависимостей

Поскольку только один экземпляр `PhotoService` класс и `Logger` требуется класс, эти классы должны быть [зарегистрирован как отдельные экземпляры для введения зависимостей](https://code.google.com/p/autofac/wiki/InstanceScope) в *DependenciesConfig.cs*:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample3.cs?highlight=1,3)]

### <a name="security-dont-show-error-details-to-users"></a>Безопасность: Больше не показывать сведения об ошибке для пользователей

Исходное приложение Fix It не имеют типовой страницы ошибки и просто оставить все пузырек исключения до пользовательского интерфейса, поэтому некоторые исключения, такие как ошибки подключения базы данных может привести к полной трассировке стека отображаемая в браузере. Подробные сведения об ошибке иногда может способствовать атаке злоумышленников. Решение — вход в сведениях об исключении и отображаться страница ошибки пользователю, который не содержит сведения об ошибке. Уже ведение журнала приложения ее исправить, и чтобы отобразить страницу ошибки, мы добавили `<customErrors mode=On>` в файле Web.config.

[!code-xml[Main](the-fix-it-sample-application/samples/sample4.xml?highlight=2)]

По умолчанию это приводит к *Views\Shared\Error.cshtml* для отображения ошибок. Вы можете настроить *Error.cshtml* или создайте собственное представление страницы ошибки и добавьте `defaultRedirect` атрибута. Можно также указать другую ошибку страницы для конкретных ошибок.

### <a name="security-only-allow-a-task-to-be-edited-by-its-creator"></a>Безопасность: разрешить только задачу, которую нужно изменить ее создателем

Страница индекса панели мониторинга отображаются только те задачи, созданные пользователем, вошедшего в систему, но пользователь-злоумышленник может создать URL-адрес с Идентификатором задачей другого пользователя. Мы добавили код в *DashboardController.cs* возвращать ошибку 404, в этом случае:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample5.cs?highlight=9-14,24-29)]

### <a name="dont-swallow-exceptions"></a>Не проглатывания исключений

Исходное приложение Fix It просто вернул значение null после входа исключения, полученное в результате SQL-запроса:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample6.cs?highlight=4)]

Это сделает его видеть пользователи, как в том случае, если запрос выполнено успешно, но только не возвратил никаких строк. Решением является повторно создавать исключение после перехвата и ведения журнала:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample7.cs)]

### <a name="catch-all-exceptions-in-worker-roles"></a>Перехватывать все исключения в рабочих ролях

Все необработанные исключения в рабочей роли приведет к перезапуску виртуальной Машины, поэтому необходимо поместить все в блок try-catch и обрабатывать все исключения.

### <a name="specify-length-for-string-properties-in-entity-classes"></a>Указание длины строковых свойств в классах сущностей

Для отображения простого кода, исходная версия приложения Fix It не были указаны значения длины для полей сущности FixItTask и поэтому они были определены как varchar(max) в базе данных. Таким образом пользовательский Интерфейс принимали практически любого объема входных данных. Указав применяются оба пользователю ограничения длины наборов входных данных в веб-страницы и размер столбца в базе данных:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample8.cs?highlight=4,7,10,12,14)]

### <a name="mark-private-members-as-readonly-when-they-arent-expected-to-change"></a>Пометить закрытых членов только для чтения, когда они не ожидаются для изменения

Например, в `DashboardController` класса экземпляра `FixItTaskRepository` создается и не должен изменить, поэтому мы определили его как [readonly](https://msdn.microsoft.com/library/acdd6hb7.aspx).

[!code-csharp[Main](the-fix-it-sample-application/samples/sample9.cs?highlight=3)]

### <a name="use-listany-instead-of-listcount-gt-0"></a>Используйте список. Any() вместо списка. Count() &gt; 0

Если вы все интересующие вас ли один или несколько элементов в списке соответствуют указанным критериям, используйте [любой](https://msdn.microsoft.com/library/bb534972.aspx) метод, поскольку он возвращает как только обнаруживается элемент подгонки критерии, тогда как `Count` всегда имеет метод для выполнения итерации через каждый элемент. Панели мониторинга *Index.cshtml* файл изначально содержал этот код:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample10.cshtml)]

Мы изменили его на это:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample11.cshtml?highlight=1)]

### <a name="generate-urls-in-mvc-views-using-mvc-helpers"></a>Создание URL-адреса в представлений MVC с помощью вспомогательных методов MVC

Для **создать Fix It** кнопки на домашней странице, Fix It приложение жестких закодированных элемент привязки:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample12.cshtml)]

Для ссылки на представление/действия следующим образом лучше использовать [Url.Action](https://msdn.microsoft.com/library/system.web.mvc.urlhelper.action.aspx) вспомогательный метод HTML, например:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample13.cshtml)]

### <a name="use-taskdelay-instead-of-threadsleep-in-worker-role"></a>Используйте Task.Delay вместо Thread.Sleep в рабочей роли

Шаблон нового проекта помещает `Thread.Sleep` в образце кода для рабочей роли, но из-за чего в спящий режим может привести к породить дополнительные ненужные потоки пула потоков. Этого можно избежать, используя [Task.Delay](https://msdn.microsoft.com/library/hh139096.aspx) вместо этого.

[!code-csharp[Main](the-fix-it-sample-application/samples/sample14.cs?highlight=11)]

### <a name="avoid-async-void"></a>Избегайте async void

Если асинхронный метод не должно возвращать значение, возвращают `Task` типа вместо `void`.

Этот пример взят из `FixItQueueManager` класса:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample15.cs)]

Следует использовать `async void` только для обработчиков событий верхнего уровня. При определении метода в качестве `async void`, вызывающий объект не может **await** метода или перехватывайте любые исключения, метод создает исключение. Дополнительные сведения см. в разделе [рекомендации в асинхронное программирование](https://msdn.microsoft.com/magazine/jj991977.aspx).

### <a name="use-a-cancellation-token-to-break-from-worker-role-loop"></a>Использовать токен отмены для из этого цикла рабочей роли

Как правило **запуска** метод на рабочей роли содержит бесконечный цикл. Когда выполняется остановка рабочей роли, [RoleEntryPoint.OnStop](https://msdn.microsoft.com/library/windowsazure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) вызывается метод. Этот метод следует использовать для отмены работы, который выполняется внутри **запуска** метод и выхода корректно. В противном случае процесс может быть прерван в процессе выполнения операции.

### <a name="opt-out-of-automatic-mime-sniffing-procedure"></a>Отказаться от автоматической процедуры обнаружение типов MIME

В некоторых случаях Internet Explorer сообщает тип MIME, отличается от типа, заданного параметром веб-сервера. Например если Internet Explorer находит HTML содержимого в файле, присутствующие в заголовке ответа HTTP Content-Type: text/plain, Internet Explorer определяет, что содержимое должны отображаться в формате HTML. К сожалению это «MIME-сканирование» также может привести к проблем безопасности для серверов, размещающих ненадежное содержимое. Для борьбы с этой проблемой, Internet Explorer 8 внесла ряд изменений в код определение типа MIME и позволяет разработчикам приложений [отказаться от того, обнаружение типов MIME](https://blogs.msdn.com/b/ie/archive/2008/07/02/ie8-security-part-v-comprehensive-protection.aspx). Следующий код был добавлен к *Web.config* файл.

[!code-xml[Main](the-fix-it-sample-application/samples/sample16.xml?highlight=2-7)]

### <a name="enable-bundling-and-minification"></a>Включить объединение и Минификация

Когда Visual Studio создает новый веб-проекта, объединение и Минификация файлы JavaScript не включен по умолчанию. Мы добавили строку кода в BundleConfig.cs:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample17.cs?highlight=9)]

### <a name="set-an-expiration-time-out-for-authentication-cookies"></a>Установки завершения времени для файлов cookie проверки подлинности

По умолчанию файлы cookie проверки подлинности истекает через две недели. Более короткое время является более безопасным. Можно изменить этот параметр в *StartupAuth.cs*:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample18.cs?highlight=4-5)]

<a id="run-in-vs"></a>
## <a name="how-to-run-the-app-from-visual-studio-on-your-local-computer"></a>Как запустить приложение из Visual Studio на локальном компьютере

Для запуска приложения ее исправить двумя способами:

- Запустите базового приложения, который записывает новые задачи непосредственно к базе данных SQL.
- Запустите приложение с помощью очереди, а также в серверную службу для создания задачи. Шаблон очереди описан в главе [рабочий шаблон на основе очередей](queue-centric-work-pattern.md).

<a id="runbase"></a>
### <a name="run-the-base-application"></a>Запуск базового приложения

1. Установка [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=button+cta&utm_content=download+vs2017).
2. Установка [Azure SDK для .NET для Visual Studio](https://azure.microsoft.com/downloads/).
3. Скачайте ZIP-файл из [коллекции кода MSDN](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4).
4. В проводнике щелкните правой кнопкой мыши ZIP-файл и выберите пункт Свойства, а затем в окне свойств нажмите кнопку разблокировать.
5. Распакуйте файл.
6. Дважды щелкните файл SLN-файл для запуска Visual Studio.
7. Из **средства** меню, щелкните **диспетчер пакетов NuGet**, затем **консоль диспетчера пакетов**.
8. В консоли диспетчера пакетов (PMC), нажмите кнопку Восстановить.
9. Закройте Visual Studio.
10. Запуск [эмулятора хранения Azure](/azure/storage/common/storage-use-emulator).
11. Перезапустите Visual Studio, откройте файл решения вы закрыли на предыдущем шаге.
12. Убедитесь, что проект FixIt задан в качестве запускаемого проекта и нажмите клавишу CTRL + F5, чтобы запустить проект.

<a id="queueslocal"></a>
### <a name="run-the-application-with-queue-processing"></a>Запустите приложение с обработкой очереди

1. Следуйте указаниям, приведенным для [запуска базового приложения](#runbase), а затем закройте браузер и закрыть Visual Studio.
2. Запустите Visual Studio с правами администратора. (Вы будете использовать эмулятор вычислений Azure, и, требуются права администратора).
3. В приложении *Web.config* файл *MyFixIt* проекта (веб-проект), измените значение свойства `appSettings/UseQueues` «true»:

    [!code-console[Main](the-fix-it-sample-application/samples/sample19.cmd?highlight=3)]
4. Если [эмулятора хранения Azure](https://msdn.microsoft.com/library/windowsazure/hh403989.aspx) не все еще выполняется, запустите его снова.
5. Запустите FixIt веб-проект и проект MyFixItCloudService одновременно.

    С помощью Visual Studio:

   1. Нажмите клавишу **F5** для запуска проекта FixIt.
   2. В **обозревателе решений**, щелкните правой кнопкой мыши проект MyFixItCloudService и нажмите кнопку **Отладка** > **запустить новый экземпляр**.

    С помощью Visual Studio 2013 Express для Web.

   3. В обозревателе решений щелкните правой кнопкой мыши решение решить и выберите **свойства**.
   4. Выберите **несколько запускаемых проектов**.
   5. В **действие** выберите в раскрывающемся списке в разделе MyFixIt и MyFixItCloudService, **запустить**.
   6. Нажмите кнопку **ОК**.
   7. Нажмите клавишу **F5** запуск обоих проектов.

      При запуске проекта MyFixItCloudService, Visual Studio запускает эмулятор вычислений Azure. В зависимости от конфигурации брандмауэра необходимо разрешить в эмуляторе через брандмауэр.

<a id="deploybase"></a>
## <a name="how-to-deploy-the-base-app-to-azure-app-service-web-apps-by-using-the-windows-powershell-scripts"></a>Развертывание базового приложения на веб-приложениях службы приложений Azure с помощью сценариев Windows PowerShell

Чтобы проиллюстрировать [автоматизировать все, что](automate-everything.md) шаблон приложения ее исправить, сопровождаются скрипты, настроить среду в Azure и развертывание проекта в новую среду. Ниже описано, как с помощью сценариев.

Если вы хотите запустить в Azure без использования очередей, а после внесения изменений для локального выполнения с очередями, убедитесь, что значение UseQueues appSetting обратно в значение false, прежде чем продолжить приведенные ниже инструкции.

Эти инструкции предполагают, уже загружено и запустить решение Fix It локально, и что у вас есть Azure учетной записи или нет подписки Azure, вы можете управлять.

1. Установка **Azure PowerShell** консоли. Инструкции см. в разделе [описывается установка и настройка Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview?view=azurermps-4.3.1).

    Это специальная консоль настроена для работы с вашей подпиской Azure. Модуль Azure устанавливается в *Program Files* directory и автоматически импортируется на каждый использование консоли Azure PowerShell.

    Если вы предпочитаете работать в другой узел программы, такие как интегрированная среда Сценариев Windows PowerShell, обязательно используйте [Import-Module](https://go.microsoft.com/fwlink/?LinkID=141553) командлет для импорта модуля Аzure или использовать команду в модуле Azure для активации, автоматический импорт модуля.
2. Запустите Azure PowerShell с **Запуск от имени администратора** параметр.
3. Запустите [Set-ExecutionPolicy](https://go.microsoft.com/fwlink/p/?linkid=293941) командлет, чтобы задать политику выполнения Azure PowerShell `RemoteSigned`. Введите **Y** (для подтверждения) для завершения изменения политики.

    [!code-console[Main](the-fix-it-sample-application/samples/sample20.cmd)]

    Этот параметр позволяет запускать локальные сценарии, не имеющие цифровой подписи. (Можно также задать политику выполнения `Unrestricted`, что помогло бы исключить необходимость для шага unblock позже, но это не рекомендуется по соображениям безопасности.)
4. Запустите `Add-AzureAccount` командлет, чтобы настроить PowerShell, используя учетные данные для учетной записи.

    [!code-console[Main](the-fix-it-sample-application/samples/sample21.cmd)]

    Эти учетные данные действительны после определенного периода времени, и вам придется повторно выполнить `Add-AzureAccount` командлета. Как выполняется запись в этой электронной книге, предельное время до истечения срока действия учетных данных является 12 часов.
5. Если у вас несколько подписок, позволяет указать подписку, которую нужно создать тестовую среду в командлет Select-AzureSubscription.
6. Импортируйте сертификат управления для той же подписке Azure с помощью `Get-AzurePublishSettingsFile` и `Import-AzurePublishSettingsFile` командлетов. Первый из этих командлетов загружает файл сертификата, а во второй укажите расположение этого файла, чтобы импортировать его. > [!IMPORTANT]
   > Сохранить скачанный файл в безопасном месте или удалите его после завершения работы с, так как он содержит сертификат, который может использоваться для управления службами Azure.

    [!code-console[Main](the-fix-it-sample-application/samples/sample22.cmd)]

    Этот сертификат используется для вызова REST API, который обнаруживает IP-адрес компьютера разработки, чтобы задать правило брандмауэра на сервере базы данных SQL.
7. Запустите [Set-Location](https://go.microsoft.com/fwlink/p/?linkid=293912) командлет (псевдонимы `cd`, `chdir`, и `sl`) для перехода к каталогу, который содержит сценарии. (Они находятся в *автоматизации* папку в папке решения Fix It.) Заключите путь в кавычки, если какой-либо имен каталогов содержит пробелы. Например, чтобы перейти к `c:\Sample Apps\FixIt\Automation` directory, можно ввести следующую команду:

    [!code-console[Main](the-fix-it-sample-application/samples/sample23.cmd)]
8. Чтобы разрешить Windows PowerShell для запуска этих сценариев, используйте [Unblock-File](https://go.microsoft.com/fwlink/p/?linkid=294021) командлета. (Скрипты блокируются, так как они были загружены из Интернета).

    > [!WARNING]
    > Безопасность — перед запуском `Unblock-File` на любой сценарий или исполняемый файл, откройте файл в блокноте, проверить команды и убедитесь, что они не содержат любой вредоносный код.

    Например, следующая команда запускает `Unblock-File` командлет на всех скриптов в текущем каталоге.

    [!code-console[Main](the-fix-it-sample-application/samples/sample24.cmd)]
9. Создание веб-приложения для базового (очереди без обработки) решение приложения, выполните скрипт создания среды.

    Необходимая `Name` параметр указывает имя базы данных, а также используется для учетной записи хранения, который создает сценарий. Имя должно быть глобально уникальным в домене azurewebsites.net. Если указать имя, которое не является уникальным, как решить или теста (или даже как в примере, fixitdemo) `New-AzureWebsite` командлетов происходит сбой произошла внутренняя ошибка, которая сообщает о конфликте. Он преобразует имя в нижнем регистре в соответствии с требованиями имя веб-приложений, учетные записи хранения и баз данных.

    Необходимая `SqlDatabasePassword` параметр указывает пароль для учетной записи администратора, который будет создан для базы данных SQL. Не включать специальные символы XML в пароле (&amp; &lt; &gt; ;). Это ограничение определенным способом написания скриптов не ограничение в Azure.

    Например если вы хотите создать веб-приложения с именем «fixitdemo» и использовать пароль администратора SQL Server «Passw0rd1», можно ввести следующую команду:

    [!code-console[Main](the-fix-it-sample-application/samples/sample25.cmd)]

    Имя должно быть уникальным в домене azurewebsites.net, а пароль должен соответствовать требованиям базы данных SQL к сложности паролей. (Пример Passw0rd1 отвечает требованиям.)

    Обратите внимание, что команда начинается с «. \". Чтобы предотвратить выполнение вредоносных сценариев Windows PowerShell необходимо указать полный путь к файлу скрипта при запуске сценария. Для указания текущего каталога можно использовать точку (».\") или укажите полный путь, например:

    [!code-console[Main](the-fix-it-sample-application/samples/sample26.cmd)]

    Дополнительные сведения о сценарии использования `Get-Help` командлета.

    [!code-console[Main](the-fix-it-sample-application/samples/sample27.cmd)]

    Можно использовать `Detailed`, `Full`, `Parameters`, и `Examples` параметры командлета Get-Help для фильтрации справки, который возвращается.

    Если скрипт вызывает сбой или ошибки, такие как «New-AzureWebsite: Во-первых, вызвать Set-AzureSubscription и Select-AzureSubscription» может не завершена конфигурации Azure PowerShell.

    После выполнения сценария на портале управления Azure можно использовать для просмотра ресурсов, которые были созданы, в том случае, как показано в [автоматизировать все, что](automate-everything.md) главы.
10. Чтобы развернуть проект FixIt в новую среду Azure, используйте *AzureWebsite.ps1* скрипта. Пример:

    [!code-console[Main](the-fix-it-sample-application/samples/sample28.cmd)]

    После завершения развертывания в браузере откроется с Fix It работающих в Azure.

<a id="troubleshooting"></a>
## <a name="troubleshooting-the-windows-powershell-scripts"></a>Устранение неполадок сценариев Windows PowerShell

Наиболее распространенные ошибки, возникшие при выполнении этих сценариев связанных с разрешениями. Убедитесь, что `Add-AzureAccount` и `Import-AzurePublishSettingsFile` выполнены успешно, и использовать их для той же подписке Azure. Даже если `Add-AzureAccount` был успешно может потребоваться запустить его снова. Разрешения, добавленные `Add-AzureAccount` истекает через 12 часов.

### <a name="object-reference-not-set-to-an-instance-of-an-object"></a>Ссылка на объект не указывает на экземпляр объекта.

Если сценарий возвращает ошибки, такие как «Ссылка на объект не указывает на экземпляр объекта,» это означает, что Windows PowerShell не удается найти объект к процессу (это исключение null reference), запустите `Add-AzureAccount` командлета и повторите сценарий снова.

[!code-console[Main](the-fix-it-sample-application/samples/sample29.cmd)]

### <a name="internalerror-the-server-encountered-an-internal-error"></a>Внутренняя ошибка: Внутренняя ошибка сервера.

`New-AzureWebsite` Командлет возвращает внутреннюю ошибку, если имя не является уникальным в домене azurewebsites.net. Чтобы устранить эту ошибку, используйте другое значение для имени, которая находится на имя параметра *New AzureWebsiteEnv.ps1*.

[!code-console[Main](the-fix-it-sample-application/samples/sample30.cmd)]

### <a name="restarting-the-script"></a>Перезапустить сценарий

Если необходимо перезапустить *New AzureWebsiteEnv.ps1* сценария из-за его сбоя, прежде чем оно было напечатано сообщение «Сценарий завершена», может потребоваться удалить ресурсы, которые остановлены сценарий, созданный перед ним. Например если он уже создан ContosoFixItDemo веб-приложение и вы снова запустите сценарий с тем же именем, скрипт при этом завершится ошибкой, поскольку имя уже используется.

Чтобы определить, какие ресурсы сценарий, созданный до его остановки, используйте следующие командлеты:

- `Get-AzureWebsite`
- `Get-AzureSqlDatabaseServer`
- `Get-AzureSqlDatabase`: Чтобы выполнить этот командлет, передайте имя сервера базы данных, чтобы `Get-AzureSqlDatabase`:   `Get-AzureSqlDatabaseServer | Get-AzureSqlDatabase.`

Чтобы удалить эти ресурсы, используйте следующие команды. Обратите внимание, что при удалении сервера базы данных, вы автоматически удаления баз данных, связанных с сервером.

- `Get-AzureWebsite -Name <WebsiteName> | Remove-AzureWebsite`
- `Get-AzureSqlDatabase -Name <DatabaseName> -ServerName <DatabaseServerName> | Remove-SqlAzureDatabase`
- `Get-AzureSqlDatabaseServer | Remove-AzureSqlDatabaseServer`

<a id="deployqueues"></a>
## <a name="how-to-deploy-the-app-with-queue-processing-to-azure-app-service-web-apps-and-an-azure-cloud-service"></a>Как развернуть приложение с очередью, обработку для веб-приложениях службы приложений Azure и в облачной службе Azure

Чтобы включить очереди, внести следующие изменения в файл MyFixIt\Web.config. В разделе `appSettings`, измените значение свойства `UseQueues` «true»:

[!code-xml[Main](the-fix-it-sample-application/samples/sample31.xml)]

Затем развернуть приложение MVC в веб-приложение в службе приложений Azure, как описано [более ранних](#deploybase).

Создайте новую Azure облачную службу. Сценарии, в состав приложения Fix It не создаются и развертывание облачной службы, поэтому для этого необходимо использовать портал Azure. На портале, щелкните **New** -- **вычислений** — **облачной службы** -- **быстрое создание**, а затем введите URL-адрес и расположение центра обработки данных. Используйте в одном центре обработки данных, где вы развернули веб-приложения.

![](the-fix-it-sample-application/_static/image1.png)

Перед развертыванием облачной службы, необходимо обновить некоторые из файлов конфигурации.

В MyFixIt.WorkerRole\app.config в разделе `connectionStrings`, замените значение `appdb` строку подключения с фактической строкой подключения для базы данных SQL. Строку подключения можно получить на портале. На портале, щелкните **баз данных SQL** - **appdb** - **базы данных SQL представления строки подключения для ADO .net, ODBC, PHP и JDBC**. Скопируйте строку подключения ADO.NET и вставьте его в файл app.config. Замените «{вашей\_пароль\_здесь}» с пароль базы данных. (При условии, что использовать сценарии для развертывания приложения MVC, указанный пароль базы данных в `SqlDatabasePassword` скрипт параметр.)

Результат должен выглядеть следующим образом:

[!code-xml[Main](the-fix-it-sample-application/samples/sample32.xml)]

В этом же файле MyFixIt.WorkerRole\app.config под `appSettings`, замените два значения заполнителей для учетной записи хранения Azure.

[!code-xml[Main](the-fix-it-sample-application/samples/sample33.xml?highlight=2-3)]

Ключ доступа можно получить на портале. См. в разделе [управление учетными записями хранения](https://docs.microsoft.com/azure/storage/common/storage-create-storage-account).

В MyFixItCloudService\ServiceConfiguration.Cloud.cscfg замените две одинаковые значения заполнители для учетной записи хранения Azure.

[!code-xml[Main](the-fix-it-sample-application/samples/sample34.xml?highlight=3)]

Теперь все готово к развертыванию облачной службы. В обозревателе решений щелкните правой кнопкой мыши проект MyFixItCloudService и выберите **публикации**. Дополнительные сведения см. в разделе "[развертывание приложения в Azure](https://www.windowsazure.com/develop/net/tutorials/multi-tier-web-site/2-download-and-run/#deployAz)«, который находится во второй части [учебником](https://code.msdn.microsoft.com/Windows-Azure-Multi-Tier-eadceb36).

> [!div class="step-by-step"]
> [Назад](more-patterns-and-guidance.md)
