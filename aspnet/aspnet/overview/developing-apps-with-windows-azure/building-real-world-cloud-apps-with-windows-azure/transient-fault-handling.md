---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling
title: Обработка временных сбоев (создание облачных приложений в реальном мире с помощью Azure) | Документация Майкрософт
author: MikeWasson
description: Создание реальных облачных приложений с помощью электронной книги Azure основано на презентации, разработанной Скотт Гатри (. В нем объясняются 13 шаблонов и методик, которые могут...
ms.author: riande
ms.date: 11/03/2015
ms.assetid: 7ead83bc-c08c-4b26-8617-00e07292e35c
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling
msc.type: authoredcontent
ms.openlocfilehash: fc281e3d8f7c9edd4d98b029a67e58113132a8b3
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74583658"
---
# <a name="transient-fault-handling-building-real-world-cloud-apps-with-azure"></a>Обработка временных сбоев (создание облачных приложений в реальном мире с помощью Azure)

[Майк Уоссон](https://github.com/MikeWasson), [Рик Андерсон (]((https://twitter.com/RickAndMSFT)), том [Dykstra)](https://github.com/tdykstra)

[Скачивание решения ИТ-проекта](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4) или [Загрузка электронной книги](https://blogs.msdn.com/b/microsoft_press/archive/2014/07/23/free-ebook-building-cloud-apps-with-microsoft-azure.aspx)

> **Создание реальных облачных приложений с помощью** электронной книги Azure основано на презентации, разработанной Скотт Гатри (. В нем объясняются 13 шаблонов и методик, которые могут помочь в успешной разработке веб-приложений для облака. Сведения о электронной книге см. [в первой главе](introduction.md).

При проектировании реальных облачных приложений необходимо подумать о том, как управлять временными перерывами в работе служб. Эта проблема уникально важна в облачных приложениях, так как вы все зависит от сетевых подключений и внешних служб. Часто можно столкнуться с небольшими сбоями, которые обычно являются самовосстанавливающимися, и если вы не готовы к их обработке, они приведут к плохой работе ваших клиентов.

## <a name="causes-of-transient-failures"></a>Причины временных сбоев

В облачной среде вы обнаружите, что неудачные и удаленные подключения к базе данных происходят периодически. Это частично обусловлено тем, что вы используете больше подсистем балансировки нагрузки по сравнению с локальной средой, в которой веб-сервер и сервер базы данных имеют прямое физическое подключение. Кроме того, иногда, когда вы зависели от службы с несколькими клиентами, вы увидите, что вызовы службы будут медленнее или истекает, так как кто-то другой, кто использует эту службу, получит ее слишком много времени. В других случаях может быть пользователь, который слишком часто обращается к службе, а служба намеренно регулирует количество подключений, чтобы предотвратить неблагоприятное воздействие на других клиентов службы.

## <a name="use-smart-retryback-off-logic-to-mitigate-the-effect-of-transient-failures"></a>Используйте интеллектуальную логику повтора или возврата, чтобы уменьшить влияние временных сбоев.

Вместо того чтобы создавать исключение и выводить сообщение о недоступности или ошибке клиенту, можно распознавать ошибки, которые обычно являются временными, и автоматически повторять операцию, которая привела к ошибке, в надеется, до тех пор пока вы будете успешными. В большинстве случаев операция будет успешно выполнена во время второй попытки, и вы сможете восстановиться после ошибки, если клиент не знал о том, что возникла проблема.

Реализовать интеллектуальную логику повторов можно несколькими способами.

- Группа "шаблоны Майкрософт &amp; рекомендации" имеет [блок приложения для обработки временной ошибки](https://msdn.microsoft.com/library/dn440719(v=pandp.60).aspx) , который выполняет все действия, если вы используете ADO.NET для доступа к базе данных SQL (не с помощью Entity Framework). Вы просто устанавливаете политику для повторных попыток, сколько раз следует повторить запрос или команду, а также время ожидания между попытками — и заключение кода SQL в блок *using* .

    [!code-csharp[Main](transient-fault-handling/samples/sample1.cs)]

    ТФХ также поддерживает [Azure кэш роли](https://msdn.microsoft.com/library/windowsazure/dn386103.aspx) и [служебную шину](https://azure.microsoft.com/services/service-bus/).
- При использовании Entity Framework обычно вы не работаете напрямую с соединениями SQL, поэтому вы не можете использовать эти шаблоны и методики, но Entity Framework 6 создает этот тип логики повторных попыток непосредственно в платформе. Аналогичным образом указывается стратегия повтора, а затем EF использует эту стратегию при каждом обращении к базе данных.

    Чтобы использовать эту функцию в приложении Fix it, необходимо добавить класс, производный от *DbConfiguration* , и включить логику повторных попыток.

    [!code-csharp[Main](transient-fault-handling/samples/sample2.cs)]

    Для исключений базы данных SQL, которые платформа определяет как обычно временные ошибки, код, приведенный в этом примере, сообщает EF о необходимости повторить операцию до 3 раз с экспоненциальной задержкой между повторными попытками и максимальной задержкой в 5 секунд. Экспоненциальное обратное выключение означает, что после каждой неудачной попытки она будет ожидать более длительный период времени, прежде чем повторить попытку. Если три попытки в строке завершатся ошибкой, возникает исключение. В следующем разделе о механизме выключения цепи объясняется, почему требуется экспоненциальная откладывание и ограниченное число повторных попыток.

    При использовании службы хранилища Azure могут возникать аналогичные проблемы, так как ИТ-приложение для ИТ-приложений работает с большими двоичными объектами, а API клиента хранилища .NET уже реализует ту же логику. Вы просто указываете политику повтора или вам даже не нужно делать это, если вы довольны параметрами по умолчанию.

<a id="circuitbreakers"></a>
## <a name="circuit-breakers"></a>Выключатели цепи

Существует несколько причин, по которым вы не хотите повторять попытку слишком долгое время:

- Слишком много пользователей, которые постоянно пытаются выполнить невыполненные запросы, могут понизить работу других пользователей. Если миллионы людей выполняют несколько повторных запросов, можно привязать очереди диспетчеризации IIS и предотвратить обслуживание приложением запросов, которые в противном случае могли бы обработать успешно.
- Если все пытаются повторить операцию из-за сбоя службы, в очереди может быть так много запросов о том, что служба перестанет работать, когда начнется ее восстановление.
- Если ошибка вызвана регулированием и имеется окно времени, которое служба использует для регулирования, то при повторении повторных попыток можно переместить это окно и приступить к продолжению регулирования.
- Возможно, пользователь ожидает отображения веб-страницы. Слишком долго пользователи могут столкнуться с большим количеством неприятных попыток.

Экспоненциальное обратное отключение устраняет некоторые из этих проблем, ограничивая частоту повторных попыток, которые служба может получить из приложения. Но также *необходимо иметь автоматическое*выключение: это означает, что при определенных пороговых значениях повторная попытка приложения прекращается и выполняется какое-либо другое действие, например одно из следующих:

- Пользовательская резервная стратегия. Если вы не можете получить стоимость акций от Reuters, возможно, ее можно получить из Bloomberg; или, если вы не можете получить данные из базы данных, возможно, их можно получить из кэша.
- Без ошибок. Если вы не все, что нужно из службы, — не все или ничего для вашего приложения, просто возвратите значение null, если не удается получить данные. Если отображается задача Fix it, а служба BLOB-объектов не отвечает, можно отобразить сведения о задаче без изображения.
- Быстрое завершение. Ошибка пользователя во избежание переполнения службы с помощью запросов повторных попыток, которые могут привести к нарушению работы службы для других пользователей или расширению окна регулирования. Можно отобразить понятное сообщение "повторить попытку позже".

Не существует универсальной политики повтора. Вы можете повторить попытку больше времени и подождать в асинхронном фоновом рабочем процессе, чем в синхронном веб-приложении, где пользователь ожидает ответа. Между повторными попытками для службы реляционной базы данных можно подождать больше времени, чем для службы кэша. Ниже приведен пример рекомендуемых политик повторных попыток, которые помогут понять, как могут различаться числа. ("Быстрая первая" означает отсутствие задержки перед первой попыткой.

![Примеры политик повтора](transient-fault-handling/_static/image1.png)

Инструкции по использованию политики повтора базы данных SQL см. [в статье Устранение временных сбоев и ошибок подключения к базе данных SQL](https://azure.microsoft.com/documentation/articles/sql-database-connectivity-issues/).

## <a name="summary"></a>Сводка

Стратегия повтора и отката позволяет сделать временные ошибки невидимыми для клиента в большинстве случаев, и корпорация Майкрософт предоставляет платформы, которые можно использовать для того, чтобы сократить объем работ по реализации стратегии независимо от того, используете ли вы ADO.NET, Entity Framework или службу хранилища Azure.

В [следующей главе](distributed-caching.md)мы рассмотрим, как повысить производительность и надежность с помощью распределенного кэширования.

## <a name="resources"></a>Ресурсы

Дополнительные сведения см. в следующих источниках.

Документация

- Рекомендации [по проектированию крупномасштабных служб в облачных службах Azure](https://msdn.microsoft.com/library/windowsazure/jj717232.aspx). Технический документ, пометив SIMM и Майкл Сомасси. Как и в случае с отказоустойчивостью, вы переходите к дополнительным сведениям. См. раздел телеметрии и диагностики.
- [Отказоустойчивость: руководство по устойчивым облачным архитектурам](https://msdn.microsoft.com/library/windowsazure/jj853352.aspx). Технический документ, (Marc Меркури, Ульрих Хоманн и Эндрю Товнхилл. Версия веб-страницы серии видеоматериалов по отказоустойчивости.
- [Шаблоны и методики Майкрософт. Руководство по Azure](https://msdn.microsoft.com/library/dn568099.aspx). См. раздел шаблон повторной попытки, шаблон супервизора агента планировщика.
- Отказоустойчивость [в базе данных SQL Azure](https://blogs.msdn.com/b/windowsazure/archive/2012/07/30/fault-tolerance-in-windows-azure-sql-database.aspx). Запись блога с помощью Тони Петросян.
- [Алгоритм устойчивости или повторной попытки подключения Entity Framework](https://msdn.microsoft.com/data/dn456835). Как использовать и настраивать функцию обработки временных сбоев Entity Framework 6.
- [Устойчивость подключений и перехват команд с помощью Entity Framework в приложении ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md). В четвертой серии руководств из девяти частей показано, как настроить функцию устойчивости подключения EF 6 для базы данных SQL.

Видео

- [Отказоустойчивость: создание масштабируемых отказоустойчивых облачных служб](https://channel9.msdn.com/Series/FailSafe). Серия из девяти частей, Ульрих Хоманн, (Marc Меркури и пометить SIMM. Предоставляет основные понятия и архитектурные принципы в очень удобном и интересном смысле, а также истории, полученные от работы группы консультирования клиентов Майкрософт (CAT) с реальными клиентами. См. обсуждение автоматических выключателей в серии 3, начиная с 40:55.
- [Создание больших: уроки, полученные от клиентов Azure, часть II](https://channel9.msdn.com/Events/Build/2012/3-030). Марк SIMM рассказывает о проектировании для сбоев, обработке временных сбоев и инструментировании всех.

Образец кода

- [Основы облачной службы в Azure](https://code.msdn.microsoft.com/Cloud-Service-Fundamentals-4ca72649). Пример приложения, созданный группой консультирования клиентов Microsoft Azure, который демонстрирует использование [блока обработки временной ошибки Enterprise Library](http://nuget.org/packages/EnterpriseLibrary.TransientFaultHandling/) (тфх). Дополнительные сведения см. в разделе [основы облачной службы уровень доступа к данным — обработка временных сбоев](https://social.technet.microsoft.com/wiki/contents/articles/18665.cloud-service-fundamentals-data-access-layer-transient-fault-handling.aspx). ТФХ рекомендуется использовать для доступа к базе данных непосредственно с помощью ADO.NET (без использования Entity Framework).

> [!div class="step-by-step"]
> [Назад](monitoring-and-telemetry.md)
> [Вперед](distributed-caching.md)
