---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/automate-everything
title: Автоматизируйте все (создание облачных приложений в реальном мире с помощью Azure) | Документация Майкрософт
author: MikeWasson
description: Создание реальных облачных приложений с помощью электронной книги Azure основано на презентации, разработанной Скотт Гатри (. В нем объясняются 13 шаблонов и методик, которые могут...
ms.author: riande
ms.date: 06/12/2014
ms.assetid: ba6e6baa-9b9f-471f-b39d-b007a3addadc
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/automate-everything
msc.type: authoredcontent
ms.openlocfilehash: e741a753a36ebdaefbff8eee0b38911785c716ac
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77457171"
---
# <a name="automate-everything-building-real-world-cloud-apps-with-azure"></a>Автоматизируйте все (создание облачных приложений в реальном мире с помощью Azure)

[Майк Уоссон](https://github.com/MikeWasson), [Рик Андерсон (](https://twitter.com/RickAndMSFT), том [Dykstra)](https://github.com/tdykstra)

[Скачивание решения ИТ-проекта](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4) или [Загрузка электронной книги](https://blogs.msdn.com/b/microsoft_press/archive/2014/07/23/free-ebook-building-cloud-apps-with-microsoft-azure.aspx)

> **Создание реальных облачных приложений с помощью** электронной книги Azure основано на презентации, разработанной Скотт Гатри (. В нем объясняются 13 шаблонов и методик, которые могут помочь в успешной разработке веб-приложений для облака. Введение в электронную книгу см. [в первой главе](introduction.md).

Первые три шаблона, которые будут рассмотрены на самом деле, применимы к любому проекту разработки программного обеспечения, но, в частности, к облачным проектам. Этот шаблон предназначен для автоматизации задач разработки. Это важный раздел, поскольку процессы, выполняемые вручную, замедляют работу и подвержены ошибкам; Автоматизация максимально возможного количества элементов помогает настроить быстрый, надежный и гибкий рабочий процесс. Это уникально важно для разработки в облаке, так как вы можете легко автоматизировать многие задачи, которые трудно или невозможно автоматизировать в локальной среде. Например, можно настроить все тестовые среды, включая новые веб-серверы и серверные виртуальные машины, базы данных, хранилище BLOB-объектов (хранилище файлов), очереди и т. д.

## <a name="devops-workflow"></a>Рабочий процесс DevOps

Все чаще слышите термин «DevOps». Термин, разработанный с учетом того, что необходимо интегрировать задачи разработки и эксплуатации, чтобы эффективно разрабатывать программное обеспечение. Тип рабочего процесса, который вы хотите включить, — это один из них, в котором можно разрабатывать приложение, развертывать его, изучать использование в рабочей среде, изменять его в ответ на то, что вы узнали, и быстро и надежно повторять цикл.

Некоторые успешные команды разработки в облаке развертываются несколько раз в день в реальной среде. Команда Azure использовалась для развертывания крупного обновления каждые 2-3 месяцев, но теперь она выпускает незначительные обновления каждые 2-3 дней и основной выпуск каждые 2-3 недель. Это действительно помогает в реагировании на Отзывы клиентов.

Для этого необходимо включить цикл разработки и развертывания, который является повторяемым, надежным, прогнозируемым и имеет низкое время цикла.

![Рабочий процесс DevOps](automate-everything/_static/image1.png)

Иными словами, это период времени между тем, когда у вас есть идея для функции и когда клиенты используют ее и предоставление отзыва должно быть как можно более коротким. Первые три шаблона — Автоматизируйте все, систему управления версиями, непрерывную интеграцию и доставку, — все это рекомендации, которые рекомендуется использовать для реализации такого рода процессов.

## <a name="azure-management-scripts"></a>Сценарии управления Azure

В статье [Введение в эту электронную книгу](introduction.md)вы видели веб-консоль, портал управления Azure. Портал управления позволяет отслеживать все ресурсы, развернутые в Azure, и управлять ими. Это простой способ создания и удаления служб, таких как веб-приложения и виртуальные машины, настройки этих служб, наблюдения за работой службы и т. д. Это отличный инструмент, но его использование является ручным процессом. Если вы собираетесь разрабатывать рабочее приложение любого размера, особенно в среде группы, мы рекомендуем использовать пользовательский интерфейс портала, чтобы изучать и изучать Azure, а затем автоматизировать процессы, которые будут повторяться.

Практически все, что можно сделать вручную на портале управления или из Visual Studio, можно также сделать, вызвав API управления RESTFUL. Вы можете создавать сценарии с помощью [Windows PowerShell](https://msdn.microsoft.com/library/windowsazure/jj156055.aspx)или использовать платформу с открытым исходным кодом, например [Chef](http://www.opscode.com/chef/) или [Puppet](http://puppetlabs.com/puppet/what-is-puppet). Вы также можете использовать программу командной строки Bash в среде Mac или Linux. В Azure есть API-интерфейсы сценариев для всех этих сред, а также [API управления .NET](http://www.hanselman.com/blog/PennyPinchingInTheCloudAutomatingEverythingWithTheWindowsAzureManagementLibrariesAndNET.aspx) на случай, если требуется написать код вместо сценария.

Для ИТ-приложения мы создали сценарии Windows PowerShell, которые автоматизируют процессы создания тестовой среды и развертывания проекта в этой среде, и мы рассмотрим часть содержимого этих сценариев.

## <a name="environment-creation-script"></a>Скрипт создания среды

Первый сценарий, который мы рассмотрим, называется *Нев-азуревебситинв. ps1*. Она создает среду Azure, в которой можно развернуть приложение Fix ИТ для тестирования. Ниже перечислены основные задачи, выполняемые этим сценарием.

- Создайте веб-приложение.
- Создайте учетную запись хранения. (Требуется для больших двоичных объектов и очередей, как вы увидите в последующих главах.)
- Создайте сервер базы данных SQL и две базы данных: базу данных приложения и базу данных членства.
- Сохраняйте параметры в Azure, которые приложение будет использовать для доступа к учетной записи хранения и базам данных.
- Создайте файлы параметров, которые будут использоваться для автоматизации развертывания.

### <a name="run-the-script"></a>Выполнение скрипта

> [!NOTE]
> В этой части главы приводятся примеры сценариев и команд, вводимых для их запуска. Эта демонстрация и не предоставляет все, что нужно знать для выполнения сценариев. Пошаговые инструкции см. [в приложении. пример приложения Fix It](the-fix-it-sample-application.md#deploybase).

Чтобы запустить сценарий PowerShell, который управляет службами Azure, необходимо установить консоль Azure PowerShell и настроить ее для работы с подпиской Azure. После настройки вы можете запустить сценарий создания ИТ-среды и выполнить следующую команду:

`.\New-AzureWebsiteEnv.ps1 -Name <websitename> -SqlDatabasePassword <password>`

Параметр `Name` указывает имя, которое будет использоваться при создании базы данных и учетных записей хранения, а параметр `SqlDatabasePassword` указывает пароль для учетной записи администратора, которая будет создана для базы данных SQL. Можно использовать и другие параметры, которые будут рассмотрены позже.

![Окно PowerShell](automate-everything/_static/image2.png)

После завершения выполнения скрипта на портале управления можно увидеть, что было создано. Вы найдете две базы данных:

![Базы данных](automate-everything/_static/image3.png)

Учетная запись хранения:

![Учетная запись хранения](automate-everything/_static/image4.png)

И веб-приложение:

![Веб-сайт](automate-everything/_static/image5.png)

На вкладке **Настройка** веб-приложения можно увидеть, что у него есть параметры учетной записи хранения и строки подключения к базе данных SQL, настроенные для приложения Fix ИТ.

![appSettings и connectionString](automate-everything/_static/image6.png)

Папка *службы автоматизации* теперь также содержит файл *&lt;имя_веб-файла&gt;. pubxml* . В этом файле хранятся параметры, которые MSBuild будет использовать для развертывания приложения в среде Azure, которая была только что создана. Например:

[!code-xml[Main](automate-everything/samples/sample1.xml)]

Как видите, сценарий создал полную тестовую среду, и весь процесс выполняется примерно за 90 секунд.

Если кто-то другой участнику рабочей группы хочет создать тестовую среду, он сможет просто запустить сценарий. Это не только так быстро, но и может быть уверенным, что они используют среду, идентичную той, которую вы используете. Вы не смогли быть уверены, что если все пользователи настроили вручную с помощью пользовательского интерфейса портала управления.

### <a name="a-look-at-the-scripts"></a>Взгляните на скрипты

Существует три сценария, выполняющие эту задачу. Вы вызываете его из командной строки и автоматически использует два других для выполнения некоторых задач:

- *Нев-азуревебситинв. ps1* является основным сценарием.

    - *Нев-азурестораже. ps1* создает учетную запись хранения.
    - *Нев-азурескл. ps1* создает базы данных.

### <a name="parameters-in-the-main-script"></a>Параметры в основном скрипте

Основной сценарий, *Нев-азуревебситинв. ps1*, определяет несколько параметров:

[!code-powershell[Main](automate-everything/samples/sample2.ps1)]

Требуются два параметра:

- Имя веб-приложения, создаваемого сценарием. (Это также можно использовать для URL-адреса: `<name>.azurewebsites.net`.)
- Пароль для нового пользователя с правами администратора сервера базы данных, создаваемого сценарием.

Необязательные параметры позволяют указать расположение центра обработки данных (по умолчанию — "Западная часть США"), имя администратора сервера базы данных (по умолчанию — "дбусер") и правило брандмауэра для сервера базы данных.

### <a name="create-the-web-app"></a>Создание веб-приложения

Первое, что делает сценарий, — это создание веб-приложения путем вызова командлета `New-AzureWebsite`, передавая ему значения имени веб-приложения и параметра Location:

[!code-powershell[Main](automate-everything/samples/sample3.ps1?highlight=2)]

### <a name="create-the-storage-account"></a>Создание учетной записи хранения

Затем главный скрипт запускает сценарий *Нев-азурестораже. ps1* , указывая "&lt;" *&gt;* хранилище "для имени учетной записи хранения и расположение центра обработки данных, в котором находится веб-приложение.

[!code-powershell[Main](automate-everything/samples/sample4.ps1?highlight=3)]

*Нев-азурестораже. ps1* вызывает командлет `New-AzureStorageAccount` для создания учетной записи хранения и возвращает значения имени учетной записи и ключа доступа. Приложению понадобятся эти значения для доступа к BLOB-объектам и очередям в учетной записи хранения.

[!code-powershell[Main](automate-everything/samples/sample5.ps1?highlight=2)]

Вы не всегда можете создать новую учетную запись хранения. Вы можете усовершенствовать сценарий, добавив параметр, который дополнительно направляет его для использования существующей учетной записи хранения.

### <a name="create-the-databases"></a>Создание баз данных

Затем основной скрипт запускает сценарий создания базы данных *Нев-азурескл. ps1*после настройки имен баз данных и правил брандмауэра по умолчанию:

[!code-powershell[Main](automate-everything/samples/sample6.ps1)]

[!code-powershell[Main](automate-everything/samples/sample7.ps1?highlight=2)]

Сценарий создания базы данных получает IP-адрес компьютера разработки и устанавливает правило брандмауэра, чтобы компьютер разработки мог подключаться к серверу и управлять им. Затем сценарий создания базы данных проходит несколько шагов для настройки баз данных.

- Создает сервер с помощью командлета `New-AzureSqlDatabaseServer`.

    [!code-powershell[Main](automate-everything/samples/sample8.ps1?highlight=1)]
- Создает правила брандмауэра, позволяющие компьютеру разработки управлять сервером и включать веб-приложение для подключения к нему. 

    [!code-powershell[Main](automate-everything/samples/sample9.ps1?highlight=3,5)]
- Создает контекст базы данных, включающий имя сервера и учетные данные, с помощью командлета `New-AzureSqlDatabaseServerContext`.

    [!code-powershell[Main](automate-everything/samples/sample10.ps1?highlight=4)]

    `New-PSCredentialFromPlainText` — это функция в скрипте, которая вызывает командлет `ConvertTo-SecureString` для шифрования пароля и возвращает объект `PSCredential`, тот же тип, который возвращает командлет `Get-Credential`.
- Создает базу данных приложения и базу данных членства с помощью командлета `New-AzureSqlDatabase`.

    [!code-powershell[Main](automate-everything/samples/sample11.ps1?highlight=2,5)]
- Вызывает локально определенную функцию для создания строки подключения для каждой базы данных. Приложение будет использовать эти строки подключения для доступа к базам данных. 

    [!code-powershell[Main](automate-everything/samples/sample12.ps1?highlight=1-2)]

    Get-Склазуредатабасеконнектионстринг — это функция, определенная в скрипте, который создает строку подключения из значений параметров, указанных для нее.

    [!code-powershell[Main](automate-everything/samples/sample13.ps1?highlight=1)]
- Возвращает хэш-таблицу с именем сервера базы данных и строками подключения.

    [!code-powershell[Main](automate-everything/samples/sample14.ps1)]

Приложение для устранения проблем использует отдельные базы данных членства и приложений. Также можно разместить данные членства и приложений в одной базе данных.

### <a name="store-app-settings-and-connection-strings"></a>Сохранение параметров приложения и строк подключения

В Azure есть функция, позволяющая хранить параметры и строки подключения, которые автоматически заменяют возвращаемые данные приложению при попытке чтения `appSettings` или `connectionStrings` коллекций в файле Web. config. Это альтернатива применению [преобразований Web. config](../../../../web-forms/overview/deployment/visual-studio-web-deployment/web-config-transformations.md) при развертывании. Дополнительные сведения см. в разделе [Хранение конфиденциальных данных в Azure](source-control.md#appsettings) далее в этой электронной книге.

Сценарий создания среды сохраняет в Azure все значения `appSettings` и `connectionStrings`, необходимые приложению для доступа к учетной записи хранения и базам данных при запуске в Azure.

[!code-powershell[Main](automate-everything/samples/sample15.ps1)]

[!code-powershell[Main](automate-everything/samples/sample16.ps1)]

[!code-powershell[Main](automate-everything/samples/sample17.ps1?highlight=2)]

[New Relic](http://newrelic.com/) — это платформа телеметрии, которая демонстрируется в главе [мониторинг и телеметрии](monitoring-and-telemetry.md) . Сценарий создания среды также перезапускает веб-приложение, чтобы убедиться, что оно использует новые параметры Relic.

[!code-powershell[Main](automate-everything/samples/sample18.ps1?highlight=2)]

### <a name="preparing-for-deployment"></a>Подготовка к развертыванию

В конце процесса сценарий создания среды вызывает две функции для создания файлов, которые будут использоваться скриптом развертывания.

Одна из этих функций создает профиль публикации *(&lt;файл имя_веб-файла&gt;. pubxml* ). Код вызывает REST API Azure для получения параметров публикации и сохраняет информацию в файле *. publishsettings* . Затем он использует сведения из этого файла вместе с файлом шаблона (*pubxml. Template*) для создания *pubxml* -файла, содержащего профиль публикации. Этот двухэтапный процесс имитирует действия, выполняемые в Visual Studio: Скачайте файл *publishsettings* и импортируйте его, чтобы создать профиль публикации.

Другая функция использует другой файл шаблона (веб-сайт — среда. шаблон) для создания файла *вебсите-енвиронмент. XML* , содержащего параметры, которые сценарий развертывания будет использовать вместе с файлом *pubxml* .

### <a name="troubleshooting-and-error-handling"></a>Устранение неполадок и обработка ошибок

Сценарии подобны программам: они могут завершиться неудачно, и когда им нужно узнать, как это можно сделать, и что привело к сбою. По этой причине сценарий создания среды изменяет значение переменной `VerbosePreference` с `SilentlyContinue` на `Continue`, чтобы отображались все подробные сообщения. Он также изменяет значение переменной `ErrorActionPreference` с `Continue` на `Stop`, чтобы скрипт был остановлен даже при возникновении устранимых ошибок:

[!code-powershell[Main](automate-everything/samples/sample19.ps1)]

Перед выполнением каких бы то ни было действий сценарий сохраняет время начала, чтобы можно было вычислить затраченное время по завершении:

[!code-powershell[Main](automate-everything/samples/sample20.ps1)]

После завершения работы скрипт отображает затраченное время:

[!code-powershell[Main](automate-everything/samples/sample21.ps1)]

И для каждой ключевой операции скрипт записывает подробные сообщения, например:

[!code-powershell[Main](automate-everything/samples/sample22.ps1)]

## <a name="deployment-script"></a>Скрипт развертывания

Что делает сценарий *Нев-азуревебситинв. ps1* для создания среды, сценарий *публиш-азуревебсите. ps1* выполняет развертывание приложения.

Скрипт развертывания получает имя веб-приложения из файла *вебсите-енвиронмент. XML* , созданного сценарием создания среды.

[!code-powershell[Main](automate-everything/samples/sample23.ps1)]

Он получает пароль пользователя развертывания из файла *publishsettings* :

[!code-powershell[Main](automate-everything/samples/sample24.ps1)]

Он выполняет команду [MSBuild](http://msbuildbook.com/) , которая выполняет сборку и развертывание проекта:

[!code-powershell[Main](automate-everything/samples/sample25.ps1)]

Если вы указали параметр `Launch` в командной строке, он вызывает командлет `Show-AzureWebsite`, чтобы открыть в браузере по умолчанию URL-адрес веб-сайта.

[!code-powershell[Main](automate-everything/samples/sample26.ps1?highlight=3)]

Скрипт развертывания можно запустить с помощью команды, подобной следующей:

`.\Publish-AzureWebsite.ps1 ..\MyFixIt\MyFixIt.csproj -Launch`

После этого браузер откроется с сайтом, запущенным в облаке, по URL-адресу `<websitename>.azurewebsites.net`.

![Исправление приложения для ИТ, развернутого в Windows Azure](automate-everything/_static/image7.png)

## <a name="summary"></a>Сводка

С помощью этих сценариев можно быть уверенным, что одни и те же действия всегда будут выполняться в том же порядке с использованием одних и тех же параметров. Это помогает гарантировать, что каждый разработчик в группе не пропустил что-либо несложное или несложное на своем компьютере что-либо, которое не будет работать точно так же, как в другом окружении или в рабочей среде другого члена группы.

Аналогичным образом большинство функций управления Azure, которые можно выполнять на портале управления, можно автоматизировать с помощью REST API, сценариев Windows PowerShell, API языка .NET или программы bash, которую можно запустить в Linux или Mac.

В [следующей главе](source-control.md) мы рассмотрим исходный код и объясните, почему важно включить скрипты в репозиторий исходного кода.

## <a name="resources"></a>Ресурсы

- [Установка и настройка Windows PowerShell для Azure](https://docs.microsoft.com/powershell/azure/overview?view=azurermps-4.3.1). В этой статье объясняется, как установить командлеты Azure PowerShell и установить сертификат, необходимый для управления учетной записью Azure на компьютере. Это отличное место для начала работы, так как оно также содержит ссылки на ресурсы для изучения собственно PowerShell.
- [Центр сценариев Azure](https://docs.microsoft.com/azure/automation/automation-runbook-gallery). WindowsAzure.com портал на ресурсы для разработки сценариев, управляющих службами Azure, со ссылками на руководства по началу работы, справочную документацию по командлетам и исходный код, а также примеры сценариев
- [Выходные Scripter: Начало работы с Azure и PowerShell](https://blogs.technet.com/b/heyscriptingguy/archive/2013/06/22/weekend-scripter-getting-started-with-windows-azure-and-powershell.aspx). В блоге, предназначенном для Windows PowerShell, эта публикация содержит общие сведения об использовании PowerShell для функций управления Azure.
- [Установите и настройте кросс-платформенный интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest). Руководство по началу работы для платформы сценариев Azure, которая работает на компьютерах Mac и Linux, а также в системах Windows.
- [Раздел программ командной строки в разделе Загрузка пакетов SDK и средств Azure](https://azure.microsoft.com/downloads/). Страница портала для документации и загружаемых файлов, связанных с программами командной строки для Azure.
- [Полная автоматизация с использованием библиотек управления Azure и .NET](http://www.hanselman.com/blog/PennyPinchingInTheCloudAutomatingEverythingWithTheWindowsAzureManagementLibrariesAndNET.aspx). Скотт Hanselman представляет API управления .NET для Azure.
- [Использование скриптов Windows PowerShell для публикации в средах разработки и тестирования](https://msdn.microsoft.com/library/azure/dn642480.aspx). Документация MSDN, в которой объясняется, как использовать скрипты публикации, которые Visual Studio автоматически создает для веб-проектов.
- [PowerShell Tools for Visual Studio 2013](https://visualstudiogallery.msdn.microsoft.com/c9eb3ba8-0c59-4944-9a62-6eee37294597). Расширение Visual Studio, добавляющее языковую поддержку для Windows PowerShell в Visual Studio.

> [!div class="step-by-step"]
> [Назад](introduction.md)
> [Вперед](source-control.md)
