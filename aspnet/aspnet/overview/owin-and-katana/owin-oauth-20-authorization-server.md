---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Сервер авторизации OAuth 2.0 OWIN | Документация Майкрософт
author: hongyes
description: Этот учебник поможет вам о том, как реализовать сервер авторизации OAuth 2.0 с помощью по промежуточного слоя OWIN OAuth. Это является расширенный учебник, только Настройка...
ms.author: riande
ms.date: 01/28/2019
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: b8451d2d9e346bd5e2f51ba45e48030a5221b549
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57059751"
---
# <a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="05b55-104">Сервер авторизации OAuth 2.0 OWIN</span><span class="sxs-lookup"><span data-stu-id="05b55-104">OWIN OAuth 2.0 Authorization Server</span></span>

> <span data-ttu-id="05b55-105">Этот учебник поможет вам о том, как реализовать сервер авторизации OAuth 2.0 с помощью по промежуточного слоя OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="05b55-105">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="05b55-106">Это дополнительно учебник, в котором только описаны шаги, чтобы создать сервер авторизации OAuth 2.0 OWIN.</span><span class="sxs-lookup"><span data-stu-id="05b55-106">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="05b55-107">Это пошаговое руководство.</span><span class="sxs-lookup"><span data-stu-id="05b55-107">This is not a step by step tutorial.</span></span> <span data-ttu-id="05b55-108">[Загрузить образец кода](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="05b55-108">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="05b55-109">Этой структуры не должен быть предназначен для может использоваться для создания безопасного рабочего приложения.</span><span class="sxs-lookup"><span data-stu-id="05b55-109">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="05b55-110">Этот учебник предназначен для предоставления только контур о том, как реализовать сервер авторизации OAuth 2.0 с помощью по промежуточного слоя OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="05b55-110">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="05b55-111">Версии программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="05b55-111">Software versions</span></span>
>
> | <span data-ttu-id="05b55-112">**В этом руководстве показано**</span><span class="sxs-lookup"><span data-stu-id="05b55-112">**Shown in the tutorial**</span></span> | <span data-ttu-id="05b55-113">**Также работает с**</span><span class="sxs-lookup"><span data-stu-id="05b55-113">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="05b55-114">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="05b55-114">Windows 8.1</span></span> | <span data-ttu-id="05b55-115">Windows 10, Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="05b55-115">Windows 10, Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="05b55-116">Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="05b55-116">Visual Studio 2017</span></span>](https://visualstudio.microsoft.com/downloads/)
> | <span data-ttu-id="05b55-117">.NET 4.7.2</span><span class="sxs-lookup"><span data-stu-id="05b55-117">.NET 4.7.2</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="05b55-118">Вопросы и комментарии</span><span class="sxs-lookup"><span data-stu-id="05b55-118">Questions and comments</span></span>
>
> <span data-ttu-id="05b55-119">Если у вас есть вопросы, которые не имеют отношения к руководству, отправьте их в [Katana проекта на GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="05b55-119">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="05b55-120">Вопросы и комментарии о самом учебнике см. в разделе "Примечания" в нижней части страницы.</span><span class="sxs-lookup"><span data-stu-id="05b55-120">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="05b55-121">[OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) позволяет сторонним приложением для получения ограниченного доступа для службы HTTP.</span><span class="sxs-lookup"><span data-stu-id="05b55-121">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="05b55-122">Вместо использования учетных данных владельца ресурса для доступа к защищенному ресурсу, клиент получает маркер доступа (это строка, обозначающая определенной области, время существования и другие атрибуты доступа).</span><span class="sxs-lookup"><span data-stu-id="05b55-122">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="05b55-123">Маркеры доступа издает для сторонних клиентов сервера авторизации с утверждением владелец ресурса.</span><span class="sxs-lookup"><span data-stu-id="05b55-123">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="05b55-124">Этом руководстве рассматривается:</span><span class="sxs-lookup"><span data-stu-id="05b55-124">This tutorial will cover:</span></span>

- <span data-ttu-id="05b55-125">Создание сервера авторизации для поддержки авторизации четырех типов предоставления и маркеры обновления:</span><span class="sxs-lookup"><span data-stu-id="05b55-125">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="05b55-126">Предоставление кода авторизации</span><span class="sxs-lookup"><span data-stu-id="05b55-126">Authorization code grant</span></span>
    - <span data-ttu-id="05b55-127">Неявное разрешение</span><span class="sxs-lookup"><span data-stu-id="05b55-127">Implicit Grant</span></span>
    - <span data-ttu-id="05b55-128">Пароль владельца ресурса предоставлением учетных данных</span><span class="sxs-lookup"><span data-stu-id="05b55-128">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="05b55-129">Предоставление учетных данных клиента</span><span class="sxs-lookup"><span data-stu-id="05b55-129">Client Credentials Grant</span></span>
- <span data-ttu-id="05b55-130">Создание сервера ресурсов, который защищен с использованием маркера доступа.</span><span class="sxs-lookup"><span data-stu-id="05b55-130">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="05b55-131">Создание клиентов OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="05b55-131">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="05b55-132">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="05b55-132">Prerequisites</span></span>

- <span data-ttu-id="05b55-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) как указано в **версий программного обеспечения** в верхней части страницы.</span><span class="sxs-lookup"><span data-stu-id="05b55-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="05b55-134">Знакомство с OWIN.</span><span class="sxs-lookup"><span data-stu-id="05b55-134">Familiarity with OWIN.</span></span> <span data-ttu-id="05b55-135">См. в разделе [Приступая к работе с проектом Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) и [новые возможности в OWIN и Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="05b55-135">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="05b55-136">Знакомство с [OAuth](http://tools.ietf.org/html/rfc6749) терминология, включая [ролей](http://tools.ietf.org/html/rfc6749#section-1.1), [потока протокола](http://tools.ietf.org/html/rfc6749#section-1.2), и [предоставления авторизации](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="05b55-136">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="05b55-137">[Общие сведения об OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) хорошо представлена вступительная информация.</span><span class="sxs-lookup"><span data-stu-id="05b55-137">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="05b55-138">Создание сервера авторизации</span><span class="sxs-lookup"><span data-stu-id="05b55-138">Create an Authorization Server</span></span>

<span data-ttu-id="05b55-139">В этом руководстве мы будет примерно начертить способы использования [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) и ASP.NET MVC для создания сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-139">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="05b55-140">Мы надеемся вскоре предоставить для загрузки для готовый пример, этот учебник содержит каждый шаг.</span><span class="sxs-lookup"><span data-stu-id="05b55-140">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="05b55-141">Во-первых, создайте пустой веб-приложение с именем *AuthorizationServer* и установите следующие пакеты:</span><span class="sxs-lookup"><span data-stu-id="05b55-141">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="05b55-142">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="05b55-142">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="05b55-143">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="05b55-143">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="05b55-144">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="05b55-144">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="05b55-145">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="05b55-145">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="05b55-146">Microsoft.Owin.Security.Google (или упаковать любые другие учетные записи социальных сетей, например Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="05b55-146">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="05b55-147">Добавить [класс запуска OWIN](owin-startup-class-detection.md) в корневой папке проекта с именем *запуска*.</span><span class="sxs-lookup"><span data-stu-id="05b55-147">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="05b55-148">Создание *приложения\_запустить* папки.</span><span class="sxs-lookup"><span data-stu-id="05b55-148">Create an *App\_Start* folder.</span></span> <span data-ttu-id="05b55-149">Выберите *приложения\_запустить* папку и используйте клавиши Shift + Alt + A, чтобы добавить загруженной версии *AuthorizationServer\App\_Start\Startup.Auth.cs* файла.</span><span class="sxs-lookup"><span data-stu-id="05b55-149">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="05b55-150">Приведенный выше код обеспечивает вход в приложение и внешних файлов cookie и проверки подлинности Google, используемые сервером авторизации, сам требуется управление учетными записями.</span><span class="sxs-lookup"><span data-stu-id="05b55-150">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="05b55-151">`UseOAuthAuthorizationServer` — Это метод расширения для настройки сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-151">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="05b55-152">Доступны следующие параметры программы установки.</span><span class="sxs-lookup"><span data-stu-id="05b55-152">The setup options are:</span></span>

- <span data-ttu-id="05b55-153">`AuthorizeEndpointPath`: Путь запроса, где клиентские приложения будут перенаправлять агент пользователя для получения пользователей согласие для выдачи маркера или кода.</span><span class="sxs-lookup"><span data-stu-id="05b55-153">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="05b55-154">Должно начинаться с косой черты, например, "`/Authorize`«.</span><span class="sxs-lookup"><span data-stu-id="05b55-154">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="05b55-155">`TokenEndpointPath`: Чтобы получить маркер доступа непосредственно взаимодействовать клиентские приложения путь запроса.</span><span class="sxs-lookup"><span data-stu-id="05b55-155">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="05b55-156">Он должен начинаться с косой черты, например «/ Token».</span><span class="sxs-lookup"><span data-stu-id="05b55-156">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="05b55-157">Если клиент выдает [клиента\_секрет](http://tools.ietf.org/html/rfc6749#appendix-A.2), но может быть передана в эту конечную точку.</span><span class="sxs-lookup"><span data-stu-id="05b55-157">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="05b55-158">`ApplicationCanDisplayErrors`: Значение `true` Если веб-приложение хочет создать на пользовательскую страницу ошибки для ошибки проверки клиента о `/Authorize` конечной точки.</span><span class="sxs-lookup"><span data-stu-id="05b55-158">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="05b55-159">Это требуется, только для случаев, когда браузер не направляется обратно в клиентское приложение, например, если `client_id` или `redirect_uri` неверны.</span><span class="sxs-lookup"><span data-stu-id="05b55-159">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="05b55-160">`/Authorize` Следует ожидать конечной точки см. в разделе «oauth. Ошибка», «oauth. ErrorDescription» и «oauth. Свойства ErrorUri» добавляются в среду OWIN.</span><span class="sxs-lookup"><span data-stu-id="05b55-160">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="05b55-161">В противном случае значение равно true, сервер авторизации возвращает страницу по умолчанию ошибка с сообщением об ошибке.</span><span class="sxs-lookup"><span data-stu-id="05b55-161">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="05b55-162">`AllowInsecureHttp`: Значение true, чтобы разрешить запросам авторизации и маркеров поступления адресов HTTP URI и разрешите входящий трафик `redirect_uri` авторизовать параметров запросов в HTTP URI-адреса.</span><span class="sxs-lookup"><span data-stu-id="05b55-162">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="05b55-163">Безопасность — это только в целях разработки.</span><span class="sxs-lookup"><span data-stu-id="05b55-163">Security - This is for development only.</span></span>
- <span data-ttu-id="05b55-164">`Provider`: Объект, предоставляемый приложением для обработки событий, вызванных по промежуточного слоя сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-164">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="05b55-165">Приложение может полностью реализовывать этот интерфейс, или он может создать экземпляр `OAuthAuthorizationServerProvider` и назначать делегаты, необходимые для потоков OAuth, данный сервер поддерживает.</span><span class="sxs-lookup"><span data-stu-id="05b55-165">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="05b55-166">`AuthorizationCodeProvider`: Создает код авторизации однократного использования для возврата в клиентское приложение.</span><span class="sxs-lookup"><span data-stu-id="05b55-166">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="05b55-167">Защитить приложения для сервера OAuth **необходимо** экземпляров для `AuthorizationCodeProvider` где маркер, созданный путем `OnCreate/OnCreateAsync` событие считается действительным только для одного вызова к `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="05b55-167">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="05b55-168">`RefreshTokenProvider`: Создает маркер обновления, который может использоваться для получения нового маркера доступа при необходимости.</span><span class="sxs-lookup"><span data-stu-id="05b55-168">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="05b55-169">Если не указан сервер авторизации не вернет маркерам обновления из `/Token` конечной точки.</span><span class="sxs-lookup"><span data-stu-id="05b55-169">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="05b55-170">Управление учетными записями</span><span class="sxs-lookup"><span data-stu-id="05b55-170">Account Management</span></span>

<span data-ttu-id="05b55-171">OAuth безразлично, откуда и как вы управляете данные учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="05b55-171">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="05b55-172">Он имеет [ASP.NET Identity](../../../identity/index.md) который отвечает за его.</span><span class="sxs-lookup"><span data-stu-id="05b55-172">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="05b55-173">В этом руководстве мы упростить код учетной записи, управления и просто убедитесь, что этот пользователь может войти на использование по промежуточного слоя OWIN.</span><span class="sxs-lookup"><span data-stu-id="05b55-173">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="05b55-174">Ниже приведен упрощенный пример кода для `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="05b55-174">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="05b55-175">`ValidateClientRedirectUri` используется для проверки клиента с его URL-адрес зарегистрированного перенаправления.</span><span class="sxs-lookup"><span data-stu-id="05b55-175">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="05b55-176">`ValidateClientAuthentication` проверяет основные схемы заголовок и текст формы для получения учетных данных клиента.</span><span class="sxs-lookup"><span data-stu-id="05b55-176">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="05b55-177">Ниже приводится на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="05b55-177">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="05b55-178">Просмотрите IETF OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) теперь разделе.</span><span class="sxs-lookup"><span data-stu-id="05b55-178">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="05b55-179">**Поставщик** (в таблице ниже), [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Поставщик, который имеет тип `OAuthAuthorizationServerProvider`, который содержит все события сервера OAuth.</span><span class="sxs-lookup"><span data-stu-id="05b55-179">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="05b55-180">Этапы потока раздел Authorization Code Grant</span><span class="sxs-lookup"><span data-stu-id="05b55-180">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="05b55-181">Загрузка образца выполняет следующие действия с.</span><span class="sxs-lookup"><span data-stu-id="05b55-181">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="05b55-182">(A клиент запускает поток, направляя владелец ресурса агента пользователя в конечную точку авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-182">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="05b55-183">Клиент добавляет свой идентификатор клиента, запрошенную область, локальное состояние и URI перенаправления, к которому сервер авторизации будет направлять агент пользователя после доступа к предоставлен (или запрещен).</span><span class="sxs-lookup"><span data-stu-id="05b55-183">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="05b55-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="05b55-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="05b55-185">(Б), сервер авторизации выполняет проверку подлинности владельца ресурса (с помощью агента пользователя) и устанавливает ли владелец ресурса или отклоняет запрос на доступ клиента.</span><span class="sxs-lookup"><span data-stu-id="05b55-185">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="05b55-186">**&lt;Если пользователь предоставил доступ&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="05b55-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="05b55-187">(C) при условии, что владелец ресурса предоставляет доступ, сервер авторизации перенаправляет агент пользователя обратно клиенту с помощью URI перенаправления, предоставленного ранее (в запросе или во время регистрации клиента).</span><span class="sxs-lookup"><span data-stu-id="05b55-187">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="05b55-188">...</span><span class="sxs-lookup"><span data-stu-id="05b55-188">...</span></span> |  |
|  |  |
| <span data-ttu-id="05b55-189">(Г) клиент запрашивает маркер доступа из конечной точки маркера сервера авторизации путем включения кода авторизации, полученного на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="05b55-189">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="05b55-190">При выполнении запроса клиент проходит проверку подлинности на сервере авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-190">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="05b55-191">Клиент включает URI перенаправления, используемый для получения кода авторизации для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="05b55-191">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="05b55-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="05b55-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="05b55-193">Пример реализации `AuthorizationCodeProvider.CreateAsync` и `ReceiveAsync` для управления созданием и проверки кода авторизации, показано ниже.</span><span class="sxs-lookup"><span data-stu-id="05b55-193">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="05b55-194">Приведенный выше код использует параллельный словарь в памяти для сохранения билета код и удостоверений и восстановить удостоверение после получения кода.</span><span class="sxs-lookup"><span data-stu-id="05b55-194">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="05b55-195">В реальном приложении он будет заменен, в постоянном хранилище данных.</span><span class="sxs-lookup"><span data-stu-id="05b55-195">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="05b55-196">Конечная точка авторизации предназначен для владельца ресурса для предоставления доступа к клиенту.</span><span class="sxs-lookup"><span data-stu-id="05b55-196">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="05b55-197">Как правило она должна пользовательский интерфейс, чтобы разрешить пользователю нажать кнопку и подтверждение разрешений.</span><span class="sxs-lookup"><span data-stu-id="05b55-197">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="05b55-198">По промежуточного слоя OWIN OAuth позволяет коду приложения для обработки в конечную точку авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-198">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="05b55-199">В нашем примере, мы используем контроллера MVC вызывается `OAuthController` его обработать.</span><span class="sxs-lookup"><span data-stu-id="05b55-199">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="05b55-200">Ниже приведен пример реализации.</span><span class="sxs-lookup"><span data-stu-id="05b55-200">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="05b55-201">`Authorize` Действие сначала проверяет, если пользователь выполнил вход на сервер авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-201">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="05b55-202">В противном случае по промежуточного слоя проверки подлинности запрашивает проверку подлинности, используя файл cookie «Приложение» вызывающего и перенаправляет на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="05b55-202">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="05b55-203">(См. выделенный код выше). Если пользователь выполнил вход, он будет отображать представление Authorize, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="05b55-203">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="05b55-204">Если **Grant** выбран переключатель, `Authorize` будет создан новый удостоверения «Bearer» и войдите с помощью его.</span><span class="sxs-lookup"><span data-stu-id="05b55-204">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="05b55-205">Он активирует сервер авторизации, чтобы создать маркер носителя и отправить его обратно клиенту с полезными данными JSON.</span><span class="sxs-lookup"><span data-stu-id="05b55-205">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="05b55-206">Неявное разрешение</span><span class="sxs-lookup"><span data-stu-id="05b55-206">Implicit Grant</span></span>

<span data-ttu-id="05b55-207">См. в IETF OAuth 2 [неявное предоставление](http://tools.ietf.org/html/rfc6749#section-4.2) теперь разделе.</span><span class="sxs-lookup"><span data-stu-id="05b55-207">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="05b55-208">[Неявное предоставление](http://tools.ietf.org/html/rfc6749#section-4.2) потока показано на рисунке 4 приведена последовательность действий, и сопоставления, который OWIN OAuth следует по промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="05b55-208">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="05b55-209">Этапы потока раздел неявное предоставление</span><span class="sxs-lookup"><span data-stu-id="05b55-209">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="05b55-210">Загрузка образца выполняет следующие действия с.</span><span class="sxs-lookup"><span data-stu-id="05b55-210">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="05b55-211">(A клиент запускает поток, направляя владелец ресурса агента пользователя в конечную точку авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-211">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="05b55-212">Клиент добавляет свой идентификатор клиента, запрошенную область, локальное состояние и URI перенаправления, к которому сервер авторизации будет направлять агент пользователя после доступа к предоставлен (или запрещен).</span><span class="sxs-lookup"><span data-stu-id="05b55-212">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="05b55-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="05b55-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="05b55-214">(Б), сервер авторизации выполняет проверку подлинности владельца ресурса (с помощью агента пользователя) и устанавливает ли владелец ресурса или отклоняет запрос на доступ клиента.</span><span class="sxs-lookup"><span data-stu-id="05b55-214">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="05b55-215">**&lt;Если пользователь предоставил доступ&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="05b55-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="05b55-216">(C) при условии, что владелец ресурса предоставляет доступ, сервер авторизации перенаправляет агент пользователя обратно клиенту с помощью URI перенаправления, предоставленного ранее (в запросе или во время регистрации клиента).</span><span class="sxs-lookup"><span data-stu-id="05b55-216">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="05b55-217">...</span><span class="sxs-lookup"><span data-stu-id="05b55-217">...</span></span> |  |
|  |  |
| <span data-ttu-id="05b55-218">(Г) клиент запрашивает маркер доступа из конечной точки маркера сервера авторизации путем включения кода авторизации, полученного на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="05b55-218">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="05b55-219">При выполнении запроса клиент проходит проверку подлинности на сервере авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-219">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="05b55-220">Клиент включает URI перенаправления, используемый для получения кода авторизации для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="05b55-220">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="05b55-221">Так как мы уже реализован в конечную точку авторизации (`OAuthController.Authorize` действие) для предоставления кода авторизации, оно автоматически включает также неявного потока.</span><span class="sxs-lookup"><span data-stu-id="05b55-221">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="05b55-222">Примечание: `Provider.ValidateClientRedirectUri` используется для проверки идентификатора клиента с его URL-адрес перенаправления, которая защищает неявный поток предоставления от маркера вредоносным клиентам, отправляющим доступ ([атаки Man-in--middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="05b55-222">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="05b55-223">Пароль владельца ресурса предоставлением учетных данных</span><span class="sxs-lookup"><span data-stu-id="05b55-223">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="05b55-224">См. в IETF OAuth 2 [предоставление учетных данных владельца ресурса](http://tools.ietf.org/html/rfc6749#section-4.3) теперь разделе.</span><span class="sxs-lookup"><span data-stu-id="05b55-224">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="05b55-225">[Предоставление учетных данных владельца ресурса](http://tools.ietf.org/html/rfc6749#section-4.3) приведена последовательность действий потока показано на рисунке 5, и сопоставления, который OWIN OAuth следует по промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="05b55-225">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="05b55-226">Этапы потока раздел предоставление учетных данных владельца ресурса</span><span class="sxs-lookup"><span data-stu-id="05b55-226">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="05b55-227">Загрузка образца выполняет следующие действия с.</span><span class="sxs-lookup"><span data-stu-id="05b55-227">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="05b55-228">(A) владелец ресурса предоставляет клиенту имя пользователя и пароль.</span><span class="sxs-lookup"><span data-stu-id="05b55-228">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="05b55-229">(Б) клиент запрашивает маркер доступа из конечной точки маркера сервера авторизации путем включения учетных данных, полученных от владельца ресурса.</span><span class="sxs-lookup"><span data-stu-id="05b55-229">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="05b55-230">При выполнении запроса клиент проходит проверку подлинности на сервере авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-230">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="05b55-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="05b55-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="05b55-232">(C) сервер авторизации проверяет подлинность клиента и проверяет учетные данные владельца ресурса и если это допустимо, выдает маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="05b55-232">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="05b55-233">Ниже приведен пример реализации для `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="05b55-233">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="05b55-234">В приведенном выше коде объясняются в этом разделе руководства и не должны использоваться в безопасный или рабочих приложений.</span><span class="sxs-lookup"><span data-stu-id="05b55-234">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="05b55-235">Он не проверяет учетные данные владельцев ресурса.</span><span class="sxs-lookup"><span data-stu-id="05b55-235">It does not check the resource owners credentials.</span></span> <span data-ttu-id="05b55-236">Предполагается, что каждый учетных данных является допустимым и создает новое удостоверение для него.</span><span class="sxs-lookup"><span data-stu-id="05b55-236">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="05b55-237">Новое удостоверение будет использоваться для создания токена доступа и токена обновления.</span><span class="sxs-lookup"><span data-stu-id="05b55-237">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="05b55-238">Замените код в коде управления безопасная учетная запись.</span><span class="sxs-lookup"><span data-stu-id="05b55-238">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="05b55-239">Предоставление учетных данных клиента</span><span class="sxs-lookup"><span data-stu-id="05b55-239">Client Credentials Grant</span></span>

<span data-ttu-id="05b55-240">См. в IETF OAuth 2 [предоставления учетных данных клиента](http://tools.ietf.org/html/rfc6749#section-4.4) теперь разделе.</span><span class="sxs-lookup"><span data-stu-id="05b55-240">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="05b55-241">[Предоставления учетных данных клиента](http://tools.ietf.org/html/rfc6749#section-4.4) приведена последовательность действий потока, показанный на рис. 6, и сопоставления, который OWIN OAuth следует по промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="05b55-241">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="05b55-242">Этапы потока раздел предоставления учетных данных клиента</span><span class="sxs-lookup"><span data-stu-id="05b55-242">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="05b55-243">Загрузка образца выполняет следующие действия с.</span><span class="sxs-lookup"><span data-stu-id="05b55-243">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="05b55-244">(A) клиент проходит проверку подлинности на сервере авторизации и запрашивает маркер доступа из конечной точки маркера.</span><span class="sxs-lookup"><span data-stu-id="05b55-244">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="05b55-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="05b55-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="05b55-246">(Б) сервер авторизации проверяет подлинность клиента и если это допустимо, выдает маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="05b55-246">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="05b55-247">Ниже приведен пример реализации для `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="05b55-247">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="05b55-248">В приведенном выше коде объясняются в этом разделе руководства и не должны использоваться в безопасный или рабочих приложений.</span><span class="sxs-lookup"><span data-stu-id="05b55-248">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="05b55-249">Замените код с вашим собственным кодом защищенный клиент управления.</span><span class="sxs-lookup"><span data-stu-id="05b55-249">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="05b55-250">Токен обновления</span><span class="sxs-lookup"><span data-stu-id="05b55-250">Refresh Token</span></span>

<span data-ttu-id="05b55-251">См. в IETF OAuth 2 [токен обновления](http://tools.ietf.org/html/rfc6749#section-1.5) теперь разделе.</span><span class="sxs-lookup"><span data-stu-id="05b55-251">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="05b55-252">[Токен обновления](http://tools.ietf.org/html/rfc6749#section-1.5) потока показано на рисунке 2 приведена последовательность действий, и сопоставления, который OWIN OAuth следует по промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="05b55-252">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="05b55-253">Этапы потока раздел предоставления учетных данных клиента</span><span class="sxs-lookup"><span data-stu-id="05b55-253">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="05b55-254">Загрузка образца выполняет следующие действия с.</span><span class="sxs-lookup"><span data-stu-id="05b55-254">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="05b55-255">(Ж) клиент запрашивает новый маркер доступа с проверкой подлинности на сервере авторизации и предоставляет токен обновления.</span><span class="sxs-lookup"><span data-stu-id="05b55-255">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="05b55-256">Требования к проверке подлинности клиента основаны на типе клиента и для сервера политик авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-256">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="05b55-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="05b55-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="05b55-258">(З) сервер авторизации проверяет подлинность клиента и проверяет маркер обновления и если это допустимо, выдает новый маркер доступа (и при необходимости новый маркер обновления).</span><span class="sxs-lookup"><span data-stu-id="05b55-258">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="05b55-259">Ниже приведен пример реализации для `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="05b55-259">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="05b55-260">Создать сервер ресурсов, который защищен с помощью токена доступа</span><span class="sxs-lookup"><span data-stu-id="05b55-260">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="05b55-261">Создайте проект пустой веб-приложения и установите следующие пакеты в проекте:</span><span class="sxs-lookup"><span data-stu-id="05b55-261">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="05b55-262">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="05b55-262">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="05b55-263">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="05b55-263">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="05b55-264">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="05b55-264">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="05b55-265">Создайте класс запуска и настройка проверки подлинности и веб-API.</span><span class="sxs-lookup"><span data-stu-id="05b55-265">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="05b55-266">См. в разделе *AuthorizationServer\ResourceServer\Startup.cs* в состав примера.</span><span class="sxs-lookup"><span data-stu-id="05b55-266">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="05b55-267">См. в разделе *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* в состав примера.</span><span class="sxs-lookup"><span data-stu-id="05b55-267">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="05b55-268">См. в разделе *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* в состав примера.</span><span class="sxs-lookup"><span data-stu-id="05b55-268">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="05b55-269">`UseCors` метод позволяет CORS для всех доменов.</span><span class="sxs-lookup"><span data-stu-id="05b55-269">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="05b55-270">`UseOAuthBearerAuthentication` метод позволяет OAuth токена проверки подлинности по промежуточного слоя носителя, который будет получать и проверить токен носителя из заголовка авторизации в запросе.</span><span class="sxs-lookup"><span data-stu-id="05b55-270">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="05b55-271">`Config.SuppressDefaultHostAuthenticaiton` по умолчанию подавляет размещаться прошедшему проверку подлинности участнику из приложения, поэтому все запросы будут анонимный после этого вызова.</span><span class="sxs-lookup"><span data-stu-id="05b55-271">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="05b55-272">`HostAuthenticationFilter` включает проверку подлинности только для типа проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="05b55-272">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="05b55-273">В этом случае это тип проверки подлинности носителя.</span><span class="sxs-lookup"><span data-stu-id="05b55-273">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="05b55-274">Чтобы продемонстрировать проверку подлинности, мы создадим ApiController для исходящих утверждений текущего пользователя.</span><span class="sxs-lookup"><span data-stu-id="05b55-274">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="05b55-275">Если сервер авторизации и сервер ресурсов не на том же компьютере, по промежуточного слоя OAuth будет использовать различные машинные ключи для шифрования и расшифровки маркера доступа носителя.</span><span class="sxs-lookup"><span data-stu-id="05b55-275">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="05b55-276">Для совместного использования одного закрытого ключа между обоих проектов, мы добавим же `machinekey` в оба *web.config* файлов.</span><span class="sxs-lookup"><span data-stu-id="05b55-276">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="05b55-277">Создание клиентов OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="05b55-277">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="05b55-278">Мы используем [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) пакет NuGet, чтобы упростить код клиента.</span><span class="sxs-lookup"><span data-stu-id="05b55-278">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="05b55-279">Клиент предоставление кода авторизации</span><span class="sxs-lookup"><span data-stu-id="05b55-279">Authorization Code Grant Client</span></span>

 <span data-ttu-id="05b55-280">Этот клиент — это приложение MVC.</span><span class="sxs-lookup"><span data-stu-id="05b55-280">This client is an MVC application.</span></span> <span data-ttu-id="05b55-281">Будет запущен поток предоставления кода авторизации для получения маркера доступа из серверной части.</span><span class="sxs-lookup"><span data-stu-id="05b55-281">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="05b55-282">Он состоит из одной страницы, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="05b55-282">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="05b55-283">**Authorize** кнопка будет перенаправлять браузер на сервере авторизации, чтобы уведомить владельца ресурсов для предоставления доступа для этого клиента.</span><span class="sxs-lookup"><span data-stu-id="05b55-283">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="05b55-284">**Обновить** кнопка получит новый маркер доступа и маркер обновления, с помощью текущего обновления токена.</span><span class="sxs-lookup"><span data-stu-id="05b55-284">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="05b55-285">**Защищенных ресурсов API-Интерфейс** кнопка будет вызывать сервер ресурсов для получения данных утверждений текущего пользователя и их отображения на странице.</span><span class="sxs-lookup"><span data-stu-id="05b55-285">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="05b55-286">Ниже приведен пример кода из `HomeController` клиента.</span><span class="sxs-lookup"><span data-stu-id="05b55-286">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="05b55-287">`DotNetOpenAuth` требуется протокол SSL по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="05b55-287">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="05b55-288">Так как в примере используется протокол HTTP, необходимо добавить следующий параметр в файле конфигурации:</span><span class="sxs-lookup"><span data-stu-id="05b55-288">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="05b55-289">Безопасность — никогда не отключить SSL в рабочем приложении.</span><span class="sxs-lookup"><span data-stu-id="05b55-289">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="05b55-290">Учетные данные входа теперь отправляются в незашифрованном по каналу связи.</span><span class="sxs-lookup"><span data-stu-id="05b55-290">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="05b55-291">Приведенный выше код можно только для отладки в локальном образца и просмотра.</span><span class="sxs-lookup"><span data-stu-id="05b55-291">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="05b55-292">Неявное предоставление клиента</span><span class="sxs-lookup"><span data-stu-id="05b55-292">Implicit Grant Client</span></span>

<span data-ttu-id="05b55-293">Этот клиент использует JavaScript для:</span><span class="sxs-lookup"><span data-stu-id="05b55-293">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="05b55-294">Откройте новое окно и перенаправление к конечной точке авторизации сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="05b55-294">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="05b55-295">Получение маркера доступа из фрагментов URL-адрес при перенаправлении обратно.</span><span class="sxs-lookup"><span data-stu-id="05b55-295">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="05b55-296">Этот процесс показан на следующем рисунке:</span><span class="sxs-lookup"><span data-stu-id="05b55-296">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="05b55-297">Клиент должен иметь две страницы: один для домашней страницы, а другой — для обратного вызова. Ниже приведен пример кода JavaScript *Index.cshtml* файла:</span><span class="sxs-lookup"><span data-stu-id="05b55-297">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="05b55-298">Ниже приведен код в обработки обратного вызова *SignIn.cshtml* файла:</span><span class="sxs-lookup"><span data-stu-id="05b55-298">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="05b55-299">Рекомендуется переместить во внешний файл JavaScript, а не внедрить его с разметкой Razor.</span><span class="sxs-lookup"><span data-stu-id="05b55-299">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="05b55-300">Для простоты примера они были объединены.</span><span class="sxs-lookup"><span data-stu-id="05b55-300">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="05b55-301">Пароль владельца ресурса учетных данных клиента Grant</span><span class="sxs-lookup"><span data-stu-id="05b55-301">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="05b55-302">Мы демонстрирует работу консольного приложения на демонстрацию этого клиента.</span><span class="sxs-lookup"><span data-stu-id="05b55-302">We uses a console app to demo this client.</span></span> <span data-ttu-id="05b55-303">Ниже приведен код:</span><span class="sxs-lookup"><span data-stu-id="05b55-303">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="05b55-304">Предоставьте учетные данные. клиент</span><span class="sxs-lookup"><span data-stu-id="05b55-304">Client Credentials Grant Client</span></span>

<span data-ttu-id="05b55-305">Как и предоставление учетных данных владельца ресурса, ниже приведен код приложения консоли.</span><span class="sxs-lookup"><span data-stu-id="05b55-305">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
