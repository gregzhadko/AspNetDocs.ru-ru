---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Сервер авторизации OWIN OAuth 2.0 Документы Майкрософт
author: hongyes
description: Этот учебник поможет вам о том, как реализовать OAuth 2.0 Авторизация Сервер с помощью OWIN OAuth промежуточного. Это продвинутый учебник, который только outlin ...
ms.author: riande
ms.date: 03/20/2014
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: d758fa2639d10e1b7be8d87c5d1f7adb7e292ac7
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540424"
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="a459f-104">Сервер авторизации OAuth 2.0 OWIN</span><span class="sxs-lookup"><span data-stu-id="a459f-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="a459f-105">[Хонъе Сун](https://github.com/hongyes) и [Прабурадж Тиагараджан](https://github.com/Praburaj)</span><span class="sxs-lookup"><span data-stu-id="a459f-105">by [Hongye Sun](https://github.com/hongyes) and [Praburaj Thiagarajan](https://github.com/Praburaj)</span></span>

> <span data-ttu-id="a459f-106">Этот учебник поможет вам о том, как реализовать OAuth 2.0 Авторизация Сервер с помощью OWIN OAuth промежуточного.</span><span class="sxs-lookup"><span data-stu-id="a459f-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="a459f-107">Это продвинутый учебник, который только излагает шаги для создания СЕРВЕРа авторизации OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="a459f-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="a459f-108">Это не шаг за шагом учебник.</span><span class="sxs-lookup"><span data-stu-id="a459f-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="a459f-109">[Скачать пример кода](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="a459f-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="a459f-110">Этот план не должен использоваться для создания безопасного производственного приложения.</span><span class="sxs-lookup"><span data-stu-id="a459f-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="a459f-111">Этот учебник предназначен для предоставления только наброски о том, как реализовать OAuth 2.0 Авторизация Сервер с помощью OWIN OAuth промежуточного.</span><span class="sxs-lookup"><span data-stu-id="a459f-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="a459f-112">Версии программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="a459f-112">Software versions</span></span>
>
> | <span data-ttu-id="a459f-113">**Показано в учебнике**</span><span class="sxs-lookup"><span data-stu-id="a459f-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="a459f-114">**Также работает с**</span><span class="sxs-lookup"><span data-stu-id="a459f-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="a459f-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="a459f-115">Windows 8.1</span></span> | <span data-ttu-id="a459f-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="a459f-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="a459f-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="a459f-117">Visual Studio 2013</span></span>](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) | <span data-ttu-id="a459f-118">[Визуальная студия 2013 Экспресс для рабочего стола](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="a459f-118">[Visual Studio 2013 Express for Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span></span> <span data-ttu-id="a459f-119">Visual Studio 2012 с последним обновлением должен работать, но учебник не был протестирован с ним, и некоторые выбор меню и диалоговые коробки отличаются.</span><span class="sxs-lookup"><span data-stu-id="a459f-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="a459f-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="a459f-120">.NET 4.5</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="a459f-121">Вопросы и комментарии</span><span class="sxs-lookup"><span data-stu-id="a459f-121">Questions and Comments</span></span>
>
> <span data-ttu-id="a459f-122">Если у вас есть вопросы, которые не имеют прямого отношения к учебнику, вы можете разместить их на [Katana project на GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="a459f-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="a459f-123">Для вопросов и комментариев, касающихся самого учебника, смотрите раздел комментариев в нижней части страницы.</span><span class="sxs-lookup"><span data-stu-id="a459f-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="a459f-124">[Платформа OAuth 2.0](http://tools.ietf.org/html/rfc6749) позволяет стороннему приложению получить ограниченный доступ к службе HTTP.</span><span class="sxs-lookup"><span data-stu-id="a459f-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="a459f-125">Вместо того, чтобы использовать учетные данные владельца ресурса для доступа к защищенному ресурсу, клиент получает токен доступа (который является строкой, обозначающей определенный объем, срок службы и другие атрибуты доступа).</span><span class="sxs-lookup"><span data-stu-id="a459f-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="a459f-126">Токены доступа выдаются сторонним клиентам сервером авторизации с одобрения владельца ресурса.</span><span class="sxs-lookup"><span data-stu-id="a459f-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="a459f-127">Этот учебник будет охватывать:</span><span class="sxs-lookup"><span data-stu-id="a459f-127">This tutorial will cover:</span></span>

- <span data-ttu-id="a459f-128">Как создать сервер авторизации для поддержки четырех типов грантов авторизации и обновления токенов:</span><span class="sxs-lookup"><span data-stu-id="a459f-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="a459f-129">Разрешение код гранта</span><span class="sxs-lookup"><span data-stu-id="a459f-129">Authorization code grant</span></span>
    - <span data-ttu-id="a459f-130">Неявный Грант</span><span class="sxs-lookup"><span data-stu-id="a459f-130">Implicit Grant</span></span>
    - <span data-ttu-id="a459f-131">Грант владельца паролей ресурса</span><span class="sxs-lookup"><span data-stu-id="a459f-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="a459f-132">Грант на учетные данные клиентов</span><span class="sxs-lookup"><span data-stu-id="a459f-132">Client Credentials Grant</span></span>
- <span data-ttu-id="a459f-133">Создание сервера ресурсов, защищенного токеном доступа.</span><span class="sxs-lookup"><span data-stu-id="a459f-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="a459f-134">Создание клиентов OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="a459f-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="a459f-135">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="a459f-135">Prerequisites</span></span>

- <span data-ttu-id="a459f-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) или бесплатная [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), как указано в **Software Versions** в верхней части страницы.</span><span class="sxs-lookup"><span data-stu-id="a459f-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="a459f-137">Знакомство с OWIN.</span><span class="sxs-lookup"><span data-stu-id="a459f-137">Familiarity with OWIN.</span></span> <span data-ttu-id="a459f-138">Смотрите [Начало работы с проектом Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) и [что нового в OWIN и Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="a459f-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="a459f-139">Знакомство с терминологией [OAuth,](http://tools.ietf.org/html/rfc6749) включая [роли,](http://tools.ietf.org/html/rfc6749#section-1.1) [Протоколный поток](http://tools.ietf.org/html/rfc6749#section-1.2)и [Грант авторизации.](http://tools.ietf.org/html/rfc6749#section-1.3)</span><span class="sxs-lookup"><span data-stu-id="a459f-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="a459f-140">[OAuth 2.0 введение](http://tools.ietf.org/html/rfc6749#section-1) обеспечивает хорошее введение.</span><span class="sxs-lookup"><span data-stu-id="a459f-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="a459f-141">Создание сервера авторизации</span><span class="sxs-lookup"><span data-stu-id="a459f-141">Create an Authorization Server</span></span>

<span data-ttu-id="a459f-142">В этом уроке мы будем примерно наброски, как использовать [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) и ASP.NET MVC для создания сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="a459f-143">Мы надеемся, что в скором времени обеспечить загрузку для завершенного образца, так как этот учебник не включает в себя каждый шаг.</span><span class="sxs-lookup"><span data-stu-id="a459f-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="a459f-144">Во-первых, создайте пустое веб-приложение под названием *AuthorizationServer* и установите следующие пакеты:</span><span class="sxs-lookup"><span data-stu-id="a459f-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="a459f-145">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="a459f-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="a459f-146">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="a459f-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="a459f-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="a459f-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="a459f-148">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="a459f-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="a459f-149">Microsoft.Owin.Security.Google (или любой другой социальный пакет входа, таких как Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="a459f-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="a459f-150">Добавьте [класс стартапа OWIN](owin-startup-class-detection.md) под корневую папку проекта под названием *Startup.*</span><span class="sxs-lookup"><span data-stu-id="a459f-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="a459f-151">Создайте папку *«Старт приложения».\_*</span><span class="sxs-lookup"><span data-stu-id="a459f-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="a459f-152">Выберите папку *App\_Start* и используйте Shift-Alt-A, чтобы добавить загруженную версию файла *AuthorizationServer-App\_Start-Start.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="a459f-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="a459f-153">Приведенный выше код позволяет приложения/внешнего знака в файлах cookie и аутентификации Google, которые используются самим сервером авторизации для управления учетными записями.</span><span class="sxs-lookup"><span data-stu-id="a459f-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="a459f-154">Метод `UseOAuthAuthorizationServer` расширения заключается в настройке сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="a459f-155">Параметры настройки:</span><span class="sxs-lookup"><span data-stu-id="a459f-155">The setup options are:</span></span>

- <span data-ttu-id="a459f-156">`AuthorizeEndpointPath`: Путь запроса, по которому клиентские приложения перенаправляют агента пользователя, чтобы получить согласие пользователей на выпуск токена или кода.</span><span class="sxs-lookup"><span data-stu-id="a459f-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="a459f-157">Она должна начинаться с ведущих черту, например, ".`/Authorize`</span><span class="sxs-lookup"><span data-stu-id="a459f-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="a459f-158">`TokenEndpointPath`: Клиентские приложения пути запроса непосредственно общаются для получения токена доступа.</span><span class="sxs-lookup"><span data-stu-id="a459f-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="a459f-159">Она должна начинаться с ведущей черты, как "/Токен".</span><span class="sxs-lookup"><span data-stu-id="a459f-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="a459f-160">Если клиенту выдается [секрет клиента,\_](http://tools.ietf.org/html/rfc6749#appendix-A.2)он должен быть предоставлен в этой точке.</span><span class="sxs-lookup"><span data-stu-id="a459f-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="a459f-161">`ApplicationCanDisplayErrors`: Установить, `true` если веб-приложение хочет создать пользовательскую страницу `/Authorize` ошибки для клиента проверки ошибок на конечную точку.</span><span class="sxs-lookup"><span data-stu-id="a459f-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="a459f-162">Это необходимо только в тех случаях, когда браузер не перенаправляется обратно `client_id` `redirect_uri` в клиентское приложение, например, когда или неправильно.</span><span class="sxs-lookup"><span data-stu-id="a459f-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="a459f-163">Конечная `/Authorize` точка должна ожидать, чтобы увидеть "Oauth. Ошибка", "Оут. ОшибкаОписание" и "Оут. Свойства ErrorUri добавляются в среду OWIN.</span><span class="sxs-lookup"><span data-stu-id="a459f-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="a459f-164">Если это не так, сервер авторизации вернет страницу ошибки по умолчанию с деталями ошибки.</span><span class="sxs-lookup"><span data-stu-id="a459f-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="a459f-165">`AllowInsecureHttp`: Верно, чтобы разрешить авторизовать и маркерные запросы, `redirect_uri` чтобы прибыть на адреса HTTP URI, и разрешить входящие параметры авторизации запроса, чтобы иметь адреса HTTP URI.</span><span class="sxs-lookup"><span data-stu-id="a459f-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="a459f-166">Безопасность - Это только для развития.</span><span class="sxs-lookup"><span data-stu-id="a459f-166">Security - This is for development only.</span></span>
- <span data-ttu-id="a459f-167">`Provider`: Объект, предоставляемый приложением для обработки событий, поднятых промежуточное программное обеспечение сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="a459f-168">Приложение может полностью реализовать интерфейс, или оно `OAuthAuthorizationServerProvider` может создать экземпляр и назначить делегатов, необходимых для потоков OAuth, которые поддерживает этот сервер.</span><span class="sxs-lookup"><span data-stu-id="a459f-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="a459f-169">`AuthorizationCodeProvider`: Производит одноразовый код авторизации для возврата в клиентское приложение.</span><span class="sxs-lookup"><span data-stu-id="a459f-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="a459f-170">Для обеспечения безопасности сервера **MUST** OAuth приложение `AuthorizationCodeProvider` должно предоставить экземпляр, в котором токен, произведенный `OnCreate/OnCreateAsync` событием, считается действительным только для одного `OnReceive/OnReceiveAsync`звонка.</span><span class="sxs-lookup"><span data-stu-id="a459f-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="a459f-171">`RefreshTokenProvider`: Производит маркер обновления, который может быть использован для создания нового токена доступа при необходимости.</span><span class="sxs-lookup"><span data-stu-id="a459f-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="a459f-172">Если сервер авторизации не вернет токены `/Token` обновления из конечных точек.</span><span class="sxs-lookup"><span data-stu-id="a459f-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="a459f-173">Управление учетными записями</span><span class="sxs-lookup"><span data-stu-id="a459f-173">Account Management</span></span>

<span data-ttu-id="a459f-174">OAuth не волнует, где и как вы управляете информацией учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="a459f-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="a459f-175">Это [ASP.NET идентичность,](../../../identity/index.md) которая несет ответственность за это.</span><span class="sxs-lookup"><span data-stu-id="a459f-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="a459f-176">В этом учебнике мы упростим код управления учетной записью и просто убедимся, что пользователь может войти в систему с помощью промежуточного посуды OWIN cookie.</span><span class="sxs-lookup"><span data-stu-id="a459f-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="a459f-177">Вот упрощенный пример кода `AccountController`для:</span><span class="sxs-lookup"><span data-stu-id="a459f-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="a459f-178">`ValidateClientRedirectUri`используется для проверки клиента с его зарегистрированным URL-адресом.</span><span class="sxs-lookup"><span data-stu-id="a459f-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="a459f-179">`ValidateClientAuthentication`проверяет основную схему заголовка и формы тела, чтобы получить полномочия клиента.</span><span class="sxs-lookup"><span data-stu-id="a459f-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="a459f-180">Страница входа отображается ниже:</span><span class="sxs-lookup"><span data-stu-id="a459f-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="a459f-181">Просмотрите раздел OAUth 2 [Авторизация](http://tools.ietf.org/html/rfc6749#section-4.1) IETth 2 Авторизация Код Грант разделе сейчас.</span><span class="sxs-lookup"><span data-stu-id="a459f-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="a459f-182">**Поставщиком** (в таблице ниже) является [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Поставщик, который имеет `OAuthAuthorizationServerProvider`тип, который содержит все события сервера OAuth.</span><span class="sxs-lookup"><span data-stu-id="a459f-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="a459f-183">Шаги потока из раздела Грант кода авторизации</span><span class="sxs-lookup"><span data-stu-id="a459f-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="a459f-184">Пример загрузки выполняет следующие шаги с:</span><span class="sxs-lookup"><span data-stu-id="a459f-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a459f-185">(A) Клиент инициирует поток, направляя агента пользователя-пользователя ресурса в конечную точку авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="a459f-186">Клиент включает в себя идентификатор клиента, запрашиваемую область, локальное состояние и перенаправление URI, на который сервер авторизации отправит агента пользователя обратно после предоставления доступа (или отказа).</span><span class="sxs-lookup"><span data-stu-id="a459f-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="a459f-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="a459f-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="a459f-188">(B) Сервер авторизации проверяет подлинность владельца ресурса (через пользователя-агента) и устанавливает, предоставляет ли владелец ресурса или отказывает клиенту в запросе на доступ.</span><span class="sxs-lookup"><span data-stu-id="a459f-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="a459f-189">**Если пользователь предоставляет доступ&gt; &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a459f-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a459f-190">(C) Предполагая, что владелец ресурса предоставляет доступ, сервер авторизации перенаправляет агента пользователя обратно клиенту, используя перенаправление URI, предоставленное ранее (в запросе или во время регистрации клиента).</span><span class="sxs-lookup"><span data-stu-id="a459f-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="a459f-191">...</span><span class="sxs-lookup"><span data-stu-id="a459f-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="a459f-192">(D) Клиент запрашивает токен доступа из токенной точки сервера авторизации, включив код авторизации, полученный на предыдущем этапе.</span><span class="sxs-lookup"><span data-stu-id="a459f-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="a459f-193">При совершении запроса клиент проверяет подлинность с помощью сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="a459f-194">Клиент включает в себя перенаправление URI, используемое для получения кода авторизации для проверки.</span><span class="sxs-lookup"><span data-stu-id="a459f-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="a459f-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a459f-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="a459f-196">Ниже показана `AuthorizationCodeProvider.CreateAsync` `ReceiveAsync` примерная реализация для создания и проверки кода авторизации и контроля.</span><span class="sxs-lookup"><span data-stu-id="a459f-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="a459f-197">Приведенный выше код использует одновременный словарь в памяти для хранения кода и идентификационного билета и восстановления идентификации после получения кода.</span><span class="sxs-lookup"><span data-stu-id="a459f-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="a459f-198">В реальном приложении он будет заменен постоянным хранилищем данных.</span><span class="sxs-lookup"><span data-stu-id="a459f-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="a459f-199">Конечная точка авторизации предназначена для владельца ресурса предоставить доступ клиенту.</span><span class="sxs-lookup"><span data-stu-id="a459f-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="a459f-200">Как правило, он нуждается в пользовательском интерфейсе, чтобы позволить пользователю нажать кнопку и подтвердить грант.</span><span class="sxs-lookup"><span data-stu-id="a459f-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="a459f-201">Промежуточное программное обеспечение OWIN OAuth позволяет коду приложения обрабатывать конечную точку авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="a459f-202">В нашем примере приложения мы используем `OAuthController` контроллер MVC, называемый для его обработки.</span><span class="sxs-lookup"><span data-stu-id="a459f-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="a459f-203">Вот пример реализации:</span><span class="sxs-lookup"><span data-stu-id="a459f-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="a459f-204">Действие `Authorize` сначала проверяет, вошел ли пользователь на сервер авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="a459f-205">В противном случае промежуточное программное обеспечение для проверки подлинности вызова вызова проверяется с помощью файла cookie и перенаправляет его на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="a459f-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="a459f-206">(См. выделенный код выше.) Если пользователь вошел в систему, он будет отображать представление Authorize, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="a459f-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="a459f-207">Если выбрана кнопка **Гранта,** `Authorize` действие создаст новую идентификацию «Bearer» и восстанет с ней.</span><span class="sxs-lookup"><span data-stu-id="a459f-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="a459f-208">Это вызовет сервер авторизации для генерации маркера носителя и отправки его обратно клиенту с полезной нагрузкой JSON.</span><span class="sxs-lookup"><span data-stu-id="a459f-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="a459f-209">Неявный Грант</span><span class="sxs-lookup"><span data-stu-id="a459f-209">Implicit Grant</span></span>

<span data-ttu-id="a459f-210">Обратитесь к разделу OAuth [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) 2 IETF.</span><span class="sxs-lookup"><span data-stu-id="a459f-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="a459f-211">[Неявный поток гранта,](http://tools.ietf.org/html/rfc6749#section-4.2) показанный на рисунке 4, — это поток и отображение, за которым следует промежуточное программное обеспечение OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="a459f-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="a459f-212">Шаги потока из раздела Неявного Гранта</span><span class="sxs-lookup"><span data-stu-id="a459f-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="a459f-213">Пример загрузки выполняет следующие шаги с:</span><span class="sxs-lookup"><span data-stu-id="a459f-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a459f-214">(A) Клиент инициирует поток, направляя агента пользователя-пользователя ресурса в конечную точку авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="a459f-215">Клиент включает в себя идентификатор клиента, запрашиваемую область, локальное состояние и перенаправление URI, на который сервер авторизации отправит агента пользователя обратно после предоставления доступа (или отказа).</span><span class="sxs-lookup"><span data-stu-id="a459f-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="a459f-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="a459f-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="a459f-217">(B) Сервер авторизации проверяет подлинность владельца ресурса (через пользователя-агента) и устанавливает, предоставляет ли владелец ресурса или отказывает клиенту в запросе на доступ.</span><span class="sxs-lookup"><span data-stu-id="a459f-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="a459f-218">**Если пользователь предоставляет доступ&gt; &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a459f-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a459f-219">(C) Предполагая, что владелец ресурса предоставляет доступ, сервер авторизации перенаправляет агента пользователя обратно клиенту, используя перенаправление URI, предоставленное ранее (в запросе или во время регистрации клиента).</span><span class="sxs-lookup"><span data-stu-id="a459f-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="a459f-220">...</span><span class="sxs-lookup"><span data-stu-id="a459f-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="a459f-221">(D) Клиент запрашивает токен доступа из токенной точки сервера авторизации, включив код авторизации, полученный на предыдущем этапе.</span><span class="sxs-lookup"><span data-stu-id="a459f-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="a459f-222">При совершении запроса клиент проверяет подлинность с помощью сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="a459f-223">Клиент включает в себя перенаправление URI, используемое для получения кода авторизации для проверки.</span><span class="sxs-lookup"><span data-stu-id="a459f-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="a459f-224">Поскольку мы уже внедрили конечную точку авторизации (действие)`OAuthController.Authorize` для предоставления кода авторизации, она автоматически позволяет неявно течь.</span><span class="sxs-lookup"><span data-stu-id="a459f-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="a459f-225">Примечание: `Provider.ValidateClientRedirectUri` используется для проверки идентификатора клиента с URL-адресом перенаправления, который защищает неявный поток грантов от отправки токена доступа злоумышленникам[(атака «Человек в середине»).](https://www.owasp.org/index.php/Man-in-the-middle_attack)</span><span class="sxs-lookup"><span data-stu-id="a459f-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="a459f-226">Грант владельца паролей ресурса</span><span class="sxs-lookup"><span data-stu-id="a459f-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="a459f-227">Обратитесь к OAuth 2 [IETF Владелец ресурсов Пароль полномочия Грант](http://tools.ietf.org/html/rfc6749#section-4.3) разделе сейчас.</span><span class="sxs-lookup"><span data-stu-id="a459f-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="a459f-228">[Ресурс Владелец паролей учетные данные Грант](http://tools.ietf.org/html/rfc6749#section-4.3) поток, показанный на рисунке 5 является поток и отображение которых OWIN OAuth промежуточного следует.</span><span class="sxs-lookup"><span data-stu-id="a459f-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="a459f-229">Поток шаги из раздела Грант учетных данных владельца паролей ресурса</span><span class="sxs-lookup"><span data-stu-id="a459f-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="a459f-230">Пример загрузки выполняет следующие шаги с:</span><span class="sxs-lookup"><span data-stu-id="a459f-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a459f-231">(A) Владелец ресурса предоставляет клиенту имя пользователя и пароль.</span><span class="sxs-lookup"><span data-stu-id="a459f-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="a459f-232">(B) Клиент запрашивает токен доступа из токенной точки сервера авторизации, включив учетные данные, полученные от владельца ресурса.</span><span class="sxs-lookup"><span data-stu-id="a459f-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="a459f-233">При совершении запроса клиент проверяет подлинность с помощью сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="a459f-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a459f-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a459f-235">(C) Сервер авторизации проверяет подлинность клиента и проверяет учетные данные владельца ресурса, а если он действителен, выдает токен доступа.</span><span class="sxs-lookup"><span data-stu-id="a459f-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="a459f-236">Вот пример реализации: `Provider.GrantResourceOwnerCredentials`</span><span class="sxs-lookup"><span data-stu-id="a459f-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="a459f-237">Приведенный выше код предназначен для объяснения этого раздела учебника и не должен использоваться в защищенных или производственных приложениях.</span><span class="sxs-lookup"><span data-stu-id="a459f-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="a459f-238">Он не проверяет учетные данные владельцев ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a459f-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="a459f-239">Он предполагает, что все учетные данные действительны и создает для нее новую идентификацию.</span><span class="sxs-lookup"><span data-stu-id="a459f-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="a459f-240">Новая идентификация будет использоваться для создания токена доступа и обновления токена.</span><span class="sxs-lookup"><span data-stu-id="a459f-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="a459f-241">Пожалуйста, замените код собственным кодом управления защищенным счетом.</span><span class="sxs-lookup"><span data-stu-id="a459f-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="a459f-242">Грант на учетные данные клиентов</span><span class="sxs-lookup"><span data-stu-id="a459f-242">Client Credentials Grant</span></span>

<span data-ttu-id="a459f-243">Обратитесь к разделу [Грант аттестат о предоставлении клиентских полномочий](http://tools.ietf.org/html/rfc6749#section-4.4) IETF В.О.2.</span><span class="sxs-lookup"><span data-stu-id="a459f-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="a459f-244">[Клиент полномочия Грант](http://tools.ietf.org/html/rfc6749#section-4.4) поток показано на рисунке 6 является поток и отображение которых OWIN OAuth промежуточного следует.</span><span class="sxs-lookup"><span data-stu-id="a459f-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="a459f-245">Шаги потока из раздела Грант учетных данных клиентов</span><span class="sxs-lookup"><span data-stu-id="a459f-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="a459f-246">Пример загрузки выполняет следующие шаги с:</span><span class="sxs-lookup"><span data-stu-id="a459f-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a459f-247">(A) Клиент проверяет подлинность с помощью сервера авторизации и запрашивает токен доступа из точки конечных токенов.</span><span class="sxs-lookup"><span data-stu-id="a459f-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="a459f-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a459f-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a459f-249">(B) Сервер авторизации проверяет подлинность клиента, и если он действителен, выдает токен доступа.</span><span class="sxs-lookup"><span data-stu-id="a459f-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="a459f-250">Вот пример реализации: `Provider.GrantClientCredentials`</span><span class="sxs-lookup"><span data-stu-id="a459f-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="a459f-251">Приведенный выше код предназначен для объяснения этого раздела учебника и не должен использоваться в защищенных или производственных приложениях.</span><span class="sxs-lookup"><span data-stu-id="a459f-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="a459f-252">Пожалуйста, замените код собственным защищенным кодом управления клиентами.</span><span class="sxs-lookup"><span data-stu-id="a459f-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="a459f-253">Refresh Token</span><span class="sxs-lookup"><span data-stu-id="a459f-253">Refresh Token</span></span>

<span data-ttu-id="a459f-254">Обратитесь к [разделу](http://tools.ietf.org/html/rfc6749#section-1.5) OAuth 2 OAUF 2.</span><span class="sxs-lookup"><span data-stu-id="a459f-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="a459f-255">Поток [Refresh Token,](http://tools.ietf.org/html/rfc6749#section-1.5) показанный на рисунке 2, — это поток и отображение, за которым следует промежуточное программное обеспечение OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="a459f-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="a459f-256">Шаги потока из раздела Грант учетных данных клиентов</span><span class="sxs-lookup"><span data-stu-id="a459f-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="a459f-257">Пример загрузки выполняет следующие шаги с:</span><span class="sxs-lookup"><span data-stu-id="a459f-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a459f-258">(G) Клиент запрашивает новый токен доступа, завершая проверку подлинности с сервером авторизации и представляя токен обновления.</span><span class="sxs-lookup"><span data-stu-id="a459f-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="a459f-259">Требования к аутентификации клиента основаны на типе клиента и на политиках сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="a459f-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a459f-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a459f-261">(H) Сервер авторизации проверяет подлинность клиента и проверяет токен обновления, и если он действителен, выдает новый токен доступа (и, по желанию, новый маркер обновления).</span><span class="sxs-lookup"><span data-stu-id="a459f-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="a459f-262">Вот пример реализации: `Provider.GrantRefreshToken`</span><span class="sxs-lookup"><span data-stu-id="a459f-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="a459f-263">Создание сервера ресурсов, защищенного токеном доступа</span><span class="sxs-lookup"><span data-stu-id="a459f-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="a459f-264">Создайте пустой проект веб-приложения и установите следующие пакеты в проекте:</span><span class="sxs-lookup"><span data-stu-id="a459f-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="a459f-265">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="a459f-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="a459f-266">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="a459f-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="a459f-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="a459f-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="a459f-268">Создайте класс запуска и назначайте аутентификацию и Web API.</span><span class="sxs-lookup"><span data-stu-id="a459f-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="a459f-269">См *авторизацияServer-ResourceServer-Startup.cs* в примере загрузки.</span><span class="sxs-lookup"><span data-stu-id="a459f-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="a459f-270">В примере загрузки сможете ознакомиться с загружаемой загрузкой *\_авторизацииСервер-РесурсСервер-Приложение Start.Start.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="a459f-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="a459f-271">В примере загрузки сможете *скачать авторизациюServer-ResourceServer-App\_Start.Start.WebApi.cs.*</span><span class="sxs-lookup"><span data-stu-id="a459f-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="a459f-272">`UseCors`метод позволяет CORS для всех доменов.</span><span class="sxs-lookup"><span data-stu-id="a459f-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="a459f-273">`UseOAuthBearerAuthentication`метод позволяет OAuth предъявителя маркера проверки подлинности промежуточной, которая будет получать и проверять маркер носителя из заголовка авторизации в запросе.</span><span class="sxs-lookup"><span data-stu-id="a459f-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="a459f-274">`Config.SuppressDefaultHostAuthenticaiton`подавляет аутентифицированный принцип хоста по умолчанию из приложения, поэтому все запросы будут анонимными после этого вызова.</span><span class="sxs-lookup"><span data-stu-id="a459f-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="a459f-275">`HostAuthenticationFilter`позволяет аутентификацию только для указанного типа проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="a459f-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="a459f-276">В этом случае это тип проверки подлинности носителя.</span><span class="sxs-lookup"><span data-stu-id="a459f-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="a459f-277">Для демонстрации подлинной идентификации мы создаем ApiController для вывода текущих утверждений пользователя.</span><span class="sxs-lookup"><span data-stu-id="a459f-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="a459f-278">Если сервер авторизации и сервер ресурсов не находятся на одном компьютере, промежуточное программное обеспечение OAuth будет использовать различные клавиши машины для шифрования и расшифровки токена доступа к носители.</span><span class="sxs-lookup"><span data-stu-id="a459f-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="a459f-279">Для того, чтобы общий ключ между обоими `machinekey` проектами, мы добавляем один и тот же параметр в обоих файлах *web.config.*</span><span class="sxs-lookup"><span data-stu-id="a459f-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="a459f-280">Создание клиентов OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="a459f-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="a459f-281">Мы используем пакет [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet для упрощения клиентского кода.</span><span class="sxs-lookup"><span data-stu-id="a459f-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="a459f-282">Авторизация Код Грант Клиент</span><span class="sxs-lookup"><span data-stu-id="a459f-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="a459f-283">Этот клиент является приложением MVC.</span><span class="sxs-lookup"><span data-stu-id="a459f-283">This client is an MVC application.</span></span> <span data-ttu-id="a459f-284">Это вызовет поток грантов кода авторизации, чтобы получить токен доступа из бэкэнда.</span><span class="sxs-lookup"><span data-stu-id="a459f-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="a459f-285">Он имеет одну страницу, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="a459f-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="a459f-286">Кнопка **Authorize** перенаправит браузер на сервер авторизации, чтобы уведомить владельца ресурса предоставить доступ к этому клиенту.</span><span class="sxs-lookup"><span data-stu-id="a459f-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="a459f-287">Кнопка **Обновления** получит новый токен доступа и обновит токен с помощью токена текущего обновления.</span><span class="sxs-lookup"><span data-stu-id="a459f-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="a459f-288">Кнопка **API защищенного ресурсами доступа** вызовет сервер ресурсов, чтобы получить текущие данные о претензиях пользователя и показать их на странице.</span><span class="sxs-lookup"><span data-stu-id="a459f-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="a459f-289">Вот пример кода `HomeController` клиента.</span><span class="sxs-lookup"><span data-stu-id="a459f-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="a459f-290">`DotNetOpenAuth`требует SSL по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="a459f-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="a459f-291">Так как наше демо использует HTTP, вам нужно добавить следующие настройки в файле конфигурации:</span><span class="sxs-lookup"><span data-stu-id="a459f-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="a459f-292">Безопасность - Никогда не отменяйте SSL в производственном приложении.</span><span class="sxs-lookup"><span data-stu-id="a459f-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="a459f-293">Ваши учетные данные входа теперь отправляются в четком тексте по проводу.</span><span class="sxs-lookup"><span data-stu-id="a459f-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="a459f-294">Приведенный выше код предназначен только для локальной отладки и разведки образцов.</span><span class="sxs-lookup"><span data-stu-id="a459f-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="a459f-295">Неявный грант клиент</span><span class="sxs-lookup"><span data-stu-id="a459f-295">Implicit Grant Client</span></span>

<span data-ttu-id="a459f-296">Этот клиент использует JavaScript для:</span><span class="sxs-lookup"><span data-stu-id="a459f-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="a459f-297">Откройте новое окно и перенаправьте на авторизуеруконечную конечную точку сервера авторизации.</span><span class="sxs-lookup"><span data-stu-id="a459f-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="a459f-298">Получите токен доступа из фрагментов URL-адресов при перенаправлении назад.</span><span class="sxs-lookup"><span data-stu-id="a459f-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="a459f-299">На следующем изображении показан этот процесс:</span><span class="sxs-lookup"><span data-stu-id="a459f-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="a459f-300">Клиент должен иметь две страницы: одна для домашней страницы, а другая для обратного вызова. Вот пример кода JavaScript, найденный в файле *Index.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="a459f-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="a459f-301">Вот код обработки обратных вызовов в файле *SignIn.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="a459f-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="a459f-302">Наилучшей практикой является перемещение JavaScript во внешний файл, а не вставлять его с разметкой Razor.</span><span class="sxs-lookup"><span data-stu-id="a459f-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="a459f-303">Чтобы сохранить этот образец простым, они были объединены.</span><span class="sxs-lookup"><span data-stu-id="a459f-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="a459f-304">Ресурс Владелец Пароль Полномочия Грант Клиент</span><span class="sxs-lookup"><span data-stu-id="a459f-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="a459f-305">Мы с помощью консольного приложения для демонстрации этого клиента.</span><span class="sxs-lookup"><span data-stu-id="a459f-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="a459f-306">Ниже приведен код:</span><span class="sxs-lookup"><span data-stu-id="a459f-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="a459f-307">Клиент скиеили учетных данных Грант Клиент</span><span class="sxs-lookup"><span data-stu-id="a459f-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="a459f-308">Как и в ресурсе Владелец пароль полномочия Грант, вот код приложения консоли:</span><span class="sxs-lookup"><span data-stu-id="a459f-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
