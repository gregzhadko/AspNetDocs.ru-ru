---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: По промежуточного слоя OWIN в службах IIS интегрирован конвейера | Документация Майкрософт
author: Praburaj
description: В этой статье показано, как для запуска компонентов по промежуточного слоя OWIN (OMCs) в интегрированном конвейере служб IIS и работает как для установки события конвейера OMC на. Вы должны...
ms.author: riande
ms.date: 11/07/2013
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 484c01f19014639cc30244ed4f4d014794594aa2
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59391706"
---
# <a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="453b8-104">По промежуточного слоя OWIN в интегрированном конвейере служб IIS</span><span class="sxs-lookup"><span data-stu-id="453b8-104">OWIN Middleware in the IIS integrated pipeline</span></span>

<span data-ttu-id="453b8-105">по [Praburaj Thiagarajan](https://github.com/Praburaj), [Рик Андерсон]((https://twitter.com/RickAndMSFT))</span><span class="sxs-lookup"><span data-stu-id="453b8-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson]((https://twitter.com/RickAndMSFT))</span></span>

> <span data-ttu-id="453b8-106">В этой статье показано, как для запуска компонентов по промежуточного слоя OWIN (OMCs) в интегрированном конвейере служб IIS и работает как для установки события конвейера OMC на.</span><span class="sxs-lookup"><span data-stu-id="453b8-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="453b8-107">Необходимо ознакомиться с [Обзор проекта Katana](an-overview-of-project-katana.md) и [определение класса запуска OWIN](owin-startup-class-detection.md) перед чтением этого руководства.</span><span class="sxs-lookup"><span data-stu-id="453b8-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="453b8-108">Это руководство было написано с Рик Андерсон ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) ), Крис Росс Praburaj Thiagarajan и Говард Дайеркинг ( [ @howard \_Дайеркинг](https://twitter.com/howard_dierking) ).</span><span class="sxs-lookup"><span data-stu-id="453b8-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>


<span data-ttu-id="453b8-109">Несмотря на то что [OWIN](an-overview-of-project-katana.md) компоненты по промежуточного слоя (OMCs) в первую очередь предназначены для запуска в конвейере независимой от сервера, можно запустить в интегрированном конвейере служб IIS также OMC (**является классический режим *не* поддерживается**).</span><span class="sxs-lookup"><span data-stu-id="453b8-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="453b8-110">OMC можно сделать для работы в интегрированном конвейере служб IIS, установив следующий пакет из консоли диспетчера пакетов (PMC):</span><span class="sxs-lookup"><span data-stu-id="453b8-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="453b8-111">Это означает, что все платформы приложений, даже те, которые еще не запускаться вне IIS и System.Web, можно использовать существующие компоненты по промежуточного слоя OWIN.</span><span class="sxs-lookup"><span data-stu-id="453b8-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="453b8-112">Все `Microsoft.Owin.Security.*` пакеты доставки с помощью новой системы удостоверений в Visual Studio 2013 (например: Файлы cookie, учетной записи Майкрософт, Google, Facebook, Twitter, [маркера носителя](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, сервер авторизации, JWT, Azure Active directory и служб федерации Active directory) создаются как OMCs и может использоваться в обоих с самостоятельным размещением и сценарии, размещенные в IIS.</span><span class="sxs-lookup"><span data-stu-id="453b8-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="453b8-113">Как выполняется по промежуточного слоя OWIN в интегрированном конвейере служб IIS</span><span class="sxs-lookup"><span data-stu-id="453b8-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="453b8-114">Для консольных приложений OWIN, использующем конвейера приложения [конфигурации запуска](owin-startup-class-detection.md) задается порядок добавления компонентов с помощью `IAppBuilder.Use` метод.</span><span class="sxs-lookup"><span data-stu-id="453b8-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="453b8-115">То есть в конвейер OWIN в [Katana](an-overview-of-project-katana.md) среда выполнения обработает OMCs в порядке, они были зарегистрированы с помощью `IAppBuilder.Use`.</span><span class="sxs-lookup"><span data-stu-id="453b8-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="453b8-116">В интегрированном конвейере служб IIS конвейера запросов состоит из [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) подписка на набор предварительно определенных событий конвейера, такие как [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)и т. д.</span><span class="sxs-lookup"><span data-stu-id="453b8-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="453b8-117">Сравнив OMC, [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) в мире ASP.NET OMC должно быть зарегистрировано для конвейера правильный предварительно определенные события.</span><span class="sxs-lookup"><span data-stu-id="453b8-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="453b8-118">Например, модуль HttpModule `MyModule` будет вызван при поступлении запроса [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) этапом работы конвейера:</span><span class="sxs-lookup"><span data-stu-id="453b8-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="453b8-119">Выполнился OMC участвовать в этот порядок выполнения же, основанное на событиях [Katana](an-overview-of-project-katana.md) кода среды выполнения просматривает [конфигурации запуска](owin-startup-class-detection.md) и подписывается, каждый из компонентов по промежуточного слоя для событие интегрированного конвейера.</span><span class="sxs-lookup"><span data-stu-id="453b8-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="453b8-120">Например следующий код OMC и регистрации позволяет см. в разделе регистрации событий по умолчанию компонентов по промежуточного слоя.</span><span class="sxs-lookup"><span data-stu-id="453b8-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="453b8-121">(Более подробные инструкции по созданию класса запуска OWIN, см. в разделе [определение класса запуска OWIN](owin-startup-class-detection.md).)</span><span class="sxs-lookup"><span data-stu-id="453b8-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="453b8-122">Создайте приложение в пустой веб-проект и назовите его **owin2**.</span><span class="sxs-lookup"><span data-stu-id="453b8-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="453b8-123">Из консоли диспетчера пакетов (PMC), выполните следующую команду:</span><span class="sxs-lookup"><span data-stu-id="453b8-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="453b8-124">Добавить `OWIN Startup Class` и назовите его `Startup`.</span><span class="sxs-lookup"><span data-stu-id="453b8-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="453b8-125">Замените сгенерированный код следующим (изменения выделены):</span><span class="sxs-lookup"><span data-stu-id="453b8-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="453b8-126">Нажмите клавишу F5 для запуска приложения.</span><span class="sxs-lookup"><span data-stu-id="453b8-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="453b8-127">Конфигурации запуска настраивает конвейер с по промежуточного слоя для трех компонентов, первые два отображения диагностической информации и реагирование на события последним (и также отображения диагностической информации).</span><span class="sxs-lookup"><span data-stu-id="453b8-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="453b8-128">`PrintCurrentIntegratedPipelineStage` Метод отображает интегрированного конвейера событий, вызывается это по промежуточного слоя, а также сообщение.</span><span class="sxs-lookup"><span data-stu-id="453b8-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="453b8-129">В окнах вывода отображаются следующие сведения:</span><span class="sxs-lookup"><span data-stu-id="453b8-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="453b8-130">Среда выполнения Katana сопоставить каждый из компонентов по промежуточного слоя OWIN для [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) по умолчанию, который соответствует событию конвейера IIS [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span><span class="sxs-lookup"><span data-stu-id="453b8-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="453b8-131">Маркеры рабочей области</span><span class="sxs-lookup"><span data-stu-id="453b8-131">Stage Markers</span></span>

<span data-ttu-id="453b8-132">Вы можете пометить OMCs выполнение на определенных этапах конвейера при помощи `IAppBuilder UseStageMarker()` метода расширения.</span><span class="sxs-lookup"><span data-stu-id="453b8-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="453b8-133">Для запуска набора компонентов по промежуточного слоя во время определенного этапа, Вставить метку этапа сразу после последнего компонента — это набор во время регистрации.</span><span class="sxs-lookup"><span data-stu-id="453b8-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="453b8-134">Существуют правила, на каком этапе конвейера можно выполнить по промежуточного слоя и компоненты заказа необходимо запустить (правила мы вернемся позже в этом руководстве).</span><span class="sxs-lookup"><span data-stu-id="453b8-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="453b8-135">Добавить `UseStageMarker` метод `Configuration` кода, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="453b8-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="453b8-136">`app.UseStageMarker(PipelineStage.Authenticate)` Вызов настраивает все компоненты по промежуточного слоя для зарегистрированного ранее (в данном случае наши два компонента диагностики) для запуска на стадии конвейера проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="453b8-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="453b8-137">Последний компонент по промежуточного слоя (который отображает диагностики и отвечает на запросы) будет выполняться на `ResolveCache` рабочей области ( [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) событий).</span><span class="sxs-lookup"><span data-stu-id="453b8-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="453b8-138">Нажмите клавишу F5 для запуска приложения. В окне вывода отобразится следующее:</span><span class="sxs-lookup"><span data-stu-id="453b8-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="453b8-139">Правила этапа маркера</span><span class="sxs-lookup"><span data-stu-id="453b8-139">Stage Marker Rules</span></span>

<span data-ttu-id="453b8-140">Компоненты по промежуточного слоя Owin (OMC) можно настроить для выполнения на следующие события этап конвейера OWIN:</span><span class="sxs-lookup"><span data-stu-id="453b8-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="453b8-141">По умолчанию OMCs выполняются с последнего события (`PreHandlerExecute`).</span><span class="sxs-lookup"><span data-stu-id="453b8-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="453b8-142">Вот почему наш первый пример кода отображается «PreExecuteRequestHandler».</span><span class="sxs-lookup"><span data-stu-id="453b8-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="453b8-143">Можно использовать `app.UseStageMarker` метод, чтобы зарегистрировать OMC для более ранних версиях выполнения на любом этапе конвейера OWIN перечисленные в `PipelineStage` перечисления.</span><span class="sxs-lookup"><span data-stu-id="453b8-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="453b8-144">Конвейер OWIN и конвейер IIS упорядочен, поэтому вызовы `app.UseStageMarker` должно быть в порядке.</span><span class="sxs-lookup"><span data-stu-id="453b8-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="453b8-145">Не удается задать обработчик событий на событие, которое предшествует последнее событие, зарегистрированное для `app.UseStageMarker`.</span><span class="sxs-lookup"><span data-stu-id="453b8-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="453b8-146">Например *после* вызова:</span><span class="sxs-lookup"><span data-stu-id="453b8-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

   <span data-ttu-id="453b8-147">вызовы `app.UseStageMarker` передачи `Authenticate` или `PostAuthenticate` не будут выполняться, а не исключение.</span><span class="sxs-lookup"><span data-stu-id="453b8-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="453b8-148">OMCs, выполните в последней рабочей области, который по умолчанию является `PreHandlerExecute`.</span><span class="sxs-lookup"><span data-stu-id="453b8-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="453b8-149">Чтобы сделать их для выполнения ранее используются маркеры рабочей области.</span><span class="sxs-lookup"><span data-stu-id="453b8-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="453b8-150">При указании маркеры рабочей области по порядку, мы округление к более ранней маркеру.</span><span class="sxs-lookup"><span data-stu-id="453b8-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="453b8-151">Другими словами Добавление метку этапа, — говорит «Запуск не позднее, чем этап X».</span><span class="sxs-lookup"><span data-stu-id="453b8-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="453b8-152">OMC его выполнения в самая ранняя метка этапа, добавленные после их в конвейер OWIN.</span><span class="sxs-lookup"><span data-stu-id="453b8-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="453b8-153">Самый ранний этап вызовы `app.UseStageMarker` wins.</span><span class="sxs-lookup"><span data-stu-id="453b8-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="453b8-154">Например, если Смена местами `app.UseStageMarker` вызовы из предыдущего примера:</span><span class="sxs-lookup"><span data-stu-id="453b8-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

   <span data-ttu-id="453b8-155">Для отображения в окне вывода:</span><span class="sxs-lookup"><span data-stu-id="453b8-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

   <span data-ttu-id="453b8-156">Работают в OMCs `AuthenticateRequest` этап, так как последний OMC зарегистрирована `Authenticate` событий и `Authenticate` событий предшествует всех остальных событий.</span><span class="sxs-lookup"><span data-stu-id="453b8-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
