---
uid: identity/overview/extensibility/overview-of-custom-storage-providers-for-aspnet-identity
title: Обзор пользовательских поставщиков хранилища для ASP.NET Identity-ASP.NET 4. x
author: Rick-Anderson
description: ASP.NET Identity — это расширяемая система, которая позволяет создать собственный поставщик хранилища и подключить его к приложению без повторной работы приложения...
ms.author: riande
ms.date: 10/13/2014
ms.assetid: 681a9204-462e-4260-9a0b-19f0644d6ad7
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/extensibility/overview-of-custom-storage-providers-for-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 21baedf6285b411f89627df9ca25d47a2a42e387
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78472224"
---
# <a name="overview-of-custom-storage-providers-for-aspnet-identity"></a>Обзор пользовательских поставщиков хранилищ для ASP.NET Identity

от [Tom фитзмаккен](https://github.com/tfitzmac)

> ASP.NET Identity — это расширяемая система, которая позволяет создать собственный поставщик хранилища и подключить его к приложению без повторной работы приложения. В этом разделе описывается создание настраиваемого поставщика хранилища для ASP.NET Identity. В нем рассматриваются важные понятия создания собственного поставщика хранилища, но не пошаговое руководство по реализации пользовательского поставщика хранилища.
> 
> Пример реализации пользовательского поставщика хранилища см. [в статье реализация пользовательского поставщика хранилища ASP.NET Identity MySQL](implementing-a-custom-mysql-aspnet-identity-storage-provider.md).
> 
> Этот раздел был обновлен для ASP.NET Identity 2,0.
> 
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемые в этом руководстве
> 
> 
> - Visual Studio 2013 с обновлением 2
> - ASP.NET Identity 2

## <a name="introduction"></a>Введение

По умолчанию ASP.NET Identity система хранит сведения о пользователях в базе данных SQL Server и использует Entity Framework Code First для создания базы данных. Для многих приложений такой подход хорошо работает. Однако вы можете использовать другой тип механизма сохранения, например хранилище таблиц Azure, или же таблицы базы данных с совершенно отличной структурой по сравнению с реализацией по умолчанию. В любом случае можно написать настраиваемый поставщик для механизма хранения и подключить его к приложению.

ASP.NET Identity включен по умолчанию во многих шаблонах Visual Studio 2013. Вы можете получить обновления для ASP.NET Identity с помощью [пакета NuGet Microsoft AspNet Identity EntityFramework](http://www.nuget.org/packages/Microsoft.AspNet.Identity.EntityFramework/).

Этот раздел включает следующие подразделы:

- [Общие сведения об архитектуре](#architecture)
- [Общие сведения о хранимых данных](#data)
- [Создание уровня доступа к данным](#dal)
- [Настройка класса User](#user)
- [Настройка хранилища пользователей](#userstore)
- [Настройка класса Role](#role)
- [Настройка хранилища ролей](#rolestore)
- [Перенастроить приложение для использования нового поставщика хранилища](#reconfigure)
- [Другие реализации пользовательских поставщиков хранилища](#other)

<a id="architecture"></a>
## <a name="understand-the-architecture"></a>Общие сведения об архитектуре

ASP.NET Identity состоит из классов, именуемых диспетчерами и магазинами. Руководители — это высокоуровневые классы, которые разработчик приложений использует для выполнения таких операций, как создание пользователя в системе ASP.NET Identity. Магазины — это классы более низкого уровня, указывающие, как сохраняются сущности, например пользователи и роли. Хранилища тесно связаны с механизмом сохранения, но менеджеры отделяются от хранилищ. Это означает, что вы можете заменить механизм сохраняемости, не нарушая работу всего приложения.

На следующей схеме показано, как веб-приложение взаимодействует с менеджерами, и сохраняет взаимодействие с уровнем доступа к данным.

![](overview-of-custom-storage-providers-for-aspnet-identity/_static/image1.png)

Чтобы создать настраиваемый поставщик хранилища для ASP.NET Identity, необходимо создать источник данных, уровень доступа к данным и классы хранилища, взаимодействующие с этим уровнем доступа к данным. Вы можете продолжить использовать те же API-интерфейсы диспетчера для выполнения операций с данными на пользователя, но теперь эти данные сохраняются в другой системе хранения.

Настраивать классы Manager не требуется, так как при создании нового экземпляра UserManager или RoleManager вы предоставляете тип класса User и передаете экземпляр класса Store в качестве аргумента. Такой подход позволяет подключать пользовательские классы к существующей структуре. Вы узнаете, как создать экземпляр UserManager и RoleManager с вашими настроенными классами хранилища в разделе [перенастройка приложения для использования нового поставщика хранилища](#reconfigure).

<a id="data"></a>
## <a name="understand-the-data-that-is-stored"></a>Общие сведения о хранимых данных

Для реализации пользовательского поставщика хранилища необходимо понимать типы данных, используемых в ASP.NET Identity, а также определить, какие функции относятся к вашему приложению.

| Данные | Description |
| --- | --- |
| Пользователи | Зарегистрированные пользователи вашего веб-сайта. Включает идентификатор пользователя и имя пользователя. Может включать хэшированный пароль, если пользователи входят в систему с учетными данными, специфическими для вашего сайта (вместо использования учетных данных с внешнего сайта, например Facebook), и метки безопасности, указывающей, изменились ли какие-либо изменения в учетных данных пользователя. Может также включать адрес электронной почты, номер телефона, включение двухфакторной проверки подлинности, текущее число неудачных попыток входа и заблокирована ли учетная запись. |
| Утверждения пользователей | Набор инструкций (или утверждений) о пользователе, который представляет удостоверение пользователя. Можно включить большее выражение удостоверения пользователя, чем можно достичь с помощью ролей. |
| Имена входа пользователей | Сведения о внешнем поставщике проверки подлинности (например, Facebook), который будет использоваться для входа пользователя. |
| Роли | Группы авторизации для сайта. Содержит идентификатор роли и имя роли (например, "admin" или "Employee"). |

<a id="dal"></a>
## <a name="create-the-data-access-layer"></a>Создание уровня доступа к данным

В этом разделе предполагается, что вы знакомы с механизмом сохраняемости, который вы собираетесь использовать, и как создавать сущности для этого механизма. В этом разделе не приводятся сведения о создании репозиториев или классов доступа к данным. Вместо этого он предоставляет некоторые рекомендации по архитектуре, которые необходимо принять при работе с ASP.NET Identity.

При проектировании репозиториев для настроенного поставщика хранилища у вас есть масса свободы. Для компонентов, которые предполагается использовать в приложении, необходимо создать только репозитории. Например, если вы не используете роли в приложении, вам не нужно создавать хранилище для ролей или ролей пользователей. Для вашей технологии и существующей инфраструктуры может потребоваться структура, которая сильно отличается от реализации по умолчанию ASP.NET Identity. На уровне доступа к данным вы предоставляете логику для работы со структурой репозиториев.

Сведения о реализации репозиториев данных в MySQL для ASP.NET Identity 2,0 см. в разделе [мисклидентити. SQL](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/MySQLIdentity.sql).

На уровне доступа к данным вы предоставляете логику для сохранения данных из ASP.NET Identity в источнике данных. Уровень доступа к данным для настроенного поставщика хранилища может включать следующие классы для хранения сведений о пользователях и ролях.

| Class | Description | Пример |
| --- | --- | --- |
| Контекст | Инкапсулирует сведения для подключения к механизму сохранения и выполнения запросов. Этот класс является центральным для уровня доступа к данным. Другим классам данных потребуется экземпляр этого класса для выполнения своих операций. Кроме того, вы инициализируйте классы хранилища с помощью экземпляра этого класса. | [мисклдатабасе](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/MySQLDatabase.cs) |
| Хранилище пользователя | Сохраняет и извлекает сведения о пользователе (например, имя пользователя и хэш пароля). | [Усертабле (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/UserTable.cs) |
| Хранилище ролей | Сохраняет и извлекает сведения о ролях (например, имя роли). | [Ролетабле (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/RoleTable.cs) |
| Хранилище Усерклаимс | Сохраняет и извлекает сведения о пользовательской заявке (например, тип и значение утверждения). | [Усерклаимстабле (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/UserClaimsTable.cs) |
| Хранилище Усерлогинс | Хранит и получает сведения для входа пользователя (например, внешний поставщик проверки подлинности). | [Усерлогинстабле (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/UserLoginsTable.cs) |
| Хранилище UserRole | Сохраняет и извлекает роли, назначенные пользователю. | [Усерролетабле (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/UserRoleTable.cs) |

Опять же, достаточно реализовать классы, которые будут использоваться в приложении.

В классах доступа к данным вы предоставляете код для выполнения операций с данными в конкретном механизме сохраняемости. Например, в реализации MySQL класс Усертабле содержит метод для вставки новой записи в таблицу базы данных Users. Переменная с именем `_database` является экземпляром класса Мисклдатабасе.

[!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample1.cs)]

После создания классов доступа к данным необходимо создать классы хранения, которые вызывают конкретные методы на уровне доступа к данным.

<a id="user"></a>
## <a name="customize-the-user-class"></a>Настройка класса User

При реализации собственного поставщика хранилища необходимо создать класс пользователя, эквивалентный классу [идентитюсер](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser(v=vs.108).aspx) в пространстве имен [Microsoft. ASP. NET. Identity. EntityFramework](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework(v=vs.108).aspx) :

На следующей схеме показан класс Идентитюсер, который необходимо создать, и интерфейс для реализации в этом классе.

![](overview-of-custom-storage-providers-for-aspnet-identity/_static/image2.png)

Интерфейс [&gt;IUser&lt;TKey](https://msdn.microsoft.com/library/dn613291(v=vs.108).aspx) определяет свойства, которые UserManager пытается вызвать при выполнении запрошенных операций. Интерфейс содержит два свойства: ID и UserName. Интерфейс [&gt;IUser&lt;TKey](https://msdn.microsoft.com/library/dn613291(v=vs.108).aspx) позволяет указать тип ключа для пользователя с помощью универсального параметра **TKey** . Тип свойства ID соответствует значению параметра TKey.

Платформа удостоверений также предоставляет интерфейс [IUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.iuser(v=vs.108).aspx) (без универсального параметра), если требуется использовать строковое значение для ключа.

Класс Идентитюсер реализует IUser и содержит любые дополнительные свойства или конструкторы для пользователей на вашем веб-сайте. В следующем примере показан класс Идентитюсер, который использует целое число для ключа. Поле идентификатора устанавливается в значение **int** в соответствии со значением универсального параметра. 

[!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample2.cs)]

 Полную реализацию см. в разделе [идентитюсер (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/IdentityUser.cs). 

<a id="userstore"></a>
## <a name="customize-the-user-store"></a>Настройка хранилища пользователей

Также создается класс UserStore, предоставляющий методы для всех операций с данными пользователя. Этот класс эквивалентен классу [UserStore&lt;тусер&gt;](https://msdn.microsoft.com/library/dn315446(v=vs.108).aspx) в пространстве имен [Microsoft. ASP. NET. Identity. EntityFramework](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework(v=vs.108).aspx) . В классе UserStore вы реализуете [IUserStore&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613276(v=vs.108).aspx) и любые дополнительные интерфейсы. Вы можете выбрать, какие дополнительные интерфейсы следует реализовать на основе функциональных возможностей, которые вы хотите предоставить в приложении.

На следующем рисунке показан класс UserStore, который необходимо создать, и соответствующие интерфейсы.

![](overview-of-custom-storage-providers-for-aspnet-identity/_static/image3.png)

Шаблон проекта по умолчанию в Visual Studio содержит код, который предполагает, что многие из дополнительных интерфейсов были реализованы в хранилище пользователя. Если вы используете шаблон по умолчанию с настроенным хранилищем пользователей, необходимо либо реализовать дополнительные интерфейсы в хранилище пользователя, либо изменить код шаблона, чтобы он больше не вызывал методы в интерфейсах, которые не были реализованы.

 В следующем примере показан простой класс хранилища пользователя. Универсальный параметр **Тусер** принимает тип класса пользователя, который обычно является классом идентитюсер, который вы определили. Универсальный параметр **TKey** принимает тип ключа пользователя. 

[!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample3.cs)]

 В этом примере конструктор, принимающий параметр с именем *Database* типа ексампледатабасе, является лишь иллюстрацией того, как передать в класс доступа к данным. Например, в реализации MySQL этот конструктор принимает параметр типа Мисклдатабасе. 

В классе UserStore используются классы доступа к данным, созданные для выполнения операций. Например, в реализации MySQL класс UserStore имеет метод CreateAsync, который использует экземпляр Усертабле для вставки новой записи. Метод **INSERT** объекта **усертабле** — это тот же метод, который был показан в предыдущем разделе. 

[!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample4.cs)]

### <a name="interfaces-to-implement-when-customizing-user-store"></a>Интерфейсы, реализуемые при настройке хранилища пользователей

На следующем рисунке показаны дополнительные сведения о функциональных возможностях, определенных в каждом интерфейсе. Все необязательные интерфейсы наследуют от IUserStore.

![](overview-of-custom-storage-providers-for-aspnet-identity/_static/image4.png)

- **IUserStore**  
  Интерфейс [IUserStore&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613278(v=vs.108).aspx) является единственным интерфейсом, который необходимо реализовать в хранилище пользователя. Он определяет методы для создания, обновления, удаления и получения пользователей.
- **IUserClaimStore**  
  Интерфейс [IUserClaimStore&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613265(v=vs.108).aspx) определяет методы, которые необходимо реализовать в хранилище пользователя для включения заявок пользователя. Он содержит методы, а также добавляет, удаляет и извлекает утверждения пользователей.
- **иусерлогинсторе**  
  [Иусерлогинсторе&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613272(v=vs.108).aspx) определяет методы, которые необходимо реализовать в хранилище пользователя для включения внешних поставщиков проверки подлинности. Он содержит методы для добавления, удаления и получения имен входа пользователей, а также метод для получения пользователя на основе сведений об имени входа.
- **IUserRoleStore**  
  Интерфейс [IUserRoleStore&lt;TKey, тусер&gt;](https://msdn.microsoft.com/library/dn613276(v=vs.108).aspx) определяет методы, которые необходимо реализовать в хранилище пользователя, чтобы сопоставлять пользователя с ролью. Он содержит методы для добавления, удаления и получения ролей пользователя, а также метод для проверки того, назначен ли пользователю роль.
- **IUserPasswordStore**  
  Интерфейс [IUserPasswordStore&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613273(v=vs.108).aspx) определяет методы, которые необходимо реализовать в хранилище пользователя для сохранения хэшированных паролей. Он содержит методы для получения и установки хэшированного пароля, а также метод, который указывает, установил ли пользователь пароль.
- **иусерсекуритистампсторе**  
  Интерфейс [&gt;иусерсекуритистампсторе&lt;Тусер, TKey](https://msdn.microsoft.com/library/dn613277(v=vs.108).aspx) определяет методы, которые необходимо реализовать в хранилище пользователя, чтобы использовать метку безопасности для указания, изменились ли сведения об учетной записи пользователя. Эта метка обновляется, когда пользователь изменяет пароль или добавляет или удаляет имена входа. Он содержит методы для получения и установки метки безопасности.
- **IUserTwoFactorStore**  
  Интерфейс [&gt;IUserTwoFactorStore&lt;Тусер, TKey](https://msdn.microsoft.com/library/dn613279(v=vs.108).aspx) определяет методы, которые необходимо реализовать для реализации двухфакторной проверки подлинности. Он содержит методы для получения и настройки проверки подлинности, включенной для пользователя.
- **иусерфоненумберсторе**  
  Интерфейс [иусерфоненумберсторе&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613275(v=vs.108).aspx) определяет методы, которые необходимо реализовать для хранения телефонных номеров пользователей. Он содержит методы для получения и установки номера телефона, а также сведения о подтверждении номера телефона.
- **иусеремаилсторе**  
  Интерфейс [иусеремаилсторе&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613143(v=vs.108).aspx) определяет методы, которые необходимо реализовать для хранения адресов электронной почты пользователей. Он содержит методы для получения и установки адреса электронной почты, а также сведения о том, подтверждено ли сообщение электронной почты.
- **иусерлоккаутсторе**  
  Интерфейс [иусерлоккаутсторе&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613271(v=vs.108).aspx) определяет методы, которые необходимо реализовать для хранения сведений о блокировке учетной записи. Он содержит методы для получения текущего количества неудачных попыток доступа, получения и задания возможности блокировки учетной записи, получения и установки даты окончания блокировки, увеличения числа неудачных попыток и сброса количества неудачных попыток.
- **IQueryableUserStore**  
  Интерфейс [IQueryableUserStore&lt;Тусер, TKey&gt;](https://msdn.microsoft.com/library/dn613267(v=vs.108).aspx) определяет члены, которые необходимо реализовать для предоставления запрашиваемого хранилища пользователя. Он содержит свойство, которое содержит запрашиваемых пользователей.

  Вы реализуете интерфейсы, необходимые в приложении; Например, интерфейсы IUserClaimStore, Иусерлогинсторе, IUserRoleStore, IUserPasswordStore и Иусерсекуритистампсторе, как показано ниже. 

[!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample5.cs)]

Полную реализацию (включая все интерфейсы) см. в разделе [UserStore (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/UserStore.cs).

### <a name="identityuserclaim-identityuserlogin-and-identityuserrole"></a>Идентитюсерклаим, Идентитюсерлогин и Идентитюсерроле

Пространство имен Microsoft. AspNet. Identity. EntityFramework содержит реализации классов [идентитюсерклаим](https://msdn.microsoft.com/library/dn613250(v=vs.108).aspx), [идентитюсерлогин](https://msdn.microsoft.com/library/dn613251(v=vs.108).aspx)и [идентитюсерроле](https://msdn.microsoft.com/library/dn613252(v=vs.108).aspx) . При использовании этих функций может потребоваться создать собственные версии этих классов и определить свойства приложения. Однако иногда эффективнее не загружать эти сущности в память при выполнении основных операций (например, при добавлении или удалении утверждения пользователя). Вместо этого классы хранилища серверной части могут выполнять эти операции непосредственно в источнике данных. Например, метод UserStore. Жетклаимсасинк () может вызвать Усерклаимтабле. Финдбюсерид (пользователь. ID) для выполнения запроса к этой таблице напрямую и возврата списка утверждений.

[!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample6.cs)]

<a id="role"></a>
## <a name="customize-the-role-class"></a>Настройка класса Role

При реализации собственного поставщика хранилища необходимо создать класс роли, эквивалентный классу [идентитироле](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityrole(v=vs.108).aspx) в пространстве имен [Microsoft. ASP. NET. Identity. EntityFramework](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework(v=vs.108).aspx) :

На следующей схеме показан класс Идентитироле, который необходимо создать, и интерфейс для реализации в этом классе.

![](overview-of-custom-storage-providers-for-aspnet-identity/_static/image5.png)

Интерфейс [&gt;ироле&lt;TKey](https://msdn.microsoft.com/library/dn613268(v=vs.108).aspx) определяет свойства, которые метод roleManager пытается вызвать при выполнении запрошенных операций. Интерфейс содержит два свойства — ID и Name. Интерфейс [&gt;ироле&lt;TKey](https://msdn.microsoft.com/library/dn613268(v=vs.108).aspx) позволяет указать тип ключа для роли с помощью универсального параметра **TKey** . Тип свойства ID соответствует значению параметра TKey.

Платформа удостоверений также предоставляет интерфейс [ироле](https://msdn.microsoft.com/library/microsoft.aspnet.identity.irole(v=vs.108).aspx) (без универсального параметра), если требуется использовать строковое значение для ключа.

В следующем примере показан класс Идентитироле, который использует целое число для ключа. Поле идентификатора устанавливается в значение int в соответствии со значением универсального параметра. 

[!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample7.cs)]

 Полную реализацию см. в разделе [идентитироле (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/IdentityRole.cs). 

<a id="rolestore"></a>
## <a name="customize-the-role-store"></a>Настройка хранилища ролей

Также создается класс Ролесторе, предоставляющий методы для всех операций с данными в ролях. Этот класс эквивалентен классу [ролесторе&lt;троле&gt;](https://msdn.microsoft.com/library/dn468181(v=vs.108).aspx) в пространстве имен Microsoft. ASP. NET. Identity. EntityFramework. В классе Ролесторе вы реализуете [иролесторе&lt;троле, tkey&gt;](https://msdn.microsoft.com/library/dn613266(v=vs.108).aspx) и, при необходимости, интерфейс [икуеряблеролесторе&lt;троле, TKey&gt;](https://msdn.microsoft.com/library/dn613262(v=vs.108).aspx) .

![](overview-of-custom-storage-providers-for-aspnet-identity/_static/image6.png)

В следующем примере показан класс хранилища ролей. Универсальный параметр троле принимает тип класса роли, который обычно является классом Идентитироле, который вы определили. Универсальный параметр TKey принимает тип ключа роли. 

[!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample8.cs)]

- **Иролесторе&lt;троле&gt;**  
  Интерфейс [иролесторе](https://msdn.microsoft.com/library/dn468195.aspx) определяет методы для реализации в классе хранилища ролей. Он содержит методы для создания, обновления, удаления и извлечения ролей.
- **Ролесторе&lt;троле&gt;**  
  Чтобы настроить Ролесторе, создайте класс, реализующий интерфейс Иролесторе. Этот класс необходимо реализовать только в том случае, если требуется использовать роли в системе. Конструктор, принимающий параметр с именем *Database* типа ексампледатабасе, является только иллюстрацией того, как передать в класс доступа к данным. Например, в реализации MySQL этот конструктор принимает параметр типа Мисклдатабасе.  
  
  Полную реализацию см. в разделе [ролесторе (MySQL)](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/AspNet.Identity.MySQL/RoleStore.cs) .

<a id="reconfigure"></a>
## <a name="reconfigure-application-to-use-new-storage-provider"></a>Перенастроить приложение для использования нового поставщика хранилища

Вы реализовали новый поставщик хранилища. Теперь необходимо настроить приложение для использования этого поставщика хранилища. Если поставщик хранилища по умолчанию был добавлен в проект, необходимо удалить поставщика по умолчанию и заменить его своим поставщиком.

### <a name="replace-default-storage-provider-in-mvc-project"></a>Замена поставщика хранилища по умолчанию в проекте MVC

1. В окне **Управление пакетами NuGet** удалите пакет **Microsoft ASP.NET Identity EntityFramework** . Этот пакет можно найти, выполнив поиск в установленных пакетах для Identity. EntityFramework.  
    ![](overview-of-custom-storage-providers-for-aspnet-identity/_static/image7.png) вам будет предложено также удалить Entity Framework. Если он не нужен в других частях приложения, его можно удалить.
2. В файле IdentityModels.cs в папке Models удалите или закомментируйте классы **аппликатионусер** и **ApplicationDbContext** . В приложении MVC можно удалить весь файл IdentityModels.cs. В приложении веб-форм удалите эти два класса, но убедитесь, что вы сохраняете вспомогательный класс, который также находится в файле IdentityModels.cs.
3. Если поставщик хранилища находится в отдельном проекте, добавьте в веб-приложение ссылку на него.
4. Замените все ссылки на `using Microsoft.AspNet.Identity.EntityFramework;` с помощью оператора using для пространства имен поставщика хранилища.
5. В классе **Startup.auth.CS** измените метод **конфигуреаус** , чтобы он использовал единственный экземпляр соответствующего контекста. 

    [!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample9.cs?highlight=3)]
6. В папке приложения\_Пуск откройте **IdentityConfig.CS**. В классе Аппликатионусерманажер измените метод **CREATE** , чтобы он возвращал Диспетчер пользователей, использующий настроенное хранилище пользователя. 

    [!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample10.cs?highlight=3)]
7. Замените все ссылки на **аппликатионусер** на **идентитюсер**.
8. Проект по умолчанию содержит некоторые члены класса User, которые не определены в интерфейсе IUser. Например, email, PasswordHash и Женератеусеридентитясинк. Если у вашего класса пользователя нет этих членов, необходимо либо реализовать их, либо изменить код, использующий эти члены.
9. Если вы создали какие бы то ни было экземпляры RoleManager, измените этот код для использования нового класса Ролесторе.  

    [!code-csharp[Main](overview-of-custom-storage-providers-for-aspnet-identity/samples/sample11.cs)]
10. Проект по умолчанию предназначен для пользовательского класса, имеющего строковое значение для ключа. Если класс пользователя имеет другой тип ключа (например, целое число), необходимо изменить проект для работы с типом. См. раздел [Изменение первичного ключа для пользователей в ASP.NET Identity](change-primary-key-for-users-in-aspnet-identity.md).
11. При необходимости добавьте строку подключения в файл Web. config.

<a id="other"></a>
## <a name="other-resources"></a>Другие ресурсы

- Блог. [реализация ASP.NET Identity](http://odetocode.com/blogs/scott/archive/2014/01/20/implementing-asp-net-identity.aspx)
- Учебник и код GIT. [простой поставщик удостоверений Data ASP.NET](http://designcoderelease.blogspot.co.uk/2015/03/simpledata-aspnet-identity-provider.html)
- Учебник.[Настройка базовых учетных записей удостоверений и указание их во внешней базе данных](http://typecastexception.com/post/2013/10/27/Configuring-Db-Connection-and-Code-First-Migration-for-Identity-Accounts-in-ASPNET-MVC-5-and-Visual-Studio-2013.aspx). По [@xivSolutions](https://twitter.com/xivSolutions).
- Учебник[. Реализация пользовательского поставщика хранилища ASP.NET Identity MySQL](implementing-a-custom-mysql-aspnet-identity-storage-provider.md)
- [Кодефлуент сущности](http://blog.codefluententities.com/2014/04/30/asp-net-identity-v2-and-codefluent-entities/) по [софтфлуент](http://www.softfluent.com/)
- [Хранилище таблиц Azure](https://www.nuget.org/packages/accidentalfish.aspnet.identity.azure/) по Джеймс Randall.
- Хранилище таблиц Azure: [AspNet. Identity. TableStorage](https://github.com/stuartleeks/leeksnet.AspNet.Identity.TableStorage) по [@stuartleeks](https://twitter.com/stuartleeks).
- [CouchDB или облако с помощью Даниэль Версеим.](https://github.com/danielwertheim/mycouch.aspnet.identity)
- Эластичные ИС[h: эластичные удостоверения](https://github.com/bmbsqd/elastic-identity) с помощью бомбскуад AB.
- [MongoDB](http://www.nuget.org/packages/MongoDB.AspNet.Identity/) by Джонатан шили Джонатан шили.
- [NHibernate. AspNet. Identity](https://github.com/milesibastos/NHibernate.AspNet.Identity) от Антôнио Милеси Бастос.
- [RavenDB](http://www.nuget.org/packages/AspNet.Identity.RavenDB/1.0.0) по [@tourismgeek](https://twitter.com/tourismgeek).
- [RavenDB. AspNet. Identity](https://github.com/ILMServices/RavenDB.AspNet.Identity) by [илмсервицес](http://www.ilmservice.com/).
- Redis: [Redis. AspNet. Identity](https://github.com/aminjam/Redis.AspNet.Identity)
- Шаблоны T4 для создания кода EF для хранилища "база данных — первый" пользовательское хранилище: [AspNet. Identity. EntityFramework](https://github.com/cbfrank/AspNet.Identity.EntityFramework)
