---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: Миграция данных универсального поставщика для членства и профилей пользователей вC#ASP.NET Identity ()-ASP.NET 4. x
author: rustd
description: В этом руководстве описываются шаги, необходимые для переноса данных пользователя и роли и данных профиля пользователя, созданных с помощью универсальные поставщики существующего приложения...
ms.author: riande
ms.date: 12/13/2013
ms.custom: seoapril2019
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 31f02a0cec3c531c45c37b7aad8456e01e80b5ea
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456118"
---
# <a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a><span data-ttu-id="7ac80-103">Перенос данных универсального поставщика членства и профилей пользователей в ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="7ac80-103">Migrating Universal Provider Data for Membership and User Profiles to ASP.NET Identity (C#)</span></span>

<span data-ttu-id="7ac80-104">[получения запись блога](https://github.com/rustd), [Рик Андерсон (](https://twitter.com/RickAndMSFT), [Роберт мкмуррай](https://github.com/rmcmurray), [Сухас Джоши](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="7ac80-104">by [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://twitter.com/RickAndMSFT), [Robert McMurray](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="7ac80-105">В этом руководстве описываются шаги, необходимые для переноса данных пользователя и роли и данных профиля пользователя, созданных с помощью универсальные поставщики существующего приложения в модель ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="7ac80-105">This tutorial describes the steps that are necessary to migrate user and role data and user profile data created using Universal Providers of an existing application to the ASP.NET Identity model.</span></span> <span data-ttu-id="7ac80-106">Подход, упомянутый здесь для переноса данных профиля пользователя, можно также использовать в приложении с членством в SQL.</span><span class="sxs-lookup"><span data-stu-id="7ac80-106">The approach mentioned here to migrate user profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="7ac80-107">В выпуске Visual Studio 2013 в команде ASP.NET появилась новая система ASP.NET Identity, и вы можете прочитать дополнительные сведения [об этом выпуске.](../../index.md)</span><span class="sxs-lookup"><span data-stu-id="7ac80-107">With the release of Visual Studio 2013, the ASP.NET team introduced a new ASP.NET Identity system, and you can read more about that release [here](../../index.md).</span></span> <span data-ttu-id="7ac80-108">В этой статье показано, как перенести веб-приложения из [членства SQL в новую систему идентификации](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), чтобы выполнить миграцию существующих приложений, которые следуют за моделью поставщиков для управления пользователями и ролями, в новую модель удостоверений.</span><span class="sxs-lookup"><span data-stu-id="7ac80-108">Following up on the article to migrate web applications from [SQL Membership to the new Identity system](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), this article illustrates the steps to migrate existing applications that follow the Providers model for user and role management to the new Identity model.</span></span> <span data-ttu-id="7ac80-109">Основное внимание в этом руководстве заключается в том, чтобы перенести данные профиля пользователя, чтобы без проблем привязать их к новой системе.</span><span class="sxs-lookup"><span data-stu-id="7ac80-109">The focus of this tutorial will be primarily on migrating the user profile data to seamlessly hook it into the new system.</span></span> <span data-ttu-id="7ac80-110">Перенос сведений о пользователях и ролях аналогичен членству в SQL.</span><span class="sxs-lookup"><span data-stu-id="7ac80-110">Migrating user and role information is similar for SQL membership.</span></span> <span data-ttu-id="7ac80-111">Подход, который следует выполнить для миграции данных профиля, можно также использовать в приложении с членством в SQL.</span><span class="sxs-lookup"><span data-stu-id="7ac80-111">The approach followed to migrate profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="7ac80-112">В качестве примера мы начнем с веб-приложения, созданного с помощью Visual Studio 2012, использующего модель поставщиков.</span><span class="sxs-lookup"><span data-stu-id="7ac80-112">As an example, we will start with a web app created using Visual Studio 2012 which uses the Providers model.</span></span> <span data-ttu-id="7ac80-113">Затем мы добавим код для управления профилями, зарегистрируем пользователя, добавляем данные профиля для пользователей, перенесите схему базы данных, а затем измените приложение на использование системы удостоверений для управления пользователями и ролями.</span><span class="sxs-lookup"><span data-stu-id="7ac80-113">We'll then add code for profile management, register a user, add profile data for the users, migrate the database schema, and then change the application to use the Identity system for user and role management.</span></span> <span data-ttu-id="7ac80-114">В качестве теста миграции пользователи, созданные с помощью универсальные поставщики, должны иметь возможность войти в систему, а новые пользователи должны иметь возможность зарегистрироваться.</span><span class="sxs-lookup"><span data-stu-id="7ac80-114">As a test of migration, users created using Universal Providers should be able to log in and new users should be able to register.</span></span>

> [!NOTE]
> <span data-ttu-id="7ac80-115">Полный пример можно найти по адресу [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).</span><span class="sxs-lookup"><span data-stu-id="7ac80-115">You can find the complete sample at [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).</span></span>

## <a name="profile-data-migration-summary"></a><span data-ttu-id="7ac80-116">Сводка по переносу данных профиля</span><span class="sxs-lookup"><span data-stu-id="7ac80-116">Profile data migration summary</span></span>

<span data-ttu-id="7ac80-117">Прежде чем начать с миграции, рассмотрим процесс хранения данных профиля в модели поставщиков.</span><span class="sxs-lookup"><span data-stu-id="7ac80-117">Before starting with the migrations, let us look at the experience of storing profile data in the Providers model.</span></span> <span data-ttu-id="7ac80-118">Данные профиля для пользователей приложений могут храниться несколькими способами, наиболее распространенными из них при использовании встроенных поставщиков профилей, поставляемых вместе с универсальные поставщики.</span><span class="sxs-lookup"><span data-stu-id="7ac80-118">Profile data for application users can be stored in multiple ways, the most common among them being using the inbuilt profile providers shipped along with the Universal Providers.</span></span> <span data-ttu-id="7ac80-119">Эти шаги включают</span><span class="sxs-lookup"><span data-stu-id="7ac80-119">The steps would include</span></span>

1. <span data-ttu-id="7ac80-120">Добавьте класс со свойствами, используемыми для хранения данных профиля.</span><span class="sxs-lookup"><span data-stu-id="7ac80-120">Add a class that has properties used to store Profile data.</span></span>
2. <span data-ttu-id="7ac80-121">Добавьте класс, расширяющий "Профилебасе", и реализующий методы, чтобы получить указанные выше данные профиля для пользователя.</span><span class="sxs-lookup"><span data-stu-id="7ac80-121">Add a class that extends 'ProfileBase' and implements methods to get the above profile data for the user.</span></span>
3. <span data-ttu-id="7ac80-122">Включите использование поставщиков профилей по умолчанию в файле *Web. config* и определите класс, объявленный на шаге #2, который будет использоваться для доступа к данным профиля.</span><span class="sxs-lookup"><span data-stu-id="7ac80-122">Enable using default profile providers in the *web.config* file and define the class declared in step #2 to be used in accessing profile information.</span></span>

<span data-ttu-id="7ac80-123">Данные профиля хранятся в виде сериализованных XML-и двоичных данных в таблице Profiles в базе данных.</span><span class="sxs-lookup"><span data-stu-id="7ac80-123">The profile information is stored as serialized xml and binary data in the 'Profiles' table in the database.</span></span>

<span data-ttu-id="7ac80-124">После переноса приложения для использования новой системы ASP.NET Identity данные профиля десериализуется и сохраняются как свойства класса User.</span><span class="sxs-lookup"><span data-stu-id="7ac80-124">After migrating the application to use the new ASP.NET Identity system, the profile information is deserialized and stored as properties on the user class.</span></span> <span data-ttu-id="7ac80-125">Затем каждое свойство может быть сопоставлено со столбцами в пользовательской таблице.</span><span class="sxs-lookup"><span data-stu-id="7ac80-125">Each property can then be mapped onto columns in the user table.</span></span> <span data-ttu-id="7ac80-126">Преимуществом здесь является то, что свойства могут работать непосредственно с помощью класса User, а не выполнять сериализацию и десериализацию данных при каждом обращении к ним.</span><span class="sxs-lookup"><span data-stu-id="7ac80-126">The advantage here is that the properties can be worked on directly using the user class in addition to not having to serialize/deserialize data information each time when accessing it.</span></span>

## <a name="getting-started"></a><span data-ttu-id="7ac80-127">Начало работы</span><span class="sxs-lookup"><span data-stu-id="7ac80-127">Getting Started</span></span>

1. <span data-ttu-id="7ac80-128">Создайте новое приложение веб-форм ASP.NET 4,5 в Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="7ac80-128">Create a new ASP.NET 4.5 Web Forms application in Visual Studio 2012.</span></span> <span data-ttu-id="7ac80-129">В текущем образце используется шаблон веб-форм, но можно также использовать приложение MVC.</span><span class="sxs-lookup"><span data-stu-id="7ac80-129">The current sample uses the Web Forms template, but you could use MVC Application as well.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="7ac80-130">Создать новую папку "Models" для хранения сведений о профиле</span><span class="sxs-lookup"><span data-stu-id="7ac80-130">Create a new folder 'Models' to store profile information</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. <span data-ttu-id="7ac80-131">В качестве примера мы будем хранить дату рождения, город, высоту и вес пользователя в профиле.</span><span class="sxs-lookup"><span data-stu-id="7ac80-131">As an example, let us store the date of birth, city, height and weight of the user in profile.</span></span> <span data-ttu-id="7ac80-132">Высота и вес хранятся в виде пользовательского класса с именем "Персоналстатс".</span><span class="sxs-lookup"><span data-stu-id="7ac80-132">The height and weight are stored as a custom class called 'PersonalStats'.</span></span> <span data-ttu-id="7ac80-133">Для хранения и извлечения профиля необходим класс, расширяющий "Профилебасе".</span><span class="sxs-lookup"><span data-stu-id="7ac80-133">To store and retrieve the profile, we need a class that extends 'ProfileBase'.</span></span> <span data-ttu-id="7ac80-134">Давайте создадим новый класс "Апппрофиле" для получения и хранения сведений о профиле.</span><span class="sxs-lookup"><span data-stu-id="7ac80-134">Let's create a new class 'AppProfile' to get and store profile information.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. <span data-ttu-id="7ac80-135">Включите профиль в файле *Web. config* .</span><span class="sxs-lookup"><span data-stu-id="7ac80-135">Enable profile in the *web.config* file.</span></span> <span data-ttu-id="7ac80-136">Введите имя класса, которое будет использоваться для хранения или извлечения сведений о пользователе, созданных на шаге #3.</span><span class="sxs-lookup"><span data-stu-id="7ac80-136">Enter the class name to be used to store/retrieve user information created in step #3.</span></span>

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. <span data-ttu-id="7ac80-137">Добавьте страницу веб-форм в папку Account, чтобы получить данные профиля от пользователя и сохранить их.</span><span class="sxs-lookup"><span data-stu-id="7ac80-137">Add a web forms page in 'Account' folder to get the profile data from the user and store it.</span></span> <span data-ttu-id="7ac80-138">Щелкните правой кнопкой мыши проект и выберите команду "добавить новый элемент".</span><span class="sxs-lookup"><span data-stu-id="7ac80-138">Right click on project and select 'Add new Item'.</span></span> <span data-ttu-id="7ac80-139">Добавить новую страницу веб-форм с главной страницей "Аддпрофиледата. aspx".</span><span class="sxs-lookup"><span data-stu-id="7ac80-139">Add a new webforms page with master page 'AddProfileData.aspx'.</span></span> <span data-ttu-id="7ac80-140">Скопируйте следующий фрагмент в раздел "MainContent":</span><span class="sxs-lookup"><span data-stu-id="7ac80-140">Copy the following in the 'MainContent' section:</span></span>

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   <span data-ttu-id="7ac80-141">Добавьте следующий код в код программной части:</span><span class="sxs-lookup"><span data-stu-id="7ac80-141">Add the following code in the code behind:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   <span data-ttu-id="7ac80-142">Добавьте пространство имен, в котором определен класс Апппрофиле для удаления ошибок компиляции.</span><span class="sxs-lookup"><span data-stu-id="7ac80-142">Add the namespace under which AppProfile class is defined to remove the compilation errors.</span></span>
6. <span data-ttu-id="7ac80-143">Запустите приложение и создайте нового пользователя с именем пользователя "**olduser".**</span><span class="sxs-lookup"><span data-stu-id="7ac80-143">Run the app and create a new user with username '**olduser'.**</span></span> <span data-ttu-id="7ac80-144">Перейдите на страницу "Аддпрофиледата" и добавьте сведения о профиле для пользователя.</span><span class="sxs-lookup"><span data-stu-id="7ac80-144">Navigate to the 'AddProfileData' page and add profile information for the user.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

<span data-ttu-id="7ac80-145">Вы можете убедиться, что данные хранятся в виде сериализованного XML в таблице Profiles, используя окно обозреватель сервера.</span><span class="sxs-lookup"><span data-stu-id="7ac80-145">You can verify that the data is stored as serialized xml in the 'Profiles' table using the Server Explorer window.</span></span> <span data-ttu-id="7ac80-146">В Visual Studio в меню "вид" выберите "обозреватель сервера".</span><span class="sxs-lookup"><span data-stu-id="7ac80-146">In Visual Studio, from 'View' menu, choose 'Server Explorer'.</span></span> <span data-ttu-id="7ac80-147">Для базы данных, определенной в файле *Web. config* , должно быть подключение к данным.</span><span class="sxs-lookup"><span data-stu-id="7ac80-147">There should be a data connection for the database defined in the *web.config* file.</span></span> <span data-ttu-id="7ac80-148">При выборе подключения к данным отображаются разные подкатегории.</span><span class="sxs-lookup"><span data-stu-id="7ac80-148">Clicking on the data connection shows different sub categories.</span></span> <span data-ttu-id="7ac80-149">Разверните "таблицы", чтобы отобразить различные таблицы в базе данных, щелкните правой кнопкой мыши "Профили" и выберите "Показать данные таблицы", чтобы просмотреть данные профиля, хранящиеся в таблице профилей.</span><span class="sxs-lookup"><span data-stu-id="7ac80-149">Expand 'Tables' to show the different tables in your database, then right click on 'Profiles' and choose 'Show Table Data' to view the profile data stored in the Profiles table.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a><span data-ttu-id="7ac80-150">Миграция схемы базы данных</span><span class="sxs-lookup"><span data-stu-id="7ac80-150">Migrating database schema</span></span>

<span data-ttu-id="7ac80-151">Чтобы обеспечить работу существующей базы данных с системой идентификации, необходимо обновить схему в базе данных удостоверений для поддержки полей, добавленных в исходную базу данных.</span><span class="sxs-lookup"><span data-stu-id="7ac80-151">To make the existing database work with the Identity system, we need to update the schema in the Identity database to support the fields we added to the original database.</span></span> <span data-ttu-id="7ac80-152">Это можно сделать с помощью скриптов SQL для создания новых таблиц и копирования существующих данных.</span><span class="sxs-lookup"><span data-stu-id="7ac80-152">This can be done using SQL scripts to create new tables and copy the existing information.</span></span> <span data-ttu-id="7ac80-153">В окне "обозреватель сервера" разверните элемент "DefaultConnection", чтобы отобразить таблицы.</span><span class="sxs-lookup"><span data-stu-id="7ac80-153">In the 'Server Explorer' window, expand the 'DefaultConnection' to display the tables.</span></span> <span data-ttu-id="7ac80-154">Щелкните правой кнопкой мыши таблицы и выберите команду "создать запрос".</span><span class="sxs-lookup"><span data-stu-id="7ac80-154">Right click Tables and select 'New Query'</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

<span data-ttu-id="7ac80-155">Вставьте скрипт SQL из [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) и запустите его.</span><span class="sxs-lookup"><span data-stu-id="7ac80-155">Paste the SQL script from [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) and run it.</span></span> <span data-ttu-id="7ac80-156">При обновлении "DefaultConnection" можно увидеть, что новые таблицы добавлены.</span><span class="sxs-lookup"><span data-stu-id="7ac80-156">If the 'DefaultConnection' is refreshed, we can see that the new tables are added.</span></span> <span data-ttu-id="7ac80-157">Можно проверить данные в таблицах, чтобы убедиться, что данные были перенесены.</span><span class="sxs-lookup"><span data-stu-id="7ac80-157">You can check the data inside the tables to see that the information has been migrated.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a><span data-ttu-id="7ac80-158">Перенос приложения для использования ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="7ac80-158">Migrating the application to use ASP.NET Identity</span></span>

1. <span data-ttu-id="7ac80-159">Установите пакеты NuGet, необходимые для ASP.NET Identity:</span><span class="sxs-lookup"><span data-stu-id="7ac80-159">Install the Nuget packages needed for ASP.NET Identity:</span></span>

    - <span data-ttu-id="7ac80-160">Microsoft.AspNet.Identity.EntityFramework</span><span class="sxs-lookup"><span data-stu-id="7ac80-160">Microsoft.AspNet.Identity.EntityFramework</span></span>
    - <span data-ttu-id="7ac80-161">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="7ac80-161">Microsoft.AspNet.Identity.Owin</span></span>
    - <span data-ttu-id="7ac80-162">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="7ac80-162">Microsoft.Owin.Host.SystemWeb</span></span>
    - <span data-ttu-id="7ac80-163">Microsoft. Owin. Security. Facebook</span><span class="sxs-lookup"><span data-stu-id="7ac80-163">Microsoft.Owin.Security.Facebook</span></span>
    - <span data-ttu-id="7ac80-164">Microsoft. Owin. Security. Google</span><span class="sxs-lookup"><span data-stu-id="7ac80-164">Microsoft.Owin.Security.Google</span></span>
    - <span data-ttu-id="7ac80-165">Microsoft. Owin. Security. MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="7ac80-165">Microsoft.Owin.Security.MicrosoftAccount</span></span>
    - <span data-ttu-id="7ac80-166">Microsoft. Owin. Security. Twitter</span><span class="sxs-lookup"><span data-stu-id="7ac80-166">Microsoft.Owin.Security.Twitter</span></span>

   <span data-ttu-id="7ac80-167">Дополнительные сведения об управлении пакетами NuGet можно найти [здесь](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog) .</span><span class="sxs-lookup"><span data-stu-id="7ac80-167">More information on managing Nuget packages can be found [here](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span></span>
2. <span data-ttu-id="7ac80-168">Для работы с существующими данными в таблице необходимо создать классы модели, которые сопоставляются с таблицами и присоединить их к системе идентификации.</span><span class="sxs-lookup"><span data-stu-id="7ac80-168">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="7ac80-169">В рамках контракта идентификации классы модели должны реализовывать интерфейсы, определенные в DLL Identity. Core, или расширять существующие реализации этих интерфейсов, доступных в Microsoft. AspNet. Identity. EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="7ac80-169">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span> <span data-ttu-id="7ac80-170">Мы будем использовать существующие классы для ролей, имен входа пользователей и утверждений пользователей.</span><span class="sxs-lookup"><span data-stu-id="7ac80-170">We will be using the existing classes for role, user logins and user claims.</span></span> <span data-ttu-id="7ac80-171">Для нашего примера необходимо использовать настраиваемого пользователя.</span><span class="sxs-lookup"><span data-stu-id="7ac80-171">We need to use a custom user for our sample.</span></span> <span data-ttu-id="7ac80-172">Щелкните проект правой кнопкой мыши и создайте новую папку "Идентитимоделс".</span><span class="sxs-lookup"><span data-stu-id="7ac80-172">Right click on the project and create new folder 'IdentityModels'.</span></span> <span data-ttu-id="7ac80-173">Добавьте новый класс User, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="7ac80-173">Add a new 'User' class as shown below:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   <span data-ttu-id="7ac80-174">Обратите внимание, что "fileInfo" теперь является свойством в классе пользователя.</span><span class="sxs-lookup"><span data-stu-id="7ac80-174">Notice that the 'ProfileInfo' is now a property on the user class.</span></span> <span data-ttu-id="7ac80-175">Поэтому мы можем использовать класс User для непосредственной работы с данными профилирования.</span><span class="sxs-lookup"><span data-stu-id="7ac80-175">Hence we can use the user class to directly work with profile data.</span></span>

<span data-ttu-id="7ac80-176">Скопируйте файлы из папок **идентитимоделс** и **идентитяккаунт** из источника загрузки ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ).</span><span class="sxs-lookup"><span data-stu-id="7ac80-176">Copy the files in the **IdentityModels** and **IdentityAccount** folders from the download source ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ).</span></span> <span data-ttu-id="7ac80-177">Они содержат оставшиеся классы моделей и новые страницы, необходимые для управления пользователями и ролями с помощью API-интерфейсов ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="7ac80-177">These have the remaining model classes and the new pages needed for user and role management using the ASP.NET Identity APIs.</span></span> <span data-ttu-id="7ac80-178">Используемый подход похож на членство в SQL и подробное описание можно найти [здесь](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).</span><span class="sxs-lookup"><span data-stu-id="7ac80-178">The approach used is similar to the SQL Membership and the detailed explanation can be found [here](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

## <a name="copying-profile-data-to-the-new-tables"></a><span data-ttu-id="7ac80-179">Копирование данных профиля в новые таблицы</span><span class="sxs-lookup"><span data-stu-id="7ac80-179">Copying Profile data to the new tables</span></span>

<span data-ttu-id="7ac80-180">Как упоминалось ранее, необходимо десериализовать XML-данные в таблицах профилей и сохранить их в столбцах таблицы AspNetUsers.</span><span class="sxs-lookup"><span data-stu-id="7ac80-180">As mentioned earlier, we need to deserialize the xml data in the Profiles tables and store it in the columns of the AspNetUsers table.</span></span> <span data-ttu-id="7ac80-181">Новые столбцы были созданы в таблице Users на предыдущем шаге, поэтому все, что осталось, — заполнить эти столбцы необходимыми данными.</span><span class="sxs-lookup"><span data-stu-id="7ac80-181">The new columns were created in the users table in the previous step so all that is left is to populate those columns with the necessary data.</span></span> <span data-ttu-id="7ac80-182">Для этого мы будем использовать консольное приложение, которое запускается один раз для заполнения только что созданных столбцов в таблице Users.</span><span class="sxs-lookup"><span data-stu-id="7ac80-182">To do this, we will use a console application which is run once to populate the newly created columns in the users table.</span></span>

1. <span data-ttu-id="7ac80-183">Создайте новое консольное приложение в выходном решении.</span><span class="sxs-lookup"><span data-stu-id="7ac80-183">Create a new console application in the exiting solution.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. <span data-ttu-id="7ac80-184">Установите последнюю версию пакета Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="7ac80-184">Install the latest version of the Entity Framework package.</span></span>
3. <span data-ttu-id="7ac80-185">Добавьте веб-приложение, созданное выше, в качестве ссылки на консольное приложение.</span><span class="sxs-lookup"><span data-stu-id="7ac80-185">Add the web application created above as a reference to the console application.</span></span> <span data-ttu-id="7ac80-186">Для этого щелкните правой кнопкой мыши проект, затем "добавить ссылки", выберите решение, затем щелкните проект и нажмите кнопку ОК.</span><span class="sxs-lookup"><span data-stu-id="7ac80-186">To do this right click on Project, then 'Add References', then Solution, then click on the project and click OK.</span></span>
4. <span data-ttu-id="7ac80-187">Скопируйте приведенный ниже код в класс Program.cs.</span><span class="sxs-lookup"><span data-stu-id="7ac80-187">Copy the below code in the Program.cs class.</span></span> <span data-ttu-id="7ac80-188">Эта логика считывает данные профиля для каждого пользователя, сериализует ее как объект "fileInfo" и сохраняет ее обратно в базу данных.</span><span class="sxs-lookup"><span data-stu-id="7ac80-188">This logic reads profile data for each user, serializes it as 'ProfileInfo' object and stores it back to the database.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   <span data-ttu-id="7ac80-189">Некоторые используемые модели определяются в папке "Идентитимоделс" проекта веб-приложения, поэтому необходимо включить соответствующие пространства имен.</span><span class="sxs-lookup"><span data-stu-id="7ac80-189">Some of the models used are defined in the 'IdentityModels' folder of the web application project, so you must include the corresponding namespaces.</span></span>
5. <span data-ttu-id="7ac80-190">Приведенный выше код работает с файлом базы данных в папке App\_Data проекта веб-приложения, созданного на предыдущих шагах.</span><span class="sxs-lookup"><span data-stu-id="7ac80-190">The above code works on the database file in the App\_Data folder of the web application project created in the previous steps.</span></span> <span data-ttu-id="7ac80-191">Чтобы сослаться на эту ссылку, обновите строку подключения в файле App. config консольного приложения с помощью строки подключения из файла Web. config веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="7ac80-191">To reference that, update the connection string in the app.config file of the console application with the connection string in the web.config of the web application.</span></span> <span data-ttu-id="7ac80-192">Также укажите полный физический путь в свойстве "AttachDbFilename".</span><span class="sxs-lookup"><span data-stu-id="7ac80-192">Also provide the complete physical path in the 'AttachDbFilename' property.</span></span>
6. <span data-ttu-id="7ac80-193">Откройте командную строку и перейдите в папку bin приведенного выше консольного приложения.</span><span class="sxs-lookup"><span data-stu-id="7ac80-193">Open a command prompt and navigate to the bin folder of the above console application.</span></span> <span data-ttu-id="7ac80-194">Запустите исполняемый файл и проверьте выходные данные журнала, как показано на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="7ac80-194">Run the executable and review the log output as shown in the following image.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. <span data-ttu-id="7ac80-195">Откройте таблицу "AspNetUsers" в обозреватель сервера и проверьте данные в новых столбцах, в которых хранятся свойства.</span><span class="sxs-lookup"><span data-stu-id="7ac80-195">Open the 'AspNetUsers' table in the Server Explorer and verify the data in the new columns that hold the properties.</span></span> <span data-ttu-id="7ac80-196">Они должны быть обновлены с учетом соответствующих значений свойств.</span><span class="sxs-lookup"><span data-stu-id="7ac80-196">They should be updated with the corresponding property values.</span></span>

## <a name="verify-functionality"></a><span data-ttu-id="7ac80-197">Проверка функциональности</span><span class="sxs-lookup"><span data-stu-id="7ac80-197">Verify functionality</span></span>

<span data-ttu-id="7ac80-198">Используйте только что добавленные страницы членства, реализованные с помощью ASP.NET Identity, для входа пользователя из старой базы данных.</span><span class="sxs-lookup"><span data-stu-id="7ac80-198">Use the newly added membership pages that are implemented using ASP.NET Identity to login a user from the old database.</span></span> <span data-ttu-id="7ac80-199">Пользователь должен иметь возможность войти в систему, используя те же учетные данные.</span><span class="sxs-lookup"><span data-stu-id="7ac80-199">The user should be able to log in using the same credentials.</span></span> <span data-ttu-id="7ac80-200">Попробуйте другие функции, такие как добавление OAuth, создание нового пользователя, изменение пароля, Добавление ролей, Добавление пользователей в роли и т. д.</span><span class="sxs-lookup"><span data-stu-id="7ac80-200">Try the other functionalities like adding OAuth, creating a new user, changing a password, adding roles, add users to roles, etc.</span></span>

<span data-ttu-id="7ac80-201">Данные профиля для старого пользователя и новых пользователей должны быть извлечены и сохранены в таблице Users.</span><span class="sxs-lookup"><span data-stu-id="7ac80-201">The Profile data for the old user and the new users should be retrieved and stored in the users table.</span></span> <span data-ttu-id="7ac80-202">На старую таблицу больше нельзя ссылаться.</span><span class="sxs-lookup"><span data-stu-id="7ac80-202">The old table should no longer be referenced.</span></span>

## <a name="conclusion"></a><span data-ttu-id="7ac80-203">Заключение</span><span class="sxs-lookup"><span data-stu-id="7ac80-203">Conclusion</span></span>

<span data-ttu-id="7ac80-204">В статье описывается процесс миграции веб-приложений, которые используют модель поставщика, для членства в ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="7ac80-204">The article described the process of migrating web applications that used the provider model for membership to ASP.NET Identity.</span></span> <span data-ttu-id="7ac80-205">В статье дополнительно описан перенос данных профиля для пользователей, которые должны быть подключены к системе идентификации.</span><span class="sxs-lookup"><span data-stu-id="7ac80-205">The article additionally outlined migrating profile data for users to be hooked into the Identity system.</span></span> <span data-ttu-id="7ac80-206">Оставьте комментарии ниже для вопросов и проблем, возникших при миграции приложения.</span><span class="sxs-lookup"><span data-stu-id="7ac80-206">Please leave comments below for questions and issues encountered when you migrate your app.</span></span>

<span data-ttu-id="7ac80-207">*Благодаря Рик Андерсон (и Роберт Мкмуррай для ознакомления с этой статьей.*</span><span class="sxs-lookup"><span data-stu-id="7ac80-207">*Thanks to Rick Anderson and Robert McMurray for reviewing the article.*</span></span>
