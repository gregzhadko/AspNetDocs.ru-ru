---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: Перенос данных универсального поставщика членства и профилей пользователей в ASP.NET Identity (C#)-ASP.NET 4.x
author: rustd
description: Этот учебник описывает шаги, необходимые для миграции пользователей и роли данных и данные профиля пользователя, созданных с помощью универсальные поставщики существующего приложения...
ms.author: riande
ms.date: 12/13/2013
ms.custom: seoapril2019
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 1043dce4cdd62f94ae9d2344a9301c1b03426f3d
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59422269"
---
# <a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a>Перенос данных универсального поставщика членства и профилей пользователей в ASP.NET Identity (C#)

по [Пранавом Растоги](https://github.com/rustd), [Рик Андерсон]((https://twitter.com/RickAndMSFT)), [(Robert McMurray)](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)

> Этом руководстве описаны шаги, необходимые для переноса пользователей и роли данных и данные профиля пользователя, созданных с помощью универсальные поставщики существующего приложения модель удостоверений ASP.NET. Этот подход упомянутые здесь, можно использовать для переноса данных профиля пользователя в приложение с помощью членства SQL также.


С выпуском Visual Studio 2013, группа разработчиков ASP.NET представлены новую систему ASP.NET Identity и Дополнительные сведения об этом выпуске [здесь](../../index.md). Вслед за статью, чтобы перенести веб-приложений от [членства SQL в новую систему удостоверений](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), в этой статье показана последовательность действий для миграции существующих приложений, которые следуют модели поставщиков для Управление пользователями и ролями в новую модель удостоверений. Цель этого учебника будет главным образом на переноса данных профиля пользователя в легко подключить его в новой системе. Миграция сведений о пользователях и роли аналогичен и для членства SQL. В приложение с помощью членства SQL также можно использовать подход, выполнить при переносе данных профиля.

Например мы начнем с веб-приложения, созданные с помощью Visual Studio 2012, которая использует модель поставщиков. Мы будем затем добавьте код для управления профилями, регистрации пользователя, добавить данные профиля для пользователей, перенос схемы базы данных и затем изменить приложение, чтобы использовать систему удостоверений Управление пользователями и ролями. Для проверки переноса пользователи, созданных с помощью универсальные поставщики должны иметь возможность входа в систему, и новые пользователи должны иметь возможность регистрации.

> [!NOTE]
> Вы найдете полный пример в [ https://github.com/suhasj/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations).


## <a name="profile-data-migration-summary"></a>Сводка по миграции данных профиля

Прежде чем начать с миграцией, давайте рассмотрим возможности хранения данных профиля в модели поставщиков. Данные профилирования для приложения, которые пользователи могут храниться несколькими способами, наиболее распространенные из них с помощью поставщиков встроенных профилей, поставляемых вместе с универсальные поставщики. Включает действия

1. Добавьте класс, который имеет свойства, используемого для хранения данных профилирования.
2. Добавьте класс, который расширяет «ProfileBase» и реализует методы, чтобы получить указанные выше данные профиля пользователя.
3. Включить с помощью поставщиков профилей по умолчанию в *web.config* файл и определить класс, объявленный на шаге 2 # для использования в доступ к сведениям профиля.

Сведения о профиле хранится в виде сериализованного xml и двоичные данные в таблице «Профили» в базе данных.

После миграции приложения, чтобы использовать новую систему ASP.NET Identity, сведения о профиле десериализуется и хранятся в виде свойства класса пользователя. Затем можно сопоставить каждое свойство на столбцы в таблице пользователя. Преимущество в том, что свойств можно было работать непосредственно с помощью класса пользователя в дополнение к отсутствию для сериализации или десериализации данных каждый раз при доступе к его.

## <a name="getting-started"></a>Начало работы

1. Создайте новое приложение веб-форм ASP.NET 4.5 в Visual Studio 2012. Текущий образец использует шаблон веб-форм, но можно также использовать приложения MVC.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. Создайте новую папку «Модели» для хранения сведений профиля  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. Например сообщите нам храните даты рождения "," Город "," Высота "и" вес пользователя в профиле. Высоты и ширины, хранятся как пользовательский класс с именем «PersonalStats». Для хранения и извлечения профиля, нам нужен класс, который расширяет «ProfileBase». Давайте создадим новый класс «AppProfile» для получения и хранения сведений профиля.

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. Включить профиль в *web.config* файл. Введите имя класса, который будет использоваться для хранения или извлечения сведения о пользователе, созданный на шаге #3.

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. Добавьте страницу web forms, в папке «Учетная запись», чтобы получить данные профиля пользователя и сохранить их. Щелкните правой кнопкой проект и выберите «Добавить новый элемент». Добавьте новую страницу веб-форм с главной страницей «AddProfileData.aspx». Скопируйте следующий код в разделе «MainContent»:

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   Добавьте следующий код в коде программной части:

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   Добавьте пространство имен, в какие AppProfile определен класс, чтобы удалить ошибки компиляции.
6. Запустите приложение и создать нового пользователя с именем пользователя "**olduser".** Перейдите на страницу «AddProfileData» и добавьте сведения о профиле пользователя.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

Вы можете проверить, что данные хранятся в качестве сериализованный xml в таблице «Профили» в окне обозревателя серверов. В Visual Studio в меню «Вид» выберите «Обозреватель серверов». Должно быть подключение данных для базы данных, определенных в *web.config* файл. Если щелкнуть соединение с данными отобразится другой подкатегории. Разверните узел «Таблицы» для отображения разных таблиц в базе данных, а затем щелкнуть правой кнопкой мыши «Профили» и выберите «Показать таблицу данных» для просмотра профиля данных, хранящихся в таблице профилей.

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a>Перенос схемы базы данных

Чтобы работать с системой идентификации существующей базы данных, необходимо обновить схему базы данных удостоверений для поддержки поля, которые мы добавили в исходной базе данных. Это можно сделать с помощью скриптов SQL для создания новых таблиц и Копировать сведения о существующем. В окне «Обозреватель серверов» разверните узел «DefaultConnection» для отображения таблиц. Таблицы щелкните правой кнопкой мыши и выберите «Создать запрос»

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

Вставьте скрипт SQL из [ https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt ](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) и запустите его. Если обновляется «DefaultConnection», мы видим, что добавляются новые таблицы. Вы можете проверить данные внутри таблицы, чтобы увидеть, что данные были перенесены.

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a>Миграция приложения для использования ASP.NET Identity

1. Установите пакеты Nuget, необходимые для ASP.NET Identity:

    - Microsoft.AspNet.Identity.EntityFramework
    - Microsoft.AspNet.Identity.Owin
    - Microsoft.Owin.Host.SystemWeb
    - Microsoft.Owin.Security.Facebook
    - Microsoft.Owin.Security.Google
    - Microsoft.Owin.Security.MicrosoftAccount
    - Microsoft.Owin.Security.Twitter

   Дополнительные сведения об управлении пакетами Nuget можно найти [здесь](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)
2. Для работы с существующими данными в таблице, необходимо создать классы моделей, которые сопоставляются с таблицами и подключить их в системы удостоверений. Как часть контракта удостоверений классы модели должен реализовывать интерфейсы, определенные в библиотеке dll Identity.Core или можно расширить существующую реализацию этих интерфейсов, доступных в Microsoft.AspNet.Identity.EntityFramework. Мы будем использовать существующие классы для роли, имена входа и утверждения пользователей. Нам нужно использовать настраиваемого пользователя для нашего примера. Щелкните правой кнопкой проект и создать новую папку «IdentityModels». Добавьте новый класс «User», как показано ниже:

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   Обратите внимание на то, что «ProfileInfo» теперь является свойством класса пользователя. Поэтому мы используем класс пользователя напрямую работать с данными профиля.

Скопируйте файлы в **IdentityModels** и **IdentityAccount** папок из источника загрузки ( [ https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ). Они имеют, в остальных классах модели и новые страницы, необходимые для пользователей и управление ролями с помощью API-интерфейсов ASP.NET Identity. Этот подход используется аналогичен членства SQL и подробное описание можно найти [здесь](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

## <a name="copying-profile-data-to-the-new-tables"></a>Копирование данных профиля в новые таблицы

Как упоминалось ранее, необходимо десериализовать XML-данные в таблицах профили и сохранять их в столбцы в таблице AspNetUsers. Новые столбцы были созданы в таблице users на предыдущем шаге, остается лишь для заполнения этих столбцов с данными, необходимыми. Чтобы сделать это, мы будем использовать консольное приложение, которое запускается один раз для заполнения только что созданные столбцы в таблице users.

1. Создайте новое консольное приложение в существующие решения.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. Установите последнюю версию пакета Entity Framework.
3. Добавьте веб-приложения, созданный ранее, как ссылка на консольное приложение. Для выполнения щелкните правой кнопкой мыши проект, а затем «Добавление ссылок», выберите решение, затем щелкните кнопкой мыши проект и нажмите кнопку ОК.
4. Скопируйте код ниже в класс Program.cs. Эта логика считывает данные профиля для каждого пользователя, сериализует его как объект «ProfileInfo» и сохраняет его в базе данных.

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   Некоторые используемые модели определяются в папке «IdentityModels» проекта веб-приложения, поэтому необходимо включить соответствующие пространства имен.
5. Приведенный выше код работает с файлом базы данных в приложении\_папке данных проекта веб-приложения, созданные на предыдущих шагах. Для ссылки, обновите строку подключения в файле app.config консольного приложения, в строке подключения в файле web.config веб-приложения. Также предоставляют полный физический путь в свойстве «AttachDbFilename».
6. Откройте командную строку и перейдите к папке bin выше консольного приложения. Запустите исполняемый файл и просмотрите выходные данные журнала, как показано на следующем рисунке.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. Откройте таблицу «AspNetUsers» в обозревателе серверов и проверки правильности данных в новые столбцы, которые содержат свойства. Их следует обновить с помощью соответствующих значений свойств.

## <a name="verify-functionality"></a>Проверка работоспособности

Используйте страницы вновь добавленный членства, которые реализуются с помощью ASP.NET Identity для входа в систему пользователя из старой базы данных. Он должен иметь возможности использовать те же учетные данные для входа. Попробуйте другие функциональные возможности, как добавление OAuth, создание нового пользователя, изменения пароля, Добавление ролей, добавьте пользователей в роли и т. д.

Данные профиля пользователя старых и новых пользователей должны быть получены и хранятся в таблице users. Старой таблицы больше не должна быть ссылка.

## <a name="conclusion"></a>Заключение

Статьи описывается процесс переноса веб-приложений, которые используются модели поставщика для членства в ASP.NET Identity. Кроме того, статьи описанные перенос данных профиля для пользователей связать системы удостоверений. Оставьте комментарии ниже для вопросов и проблем, возникающих при миграции приложения.

*Благодаря Рик Андерсон и (Robert McMurray) за рецензирование статьи.*
