---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: Миграция данных универсального поставщика для членства и профилей пользователей вC#ASP.NET Identity ()-ASP.NET 4. x
author: rustd
description: В этом руководстве описываются шаги, необходимые для переноса данных пользователя и роли и данных профиля пользователя, созданных с помощью универсальные поставщики существующего приложения...
ms.author: riande
ms.date: 12/13/2013
ms.custom: seoapril2019
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 31f02a0cec3c531c45c37b7aad8456e01e80b5ea
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456118"
---
# <a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a>Перенос данных универсального поставщика членства и профилей пользователей в ASP.NET Identity (C#)

[получения запись блога](https://github.com/rustd), [Рик Андерсон (](https://twitter.com/RickAndMSFT), [Роберт мкмуррай](https://github.com/rmcmurray), [Сухас Джоши](https://github.com/suhasj)

> В этом руководстве описываются шаги, необходимые для переноса данных пользователя и роли и данных профиля пользователя, созданных с помощью универсальные поставщики существующего приложения в модель ASP.NET Identity. Подход, упомянутый здесь для переноса данных профиля пользователя, можно также использовать в приложении с членством в SQL.

В выпуске Visual Studio 2013 в команде ASP.NET появилась новая система ASP.NET Identity, и вы можете прочитать дополнительные сведения [об этом выпуске.](../../index.md) В этой статье показано, как перенести веб-приложения из [членства SQL в новую систему идентификации](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), чтобы выполнить миграцию существующих приложений, которые следуют за моделью поставщиков для управления пользователями и ролями, в новую модель удостоверений. Основное внимание в этом руководстве заключается в том, чтобы перенести данные профиля пользователя, чтобы без проблем привязать их к новой системе. Перенос сведений о пользователях и ролях аналогичен членству в SQL. Подход, который следует выполнить для миграции данных профиля, можно также использовать в приложении с членством в SQL.

В качестве примера мы начнем с веб-приложения, созданного с помощью Visual Studio 2012, использующего модель поставщиков. Затем мы добавим код для управления профилями, зарегистрируем пользователя, добавляем данные профиля для пользователей, перенесите схему базы данных, а затем измените приложение на использование системы удостоверений для управления пользователями и ролями. В качестве теста миграции пользователи, созданные с помощью универсальные поставщики, должны иметь возможность войти в систему, а новые пользователи должны иметь возможность зарегистрироваться.

> [!NOTE]
> Полный пример можно найти по адресу [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).

## <a name="profile-data-migration-summary"></a>Сводка по переносу данных профиля

Прежде чем начать с миграции, рассмотрим процесс хранения данных профиля в модели поставщиков. Данные профиля для пользователей приложений могут храниться несколькими способами, наиболее распространенными из них при использовании встроенных поставщиков профилей, поставляемых вместе с универсальные поставщики. Эти шаги включают

1. Добавьте класс со свойствами, используемыми для хранения данных профиля.
2. Добавьте класс, расширяющий "Профилебасе", и реализующий методы, чтобы получить указанные выше данные профиля для пользователя.
3. Включите использование поставщиков профилей по умолчанию в файле *Web. config* и определите класс, объявленный на шаге #2, который будет использоваться для доступа к данным профиля.

Данные профиля хранятся в виде сериализованных XML-и двоичных данных в таблице Profiles в базе данных.

После переноса приложения для использования новой системы ASP.NET Identity данные профиля десериализуется и сохраняются как свойства класса User. Затем каждое свойство может быть сопоставлено со столбцами в пользовательской таблице. Преимуществом здесь является то, что свойства могут работать непосредственно с помощью класса User, а не выполнять сериализацию и десериализацию данных при каждом обращении к ним.

## <a name="getting-started"></a>Начало работы

1. Создайте новое приложение веб-форм ASP.NET 4,5 в Visual Studio 2012. В текущем образце используется шаблон веб-форм, но можно также использовать приложение MVC.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. Создать новую папку "Models" для хранения сведений о профиле  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. В качестве примера мы будем хранить дату рождения, город, высоту и вес пользователя в профиле. Высота и вес хранятся в виде пользовательского класса с именем "Персоналстатс". Для хранения и извлечения профиля необходим класс, расширяющий "Профилебасе". Давайте создадим новый класс "Апппрофиле" для получения и хранения сведений о профиле.

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. Включите профиль в файле *Web. config* . Введите имя класса, которое будет использоваться для хранения или извлечения сведений о пользователе, созданных на шаге #3.

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. Добавьте страницу веб-форм в папку Account, чтобы получить данные профиля от пользователя и сохранить их. Щелкните правой кнопкой мыши проект и выберите команду "добавить новый элемент". Добавить новую страницу веб-форм с главной страницей "Аддпрофиледата. aspx". Скопируйте следующий фрагмент в раздел "MainContent":

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   Добавьте следующий код в код программной части:

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   Добавьте пространство имен, в котором определен класс Апппрофиле для удаления ошибок компиляции.
6. Запустите приложение и создайте нового пользователя с именем пользователя "**olduser".** Перейдите на страницу "Аддпрофиледата" и добавьте сведения о профиле для пользователя.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

Вы можете убедиться, что данные хранятся в виде сериализованного XML в таблице Profiles, используя окно обозреватель сервера. В Visual Studio в меню "вид" выберите "обозреватель сервера". Для базы данных, определенной в файле *Web. config* , должно быть подключение к данным. При выборе подключения к данным отображаются разные подкатегории. Разверните "таблицы", чтобы отобразить различные таблицы в базе данных, щелкните правой кнопкой мыши "Профили" и выберите "Показать данные таблицы", чтобы просмотреть данные профиля, хранящиеся в таблице профилей.

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a>Миграция схемы базы данных

Чтобы обеспечить работу существующей базы данных с системой идентификации, необходимо обновить схему в базе данных удостоверений для поддержки полей, добавленных в исходную базу данных. Это можно сделать с помощью скриптов SQL для создания новых таблиц и копирования существующих данных. В окне "обозреватель сервера" разверните элемент "DefaultConnection", чтобы отобразить таблицы. Щелкните правой кнопкой мыши таблицы и выберите команду "создать запрос".

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

Вставьте скрипт SQL из [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) и запустите его. При обновлении "DefaultConnection" можно увидеть, что новые таблицы добавлены. Можно проверить данные в таблицах, чтобы убедиться, что данные были перенесены.

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a>Перенос приложения для использования ASP.NET Identity

1. Установите пакеты NuGet, необходимые для ASP.NET Identity:

    - Microsoft.AspNet.Identity.EntityFramework
    - Microsoft.AspNet.Identity.Owin
    - Microsoft.Owin.Host.SystemWeb
    - Microsoft. Owin. Security. Facebook
    - Microsoft. Owin. Security. Google
    - Microsoft. Owin. Security. MicrosoftAccount
    - Microsoft. Owin. Security. Twitter

   Дополнительные сведения об управлении пакетами NuGet можно найти [здесь](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog) .
2. Для работы с существующими данными в таблице необходимо создать классы модели, которые сопоставляются с таблицами и присоединить их к системе идентификации. В рамках контракта идентификации классы модели должны реализовывать интерфейсы, определенные в DLL Identity. Core, или расширять существующие реализации этих интерфейсов, доступных в Microsoft. AspNet. Identity. EntityFramework. Мы будем использовать существующие классы для ролей, имен входа пользователей и утверждений пользователей. Для нашего примера необходимо использовать настраиваемого пользователя. Щелкните проект правой кнопкой мыши и создайте новую папку "Идентитимоделс". Добавьте новый класс User, как показано ниже:

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   Обратите внимание, что "fileInfo" теперь является свойством в классе пользователя. Поэтому мы можем использовать класс User для непосредственной работы с данными профилирования.

Скопируйте файлы из папок **идентитимоделс** и **идентитяккаунт** из источника загрузки ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ). Они содержат оставшиеся классы моделей и новые страницы, необходимые для управления пользователями и ролями с помощью API-интерфейсов ASP.NET Identity. Используемый подход похож на членство в SQL и подробное описание можно найти [здесь](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

## <a name="copying-profile-data-to-the-new-tables"></a>Копирование данных профиля в новые таблицы

Как упоминалось ранее, необходимо десериализовать XML-данные в таблицах профилей и сохранить их в столбцах таблицы AspNetUsers. Новые столбцы были созданы в таблице Users на предыдущем шаге, поэтому все, что осталось, — заполнить эти столбцы необходимыми данными. Для этого мы будем использовать консольное приложение, которое запускается один раз для заполнения только что созданных столбцов в таблице Users.

1. Создайте новое консольное приложение в выходном решении.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. Установите последнюю версию пакета Entity Framework.
3. Добавьте веб-приложение, созданное выше, в качестве ссылки на консольное приложение. Для этого щелкните правой кнопкой мыши проект, затем "добавить ссылки", выберите решение, затем щелкните проект и нажмите кнопку ОК.
4. Скопируйте приведенный ниже код в класс Program.cs. Эта логика считывает данные профиля для каждого пользователя, сериализует ее как объект "fileInfo" и сохраняет ее обратно в базу данных.

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   Некоторые используемые модели определяются в папке "Идентитимоделс" проекта веб-приложения, поэтому необходимо включить соответствующие пространства имен.
5. Приведенный выше код работает с файлом базы данных в папке App\_Data проекта веб-приложения, созданного на предыдущих шагах. Чтобы сослаться на эту ссылку, обновите строку подключения в файле App. config консольного приложения с помощью строки подключения из файла Web. config веб-приложения. Также укажите полный физический путь в свойстве "AttachDbFilename".
6. Откройте командную строку и перейдите в папку bin приведенного выше консольного приложения. Запустите исполняемый файл и проверьте выходные данные журнала, как показано на следующем рисунке.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. Откройте таблицу "AspNetUsers" в обозреватель сервера и проверьте данные в новых столбцах, в которых хранятся свойства. Они должны быть обновлены с учетом соответствующих значений свойств.

## <a name="verify-functionality"></a>Проверка функциональности

Используйте только что добавленные страницы членства, реализованные с помощью ASP.NET Identity, для входа пользователя из старой базы данных. Пользователь должен иметь возможность войти в систему, используя те же учетные данные. Попробуйте другие функции, такие как добавление OAuth, создание нового пользователя, изменение пароля, Добавление ролей, Добавление пользователей в роли и т. д.

Данные профиля для старого пользователя и новых пользователей должны быть извлечены и сохранены в таблице Users. На старую таблицу больше нельзя ссылаться.

## <a name="conclusion"></a>Заключение

В статье описывается процесс миграции веб-приложений, которые используют модель поставщика, для членства в ASP.NET Identity. В статье дополнительно описан перенос данных профиля для пользователей, которые должны быть подключены к системе идентификации. Оставьте комментарии ниже для вопросов и проблем, возникших при миграции приложения.

*Благодаря Рик Андерсон (и Роберт Мкмуррай для ознакомления с этой статьей.*
