---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: Перенос существующего веб-сайта из членства SQL в ASP.NET Identity-ASP.NET 4. x
author: Rick-Anderson
description: В этом учебнике показаны шаги по переносу существующего веб-приложения с данными пользователей и ролей, созданными с помощью членства SQL, в новые ASP.NET Identity s...
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 633229cc4311d151121bf6a91b9fa8aeecca1197
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456157"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a>Миграция существующего веб-сайта из членства SQL в ASP.NET Identity

по [Рик Андерсон (](https://twitter.com/RickAndMSFT), [Сухас Джоши](https://github.com/suhasj)

> В этом учебнике показаны шаги по переносу существующего веб-приложения с данными пользователей и ролей, созданными с помощью членства SQL, в новую систему ASP.NET Identity. Этот подход подразумевает изменение существующей схемы базы данных на ту, которая необходима ASP.NET Identity и привязывается к ней в старых и новых классах. После применения этого подхода после переноса базы данных будущие обновления удостоверения будут обработаны без проблем.

В этом руководстве мы создадим шаблон веб-приложения (веб-формы), созданный с помощью Visual Studio 2010, для создания данных пользователей и ролей. Затем мы будем использовать скрипты SQL для переноса существующей базы данных в таблицы, необходимые системе идентификации. Далее мы установим необходимые пакеты NuGet и добавим новые страницы управления учетными записями, которые используют систему удостоверений для управления членством. В качестве проверки миграции пользователи, созданные с помощью членства SQL, должны иметь возможность войти в систему, и новые пользователи должны иметь возможность зарегистрироваться. Полный пример см. [здесь](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/). См. также [Миграция из ASP.NET членства в ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).

## <a name="getting-started"></a>Начало работы

### <a name="creating-an-application-with-sql-membership"></a>Создание приложения с членством в SQL

1. Нам нужно начать с существующего приложения, использующего членство SQL и имеющего данные пользователя и роли. Для целей этой статьи создадим веб-приложение в Visual Studio 2010.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. С помощью средства настройки ASP.NET создайте 2 пользователя: **олдадминусер** и **oldUser.**

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. Создайте роль с именем admin и добавьте "Олдадминусер" в качестве пользователя в этой роли.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. Создайте раздел администрирования сайта с помощью Default. aspx. Установите тег авторизации в файле Web. config, чтобы разрешить доступ только пользователям в ролях администратора. Дополнительные сведения можно найти здесь [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. Просмотрите базу данных в обозреватель сервера, чтобы понять, какие таблицы созданы системой членства SQL. Данные для входа пользователя сохраняются в таблицах ASPNET\_Users и ASPNET\_Membership, тогда как данные ролей хранятся в таблице ролей ASPNET\_. Сведения о том, какие пользователи в какой роли хранятся в таблице ASPNET\_Усерсинролес. Для базового управления членством достаточно перенести сведения из приведенных выше таблиц в систему ASP.NET Identity.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a>Переход на Visual Studio 2013

1. Установите Visual Studio Express 2013 для Web или Visual Studio 2013 вместе с [последними обновлениями](https://www.microsoft.com/download/details.aspx?id=44921).
2. Откройте приведенный выше проект в установленной версии Visual Studio. Если SQL Server Express не установлен на компьютере, при открытии проекта отображается запрос, поскольку в строке подключения используется SQL Express. Можно выбрать установку SQL Express или по мере изменения строки подключения к LocalDb. В этой статье мы изменим ее на LocalDb.
3. Откройте файл Web. config и измените строку подключения с. SQLExpress to (LocalDb) v 11.0. Удалите "User Instance = true" из строки подключения.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. Откройте обозреватель сервера и убедитесь, что можно наблюдать за схемой и данными таблицы.
5. Система ASP.NET Identity работает с платформой версии 4,5 или более поздней. Перенацеливание приложения на 4,5 или более поздней версии.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    Постройте проект, чтобы убедиться в отсутствии ошибок.

### <a name="installing-the-nuget-packages"></a>Установка пакетов NuGet

1. В обозреватель решений щелкните правой кнопкой мыши проект &gt; **Управление пакетами NuGet**. В поле поиска введите "Asp.net Identity". Выберите пакет в списке результатов и нажмите кнопку установить. Примите условия лицензионного соглашения, нажав кнопку "принимаю". Обратите внимание, что этот пакет будет устанавливать пакеты зависимостей: EntityFramework и Microsoft ASP.NET Core Identity. Аналогичным образом установите следующие пакеты (пропустите последние 4 пакета OWIN, если вы не хотите включать вход OAuth):

   - Microsoft.AspNet.Identity.Owin
   - Microsoft.Owin.Host.SystemWeb
   - Microsoft. Owin. Security. Facebook
   - Microsoft. Owin. Security. Google
   - Microsoft. Owin. Security. MicrosoftAccount
   - Microsoft. Owin. Security. Twitter

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a>Перенос базы данных в новую систему удостоверений

Следующим шагом является перенос существующей базы данных в схему, необходимую для ASP.NET Identityной системы. Для этого мы выполним сценарий SQL, который содержит набор команд для создания новых таблиц и переноса существующих сведений о пользователях в новые таблицы. Файл скрипта можно найти [здесь](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).

Этот файл скрипта относится к этому образцу. Если схема для таблиц, созданных с помощью членства SQL, настроена или изменена, скрипты необходимо соответствующим образом изменить.

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a>Создание скрипта SQL для миграции схемы

Чтобы ASP.NET Identity классы работали с данными существующих пользователей, необходимо перенести схему базы данных в ту, которая необходима для ASP.NET Identity. Это можно сделать, добавив новые таблицы и скопировав существующие данные в эти таблицы. По умолчанию ASP.NET Identity использует EntityFramework для повторного соответствия классов модели удостоверений с базой данных для хранения или извлечения информации. Эти классы модели реализуют основные интерфейсы идентификации, определяющие объекты пользователя и роли. Таблицы и столбцы в базе данных основаны на этих классах модели. Классы модели EntityFramework в Identity v 2.1.0 и их свойства определены ниже.

| **идентитюсер** | **Тип** | **идентитироле** | **идентитюсерроле** | **идентитюсерлогин** | **идентитюсерклаим** |
| --- | --- | --- | --- | --- | --- |
| Id | string | Id | RoleId | провидеркэй | Id |
| Имя пользователя | string | Имя | UserId | UserId | ClaimType |
| PasswordHash | string |  |  | LoginProvider | ClaimValue |
| секуритистамп | string |  |  |  | Идентификатор\_пользователя |
| Email | string |  |  |  |  |
| емаилконфирмед | bool |  |  |  |  |
| PhoneNumber | string |  |  |  |  |
| фоненумберконфирмед | bool |  |  |  |  |
| локкаутенаблед | bool |  |  |  |  |
| локкаутенддате | Дата и время |  |  |  |  |
| акцессфаиледкаунт | int |  |  |  |  |

Необходимо иметь таблицы для каждой из этих моделей со столбцами, соответствующими свойствам. Сопоставление классов и таблиц определяется в методе `OnModelCreating` `IdentityDBContext`. Это называется методом конфигурации API Fluent, и дополнительные сведения можно найти [здесь](https://msdn.microsoft.com/data/jj591617.aspx). Конфигурация для классов описана ниже.

| **Class** | **Таблица** | **Первичный ключ** | **Внешний ключ** |
| --- | --- | --- | --- |
| идентитюсер | AspnetUsers | Id |  |
| идентитироле | аспнетролес | Id |  |
| идентитюсерроле | аспнетусерроле | UserId + RoleId | User\_ID —&gt;AspnetUsers RoleId-&gt;Аспнетролес |
| идентитюсерлогин | аспнетусерлогинс | Провидеркэй + UserId + LoginProvider | UserId-&gt;AspnetUsers |
| идентитюсерклаим | аспнетусерклаимс | Id | Идентификатор\_пользователя —&gt;AspnetUsers |

С помощью этой информации можно создавать инструкции SQL для создания новых таблиц. Мы можем либо написать каждую инструкцию по отдельности, либо создать весь скрипт с помощью команд PowerShell EntityFramework, которые затем можно изменить в соответствии с требованиями. Для этого в VS откройте **консоль диспетчера пакетов** из меню " **вид** " или " **Сервис** ".

- Выполните команду "Enable-migrations", чтобы включить миграцию EntityFramework.
- Выполните команду "добавить начальную миграцию", которая создает исходный код настройки для создания базы данных C#в/ВБ.
- Последним шагом является выполнение команды "обновить-Database — Script", которая создает скрипт SQL на основе классов модели.

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

Этот скрипт создания базы данных можно использовать в качестве начала, когда мы будем вносить дополнительные изменения для добавления новых столбцов и копирования данных. Преимуществом этого является то, что мы создаем `_MigrationHistory` таблицу, которая используется EntityFramework для изменения схемы базы данных при изменении классов модели для будущих версий выпусков удостоверений.

Сведения о пользователе членства SQL имеют другие свойства в дополнение к именам класса пользовательской модели удостоверений, а также по электронной почте, попыток ввода пароля, дате последнего входа, последней блокировке и т. д. Это полезная информация, которую мы хотим перенести в систему идентификации. Это можно сделать, добавив дополнительные свойства в модель пользователя и сопоставив их со столбцами таблицы в базе данных. Это можно сделать, добавив класс, который подклассировать для модели `IdentityUser`. Мы можем добавить свойства в этот пользовательский класс и изменить скрипт SQL, чтобы добавить соответствующие столбцы при создании таблицы. Код для этого класса описан далее в этой статье. Скрипт SQL для создания `AspnetUsers` таблицы после добавления новых свойств будет

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

Затем необходимо скопировать существующие данные из базы данных членства SQL в вновь добавленные таблицы для удостоверения. Это можно сделать с помощью SQL, скопировав данные непосредственно из одной таблицы в другую. Чтобы добавить данные в строки таблицы, используется конструкция `INSERT INTO [Table]`. Для копирования из другой таблицы можно использовать инструкцию `INSERT INTO` вместе с инструкцией `SELECT`. Чтобы получить все сведения о пользователе, необходимые для запроса *пользователей aspnet\_* и *ASPNET\_таблиц членства* и копирования данных в таблицу *AspNetUsers* . Мы используем `INSERT INTO` и `SELECT` вместе с инструкциями `JOIN` и `LEFT OUTER JOIN`. Дополнительные сведения о запросах и копировании данных между таблицами см. по [этой](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) ссылке. Кроме того, таблицы Аспнетусерлогинс и Аспнетусерклаимс пусты, чтобы начать с момента отсутствия сведений о членстве в SQL, которые сопоставляются с этим по умолчанию. Копируются только сведения о пользователях и ролях. Для проекта, созданного на предыдущих шагах, SQL запрос на копирование данных в таблицу Users будет

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

В приведенной выше инструкции SQL сведения о каждом пользователе из таблиц *aspnet\_Users* и *ASPNET\_членства* копируются в столбцы таблицы *AspnetUsers* . Единственным изменением, которое выполняется здесь, является копирование пароля. Поскольку алгоритм шифрования паролей в членстве SQL использует "Пассвордсалт" и "Пассвордформат", мы тоже скопировали их вместе с хэшированным паролем, чтобы его можно было использовать для расшифровки пароля по идентификатору. Это объясняется далее в статье, посвященной подключению пользовательского хэша паролей.

Этот файл скрипта относится к этому образцу. Для приложений с дополнительными таблицами разработчики могут следовать аналогичному подходу к добавлению дополнительных свойств в класс пользовательской модели и сопоставлять их со столбцами в таблице AspnetUsers. Чтобы запустить сценарий,

1. Откройте Обозреватель серверов. Разверните подключение "ApplicationServices", чтобы отобразить таблицы. Щелкните правой кнопкой мыши узел таблицы и выберите пункт "создать запрос".

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. В окне запроса скопируйте и вставьте весь скрипт SQL из файла migrations. SQL. Запустите файл сценария, нажав кнопку со стрелкой "выполнить".

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    Обновите окно обозреватель сервера. В базе данных создаются пять новых таблиц.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    Ниже показано, как данные в таблицах членства SQL сопоставляются с новой системой идентификации.

    Роли\_ASPNET —&gt; Аспнетролес

    ASP\_Нетусерс и ASP\_Нетмембершип--&gt; AspNetUsers

    ASPNET\_Усеринролес--&gt; Аспнетусерролес

    Как описано в приведенном выше разделе, таблицы Аспнетусерклаимс и Аспнетусерлогинс пусты. Поле дискриминатора в таблице Аспнетусер должно соответствовать имени класса модели, которое определено как следующий шаг. Кроме того, столбец PasswordHash имеет формат "зашифрованный пароль | Salt-пароль | пароль". Это позволяет использовать специальную логику шифрования членства SQL, чтобы можно было повторно использовать старые пароли. Это объясняется далее в этой статье.

### <a name="creating-models-and-membership-pages"></a>Создание моделей и страниц членства

Как упоминалось ранее, функция идентификации использует Entity Framework для взаимодействия с базой данных для хранения сведений об учетной записи по умолчанию. Для работы с существующими данными в таблице необходимо создать классы модели, которые сопоставляются с таблицами и присоединить их к системе идентификации. В рамках контракта идентификации классы модели должны реализовывать интерфейсы, определенные в DLL Identity. Core, или расширять существующие реализации этих интерфейсов, доступных в Microsoft. AspNet. Identity. EntityFramework.

В нашем примере таблицы Аспнетролес, Аспнетусерклаимс, Аспнетлогинс и Аспнетусерроле имеют столбцы, аналогичные существующим реализациям системы идентификации. Поэтому мы можем повторно использовать существующие классы для соотнесения с этими таблицами. Таблица Аспнетусер содержит несколько дополнительных столбцов, которые используются для хранения дополнительных сведений из таблиц членства SQL. Это можно сопоставить, создав класс модели, который расширяет существующую реализацию "Идентитюсер" и добавляет дополнительные свойства.

1. Создайте папку Models в проекте и добавьте пользователя класса. Имя класса должно соответствовать данным, добавленным в столбце "дискриминатор" таблицы "AspnetUsers".

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    Класс User должен расширять класс Идентитюсер, найденный в библиотеке DLL *Microsoft. AspNet. Identity. EntityFramework* . Объявите свойства в классе, которые сопоставляются со столбцами Аспнетусер. Свойства ID, username, PasswordHash и Секуритистамп определены в Идентитюсер и поэтому опущены. Ниже приведен код для класса User, который имеет все свойства.

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. Класс Entity Framework DbContext необходим для того, чтобы сохранить данные в моделях обратно в таблицы и получить данные из таблиц для заполнения моделей. Библиотека DLL *Microsoft. AspNet. Identity. EntityFramework* определяет класс IdentityDbContext, который взаимодействует с таблицами удостоверений для получения и хранения информации. IdentityDbContext&lt;Тусер&gt; принимает класс Тусер, который может быть любым классом, расширяющим класс Идентитюсер.

    Создайте новый класс ApplicationDBContext, который расширяет IdentityDbContext в папке Models, передав класс User, созданный на шаге 1.

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. Управление пользователями в новой системе идентификации выполняется с помощью класса UserManager&lt;Тусер&gt;, определенного в библиотеке DLL *Microsoft. AspNet. Identity. EntityFramework* . Необходимо создать пользовательский класс, расширяющий UserManager, передав класс User, созданный на шаге 1.

    В папке Models создайте новый класс UserManager, который расширяет UserManager&lt;пользователя&gt;

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. Пароли пользователей приложения шифруются и сохраняются в базе данных. Алгоритм шифрования, используемый в членстве SQL, отличается от используемого в новой системе идентификации. Чтобы повторно использовать старые пароли, необходимо выборочно расшифровывать пароли, когда старые пользователи входят в систему с использованием алгоритма членства SQL при использовании алгоритма шифрования в удостоверениях для новых пользователей.

    Класс UserManager имеет свойство "Пассвордхашер", которое хранит экземпляр класса, реализующего интерфейс "Ипассвордхашер". Используется для шифрования и расшифровки паролей во время транзакций проверки подлинности пользователя. В классе UserManager, определенном на шаге 3, создайте новый класс Склпассвордхашер и скопируйте приведенный ниже код.

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    Устраните ошибки компиляции, импортировав пространства имен System. Text и System. Security. Cryptography.

    Метод Енкодепассворд шифрует пароль в соответствии с реализацией криптографии членства SQL по умолчанию. Это взято из библиотеки DLL System. Web. Если старое приложение использовало пользовательскую реализацию, оно должно быть отражено здесь. Нам нужно определить два других метода *хашпассворд* и *верифихашедпассворд* , которые используют метод *енкодепассворд* для хэширования данного пароля или проверки обычного текстового пароля с помощью существующего в базе данных.

    Система членства SQL использовала PasswordHash, Пассвордсалт и Пассвордформат для хэширования пароля, вводимых пользователями при регистрации или изменении пароля. Во время переноса все три поля хранятся в столбце PasswordHash таблицы Аспнетусер, разделенной символом "|". Когда пользователь входит в систему, а пароль содержит эти поля, для проверки пароля используется шифрование членства SQL. в противном случае мы используем шифрование по умолчанию системы удостоверений для проверки пароля. Таким образом, старым пользователям не придется изменять пароли после переноса приложения.
5. Объявите конструктор для класса UserManager и передайте его в качестве Склпассвордхашер в свойство в конструкторе.

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a>Создание новых страниц управления учетными записями

Следующим шагом в переносе является добавление страниц управления учетными записями, позволяющих пользователю регистрироваться и входить в систему. Старые страницы учетной записи из членства SQL используют элементы управления, которые не работают с новой системой идентификации. Чтобы добавить новые страницы управления пользователями, следуйте указаниям в руководстве по этой ссылке [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) начиная с шага "Добавление веб-форм для регистрации пользователей в приложении", так как мы уже создали проект и добавили пакеты NuGet.

Нам нужно внести некоторые изменения в пример для работы с этим проектом.

- Классы кода программной части Register.aspx.cs и Login.aspx.cs используют `UserManager` из пакетов удостоверений для создания пользователя. В этом примере используйте UserManager, добавленный в папку Models, выполнив описанные выше действия.
- Используйте созданный класс User вместо Идентитюсер в классах кода программной части Register.aspx.cs и Login.aspx.cs. Эти ловушки в пользовательском классе пользователя переключаются в систему идентификации.
- Часть для создания базы данных можно пропустить.
- Разработчику необходимо задать для нового пользователя значение ApplicationId, чтобы оно соответствовало текущему ИДЕНТИФИКАТОРу приложения. Это можно сделать, запросив приложение ApplicationId для этого приложения перед созданием объекта пользователя в классе Register.aspx.cs и настроив его до создания пользователя.

    Пример.

    Определите метод на странице Register.aspx.cs, чтобы запросить таблицу ASPNET\_Applications и получить идентификатор приложения в соответствии с именем приложения.

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    Теперь установите это значение для объекта User.

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

Используйте старое имя пользователя и пароль для входа существующего пользователя. Используйте страницу Регистрация для создания нового пользователя. Также убедитесь, что пользователи находятся в ролях должным образом.

Перенос системы идентификации помогает пользователю добавить в приложение открытую проверку подлинности (OAuth). См [. пример с](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) включенным OAuth.

## <a name="next-steps"></a>Следующие шаги

В этом руководстве мы показали, как перенести пользователей из членства SQL в ASP.NET Identity, но мы не продемонстрировали данные профиля. В следующем учебном курсе мы рассмотрим перенос данных профиля из членства SQL в новую систему идентификации.

Вы можете оставить отзыв в нижней части этой статьи.

*Спасибо Dykstra) и Рик Андерсон (, чтобы ознакомиться с этой статьей.*
