---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: Миграция существующего веб-сайта из членства SQL в ASP.NET Identity | Документация Майкрософт
author: Rick-Anderson
description: В этом учебнике демонстрируются действия, чтобы перенести веб-приложение с именем пользователя и роли данных, созданных с помощью членства SQL для нового удостоверения ASP.NET s...
ms.author: riande
ms.date: 12/19/2014
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: b80f2f5cc4702c3e406d8989905c56508711e788
ms.sourcegitcommit: 289e051cc8a90e8f7127e239fda73047bde4de12
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/25/2019
ms.locfileid: "58426085"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a>Миграция существующего веб-сайта из членства SQL в ASP.NET Identity

по [Рик Андерсон]((https://twitter.com/RickAndMSFT)), [Suhas Joshi](https://github.com/suhasj)

> Этот учебник демонстрирует действия по миграции веб-приложение с именем пользователя и роли данных, созданных с помощью членства SQL в новую систему ASP.NET Identity. Этот подход включает изменение существующей схемы базы данных к одному необходимые ASP.NET Identity и обработчик в классах старым или новым к нему. После после переноса базы данных применять этот подход, будущие обновления удостоверение будет обрабатываться без усилий.

В этом учебнике мы обратим шаблона веб-приложения (веб-формы) создан с помощью Visual Studio 2010 для создания данных пользователя и роли. Затем мы используем скрипты SQL для переноса существующей базы данных в таблицы, необходимые системе удостоверений. Далее мы установить необходимые пакеты NuGet и добавить новые страницы управления учетной записи, которые используют системы идентификации для управления членством. Для проверки миграции пользователей, созданных с помощью членства SQL должен быть возможность входа в систему, и новые пользователи должны иметь возможность регистрации. Вы найдете полный пример [здесь](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/). См. также [переход с членства ASP.NET на ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).

## <a name="getting-started"></a>Начало работы

### <a name="creating-an-application-with-sql-membership"></a>Создание приложения с помощью членства SQL

1. Нам нужно начать с существующего приложения, которое использует членства SQL и содержит данные пользователя и роли. В этой статье давайте создадим веб-приложения в Visual Studio 2010.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. С помощью средства настройки ASP.NET создайте 2 пользователя: **oldAdminUser** и **oldUser.**

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. Создайте роль с именем администратора и добавьте «oldAdminUser» от имени пользователя в этой роли.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. Создайте раздел администратора сайта с Default.aspx. Значение тега авторизации в файле web.config, чтобы разрешить доступ только к пользователям в роли администратора. Дополнительные сведения можно найти здесь [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. Просмотр базы данных в обозревателе серверов, чтобы понять, таблицы, созданные системой членства SQL. Данные имени входа пользователя хранится в aspnet\_пользователей и aspnet\_таблицы членства, пока данные роли хранятся в aspnet\_таблицу Roles. Сведения о том, какие пользователи являются в роли, которые хранятся в aspnet\_UsersInRoles таблицы. Для управления базовый уровень участия достаточно сведения в приведенных выше таблицах в систему ASP.NET Identity порта.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a>Переход на Visual Studio 2013

1. Установка Visual Studio Express 2013 для Web или Visual Studio 2013 вместе с [последние обновления](https://www.microsoft.com/download/details.aspx?id=44921).
2. Откройте проект выше в установленной версии Visual Studio. Если SQL Server Express на компьютере не установлен, запрос отображается при открытии проекта, так как в строке подключения используется SQL Express. Можно либо установить SQL Express или как обойти изменить строку подключения с LocalDb. В этой статье мы изменим его в LocalDb.
3. Откройте файл web.config и измените строку подключения из. SQLExpress для v11.0 (LocalDb). Удалить "User Instance = true" в строке подключения.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. Откройте обозреватель серверов и проверить схему таблицы и данные можно просмотреть.
5. ASP.NET Identity система работает с версией 4.5 или более поздней версии платформы. Изменить целевую платформу приложения до версии 4.5 или более поздней версии.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    Построение проекта, чтобы убедиться в отсутствии ошибок.

### <a name="installing-the-nuget-packages"></a>Установка пакетов Nuget

1. В обозревателе решений щелкните правой кнопкой мыши проект &gt; **управление пакетами NuGet**. В поле поиска введите «Asp.net Identity». Выберите пакет в списке результатов и нажмите "установить". Примите лицензионное соглашение, нажав кнопку «Принимаю». Обратите внимание на то, что этот пакет устанавливается пакеты зависимостей: EntityFramework и удостоверения Microsoft ASP.NET Core. Аналогичным образом установите следующие пакеты (пропустить последние 4 пакеты OWIN, если вы не хотите включить вход OAuth):

   - Microsoft.AspNet.Identity.Owin
   - Microsoft.Owin.Host.SystemWeb
   - Microsoft.Owin.Security.Facebook
   - Microsoft.Owin.Security.Google
   - Microsoft.Owin.Security.MicrosoftAccount
   - Microsoft.Owin.Security.Twitter

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a>Перенос базы данных в новую систему удостоверений

Следующим шагом является перенос существующей базы данных в схеме, необходимые системе ASP.NET Identity. Для достижения данного мы запуска SQL сценария, она имеет набор команд для создания новых таблиц и перенести существующие данные пользователя в новые таблицы. Файл сценария можно найти [здесь](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/Migrations.sql).

Этот файл сценария относится к этому примеру. Если создана схема для таблиц с помощью членства SQL настроенное или изменении скриптов необходимо изменить соответствующим образом.

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a>Создание скрипта SQL для переноса схемы

Для классов ASP.NET Identity для работы за пределами поля с данными из существующих пользователей нам нужно перенести схему базы данных в один, необходимые для ASP.NET Identity. Мы это можно сделать путем добавления новых таблиц и копирование сведения о существующем к этим таблицам. По умолчанию ASP.NET Identity использует EntityFramework для сопоставления классов модели удостоверения в базе данных для хранения или извлечения информации. Эти классы модели реализации базовых интерфейсов удостоверений, определение и объектов роли пользователя. Таблицы и столбцы в базе данных основаны на эти классы модели. Классы модели EntityFramework v2.1.0 удостоверений и их свойства, как определено ниже

| **IdentityUser** | **Type** | **IdentityRole** | **IdentityUserRole** | **IdentityUserLogin** | **IdentityUserClaim** |
| --- | --- | --- | --- | --- | --- |
| Идентификатор | string | Идентификатор | RoleId | ProviderKey | Идентификатор |
| Имя пользователя | string | name | Идентификатор пользователя | Идентификатор пользователя | ClaimType |
| PasswordHash | string |  |  | Loginprovider | ClaimValue |
| SecurityStamp | string |  |  |  | Пользователь\_идентификатор |
| Адрес эл. почты | string |  |  |  |  |
| EmailConfirmed | bool |  |  |  |  |
| Номер телефона | string |  |  |  |  |
| PhoneNumberConfirmed | bool |  |  |  |  |
| LockoutEnabled | bool |  |  |  |  |
| LockoutEndDate | DateTime |  |  |  |  |
| Счетчик AccessFailedCount | int |  |  |  |  |

Необходимо иметь таблицы для каждого из этих моделей со столбцами, соответствующими свойствам. Определение сопоставления между классами и таблиц в `OnModelCreating` метод `IdentityDBContext`. Этот процесс известен как метод fluent API конфигурации и Дополнительные сведения можно найти [здесь](https://msdn.microsoft.com/data/jj591617.aspx). Конфигурация для классов является, приведенные ниже

| **Класс** | **Таблица** | **Первичный ключ** | **Внешний ключ** |
| --- | --- | --- | --- |
| IdentityUser | AspnetUsers | Идентификатор |  |
| IdentityRole | AspnetRoles | Идентификатор |  |
| IdentityUserRole | AspnetUserRole | UserId + RoleId | Пользователь\_идентификатор -&gt;AspnetUsers RoleId -&gt;AspnetRoles |
| IdentityUserLogin | AspnetUserLogins | ProviderKey + UserId + loginprovider | UserId -&gt;AspnetUsers |
| IdentityUserClaim | AspnetUserClaims | Идентификатор | Пользователь\_идентификатор -&gt;AspnetUsers |

С помощью этой информации мы можем создать инструкции SQL для создания новых таблиц. Мы записи каждый оператор по отдельности или создать весь скрипт с помощью команды EntityFramework PowerShell, которые затем можно изменить при необходимости. Чтобы сделать это, в рамках соглашения VS open **консоль диспетчера пакетов** из **представление** или **средства** меню

- Выполните команду «Enable-Migrations» выполняет миграцию EntityFramework.
- Выполните команду «Add-migration initial», который создает код начальной настройки для создания базы данных на языке C# / Visual Basic.
- Последний шаг — это выполнить «Update-Database-сценария» команду, которая формирует скрипт SQL на основе модели классов.

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

Этот скрипт создания базы данных можно использовать для начала, где будут сделаны дополнительные изменения, чтобы добавить новые столбцы и копирование данных. Преимущество в том, что мы создаем `_MigrationHistory` таблицы, которая используется EntityFramework, чтобы изменить схему базы данных, когда изменение для будущих версий выпусков удостоверений классов модели.

Сведения о пользователе членства SQL было другие свойства в дополнение к тем в классе модели удостоверения пользователя а именно: по электронной почте, попыток ввода пароля, Дата последнего входа, Дата последнего ожидания блокировки и т.д. Это полезная информация и мы предлагаем переносятся на системы удостоверений. Это можно сделать путем добавления дополнительных свойств на модель пользователей и сопоставления их обратно к столбцам таблицы в базе данных. Мы это можно сделать, добавив класс подклассами `IdentityUser` модели. Мы можно добавить эти свойства в пользовательский класс и изменить сценарий SQL для добавления соответствующих столбцов при создании таблицы. Код для этого класса описан далее в этой статье. Скрипт SQL для создания `AspnetUsers` таблицы после добавления новых свойства становятся

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

Далее нам нужно скопировать существующие данные из базы данных членства SQL в новые таблицы для удостоверения. Это можно сделать через SQL путем копирования данных напрямую из одной таблицы в другую. Чтобы добавить данные в строках таблицы, мы используем `INSERT INTO [Table]` построения. Для копирования из другой таблицы, мы можем использовать `INSERT INTO` инструкции вместе с `SELECT` инструкции. Получить все сведения о пользователе, нам нужно запросить *aspnet\_пользователей* и *aspnet\_членства* таблицы и скопировать данные на *AspNetUsers*таблицы. Мы используем `INSERT INTO` и `SELECT` вместе с `JOIN` и `LEFT OUTER JOIN` инструкций. Дополнительные сведения о запросе, а также копирование данных между таблицами, см. [это](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) ссылку. Кроме того таблицы AspnetUserLogins и AspnetUserClaims пусты с самого начала, так как информация отсутствует в членства SQL, который сопоставляется это по умолчанию. Только копируемых данных предназначен для пользователей и ролей. Для проекта, созданного в предыдущих шагах будет SQL-запрос, чтобы скопировать данные в таблицу пользователей

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

В Приведенная выше инструкция SQL, информация о каждом пользователе из *aspnet\_пользователей* и *aspnet\_членства* таблицы копируется в столбцы  *AspnetUsers* таблицы. При единственным изменением, здесь мы Скопируйте пароль. Поскольку алгоритм шифрования для паролей в членства SQL «PasswordSalt» и «PasswordFormat», мы копируем слишком вместе с хэшированный пароль, чтобы его можно использовать для расшифровки пароля по удостоверению. Это описывается далее в этой статье, когда подключение hasher пользовательским паролем.

Этот файл сценария относится к этому примеру. Для приложений, которые имеют дополнительные таблицы разработчики могут следовать аналогичный подход для добавления дополнительных свойств в классе модели пользователя и сопоставить их со столбцами в таблице AspnetUsers. Чтобы запустить скрипт,

1. Откройте обозреватель серверов. Разверните узел соединения «ApplicationServices» для отображения таблиц. Щелкнуть правой кнопкой мыши узел таблицы и выберите параметр «Создать запрос»

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. В окне запроса скопируйте и вставьте весь скрипт SQL из файла Migrations.sql. Запуск файла скрипта, нажав кнопку со стрелкой «Выполнить».

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    Обновление окна обозревателя серверов. Пять новые таблицы создаются в базе данных.

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    Ниже приведен сопоставление данных в таблицах членства SQL в новую систему удостоверений.

    ASPNET\_роли--&gt; AspNetRoles

    ASP\_netUsers и asp\_netMembership--&gt; AspNetUsers

    ASPNET\_UserInRoles--&gt; AspNetUserRoles

    Как описано в предыдущем разделе, таблицы AspNetUserClaims и AspNetUserLogins пусты. Поле «Дискриминатора» в таблице пользователь ASPNET должно соответствовать имени класса модели, который определен в качестве следующего шага. Также в столбце PasswordHash указывается в формате "зашифрованный пароль | расширяющее значение пароля | формат пароля". Это позволяет использовать специальную логику шифрования членства SQL, таким образом, вы можете повторно использовать старые пароли. О котором рассказывается в далее в этой статье.

### <a name="creating-models-and-membership-pages"></a>Создание моделей и страниц членства

Как упоминалось ранее, функция удостоверений использует Entity Framework, обращаться к базе данных для хранения информации учетной записи по умолчанию. Для работы с существующими данными в таблице, необходимо создать классы моделей, которые сопоставляются с таблицами и подключить их в системы удостоверений. Как часть контракта удостоверений классы модели должен реализовывать интерфейсы, определенные в библиотеке dll Identity.Core или можно расширить существующую реализацию этих интерфейсов, доступных в Microsoft.AspNet.Identity.EntityFramework.

В нашем примере таблицы AspNetRoles, AspNetUserClaims, AspNetLogins и AspNetUserRole иметь столбцы, которые похожи на существующую реализацию системы удостоверений. Поэтому мы можем повторно использовать существующие классы для сопоставления с этими таблицами. Пользователь ASPNET таблица содержит некоторые дополнительные столбцы, которые используются для хранения дополнительной информации из таблицы членства SQL. Это могут быть сопоставлены, создав класс модели, которые расширяют существующую реализацию «IdentityUser» и добавьте дополнительные свойства.

1. Создайте папку моделей в проекте и добавьте класс пользователя. Имя класса должно соответствовать данные, добавленные в столбце «Дискриминатора» таблицы «AspnetUsers».

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    Класс пользователя должны расширять класс IdentityUser, найденный в *Microsoft.AspNet.Identity.EntityFramework* библиотеки dll. Объявление свойств в классах, которые сопоставляются столбцы пользователь ASPNET. Свойства идентификатора, имени пользователя, PasswordHash и SecurityStamp определяются в IdentityUser и поэтому опускается. Ниже приведен код для класса пользователя, который содержит все свойства

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. Класс Entity Framework DbContext необходим для сохранения данных в моделях обратно к таблицам и получения данных из таблиц для заполнения модели. *Microsoft.AspNet.Identity.EntityFramework* dll определяет класс IdentityDbContext, который взаимодействует с таблицами удостоверение для получения и хранения информации. IdentityDbContext&lt;tuser&gt; принимает класс «TUser», который может быть любой класс, расширяющий класс IdentityUser.

    Создайте новый класс ApplicationDBContext, который расширяет IdentityDbContext в папке «Модели», передав в классе «User», созданное на шаге 1

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. Управление пользователями в новой системе идентификации выполняется с помощью UserManager&lt;tuser&gt; класс, определенный в *Microsoft.AspNet.Identity.EntityFramework* библиотеки dll. Необходимо создать пользовательский класс, расширяющий UserManager, передав в классе «User», созданное на шаге 1.

    В папке Models создайте новый класс, расширяющий UserManager UserManager&lt;пользователя&gt;

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. Пароли пользователей приложения шифруются и хранятся в базе данных. Алгоритм шифрования, используемые в членстве в SQL отличается от того, в новой системе удостоверений. Чтобы повторно использовать старые пароли, необходимо выборочно расшифровать пароли, при входе старых пользователей с помощью алгоритма членства SQL при использовании алгоритма шифрования в удостоверении для новых пользователей.

    Класс UserManager имеет свойство «PasswordHasher», который хранит экземпляр класса, который реализует интерфейс «IPasswordHasher». Используется для шифрования и расшифровки паролей во время проверки подлинности пользовательских транзакций. В классе UserManager, определенный на шаге 3, создайте новый класс SQLPasswordHasher и скопируйте ниже кода.

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    Устраните ошибки компиляции путем импорта пространства имен System.Text и System.Security.Cryptography.

    Метод EncodePassword шифрует пароль в соответствии с реализации шифрования членства SQL по умолчанию. Метаданные берутся из библиотеки dll System.Web. Если старое приложение использовать пользовательскую реализацию, а затем должны быть отражены здесь. Нам нужно определить два других метода *HashPassword* и *VerifyHashedPassword* , использующих *EncodePassword* метод для хэширования пароля или проверки обычный текст пароль с одной существующим в базе данных.

    Система членства SQL используется PasswordHash и PasswordSalt PasswordFormat для хэширования пароля, введенного пользователем во время регистрации или изменения их паролей. Во время миграции всех трех полях хранятся в столбце PasswordHash в таблице пользователь ASPNET, разделенные "|" символов. Когда пользователь вошел в систему и пароль содержит следующие поля, мы используем crypto членства SQL для проверки пароля; в противном случае мы используем шифрования по умолчанию для системы идентификации, чтобы проверить пароль. Таким образом старых пользователей не придется менять свои пароли, после переноса приложения.
5. Объявите конструктор для класса UserManager и передать ее как SQLPasswordHasher свойству в конструктор.

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a>Создать новую учетную запись страниц управления

Следующий шаг в процессе переноса является добавление страницы управления учетной записью, позволит пользователю регистрировать и войдите в систему. Старые страницы учетной записи из членства SQL используйте элементы управления, которые не работают с новой системой удостоверение. Чтобы добавить нового пользователя страницы управления Пройдите учебник по этой ссылке [ https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project ](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) начиная с шага «Добавление веб-форм для регистрации пользователей в приложение», так как мы уже создали проект и добавили NuGet пакеты.

Нам нужно внести некоторые изменения для работы с проектом, здесь у нас есть примера.

- Register.aspx.cs и Login.aspx.cs кода используйте классы `UserManager` из идентификаторов пакетов для создания пользователя. В этом примере используйте UserManager, добавлен в папку Models, выполнив действия, описанные ранее.
- Класс пользователя, вместо IdentityUser в Register.aspx.cs и Login.aspx.cs кода классов. Это подключает в наш пользовательский класс, в систему удостоверений.
- Часть, которую необходимо создать базу данных можно пропустить.
- Разработчику необходимо задать идентификатор приложения для нового пользователя, в соответствии с текущей идентификатор приложения. Это можно сделать, запросив ApplicationId для этого приложения, перед созданием объекта пользователя в классе Register.aspx.cs и установите его перед созданием пользователя.

    Пример

    Определение метода на странице Register.aspx.cs запросить aspnet\_приложений таблицы и получение идентификатора приложения в соответствии с именем приложения

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    Теперь установить это в объекте пользователя

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

Используйте старое имя пользователя и пароль для входа существующего пользователя. Страница регистрации для создания нового пользователя. Также убедитесь, что пользователи в роли должным образом.

Перенос приложений в системы идентификации помогает пользователю добавить Open Authentication (OAuth) в приложение. См. образец [здесь](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/) которой активирован протокол OAuth.

## <a name="next-steps"></a>Следующие шаги

В этом руководстве мы показали, как перенос пользователей из членства SQL в ASP.NET Identity, но мы не перенести данные профиля. В следующем учебном курсе мы будем рассмотрим перенос данных профиля из членства SQL в новую систему удостоверений.

Вы можете оставить отзыв в нижней части этой статьи.

*Благодаря том Дайкстра и Рик Андерсон за рецензирование статьи.*
