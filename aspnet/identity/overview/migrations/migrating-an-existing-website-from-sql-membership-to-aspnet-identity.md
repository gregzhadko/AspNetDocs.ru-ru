---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: Перенос существующего веб-сайта из членства SQL в ASP.NET Identity-ASP.NET 4. x
author: Rick-Anderson
description: В этом учебнике показаны шаги по переносу существующего веб-приложения с данными пользователей и ролей, созданными с помощью членства SQL, в новые ASP.NET Identity s...
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 633229cc4311d151121bf6a91b9fa8aeecca1197
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456157"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="b9f89-103">Миграция существующего веб-сайта из членства SQL в ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="b9f89-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="b9f89-104">по [Рик Андерсон (](https://twitter.com/RickAndMSFT), [Сухас Джоши](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="b9f89-104">by [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="b9f89-105">В этом учебнике показаны шаги по переносу существующего веб-приложения с данными пользователей и ролей, созданными с помощью членства SQL, в новую систему ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="b9f89-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="b9f89-106">Этот подход подразумевает изменение существующей схемы базы данных на ту, которая необходима ASP.NET Identity и привязывается к ней в старых и новых классах.</span><span class="sxs-lookup"><span data-stu-id="b9f89-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="b9f89-107">После применения этого подхода после переноса базы данных будущие обновления удостоверения будут обработаны без проблем.</span><span class="sxs-lookup"><span data-stu-id="b9f89-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="b9f89-108">В этом руководстве мы создадим шаблон веб-приложения (веб-формы), созданный с помощью Visual Studio 2010, для создания данных пользователей и ролей.</span><span class="sxs-lookup"><span data-stu-id="b9f89-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="b9f89-109">Затем мы будем использовать скрипты SQL для переноса существующей базы данных в таблицы, необходимые системе идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="b9f89-110">Далее мы установим необходимые пакеты NuGet и добавим новые страницы управления учетными записями, которые используют систему удостоверений для управления членством.</span><span class="sxs-lookup"><span data-stu-id="b9f89-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="b9f89-111">В качестве проверки миграции пользователи, созданные с помощью членства SQL, должны иметь возможность войти в систему, и новые пользователи должны иметь возможность зарегистрироваться.</span><span class="sxs-lookup"><span data-stu-id="b9f89-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="b9f89-112">Полный пример см. [здесь](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span><span class="sxs-lookup"><span data-stu-id="b9f89-112">You can find the complete sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="b9f89-113">См. также [Миграция из ASP.NET членства в ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span><span class="sxs-lookup"><span data-stu-id="b9f89-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="b9f89-114">Начало работы</span><span class="sxs-lookup"><span data-stu-id="b9f89-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="b9f89-115">Создание приложения с членством в SQL</span><span class="sxs-lookup"><span data-stu-id="b9f89-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="b9f89-116">Нам нужно начать с существующего приложения, использующего членство SQL и имеющего данные пользователя и роли.</span><span class="sxs-lookup"><span data-stu-id="b9f89-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="b9f89-117">Для целей этой статьи создадим веб-приложение в Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="b9f89-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="b9f89-118">С помощью средства настройки ASP.NET создайте 2 пользователя: **олдадминусер** и **oldUser.**</span><span class="sxs-lookup"><span data-stu-id="b9f89-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="b9f89-119">Создайте роль с именем admin и добавьте "Олдадминусер" в качестве пользователя в этой роли.</span><span class="sxs-lookup"><span data-stu-id="b9f89-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="b9f89-120">Создайте раздел администрирования сайта с помощью Default. aspx.</span><span class="sxs-lookup"><span data-stu-id="b9f89-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="b9f89-121">Установите тег авторизации в файле Web. config, чтобы разрешить доступ только пользователям в ролях администратора.</span><span class="sxs-lookup"><span data-stu-id="b9f89-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="b9f89-122">Дополнительные сведения можно найти здесь [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="b9f89-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="b9f89-123">Просмотрите базу данных в обозреватель сервера, чтобы понять, какие таблицы созданы системой членства SQL.</span><span class="sxs-lookup"><span data-stu-id="b9f89-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="b9f89-124">Данные для входа пользователя сохраняются в таблицах ASPNET\_Users и ASPNET\_Membership, тогда как данные ролей хранятся в таблице ролей ASPNET\_.</span><span class="sxs-lookup"><span data-stu-id="b9f89-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="b9f89-125">Сведения о том, какие пользователи в какой роли хранятся в таблице ASPNET\_Усерсинролес.</span><span class="sxs-lookup"><span data-stu-id="b9f89-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="b9f89-126">Для базового управления членством достаточно перенести сведения из приведенных выше таблиц в систему ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="b9f89-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="b9f89-127">Переход на Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="b9f89-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="b9f89-128">Установите Visual Studio Express 2013 для Web или Visual Studio 2013 вместе с [последними обновлениями](https://www.microsoft.com/download/details.aspx?id=44921).</span><span class="sxs-lookup"><span data-stu-id="b9f89-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="b9f89-129">Откройте приведенный выше проект в установленной версии Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b9f89-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="b9f89-130">Если SQL Server Express не установлен на компьютере, при открытии проекта отображается запрос, поскольку в строке подключения используется SQL Express.</span><span class="sxs-lookup"><span data-stu-id="b9f89-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="b9f89-131">Можно выбрать установку SQL Express или по мере изменения строки подключения к LocalDb.</span><span class="sxs-lookup"><span data-stu-id="b9f89-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="b9f89-132">В этой статье мы изменим ее на LocalDb.</span><span class="sxs-lookup"><span data-stu-id="b9f89-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="b9f89-133">Откройте файл Web. config и измените строку подключения с. SQLExpress to (LocalDb) v 11.0.</span><span class="sxs-lookup"><span data-stu-id="b9f89-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="b9f89-134">Удалите "User Instance = true" из строки подключения.</span><span class="sxs-lookup"><span data-stu-id="b9f89-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="b9f89-135">Откройте обозреватель сервера и убедитесь, что можно наблюдать за схемой и данными таблицы.</span><span class="sxs-lookup"><span data-stu-id="b9f89-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="b9f89-136">Система ASP.NET Identity работает с платформой версии 4,5 или более поздней.</span><span class="sxs-lookup"><span data-stu-id="b9f89-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="b9f89-137">Перенацеливание приложения на 4,5 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="b9f89-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="b9f89-138">Постройте проект, чтобы убедиться в отсутствии ошибок.</span><span class="sxs-lookup"><span data-stu-id="b9f89-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="b9f89-139">Установка пакетов NuGet</span><span class="sxs-lookup"><span data-stu-id="b9f89-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="b9f89-140">В обозреватель решений щелкните правой кнопкой мыши проект &gt; **Управление пакетами NuGet**.</span><span class="sxs-lookup"><span data-stu-id="b9f89-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="b9f89-141">В поле поиска введите "Asp.net Identity".</span><span class="sxs-lookup"><span data-stu-id="b9f89-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="b9f89-142">Выберите пакет в списке результатов и нажмите кнопку установить.</span><span class="sxs-lookup"><span data-stu-id="b9f89-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="b9f89-143">Примите условия лицензионного соглашения, нажав кнопку "принимаю".</span><span class="sxs-lookup"><span data-stu-id="b9f89-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="b9f89-144">Обратите внимание, что этот пакет будет устанавливать пакеты зависимостей: EntityFramework и Microsoft ASP.NET Core Identity.</span><span class="sxs-lookup"><span data-stu-id="b9f89-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="b9f89-145">Аналогичным образом установите следующие пакеты (пропустите последние 4 пакета OWIN, если вы не хотите включать вход OAuth):</span><span class="sxs-lookup"><span data-stu-id="b9f89-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="b9f89-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="b9f89-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="b9f89-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="b9f89-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="b9f89-148">Microsoft. Owin. Security. Facebook</span><span class="sxs-lookup"><span data-stu-id="b9f89-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="b9f89-149">Microsoft. Owin. Security. Google</span><span class="sxs-lookup"><span data-stu-id="b9f89-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="b9f89-150">Microsoft. Owin. Security. MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="b9f89-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="b9f89-151">Microsoft. Owin. Security. Twitter</span><span class="sxs-lookup"><span data-stu-id="b9f89-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="b9f89-152">Перенос базы данных в новую систему удостоверений</span><span class="sxs-lookup"><span data-stu-id="b9f89-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="b9f89-153">Следующим шагом является перенос существующей базы данных в схему, необходимую для ASP.NET Identityной системы.</span><span class="sxs-lookup"><span data-stu-id="b9f89-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="b9f89-154">Для этого мы выполним сценарий SQL, который содержит набор команд для создания новых таблиц и переноса существующих сведений о пользователях в новые таблицы.</span><span class="sxs-lookup"><span data-stu-id="b9f89-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="b9f89-155">Файл скрипта можно найти [здесь](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span><span class="sxs-lookup"><span data-stu-id="b9f89-155">The script file can be found [here](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="b9f89-156">Этот файл скрипта относится к этому образцу.</span><span class="sxs-lookup"><span data-stu-id="b9f89-156">This script file is specific to this sample.</span></span> <span data-ttu-id="b9f89-157">Если схема для таблиц, созданных с помощью членства SQL, настроена или изменена, скрипты необходимо соответствующим образом изменить.</span><span class="sxs-lookup"><span data-stu-id="b9f89-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="b9f89-158">Создание скрипта SQL для миграции схемы</span><span class="sxs-lookup"><span data-stu-id="b9f89-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="b9f89-159">Чтобы ASP.NET Identity классы работали с данными существующих пользователей, необходимо перенести схему базы данных в ту, которая необходима для ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="b9f89-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="b9f89-160">Это можно сделать, добавив новые таблицы и скопировав существующие данные в эти таблицы.</span><span class="sxs-lookup"><span data-stu-id="b9f89-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="b9f89-161">По умолчанию ASP.NET Identity использует EntityFramework для повторного соответствия классов модели удостоверений с базой данных для хранения или извлечения информации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="b9f89-162">Эти классы модели реализуют основные интерфейсы идентификации, определяющие объекты пользователя и роли.</span><span class="sxs-lookup"><span data-stu-id="b9f89-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="b9f89-163">Таблицы и столбцы в базе данных основаны на этих классах модели.</span><span class="sxs-lookup"><span data-stu-id="b9f89-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="b9f89-164">Классы модели EntityFramework в Identity v 2.1.0 и их свойства определены ниже.</span><span class="sxs-lookup"><span data-stu-id="b9f89-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="b9f89-165">**идентитюсер**</span><span class="sxs-lookup"><span data-stu-id="b9f89-165">**IdentityUser**</span></span> | <span data-ttu-id="b9f89-166">**Тип**</span><span class="sxs-lookup"><span data-stu-id="b9f89-166">**Type**</span></span> | <span data-ttu-id="b9f89-167">**идентитироле**</span><span class="sxs-lookup"><span data-stu-id="b9f89-167">**IdentityRole**</span></span> | <span data-ttu-id="b9f89-168">**идентитюсерроле**</span><span class="sxs-lookup"><span data-stu-id="b9f89-168">**IdentityUserRole**</span></span> | <span data-ttu-id="b9f89-169">**идентитюсерлогин**</span><span class="sxs-lookup"><span data-stu-id="b9f89-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="b9f89-170">**идентитюсерклаим**</span><span class="sxs-lookup"><span data-stu-id="b9f89-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="b9f89-171">Id</span><span class="sxs-lookup"><span data-stu-id="b9f89-171">Id</span></span> | <span data-ttu-id="b9f89-172">string</span><span class="sxs-lookup"><span data-stu-id="b9f89-172">string</span></span> | <span data-ttu-id="b9f89-173">Id</span><span class="sxs-lookup"><span data-stu-id="b9f89-173">Id</span></span> | <span data-ttu-id="b9f89-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="b9f89-174">RoleId</span></span> | <span data-ttu-id="b9f89-175">провидеркэй</span><span class="sxs-lookup"><span data-stu-id="b9f89-175">ProviderKey</span></span> | <span data-ttu-id="b9f89-176">Id</span><span class="sxs-lookup"><span data-stu-id="b9f89-176">Id</span></span> |
| <span data-ttu-id="b9f89-177">Имя пользователя</span><span class="sxs-lookup"><span data-stu-id="b9f89-177">Username</span></span> | <span data-ttu-id="b9f89-178">string</span><span class="sxs-lookup"><span data-stu-id="b9f89-178">string</span></span> | <span data-ttu-id="b9f89-179">Имя</span><span class="sxs-lookup"><span data-stu-id="b9f89-179">Name</span></span> | <span data-ttu-id="b9f89-180">UserId</span><span class="sxs-lookup"><span data-stu-id="b9f89-180">UserId</span></span> | <span data-ttu-id="b9f89-181">UserId</span><span class="sxs-lookup"><span data-stu-id="b9f89-181">UserId</span></span> | <span data-ttu-id="b9f89-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="b9f89-182">ClaimType</span></span> |
| <span data-ttu-id="b9f89-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="b9f89-183">PasswordHash</span></span> | <span data-ttu-id="b9f89-184">string</span><span class="sxs-lookup"><span data-stu-id="b9f89-184">string</span></span> |  |  | <span data-ttu-id="b9f89-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="b9f89-185">LoginProvider</span></span> | <span data-ttu-id="b9f89-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="b9f89-186">ClaimValue</span></span> |
| <span data-ttu-id="b9f89-187">секуритистамп</span><span class="sxs-lookup"><span data-stu-id="b9f89-187">SecurityStamp</span></span> | <span data-ttu-id="b9f89-188">string</span><span class="sxs-lookup"><span data-stu-id="b9f89-188">string</span></span> |  |  |  | <span data-ttu-id="b9f89-189">Идентификатор\_пользователя</span><span class="sxs-lookup"><span data-stu-id="b9f89-189">User\_Id</span></span> |
| <span data-ttu-id="b9f89-190">Email</span><span class="sxs-lookup"><span data-stu-id="b9f89-190">Email</span></span> | <span data-ttu-id="b9f89-191">string</span><span class="sxs-lookup"><span data-stu-id="b9f89-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="b9f89-192">емаилконфирмед</span><span class="sxs-lookup"><span data-stu-id="b9f89-192">EmailConfirmed</span></span> | <span data-ttu-id="b9f89-193">bool</span><span class="sxs-lookup"><span data-stu-id="b9f89-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="b9f89-194">PhoneNumber</span><span class="sxs-lookup"><span data-stu-id="b9f89-194">PhoneNumber</span></span> | <span data-ttu-id="b9f89-195">string</span><span class="sxs-lookup"><span data-stu-id="b9f89-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="b9f89-196">фоненумберконфирмед</span><span class="sxs-lookup"><span data-stu-id="b9f89-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="b9f89-197">bool</span><span class="sxs-lookup"><span data-stu-id="b9f89-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="b9f89-198">локкаутенаблед</span><span class="sxs-lookup"><span data-stu-id="b9f89-198">LockoutEnabled</span></span> | <span data-ttu-id="b9f89-199">bool</span><span class="sxs-lookup"><span data-stu-id="b9f89-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="b9f89-200">локкаутенддате</span><span class="sxs-lookup"><span data-stu-id="b9f89-200">LockoutEndDate</span></span> | <span data-ttu-id="b9f89-201">Дата и время</span><span class="sxs-lookup"><span data-stu-id="b9f89-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="b9f89-202">акцессфаиледкаунт</span><span class="sxs-lookup"><span data-stu-id="b9f89-202">AccessFailedCount</span></span> | <span data-ttu-id="b9f89-203">int</span><span class="sxs-lookup"><span data-stu-id="b9f89-203">int</span></span> |  |  |  |  |

<span data-ttu-id="b9f89-204">Необходимо иметь таблицы для каждой из этих моделей со столбцами, соответствующими свойствам.</span><span class="sxs-lookup"><span data-stu-id="b9f89-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="b9f89-205">Сопоставление классов и таблиц определяется в методе `OnModelCreating` `IdentityDBContext`.</span><span class="sxs-lookup"><span data-stu-id="b9f89-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="b9f89-206">Это называется методом конфигурации API Fluent, и дополнительные сведения можно найти [здесь](https://msdn.microsoft.com/data/jj591617.aspx).</span><span class="sxs-lookup"><span data-stu-id="b9f89-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="b9f89-207">Конфигурация для классов описана ниже.</span><span class="sxs-lookup"><span data-stu-id="b9f89-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="b9f89-208">**Class**</span><span class="sxs-lookup"><span data-stu-id="b9f89-208">**Class**</span></span> | <span data-ttu-id="b9f89-209">**Таблица**</span><span class="sxs-lookup"><span data-stu-id="b9f89-209">**Table**</span></span> | <span data-ttu-id="b9f89-210">**Первичный ключ**</span><span class="sxs-lookup"><span data-stu-id="b9f89-210">**Primary key**</span></span> | <span data-ttu-id="b9f89-211">**Внешний ключ**</span><span class="sxs-lookup"><span data-stu-id="b9f89-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="b9f89-212">идентитюсер</span><span class="sxs-lookup"><span data-stu-id="b9f89-212">IdentityUser</span></span> | <span data-ttu-id="b9f89-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="b9f89-213">AspnetUsers</span></span> | <span data-ttu-id="b9f89-214">Id</span><span class="sxs-lookup"><span data-stu-id="b9f89-214">Id</span></span> |  |
| <span data-ttu-id="b9f89-215">идентитироле</span><span class="sxs-lookup"><span data-stu-id="b9f89-215">IdentityRole</span></span> | <span data-ttu-id="b9f89-216">аспнетролес</span><span class="sxs-lookup"><span data-stu-id="b9f89-216">AspnetRoles</span></span> | <span data-ttu-id="b9f89-217">Id</span><span class="sxs-lookup"><span data-stu-id="b9f89-217">Id</span></span> |  |
| <span data-ttu-id="b9f89-218">идентитюсерроле</span><span class="sxs-lookup"><span data-stu-id="b9f89-218">IdentityUserRole</span></span> | <span data-ttu-id="b9f89-219">аспнетусерроле</span><span class="sxs-lookup"><span data-stu-id="b9f89-219">AspnetUserRole</span></span> | <span data-ttu-id="b9f89-220">UserId + RoleId</span><span class="sxs-lookup"><span data-stu-id="b9f89-220">UserId + RoleId</span></span> | <span data-ttu-id="b9f89-221">User\_ID —&gt;AspnetUsers RoleId-&gt;Аспнетролес</span><span class="sxs-lookup"><span data-stu-id="b9f89-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="b9f89-222">идентитюсерлогин</span><span class="sxs-lookup"><span data-stu-id="b9f89-222">IdentityUserLogin</span></span> | <span data-ttu-id="b9f89-223">аспнетусерлогинс</span><span class="sxs-lookup"><span data-stu-id="b9f89-223">AspnetUserLogins</span></span> | <span data-ttu-id="b9f89-224">Провидеркэй + UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="b9f89-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="b9f89-225">UserId-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="b9f89-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="b9f89-226">идентитюсерклаим</span><span class="sxs-lookup"><span data-stu-id="b9f89-226">IdentityUserClaim</span></span> | <span data-ttu-id="b9f89-227">аспнетусерклаимс</span><span class="sxs-lookup"><span data-stu-id="b9f89-227">AspnetUserClaims</span></span> | <span data-ttu-id="b9f89-228">Id</span><span class="sxs-lookup"><span data-stu-id="b9f89-228">Id</span></span> | <span data-ttu-id="b9f89-229">Идентификатор\_пользователя —&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="b9f89-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="b9f89-230">С помощью этой информации можно создавать инструкции SQL для создания новых таблиц.</span><span class="sxs-lookup"><span data-stu-id="b9f89-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="b9f89-231">Мы можем либо написать каждую инструкцию по отдельности, либо создать весь скрипт с помощью команд PowerShell EntityFramework, которые затем можно изменить в соответствии с требованиями.</span><span class="sxs-lookup"><span data-stu-id="b9f89-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="b9f89-232">Для этого в VS откройте **консоль диспетчера пакетов** из меню " **вид** " или " **Сервис** ".</span><span class="sxs-lookup"><span data-stu-id="b9f89-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="b9f89-233">Выполните команду "Enable-migrations", чтобы включить миграцию EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="b9f89-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="b9f89-234">Выполните команду "добавить начальную миграцию", которая создает исходный код настройки для создания базы данных C#в/ВБ.</span><span class="sxs-lookup"><span data-stu-id="b9f89-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="b9f89-235">Последним шагом является выполнение команды "обновить-Database — Script", которая создает скрипт SQL на основе классов модели.</span><span class="sxs-lookup"><span data-stu-id="b9f89-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="b9f89-236">Этот скрипт создания базы данных можно использовать в качестве начала, когда мы будем вносить дополнительные изменения для добавления новых столбцов и копирования данных.</span><span class="sxs-lookup"><span data-stu-id="b9f89-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="b9f89-237">Преимуществом этого является то, что мы создаем `_MigrationHistory` таблицу, которая используется EntityFramework для изменения схемы базы данных при изменении классов модели для будущих версий выпусков удостоверений.</span><span class="sxs-lookup"><span data-stu-id="b9f89-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="b9f89-238">Сведения о пользователе членства SQL имеют другие свойства в дополнение к именам класса пользовательской модели удостоверений, а также по электронной почте, попыток ввода пароля, дате последнего входа, последней блокировке и т. д. Это полезная информация, которую мы хотим перенести в систему идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="b9f89-239">Это можно сделать, добавив дополнительные свойства в модель пользователя и сопоставив их со столбцами таблицы в базе данных.</span><span class="sxs-lookup"><span data-stu-id="b9f89-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="b9f89-240">Это можно сделать, добавив класс, который подклассировать для модели `IdentityUser`.</span><span class="sxs-lookup"><span data-stu-id="b9f89-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="b9f89-241">Мы можем добавить свойства в этот пользовательский класс и изменить скрипт SQL, чтобы добавить соответствующие столбцы при создании таблицы.</span><span class="sxs-lookup"><span data-stu-id="b9f89-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="b9f89-242">Код для этого класса описан далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="b9f89-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="b9f89-243">Скрипт SQL для создания `AspnetUsers` таблицы после добавления новых свойств будет</span><span class="sxs-lookup"><span data-stu-id="b9f89-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="b9f89-244">Затем необходимо скопировать существующие данные из базы данных членства SQL в вновь добавленные таблицы для удостоверения.</span><span class="sxs-lookup"><span data-stu-id="b9f89-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="b9f89-245">Это можно сделать с помощью SQL, скопировав данные непосредственно из одной таблицы в другую.</span><span class="sxs-lookup"><span data-stu-id="b9f89-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="b9f89-246">Чтобы добавить данные в строки таблицы, используется конструкция `INSERT INTO [Table]`.</span><span class="sxs-lookup"><span data-stu-id="b9f89-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="b9f89-247">Для копирования из другой таблицы можно использовать инструкцию `INSERT INTO` вместе с инструкцией `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="b9f89-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="b9f89-248">Чтобы получить все сведения о пользователе, необходимые для запроса *пользователей aspnet\_* и *ASPNET\_таблиц членства* и копирования данных в таблицу *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="b9f89-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="b9f89-249">Мы используем `INSERT INTO` и `SELECT` вместе с инструкциями `JOIN` и `LEFT OUTER JOIN`.</span><span class="sxs-lookup"><span data-stu-id="b9f89-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="b9f89-250">Дополнительные сведения о запросах и копировании данных между таблицами см. по [этой](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) ссылке.</span><span class="sxs-lookup"><span data-stu-id="b9f89-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="b9f89-251">Кроме того, таблицы Аспнетусерлогинс и Аспнетусерклаимс пусты, чтобы начать с момента отсутствия сведений о членстве в SQL, которые сопоставляются с этим по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b9f89-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="b9f89-252">Копируются только сведения о пользователях и ролях.</span><span class="sxs-lookup"><span data-stu-id="b9f89-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="b9f89-253">Для проекта, созданного на предыдущих шагах, SQL запрос на копирование данных в таблицу Users будет</span><span class="sxs-lookup"><span data-stu-id="b9f89-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="b9f89-254">В приведенной выше инструкции SQL сведения о каждом пользователе из таблиц *aspnet\_Users* и *ASPNET\_членства* копируются в столбцы таблицы *AspnetUsers* .</span><span class="sxs-lookup"><span data-stu-id="b9f89-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="b9f89-255">Единственным изменением, которое выполняется здесь, является копирование пароля.</span><span class="sxs-lookup"><span data-stu-id="b9f89-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="b9f89-256">Поскольку алгоритм шифрования паролей в членстве SQL использует "Пассвордсалт" и "Пассвордформат", мы тоже скопировали их вместе с хэшированным паролем, чтобы его можно было использовать для расшифровки пароля по идентификатору.</span><span class="sxs-lookup"><span data-stu-id="b9f89-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="b9f89-257">Это объясняется далее в статье, посвященной подключению пользовательского хэша паролей.</span><span class="sxs-lookup"><span data-stu-id="b9f89-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="b9f89-258">Этот файл скрипта относится к этому образцу.</span><span class="sxs-lookup"><span data-stu-id="b9f89-258">This script file is specific to this sample.</span></span> <span data-ttu-id="b9f89-259">Для приложений с дополнительными таблицами разработчики могут следовать аналогичному подходу к добавлению дополнительных свойств в класс пользовательской модели и сопоставлять их со столбцами в таблице AspnetUsers.</span><span class="sxs-lookup"><span data-stu-id="b9f89-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="b9f89-260">Чтобы запустить сценарий,</span><span class="sxs-lookup"><span data-stu-id="b9f89-260">To run the script,</span></span>

1. <span data-ttu-id="b9f89-261">Откройте Обозреватель серверов.</span><span class="sxs-lookup"><span data-stu-id="b9f89-261">Open Server Explorer.</span></span> <span data-ttu-id="b9f89-262">Разверните подключение "ApplicationServices", чтобы отобразить таблицы.</span><span class="sxs-lookup"><span data-stu-id="b9f89-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="b9f89-263">Щелкните правой кнопкой мыши узел таблицы и выберите пункт "создать запрос".</span><span class="sxs-lookup"><span data-stu-id="b9f89-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="b9f89-264">В окне запроса скопируйте и вставьте весь скрипт SQL из файла migrations. SQL.</span><span class="sxs-lookup"><span data-stu-id="b9f89-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="b9f89-265">Запустите файл сценария, нажав кнопку со стрелкой "выполнить".</span><span class="sxs-lookup"><span data-stu-id="b9f89-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="b9f89-266">Обновите окно обозреватель сервера.</span><span class="sxs-lookup"><span data-stu-id="b9f89-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="b9f89-267">В базе данных создаются пять новых таблиц.</span><span class="sxs-lookup"><span data-stu-id="b9f89-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="b9f89-268">Ниже показано, как данные в таблицах членства SQL сопоставляются с новой системой идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="b9f89-269">Роли\_ASPNET —&gt; Аспнетролес</span><span class="sxs-lookup"><span data-stu-id="b9f89-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="b9f89-270">ASP\_Нетусерс и ASP\_Нетмембершип--&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="b9f89-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="b9f89-271">ASPNET\_Усеринролес--&gt; Аспнетусерролес</span><span class="sxs-lookup"><span data-stu-id="b9f89-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="b9f89-272">Как описано в приведенном выше разделе, таблицы Аспнетусерклаимс и Аспнетусерлогинс пусты.</span><span class="sxs-lookup"><span data-stu-id="b9f89-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="b9f89-273">Поле дискриминатора в таблице Аспнетусер должно соответствовать имени класса модели, которое определено как следующий шаг.</span><span class="sxs-lookup"><span data-stu-id="b9f89-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="b9f89-274">Кроме того, столбец PasswordHash имеет формат "зашифрованный пароль | Salt-пароль | пароль".</span><span class="sxs-lookup"><span data-stu-id="b9f89-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="b9f89-275">Это позволяет использовать специальную логику шифрования членства SQL, чтобы можно было повторно использовать старые пароли.</span><span class="sxs-lookup"><span data-stu-id="b9f89-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="b9f89-276">Это объясняется далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="b9f89-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="b9f89-277">Создание моделей и страниц членства</span><span class="sxs-lookup"><span data-stu-id="b9f89-277">Creating models and membership pages</span></span>

<span data-ttu-id="b9f89-278">Как упоминалось ранее, функция идентификации использует Entity Framework для взаимодействия с базой данных для хранения сведений об учетной записи по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b9f89-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="b9f89-279">Для работы с существующими данными в таблице необходимо создать классы модели, которые сопоставляются с таблицами и присоединить их к системе идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="b9f89-280">В рамках контракта идентификации классы модели должны реализовывать интерфейсы, определенные в DLL Identity. Core, или расширять существующие реализации этих интерфейсов, доступных в Microsoft. AspNet. Identity. EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="b9f89-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="b9f89-281">В нашем примере таблицы Аспнетролес, Аспнетусерклаимс, Аспнетлогинс и Аспнетусерроле имеют столбцы, аналогичные существующим реализациям системы идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="b9f89-282">Поэтому мы можем повторно использовать существующие классы для соотнесения с этими таблицами.</span><span class="sxs-lookup"><span data-stu-id="b9f89-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="b9f89-283">Таблица Аспнетусер содержит несколько дополнительных столбцов, которые используются для хранения дополнительных сведений из таблиц членства SQL.</span><span class="sxs-lookup"><span data-stu-id="b9f89-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="b9f89-284">Это можно сопоставить, создав класс модели, который расширяет существующую реализацию "Идентитюсер" и добавляет дополнительные свойства.</span><span class="sxs-lookup"><span data-stu-id="b9f89-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="b9f89-285">Создайте папку Models в проекте и добавьте пользователя класса.</span><span class="sxs-lookup"><span data-stu-id="b9f89-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="b9f89-286">Имя класса должно соответствовать данным, добавленным в столбце "дискриминатор" таблицы "AspnetUsers".</span><span class="sxs-lookup"><span data-stu-id="b9f89-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="b9f89-287">Класс User должен расширять класс Идентитюсер, найденный в библиотеке DLL *Microsoft. AspNet. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="b9f89-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="b9f89-288">Объявите свойства в классе, которые сопоставляются со столбцами Аспнетусер.</span><span class="sxs-lookup"><span data-stu-id="b9f89-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="b9f89-289">Свойства ID, username, PasswordHash и Секуритистамп определены в Идентитюсер и поэтому опущены.</span><span class="sxs-lookup"><span data-stu-id="b9f89-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="b9f89-290">Ниже приведен код для класса User, который имеет все свойства.</span><span class="sxs-lookup"><span data-stu-id="b9f89-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="b9f89-291">Класс Entity Framework DbContext необходим для того, чтобы сохранить данные в моделях обратно в таблицы и получить данные из таблиц для заполнения моделей.</span><span class="sxs-lookup"><span data-stu-id="b9f89-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="b9f89-292">Библиотека DLL *Microsoft. AspNet. Identity. EntityFramework* определяет класс IdentityDbContext, который взаимодействует с таблицами удостоверений для получения и хранения информации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="b9f89-293">IdentityDbContext&lt;Тусер&gt; принимает класс Тусер, который может быть любым классом, расширяющим класс Идентитюсер.</span><span class="sxs-lookup"><span data-stu-id="b9f89-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="b9f89-294">Создайте новый класс ApplicationDBContext, который расширяет IdentityDbContext в папке Models, передав класс User, созданный на шаге 1.</span><span class="sxs-lookup"><span data-stu-id="b9f89-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="b9f89-295">Управление пользователями в новой системе идентификации выполняется с помощью класса UserManager&lt;Тусер&gt;, определенного в библиотеке DLL *Microsoft. AspNet. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="b9f89-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="b9f89-296">Необходимо создать пользовательский класс, расширяющий UserManager, передав класс User, созданный на шаге 1.</span><span class="sxs-lookup"><span data-stu-id="b9f89-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="b9f89-297">В папке Models создайте новый класс UserManager, который расширяет UserManager&lt;пользователя&gt;</span><span class="sxs-lookup"><span data-stu-id="b9f89-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="b9f89-298">Пароли пользователей приложения шифруются и сохраняются в базе данных.</span><span class="sxs-lookup"><span data-stu-id="b9f89-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="b9f89-299">Алгоритм шифрования, используемый в членстве SQL, отличается от используемого в новой системе идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="b9f89-300">Чтобы повторно использовать старые пароли, необходимо выборочно расшифровывать пароли, когда старые пользователи входят в систему с использованием алгоритма членства SQL при использовании алгоритма шифрования в удостоверениях для новых пользователей.</span><span class="sxs-lookup"><span data-stu-id="b9f89-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="b9f89-301">Класс UserManager имеет свойство "Пассвордхашер", которое хранит экземпляр класса, реализующего интерфейс "Ипассвордхашер".</span><span class="sxs-lookup"><span data-stu-id="b9f89-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="b9f89-302">Используется для шифрования и расшифровки паролей во время транзакций проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="b9f89-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="b9f89-303">В классе UserManager, определенном на шаге 3, создайте новый класс Склпассвордхашер и скопируйте приведенный ниже код.</span><span class="sxs-lookup"><span data-stu-id="b9f89-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="b9f89-304">Устраните ошибки компиляции, импортировав пространства имен System. Text и System. Security. Cryptography.</span><span class="sxs-lookup"><span data-stu-id="b9f89-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="b9f89-305">Метод Енкодепассворд шифрует пароль в соответствии с реализацией криптографии членства SQL по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b9f89-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="b9f89-306">Это взято из библиотеки DLL System. Web.</span><span class="sxs-lookup"><span data-stu-id="b9f89-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="b9f89-307">Если старое приложение использовало пользовательскую реализацию, оно должно быть отражено здесь.</span><span class="sxs-lookup"><span data-stu-id="b9f89-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="b9f89-308">Нам нужно определить два других метода *хашпассворд* и *верифихашедпассворд* , которые используют метод *енкодепассворд* для хэширования данного пароля или проверки обычного текстового пароля с помощью существующего в базе данных.</span><span class="sxs-lookup"><span data-stu-id="b9f89-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="b9f89-309">Система членства SQL использовала PasswordHash, Пассвордсалт и Пассвордформат для хэширования пароля, вводимых пользователями при регистрации или изменении пароля.</span><span class="sxs-lookup"><span data-stu-id="b9f89-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="b9f89-310">Во время переноса все три поля хранятся в столбце PasswordHash таблицы Аспнетусер, разделенной символом "|".</span><span class="sxs-lookup"><span data-stu-id="b9f89-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="b9f89-311">Когда пользователь входит в систему, а пароль содержит эти поля, для проверки пароля используется шифрование членства SQL. в противном случае мы используем шифрование по умолчанию системы удостоверений для проверки пароля.</span><span class="sxs-lookup"><span data-stu-id="b9f89-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="b9f89-312">Таким образом, старым пользователям не придется изменять пароли после переноса приложения.</span><span class="sxs-lookup"><span data-stu-id="b9f89-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="b9f89-313">Объявите конструктор для класса UserManager и передайте его в качестве Склпассвордхашер в свойство в конструкторе.</span><span class="sxs-lookup"><span data-stu-id="b9f89-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="b9f89-314">Создание новых страниц управления учетными записями</span><span class="sxs-lookup"><span data-stu-id="b9f89-314">Create new account management pages</span></span>

<span data-ttu-id="b9f89-315">Следующим шагом в переносе является добавление страниц управления учетными записями, позволяющих пользователю регистрироваться и входить в систему.</span><span class="sxs-lookup"><span data-stu-id="b9f89-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="b9f89-316">Старые страницы учетной записи из членства SQL используют элементы управления, которые не работают с новой системой идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="b9f89-317">Чтобы добавить новые страницы управления пользователями, следуйте указаниям в руководстве по этой ссылке [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) начиная с шага "Добавление веб-форм для регистрации пользователей в приложении", так как мы уже создали проект и добавили пакеты NuGet.</span><span class="sxs-lookup"><span data-stu-id="b9f89-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="b9f89-318">Нам нужно внести некоторые изменения в пример для работы с этим проектом.</span><span class="sxs-lookup"><span data-stu-id="b9f89-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="b9f89-319">Классы кода программной части Register.aspx.cs и Login.aspx.cs используют `UserManager` из пакетов удостоверений для создания пользователя.</span><span class="sxs-lookup"><span data-stu-id="b9f89-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="b9f89-320">В этом примере используйте UserManager, добавленный в папку Models, выполнив описанные выше действия.</span><span class="sxs-lookup"><span data-stu-id="b9f89-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="b9f89-321">Используйте созданный класс User вместо Идентитюсер в классах кода программной части Register.aspx.cs и Login.aspx.cs.</span><span class="sxs-lookup"><span data-stu-id="b9f89-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="b9f89-322">Эти ловушки в пользовательском классе пользователя переключаются в систему идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="b9f89-323">Часть для создания базы данных можно пропустить.</span><span class="sxs-lookup"><span data-stu-id="b9f89-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="b9f89-324">Разработчику необходимо задать для нового пользователя значение ApplicationId, чтобы оно соответствовало текущему ИДЕНТИФИКАТОРу приложения.</span><span class="sxs-lookup"><span data-stu-id="b9f89-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="b9f89-325">Это можно сделать, запросив приложение ApplicationId для этого приложения перед созданием объекта пользователя в классе Register.aspx.cs и настроив его до создания пользователя.</span><span class="sxs-lookup"><span data-stu-id="b9f89-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="b9f89-326">Пример.</span><span class="sxs-lookup"><span data-stu-id="b9f89-326">Example:</span></span>

    <span data-ttu-id="b9f89-327">Определите метод на странице Register.aspx.cs, чтобы запросить таблицу ASPNET\_Applications и получить идентификатор приложения в соответствии с именем приложения.</span><span class="sxs-lookup"><span data-stu-id="b9f89-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="b9f89-328">Теперь установите это значение для объекта User.</span><span class="sxs-lookup"><span data-stu-id="b9f89-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="b9f89-329">Используйте старое имя пользователя и пароль для входа существующего пользователя.</span><span class="sxs-lookup"><span data-stu-id="b9f89-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="b9f89-330">Используйте страницу Регистрация для создания нового пользователя.</span><span class="sxs-lookup"><span data-stu-id="b9f89-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="b9f89-331">Также убедитесь, что пользователи находятся в ролях должным образом.</span><span class="sxs-lookup"><span data-stu-id="b9f89-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="b9f89-332">Перенос системы идентификации помогает пользователю добавить в приложение открытую проверку подлинности (OAuth).</span><span class="sxs-lookup"><span data-stu-id="b9f89-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="b9f89-333">См [. пример с](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) включенным OAuth.</span><span class="sxs-lookup"><span data-stu-id="b9f89-333">Please refer to the sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b9f89-334">Следующие шаги</span><span class="sxs-lookup"><span data-stu-id="b9f89-334">Next Steps</span></span>

<span data-ttu-id="b9f89-335">В этом руководстве мы показали, как перенести пользователей из членства SQL в ASP.NET Identity, но мы не продемонстрировали данные профиля.</span><span class="sxs-lookup"><span data-stu-id="b9f89-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="b9f89-336">В следующем учебном курсе мы рассмотрим перенос данных профиля из членства SQL в новую систему идентификации.</span><span class="sxs-lookup"><span data-stu-id="b9f89-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="b9f89-337">Вы можете оставить отзыв в нижней части этой статьи.</span><span class="sxs-lookup"><span data-stu-id="b9f89-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="b9f89-338">*Спасибо Dykstra) и Рик Андерсон (, чтобы ознакомиться с этой статьей.*</span><span class="sxs-lookup"><span data-stu-id="b9f89-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
