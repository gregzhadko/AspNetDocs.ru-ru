---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: Разработка приложений ASP.NET с помощью Azure Active Directory-ASP.NET 4. x
author: Rick-Anderson
description: Средства Microsoft ASP.NET для Azure Active Directory упрощают включение проверки подлинности для веб-приложений, размещенных в Azure. Вы можете использовать Azure й...
ms.author: riande
ms.date: 08/14/2014
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 28425ea8d1312dfc6e14df9677396f2cbcf6f16d
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456729"
---
# <a name="developing-aspnet-apps-with-azure-active-directory"></a><span data-ttu-id="ec6b5-104">Разработка приложений ASP.NET с Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="ec6b5-104">Developing ASP.NET Apps with Azure Active Directory</span></span>

<span data-ttu-id="ec6b5-105">по [Рик Андерсон (](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="ec6b5-105">by [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="ec6b5-106">Средства Microsoft ASP.NET для Azure Active Directory упрощают включение проверки подлинности для веб-приложений, размещенных в [Azure](https://www.windowsazure.com/home/features/web-sites/).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-106">Microsoft ASP.NET tools for Azure Active Directory simplifies enabling authentication for web apps hosted on [Azure](https://www.windowsazure.com/home/features/web-sites/).</span></span> <span data-ttu-id="ec6b5-107">Для проверки подлинности пользователей Office 365 в Организации можно использовать проверку подлинности Azure. корпоративные учетные записи синхронизируются с локальными Active Directory или пользователями, созданными в пользовательском домене Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-107">You can use Azure Authentication to authenticate Office 365 users from your organization, corporate accounts synced from your on-premise Active Directory or users created in your own custom Azure Active Directory domain.</span></span> <span data-ttu-id="ec6b5-108">Включение проверки подлинности Windows Azure настраивает приложение для проверки подлинности пользователей с помощью одного клиента [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) .</span><span class="sxs-lookup"><span data-stu-id="ec6b5-108">Enabling Windows Azure Authentication configures your application to authenticate users using a single [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) tenant.</span></span>

<span data-ttu-id="ec6b5-109">В этом руководстве показано, как создать приложение ASP.NET, настроенное для входа с помощью [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-109">This tutorial will show you how to create an ASP.NET application that is configured for sign-on with [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span></span> <span data-ttu-id="ec6b5-110">Кроме того, вы узнаете, как вызвать API Graph, чтобы получить сведения о пользователе, выполнившего вход, и о том, как развернуть приложение в Azure.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-110">You will also learn how to call the Graph API to get information about the currently signed-in user and how to deploy the application to Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="ec6b5-111">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="ec6b5-111">Prerequisites</span></span>

1. <span data-ttu-id="ec6b5-112">[Visual Studio Express 2013 для Web](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) или [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-112">[Visual Studio Express 2013 for Web](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) or [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013).</span></span>
2. <span data-ttu-id="ec6b5-113">Требуется [Обновление 4 для Visual Studio 2013](https://www.microsoft.com/download/details.aspx?id=44921) -обновление 3 или более поздняя версия.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-113">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) - Update 3 or higher is required.</span></span>
3. <span data-ttu-id="ec6b5-114">Учетная запись Azure.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-114">An Azure account.</span></span> <span data-ttu-id="ec6b5-115">[Щелкните здесь](https://azure.microsoft.com/pricing/free-trial/) , чтобы получить бесплатную пробную версию, если у вас еще нет учетной записи.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-115">[Click here](https://azure.microsoft.com/pricing/free-trial/) for a free trial if you do not already have an account.</span></span>

## <a name="add-a-global-administrator-to-your-active-directory"></a><span data-ttu-id="ec6b5-116">Добавление глобального администратора в Active Directory</span><span class="sxs-lookup"><span data-stu-id="ec6b5-116">Add a Global Administrator to your Active Directory</span></span>

1. <span data-ttu-id="ec6b5-117">Выполните вход на [портал управления Azure](https://manage.windowsazure.com/).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-117">Sign in to the [Azure Management Portal](https://manage.windowsazure.com/).</span></span>
2. <span data-ttu-id="ec6b5-118">Все учетные записи Azure содержат **Каталог по умолчанию** — щелкните его, а затем перейдите на вкладку **Пользователи** в верхней части страницы (см. изображение ниже).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-118">All Azure accounts contain a **Default Directory** -- click on it, then click the **Users** tab at the top of the page (see image below).</span></span>
3. <span data-ttu-id="ec6b5-119">Щелкните Добавить пользователя.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-119">Click Add User.</span></span>
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. <span data-ttu-id="ec6b5-120">Создайте нового пользователя с ролью **глобального администратора** .</span><span class="sxs-lookup"><span data-stu-id="ec6b5-120">Create a new user with the **Global Administrator** role.</span></span> <span data-ttu-id="ec6b5-121">В верхнем меню щелкните **Пользователи** , а затем нажмите кнопку **Добавить пользователя** на панели команд.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-121">Click **Users** from the top menu, and then click the **Add User** button on the command bar.</span></span>
5. <span data-ttu-id="ec6b5-122">В диалоговом окне **Добавление пользователя** введите имя нового пользователя и нажмите кнопку со стрелкой вправо.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-122">In the **Add User** dialog, enter a name for the new user and then click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. <span data-ttu-id="ec6b5-123">Введите имя пользователя и задайте для роли значение **глобальный администратор**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-123">Enter the user name and set the role to **Global Administrator**.</span></span> <span data-ttu-id="ec6b5-124">Глобальным администраторам требуется альтернативный адрес электронной почты для восстановления пароля.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-124">Global administrators require an alternate email address for password recovery purposes.</span></span> <span data-ttu-id="ec6b5-125">После завершения нажмите кнопку со стрелкой вправо.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-125">After you're finished, click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. <span data-ttu-id="ec6b5-126">На следующей странице диалогового окна нажмите кнопку **создать**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-126">On the next page of the dialog, click **Create**.</span></span> <span data-ttu-id="ec6b5-127">Для нового пользователя будет создан временный пароль, отображаемый в диалоговом окне.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-127">A temporary password will be created for the new user and displayed in the dialog.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)

   <span data-ttu-id="ec6b5-128">Сохраните пароль, после первого входа в систему потребуется изменить пароль.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-128">Save the password, you will be required to change the password after the first log in.</span></span> <span data-ttu-id="ec6b5-129">На следующем рисунке показана новая учетная запись администратора.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-129">The following image shows the new admin account.</span></span> <span data-ttu-id="ec6b5-130">Для входа в приложение необходимо использовать Azure Active Directory, а не учетная запись Майкрософт, показанные на этой странице.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-130">You must use the Azure Active Directory to log into your app, not the Microsoft account also shown on this page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a><span data-ttu-id="ec6b5-131">Создание приложения ASP.NET</span><span class="sxs-lookup"><span data-stu-id="ec6b5-131">Create an ASP.NET Application</span></span>

<span data-ttu-id="ec6b5-132">В следующих шагах используется [Visual Studio Express 2013 для Web](https://www.microsoft.com/download/details.aspx?id=40747)и требуется [Visual Studio 2013 обновление 3](https://www.microsoft.com/download/details.aspx?id=43721).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-132">The following steps use [Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747), and requires [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span></span>

1. <span data-ttu-id="ec6b5-133">В Visual Studio щелкните **файл** , а затем — **Новый проект**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-133">In Visual Studio, click **File** and then **New Project**.</span></span> <span data-ttu-id="ec6b5-134">В диалоговом окне **Новый проект** выберите визуальный C# веб-проект в меню слева и нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-134">On the **New Project** dialog, select the Visual C# Web project from the left menu and click **OK**.</span></span> <span data-ttu-id="ec6b5-135">Также можно снять флажок **добавить Application Insights в проект** , если вы не хотите использовать функциональные возможности приложения.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-135">You may also want to uncheck the **Add Application Insights to Project** if you don't want the functionality for your application.</span></span>
2. <span data-ttu-id="ec6b5-136">В диалоговом окне **Новый проект ASP.NET** выберите **MVC**и нажмите кнопку **изменить проверку подлинности**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-136">In the **New ASP.NET Project** dialog, select **MVC**, and then click **Change Authentication**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. <span data-ttu-id="ec6b5-137">В диалоговом окне **Изменение проверки подлинности** выберите **учетные записи организации**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-137">On the **Change Authentication** dialog, select **Organizational Accounts**.</span></span> <span data-ttu-id="ec6b5-138">Эти параметры можно использовать для автоматической регистрации приложения в Azure AD, а также для автоматической настройки приложения для интеграции с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-138">These options can be used to automatically register your application with Azure AD as well as automatically configure your application to integrate with Azure AD.</span></span> <span data-ttu-id="ec6b5-139">Для регистрации и настройки приложения не нужно использовать диалоговое окно **изменение параметров проверки подлинности** , но оно значительно упрощает работу.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-139">You don't have to use the **Change Authentication** dialog to register and configure your application, but it makes it much easier.</span></span> <span data-ttu-id="ec6b5-140">Например, если вы используете Visual Studio 2012, вы по-прежнему можете вручную зарегистрировать приложение в портал управления Azure и обновить его конфигурацию для интеграции с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-140">If you are using Visual Studio 2012 for example, you can still manually register the application in the Azure Management Portal and update its configuration to integrate with Azure AD.</span></span>
   <span data-ttu-id="ec6b5-141">В раскрывающихся меню выберите **облако — Единая Организация** и **единый вход, чтение данных каталога**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-141">In the drop-down menus, select **Cloud - Single Organization** and **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="ec6b5-142">Введите домен для каталога Azure AD, например (на рисунке ниже) *aricka0yahoo.onmicrosoft.com*, а затем нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-142">Enter the domain for your Azure AD directory, for example (in the images below) *aricka0yahoo.onmicrosoft.com*, and then click **OK**.</span></span> <span data-ttu-id="ec6b5-143">Доменное имя можно получить на вкладке "домены" для каталога по умолчанию на портале Azure (см. следующее изображение ниже).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-143">You can get the domain name from the Domains tab for the Default Directory on the azure portal (see the next image down).</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)

   <span data-ttu-id="ec6b5-144">На следующем рисунке показано имя домена из портал Azure.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-144">The following image shows the domain name from the Azure portal.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)

    > [!NOTE]
    > <span data-ttu-id="ec6b5-145">При необходимости можно настроить URI идентификатора приложения, который будет зарегистрирован в Azure AD, щелкнув **Дополнительные параметры**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-145">You can optionally configure the Application ID URI that will be registered in Azure AD by clicking **More Options**.</span></span> <span data-ttu-id="ec6b5-146">URI идентификатора приложения — это уникальный идентификатор приложения, которое регистрируется в Azure AD и используется приложением для идентификации себя при взаимодействии с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-146">The App ID URI is the unique identifier for an application, which is registered in Azure AD and used by the application to identify itself when communicating with Azure AD.</span></span> <span data-ttu-id="ec6b5-147">Дополнительные сведения об универсальном коде ресурса (URI) идентификатора приложения и других свойствах зарегистрированных приложений см. в [этом разделе](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-147">For more information about the App ID URI and other properties of registered applications, see [this topic](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span></span> <span data-ttu-id="ec6b5-148">Установив флажок под полем URI идентификатора приложения, можно также переписать существующую регистрацию в Azure AD, которая использует тот же URI идентификатора приложения.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-148">By clicking the checkbox below the App ID URI field, you can also choose to overwrite an existing registration in Azure AD that uses the same App ID URI.</span></span>
4. <span data-ttu-id="ec6b5-149">После нажатия кнопки **ОК**появится диалоговое окно входа, в котором потребуется выполнить вход с использованием учетной записи глобального администратора (а не учетная запись Майкрософт, связанной с вашей подпиской).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-149">After clicking **OK**, a sign-in dialog will appear, and you'll need to sign in using a Global Administrator account (not the Microsoft account associated with your subscription).</span></span> <span data-ttu-id="ec6b5-150">Если вы ранее создали учетную запись администратора, вам потребуется изменить пароль, а затем снова войти, используя новый пароль.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-150">If you created a new Administrator account earlier, you'll be required to change the password and then sign in again using the new password.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. <span data-ttu-id="ec6b5-151">После успешной проверки подлинности в диалоговом окне **Новый проект ASP.NET** отобразится выбранный вариант проверки подлинности (**Организация** ) и каталог, в котором будет зарегистрировано новое приложение (*aricka0yahoo.onmicrosoft.com* на рисунке ниже).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-151">After you've successfully authenticated, the **New ASP.NET Project** dialog will show your authentication choice (**Organizational** ) and the directory where the new application will be registered (*aricka0yahoo.onmicrosoft.com* in the image below).</span></span> <span data-ttu-id="ec6b5-152">Ниже этой информации установите флажок **узел в облаке**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-152">Below this information, select the checkbox labeled **Host in the cloud**.</span></span> <span data-ttu-id="ec6b5-153">Если этот флажок установлен, проект будет подготовлен в качестве веб-приложения Azure и будет включен для простой публикации позже.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-153">If this checkbox is selected, the project will be provisioned as an Azure web app and will be enabled for easy publishing later.</span></span> <span data-ttu-id="ec6b5-154">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-154">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. <span data-ttu-id="ec6b5-155">Откроется диалоговое окно **Настройка веб-сайта Azure** с использованием автоматически созданного имени сайта и региона.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-155">The **Configure Azure Website** dialog will appear, using an auto-generated site name and region.</span></span> <span data-ttu-id="ec6b5-156">Также обратите внимание на учетную запись, которую вы вошли в диалоговом окне.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-156">Also note the account you're currently signed into in the dialog.</span></span> <span data-ttu-id="ec6b5-157">Вы хотите убедиться, что эта учетная запись является той, к которой подключена подписка Azure, обычно это учетная запись Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-157">You want to make sure that this account is the one that your Azure subscription is attached to, typically a Microsoft account.</span></span>

    > [!NOTE]
    > <span data-ttu-id="ec6b5-158">Для этого проекта требуется база данных.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-158">This project requires a database.</span></span> <span data-ttu-id="ec6b5-159">Необходимо выбрать одну из существующих баз данных или создать новую.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-159">You need to select one of your existing databases, or create a new one.</span></span> <span data-ttu-id="ec6b5-160">База данных является обязательной, поскольку проект уже использует файл локальной базы данных для хранения небольшого объема данных конфигурации проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-160">A database is required because the project already uses a local database file to store a small amount of authentication configuration data.</span></span> <span data-ttu-id="ec6b5-161">При развертывании приложения на веб-сайте Azure эта база данных не упаковывается в развертывание, поэтому необходимо выбрать доступную в облаке.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-161">When you deploy the application to an Azure Website, this database isn't packaged with the deployment, so you need to choose one that's accessible in the cloud.</span></span> <span data-ttu-id="ec6b5-162">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-162">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. <span data-ttu-id="ec6b5-163">Проект будет создан, и параметры проверки подлинности и веб-приложения будут автоматически настроены в проекте.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-163">The project will be created, and your authentication options and web app options will be automatically configured with the project.</span></span> <span data-ttu-id="ec6b5-164">После завершения этого процесса запустите проект локально, нажав клавишу **^ F5**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-164">Once this process has completed, run the project locally by pressing **^F5**.</span></span> <span data-ttu-id="ec6b5-165">Вам потребуется выполнить вход с использованием учетной записи организации.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-165">You will be required to sign in using your organizational account.</span></span> <span data-ttu-id="ec6b5-166">Укажите имя пользователя и пароль для созданной ранее учетной записи и нажмите кнопку **войти**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-166">Provide the username and password for the account you created earlier and click **Sign in**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. <span data-ttu-id="ec6b5-167">После успешного входа сайт ASP.NET покажет, что вы прошли проверку подлинности, отображая имя пользователя в правом верхнем углу страницы.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-167">After successful sign in, the ASP.NET site will show that you've authenticated by displaying the username in the top right corner of the page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)

   <span data-ttu-id="ec6b5-168">Если возникает ошибка: значение не может быть равно null или пусто.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-168">If you get the error: Value cannot be null or empty.</span></span> <span data-ttu-id="ec6b5-169">Имя параметра: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="ec6b5-169">Parameter name: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span></span>

   <span data-ttu-id="ec6b5-170">Ознакомьтесь с разделом [Отладка](#dbg) в конце этого руководства.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-170">see the [debug](#dbg) section at the end of the tutorial.</span></span>

## <a name="basics-of-the-graph-api"></a><span data-ttu-id="ec6b5-171">Основные сведения о API Graph</span><span class="sxs-lookup"><span data-stu-id="ec6b5-171">Basics of the Graph API</span></span>

<span data-ttu-id="ec6b5-172">[API Graph](https://msdn.microsoft.com/library/azure/hh974476.aspx) — это программный интерфейс, используемый для выполнения CRUD и других операций с объектами в каталоге Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-172">[The Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) is the programmatic interface used to perform CRUD and other operations on objects in your Azure AD directory.</span></span> <span data-ttu-id="ec6b5-173">Если при создании нового проекта в Visual Studio 2013 выбран вариант учетной записи организации, то приложение уже будет настроено для вызова API Graph.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-173">If you select an Organizational Account option for authentication when creating a new project in Visual Studio 2013, your application will already be configured to call the Graph API.</span></span> <span data-ttu-id="ec6b5-174">В этом разделе кратко показано, как работает API Graph.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-174">This section briefly shows you how the Graph API works.</span></span>

1. <span data-ttu-id="ec6b5-175">В работающем приложении щелкните имя пользователя, выполнившего вход, в правом верхнем углу страницы.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-175">In your running application, click on the name of the signed-in user at the top right of the page.</span></span> <span data-ttu-id="ec6b5-176">Откроется страница профиля пользователя, которая является действием на контроллере home.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-176">This will take you to the User Profile page, which is an action on the Home Controller.</span></span> <span data-ttu-id="ec6b5-177">Вы заметите, что в таблице содержатся сведения о пользователях учетной записи администратора, созданной ранее.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-177">You'll notice that the table contains user information about the administrator account you created earlier.</span></span> <span data-ttu-id="ec6b5-178">Эта информация хранится в каталоге и вызывается API Graph для получения этих сведений при загрузке страницы.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-178">This information is stored in your directory, and the Graph API is called to retrieve this information when the page loads.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. <span data-ttu-id="ec6b5-179">Вернитесь в Visual Studio и разверните папку **Controllers** , а затем откройте файл **HomeController.CS** .</span><span class="sxs-lookup"><span data-stu-id="ec6b5-179">Go back to Visual Studio and expand the **Controllers** folder and then open the **HomeController.cs** file.</span></span> <span data-ttu-id="ec6b5-180">Вы увидите действие **UserProfile ()** , содержащее код для получения маркера, а затем вызовите API Graph.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-180">You'll see a **UserProfile()** action that contains code to retrieve a token and then call the Graph API.</span></span> <span data-ttu-id="ec6b5-181">Этот код повторяется ниже:</span><span class="sxs-lookup"><span data-stu-id="ec6b5-181">This code is duplicated below:</span></span>

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    <span data-ttu-id="ec6b5-182">Чтобы вызвать API Graph, сначала необходимо получить маркер.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-182">To call the Graph API, you first need to retrieve a token.</span></span> <span data-ttu-id="ec6b5-183">При извлечении маркера его строковое значение должно быть добавлено в заголовок авторизации для всех последующих запросов к API Graph.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-183">When the token is retrieved, its string value must be appended in the Authorization header for all subsequent requests to the Graph API.</span></span> <span data-ttu-id="ec6b5-184">Большая часть приведенного выше кода обрабатывает сведения о проверке подлинности в Azure AD для получения маркера, использования маркера для выполнения вызова API Graph, а затем преобразования ответа, чтобы его можно было представить в представлении.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-184">Most of the code above handles the details of authenticating to Azure AD to get a token, using the token to make a call to the Graph API, and then transforming the response so that it can be presented in the View.</span></span>

    <span data-ttu-id="ec6b5-185">Наиболее важной частью для обсуждения является следующая выделенная строка: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-185">The most relevant portion for discussion is the following highlighted line: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span></span> <span data-ttu-id="ec6b5-186">Эта строка представляет имя пользователя, которое было десериализовано из ответа JSON и представлено в представлении.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-186">This line represents the name of the user, which has been deserialized from the JSON response and is presented in the View.</span></span>

    <span data-ttu-id="ec6b5-187">Вы можете вызвать API Graph с помощью HttpClient и самостоятельно управлять необработанными данными, но проще всего использовать [клиентскую библиотеку графа, доступную через NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-187">You can call the Graph API using HttpClient and handle the raw data yourself, but an easier way is to use the [Graph Client Library which is available via NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span></span> <span data-ttu-id="ec6b5-188">Клиентская библиотека обрабатывает необработанные HTTP-запросы и преобразование возвращаемых данных и значительно упрощает работу с API Graph в среде .NET.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-188">The Client Library handles the raw HTTP requests and the transformation of the returned data for you, and makes it much easier to work with the Graph API in a .NET environment.</span></span> <span data-ttu-id="ec6b5-189">См. соответствующие примеры кода API Graph на сайте [GitHub.](https://github.com/AzureADSamples)</span><span class="sxs-lookup"><span data-stu-id="ec6b5-189">See the related Graph API code samples on [GitHub.](https://github.com/AzureADSamples)</span></span>

## <a name="deploy-the-application-to-azure"></a><span data-ttu-id="ec6b5-190">Развертывание приложения в Azure</span><span class="sxs-lookup"><span data-stu-id="ec6b5-190">Deploy the Application to Azure</span></span>

<span data-ttu-id="ec6b5-191">В следующих шагах показано, как развернуть приложение в Azure.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-191">The following steps will show you how to deploy the application to Azure.</span></span> <span data-ttu-id="ec6b5-192">На предыдущих шагах вы подключились к новому проекту с помощью веб-приложения в Azure, поэтому все готово к публикации всего за несколько шагов.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-192">In the earlier steps, you connected your new project with a web app on Azure, so it's ready to be published in just a few steps.</span></span>

1. <span data-ttu-id="ec6b5-193">В Visual Studio щелкните проект правой кнопкой мыши и выберите **опубликовать**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-193">In Visual Studio, right-click on the project and select **Publish**.</span></span> <span data-ttu-id="ec6b5-194">Появится диалоговое окно **Публикация веб-сайта** , где каждый параметр уже настроен.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-194">The **Publish Web** dialog will appear with each setting already configured.</span></span> <span data-ttu-id="ec6b5-195">Нажмите кнопку **Далее** , чтобы открыть страницу **Параметры** .</span><span class="sxs-lookup"><span data-stu-id="ec6b5-195">Click on the **Next** button to go to the **Settings** page.</span></span> <span data-ttu-id="ec6b5-196">Может появиться запрос на проверку подлинности; Убедитесь, что вы выполняете проверку подлинности с помощью учетной записи подписки Azure (обычно это учетная запись Майкрософт), а не учетной записи организации, созданной ранее.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-196">You may be prompted to authenticate; make sure you authenticate using your Azure subscription account (typically a Microsoft account) and not the organizational account you created earlier.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. <span data-ttu-id="ec6b5-197">Установите флажок " **включить проверку подлинности в Организации** ".</span><span class="sxs-lookup"><span data-stu-id="ec6b5-197">Check the **Enable Organizational Authentication** option.</span></span> <span data-ttu-id="ec6b5-198">В поле **домен** введите домен для каталога.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-198">In the **Domain** field, enter the domain for your directory.</span></span> <span data-ttu-id="ec6b5-199">В раскрывающемся списке **уровень доступа** выберите **единый вход и чтение данных каталога**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-199">From the **Access Level** drop-down, select **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="ec6b5-200">Вы заметите, что предыдущая используемая база данных уже заполнена в разделе **базы данных** .</span><span class="sxs-lookup"><span data-stu-id="ec6b5-200">You'll notice that the previous database you used is already populated in the **Databases** section.</span></span> <span data-ttu-id="ec6b5-201">Нажмите кнопку **Опубликовать**.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-201">Click **Publish**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. <span data-ttu-id="ec6b5-202">Visual Studio начнет развертывание веб-сайта, после чего появится новое окно браузера.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-202">Visual Studio will begin deploying your website, and then a new browser window will appear.</span></span> <span data-ttu-id="ec6b5-203">Возможно, вам будет предложено снова пройти проверку подлинности в каталоге.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-203">You may be prompted to authenticate to your directory once again.</span></span> <span data-ttu-id="ec6b5-204">После проверки подлинности вы будете перенаправлены на новый опубликованный веб-сайт в Azure.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-204">Once you've authenticated, you'll be redirected to your newly published website on Azure.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a><span data-ttu-id="ec6b5-205">Отладка приложения</span><span class="sxs-lookup"><span data-stu-id="ec6b5-205">Debugging the app</span></span>

<span data-ttu-id="ec6b5-206">Если возникнет следующая ошибка: значение не может быть null или пустым.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-206">If you get the following error: Value cannot be null or empty.</span></span> <span data-ttu-id="ec6b5-207">Имя параметра: linkText</span><span class="sxs-lookup"><span data-stu-id="ec6b5-207">Parameter name: linkText</span></span>

![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)

<span data-ttu-id="ec6b5-208">Замените код в файле *Views\Shared\\_LoginPartial. cshtml* следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="ec6b5-208">Replace the code in the *Views\Shared\\_LoginPartial.cshtml* file with the following:</span></span>

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

<span data-ttu-id="ec6b5-209">После запуска приложения, если вошедший в систему пользователь отображает "null User", выйдите из системы и снова войдите с помощью учетной записи Active Directory, созданной ранее.</span><span class="sxs-lookup"><span data-stu-id="ec6b5-209">After running the app, if the logged in user shows "Null User", sign out, and sign back in with the Active Directory account you created earlier.</span></span>

<span data-ttu-id="ec6b5-210">Отличная рекомендация, которую следует выполнить, — это Раинэй [веб-сайты Azure и аутентификация Организации с помощью Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span><span class="sxs-lookup"><span data-stu-id="ec6b5-210">An excellent tutorial to follow is Rick Rainey's [Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span></span>

## <a name="more-information"></a><span data-ttu-id="ec6b5-211">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="ec6b5-211">More Information</span></span>

- [<span data-ttu-id="ec6b5-212">Подробный обзор: веб-сайты Azure и аутентификация в Организации с помощью Azure AD</span><span class="sxs-lookup"><span data-stu-id="ec6b5-212">Deep Dive: Azure Websites and Organizational Authentication using Azure AD</span></span>](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)
- [<span data-ttu-id="ec6b5-213">Обзор API Graph Azure AD</span><span class="sxs-lookup"><span data-stu-id="ec6b5-213">Azure AD Graph API Overview</span></span>](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [<span data-ttu-id="ec6b5-214">Сценарии проверки подлинности в Azure AD</span><span class="sxs-lookup"><span data-stu-id="ec6b5-214">Authentication Scenarios in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [<span data-ttu-id="ec6b5-215">Примеры кода Azure AD на сайте GitHub</span><span class="sxs-lookup"><span data-stu-id="ec6b5-215">Azure AD Code Samples on GitHub</span></span>](https://github.com/AzureADSamples)
