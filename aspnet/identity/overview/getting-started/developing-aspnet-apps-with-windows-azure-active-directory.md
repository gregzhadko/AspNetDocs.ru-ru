---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: Разработка приложений ASP.NET с Azure Active Directory — ASP.NET 4.x
author: Rick-Anderson
description: Средства Microsoft ASP.NET для Azure Active Directory упрощает для включения проверки подлинности для веб-приложений, размещенных в Azure. Можно использовать Azure проверка...
ms.author: riande
ms.date: 08/14/2014
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 6f8b926c78097b68e6a159f2fdd30e7b8a6477a0
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59395177"
---
# <a name="developing-aspnet-apps-with-azure-active-directory"></a>Разработка приложений ASP.NET с Azure Active Directory

по [Рик Андерсон]((https://twitter.com/RickAndMSFT))

Средства Microsoft ASP.NET для Azure Active Directory упрощает Включение проверки подлинности для веб-приложений, размещенных на [Azure](https://www.windowsazure.com/home/features/web-sites/). Проверка подлинности Azure можно использовать для проверки подлинности пользователей Office 365 из вашей организации, корпоративных учетных записей, синхронизированные из локальной службы Active Directory или пользователей, созданных в личном домене Azure Active Directory. Включение проверки подлинности Windows Azure настраивает приложение для проверки подлинности пользователей с помощью одного [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) клиента.

Этом руководстве показано, как создать приложение ASP.NET, настроенного для единого входа с [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD). Вы также узнаете, как вызвать API Graph для получения сведений о пользователе, вошедшего в систему и как развернуть приложение в Azure.

## <a name="prerequisites"></a>Предварительные требования

1. [Visual Studio Express 2013 для Web](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) или [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013).
2. [Visual Studio 2013 с обновлением 4](https://www.microsoft.com/download/details.aspx?id=44921) -требуется обновление 3 или более поздней версии.
3. Учетная запись Azure. [Щелкните здесь,](https://azure.microsoft.com/pricing/free-trial/) для получения бесплатной пробной версии, если у вас еще нет учетной записи.

## <a name="add-a-global-administrator-to-your-active-directory"></a>Добавление глобального администратора в Active Directory

1. Войдите в [портал управления Azure](https://manage.windowsazure.com/).
2. Все учетные записи Azure содержат **каталог по умолчанию** --щелкните его, а затем нажмите кнопку **пользователей** вкладки в верхней части страницы (см. рисунок ниже).
3. Нажмите кнопку Добавить пользователя.
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. Создайте нового пользователя с **глобального администратора** роли. Нажмите кнопку **пользователей** из в верхнем меню и нажмите кнопку **добавить пользователя** кнопки на панели команд.
5. В **добавить пользователя** диалоговое окно, введите имя для нового пользователя и нажмите кнопку со стрелкой вправо.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. Введите имя пользователя и задайте для роли **глобального администратора**. Глобальные администраторы требуют запасной адрес электронной почты для целей восстановления пароля. После завершения работы нажмите кнопку со стрелкой вправо.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. На следующей странице диалогового окна нажмите кнопку **создать**. Временный пароль будет создан для нового пользователя и отображаются в диалоговом окне.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)

   Этот пароль можно изменить пароль после первого входа в. На следующем рисунке показана новую учетную запись администратора. Azure Active Directory необходимо использовать для входа в приложение, а не учетной записи Майкрософт, также отображается на этой странице.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a>Создание приложения ASP.NET

В следующих действиях используется [Visual Studio Express 2013 для Web](https://www.microsoft.com/download/details.aspx?id=40747)и требует [Visual Studio 2013 с обновлением 3](https://www.microsoft.com/download/details.aspx?id=43721).

1. В Visual Studio щелкните **файл** и затем **новый проект**. На **новый проект** диалоговое окно, выберите Visual C# Web project в меню слева и нажмите кнопку **ОК**. Можно также снять **добавить Application Insights в проект** Если вы не хотите функциональные возможности для вашего приложения.
2. В **новый проект ASP.NET** диалоговом окне выберите **MVC**, а затем нажмите кнопку **изменить способ проверки подлинности**.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. На **изменить способ проверки подлинности** диалоговом окне выберите **учетные записи организации**. Эти параметры можно использовать для автоматической регистрации приложения в Azure AD, а также автоматически настроить приложение для интеграции с Azure AD. Нет необходимости использовать **изменить способ проверки подлинности** диалоговое окно для регистрации и настройки приложения, но он значительно упрощает его. Если вы используете Visual Studio 2012. Например, можно вручную зарегистрировать приложение на портале управления Azure и обновления конфигурации для интеграции с Azure AD.
   В раскрывающемся меню, выберите **облако — одна организация** и **единый вход, чтение данных каталога**. Введите имя домена для вашего каталога Azure AD (в примере ниже изображения) *aricka0yahoo.onmicrosoft.com*, а затем нажмите кнопку **ОК**. Имя домена можно получить на вкладке "домены" для каталога по умолчанию на портале azure (см. далее вниз).

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)

   Ниже показано имя домена на портале Azure.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)

    > [!NOTE]
    > При необходимости можно настроить URI идентификатора приложения, которое будет зарегистрировано в Azure AD, щелкнув **Дополнительно**. URI идентификатора приложения — это уникальный идентификатор для приложения, который был зарегистрирован в Azure AD и используется приложением для собственной идентификации при взаимодействии с Azure AD. Дополнительные сведения о URI идентификатора приложения и другие свойства зарегистрированных приложений, см. в разделе [в этом разделе](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering). Установив флажок под полем URI идентификатора приложения, можно также заменить имеющуюся регистрацию в Azure AD, который использует тот URI ИД приложения.
4. После нажатия кнопки **ОК**, появится диалоговое окно входа в систему, и вам потребуется выполнить вход с использованием учетной записи глобального администратора (не Майкрософт учетной записи, связанной с вашей подпиской). Если ранее вы создали новую учетную запись администратора, вам потребуется изменить пароль, а затем войдите в систему, используя новый пароль.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. После вы успешно прошли проверку подлинности, **новый проект ASP.NET** диалоговом окне будет показан Выбор проверки подлинности (**организации** ) и каталог, где новое приложение будет зарегистрирован (*aricka0yahoo.onmicrosoft.com* на рисунке ниже). Ниже эти сведения, установите флажок **разместить в облаке**. Если этот флажок установлен, проект подготавливается в качестве веб-приложение Azure и будут включены для простой публикации более поздней версии. Нажмите кнопку **ОК**.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. **Настройка веб-сайта Azure** появится диалоговое окно, с помощью автоматически сформированных сайта имя и регион учетной записи. Также Обратите внимание, учетная запись, которую вы вошли в диалоговом окне. Вы хотели бы убедиться, что эта учетная запись является то, что к вашей подписке Azure, обычно является учетной записью Майкрософт.

    > [!NOTE]
    > Этот проект требует базы данных. Необходимо выбрать один из существующих баз данных или создайте новую. Базы данных не требуется, поскольку проект уже использует файл локальной базы данных, чтобы сохранить небольшой объем данных конфигурации проверки подлинности. При развертывании приложения на веб-сайте Azure, эта база данных не упаковываются в развертывание, поэтому вам нужно выбрать один, который доступен в облаке. Нажмите кнопку **ОК**.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. Будет создан проект, и ваши параметры проверки подлинности и веб-приложения параметры будут автоматически настроены с проектом. После завершения этого процесса, запустить проект локально, нажав клавишу **^ F5**. Необходимо будет выполнить вход с использованием учетной записи организации. Укажите имя пользователя и пароль для учетной записи, созданной ранее и нажмите кнопку **вход**.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. После успешного входа в веб-сайте ASP.NET будет показано, что вы прошли проверку подлинности, отображая имя пользователя в правом верхнем углу страницы.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)

   Если возникает ошибка. Значение не может быть пустым или равным NULL. Имя параметра: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)

   см. в разделе [Отладка](#dbg) в конце этого руководства.

## <a name="basics-of-the-graph-api"></a>Основы API Graph

[Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) — это программный интерфейс, используемый для выполнения операций CRUD и других операций с объектами в каталоге Azure AD. Если выбран параметр учетной записи организации для проверки подлинности при создании нового проекта в Visual Studio 2013, приложение будет уже настроен для вызова Graph API. В этом разделе кратко показано, как работает Graph API.

1. В выполняемом приложении, щелкните имя пользователя, вошедшего в систему в верхней правой части страницы. Откроется на странице профиля пользователя — это действие на контроллер Home. Вы заметите, что таблица содержит пользователю сведения об учетной записи администратора, созданную ранее. Эти сведения хранятся в каталоге, и вызывает Graph API для получения этой информации при загрузке страницы.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. Вернитесь в Visual Studio и разверните **контроллеров** папку и откройте **HomeController.cs** файла. Вы увидите **UserProfile()** действие, которое содержит код для получения маркера, а затем вызвать Graph API. Этот код повторяется ниже:

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    Чтобы вызвать Graph API, необходимо сначала получить маркер. При получении маркера его строковым значением должен быть добавлен в заголовок авторизации для всех последующих запросов к Graph API. Большая часть кода выше обрабатывает сведения о проверке подлинности в Azure AD для получения маркера, использующее токен для вызова с Graph API и затем преобразование ответ таким образом, чтобы можно было представить в представлении.

    Наиболее участку обсуждение имеет следующую выделенную строку: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`. Эта строка представляет имя пользователя, который был десериализован из ответа JSON и выводятся в представлении.

    Можно вызвать API Graph, с помощью HttpClient и обработать необработанные данные вручную, но более простым способом является использование [Graph клиентскую библиотеку, которая доступна в NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/). Клиентская библиотека обрабатывает необработанных HTTP-запросов и преобразования возвращаемых данных для вас и значительно упрощает для работы с API Graph в среде .NET. Просмотрите связанные примеры кода Graph API на [GitHub.](https://github.com/AzureADSamples)

## <a name="deploy-the-application-to-azure"></a>Развертывание приложения в Azure

Ниже будет показано, как развернуть приложение в Azure. На предыдущих этапах подключен нового проекта с веб-приложения в Azure, чтобы подготовить для публикации в всего за несколько шагов.

1. В Visual Studio щелкните правой кнопкой мыши проект и выберите **публикации**. **Веб-публикации** с каждым параметром, который уже настроен, появится диалоговое окно. Щелкните **Далее** кнопку, чтобы перейти к **параметры** страницы. Вам может быть предложено пройти проверку подлинности; Убедитесь, что проверка подлинности с помощью учетной записи подписки Azure (обычно учетная запись Майкрософт) и не учетная запись организации, созданную ранее.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. Проверьте **Включение аутентификации в организации** параметр. В **домена** введите домен для каталога. Из **уровень доступа** раскрывающегося списка, выберите **единый вход, чтение данных каталога**. Вы заметите, что Прежняя база данных использовалась уже заполняется **баз данных** раздел. Нажмите кнопку **Опубликовать**.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. Visual Studio начнет развертывание веб-сайта, а затем появится новое окно браузера. Может быть предложено проходить проверку подлинности вашего каталога еще раз. Как только вы прошли проверку подлинности, вы будете перенаправлены на только что опубликованный веб-сайт в Azure.

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a>Отладка приложения

Если возникнет следующая ошибка: Значение не может быть пустым или равным NULL. Имя параметра: linkText

![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)


Замените код в *Views\Shared\\_LoginPartial.cshtml* файл со следующими:

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

После запуска приложения, если пользователь показывает «Значения Null для пользователя», выйдите из системы и снова войдите под учетной записью Active Directory, созданную ранее.

Rick Rainey является отличным руководству, чтобы следовать [глубокое погружение в обработку: Веб-сайтов и аутентификации в организации с помощью Azure AD Azure](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).

## <a name="more-information"></a>Дополнительные сведения

- [Подробный обзор: Azure веб-сайтов и аутентификации в организации с помощью Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)
- [Общие сведения об API Graph Azure AD](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [Сценарии проверки подлинности в Azure AD](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [Примеры кода Azure AD на GitHub](https://github.com/AzureADSamples)
