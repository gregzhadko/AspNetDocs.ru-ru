---
uid: identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
title: Добавление ASP.NET Identity к пустой или существующий веб-проект форм | Документация Майкрософт
author: raquelsa
description: Этом руководстве показано, как добавление ASP.NET Identity (новая система членства для ASP.NET) в приложение ASP.NET. При создании нового веб-форм или MVC...
ms.author: riande
ms.date: 01/22/2019
ms.assetid: 1cbc0ed2-5bd6-4b62-8d34-4c193dcd8b25
msc.legacyurl: /identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
msc.type: authoredcontent
ms.openlocfilehash: cd28cc68db96b52eb205b8764aa2af014ffad9c3
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57038281"
---
# <a name="adding-aspnet-identity-to-an-empty-or-existing-web-forms-project"></a><span data-ttu-id="7546c-104">Добавление ASP.NET Identity в пустой или существующий проект веб-форм</span><span class="sxs-lookup"><span data-stu-id="7546c-104">Adding ASP.NET Identity to an Empty or Existing Web Forms Project</span></span>


> <span data-ttu-id="7546c-105">Этот учебник демонстрирует добавление [ASP.NET Identity](introduction-to-aspnet-identity.md) (новая система членства для ASP.NET) для приложений ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="7546c-105">This tutorial shows you how to add [ASP.NET Identity](introduction-to-aspnet-identity.md) (the new membership system for ASP.NET) to an ASP.NET application.</span></span>
> 
> <span data-ttu-id="7546c-106">При создании нового проекта веб-форм или MVC в Visual Studio 2017 RTM отдельные учетные записи Visual Studio установите все необходимые пакеты и добавить все необходимые классы для вас.</span><span class="sxs-lookup"><span data-stu-id="7546c-106">When you create a new Web Forms or MVC project in Visual Studio 2017 RTM with Individual Accounts, Visual Studio will install all the required packages and add all necessary classes for you.</span></span> <span data-ttu-id="7546c-107">Этот учебник будет покажем, как добавить поддержку ASP.NET Identity в существующий проект веб-форм или новый пустой проект.</span><span class="sxs-lookup"><span data-stu-id="7546c-107">This tutorial will illustrate the steps to add ASP.NET Identity support to your existing Web Forms project or a new empty project.</span></span> <span data-ttu-id="7546c-108">Я рассмотрю все пакеты NuGet, которые необходимо установить и классы, которые необходимо добавить.</span><span class="sxs-lookup"><span data-stu-id="7546c-108">I will outline all the NuGet packages you need to install, and classes you need to add.</span></span> <span data-ttu-id="7546c-109">Я будут рассмотрены пример веб-форм для регистрации новых пользователей и вход в систему, выделите все основные элементы точки API-интерфейсы для управления пользователями и проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="7546c-109">I will go over sample Web Forms for registering new users and logging in while highlighting all main entry point APIs for user management and authentication.</span></span> <span data-ttu-id="7546c-110">В этом примере будет использоваться реализация по умолчанию ASP.NET Identity для хранилища данных SQL, которая построена на платформе Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="7546c-110">This sample will use the ASP.NET Identity default implementation for SQL data storage which is built on Entity Framework.</span></span> <span data-ttu-id="7546c-111">Этом руководстве мы будем использовать LocalDB для базы данных SQL.</span><span class="sxs-lookup"><span data-stu-id="7546c-111">This tutorial, we will use LocalDB for the SQL database.</span></span>
> 

## <a name="get-started-with-aspnet-identity"></a><span data-ttu-id="7546c-112">Начало работы с ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="7546c-112">Get started with ASP.NET Identity</span></span>

1. <span data-ttu-id="7546c-113">Начните с установки и запуска [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span><span class="sxs-lookup"><span data-stu-id="7546c-113">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span></span>
2. <span data-ttu-id="7546c-114">Выберите **новый проект** от начала страницы, или можно использовать меню и выберите **файл**, а затем **новый проект**.</span><span class="sxs-lookup"><span data-stu-id="7546c-114">Select **New Project** from the Start page, or you can use the menu and select **File**, and then **New Project**.</span></span>
3. <span data-ttu-id="7546c-115">В левой области разверните **Visual C#** , а затем выберите **Web**, затем **веб-приложение ASP.NET (.Net Framework)**.</span><span class="sxs-lookup"><span data-stu-id="7546c-115">In the left pane, expand **Visual C#**, then select **Web**, then **ASP.NET Web Application (.Net Framework)**.</span></span> <span data-ttu-id="7546c-116">Присвойте проекту имя «WebFormsIdentity» и выберите **ОК**.</span><span class="sxs-lookup"><span data-stu-id="7546c-116">Name your project "WebFormsIdentity" and select **OK**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image17.png)
4. <span data-ttu-id="7546c-117">В **новый проект ASP.NET** диалоговом окне выберите **пустой** шаблона.</span><span class="sxs-lookup"><span data-stu-id="7546c-117">In the **New ASP.NET Project** dialog, select the **Empty** template.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image2.png)  
  
   <span data-ttu-id="7546c-118">Обратите внимание, что **изменить способ проверки подлинности** кнопка отключена, поддержка проверки подлинности, не предоставляется в этом шаблоне.</span><span class="sxs-lookup"><span data-stu-id="7546c-118">Notice the **Change Authentication** button is disabled and no authentication support is provided in this template.</span></span> <span data-ttu-id="7546c-119">Шаблоны веб-форм, MVC и веб-API позволяют выбрать подход к проверке подлинности.</span><span class="sxs-lookup"><span data-stu-id="7546c-119">The Web Forms, MVC and Web API templates allow you to select the authentication approach.</span></span>

## <a name="add-identity-packages-to-your-app"></a><span data-ttu-id="7546c-120">Добавление пакетов удостоверений в приложение</span><span class="sxs-lookup"><span data-stu-id="7546c-120">Add Identity packages to your app</span></span>

<span data-ttu-id="7546c-121">В обозревателе решений щелкните правой кнопкой мыши проект и выберите **управление пакетами NuGet**.</span><span class="sxs-lookup"><span data-stu-id="7546c-121">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="7546c-122">Найдите и установите **Microsoft.AspNet.Identity.EntityFramework** пакета.</span><span class="sxs-lookup"><span data-stu-id="7546c-122">Search for and install the **Microsoft.AspNet.Identity.EntityFramework** package.</span></span> 
  
![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image15.png)
  
<span data-ttu-id="7546c-123">Обратите внимание на то, что этот пакет устанавливается пакеты зависимостей: **EntityFramework** и **Core Microsoft ASP.NET Identity**.</span><span class="sxs-lookup"><span data-stu-id="7546c-123">Note that this package will install the dependency packages: **EntityFramework** and **Microsoft ASP.NET Identity Core**.</span></span>

## <a name="add-a-web-form-to-register-users"></a><span data-ttu-id="7546c-124">Добавьте веб-форму для регистрации пользователей</span><span class="sxs-lookup"><span data-stu-id="7546c-124">Add a web form to register users</span></span>

1. <span data-ttu-id="7546c-125">В **обозревателе решений**, щелкните правой кнопкой мыши проект и выберите **добавить**, а затем **веб-формы**.</span><span class="sxs-lookup"><span data-stu-id="7546c-125">In **Solution Explorer**, right-click your project and select **Add**, and then **Web Form**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image4.png)
2. <span data-ttu-id="7546c-126">В **указания имени элемента** диалоговом окне имя новой веб-формы **зарегистрировать**, а затем выберите **ОК**</span><span class="sxs-lookup"><span data-stu-id="7546c-126">In the **Specify Name for Item** dialog box, name the new web form **Register**, and then select **OK**</span></span>
3. <span data-ttu-id="7546c-127">Замените существующую разметку в созданном *Register.aspx* файла следующим кодом.</span><span class="sxs-lookup"><span data-stu-id="7546c-127">Replace the markup in the generated *Register.aspx* file with the code below.</span></span> <span data-ttu-id="7546c-128">Изменения в коде выделены.</span><span class="sxs-lookup"><span data-stu-id="7546c-128">The code changes are highlighted.</span></span> 

    [!code-html[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample1.aspx?highlight=9,12-40)]

    > [!NOTE]
    > <span data-ttu-id="7546c-129">Это просто упрощенную версию *Register.aspx* файл, который создается при создании нового проекта веб-форм ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="7546c-129">This is just a simplified version of the *Register.aspx* file that is created when you create a new ASP.NET Web Forms project.</span></span> <span data-ttu-id="7546c-130">Приведенная выше разметка добавляет поля формы и кнопку для регистрации нового пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-130">The markup above adds form fields and a button to register a new user.</span></span>
4. <span data-ttu-id="7546c-131">Откройте *Register.aspx.cs* файл и замените содержимое файла следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="7546c-131">Open the *Register.aspx.cs* file and replace the contents of the file with the following code:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample2.cs)]

    > [!NOTE] 
    > 
    > 1. <span data-ttu-id="7546c-132">Приведенный выше код представляет упрощенную версию *Register.aspx.cs* файл, который создается при создании нового проекта веб-форм ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="7546c-132">The code above is a simplified version of the *Register.aspx.cs* file that is created when you create a new ASP.NET Web Forms project.</span></span>
    > 2. <span data-ttu-id="7546c-133">*IdentityUser* класс является реализацией по умолчанию EntityFramework *IUser* интерфейс.</span><span class="sxs-lookup"><span data-stu-id="7546c-133">The *IdentityUser* class is the default EntityFramework implementation of the *IUser* interface.</span></span> <span data-ttu-id="7546c-134">*IUser* это минимальный интерфейс для пользователя на удостоверение ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="7546c-134">*IUser* interface is the minimal interface for a user on ASP.NET Identity Core.</span></span>
    > 3. <span data-ttu-id="7546c-135">*UserStore* класс является реализацией EntityFramework по умолчанию из хранилища пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-135">The *UserStore* class is the default EntityFramework implementation of a user store.</span></span> <span data-ttu-id="7546c-136">Этот класс реализует минимальным количеством интерфейсов удостоверения ASP.NET Core: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* и *IUserRoleStore*.</span><span class="sxs-lookup"><span data-stu-id="7546c-136">This class implements the ASP.NET Identity Core's minimal interfaces: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* and *IUserRoleStore*.</span></span>
    > 4. <span data-ttu-id="7546c-137">*UserManager* класс предоставляет связанный с пользователем API-интерфейсов, который автоматически сохранит изменения *UserStore*.</span><span class="sxs-lookup"><span data-stu-id="7546c-137">The *UserManager* class exposes user related APIs which will automatically save changes to the *UserStore*.</span></span>
    > 5. <span data-ttu-id="7546c-138">*IdentityResult* класса представляет результат операции identity.</span><span class="sxs-lookup"><span data-stu-id="7546c-138">The *IdentityResult* class represents the result of an identity operation.</span></span>
5. <span data-ttu-id="7546c-139">В **обозревателе решений**, щелкните правой кнопкой мыши проект и выберите **добавить**, **добавить папку ASP.NET** и затем **приложения\_данных**.</span><span class="sxs-lookup"><span data-stu-id="7546c-139">In **Solution Explorer**, right-click your project and select **Add**, **Add ASP.NET Folder** and then **App\_Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image5.png)
6. <span data-ttu-id="7546c-140">Откройте *Web.config* файл и добавьте запись строки соединения для базы данных, мы будем использовать для хранения пользовательских данных.</span><span class="sxs-lookup"><span data-stu-id="7546c-140">Open the *Web.config* file and add a connection string entry for the database we will use to store user information.</span></span> <span data-ttu-id="7546c-141">Базы данных создается во время выполнения, EntityFramework для идентификации сущностей.</span><span class="sxs-lookup"><span data-stu-id="7546c-141">The database will be created at runtime by EntityFramework for the Identity entities.</span></span> <span data-ttu-id="7546c-142">Строка подключения похожа на один создаются автоматически при создании проекта веб-форм.</span><span class="sxs-lookup"><span data-stu-id="7546c-142">The connection string is similar to one created for you when you create a new Web Forms project.</span></span> <span data-ttu-id="7546c-143">Выделенный код показана разметка, который необходимо добавить:</span><span class="sxs-lookup"><span data-stu-id="7546c-143">The highlighted code shows the markup you should add:</span></span>

    [!code-xml[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample3.xml?highlight=11-14)]
    
    > [!NOTE] 
    > <span data-ttu-id="7546c-144">Для Visual Studio 2015 или более поздней версии, замените `(localdb)\v11.0` с `(localdb)\MSSQLLocalDB` в строке подключения.</span><span class="sxs-lookup"><span data-stu-id="7546c-144">For Visual Studio 2015 or higher, replace `(localdb)\v11.0` with `(localdb)\MSSQLLocalDB` in your connection string.</span></span>
    
7. <span data-ttu-id="7546c-145">Щелкните правой кнопкой мыши файл *Register.aspx* в проект, выберите **задать в качестве начальной страницы**.</span><span class="sxs-lookup"><span data-stu-id="7546c-145">Right click file *Register.aspx* in your project and select **Set as Start Page**.</span></span> <span data-ttu-id="7546c-146">Нажмите клавиши Ctrl + F5 для сборки и запуска веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="7546c-146">Press Ctrl + F5 to build and run the web application.</span></span> <span data-ttu-id="7546c-147">Введите новое имя пользователя и пароль, а затем выберите **зарегистрировать**.</span><span class="sxs-lookup"><span data-stu-id="7546c-147">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image6.png)  

    > [!NOTE]
    > <span data-ttu-id="7546c-148">Удостоверение ASP.NET имеет поддержку проверки и в этом примере можно проверить поведение по умолчанию для пользователя и пароль проверяющие элементы управления, полученные из удостоверения основного пакета.</span><span class="sxs-lookup"><span data-stu-id="7546c-148">ASP.NET Identity has support for validation and in this sample you can verify the default behavior on User and Password validators that come from the Identity Core package.</span></span> <span data-ttu-id="7546c-149">Проверяющий элемент управления по умолчанию для пользователя (`UserValidator`) имеет свойство `AllowOnlyAlphanumericUserNames` , имеет значение по умолчанию, равным `true`.</span><span class="sxs-lookup"><span data-stu-id="7546c-149">The default validator for User (`UserValidator`) has a property `AllowOnlyAlphanumericUserNames` that has default value set to `true`.</span></span> <span data-ttu-id="7546c-150">Проверяющий элемент управления по умолчанию для пароля (`MinimumLengthValidator`) гарантирует, что пароль имеет по крайней мере 6 символов.</span><span class="sxs-lookup"><span data-stu-id="7546c-150">The default validator for Password (`MinimumLengthValidator`) ensures that password has at least 6 characters.</span></span> <span data-ttu-id="7546c-151">Эти проверяющие элементы управления являются свойствами на `UserManager` , можно переопределить, чтобы пользовательская проверка</span><span class="sxs-lookup"><span data-stu-id="7546c-151">These validators are properties on `UserManager` that can be overridden if you want to have custom validation,</span></span>

## <a name="verify-the-localdb-identity-database-and-tables-generated-by-entity-framework"></a><span data-ttu-id="7546c-152">Проверка базы данных LocalDb удостоверений и таблиц, созданным Entity Framework</span><span class="sxs-lookup"><span data-stu-id="7546c-152">Verify the LocalDb Identity database and tables generated by Entity Framework</span></span>

1. <span data-ttu-id="7546c-153">В **представление** меню, выберите **обозревателя серверов**.</span><span class="sxs-lookup"><span data-stu-id="7546c-153">In the **View** menu, select **Server Explorer**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image7.png)
2. <span data-ttu-id="7546c-154">Разверните **DefaultConnection (WebFormsIdentity)**, разверните **таблиц**, щелкните правой кнопкой мыши **AspNetUsers** , а затем выберите **Показать таблицу данных**.</span><span class="sxs-lookup"><span data-stu-id="7546c-154">Expand **DefaultConnection (WebFormsIdentity)**, expand **Tables**, right-click **AspNetUsers** and then select **Show Table Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image8.png)  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image9.png)

## <a name="configure-the-application-for-owin-authentication"></a><span data-ttu-id="7546c-155">Настройка приложения для проверки подлинности OWIN</span><span class="sxs-lookup"><span data-stu-id="7546c-155">Configure the application for OWIN authentication</span></span>

<span data-ttu-id="7546c-156">На этом этапе только добавлена поддержка создания пользователей.</span><span class="sxs-lookup"><span data-stu-id="7546c-156">At this point we have only added support for creating users.</span></span> <span data-ttu-id="7546c-157">Теперь мы собираемся продемонстрировать, как мы можем добавить проверку подлинности для входа в систему пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-157">Now, we are going to demonstrate how we can add authentication to login a user.</span></span> <span data-ttu-id="7546c-158">ASP.NET Identity использует Microsoft OWIN по промежуточного слоя для проверки подлинности форм.</span><span class="sxs-lookup"><span data-stu-id="7546c-158">ASP.NET Identity uses Microsoft OWIN Authentication middleware for forms authentication.</span></span> <span data-ttu-id="7546c-159">Файл Cookie проверки подлинности OWIN, является файлом cookie и утверждений проверки подлинности на основе механизм, который может использоваться любой платформой, размещенных на [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) или IIS.</span><span class="sxs-lookup"><span data-stu-id="7546c-159">The OWIN Cookie Authentication is a cookie and claims based authentication mechanism that can be used by any framework hosted on [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) or IIS.</span></span> <span data-ttu-id="7546c-160">В этой модели можно использовать те же пакеты проверки подлинности на нескольких платформах, включая ASP.NET MVC и Web Forms.</span><span class="sxs-lookup"><span data-stu-id="7546c-160">With this model, the same authentication packages can be used across multiple frameworks including ASP.NET MVC and Web Forms.</span></span> <span data-ttu-id="7546c-161">Дополнительные сведения о проекта Katana и способах выполнения по промежуточного слоя. в разделе, зависит от узла [Приступая к работе с проектом Katana](https://msdn.microsoft.com/magazine/dn451439.aspx).</span><span class="sxs-lookup"><span data-stu-id="7546c-161">For more information on project Katana and how to run middleware in a host agnostic see [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx).</span></span>

## <a name="install-authentication-packages-to-your-application"></a><span data-ttu-id="7546c-162">Установить пакеты проверки подлинности в приложение</span><span class="sxs-lookup"><span data-stu-id="7546c-162">Install authentication packages to your application</span></span>

1. <span data-ttu-id="7546c-163">В обозревателе решений щелкните правой кнопкой мыши проект и выберите **управление пакетами NuGet**.</span><span class="sxs-lookup"><span data-stu-id="7546c-163">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="7546c-164">Найдите и установите ***Microsoft.AspNet.Identity.Owin*** пакета.</span><span class="sxs-lookup"><span data-stu-id="7546c-164">Search for and install the ***Microsoft.AspNet.Identity.Owin*** package.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image16.png)

2. <span data-ttu-id="7546c-165">Найдите и установите ***Microsoft.Owin.Host.SystemWeb*** пакета.</span><span class="sxs-lookup"><span data-stu-id="7546c-165">Search for and install the ***Microsoft.Owin.Host.SystemWeb*** package.</span></span>

    > [!NOTE]
    > <span data-ttu-id="7546c-166">**Microsoft.Aspnet.Identity.Owin** пакет содержит набор классов расширения OWIN для управления и настройки по промежуточного слоя проверки подлинности OWIN для использования процессом пакеты ASP.NET Identity Core.</span><span class="sxs-lookup"><span data-stu-id="7546c-166">The **Microsoft.Aspnet.Identity.Owin** package contains a set of OWIN extension classes to manage and configure OWIN authentication middleware to be consumed by ASP.NET Identity Core packages.</span></span>
    > <span data-ttu-id="7546c-167">**Microsoft.Owin.Host.SystemWeb** пакет содержит это сервер OWIN, который позволяет приложениям на базе OWIN для запуска в IIS с помощью конвейера запросов ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="7546c-167">The **Microsoft.Owin.Host.SystemWeb** package contains an OWIN server that enables OWIN-based applications to run on IIS using the ASP.NET request pipeline.</span></span> <span data-ttu-id="7546c-168">Дополнительные сведения см. в разделе [по промежуточного слоя OWIN в службах IIS интегрирован конвейера](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span><span class="sxs-lookup"><span data-stu-id="7546c-168">For more information see [OWIN Middleware in the IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span></span>

## <a name="add-owin-startup-and-authentication-configuration-classes"></a><span data-ttu-id="7546c-169">Добавление классов конфигурации запуска и проверки подлинности OWIN</span><span class="sxs-lookup"><span data-stu-id="7546c-169">Add OWIN startup and authentication configuration classes</span></span>

1. <span data-ttu-id="7546c-170">В **обозревателе решений**, щелкните правой кнопкой мыши проект, выберите **добавить**, а затем **Добавление нового элемента**.</span><span class="sxs-lookup"><span data-stu-id="7546c-170">In **Solution Explorer**, right-click your project, select **Add**, and then **Add New Item**.</span></span> <span data-ttu-id="7546c-171">В диалоговом поле поиска текста, введите "*owin*«.</span><span class="sxs-lookup"><span data-stu-id="7546c-171">In the search text box dialog, type "*owin*".</span></span> <span data-ttu-id="7546c-172">Имя класса "*запуска*" и выберите **добавить**.</span><span class="sxs-lookup"><span data-stu-id="7546c-172">Name the class "*Startup*" and select **Add**.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image11.png)
2. <span data-ttu-id="7546c-173">В файле Startup.cs добавьте выделенный код, показано ниже, чтобы настроить проверку подлинности файла cookie OWIN.</span><span class="sxs-lookup"><span data-stu-id="7546c-173">In the Startup.cs file, add the highlighted code shown below to configure OWIN cookie authentication.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample4.cs?highlight=1,3,15-19)]

    > [!NOTE]
    > <span data-ttu-id="7546c-174">Этот класс содержит `OwinStartup` атрибут для указания класса запуска OWIN.</span><span class="sxs-lookup"><span data-stu-id="7546c-174">This class contains the `OwinStartup` attribute for specifying the OWIN startup class.</span></span> <span data-ttu-id="7546c-175">Каждое приложение OWIN имеет класс запуска, где указываются компоненты конвейера приложения.</span><span class="sxs-lookup"><span data-stu-id="7546c-175">Every OWIN application has a startup class where you specify components for the application pipeline.</span></span> <span data-ttu-id="7546c-176">См. в разделе [определение класса запуска OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) Дополнительные сведения об этой модели.</span><span class="sxs-lookup"><span data-stu-id="7546c-176">See [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) for more info on this model.</span></span>

## <a name="add-web-forms-for-registering-and-signing-in-users"></a><span data-ttu-id="7546c-177">Добавление веб-форм для регистрации и входа пользователей</span><span class="sxs-lookup"><span data-stu-id="7546c-177">Add web forms for registering and signing in users</span></span>

1. <span data-ttu-id="7546c-178">Откройте *Register.aspx.cs* файл и добавьте приведенный ниже код какие выполняет вход пользователь при успешной регистрации.</span><span class="sxs-lookup"><span data-stu-id="7546c-178">Open the *Register.aspx.cs* file and add the following code which signs in the user when registration succeeds.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample5.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="7546c-179">Так как ASP.NET Identity и OWIN файл Cookie проверки подлинности на основе утверждений системы, платформы требует, чтобы разработчик приложений для создания [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) для пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-179">Since ASP.NET Identity and OWIN Cookie Authentication are claims based system, the framework requires the app developer to generate a [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) for the user.</span></span> <span data-ttu-id="7546c-180">ClaimsIdentity имеет сведения о все утверждения для пользователя, например пользователь принадлежит к роли.</span><span class="sxs-lookup"><span data-stu-id="7546c-180">ClaimsIdentity has information about all the claims for the user such as what Roles the user belongs to.</span></span> <span data-ttu-id="7546c-181">На этом этапе можно также добавить дополнительные утверждения для пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-181">You can also add more claims for the user at this stage.</span></span>
    > - <span data-ttu-id="7546c-182">Можно вход пользователя с помощью AuthenticationManager из OWIN и вызывая метод `SignIn` и передавая ClaimsIdentity, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="7546c-182">You can sign in the user by using the AuthenticationManager from OWIN and calling `SignIn` and passing in the ClaimsIdentity as shown above.</span></span> <span data-ttu-id="7546c-183">Этот код будет вход пользователя и создать файл cookie также.</span><span class="sxs-lookup"><span data-stu-id="7546c-183">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="7546c-184">Этот вызов является аналогом [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) используемые [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) модуля.</span><span class="sxs-lookup"><span data-stu-id="7546c-184">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
2. <span data-ttu-id="7546c-185">В **обозревателе решений**, щелкните правой кнопкой мыши проект, выберите **добавить**, а затем **веб-формы**.</span><span class="sxs-lookup"><span data-stu-id="7546c-185">In **Solution Explorer**, right-click your project, select **Add**, and then **Web Form**.</span></span> <span data-ttu-id="7546c-186">Имя веб-формы **входа**.</span><span class="sxs-lookup"><span data-stu-id="7546c-186">Name the web form **Login**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image12.png)
3. <span data-ttu-id="7546c-187">Замените содержимое файла *Login.aspx* файла следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="7546c-187">Replace the contents of the *Login.aspx* file with the following code:</span></span>

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample6.aspx)]
4. <span data-ttu-id="7546c-188">Замените содержимое файла *Login.aspx.cs* файл со следующими:</span><span class="sxs-lookup"><span data-stu-id="7546c-188">Replace the contents of the *Login.aspx.cs* file with the following:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample7.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="7546c-189">`Page_Load` Теперь проверяет состояние текущего пользователя и выполняет действия на основе его `Context.User.Identity.IsAuthenticated` состояния.</span><span class="sxs-lookup"><span data-stu-id="7546c-189">The `Page_Load` now checks for the status of current user and takes action based on its `Context.User.Identity.IsAuthenticated` status.</span></span>
    >     <span data-ttu-id="7546c-190">**Отображение вход от имени пользователя** : Инфраструктуру идентификации Microsoft ASP.NET перечислил методы расширения в [System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) , позволит вам получить `UserName` и `UserId` для вошедшего в систему пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-190">**Display Logged in User Name** : The Microsoft ASP.NET Identity Framework has added extension methods on [System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) that allows you to get the `UserName` and `UserId`  for the logged in User.</span></span> <span data-ttu-id="7546c-191">Эти методы расширения определяются в `Microsoft.AspNet.Identity.Core` сборки.</span><span class="sxs-lookup"><span data-stu-id="7546c-191">These extension methods are defined in the `Microsoft.AspNet.Identity.Core` assembly.</span></span> <span data-ttu-id="7546c-192">Эти методы расширения являются заменой [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span><span class="sxs-lookup"><span data-stu-id="7546c-192">These extension methods are the replacement for [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span></span>
    > - <span data-ttu-id="7546c-193">Метод входа: `This` метод заменяет предыдущий `CreateUser_Click` метод в этом примере и теперь выполняет вход пользователь после успешного создания пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-193">SignIn method: `This` method replaces the previous `CreateUser_Click` method in this sample and now signs in the user after successfully creating the user.</span></span>   
    >   <span data-ttu-id="7546c-194">Платформа Microsoft OWIN перечислил методы расширения в `System.Web.HttpContext` , позволит вам получить ссылку на `IOwinContext`.</span><span class="sxs-lookup"><span data-stu-id="7546c-194">The Microsoft OWIN Framework has added extension methods on `System.Web.HttpContext` that allows you to get a reference to an `IOwinContext`.</span></span> <span data-ttu-id="7546c-195">Эти методы расширения определяются в `Microsoft.Owin.Host.SystemWeb` сборки.</span><span class="sxs-lookup"><span data-stu-id="7546c-195">These extension methods are defined in `Microsoft.Owin.Host.SystemWeb` assembly.</span></span> <span data-ttu-id="7546c-196">`OwinContext` Предоставляет `IAuthenticationManager` свойство, которое представляет функциональные возможности по промежуточного слоя проверки подлинности, доступные в текущем запросе.</span><span class="sxs-lookup"><span data-stu-id="7546c-196">The `OwinContext` class exposes an `IAuthenticationManager` property that represents the Authentication middleware functionality available on the current request.</span></span> <span data-ttu-id="7546c-197">Пользователь может войти с помощью `AuthenticationManager` из OWIN и вызвав `SignIn` и передавая `ClaimsIdentity` как показано выше.</span><span class="sxs-lookup"><span data-stu-id="7546c-197">You can sign in the user by using the `AuthenticationManager` from OWIN and calling `SignIn` and passing in the `ClaimsIdentity` as shown above.</span></span> <span data-ttu-id="7546c-198">Поскольку ASP.NET Identity и OWIN файл Cookie проверки подлинности на основе утверждений система, платформа требует приложение, чтобы создать `ClaimsIdentity` для пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-198">Because ASP.NET Identity and OWIN Cookie Authentication are claims-based system, the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="7546c-199">`ClaimsIdentity` Со сведениями о все утверждения для пользователя, например пользователь принадлежит к роли.</span><span class="sxs-lookup"><span data-stu-id="7546c-199">The `ClaimsIdentity` has information about all the claims for the user, such as what roles the user belongs to.</span></span> <span data-ttu-id="7546c-200">На этом этапе, этот код будет вход пользователя и создать файл cookie также можно также добавить дополнительные утверждения для пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-200">You can also add more claims for the user at this stage This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="7546c-201">Этот вызов является аналогом [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) используемые [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) модуля.</span><span class="sxs-lookup"><span data-stu-id="7546c-201">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
    > - <span data-ttu-id="7546c-202">`SignOut` метод: Получает ссылку на `AuthenticationManager` из OWIN и вызывает `SignOut`.</span><span class="sxs-lookup"><span data-stu-id="7546c-202">`SignOut` method: Gets a reference to the `AuthenticationManager` from OWIN and calls `SignOut`.</span></span> <span data-ttu-id="7546c-203">Это аналогично [FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) метод, используемый [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) модуля.</span><span class="sxs-lookup"><span data-stu-id="7546c-203">This is analogous to [FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) method used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
5. <span data-ttu-id="7546c-204">Нажмите клавишу **Ctrl + F5** для сборки и запуска веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="7546c-204">Press **Ctrl + F5** to build and run the web application.</span></span> <span data-ttu-id="7546c-205">Введите новое имя пользователя и пароль, а затем выберите **зарегистрировать**.</span><span class="sxs-lookup"><span data-stu-id="7546c-205">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image13.png)  
   <span data-ttu-id="7546c-206">Примечание. На этом этапе создается и вход нового пользователя.</span><span class="sxs-lookup"><span data-stu-id="7546c-206">Note: At this point, the new user is created and logged in.</span></span>
6. <span data-ttu-id="7546c-207">Выберите **Выход** кнопки.</span><span class="sxs-lookup"><span data-stu-id="7546c-207">Select the **Log out** button.</span></span> <span data-ttu-id="7546c-208">Вы будете перенаправлены в журнале в форме.</span><span class="sxs-lookup"><span data-stu-id="7546c-208">You are redirected to the Log in form.</span></span>
7. <span data-ttu-id="7546c-209">Введите пароль или недопустимое имя пользователя и выберите **вход** кнопки.</span><span class="sxs-lookup"><span data-stu-id="7546c-209">Enter an invalid user name or password and select the **Log in** button.</span></span> 
   <span data-ttu-id="7546c-210">`UserManager.Find` Метод вернет значение null, а сообщение об ошибке: " *Недопустимое имя пользователя или пароль* «будет отображаться.</span><span class="sxs-lookup"><span data-stu-id="7546c-210">The `UserManager.Find`  method will return null and the error message: " *Invalid user name or password* " will be displayed.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image14.png)
