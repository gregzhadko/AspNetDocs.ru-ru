---
uid: identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
title: Добавление ASP.NET Identity в пустой или существующий проект Web Forms — ASP.NET 4. x
author: raquelsa
description: В этом руководстве показано, как добавить ASP.NET Identity (систему членства для ASP.NET) в приложение ASP.NET. При создании новой веб-формы или MVC...
ms.author: riande
ms.date: 01/22/2019
ms.assetid: 1cbc0ed2-5bd6-4b62-8d34-4c193dcd8b25
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
msc.type: authoredcontent
ms.openlocfilehash: 8e82951d57f0b8052ee3f6530a7470be7d030206
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78471978"
---
# <a name="adding-aspnet-identity-to-an-empty-or-existing-web-forms-project"></a><span data-ttu-id="c05c2-104">Добавление ASP.NET Identity в пустой или существующий проект веб-форм</span><span class="sxs-lookup"><span data-stu-id="c05c2-104">Adding ASP.NET Identity to an Empty or Existing Web Forms Project</span></span>

> <span data-ttu-id="c05c2-105">В этом руководстве показано, как добавить [ASP.NET Identity](introduction-to-aspnet-identity.md) (новую систему членства для ASP.NET) в приложение ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="c05c2-105">This tutorial shows you how to add [ASP.NET Identity](introduction-to-aspnet-identity.md) (the new membership system for ASP.NET) to an ASP.NET application.</span></span>
> 
> <span data-ttu-id="c05c2-106">При создании нового веб-формы или проекта MVC в Visual Studio 2017 RTM с отдельными учетными записями Visual Studio установит все необходимые пакеты и добавит все необходимые классы.</span><span class="sxs-lookup"><span data-stu-id="c05c2-106">When you create a new Web Forms or MVC project in Visual Studio 2017 RTM with Individual Accounts, Visual Studio will install all the required packages and add all necessary classes for you.</span></span> <span data-ttu-id="c05c2-107">В этом учебнике показано, как добавить поддержку ASP.NET Identity в существующий проект Web Forms или новый пустой проект.</span><span class="sxs-lookup"><span data-stu-id="c05c2-107">This tutorial will illustrate the steps to add ASP.NET Identity support to your existing Web Forms project or a new empty project.</span></span> <span data-ttu-id="c05c2-108">Я буду структурировать все пакеты NuGet, которые необходимо установить, и классы, которые необходимо добавить.</span><span class="sxs-lookup"><span data-stu-id="c05c2-108">I will outline all the NuGet packages you need to install, and classes you need to add.</span></span> <span data-ttu-id="c05c2-109">Мы рассмотрим пример веб-форм для регистрации новых пользователей и входа в систему, выделяя все основные интерфейсы API точки входа для управления пользователями и проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="c05c2-109">I will go over sample Web Forms for registering new users and logging in while highlighting all main entry point APIs for user management and authentication.</span></span> <span data-ttu-id="c05c2-110">В этом примере будет использоваться реализация ASP.NET Identity по умолчанию для хранилища данных SQL, созданная на основе Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="c05c2-110">This sample will use the ASP.NET Identity default implementation for SQL data storage which is built on Entity Framework.</span></span> <span data-ttu-id="c05c2-111">В этом руководстве мы будем использовать LocalDB для базы данных SQL.</span><span class="sxs-lookup"><span data-stu-id="c05c2-111">This tutorial, we will use LocalDB for the SQL database.</span></span>
> 

## <a name="get-started-with-aspnet-identity"></a><span data-ttu-id="c05c2-112">Начало работы с ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="c05c2-112">Get started with ASP.NET Identity</span></span>

1. <span data-ttu-id="c05c2-113">Начните с установки и запуска [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span><span class="sxs-lookup"><span data-stu-id="c05c2-113">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span></span>
2. <span data-ttu-id="c05c2-114">Выберите **Новый проект** на начальной странице, либо используйте меню, выберите **файл**, а затем — **Новый проект**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-114">Select **New Project** from the Start page, or you can use the menu and select **File**, and then **New Project**.</span></span>
3. <span data-ttu-id="c05c2-115">В левой области разверните узел **визуальный C#** элемент, затем выберите **веб**, а затем — веб **-приложение ASP.NET (.NET Framework)** .</span><span class="sxs-lookup"><span data-stu-id="c05c2-115">In the left pane, expand **Visual C#**, then select **Web**, then **ASP.NET Web Application (.Net Framework)**.</span></span> <span data-ttu-id="c05c2-116">Присвойте проекту имя "Вебформсидентити" и нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-116">Name your project "WebFormsIdentity" and select **OK**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image17.png)
4. <span data-ttu-id="c05c2-117">В диалоговом окне **Новый проект ASP.NET** выберите **пустой** шаблон.</span><span class="sxs-lookup"><span data-stu-id="c05c2-117">In the **New ASP.NET Project** dialog, select the **Empty** template.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image2.png)  
  
   <span data-ttu-id="c05c2-118">Обратите внимание, что кнопка **изменить проверку подлинности** отключена, и в этом шаблоне поддержка проверки подлинности не предоставляется.</span><span class="sxs-lookup"><span data-stu-id="c05c2-118">Notice the **Change Authentication** button is disabled and no authentication support is provided in this template.</span></span> <span data-ttu-id="c05c2-119">Шаблоны веб-форм, MVC и веб-API позволяют выбрать способ проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="c05c2-119">The Web Forms, MVC and Web API templates allow you to select the authentication approach.</span></span>

## <a name="add-identity-packages-to-your-app"></a><span data-ttu-id="c05c2-120">Добавление пакетов удостоверений в приложение</span><span class="sxs-lookup"><span data-stu-id="c05c2-120">Add Identity packages to your app</span></span>

<span data-ttu-id="c05c2-121">В обозреватель решений щелкните правой кнопкой мыши проект и выберите **Управление пакетами NuGet**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-121">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="c05c2-122">Найдите и установите пакет **Microsoft. AspNet. Identity. EntityFramework** .</span><span class="sxs-lookup"><span data-stu-id="c05c2-122">Search for and install the **Microsoft.AspNet.Identity.EntityFramework** package.</span></span> 
  
![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image15.png)
  
<span data-ttu-id="c05c2-123">Обратите внимание, что этот пакет будет устанавливать пакеты зависимостей: **EntityFramework** и **Microsoft ASP.NET Core Identity**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-123">Note that this package will install the dependency packages: **EntityFramework** and **Microsoft ASP.NET Identity Core**.</span></span>

## <a name="add-a-web-form-to-register-users"></a><span data-ttu-id="c05c2-124">Добавление веб-формы для регистрации пользователей</span><span class="sxs-lookup"><span data-stu-id="c05c2-124">Add a web form to register users</span></span>

1. <span data-ttu-id="c05c2-125">В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите **Добавить**, а затем — **веб-форма**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-125">In **Solution Explorer**, right-click your project and select **Add**, and then **Web Form**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image4.png)
2. <span data-ttu-id="c05c2-126">В диалоговом окне **Указание имени для элемента** введите имя нового **регистра**веб-формы и нажмите кнопку **ОК** .</span><span class="sxs-lookup"><span data-stu-id="c05c2-126">In the **Specify Name for Item** dialog box, name the new web form **Register**, and then select **OK**</span></span>
3. <span data-ttu-id="c05c2-127">Замените разметку в созданном файле *Register. aspx* приведенным ниже кодом.</span><span class="sxs-lookup"><span data-stu-id="c05c2-127">Replace the markup in the generated *Register.aspx* file with the code below.</span></span> <span data-ttu-id="c05c2-128">Изменения в коде выделены.</span><span class="sxs-lookup"><span data-stu-id="c05c2-128">The code changes are highlighted.</span></span> 

    [!code-html[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample1.aspx?highlight=9,12-40)]

    > [!NOTE]
    > <span data-ttu-id="c05c2-129">Это просто упрощенная версия файла *Register. aspx* , создаваемая при создании нового проекта веб-форм ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="c05c2-129">This is just a simplified version of the *Register.aspx* file that is created when you create a new ASP.NET Web Forms project.</span></span> <span data-ttu-id="c05c2-130">Приведенная выше разметка добавляет поля формы и кнопку для регистрации нового пользователя.</span><span class="sxs-lookup"><span data-stu-id="c05c2-130">The markup above adds form fields and a button to register a new user.</span></span>
4. <span data-ttu-id="c05c2-131">Откройте файл *Register.aspx.CS* и замените содержимое файла следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="c05c2-131">Open the *Register.aspx.cs* file and replace the contents of the file with the following code:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample2.cs)]

    > [!NOTE] 
    > 
    > 1. <span data-ttu-id="c05c2-132">Приведенный выше код является упрощенной версией файла *Register.aspx.CS* , который создается при создании нового проекта веб-форм ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="c05c2-132">The code above is a simplified version of the *Register.aspx.cs* file that is created when you create a new ASP.NET Web Forms project.</span></span>
    > 2. <span data-ttu-id="c05c2-133">Класс *идентитюсер* является реализацией EntityFramework по умолчанию интерфейса *IUser* .</span><span class="sxs-lookup"><span data-stu-id="c05c2-133">The *IdentityUser* class is the default EntityFramework implementation of the *IUser* interface.</span></span> <span data-ttu-id="c05c2-134">Интерфейс *IUser* является минимальным интерфейсом для пользователя ASP.NET Identity Core.</span><span class="sxs-lookup"><span data-stu-id="c05c2-134">*IUser* interface is the minimal interface for a user on ASP.NET Identity Core.</span></span>
    > 3. <span data-ttu-id="c05c2-135">Класс *UserStore* является реализацией EntityFramework по умолчанию для хранилища пользователей.</span><span class="sxs-lookup"><span data-stu-id="c05c2-135">The *UserStore* class is the default EntityFramework implementation of a user store.</span></span> <span data-ttu-id="c05c2-136">Этот класс реализует минимальные интерфейсы ASP.NET Identity Core: *IUserStore*, *иусерлогинсторе*, *IUserClaimStore* и *IUserRoleStore*.</span><span class="sxs-lookup"><span data-stu-id="c05c2-136">This class implements the ASP.NET Identity Core's minimal interfaces: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* and *IUserRoleStore*.</span></span>
    > 4. <span data-ttu-id="c05c2-137">Класс *UserManager* предоставляет интерфейсы API, связанные с пользователем, которые автоматически сохраняют изменения в *UserStore*.</span><span class="sxs-lookup"><span data-stu-id="c05c2-137">The *UserManager* class exposes user related APIs which will automatically save changes to the *UserStore*.</span></span>
    > 5. <span data-ttu-id="c05c2-138">Класс *идентитиресулт* представляет результат операции идентификации.</span><span class="sxs-lookup"><span data-stu-id="c05c2-138">The *IdentityResult* class represents the result of an identity operation.</span></span>
5. <span data-ttu-id="c05c2-139">В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите **Добавить**, **Добавить папку ASP.NET** , а затем — **\_данные приложения**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-139">In **Solution Explorer**, right-click your project and select **Add**, **Add ASP.NET Folder** and then **App\_Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image5.png)
6. <span data-ttu-id="c05c2-140">Откройте файл *Web. config* и добавьте запись строки подключения для базы данных, которая будет использоваться для хранения сведений о пользователе.</span><span class="sxs-lookup"><span data-stu-id="c05c2-140">Open the *Web.config* file and add a connection string entry for the database we will use to store user information.</span></span> <span data-ttu-id="c05c2-141">База данных будет создана во время выполнения EntityFramework для сущностей Identity.</span><span class="sxs-lookup"><span data-stu-id="c05c2-141">The database will be created at runtime by EntityFramework for the Identity entities.</span></span> <span data-ttu-id="c05c2-142">Строка подключения аналогична той, которая была создана при создании нового проекта веб-форм.</span><span class="sxs-lookup"><span data-stu-id="c05c2-142">The connection string is similar to one created for you when you create a new Web Forms project.</span></span> <span data-ttu-id="c05c2-143">Выделенный код показывает разметку, которую следует добавить:</span><span class="sxs-lookup"><span data-stu-id="c05c2-143">The highlighted code shows the markup you should add:</span></span>

    [!code-xml[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample3.xml?highlight=11-14)]
    
    > [!NOTE] 
    > <span data-ttu-id="c05c2-144">В Visual Studio 2015 или более поздней версии замените `(localdb)\v11.0` `(localdb)\MSSQLLocalDB` в строке подключения.</span><span class="sxs-lookup"><span data-stu-id="c05c2-144">For Visual Studio 2015 or higher, replace `(localdb)\v11.0` with `(localdb)\MSSQLLocalDB` in your connection string.</span></span>
    
7. <span data-ttu-id="c05c2-145">Щелкните правой кнопкой мыши файл *Register. aspx* в проекте и выберите **задать в качестве начальной страницы**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-145">Right click file *Register.aspx* in your project and select **Set as Start Page**.</span></span> <span data-ttu-id="c05c2-146">Нажмите клавиши CTRL + F5, чтобы создать и запустить веб-приложение.</span><span class="sxs-lookup"><span data-stu-id="c05c2-146">Press Ctrl + F5 to build and run the web application.</span></span> <span data-ttu-id="c05c2-147">Введите новое имя пользователя и пароль, а затем нажмите кнопку **зарегистрировать**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-147">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image6.png)  

    > [!NOTE]
    > <span data-ttu-id="c05c2-148">ASP.NET Identity поддерживает проверку. в этом примере можно проверить поведение по умолчанию для проверяющих элементов управления для пользователей и паролей, которые поступают из пакета удостоверений Core.</span><span class="sxs-lookup"><span data-stu-id="c05c2-148">ASP.NET Identity has support for validation and in this sample you can verify the default behavior on User and Password validators that come from the Identity Core package.</span></span> <span data-ttu-id="c05c2-149">Проверяющий элемент управления по умолчанию для пользователя (`UserValidator`) имеет свойство `AllowOnlyAlphanumericUserNames` со значением по умолчанию, равным `true`.</span><span class="sxs-lookup"><span data-stu-id="c05c2-149">The default validator for User (`UserValidator`) has a property `AllowOnlyAlphanumericUserNames` that has default value set to `true`.</span></span> <span data-ttu-id="c05c2-150">Проверяющий элемент управления по умолчанию для Password (`MinimumLengthValidator`) гарантирует, что пароль содержит не менее 6 символов.</span><span class="sxs-lookup"><span data-stu-id="c05c2-150">The default validator for Password (`MinimumLengthValidator`) ensures that password has at least 6 characters.</span></span> <span data-ttu-id="c05c2-151">Эти проверяющие элементы управления являются свойствами на `UserManager`, которые могут быть переопределены, если требуется пользовательская проверка.</span><span class="sxs-lookup"><span data-stu-id="c05c2-151">These validators are properties on `UserManager` that can be overridden if you want to have custom validation,</span></span>

## <a name="verify-the-localdb-identity-database-and-tables-generated-by-entity-framework"></a><span data-ttu-id="c05c2-152">Проверьте базу данных удостоверений LocalDb и таблицы, созданные Entity Framework</span><span class="sxs-lookup"><span data-stu-id="c05c2-152">Verify the LocalDb Identity database and tables generated by Entity Framework</span></span>

1. <span data-ttu-id="c05c2-153">В меню **вид** выберите **Обозреватель сервера**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-153">In the **View** menu, select **Server Explorer**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image7.png)
2. <span data-ttu-id="c05c2-154">Разверните узел **DefaultConnection (вебформсидентити)** , разверните узел **таблицы**, щелкните правой кнопкой мыши элемент **AspNetUsers** , а затем выберите команду **отобразить данные таблицы**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-154">Expand **DefaultConnection (WebFormsIdentity)**, expand **Tables**, right-click **AspNetUsers** and then select **Show Table Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image8.png)  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image9.png)

## <a name="configure-the-application-for-owin-authentication"></a><span data-ttu-id="c05c2-155">Настройка приложения для проверки подлинности OWIN</span><span class="sxs-lookup"><span data-stu-id="c05c2-155">Configure the application for OWIN authentication</span></span>

<span data-ttu-id="c05c2-156">На этом этапе мы добавили только поддержку для создания пользователей.</span><span class="sxs-lookup"><span data-stu-id="c05c2-156">At this point we have only added support for creating users.</span></span> <span data-ttu-id="c05c2-157">Теперь мы покажем, как можно добавить проверку подлинности для входа пользователя.</span><span class="sxs-lookup"><span data-stu-id="c05c2-157">Now, we are going to demonstrate how we can add authentication to login a user.</span></span> <span data-ttu-id="c05c2-158">ASP.NET Identity использует по промежуточного слоя проверки подлинности Microsoft OWIN для проверки подлинности форм</span><span class="sxs-lookup"><span data-stu-id="c05c2-158">ASP.NET Identity uses Microsoft OWIN Authentication middleware for forms authentication.</span></span> <span data-ttu-id="c05c2-159">Проверка подлинности OWIN cookie — это файл cookie и механизм проверки подлинности на основе утверждений, который может использоваться любой платформой, размещенной в [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) или IIS.</span><span class="sxs-lookup"><span data-stu-id="c05c2-159">The OWIN Cookie Authentication is a cookie and claims based authentication mechanism that can be used by any framework hosted on [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) or IIS.</span></span> <span data-ttu-id="c05c2-160">В этой модели одни и те же пакеты проверки подлинности можно использовать в нескольких платформах, включая ASP.NET MVC и веб-формы.</span><span class="sxs-lookup"><span data-stu-id="c05c2-160">With this model, the same authentication packages can be used across multiple frameworks including ASP.NET MVC and Web Forms.</span></span> <span data-ttu-id="c05c2-161">Дополнительные сведения о проекте Katana и о том, как выполнять по промежуточного слоя на узле, не зависят [от начало работы с проектом Katana](https://msdn.microsoft.com/magazine/dn451439.aspx).</span><span class="sxs-lookup"><span data-stu-id="c05c2-161">For more information on project Katana and how to run middleware in a host agnostic see [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx).</span></span>

## <a name="install-authentication-packages-to-your-application"></a><span data-ttu-id="c05c2-162">Установка пакетов проверки подлинности в приложение</span><span class="sxs-lookup"><span data-stu-id="c05c2-162">Install authentication packages to your application</span></span>

1. <span data-ttu-id="c05c2-163">В обозреватель решений щелкните правой кнопкой мыши проект и выберите **Управление пакетами NuGet**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-163">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="c05c2-164">Найдите и установите пакет ***Microsoft. AspNet. Identity. Owin*** .</span><span class="sxs-lookup"><span data-stu-id="c05c2-164">Search for and install the ***Microsoft.AspNet.Identity.Owin*** package.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image16.png)

2. <span data-ttu-id="c05c2-165">Найдите и установите пакет ***Microsoft. Owin. host. SystemWeb*** .</span><span class="sxs-lookup"><span data-stu-id="c05c2-165">Search for and install the ***Microsoft.Owin.Host.SystemWeb*** package.</span></span>

    > [!NOTE]
    > <span data-ttu-id="c05c2-166">Пакет **Microsoft. ASPNET. Identity. Owin** содержит набор классов расширений Owin для управления и настройки по промежуточного слоя проверки подлинности Owin, который будет использоваться ASP.NET Identity пакетах ядра.</span><span class="sxs-lookup"><span data-stu-id="c05c2-166">The **Microsoft.Aspnet.Identity.Owin** package contains a set of OWIN extension classes to manage and configure OWIN authentication middleware to be consumed by ASP.NET Identity Core packages.</span></span>
    > <span data-ttu-id="c05c2-167">Пакет **Microsoft. Owin. host. SystemWeb** содержит сервер Owin, который позволяет приложениям на основе Owin выполняться в IIS с помощью конвейера запросов ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="c05c2-167">The **Microsoft.Owin.Host.SystemWeb** package contains an OWIN server that enables OWIN-based applications to run on IIS using the ASP.NET request pipeline.</span></span> <span data-ttu-id="c05c2-168">Дополнительные сведения см. [в разделе по промежуточного слоя OWIN в интегрированном конвейере IIS](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span><span class="sxs-lookup"><span data-stu-id="c05c2-168">For more information see [OWIN Middleware in the IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span></span>

## <a name="add-owin-startup-and-authentication-configuration-classes"></a><span data-ttu-id="c05c2-169">Добавление классов конфигурации запуска и проверки подлинности OWIN</span><span class="sxs-lookup"><span data-stu-id="c05c2-169">Add OWIN startup and authentication configuration classes</span></span>

1. <span data-ttu-id="c05c2-170">В **Обозреватель решений**щелкните правой кнопкой мыши проект, выберите **Добавить**, а затем **Добавить новый элемент**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-170">In **Solution Explorer**, right-click your project, select **Add**, and then **Add New Item**.</span></span> <span data-ttu-id="c05c2-171">В диалоговом окне Поиск текстового поля введите "*owin*".</span><span class="sxs-lookup"><span data-stu-id="c05c2-171">In the search text box dialog, type "*owin*".</span></span> <span data-ttu-id="c05c2-172">Назовите класс "*Startup*" и выберите **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-172">Name the class "*Startup*" and select **Add**.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image11.png)
2. <span data-ttu-id="c05c2-173">В файле Startup.cs добавьте выделенный код, показанный ниже, чтобы настроить проверку подлинности файлов cookie OWIN.</span><span class="sxs-lookup"><span data-stu-id="c05c2-173">In the Startup.cs file, add the highlighted code shown below to configure OWIN cookie authentication.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample4.cs?highlight=1,3,15-19)]

    > [!NOTE]
    > <span data-ttu-id="c05c2-174">Этот класс содержит атрибут `OwinStartup` для указания класса запуска OWIN.</span><span class="sxs-lookup"><span data-stu-id="c05c2-174">This class contains the `OwinStartup` attribute for specifying the OWIN startup class.</span></span> <span data-ttu-id="c05c2-175">Каждое приложение OWIN имеет класс Startup, в котором указываются компоненты для конвейера приложения.</span><span class="sxs-lookup"><span data-stu-id="c05c2-175">Every OWIN application has a startup class where you specify components for the application pipeline.</span></span> <span data-ttu-id="c05c2-176">Дополнительные сведения об этой модели см. в разделе [Обнаружение класса запуска OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) .</span><span class="sxs-lookup"><span data-stu-id="c05c2-176">See [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) for more info on this model.</span></span>

## <a name="add-web-forms-for-registering-and-signing-in-users"></a><span data-ttu-id="c05c2-177">Добавление веб-форм для регистрации пользователей и входа в систему</span><span class="sxs-lookup"><span data-stu-id="c05c2-177">Add web forms for registering and signing in users</span></span>

1. <span data-ttu-id="c05c2-178">Откройте файл *Register.aspx.CS* и добавьте следующий код, который подписывает пользователя после того, как регистрация будет выполнена.</span><span class="sxs-lookup"><span data-stu-id="c05c2-178">Open the *Register.aspx.cs* file and add the following code which signs in the user when registration succeeds.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample5.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="c05c2-179">Так как проверка подлинности ASP.NET Identity и OWIN cookie — это система на основе утверждений, платформа требует от разработчика приложения создать [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) для пользователя.</span><span class="sxs-lookup"><span data-stu-id="c05c2-179">Since ASP.NET Identity and OWIN Cookie Authentication are claims based system, the framework requires the app developer to generate a [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) for the user.</span></span> <span data-ttu-id="c05c2-180">ClaimsIdentity содержит сведения обо всех утверждениях для пользователя, например о ролях, к которой принадлежит пользователь.</span><span class="sxs-lookup"><span data-stu-id="c05c2-180">ClaimsIdentity has information about all the claims for the user such as what Roles the user belongs to.</span></span> <span data-ttu-id="c05c2-181">На этом этапе можно также добавить дополнительные утверждения для пользователя.</span><span class="sxs-lookup"><span data-stu-id="c05c2-181">You can also add more claims for the user at this stage.</span></span>
    > - <span data-ttu-id="c05c2-182">Вы можете войти в систему с помощью AuthenticationManager из OWIN и вызвать `SignIn` и передать в ClaimsIdentity, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="c05c2-182">You can sign in the user by using the AuthenticationManager from OWIN and calling `SignIn` and passing in the ClaimsIdentity as shown above.</span></span> <span data-ttu-id="c05c2-183">Этот код выполнит вход пользователя и создаст файл cookie.</span><span class="sxs-lookup"><span data-stu-id="c05c2-183">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="c05c2-184">Этот вызов аналогичен [формаусентикатион. сетаускукие](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) , используемому модулем [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c05c2-184">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
2. <span data-ttu-id="c05c2-185">В **Обозреватель решений**щелкните правой кнопкой мыши проект, выберите **Добавить**, а затем — **веб-форма**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-185">In **Solution Explorer**, right-click your project, select **Add**, and then **Web Form**.</span></span> <span data-ttu-id="c05c2-186">Назовите имя **входа**веб-формы.</span><span class="sxs-lookup"><span data-stu-id="c05c2-186">Name the web form **Login**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image12.png)
3. <span data-ttu-id="c05c2-187">Замените содержимое файла *Login. aspx* следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="c05c2-187">Replace the contents of the *Login.aspx* file with the following code:</span></span>

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample6.aspx)]
4. <span data-ttu-id="c05c2-188">Замените содержимое файла *Login.aspx.CS* следующим:</span><span class="sxs-lookup"><span data-stu-id="c05c2-188">Replace the contents of the *Login.aspx.cs* file with the following:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample7.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="c05c2-189">`Page_Load` теперь проверяет состояние текущего пользователя и выполняет действия в зависимости от состояния `Context.User.Identity.IsAuthenticated`.</span><span class="sxs-lookup"><span data-stu-id="c05c2-189">The `Page_Load` now checks for the status of current user and takes action based on its `Context.User.Identity.IsAuthenticated` status.</span></span>
    >   <span data-ttu-id="c05c2-190">**Отображение имени пользователя, выполнившего вход** . платформа удостоверений Microsoft ASP.NET добавила методы расширения в [System. Security. Principal. IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) , что позволяет получить `UserName` и `UserId` для вошедшего в систему пользователя.</span><span class="sxs-lookup"><span data-stu-id="c05c2-190">**Display Logged in User Name** : The Microsoft ASP.NET Identity Framework has added extension methods on [System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) that allows you to get the `UserName` and `UserId`  for the logged in User.</span></span> <span data-ttu-id="c05c2-191">Эти методы расширения определены в сборке `Microsoft.AspNet.Identity.Core`.</span><span class="sxs-lookup"><span data-stu-id="c05c2-191">These extension methods are defined in the `Microsoft.AspNet.Identity.Core` assembly.</span></span> <span data-ttu-id="c05c2-192">Эти методы расширения являются заменой для [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c05c2-192">These extension methods are the replacement for [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span></span>
    > - <span data-ttu-id="c05c2-193">Метод Signing: `This` метод заменяет предыдущий метод `CreateUser_Click` в этом примере и теперь после успешного создания пользователя выполняет вход в систему.</span><span class="sxs-lookup"><span data-stu-id="c05c2-193">SignIn method: `This` method replaces the previous `CreateUser_Click` method in this sample and now signs in the user after successfully creating the user.</span></span>   
    >   <span data-ttu-id="c05c2-194">Платформа Microsoft OWIN Framework добавила методы расширения в `System.Web.HttpContext`, которые позволяют получить ссылку на `IOwinContext`.</span><span class="sxs-lookup"><span data-stu-id="c05c2-194">The Microsoft OWIN Framework has added extension methods on `System.Web.HttpContext` that allows you to get a reference to an `IOwinContext`.</span></span> <span data-ttu-id="c05c2-195">Эти методы расширения определены в `Microsoft.Owin.Host.SystemWeb` сборке.</span><span class="sxs-lookup"><span data-stu-id="c05c2-195">These extension methods are defined in `Microsoft.Owin.Host.SystemWeb` assembly.</span></span> <span data-ttu-id="c05c2-196">Класс `OwinContext` предоставляет свойство `IAuthenticationManager`, которое представляет функциональные возможности по промежуточного слоя для проверки подлинности, доступные в текущем запросе.</span><span class="sxs-lookup"><span data-stu-id="c05c2-196">The `OwinContext` class exposes an `IAuthenticationManager` property that represents the Authentication middleware functionality available on the current request.</span></span> <span data-ttu-id="c05c2-197">Вы можете войти в систему с помощью `AuthenticationManager` из OWIN и вызова `SignIn` и передачи `ClaimsIdentity`, как показано выше.</span><span class="sxs-lookup"><span data-stu-id="c05c2-197">You can sign in the user by using the `AuthenticationManager` from OWIN and calling `SignIn` and passing in the `ClaimsIdentity` as shown above.</span></span> <span data-ttu-id="c05c2-198">Так как проверка подлинности ASP.NET Identity и OWIN cookie — это система на основе утверждений, платформа требует, чтобы приложение создавало `ClaimsIdentity` для пользователя.</span><span class="sxs-lookup"><span data-stu-id="c05c2-198">Because ASP.NET Identity and OWIN Cookie Authentication are claims-based system, the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="c05c2-199">`ClaimsIdentity` содержит сведения обо всех утверждениях для пользователя, например о ролях, к которым принадлежит пользователь.</span><span class="sxs-lookup"><span data-stu-id="c05c2-199">The `ClaimsIdentity` has information about all the claims for the user, such as what roles the user belongs to.</span></span> <span data-ttu-id="c05c2-200">Можно также добавить дополнительные утверждения для пользователя на этом этапе. Этот код будет выполнять вход пользователя и создавать файл cookie.</span><span class="sxs-lookup"><span data-stu-id="c05c2-200">You can also add more claims for the user at this stage This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="c05c2-201">Этот вызов аналогичен [формаусентикатион. сетаускукие](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) , используемому модулем [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c05c2-201">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
    > - <span data-ttu-id="c05c2-202">метод `SignOut`: получает ссылку на `AuthenticationManager` из OWIN и вызывает `SignOut`.</span><span class="sxs-lookup"><span data-stu-id="c05c2-202">`SignOut` method: Gets a reference to the `AuthenticationManager` from OWIN and calls `SignOut`.</span></span> <span data-ttu-id="c05c2-203">Это аналогично методу [FormsAuthentication. Signing](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) , используемому модулем [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) .</span><span class="sxs-lookup"><span data-stu-id="c05c2-203">This is analogous to [FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) method used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
5. <span data-ttu-id="c05c2-204">Нажмите клавиши **CTRL + F5** , чтобы создать и запустить веб-приложение.</span><span class="sxs-lookup"><span data-stu-id="c05c2-204">Press **Ctrl + F5** to build and run the web application.</span></span> <span data-ttu-id="c05c2-205">Введите новое имя пользователя и пароль, а затем нажмите кнопку **зарегистрировать**.</span><span class="sxs-lookup"><span data-stu-id="c05c2-205">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image13.png)  
   <span data-ttu-id="c05c2-206">Примечание. на этом этапе новый пользователь создается и входит в систему.</span><span class="sxs-lookup"><span data-stu-id="c05c2-206">Note: At this point, the new user is created and logged in.</span></span>
6. <span data-ttu-id="c05c2-207">Нажмите кнопку **выход** .</span><span class="sxs-lookup"><span data-stu-id="c05c2-207">Select the **Log out** button.</span></span> <span data-ttu-id="c05c2-208">Вы будете перенаправлены на форму входа.</span><span class="sxs-lookup"><span data-stu-id="c05c2-208">You are redirected to the Log in form.</span></span>
7. <span data-ttu-id="c05c2-209">Введите недопустимое имя пользователя или пароль и нажмите кнопку **Вход** .</span><span class="sxs-lookup"><span data-stu-id="c05c2-209">Enter an invalid user name or password and select the **Log in** button.</span></span> 
   <span data-ttu-id="c05c2-210">Метод `UserManager.Find` вернет значение null, и появится сообщение об ошибке: " *недопустимое имя пользователя или пароль* ".</span><span class="sxs-lookup"><span data-stu-id="c05c2-210">The `UserManager.Find`  method will return null and the error message: " *Invalid user name or password* " will be displayed.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image14.png)
