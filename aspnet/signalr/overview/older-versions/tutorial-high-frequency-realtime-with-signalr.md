---
uid: signalr/overview/older-versions/tutorial-high-frequency-realtime-with-signalr
title: Высокая частота в реальном времени с SignalR 1. x | Документация Майкрософт
author: bradygaster
description: В этом руководстве показано, как создать веб-приложение, которое использует SignalR ASP.NET для предоставления высокоскоростной функции обмена сообщениями. Высокая частота обмена сообщениями в...
ms.author: bradyg
ms.date: 04/16/2013
ms.assetid: ad2a5da5-2e79-40ea-bc84-028d327f5982
msc.legacyurl: /signalr/overview/older-versions/tutorial-high-frequency-realtime-with-signalr
msc.type: authoredcontent
ms.openlocfilehash: e37e63a410952ec170cbbaadeeb54eae7e82b3b5
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78505716"
---
# <a name="high-frequency-realtime-with-signalr-1x"></a>Обмен сообщениями с высоким уровнем периодичности в режиме реального времени с помощью SignalR 1.x

по [Патрик Флетчера](https://github.com/pfletcher)

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

> В этом руководстве показано, как создать веб-приложение, которое использует SignalR ASP.NET для предоставления высокоскоростной функции обмена сообщениями. Высокая частота обмена сообщениями в этом случае означает, что обновления отправляются с фиксированной частотой; в случае с этим приложением до 10 сообщений секунды.
> 
> В приложении, которое вы создадите в этом учебнике, отображается фигура, которую пользователи могут перетаскивать. После этого расположение фигуры во всех остальных подключенных браузерах будет Обновлено в соответствии с позицией перетаскиваемого элемента с помощью времени обновления.
> 
> Основные понятия, представленные в этом руководстве, представляют собой приложения в режиме реального времени и другие приложения моделирования.
> 
> Комментарии в учебнике — Добро пожаловать. Если у вас есть вопросы, не связанные непосредственно с этим руководством, их можно опубликовать на [форуме ASP.NET SignalR](https://forums.asp.net/1254.aspx/1?ASP+NET+SignalR) или [StackOverflow.com](http://stackoverflow.com).

## <a name="overview"></a>Обзор

В этом учебнике показано, как создать приложение, которое совместно использует состояние объекта в других браузерах в режиме реального времени. Создаваемое приложение называется Мовешапе. На странице Мовешапе будет отображен элемент HTML div, который пользователь может перетаскивать; Когда пользователь перетаскивает div, его новое расположение будет отправлено на сервер, который затем будет сообщать всем другим подключенным клиентам обновить расположение фигуры.

![Окно приложения](tutorial-high-frequency-realtime-with-signalr/_static/image1.png)

Приложение, созданное в этом руководстве, основано на демонстрационной версии Дэмиен Edwards. Видео, содержащее эту демонстрацию, можно просмотреть [здесь](https://channel9.msdn.com/Series/Building-Web-Apps-with-ASP-NET-Jump-Start/Building-Web-Apps-with-ASPNET-Jump-Start-08-Real-time-Communication-with-SignalR).

В этом учебнике будет показано, как отправить сообщения SignalR из каждого события, возникающего при перетаскивании фигуры. Каждый подключенный клиент будет обновлять расположение локальной версии фигуры при каждом получении сообщения.

Несмотря на то, что приложение будет работать с использованием этого метода, это не рекомендуемая модель программирования, поскольку верхний предел числа отправляемых сообщений не ограничен, поэтому клиенты и сервер могут перестать перегружаться с сообщениями и производительностью понизиться. . Отображаемая анимация на стороне клиента также будет несвязна, так как фигура будет немедленно перемещена каждым методом, а не плавно перемещаться в каждое новое место. В последующих разделах учебника будет показано, как создать функцию таймера, которая ограничит максимальную скорость, с которой сообщения отправляются клиентом или сервером, и как плавно перемещать фигуру между расположениями. Окончательную версию приложения, созданного в этом руководстве, можно скачать из [коллекции кода](https://code.msdn.microsoft.com/SignalR-MoveShape-demo-3366dac6).

Этот учебник содержит следующие подразделы:

- [Предварительные требования](#prerequisites)
- [Создание проекта](#createtheproject)
- [Добавление ASP.NET SignalR и JQuery. UI NuGet Packages](#nugetpackages)
- [Создание базового приложения](#baseapp)
- [Добавление цикла клиента](#clientloop)
- [Добавление цикла сервера](#serverloop)
- [Добавление гладкой анимации на клиенте](#animation)
- [Дальнейшие действия](#furthersteps)

<a id="prerequisites"></a>

## <a name="prerequisites"></a>предварительные требования

Для работы с этим руководством требуется Visual Studio 2012 или Visual Studio 2010. Если используется Visual Studio 2010, проект будет использовать .NET Framework 4, а не .NET Framework 4,5.

Если вы используете Visual Studio 2012, рекомендуется установить [обновление ASP.NET and Web Tools 2012,2](https://go.microsoft.com/fwlink/?LinkId=282650). Это обновление содержит новые функции, такие как улучшения публикации, новые функциональные возможности и новые шаблоны.

Если у вас есть Visual Studio 2010, убедитесь, что [NuGet](https://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c) установлен.

<a id="createtheproject"></a>

## <a name="create-the-project"></a>Создание проекта

В этом разделе мы создадим проект в Visual Studio.

1. В меню **Файл** выберите **Новый проект**.
2. В диалоговом окне **Новый проект** разверните узел **C#** **шаблоны** и выберите **веб**.
3. Выберите шаблон **ASP.NET пустое веб-приложение** , присвойте проекту имя *мовешапедемо*и нажмите кнопку **ОК**.

    ![Создание нового проекта](tutorial-high-frequency-realtime-with-signalr/_static/image2.png)

<a id="nugetpackages"></a>

## <a name="add-the-signalr-and-jqueryui-nuget-packages"></a>Добавление SignalR и JQuery. пакеты NuGet для пользовательского интерфейса

Функциональные возможности SignalR можно добавить в проект, установив пакет NuGet. В этом руководстве также будет использоваться пакет JQuery. UI для разрешения перетаскивания фигуры и ее анимации.

1. Щелкните **Сервис | Диспетчер пакетов NuGet | Консоль диспетчера пакетов**.
2. Введите следующую команду в диспетчере пакетов.

    [!code-powershell[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample1.ps1)]

    Пакет SignalR устанавливает ряд других пакетов NuGet в качестве зависимостей. По завершении установки у вас будут все компоненты сервера и клиента, необходимые для использования SignalR в приложении ASP.NET.
3. Введите следующую команду в консоль диспетчера пакетов, чтобы установить пакеты JQuery и JQuery. UI.

    [!code-powershell[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample2.ps1)]

<a id="baseapp"></a>

## <a name="create-the-base-application"></a>Создание базового приложения

В этом разделе мы создадим приложение браузера, которое отправляет расположение фигуры на сервер при каждом событии перемещения указателя мыши. Затем сервер передает эти сведения всем остальным подключенным клиентам по мере их получения. Это приложение будет расширено в последующих разделах.

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите **Добавить**, **класс...** . Назовите класс **мовешапехуб** и нажмите кнопку **Добавить**.
2. Замените код в новом классе **мовешапехуб** следующим кодом.

    [!code-csharp[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample3.cs)]

    Приведенный выше класс `MoveShapeHub` является реализацией концентратора SignalR. Как и в [Начало работы с](index.md) руководством по SignalR, центр имеет метод, который клиенты будут вызывать напрямую. В этом случае клиент отправляет объект, содержащий новые координаты X и Y фигуры, на сервер, который затем отправляется на все остальные подключенные клиенты. SignalR автоматически сериализует этот объект с помощью JSON.

    Объект, который будет отправлен клиенту (`ShapeModel`), содержит элементы для сохранения расположения фигуры. Версия объекта на сервере также содержит элемент для отслеживания хранения данных клиента, чтобы заданный клиент не отправлял собственные данные. Этот элемент использует атрибут `JsonIgnore`, чтобы предотвратить его сериализацию и отправку клиенту.
3. Далее мы настроили центр при запуске приложения. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите команду **Добавить | Глобальный класс приложения**. Примите имя по умолчанию *Global* и нажмите кнопку **ОК**.

    ![Добавление глобального класса приложения](tutorial-high-frequency-realtime-with-signalr/_static/image3.png)
4. Добавьте следующую инструкцию `using` после предоставленных операторов **using** в классе Global.asax.cs.

    [!code-csharp[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample4.cs)]
5. Добавьте следующую строку кода в метод `Application_Start` глобального класса, чтобы зарегистрировать маршрут по умолчанию для SignalR.

    [!code-csharp[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample5.cs)]

    Файл Global. asax должен выглядеть следующим образом:

    [!code-csharp[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample6.cs)]
6. Далее мы добавим клиент. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите команду **Добавить | Новый элемент**. В диалоговом окне **Добавление нового элемента** выберите **страница HTML**. Присвойте странице соответствующее имя (например **, Default. HTML**) и нажмите кнопку **Добавить**.
7. В **Обозреватель решений**щелкните правой кнопкой мыши только что созданную страницу и выберите пункт **задать как начальную страницу**.
8. Замените код по умолчанию на странице HTML следующим фрагментом кода.

    > [!NOTE]
    > Убедитесь, что указанные ниже ссылки на скрипт соответствуют пакетам, добавленным в проект в папке Scripts. В Visual Studio 2010 версия JQuery и SignalR, добавленные в проект, могут не соответствовать номерам версий ниже.

    [!code-html[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample7.html)]

    Вышеприведенный код HTML и JavaScript создает красную фигуру с именем Shape, обеспечивает поведение перетаскивания фигуры с помощью библиотеки jQuery и использует событие `drag` фигуры для отправки расположения фигуры на сервер.
9. Запустите приложение, нажав клавишу F5. Скопируйте URL-адрес страницы и вставьте его в второе окно браузера. Перетащите фигуру в одно из окон браузера. фигура в другом окне браузера должна перемещаться.

    ![Окно приложения](tutorial-high-frequency-realtime-with-signalr/_static/image4.png)

<a id="clientloop"></a>

## <a name="add-the-client-loop"></a>Добавление цикла клиента

Поскольку отправка расположения фигуры при каждом событии перемещения указателя мыши приведет к созданию ненужного объема сетевого трафика, сообщения от клиента необходимо регулировать. Мы будем использовать функцию JavaScript `setInterval` для настройки цикла, который отправляет новые сведения о позиции на сервер с фиксированной частотой. Этот цикл является очень базовым представлением «цикла игры», часто именуемой функцией, которая выполняет все функции игры или другого моделирования.

1. Обновите код клиента на странице HTML в соответствии с приведенным ниже фрагментом кода.

    [!code-html[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample8.html)]

    Приведенное выше обновление добавляет функцию `updateServerModel`, которая вызывается с фиксированной частотой. Эта функция отправляет данные о положении на сервер, когда флаг `moved` указывает на наличие новых данных о расположении для отправки.
2. Запустите приложение, нажав клавишу F5. Скопируйте URL-адрес страницы и вставьте его в второе окно браузера. Перетащите фигуру в одно из окон браузера. фигура в другом окне браузера должна перемещаться. Так как количество сообщений, отправляемых на сервер, будет регулироваться, анимация не будет отображаться как гладкий, как в предыдущем разделе.

    ![Окно приложения](tutorial-high-frequency-realtime-with-signalr/_static/image5.png)

<a id="serverloop"></a>

## <a name="add-the-server-loop"></a>Добавление цикла сервера

В текущем приложении сообщения, отправленные с сервера клиенту, отправляются так часто, как они получены. Это представляет подобную проблему, как показано на клиенте. сообщения могут отправляться чаще, чем требуется, а подключение может передаваться в результате. В этом разделе описывается, как обновить сервер для реализации таймера, который регулирует скорость исходящих сообщений.

1. Замените содержимое `MoveShapeHub.cs` следующим фрагментом кода.

    [!code-csharp[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample9.cs)]

    Приведенный выше код расширяет возможности клиента, добавляя класс `Broadcaster`, который регулирует исходящие сообщения с помощью класса `Timer` из .NET Framework.

    Так как сам концентратор является транзитным (он создается каждый раз, когда он необходим), `Broadcaster` будет создан как одноэлементный. Отложенная инициализация (введенная в .NET 4) используется, чтобы отложить ее создание до тех пор, пока не будет потребовалось, прежде чем запустить таймер, убедитесь, что первый экземпляр концентратора создан полностью.

    Затем вызов функции `UpdateShape` клиентов перемещается из метода `UpdateModel` концентратора, чтобы он больше не вызывался немедленно при получении входящих сообщений. Вместо этого сообщения для клиентов будут отправляться с частотой 25 вызовов в секунду, управляемых таймером `_broadcastLoop` из класса `Broadcaster`.

    Наконец, вместо непосредственного вызова метода клиента из концентратора `Broadcaster` классу необходимо получить ссылку на текущую операционную концентратор (`_hubContext`) с помощью `GlobalHost`.
2. Запустите приложение, нажав клавишу F5. Скопируйте URL-адрес страницы и вставьте его в второе окно браузера. Перетащите фигуру в одно из окон браузера. фигура в другом окне браузера должна перемещаться. В браузере не будет заметного отличия от предыдущего раздела, но количество сообщений, отправляемых клиенту, будет регулироваться.

    ![Окно приложения](tutorial-high-frequency-realtime-with-signalr/_static/image6.png)

<a id="animation"></a>

## <a name="add-smooth-animation-on-the-client"></a>Добавление гладкой анимации на клиенте

Приложение почти готово, но мы можем сделать еще одно улучшение в перемещении фигуры на клиенте, так как оно перемещается в ответ на сообщения сервера. Вместо того чтобы устанавливать положение фигуры в новое место, заданное сервером, мы будем использовать функцию `animate` библиотеки пользовательского интерфейса JQuery для плавного перемещения фигуры между текущей и новой позициями.

1. Обновите метод `updateShape` клиента, чтобы он был похож на выделенный ниже код:

    [!code-html[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample10.html?highlight=35-42)]

    Приведенный выше код перемещает фигуру из старого расположения в новое, заданное сервером в течение интервала анимации (в данном случае 100 миллисекунд). Любая предыдущая анимация, выполняемая на фигуре, удаляется перед началом новой анимации.
2. Запустите приложение, нажав клавишу F5. Скопируйте URL-адрес страницы и вставьте его в второе окно браузера. Перетащите фигуру в одно из окон браузера. фигура в другом окне браузера должна перемещаться. Перемещение фигуры в другом окне должно быть меньше жерки, так как при его перемещении интерполяция изменяется с течением времени, а не задается один раз для каждого входящего сообщения.

    ![Окно приложения](tutorial-high-frequency-realtime-with-signalr/_static/image7.png)

<a id="furthersteps"></a>

## <a name="further-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как программировать приложение SignalR, которое отправляет сообщения высокой частоты между клиентами и серверами. Эта парадигма взаимодействия полезна для разработки Интернет-игр и других симуляций, таких как [игра «прокрутка», созданная с помощью SignalR](http://shootr.signalr.net).

Полное приложение, созданное в этом руководстве, можно скачать из [коллекции кода](https://code.msdn.microsoft.com/SignalR-MoveShape-demo-3366dac6).

Дополнительные сведения о концепциях разработки SignalR см. на следующих сайтах, посвященных исходному коду и ресурсам SignalR:

- [Проект SignalR](http://signalr.net)
- [GitHub и примеры SignalR](https://github.com/SignalR/SignalR)
- [Вики-сайт SignalR](https://github.com/SignalR/SignalR/wiki)
