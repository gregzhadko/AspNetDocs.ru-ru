---
uid: signalr/overview/older-versions/signalr-performance
title: Производительность SignalR (SignalR 1. x) | Документация Майкрософт
author: bradygaster
description: Производительность SignalR
ms.author: bradyg
ms.date: 07/03/2013
ms.assetid: 9594d644-66b6-4223-acdd-23e29a6e4c46
msc.legacyurl: /signalr/overview/older-versions/signalr-performance
msc.type: authoredcontent
ms.openlocfilehash: 915fd822caae9bbcb0a688c6dd7a5b2bda12c9df
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78468108"
---
# <a name="signalr-performance-signalr-1x"></a>Производительность SignalR (SignalR 1.x)

по [Патрик Флетчера](https://github.com/pfletcher)

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

> В этом разделе описывается разработка, измерение и повышение производительности в приложении SignalR.

Последние сведения о производительности и масштабировании SignalR см. в статье [масштабирование веб-сайта в режиме реального времени с помощью ASP.NET SignalR](https://channel9.msdn.com/Events/Build/2013/3-502).

Этот раздел состоит из следующих подразделов.

- [Рекомендации по проектированию](#design)
- [Настройка сервера SignalR для повышения производительности](#tuning)
- [Устранение проблем с производительностью](#troubleshooting)
- [Использование счетчиков производительности SignalR](#perfcounters)
- [Использование других счетчиков производительности](#othercounters)
- [Другие ресурсы](#otherresources)

<a id="design"></a>

## <a name="design-considerations"></a>Рекомендации по проектированию

В этом разделе описываются шаблоны, которые могут быть реализованы во время разработки приложения SignalR, чтобы избежать снижения производительности, создавая ненужный сетевой трафик.

### <a name="throttling-message-frequency"></a>Частота сообщений регулирования

Даже в приложении, которое отправляет сообщения с высокой частотой (например, с игровым приложением реального времени), большинству приложений не требуется отправлять в секунду несколько сообщений. Чтобы уменьшить объем трафика, создаваемого каждым клиентом, можно реализовать цикл обработки сообщений, который помещает очереди и отправляет сообщения не чаще, чем фиксированная скорость (то есть до определенного числа сообщений будет отправляться каждую секунду, если в это время есть сообщения в тервал для отправки). Пример приложения, который регулирует сообщения до определенной скорости (от клиента и сервера), см. в разделе [Высокая частота в реальном времени с SignalR](../getting-started/tutorial-high-frequency-realtime-with-signalr.md).

### <a name="reducing-message-size"></a>Уменьшение размера сообщения

Можно уменьшить размер сообщения SignalR, уменьшив размер сериализованных объектов. В серверном коде при отправке объекта, содержащего свойства, которые не требуется передавать, запретите сериализацию этих свойств с помощью атрибута `JsonIgnore`. Имена свойств также хранятся в сообщении. имена свойств можно сократить с помощью атрибута `JsonProperty`. В следующем примере кода показано, как исключить свойство из отправки клиенту и как сократить имена свойств:

**Серверный код .NET, демонстрирующий атрибут Жсонигноре для исключения данных из отправки клиенту, а атрибут JsonProperty — для уменьшения размера сообщения.**

[!code-csharp[Main](signalr-performance/samples/sample1.cs?highlight=5,7,10)]

Чтобы сохранить удобочитаемость и удобство сопровождения в клиентском коде, сокращенные имена свойств можно повторно сопоставить с понятными именами после получения сообщения. В следующем примере кода демонстрируется один из возможных способов повторного сопоставления сокращенных имен с более длинными, путем определения контракта сообщения (сопоставления) и использования функции `reMap` для применения контракта к оптимизированному классу сообщений:

**Код JavaScript на стороне клиента, который повторно сопоставляет сокращенные имена свойств с понятными для человека именами.**

[!code-javascript[Main](signalr-performance/samples/sample2.js)]

Имена можно также сократить в сообщениях от клиента на сервере, используя тот же метод.

Уменьшение объема памяти (т. е. объема памяти, используемого для сообщения) объекта Message также может повысить производительность. Например, если полный диапазон `int` не требуется, вместо него можно использовать `short` или `byte`.

Так как сообщения хранятся в памяти сервера в шине сообщений, уменьшение размера сообщений может также привести к проблемам с памятью сервера.

<a id="tuning"></a>

### <a name="tuning-your-signalr-server-for-performance"></a>Настройка сервера SignalR для повышения производительности

Следующие параметры конфигурации можно использовать для настройки сервера для повышения производительности в приложении SignalR. Общие сведения о том, как повысить производительность приложения ASP.NET, см. в разделе [улучшение производительности ASP.NET](https://msdn.microsoft.com/library/ff647787.aspx).

**Параметры конфигурации SignalR**

- **Дефаултмессажебуфферсизе**: по умолчанию signalr поддерживает 1000 сообщений в памяти на каждый концентратор на каждое соединение. Если используются большие сообщения, это может привести к возникновению проблем с памятью, которые можно сократить, уменьшив это значение. Этот параметр можно задать в обработчике `Application_Start` событий в приложении ASP.NET или в методе `Configuration` класса запуска OWIN в собственном приложении. В следующем примере показано, как уменьшить это значение, чтобы уменьшить объем памяти, занимаемый приложением, чтобы сократить используемую память сервера:

    **Код сервера .NET в Global. asax для уменьшения размера буфера сообщений по умолчанию**

    [!code-csharp[Main](signalr-performance/samples/sample3.cs)]

**Параметры конфигурации IIS**

- **Максимальное число одновременных запросов на приложение**: увеличение числа одновременных запросов IIS увеличит количество ресурсов сервера, доступных для обслуживания запросов. Значение по умолчанию — 5000; чтобы увеличить этот параметр, выполните следующие команды в командной строке с повышенными привилегиями:

    [!code-console[Main](signalr-performance/samples/sample4.cmd)]

**Параметры конфигурации ASP.NET**

В этом разделе содержатся параметры конфигурации, которые можно задать в файле `aspnet.config`. Этот файл находится в одном из двух расположений в зависимости от платформы:

- `%windir%\Microsoft.NET\Framework\v4.0.30319\aspnet.config`
- `%windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet.config`

Параметры ASP.NET, которые могут улучшить производительность SignalR, включают следующее:

- **Максимальное число одновременных запросов на ЦП**: увеличение этого значения может привести к снижению узких мест производительности. Чтобы увеличить этот параметр, добавьте следующий параметр конфигурации в файл `aspnet.config`:

    [!code-xml[Main](signalr-performance/samples/sample5.xml?highlight=4)]
- **Ограничение очереди запросов**: Если общее число соединений превышает значение параметра `maxConcurrentRequestsPerCPU`, ASP.NET начнет регулирование запросов с помощью очереди. Чтобы увеличить размер очереди, можно увеличить значение параметра `requestQueueLimit`. Для этого добавьте следующий параметр конфигурации в узел `processModel` в `config/machine.config` (а не `aspnet.config`):

    [!code-xml[Main](signalr-performance/samples/sample6.xml)]

<a id="troubleshooting"></a>

## <a name="troubleshooting-performance-issues"></a>Устранение проблем с производительностью

В этом разделе описываются способы поиска узких мест производительности в приложении.

### <a name="verifying-that-websocket-is-being-used"></a>Проверка использования WebSocket

Хотя SignalR может использовать разнообразные транспорты для обмена данными между клиентом и сервером, WebSocket обеспечивает значительное преимущество в производительности и следует использовать, если клиент и сервер его поддерживают. Чтобы определить, соответствуют ли клиент и сервер требованиям WebSocket, см. раздел [транспорты и резервные](../getting-started/introduction-to-signalr.md#transports)серверы. Чтобы определить, какой транспорт используется в приложении, можно использовать средства разработчика браузера и просмотреть журналы, чтобы узнать, какой транспорт используется для подключения. Сведения об использовании средств разработки браузеров в Internet Explorer и Chrome см. в статье [транспорты и резервные стратегии](../getting-started/introduction-to-signalr.md#transports).

<a id="perfcounters"></a>

## <a name="using-signalr-performance-counters"></a>Использование счетчиков производительности SignalR

В этом разделе описывается включение и использование счетчиков производительности SignalR, найденных в пакете `Microsoft.AspNet.SignalR.Utils`.

### <a name="installing-signalrexe"></a>Установка SignalR. exe

Счетчики производительности можно добавить на сервер с помощью служебной программы SignalR. exe. Чтобы установить эту программу, выполните следующие действия.

1. В Visual Studio выберите **инструменты** > **диспетчер пакетов NuGet** > **Управление пакетами NuGet для решения**
2. Найдите **SignalR. utils**и нажмите кнопку установить.

    ![](signalr-performance/_static/image1.png)
3. Примите условия лицензионного соглашения, чтобы установить пакет.
4. SignalR. exe будет установлен для `<project folder>/packages/Microsoft.AspNet.SignalR.Utils.<version>/tools`.

### <a name="installing-performance-counters-with-signalrexe"></a>Установка счетчиков производительности с помощью SignalR. exe

Чтобы установить счетчики производительности SignalR, запустите SignalR. exe в командной строке с повышенными привилегиями со следующим параметром:

[!code-console[Main](signalr-performance/samples/sample7.cmd)]

Чтобы удалить счетчики производительности SignalR, запустите SignalR. exe в командной строке с повышенными привилегиями со следующим параметром:

[!code-console[Main](signalr-performance/samples/sample8.cmd)]

### <a name="signalr-performance-counters"></a>Счетчики производительности SignalR

Пакет служебных программ устанавливает следующие счетчики производительности. Счетчик "всего" измеряет количество событий, произошедших с момента последнего перезапуска сервера или пула приложений.

**Метрики подключения**

Следующие метрики измеряют происходящие события времени существования соединения. Дополнительные сведения см. в разделе [Основные сведения и обработка событий времени жизни соединения](../guide-to-the-api/handling-connection-lifetime-events.md).

- **Подключено подключений**
- **Подключения повторно подключены**
- **Подключения отключены**
- **Текущих подключений**

**Метрики сообщений**

Следующие метрики измеряют трафик сообщений, создаваемый SignalR.

- **Всего получено сообщений подключения**
- **Всего Отправлено сообщений подключения**
- **Получено сообщений о соединении/с**
- **Отправлено сообщений о соединении/с**

**Метрики шины сообщений**

Следующие метрики измеряют трафик через внутреннюю шину сообщений SignalR, очередь, в которой размещаются все входящие и исходящие сообщения SignalR. Сообщение **публикуется** во время отправки или вещания. **Подписчик** в этом контексте является подпиской на канале сообщений; Это число должно равняться числу клиентов плюс сам сервер. **Выделенный рабочий процесс** — это компонент, который отправляет данные в активные соединения; **занятая рабочая роль** — это одна из них, которая активно отправляет сообщение.

- **Всего получено сообщений в шине сообщений**
- **Получено сообщений в шине сообщений/с**
- **Всего опубликованных сообщений в шине сообщений**
- **Опубликовано сообщений в шине сообщений/с**
- **Текущие подписчики шины сообщений**
- **Всего подписчиков на шину сообщений**
- **Подписчиков шины сообщений/с**
- **Выделенные рабочие процессы шины сообщений**
- **Рабочие процессы, занятые шиной сообщений**
- **Актуальные разделы шины сообщений**

**Метрики ошибок**

Следующие метрики измеряют ошибки, создаваемые трафиком сообщений SignalR. Ошибки **разрешения концентратора** возникают, когда не удается разрешить концентратор или метод концентратора. Ошибки **вызова концентратора** — это исключения, возникающие при вызове метода концентратора. Ошибки **транспорта** — это ошибки соединения, возникающие во время HTTP-запроса или ответа.

- **Ошибки: все итоги**
- **Ошибок: "всего/с"**
- **Ошибки: общее разрешение концентратора**
- **Ошибки: разрешение концентратора/с**
- **Ошибки: всего вызовов концентратора**
- **Ошибки: вызов концентратора/с**
- **Ошибки: всего транспортных**
- **Ошибки: транспорт/с**

**Метрики масштабирования**

Следующие метрики измеряют трафик и ошибки, созданные поставщиком масштабирования. **Поток** в этом контексте — это единица масштабирования, используемая поставщиком масштабирования; Это таблица, если используется SQL Server, раздел, если используется служебная шина, и подписка, если используется Redis. По умолчанию используется только один поток, но его можно увеличить с помощью настройки SQL Server и служебной шины. Поток **буферизации** — это тот, который перешел в состояние сбоя. Если поток находится в состоянии сбоя, все сообщения, отправленные на объединительную плату, будут завершаться сбоем сразу, пока поток не завершится ошибкой. **Длина очереди отправки** — это количество сообщений, которые были отправлены, но еще не отправлены.

- **Получено сообщений в канале масштабирования сообщений в секунду**
- **Всего потоков масштабирования**
- **Открытие потоков масштабирования**
- **Буферизация потоков с масштабированием**
- **Всего ошибок масштабирования**
- **Ошибок масштабирования/с**
- **Длина очереди отправки при увеличении**

Дополнительные сведения об измерении этих счетчиков см. в разделе [масштабирование SignalR с помощью служебной шины Azure](scaleout-with-windows-azure-service-bus.md).

<a id="othercounters"></a>

## <a name="using-other-performance-counters"></a>Использование других счетчиков производительности

Следующие счетчики производительности также могут быть полезны при наблюдении за производительностью приложения.

**Память**

- Память CLR .NET байт во всех кучах (для w3wp)

**ASP.NET**

- Текущий ASP. NET \ запросов
- ASP.NET\Queued
- ASP.NET\Rejected

**ЦП**

- Время Информатион\процессор процессора

**TCP/IP**

- TCPv6/подключения установлены
- TCPv4/подключения установлены

**Веб-служба**

- Подключения к веб-служба \ текущих
- Подключения к веб-Сервице\максимум

**Работа с потоками**

- LocksAndThreads CLR .NET\# из текущих логических потоков
- Потоки Локксанд CLR .NET\# из текущих физических потоков

<a id="otherresources"></a>

## <a name="other-resources"></a>Другие ресурсы

Дополнительные сведения о мониторинге производительности ASP.NET и настройке см. в следующих разделах:

- [Общие сведения о производительности ASP.NET](https://msdn.microsoft.com/library/cc668225(v=vs.100).aspx)
- [Использование потоков ASP.NET в IIS 7,5, IIS 7,0 и IIS 6,0](https://blogs.msdn.com/b/tmarq/archive/2007/07/21/asp-net-thread-usage-on-iis-7-0-and-6-0.aspx)
- [Элемент &lt;applicationPool&gt; (веб-параметры)](https://msdn.microsoft.com/library/dd560842.aspx)
