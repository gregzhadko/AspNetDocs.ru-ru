---
uid: signalr/overview/older-versions/tutorial-server-broadcast-with-aspnet-signalr
title: Учебник. серверное вещание с помощью ASP.NET SignalR 1. x | Документация Майкрософт
author: bradygaster
description: В этом руководстве показано, как создать веб-приложение, которое использует SignalR ASP.NET для предоставления функций серверной широковещательной рассылки. Широковещательная рассылка сервера означает, что Коммуник...
ms.author: bradyg
ms.date: 04/10/2013
ms.assetid: ab7b2554-956a-4f6d-b2a0-4ae0c62e8580
msc.legacyurl: /signalr/overview/older-versions/tutorial-server-broadcast-with-aspnet-signalr
msc.type: authoredcontent
ms.openlocfilehash: 68908be34f6b010e512677fe5f5e31bfdefab592
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78467934"
---
# <a name="tutorial-server-broadcast-with-aspnet-signalr-1x"></a><span data-ttu-id="0a57f-104">Учебник. широковещательная рассылка сервера с помощью ASP.NET SignalR 1. x</span><span class="sxs-lookup"><span data-stu-id="0a57f-104">Tutorial: Server Broadcast with ASP.NET SignalR 1.x</span></span>

<span data-ttu-id="0a57f-105">[Патрик Флетчера](https://github.com/pfletcher), [Tom Dykstra)](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="0a57f-105">by [Patrick Fletcher](https://github.com/pfletcher), [Tom Dykstra](https://github.com/tdykstra)</span></span>

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

> <span data-ttu-id="0a57f-106">В этом руководстве показано, как создать веб-приложение, которое использует SignalR ASP.NET для предоставления функций серверной широковещательной рассылки.</span><span class="sxs-lookup"><span data-stu-id="0a57f-106">This tutorial shows how to create a web application that uses ASP.NET SignalR to provide server broadcast functionality.</span></span> <span data-ttu-id="0a57f-107">Серверное вещание означает, что связь, отправляемая клиентам, инициируется сервером.</span><span class="sxs-lookup"><span data-stu-id="0a57f-107">Server broadcast means that communications sent to clients are initiated by the server.</span></span> <span data-ttu-id="0a57f-108">В этом сценарии требуется другой подход к программированию, чем в одноранговых сценариях, таких как приложения для разговора, при которых связь, отправляемая клиентам, инициируется одним или несколькими клиентами.</span><span class="sxs-lookup"><span data-stu-id="0a57f-108">This scenario requires a different programming approach than peer-to-peer scenarios such as chat applications, in which communications sent to clients are initiated by one or more of the clients.</span></span>
> 
> <span data-ttu-id="0a57f-109">Приложение, которое будет создано в этом учебнике, имитирует биржевое биржевое, типичный сценарий для серверной функции вещания.</span><span class="sxs-lookup"><span data-stu-id="0a57f-109">The application that you'll create in this tutorial simulates a stock ticker, a typical scenario for server broadcast functionality.</span></span>
> 
> <span data-ttu-id="0a57f-110">Комментарии в учебнике — Добро пожаловать.</span><span class="sxs-lookup"><span data-stu-id="0a57f-110">Comments on the tutorial are welcome.</span></span> <span data-ttu-id="0a57f-111">Если у вас есть вопросы, не связанные непосредственно с этим руководством, их можно опубликовать на [форуме ASP.NET SignalR](https://forums.asp.net/1254.aspx/1?ASP+NET+SignalR) или [StackOverflow.com](http://stackoverflow.com).</span><span class="sxs-lookup"><span data-stu-id="0a57f-111">If you have questions that are not directly related to the tutorial, you can post them to the [ASP.NET SignalR forum](https://forums.asp.net/1254.aspx/1?ASP+NET+SignalR) or [StackOverflow.com](http://stackoverflow.com).</span></span>

## <a name="overview"></a><span data-ttu-id="0a57f-112">Обзор</span><span class="sxs-lookup"><span data-stu-id="0a57f-112">Overview</span></span>

<span data-ttu-id="0a57f-113">Пакет NuGet [Microsoft. AspNet. SignalR. Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) устанавливает пример смоделированного приложения для биржевых котировок в проекте Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="0a57f-113">The [Microsoft.AspNet.SignalR.Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) NuGet package installs a sample simulated stock ticker application in a Visual Studio project.</span></span> <span data-ttu-id="0a57f-114">В первой части этого руководства вы создадите упрощенную версию приложения с нуля.</span><span class="sxs-lookup"><span data-stu-id="0a57f-114">In the first part of this tutorial, you'll create a simplified version of that application from scratch.</span></span> <span data-ttu-id="0a57f-115">В оставшейся части руководства вы установите пакет NuGet и ознакомьтесь с дополнительными функциями и кодом, который он создает.</span><span class="sxs-lookup"><span data-stu-id="0a57f-115">In the remainder of the tutorial, you'll install the NuGet package and review the additional features and code that it creates.</span></span>

<span data-ttu-id="0a57f-116">Приложение для биржевых котировок является репрезентативным видом приложения в режиме реального времени, в котором требуется периодически "отправлять" или рассылать уведомления от сервера на все подключенные клиенты.</span><span class="sxs-lookup"><span data-stu-id="0a57f-116">The stock ticker application is a representative of a kind of real-time application in which you want to periodically "push," or broadcast, notifications from the server to all connected clients.</span></span>

<span data-ttu-id="0a57f-117">В приложении, которое будет создаваться в первой части этого учебника, отображается сетка с данными об акциях.</span><span class="sxs-lookup"><span data-stu-id="0a57f-117">The application that you'll build in the first part of this tutorial displays a grid with stock data.</span></span>

![Исходная версия Стокктиккер](tutorial-server-broadcast-with-aspnet-signalr/_static/image1.png)

<span data-ttu-id="0a57f-119">Периодически сервер обновляет цены на акции и отправляет обновления на все подключенные клиенты.</span><span class="sxs-lookup"><span data-stu-id="0a57f-119">Periodically the server randomly updates stock prices and pushes the updates to all connected clients.</span></span> <span data-ttu-id="0a57f-120">В браузере числа и символы в столбцах **Change** и **%** динамически меняются в ответ на уведомления от сервера.</span><span class="sxs-lookup"><span data-stu-id="0a57f-120">In the browser the numbers and symbols in the **Change** and **%** columns dynamically change in response to notifications from the server.</span></span> <span data-ttu-id="0a57f-121">Если открыть дополнительные браузеры для одного и того же URL-адреса, все они будут отображать одни и те же данные и одни и те же изменения данных одновременно.</span><span class="sxs-lookup"><span data-stu-id="0a57f-121">If you open additional browsers to the same URL, they all show the same data and the same changes to the data simultaneously.</span></span>

<span data-ttu-id="0a57f-122">Этот учебник содержит следующие подразделы:</span><span class="sxs-lookup"><span data-stu-id="0a57f-122">This tutorial contains the following sections:</span></span>

- [<span data-ttu-id="0a57f-123">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="0a57f-123">Prerequisites</span></span>](#prerequisites)
- [<span data-ttu-id="0a57f-124">Создание проекта</span><span class="sxs-lookup"><span data-stu-id="0a57f-124">Create the project</span></span>](#createproject)
- [<span data-ttu-id="0a57f-125">Добавление пакетов NuGet SignalR</span><span class="sxs-lookup"><span data-stu-id="0a57f-125">Add the SignalR NuGet packages</span></span>](#nugetpackages)
- [<span data-ttu-id="0a57f-126">Настройка серверного кода</span><span class="sxs-lookup"><span data-stu-id="0a57f-126">Set up the server code</span></span>](#server)
- [<span data-ttu-id="0a57f-127">Настройка клиентского кода</span><span class="sxs-lookup"><span data-stu-id="0a57f-127">Set up the client code</span></span>](#client)
- [<span data-ttu-id="0a57f-128">Тестирование приложения</span><span class="sxs-lookup"><span data-stu-id="0a57f-128">Test the application</span></span>](#test)
- [<span data-ttu-id="0a57f-129">Включение ведения журналов</span><span class="sxs-lookup"><span data-stu-id="0a57f-129">Enable logging</span></span>](#enablelogging)
- [<span data-ttu-id="0a57f-130">Установка и проверка полного примера Стокктиккер</span><span class="sxs-lookup"><span data-stu-id="0a57f-130">Install and review the full StockTicker sample</span></span>](#fullsample)
- [<span data-ttu-id="0a57f-131">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="0a57f-131">Next steps</span></span>](#nextsteps)

> [!NOTE]
> <span data-ttu-id="0a57f-132">Если вы не хотите поработать с этапами создания приложения, можно установить пакет SignalR. Sample в новом **пустом проекте веб-приложения ASP.NET** и прочесть эти шаги, чтобы получить объяснения кода.</span><span class="sxs-lookup"><span data-stu-id="0a57f-132">If you don't want to work through the steps of building the application, you can install the SignalR.Sample package in a new **Empty ASP.NET Web Application** project, and read through these steps to get explanations of the code.</span></span> <span data-ttu-id="0a57f-133">В первой части руководства рассматривается подмножество SignalR. пример кода, а во второй части объясняются основные возможности дополнительных функциональных возможностей в пакете SignalR. Sample.</span><span class="sxs-lookup"><span data-stu-id="0a57f-133">The first part of the tutorial covers a subset of the SignalR.Sample code, and the second part explains key features of the additional functionality in the SignalR.Sample package.</span></span>

<a id="prerequisites"></a>

## <a name="prerequisites"></a><span data-ttu-id="0a57f-134">предварительные требования</span><span class="sxs-lookup"><span data-stu-id="0a57f-134">Prerequisites</span></span>

<span data-ttu-id="0a57f-135">Прежде чем начать, убедитесь, что на компьютере установлен Visual Studio 2012 или 2010 с пакетом обновления 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="0a57f-135">Before you start, make sure that you have Visual Studio 2012 or 2010 SP1 installed on your computer.</span></span> <span data-ttu-id="0a57f-136">Если у вас нет Visual Studio, см. [ASP.net downloads](https://www.asp.net/downloads) , чтобы получить бесплатный выпуск visual Studio 2012 Express для Web.</span><span class="sxs-lookup"><span data-stu-id="0a57f-136">If you don't have Visual Studio, see [ASP.NET Downloads](https://www.asp.net/downloads) to get the free Visual Studio 2012 Express for Web.</span></span>

<span data-ttu-id="0a57f-137">Если у вас есть Visual Studio 2010, убедитесь, что [NuGet](https://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c) установлен.</span><span class="sxs-lookup"><span data-stu-id="0a57f-137">If you have Visual Studio 2010, make sure that [NuGet](https://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c) is installed.</span></span>

<a id="createproject"></a>

## <a name="create-the-project"></a><span data-ttu-id="0a57f-138">Создание проекта</span><span class="sxs-lookup"><span data-stu-id="0a57f-138">Create the project</span></span>

1. <span data-ttu-id="0a57f-139">В меню **Файл** выберите **Новый проект**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-139">From the **File** menu click **New Project**.</span></span>
2. <span data-ttu-id="0a57f-140">В диалоговом окне **Новый проект** разверните узел **C#** **шаблоны** и выберите **веб**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-140">In the **New Project** dialog box, expand **C#** under **Templates** and select **Web**.</span></span>
3. <span data-ttu-id="0a57f-141">Выберите шаблон **пустое веб-приложение ASP.NET** , назовите проект *SignalR. стокктиккер*и нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-141">Select the **ASP.NET Empty Web Application** template, name the project *SignalR.StockTicker*, and click **OK**.</span></span>

    ![Диалоговое окно «Создание проекта»](tutorial-server-broadcast-with-aspnet-signalr/_static/image2.png)

<a id="nugetpackages"></a>

## <a name="add-the-signalr-nuget-packages"></a><span data-ttu-id="0a57f-143">Добавление пакетов NuGet SignalR</span><span class="sxs-lookup"><span data-stu-id="0a57f-143">Add the SignalR NuGet Packages</span></span>

### <a name="add-the-signalr-and-jquery-nuget-packages"></a><span data-ttu-id="0a57f-144">Добавление пакетов NuGet SignalR и JQuery</span><span class="sxs-lookup"><span data-stu-id="0a57f-144">Add the SignalR and JQuery NuGet Packages</span></span>

<span data-ttu-id="0a57f-145">Функциональные возможности SignalR можно добавить в проект, установив пакет NuGet.</span><span class="sxs-lookup"><span data-stu-id="0a57f-145">You can add SignalR functionality to a project by installing a NuGet package.</span></span>

1. <span data-ttu-id="0a57f-146">Щелкните **Сервис | Диспетчер пакетов NuGet | Консоль диспетчера пакетов**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-146">Click **Tools | NuGet Package Manager | Package Manager Console**.</span></span>
2. <span data-ttu-id="0a57f-147">Введите следующую команду в диспетчере пакетов.</span><span class="sxs-lookup"><span data-stu-id="0a57f-147">Enter the following command in the package manager.</span></span>

    [!code-powershell[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample1.ps1)]

    <span data-ttu-id="0a57f-148">Пакет SignalR устанавливает ряд других пакетов NuGet в качестве зависимостей.</span><span class="sxs-lookup"><span data-stu-id="0a57f-148">The SignalR package installs a number of other NuGet packages as dependencies.</span></span> <span data-ttu-id="0a57f-149">По завершении установки у вас будут все компоненты сервера и клиента, необходимые для использования SignalR в приложении ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="0a57f-149">When the installation is finished you have all of the server and client components required to use SignalR in an ASP.NET application.</span></span>

<a id="server"></a>

## <a name="set-up-the-server-code"></a><span data-ttu-id="0a57f-150">Настройка кода сервера</span><span class="sxs-lookup"><span data-stu-id="0a57f-150">Set up the server code</span></span>

<span data-ttu-id="0a57f-151">В этом разделе вы настроите код, который выполняется на сервере.</span><span class="sxs-lookup"><span data-stu-id="0a57f-151">In this section you set up the code that runs on the server.</span></span>

### <a name="create-the-stock-class"></a><span data-ttu-id="0a57f-152">Создание класса акции</span><span class="sxs-lookup"><span data-stu-id="0a57f-152">Create the Stock class</span></span>

<span data-ttu-id="0a57f-153">Начнем с создания класса «складская модель», который будет использоваться для хранения и передачи информации о акции.</span><span class="sxs-lookup"><span data-stu-id="0a57f-153">You begin by creating the Stock model class that you'll use to store and transmit information about a stock.</span></span>

1. <span data-ttu-id="0a57f-154">Создайте новый файл класса в папке проекта, назовите его *Stock.CS*, а затем замените код шаблона следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="0a57f-154">Create a new class file in the project folder, name it *Stock.cs*, and then replace the template code with the following code:</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample2.cs)]

    <span data-ttu-id="0a57f-155">Два свойства, которые вы задаете при создании акций, — это символ (например, MSFT для Майкрософт) и цена.</span><span class="sxs-lookup"><span data-stu-id="0a57f-155">The two properties that you'll set when you create stocks are the Symbol (for example, MSFT for Microsoft) and the Price.</span></span> <span data-ttu-id="0a57f-156">Другие свойства зависят от того, как и когда задается цена.</span><span class="sxs-lookup"><span data-stu-id="0a57f-156">The other properties depend on how and when you set Price.</span></span> <span data-ttu-id="0a57f-157">При первом задании цены значение будет распространяться на Дайопен.</span><span class="sxs-lookup"><span data-stu-id="0a57f-157">The first time you set Price, the value gets propagated to DayOpen.</span></span> <span data-ttu-id="0a57f-158">В последующих случаях при задании цены значения свойств Change и Перцентчанже рассчитываются на основе разницы между ценами и Дайопен.</span><span class="sxs-lookup"><span data-stu-id="0a57f-158">Subsequent times when you set Price, the Change and PercentChange property values are calculated based on the difference between Price and DayOpen.</span></span>

### <a name="create-the-stockticker-and-stocktickerhub-classes"></a><span data-ttu-id="0a57f-159">Создание классов Стокктиккер и Стокктиккерхуб</span><span class="sxs-lookup"><span data-stu-id="0a57f-159">Create the StockTicker and StockTickerHub classes</span></span>

<span data-ttu-id="0a57f-160">Для обработки взаимодействия "сервер-клиент" вы будете использовать API концентратора SignalR.</span><span class="sxs-lookup"><span data-stu-id="0a57f-160">You'll use the SignalR Hub API to handle server-to-client interaction.</span></span> <span data-ttu-id="0a57f-161">Класс Стокктиккерхуб, производный от класса концентратора SignalR, будет выполнять получение подключений и вызовов методов от клиентов.</span><span class="sxs-lookup"><span data-stu-id="0a57f-161">A StockTickerHub class that derives from the SignalR Hub class will handle receiving connections and method calls from clients.</span></span> <span data-ttu-id="0a57f-162">Кроме того, необходимо сохранить данные на бирже и запустить объект таймера для периодического запуска обновлений цен независимо от клиентских подключений.</span><span class="sxs-lookup"><span data-stu-id="0a57f-162">You also need to maintain stock data and run a Timer object to periodically trigger price updates, independently of client connections.</span></span> <span data-ttu-id="0a57f-163">Эти функции нельзя разместить в центральном классе, так как экземпляры концентратора являются временными.</span><span class="sxs-lookup"><span data-stu-id="0a57f-163">You can't put these functions in a Hub class, because Hub instances are transient.</span></span> <span data-ttu-id="0a57f-164">Для каждой операции в концентраторе создается экземпляр класса концентратора, например подключения и вызовы от клиента к серверу.</span><span class="sxs-lookup"><span data-stu-id="0a57f-164">A Hub class instance is created for each operation on the hub, such as connections and calls from the client to the server.</span></span> <span data-ttu-id="0a57f-165">Таким образом, механизм, который хранит данные на бирже, обновляет цены и выполняет широковещательную рассылку, должен выполняться в отдельном классе, который наименее Стокктиккер.</span><span class="sxs-lookup"><span data-stu-id="0a57f-165">So the mechanism that keeps stock data, updates prices, and broadcasts the price updates has to run in a separate class, which you'll name StockTicker.</span></span>

![Вещание от Стокктиккер](tutorial-server-broadcast-with-aspnet-signalr/_static/image4.png)

<span data-ttu-id="0a57f-167">Необходимо, чтобы на сервере выполнялся только один экземпляр класса Стокктиккер, поэтому необходимо настроить ссылку из каждого экземпляра Стокктиккерхуб на одноэлементный экземпляр Стокктиккер.</span><span class="sxs-lookup"><span data-stu-id="0a57f-167">You only want one instance of the StockTicker class to run on the server, so you'll need to set up a reference from each StockTickerHub instance to the singleton StockTicker instance.</span></span> <span data-ttu-id="0a57f-168">Класс Стокктиккер должен иметь возможность выполнять широковещательную рассылку на клиентах, так как он содержит данные о акции и инициирует обновления, но Стокктиккер не является классом концентратора.</span><span class="sxs-lookup"><span data-stu-id="0a57f-168">The StockTicker class has to be able to broadcast to clients because it has the stock data and triggers updates, but StockTicker is not a Hub class.</span></span> <span data-ttu-id="0a57f-169">Таким образом, класс Стокктиккер должен получить ссылку на объект контекста подключения концентратора SignalR.</span><span class="sxs-lookup"><span data-stu-id="0a57f-169">Therefore, the StockTicker class has to get a reference to the SignalR Hub connection context object.</span></span> <span data-ttu-id="0a57f-170">Затем он может использовать объект контекста подключения SignalR для передачи клиентам.</span><span class="sxs-lookup"><span data-stu-id="0a57f-170">It can then use the SignalR connection context object to broadcast to clients.</span></span>

1. <span data-ttu-id="0a57f-171">В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите команду **Добавить новый элемент**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-171">In **Solution Explorer**, right-click the project and click **Add New Item**.</span></span>
2. <span data-ttu-id="0a57f-172">Если у вас есть Visual Studio 2012 с [обновлением ASP.NET and Web Tools 2012,2](https://go.microsoft.com/fwlink/?LinkId=279941), щелкните **веб-сайт** в разделе **Visual C#**  и выберите шаблон элемента **класса концентратора SignalR** .</span><span class="sxs-lookup"><span data-stu-id="0a57f-172">If you have Visual Studio 2012 with the [ASP.NET and Web Tools 2012.2 Update](https://go.microsoft.com/fwlink/?LinkId=279941), click **Web** under **Visual C#** and select the **SignalR Hub Class** item template.</span></span> <span data-ttu-id="0a57f-173">В противном случае выберите шаблон **класса** .</span><span class="sxs-lookup"><span data-stu-id="0a57f-173">Otherwise, select the **Class** template.</span></span>
3. <span data-ttu-id="0a57f-174">Назовите новый класс *StockTickerHub.CS*и нажмите кнопку **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-174">Name the new class *StockTickerHub.cs*, and then click **Add**.</span></span>

    ![Добавить StockTickerHub.cs](tutorial-server-broadcast-with-aspnet-signalr/_static/image5.png)
4. <span data-ttu-id="0a57f-176">Замените код шаблона следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="0a57f-176">Replace the template code with the following code:</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample3.cs)]

    <span data-ttu-id="0a57f-177">Класс [Hub](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hub(v=vs.111).aspx) используется для определения методов, которые клиенты могут вызывать на сервере.</span><span class="sxs-lookup"><span data-stu-id="0a57f-177">The [Hub](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hub(v=vs.111).aspx) class is used to define methods the clients can call on the server.</span></span> <span data-ttu-id="0a57f-178">Вы определяете один метод: `GetAllStocks()`.</span><span class="sxs-lookup"><span data-stu-id="0a57f-178">You are defining one method: `GetAllStocks()`.</span></span> <span data-ttu-id="0a57f-179">Когда клиент изначально подключается к серверу, он вызывает этот метод, чтобы получить список всех акций с текущими ценами.</span><span class="sxs-lookup"><span data-stu-id="0a57f-179">When a client initially connects to the server, it will call this method to get a list of all of the stocks with their current prices.</span></span> <span data-ttu-id="0a57f-180">Метод может выполняться синхронно и возвращать `IEnumerable<Stock>`, так как он возвращает данные из памяти.</span><span class="sxs-lookup"><span data-stu-id="0a57f-180">The method can execute synchronously and return `IEnumerable<Stock>` because it is returning data from memory.</span></span> <span data-ttu-id="0a57f-181">Если методу пришлось бы получать данные, выполняя что-либо, включающее в себя ожидание, например поиск базы данных или вызов веб-службы, необходимо указать `Task<IEnumerable<Stock>>` как возвращаемое значение, чтобы включить асинхронную обработку.</span><span class="sxs-lookup"><span data-stu-id="0a57f-181">If the method had to get the data by doing something that would involve waiting, such as a database lookup or a web service call, you would specify `Task<IEnumerable<Stock>>` as the return value to enable asynchronous processing.</span></span> <span data-ttu-id="0a57f-182">Дополнительные сведения см. [в разделе ASP.NET SignalR Hubs Guide-Server-on to Execute On асинхронное выполнение](index.md).</span><span class="sxs-lookup"><span data-stu-id="0a57f-182">For more information, see [ASP.NET SignalR Hubs API Guide - Server - When to execute asynchronously](index.md).</span></span>

    <span data-ttu-id="0a57f-183">Атрибут HubName указывает, как на клиенте будет ссылаться центр кода JavaScript.</span><span class="sxs-lookup"><span data-stu-id="0a57f-183">The HubName attribute specifies how the Hub will be referenced in JavaScript code on the client.</span></span> <span data-ttu-id="0a57f-184">Имя по умолчанию на клиенте, если этот атрибут не используется, — это версия имени класса в стиле Camel, которая в данном случае будет Стокктиккерхуб.</span><span class="sxs-lookup"><span data-stu-id="0a57f-184">The default name on the client if you don't use this attribute is a camel-cased version of the class name, which in this case would be stockTickerHub.</span></span>

    <span data-ttu-id="0a57f-185">Как вы увидите позже при создании класса Стокктиккер, в его свойстве статического экземпляра создается одноэлементный экземпляр этого класса.</span><span class="sxs-lookup"><span data-stu-id="0a57f-185">As you'll see later when you create the StockTicker class, a singleton instance of that class is created in its static Instance property.</span></span> <span data-ttu-id="0a57f-186">Этот одноэлементный экземпляр Стокктиккер остается в памяти независимо от того, сколько клиентов подключается или отключается, и что этот экземпляр использует метод Жеталлстоккс для возврата текущих сведений о акции.</span><span class="sxs-lookup"><span data-stu-id="0a57f-186">That singleton instance of StockTicker remains in memory no matter how many clients connect or disconnect, and that instance is what the GetAllStocks method uses to return current stock information.</span></span>
5. <span data-ttu-id="0a57f-187">Создайте новый файл класса в папке проекта, назовите его *StockTicker.CS*, а затем замените код шаблона следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="0a57f-187">Create a new class file in the project folder, name it *StockTicker.cs*, and then replace the template code with the following code:</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample4.cs)]

    <span data-ttu-id="0a57f-188">Поскольку несколько потоков будут выполнять один и тот же экземпляр Стокктиккер кода, класс Стокктиккер должен быть среадсафе.</span><span class="sxs-lookup"><span data-stu-id="0a57f-188">Since multiple threads will be running the same instance of StockTicker code, the StockTicker class has to be threadsafe.</span></span>

    ### <a name="storing-the-singleton-instance-in-a-static-field"></a><span data-ttu-id="0a57f-189">Сохранение одноэлементного экземпляра в статическом поле</span><span class="sxs-lookup"><span data-stu-id="0a57f-189">Storing the singleton instance in a static field</span></span>

    <span data-ttu-id="0a57f-190">Код инициализирует статическое поле экземпляра \_, которое выполняет резервное копирование свойства экземпляра с помощью экземпляра класса, и это единственный экземпляр класса, который можно создать, поскольку конструктор помечен как частный.</span><span class="sxs-lookup"><span data-stu-id="0a57f-190">The code initializes the static \_instance field that backs the Instance property with an instance of the class, and this is the only instance of the class that can be created, because the constructor is marked as private.</span></span> <span data-ttu-id="0a57f-191">[Отложенная инициализация](https://msdn.microsoft.com/library/dd997286.aspx) используется для поля экземпляра \_, а не по соображениям производительности, но для обеспечения среадсафе создания экземпляра.</span><span class="sxs-lookup"><span data-stu-id="0a57f-191">[Lazy initialization](https://msdn.microsoft.com/library/dd997286.aspx) is used for the \_instance field, not for performance reasons but to ensure that the instance creation is threadsafe.</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample5.cs)]

    <span data-ttu-id="0a57f-192">Каждый раз, когда клиент подключается к серверу, новый экземпляр класса Стокктиккерхуб, выполняющийся в отдельном потоке, получает одноэлементный экземпляр Стокктиккер из статического свойства Стокктиккер. instance, как было показано ранее в классе Стокктиккерхуб.</span><span class="sxs-lookup"><span data-stu-id="0a57f-192">Each time a client connects to the server, a new instance of the StockTickerHub class running in a separate thread gets the StockTicker singleton instance from the StockTicker.Instance static property, as you saw earlier in the StockTickerHub class.</span></span>

    ### <a name="storing-stock-data-in-a-concurrentdictionary"></a><span data-ttu-id="0a57f-193">Хранение данных о акции в ConcurrentDictionary</span><span class="sxs-lookup"><span data-stu-id="0a57f-193">Storing stock data in a ConcurrentDictionary</span></span>

    <span data-ttu-id="0a57f-194">Конструктор инициализирует \_коллекцию акций с помощью некоторых примеров биржевых данных, а Жеталлстоккс возвращает акции.</span><span class="sxs-lookup"><span data-stu-id="0a57f-194">The constructor initializes the \_stocks collection with some sample stock data, and GetAllStocks returns the stocks.</span></span> <span data-ttu-id="0a57f-195">Как было показано ранее, эта коллекция акций в свою очередь возвращается функцией Стокктиккерхуб. Жеталлстоккс, которая является методом сервера в классе Hub, который может вызываться клиентами.</span><span class="sxs-lookup"><span data-stu-id="0a57f-195">As you saw earlier, this collection of stocks is in turn returned by StockTickerHub.GetAllStocks which is a server method in the Hub class that clients can call.</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample6.cs)]

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample7.cs)]

    <span data-ttu-id="0a57f-196">Коллекция Stocks определяется как тип [ConcurrentDictionary](https://msdn.microsoft.com/library/dd287191.aspx) для потокобезопасности.</span><span class="sxs-lookup"><span data-stu-id="0a57f-196">The stocks collection is defined as a [ConcurrentDictionary](https://msdn.microsoft.com/library/dd287191.aspx) type for thread safety.</span></span> <span data-ttu-id="0a57f-197">В качестве альтернативы можно использовать объект [Dictionary](https://msdn.microsoft.com/library/xfhwa508.aspx) и явным образом заблокировать словарь при внесении в него изменений.</span><span class="sxs-lookup"><span data-stu-id="0a57f-197">As an alternative, you could use a [Dictionary](https://msdn.microsoft.com/library/xfhwa508.aspx) object and explicitly lock the dictionary when you make changes to it.</span></span>

    <span data-ttu-id="0a57f-198">Для этого примера приложения можно сохранить данные приложения в памяти и потерять данные при удалении экземпляра Стокктиккер.</span><span class="sxs-lookup"><span data-stu-id="0a57f-198">For this sample application, it's OK to store application data in memory and to lose the data when the StockTicker instance is disposed.</span></span> <span data-ttu-id="0a57f-199">В реальном приложении вы бы работали с серверным хранилищем данных, например базой данных.</span><span class="sxs-lookup"><span data-stu-id="0a57f-199">In a real application you would work with a back-end data store such as a database.</span></span>

    ### <a name="periodically-updating-stock-prices"></a><span data-ttu-id="0a57f-200">Периодическое обновление цен на акции</span><span class="sxs-lookup"><span data-stu-id="0a57f-200">Periodically updating stock prices</span></span>

    <span data-ttu-id="0a57f-201">Конструктор запускает объект Timer, который периодически вызывает методы, которые обновляют цены акций на случайном уровне.</span><span class="sxs-lookup"><span data-stu-id="0a57f-201">The constructor starts up a Timer object that periodically calls methods that update stock prices on a random basis.</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample8.cs)]

    <span data-ttu-id="0a57f-202">Упдатестоккприцес вызывается таймером, который передает значение NULL в параметре state.</span><span class="sxs-lookup"><span data-stu-id="0a57f-202">UpdateStockPrices is called by the Timer, which passes in null in the state parameter.</span></span> <span data-ttu-id="0a57f-203">Перед обновлением цен на объект \_Упдатестоккприцеслокк будет сделана блокировка.</span><span class="sxs-lookup"><span data-stu-id="0a57f-203">Before updating prices, a lock is taken on the \_updateStockPricesLock object.</span></span> <span data-ttu-id="0a57f-204">Код проверяет, обновил ли другой поток цены, а затем вызывает Трюпдатестоккприце для каждой акции в списке.</span><span class="sxs-lookup"><span data-stu-id="0a57f-204">The code checks if another thread is already updating prices, and then it calls TryUpdateStockPrice on each stock in the list.</span></span> <span data-ttu-id="0a57f-205">Метод Трюпдатестоккприце принимает решение о необходимости изменения стоимости акций и объема ее изменения.</span><span class="sxs-lookup"><span data-stu-id="0a57f-205">The TryUpdateStockPrice method decides whether to change the stock price, and how much to change it.</span></span> <span data-ttu-id="0a57f-206">Если цена акций изменена, Броадкастстоккприце вызывается для передачи изменений цены акций на все подключенные клиенты.</span><span class="sxs-lookup"><span data-stu-id="0a57f-206">If the stock price is changed, BroadcastStockPrice is called to broadcast the stock price change to all connected clients.</span></span>

    <span data-ttu-id="0a57f-207">Флаг \_Упдатингстоккприцес помечается как [volatile](https://msdn.microsoft.com/library/x13ttww7.aspx) , чтобы обеспечить доступ к нему среадсафе.</span><span class="sxs-lookup"><span data-stu-id="0a57f-207">The \_updatingStockPrices flag is marked as [volatile](https://msdn.microsoft.com/library/x13ttww7.aspx) to ensure that access to it is threadsafe.</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample9.cs)]

    <span data-ttu-id="0a57f-208">В реальном приложении метод Трюпдатестоккприце вызовет веб-службу для поиска цены; в этом коде используется генератор случайных чисел для внесения изменений случайным образом.</span><span class="sxs-lookup"><span data-stu-id="0a57f-208">In a real application, the TryUpdateStockPrice method would call a web service to look up the price; in this code it uses a random number generator to make changes randomly.</span></span>

    ### <a name="getting-the-signalr-context-so-that-the-stockticker-class-can-broadcast-to-clients"></a><span data-ttu-id="0a57f-209">Получение контекста SignalR, чтобы класс Стокктиккер мог выполнить широковещательную рассылку клиентам</span><span class="sxs-lookup"><span data-stu-id="0a57f-209">Getting the SignalR context so that the StockTicker class can broadcast to clients</span></span>

    <span data-ttu-id="0a57f-210">Поскольку изменения цен происходят в объекте Стокктиккер, это объект, которому требуется вызывать метод Упдатестоккприце на всех подключенных клиентах.</span><span class="sxs-lookup"><span data-stu-id="0a57f-210">Because the price changes originate here in the StockTicker object, this is the object that needs to call an updateStockPrice method on all connected clients.</span></span> <span data-ttu-id="0a57f-211">В классе концентратора имеется API для вызова клиентских методов, но Стокктиккер не является производным от класса HUB и не имеет ссылки на какой-либо объект концентратора.</span><span class="sxs-lookup"><span data-stu-id="0a57f-211">In a Hub class you have an API for calling client methods, but StockTicker does not derive from the Hub class and does not have a reference to any Hub object.</span></span> <span data-ttu-id="0a57f-212">Поэтому для вещания на подключенных клиентах класс Стокктиккер должен получить экземпляр контекста SignalR для класса Стокктиккерхуб и использовать его для вызова методов на клиентах.</span><span class="sxs-lookup"><span data-stu-id="0a57f-212">Therefore, in order to broadcast to connected clients, the StockTicker class has to get the SignalR context instance for the StockTickerHub class and use that to call methods on clients.</span></span>

    <span data-ttu-id="0a57f-213">Код получает ссылку на контекст SignalR при создании экземпляра одноэлементного класса, передает эту ссылку конструктору, а конструктор помещает его в свойство Clients.</span><span class="sxs-lookup"><span data-stu-id="0a57f-213">The code gets a reference to the SignalR context when it creates the singleton class instance, passes that reference to the constructor, and the constructor puts it in the Clients property.</span></span>

    <span data-ttu-id="0a57f-214">Существует две причины, по которым вы хотите получить контекст только один раз: Получение контекста является дорогостоящей операцией, и получение ее однократно гарантирует, что будет сохранен порядок сообщений, отправленных клиентам.</span><span class="sxs-lookup"><span data-stu-id="0a57f-214">There are two reasons why you want to get the context just once: getting the context is an expensive operation, and getting it once ensures that the intended order of messages sent to clients is preserved.</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample10.cs)]

    <span data-ttu-id="0a57f-215">Получение свойства Clients контекста и помещение его в свойство Стокктиккерклиент позволяет написать код для вызова клиентских методов, которые выглядят так же, как в классе Hub.</span><span class="sxs-lookup"><span data-stu-id="0a57f-215">Getting the Clients property of the context and putting it in the StockTickerClient property lets you write code to call client methods that looks the same as it would in a Hub class.</span></span> <span data-ttu-id="0a57f-216">Например, для вещания на всех клиентах можно писать клиенты. ALL. Упдатестоккприце (на бирже).</span><span class="sxs-lookup"><span data-stu-id="0a57f-216">For instance, to broadcast to all clients you can write Clients.All.updateStockPrice(stock).</span></span>

    <span data-ttu-id="0a57f-217">Метод Упдатестоккприце, который вызывается в Броадкастстоккприце, еще не существует; Он будет добавлен позже при написании кода, выполняемого на клиенте.</span><span class="sxs-lookup"><span data-stu-id="0a57f-217">The updateStockPrice method that you are calling in BroadcastStockPrice doesn't exist yet; you'll add it later when you write code that runs on the client.</span></span> <span data-ttu-id="0a57f-218">Здесь можно обратиться к Упдатестоккприце, так как Clients. ALL является динамическим, а это означает, что выражение будет вычисляться во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="0a57f-218">You can refer to updateStockPrice here because Clients.All is dynamic, which means the expression will be evaluated at runtime.</span></span> <span data-ttu-id="0a57f-219">При выполнении этого вызова метода SignalR отправляет клиенту имя метода и значение параметра, а если у клиента есть метод с именем Упдатестоккприце, будет вызван этот метод, и ему будет передано значение параметра.</span><span class="sxs-lookup"><span data-stu-id="0a57f-219">When this method call executes, SignalR will send the method name and the parameter value to the client, and if the client has a method named updateStockPrice, that method will be called and the parameter value will be passed to it.</span></span>

    <span data-ttu-id="0a57f-220">Clients. ALL означает Send для всех клиентов.</span><span class="sxs-lookup"><span data-stu-id="0a57f-220">Clients.All means send to all clients.</span></span> <span data-ttu-id="0a57f-221">SignalR предоставляет другие возможности для указания клиентов или групп клиентов для отправки.</span><span class="sxs-lookup"><span data-stu-id="0a57f-221">SignalR gives you other options to specify which clients or groups of clients to send to.</span></span> <span data-ttu-id="0a57f-222">Дополнительные сведения см. в разделе [хубконнектионконтекст](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hubs.hubconnectioncontext(v=vs.111).aspx).</span><span class="sxs-lookup"><span data-stu-id="0a57f-222">For more information, see [HubConnectionContext](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hubs.hubconnectioncontext(v=vs.111).aspx).</span></span>

### <a name="register-the-signalr-route"></a><span data-ttu-id="0a57f-223">Регистрация маршрута SignalR</span><span class="sxs-lookup"><span data-stu-id="0a57f-223">Register the SignalR route</span></span>

<span data-ttu-id="0a57f-224">Серверу необходимо указать, какой URL-адрес следует перехватить, и направить его в SignalR.</span><span class="sxs-lookup"><span data-stu-id="0a57f-224">The server needs to know which URL to intercept and direct to SignalR.</span></span> <span data-ttu-id="0a57f-225">Чтобы сделать это, добавьте код в файл *Global. asax* .</span><span class="sxs-lookup"><span data-stu-id="0a57f-225">To do that you'll add some code to the *Global.asax* file.</span></span>

1. <span data-ttu-id="0a57f-226">В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите команду **Добавить новый элемент**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-226">In **Solution Explorer**, right-click the project, and then click **Add New Item**.</span></span>
2. <span data-ttu-id="0a57f-227">Выберите шаблон элемента **глобального приложения** и нажмите кнопку **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-227">Select the **Global Application Class** item template, and then click **Add**.</span></span>

    ![Добавить Global. asax](tutorial-server-broadcast-with-aspnet-signalr/_static/image6.png)
3. <span data-ttu-id="0a57f-229">Добавьте код регистрации маршрута SignalR в метод\_запуска приложения:</span><span class="sxs-lookup"><span data-stu-id="0a57f-229">Add the SignalR route registration code to the Application\_Start method:</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample11.cs)]

    <span data-ttu-id="0a57f-230">По умолчанию основным URL-адресом для всего трафика SignalR является "/SignalR", а "/сигналр/хубс" используется для получения динамически создаваемого файла JavaScript, который определяет учетные записи-посредники для всех концентраторов в приложении.</span><span class="sxs-lookup"><span data-stu-id="0a57f-230">By default, the base URL for all SignalR traffic is "/signalr", and "/signalr/hubs" is used to retrieve a dynamically generated JavaScript file that defines proxies for all the Hubs you have in your application.</span></span> <span data-ttu-id="0a57f-231">Метод Мафубс включает перегрузки, позволяющие указать другой базовый URL-адрес и определенные параметры SignalR в экземпляре класса [хубконфигуратион](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hubconfiguration(v=vs.111).aspx) .</span><span class="sxs-lookup"><span data-stu-id="0a57f-231">The MapHubs method includes overloads that let you specify a different base URL and certain SignalR options in an instance of the [HubConfiguration](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hubconfiguration(v=vs.111).aspx) class.</span></span>
4. <span data-ttu-id="0a57f-232">Добавьте оператор using в начало файла:</span><span class="sxs-lookup"><span data-stu-id="0a57f-232">Add a using statement at the top of the file:</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample12.cs)]
5. <span data-ttu-id="0a57f-233">Сохраните и закройте файл *Global. asax* и создайте проект.</span><span class="sxs-lookup"><span data-stu-id="0a57f-233">Save and close the *Global.asax* file, and build the project.</span></span>

<span data-ttu-id="0a57f-234">Настройка кода сервера завершена.</span><span class="sxs-lookup"><span data-stu-id="0a57f-234">You have now completed setting up the server code.</span></span> <span data-ttu-id="0a57f-235">В следующем разделе вы настроите клиент.</span><span class="sxs-lookup"><span data-stu-id="0a57f-235">In the next section you'll set up the client.</span></span>

<a id="client"></a>

## <a name="set-up-the-client-code"></a><span data-ttu-id="0a57f-236">Настройка клиентского кода</span><span class="sxs-lookup"><span data-stu-id="0a57f-236">Set up the client code</span></span>

1. <span data-ttu-id="0a57f-237">Создайте новый HTML-файл в папке проекта и назовите его *стокктиккер. HTML*.</span><span class="sxs-lookup"><span data-stu-id="0a57f-237">Create a new HTML file in the project folder, and name it *StockTicker.html*.</span></span>
2. <span data-ttu-id="0a57f-238">Замените код шаблона следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="0a57f-238">Replace the template code with the following code:</span></span>

    [!code-html[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample13.html)]

    <span data-ttu-id="0a57f-239">HTML создает таблицу с 5 столбцами, строкой заголовка и строкой данных с одной ячейкой, охватывающей все 5 столбцов.</span><span class="sxs-lookup"><span data-stu-id="0a57f-239">The HTML creates a table with 5 columns, a header row, and a data row with a single cell that spans all 5 columns.</span></span> <span data-ttu-id="0a57f-240">В строке данных отображается "Загрузка..." и будут отображаться мгновенно только при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="0a57f-240">The data row displays "loading..." and will only be shown momentarily when the application starts.</span></span> <span data-ttu-id="0a57f-241">Код JavaScript удалит эту строку и добавит в нее строки с данными, полученными с сервера.</span><span class="sxs-lookup"><span data-stu-id="0a57f-241">JavaScript code will remove that row and add in its place rows with stock data retrieved from the server.</span></span>

    <span data-ttu-id="0a57f-242">Теги скрипта указывают файл скрипта jQuery, основной файл скрипта SignalR, файл сценария прокси-сервера SignalR и файл сценария Стокктиккер, который будет создан позже.</span><span class="sxs-lookup"><span data-stu-id="0a57f-242">The script tags specify the jQuery script file, the SignalR core script file, the SignalR proxies script file, and a StockTicker script file that you'll create later.</span></span> <span data-ttu-id="0a57f-243">Файл скрипта прокси SignalR, который указывает URL-адрес "/сигналр/хубс", динамически создается и определяет прокси-методы для методов в классе Hub, в данном случае для Стокктиккерхуб. Жеталлстоккс.</span><span class="sxs-lookup"><span data-stu-id="0a57f-243">The SignalR proxies script file, which specifies the "/signalr/hubs" URL, is dynamically generated and defines proxy methods for the methods on the Hub class, in this case for StockTickerHub.GetAllStocks.</span></span> <span data-ttu-id="0a57f-244">При желании вы можете создать этот файл JavaScript вручную с помощью [служебных программ SignalR](http://nuget.org/packages/Microsoft.AspNet.SignalR.Utils/) и отключить динамическое создание файлов при вызове метода мафубс.</span><span class="sxs-lookup"><span data-stu-id="0a57f-244">If you prefer, you can generate this JavaScript file manually by using [SignalR Utilities](http://nuget.org/packages/Microsoft.AspNet.SignalR.Utils/) and disable dynamic file creation in the MapHubs method call.</span></span>
3. > [!IMPORTANT]
   > <span data-ttu-id="0a57f-245">Убедитесь, что ссылки на файл JavaScript в *стокктиккер. HTML* указаны правильно.</span><span class="sxs-lookup"><span data-stu-id="0a57f-245">Make sure that the JavaScript file references in *StockTicker.html* are correct.</span></span> <span data-ttu-id="0a57f-246">То есть убедитесь, что версия jQuery в теге скрипта (1.8.2 в примере) совпадает с версией jQuery в папке *Scripts* проекта, и убедитесь, что версия SignalR в теге скрипта совпадает с версией SignalR в папке *Scripts* проекта.</span><span class="sxs-lookup"><span data-stu-id="0a57f-246">That is, make sure that the jQuery version in your script tag (1.8.2 in the example) is the same as the jQuery version in your project's *Scripts* folder, and make sure that the SignalR version in your script tag is the same as the SignalR version in your project's *Scripts* folder.</span></span> <span data-ttu-id="0a57f-247">При необходимости измените имена файлов в тегах скрипта.</span><span class="sxs-lookup"><span data-stu-id="0a57f-247">Change the file names in the script tags if necessary.</span></span>
4. <span data-ttu-id="0a57f-248">В **Обозреватель решений**щелкните правой кнопкой мыши *стокктиккер. HTML*и выберите пункт **задать в качестве начальной страницы**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-248">In **Solution Explorer**, right-click *StockTicker.html*, and then click **Set as Start Page**.</span></span>
5. <span data-ttu-id="0a57f-249">Создайте новый файл JavaScript в папке проекта и назовите его *стокктиккер. js*.</span><span class="sxs-lookup"><span data-stu-id="0a57f-249">Create a new JavaScript file in the project folder and name it *StockTicker.js*..</span></span>
6. <span data-ttu-id="0a57f-250">Замените код шаблона следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="0a57f-250">Replace the template code with the following code:</span></span>

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample14.js)]

    <span data-ttu-id="0a57f-251">$. Connection означает прокси-серверы SignalR.</span><span class="sxs-lookup"><span data-stu-id="0a57f-251">$.connection refers to the SignalR proxies.</span></span> <span data-ttu-id="0a57f-252">Код получает ссылку на прокси-сервер для класса Стокктиккерхуб и помещает его в переменную Tick.</span><span class="sxs-lookup"><span data-stu-id="0a57f-252">The code gets a reference to the proxy for the StockTickerHub class and puts it in the ticker variable.</span></span> <span data-ttu-id="0a57f-253">Имя прокси-сервера — это имя, заданное атрибутом [HubName]:</span><span class="sxs-lookup"><span data-stu-id="0a57f-253">The proxy name is the name that was set by the [HubName] attribute:</span></span>

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample15.js)]

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample16.cs)]

    <span data-ttu-id="0a57f-254">После определения всех переменных и функций последняя строка кода в файле инициализирует подключение SignalR, вызывая функцию start SignalR.</span><span class="sxs-lookup"><span data-stu-id="0a57f-254">After all the variables and functions are defined, the last line of code in the file initializes the SignalR connection by calling the SignalR start function.</span></span> <span data-ttu-id="0a57f-255">Функция Start выполняется асинхронно и возвращает [отложенный объект jQuery](http://api.jquery.com/category/deferred-object/), что означает, что можно вызвать функцию done, чтобы указать функцию, вызываемую при завершении асинхронной операции.</span><span class="sxs-lookup"><span data-stu-id="0a57f-255">The start function executes asynchronously and returns a [jQuery Deferred object](http://api.jquery.com/category/deferred-object/), which means you can call the done function to specify the function to call when the asynchronous operation is completed..</span></span>

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample17.js)]

    <span data-ttu-id="0a57f-256">Функция init вызывает функцию Жеталлстоккс на сервере и использует сведения, возвращаемые сервером для обновления таблицы хранения данных.</span><span class="sxs-lookup"><span data-stu-id="0a57f-256">The init function calls the getAllStocks function on the server and uses the information that the server returns to update the stock table.</span></span> <span data-ttu-id="0a57f-257">Обратите внимание, что по умолчанию для клиента необходимо использовать регистр в стиле Camel, хотя на сервере используется имя метода Pascal.</span><span class="sxs-lookup"><span data-stu-id="0a57f-257">Notice that by default, you have to use camel casing on the client although the method name is pascal-cased on the server.</span></span> <span data-ttu-id="0a57f-258">Правило для прописных букв применяется только к методам, а не к объектам.</span><span class="sxs-lookup"><span data-stu-id="0a57f-258">The camel-casing rule only applies to methods, not objects.</span></span> <span data-ttu-id="0a57f-259">Например, вы ссылаетесь на склад. Symbol и акции. Цена, а не склад. Symbol или акций. Price.</span><span class="sxs-lookup"><span data-stu-id="0a57f-259">For example, you refer to stock.Symbol and stock.Price, not stock.symbol or stock.price.</span></span>

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample18.js)]

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample19.cs)]

    <span data-ttu-id="0a57f-260">Если вы хотите использовать для клиента регистр на стиле Pascal или хотите использовать совершенно другое имя метода, можно было бы дополнить метод концентратора атрибутом Хубмесоднаме таким же образом, как и сам класс Hub, с атрибутом HubName.</span><span class="sxs-lookup"><span data-stu-id="0a57f-260">If you wanted to use pascal casing on the client, or if you wanted to use a completely different method name, you could decorate the Hub method with the HubMethodName attribute the same way you decorated the Hub class itself with the HubName attribute.</span></span>

    <span data-ttu-id="0a57f-261">В методе init HTML для строки таблицы создается для каждого объекта, полученного с сервера, путем вызова Форматстокк для форматирования свойств объекта фондовой, а затем путем вызова функции заменит (которая определена в начале *стокктиккер. js*), чтобы заменить заполнители в переменной ровтемплате значениями свойств объекта «фондовой биржи».</span><span class="sxs-lookup"><span data-stu-id="0a57f-261">In the init method, HTML for a table row is created for each stock object received from the server by calling formatStock to format properties of the stock object, and then by calling supplant (which is defined at the top of *StockTicker.js*) to replace placeholders in the rowTemplate variable with the stock object property values.</span></span> <span data-ttu-id="0a57f-262">Затем полученный код HTML добавляется в таблицу запасов.</span><span class="sxs-lookup"><span data-stu-id="0a57f-262">The resulting HTML is then appended to the stock table.</span></span>

    <span data-ttu-id="0a57f-263">Метод Init вызывается путем передачи его в виде функции обратного вызова, которая выполняется после завершения функции асинхронного запуска.</span><span class="sxs-lookup"><span data-stu-id="0a57f-263">You call init by passing it in as a callback function that executes after the asynchronous start function completes.</span></span> <span data-ttu-id="0a57f-264">Если после вызова Start вы вызвали init как отдельную инструкцию JavaScript, функция завершится ошибкой, так как она будет выполнена немедленно без ожидания завершения установки соединения функцией start.</span><span class="sxs-lookup"><span data-stu-id="0a57f-264">If you called init as a separate JavaScript statement after calling start, the function would fail because it would execute immediately without waiting for the start function to finish establishing the connection.</span></span> <span data-ttu-id="0a57f-265">В этом случае функция init попытается вызвать функцию Жеталлстоккс до установки соединения с сервером.</span><span class="sxs-lookup"><span data-stu-id="0a57f-265">In that case, the init function would try to call the getAllStocks function before the server connection is established.</span></span>

    <span data-ttu-id="0a57f-266">Когда сервер изменяет цену на акцию, он вызывает Упдатестоккприце на подключенных клиентах.</span><span class="sxs-lookup"><span data-stu-id="0a57f-266">When the server changes a stock's price, it calls the updateStockPrice on connected clients.</span></span> <span data-ttu-id="0a57f-267">Функция добавляется в свойство клиента прокси-сервера Стокктиккер, чтобы сделать его доступным для вызовов с сервера.</span><span class="sxs-lookup"><span data-stu-id="0a57f-267">The function is added to the client property of the stockTicker proxy in order to make it available to calls from the server.</span></span>

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample20.js)]

    <span data-ttu-id="0a57f-268">Функция Упдатестоккприце форматирует объект, полученный с сервера, в строку таблицы таким же образом, как и в функции init.</span><span class="sxs-lookup"><span data-stu-id="0a57f-268">The updateStockPrice function formats a stock object received from the server into a table row the same way as in the init function.</span></span> <span data-ttu-id="0a57f-269">Однако вместо того, чтобы добавлять строку в таблицу, она находит текущую строку складского запаса в таблице и заменяет эту строку новой.</span><span class="sxs-lookup"><span data-stu-id="0a57f-269">However, instead of appending the row to the table, it finds the stock's current row in the table and replaces that row with the new one.</span></span>

<a id="test"></a>

## <a name="test-the-application"></a><span data-ttu-id="0a57f-270">Тестирование приложения</span><span class="sxs-lookup"><span data-stu-id="0a57f-270">Test the application</span></span>

1. <span data-ttu-id="0a57f-271">Нажмите F5, чтобы выполнить приложение в режиме отладки.</span><span class="sxs-lookup"><span data-stu-id="0a57f-271">Press F5 to run the application in debug mode.</span></span>

    <span data-ttu-id="0a57f-272">В таблице «акции» изначально отображается «загрузка...». После небольшой задержки отображается начальные данные о акции, а затем цены на акции начинают изменяться.</span><span class="sxs-lookup"><span data-stu-id="0a57f-272">The stock table initially displays the "loading..." line, then after a short delay the initial stock data is displayed, and then the stock prices start to change.</span></span>

    ![Загрузка](tutorial-server-broadcast-with-aspnet-signalr/_static/image7.png)

    ![Начальная таблица запасов](tutorial-server-broadcast-with-aspnet-signalr/_static/image8.png)

    ![Складская таблица, получающая изменения с сервера](tutorial-server-broadcast-with-aspnet-signalr/_static/image9.png)
2. <span data-ttu-id="0a57f-276">Скопируйте URL-адрес из адресной строки браузера и вставьте его в одно или несколько новых окон браузера.</span><span class="sxs-lookup"><span data-stu-id="0a57f-276">Copy the URL from the browser address bar and paste it into one or more new browser window(s).</span></span>

    <span data-ttu-id="0a57f-277">Начальное отображение запасов аналогично первому браузеру, и изменения происходят одновременно.</span><span class="sxs-lookup"><span data-stu-id="0a57f-277">The initial stock display is the same as the first browser and changes happen simultaneously.</span></span>
3. <span data-ttu-id="0a57f-278">Закройте все браузеры и откройте новый браузер, а затем перейдите по тому же URL-адресу.</span><span class="sxs-lookup"><span data-stu-id="0a57f-278">Close all browsers and open a new browser, then go to the same URL.</span></span>

    <span data-ttu-id="0a57f-279">Объект одноэлементного объекта Стокктиккер продолжает работать на сервере, поэтому в таблице акций отображается, что акции продолжают изменяться.</span><span class="sxs-lookup"><span data-stu-id="0a57f-279">The StockTicker singleton object has continued to run in the server, so the stock table display shows that the stocks have continued to change.</span></span> <span data-ttu-id="0a57f-280">(Начальная таблица с нулевыми рисунками не отображается).</span><span class="sxs-lookup"><span data-stu-id="0a57f-280">(You don't see the initial table with zero change figures.)</span></span>
4. <span data-ttu-id="0a57f-281">Закройте браузер.</span><span class="sxs-lookup"><span data-stu-id="0a57f-281">Close the browser.</span></span>

<a id="enablelogging"></a>

## <a name="enable-logging"></a><span data-ttu-id="0a57f-282">Включение ведения журналов</span><span class="sxs-lookup"><span data-stu-id="0a57f-282">Enable logging</span></span>

<span data-ttu-id="0a57f-283">SignalR имеет встроенную функцию ведения журнала, которую можно включить на клиенте, чтобы помочь в устранении неполадок.</span><span class="sxs-lookup"><span data-stu-id="0a57f-283">SignalR has a built-in logging function that you can enable on the client to aid in troubleshooting.</span></span> <span data-ttu-id="0a57f-284">В этом разделе вы включите ведение журнала и просмотрите примеры, демонстрирующие, как журналы указывают, какой из следующих методов транспорта использует.</span><span class="sxs-lookup"><span data-stu-id="0a57f-284">In this section you enable logging and see examples that show how logs tell you which of the following transport methods SignalR is using:</span></span>

- <span data-ttu-id="0a57f-285">[WebSockets](http://en.wikipedia.org/wiki/WebSocket), поддерживаемые службами IIS 8 и текущими браузерами.</span><span class="sxs-lookup"><span data-stu-id="0a57f-285">[WebSockets](http://en.wikipedia.org/wiki/WebSocket), supported by IIS 8 and current browsers.</span></span>
- <span data-ttu-id="0a57f-286">[События, отправленные сервером](http://en.wikipedia.org/wiki/Server-sent_events), поддерживаются обозревателями, отличными от Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="0a57f-286">[Server-sent events](http://en.wikipedia.org/wiki/Server-sent_events), supported by browsers other than Internet Explorer.</span></span>
- <span data-ttu-id="0a57f-287">[Непрерывная рамка](http://en.wikipedia.org/wiki/Comet_(programming)#Hidden_iframe), поддерживаемая Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="0a57f-287">[Forever frame](http://en.wikipedia.org/wiki/Comet_(programming)#Hidden_iframe), supported by Internet Explorer.</span></span>
- <span data-ttu-id="0a57f-288">[Длинный опрос Ajax](http://en.wikipedia.org/wiki/Comet_(programming)#Ajax_with_long_polling), поддерживаемый всеми браузерами.</span><span class="sxs-lookup"><span data-stu-id="0a57f-288">[Ajax long polling](http://en.wikipedia.org/wiki/Comet_(programming)#Ajax_with_long_polling), supported by all browsers.</span></span>

<span data-ttu-id="0a57f-289">Для любого заданного соединения SignalR выбирает лучший метод транспортировки, который поддерживает сервер и клиент.</span><span class="sxs-lookup"><span data-stu-id="0a57f-289">For any given connection, SignalR chooses the best transport method that both the server and the client support.</span></span>

1. <span data-ttu-id="0a57f-290">Откройте *стокктиккер. js* и добавьте строку кода, чтобы включить ведение журнала непосредственно перед кодом, который инициализирует подключение в конце файла:</span><span class="sxs-lookup"><span data-stu-id="0a57f-290">Open *StockTicker.js* and add a line of code to enable logging immediately before the code that initializes the connection at the end of the file:</span></span>

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample21.js)]
2. <span data-ttu-id="0a57f-291">Нажмите клавишу F5, чтобы запустить проект.</span><span class="sxs-lookup"><span data-stu-id="0a57f-291">Press F5 to run the project.</span></span>
3. <span data-ttu-id="0a57f-292">Откройте окно средств разработчика в браузере и выберите консоль, чтобы просмотреть журналы.</span><span class="sxs-lookup"><span data-stu-id="0a57f-292">Open your browser's developer tools window, and select the Console to see the logs.</span></span> <span data-ttu-id="0a57f-293">Может потребоваться обновить страницу, чтобы просмотреть журналы SignalR, согласования транспортного метода для нового подключения.</span><span class="sxs-lookup"><span data-stu-id="0a57f-293">You might have to refresh the page to see the logs of Signalr negotiating the transport method for a new connection.</span></span>

    <span data-ttu-id="0a57f-294">Если вы используете Internet Explorer 10 в Windows 8 (IIS 8), метод транспорта — это WebSockets.</span><span class="sxs-lookup"><span data-stu-id="0a57f-294">If you are running Internet Explorer 10 on Windows 8 (IIS 8), the transport method is WebSockets.</span></span>

    ![Консоль Internet Explorer 10 IIS 8](tutorial-server-broadcast-with-aspnet-signalr/_static/image10.png)

    <span data-ttu-id="0a57f-296">Если вы используете Internet Explorer 10 в Windows 7 (IIS 7,5), то транспортным методом является IFRAME.</span><span class="sxs-lookup"><span data-stu-id="0a57f-296">If you are running Internet Explorer 10 on Windows 7 (IIS 7.5), the transport method is iframe.</span></span>

    ![Консоль Internet Explorer 10, IIS 7,5](tutorial-server-broadcast-with-aspnet-signalr/_static/image11.png)

    <span data-ttu-id="0a57f-298">В браузере Firefox установите надстройку Firebug, чтобы получить окно консоли.</span><span class="sxs-lookup"><span data-stu-id="0a57f-298">In Firefox, install the Firebug add-in to get a Console window.</span></span> <span data-ttu-id="0a57f-299">Если вы используете Firefox 19 в Windows 8 (IIS 8), метод транспорта — это WebSockets.</span><span class="sxs-lookup"><span data-stu-id="0a57f-299">If you are running Firefox 19 on Windows 8 (IIS 8), the transport method is WebSockets.</span></span>

    ![WebSocket 19 служб IIS 8](tutorial-server-broadcast-with-aspnet-signalr/_static/image12.png)

    <span data-ttu-id="0a57f-301">Если вы используете Firefox 19 в Windows 7 (IIS 7,5), метод Transport является серверными событиями.</span><span class="sxs-lookup"><span data-stu-id="0a57f-301">If you are running Firefox 19 on Windows 7 (IIS 7.5), the transport method is server-sent events.</span></span>

    ![Консоль IIS Firefox 19 с браузером 7,5](tutorial-server-broadcast-with-aspnet-signalr/_static/image13.png)

<a id="fullsample"></a>

## <a name="install-and-review-the-full-stockticker-sample"></a><span data-ttu-id="0a57f-303">Установка и проверка полного примера Стокктиккер</span><span class="sxs-lookup"><span data-stu-id="0a57f-303">Install and review the full StockTicker sample</span></span>

<span data-ttu-id="0a57f-304">Приложение Стокктиккер, устанавливаемое с помощью пакета [Microsoft. AspNet. SignalR. Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) NuGet, содержит больше функций, чем упрощенная версия, созданная с нуля.</span><span class="sxs-lookup"><span data-stu-id="0a57f-304">The StockTicker application that is installed by the [Microsoft.AspNet.SignalR.Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) NuGet package includes more features than the simplified version that you just created from scratch.</span></span> <span data-ttu-id="0a57f-305">В этом разделе руководства вы установите пакет NuGet и ознакомьтесь с новыми функциями и кодом, который их реализует.</span><span class="sxs-lookup"><span data-stu-id="0a57f-305">In this section of the tutorial, you install the NuGet package and review the new features and the code that implements them.</span></span>

### <a name="install-the-signalrsample-nuget-package"></a><span data-ttu-id="0a57f-306">Установите пакет NuGet с SignalR. Sample.</span><span class="sxs-lookup"><span data-stu-id="0a57f-306">Install the SignalR.Sample NuGet package</span></span>

1. <span data-ttu-id="0a57f-307">В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите пункт **Управление пакетами NuGet**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-307">In **Solution Explorer**, right-click the project and click **Manage NuGet Packages**.</span></span>
2. <span data-ttu-id="0a57f-308">В диалоговом окне **Управление пакетами NuGet** щелкните в **сети**, *введите SignalR. Sample* в поле **Поиск в Интернете** , а затем нажмите кнопку **установить** в пакете **SignalR. Sample** .</span><span class="sxs-lookup"><span data-stu-id="0a57f-308">In the **Manage NuGet Packages** dialog box, click **Online**, enter *SignalR.Sample* in the **Search Online** box, and then click **Install** in the **SignalR.Sample** package.</span></span>

    ![Установка SignalR. пример пакета](tutorial-server-broadcast-with-aspnet-signalr/_static/image14.png)
3. <span data-ttu-id="0a57f-310">В файле *Global. asax* закомментируйте RouteTable. routes. мафубс (); Строка, добавленная ранее в методе\_запуск приложения.</span><span class="sxs-lookup"><span data-stu-id="0a57f-310">In the *Global.asax* file, comment out the RouteTable.Routes.MapHubs(); line that you added earlier in the Application\_Start method.</span></span>

    <span data-ttu-id="0a57f-311">Код в *Global. asax* больше не нужен, так как этот пакет регистрирует маршрут SignalR в файле *app\_Start/регистерхубс. CS* :</span><span class="sxs-lookup"><span data-stu-id="0a57f-311">The code in *Global.asax* is no longer needed because the SignalR.Sample package registers the SignalR route in the *App\_Start/RegisterHubs.cs* file:</span></span>

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample22.cs)]

    <span data-ttu-id="0a57f-312">Класс "Активатор", на который ссылается атрибут сборки, включен в пакет NuGet Вебактиваторекс, который устанавливается как зависимость от SignalR. пример пакета.</span><span class="sxs-lookup"><span data-stu-id="0a57f-312">The WebActivator class that is referenced by the assembly attribute is included in the WebActivatorEx NuGet package, which is installed as a dependency of the SignalR.Sample package.</span></span>
4. <span data-ttu-id="0a57f-313">В **Обозреватель решений**разверните папку *SignalR. Sample* , которая была создана при установке SignalR. пример пакета.</span><span class="sxs-lookup"><span data-stu-id="0a57f-313">In **Solution Explorer**, expand the *SignalR.Sample* folder which was created by installing the SignalR.Sample package.</span></span>
5. <span data-ttu-id="0a57f-314">В папке *SignalR. Sample* щелкните правой кнопкой мыши *стокктиккер. HTML*и выберите пункт **задать в качестве начальной страницы**.</span><span class="sxs-lookup"><span data-stu-id="0a57f-314">In the *SignalR.Sample* folder, right-click *StockTicker.html*, and then click **Set As Start Page**.</span></span>

    > [!NOTE]
    > <span data-ttu-id="0a57f-315">Установка SignalR. пример пакета NuGet может изменить версию jQuery в папке *Scripts* .</span><span class="sxs-lookup"><span data-stu-id="0a57f-315">Installing The SignalR.Sample NuGet package might change the version of jQuery that you have in your *Scripts* folder.</span></span> <span data-ttu-id="0a57f-316">Новый файл *стокктиккер. HTML* , устанавливаемый пакетом в папке *SignalR. Sample* , будет синхронизирован с версией jQuery, устанавливаемой пакетом, но если вы хотите снова запустить исходный файл *стокктиккер. HTML* , то, возможно, потребуется сначала обновить ссылку JQuery в теге script.</span><span class="sxs-lookup"><span data-stu-id="0a57f-316">The new *StockTicker.html* file that the package installs in the *SignalR.Sample* folder will be in sync with the jQuery version that the package installs, but if you want to run your original *StockTicker.html* file again, you might have to update the jQuery reference in the script tag first.</span></span>

### <a name="run-the-application"></a><span data-ttu-id="0a57f-317">Выполнение приложения</span><span class="sxs-lookup"><span data-stu-id="0a57f-317">Run the application</span></span>

1. <span data-ttu-id="0a57f-318">Нажмите клавишу F5 для запуска приложения.</span><span class="sxs-lookup"><span data-stu-id="0a57f-318">Press F5 to run the application.</span></span>

    <span data-ttu-id="0a57f-319">В дополнение к сетке, которую вы видели ранее, в полном приложении для биржевых котировок отображается окно с горизонтальной прокруткой, в котором отображаются одни и те же биржевые данные.</span><span class="sxs-lookup"><span data-stu-id="0a57f-319">In addition to the grid that you saw earlier, the full stock ticker application shows a horizontally scrolling window that displays the same stock data.</span></span> <span data-ttu-id="0a57f-320">При первом запуске приложения "Market" — "Closed", и вы увидите статическую сетку и окно с импульсами, которое не прокручивается.</span><span class="sxs-lookup"><span data-stu-id="0a57f-320">When you run the application for the first time, the "market" is "closed" and you see a static grid and a ticker window that isn't scrolling.</span></span>

    ![Начало экрана Стокктиккер](tutorial-server-broadcast-with-aspnet-signalr/_static/image15.png)

    <span data-ttu-id="0a57f-322">При нажатии кнопки **Открыть рыночный**ящик в **реальном** времени начнет прокручиваться по горизонтали, а сервер начнет периодически рассылать изменения цены акций на случайном уровне.</span><span class="sxs-lookup"><span data-stu-id="0a57f-322">When you click **Open Market**, the **Live Stock Ticker** box starts to scroll horizontally, and the server starts to periodically broadcast stock price changes on a random basis.</span></span> <span data-ttu-id="0a57f-323">При каждом изменении цены на акцию обновляются как сетка **таблицы запасов в реальном** времени, так и поле **Live биржевое** значение.</span><span class="sxs-lookup"><span data-stu-id="0a57f-323">Each time a stock price changes, both the **Live Stock Table** grid and the **Live Stock Ticker** box are updated.</span></span> <span data-ttu-id="0a57f-324">Если изменение цены на фондовой бирже положительно, то на бумаге отображается зеленый фон, а когда изменение отрицательное, на бумаге отображается красный фон.</span><span class="sxs-lookup"><span data-stu-id="0a57f-324">When a stock's price change is positive, the stock is shown with a green background, and when the change is negative, the stock is shown with a red background.</span></span>

    ![Приложение Стокктиккер, открытое на рынке](tutorial-server-broadcast-with-aspnet-signalr/_static/image16.png)

    <span data-ttu-id="0a57f-326">Кнопка **Закрыть на рынке** останавливает изменения и останавливает прокрутку импульсов, а кнопка **Сброс** сбрасывает все биржевые данные в исходное состояние до начала изменения цены.</span><span class="sxs-lookup"><span data-stu-id="0a57f-326">The **Close Market** button stops the changes and stops the ticker scrolling, and the **Reset** button resets all stock data to the initial state before price changes started.</span></span> <span data-ttu-id="0a57f-327">Если открыть больше окон браузера и перейти к одному и тому же URL-адресу, вы увидите, что одни и те же данные динамически обновляются в каждом браузере.</span><span class="sxs-lookup"><span data-stu-id="0a57f-327">If you open more browser windows and go to the same URL, you see the same data dynamically updated at the same time in each browser.</span></span> <span data-ttu-id="0a57f-328">Если щелкнуть одну из кнопок, все браузеры будут отвечать одинаковым образом.</span><span class="sxs-lookup"><span data-stu-id="0a57f-328">When you click one of the buttons, all browsers respond the same way at the same time.</span></span>

### <a name="live-stock-ticker-display"></a><span data-ttu-id="0a57f-329">Отображение биржевых котировок в реальном времени</span><span class="sxs-lookup"><span data-stu-id="0a57f-329">Live Stock Ticker display</span></span>

<span data-ttu-id="0a57f-330">Отображение **биржевых котировок** — это неупорядоченный список в элементе div, который форматируется в виде одной строки в стилях CSS.</span><span class="sxs-lookup"><span data-stu-id="0a57f-330">The **Live Stock Ticker** display is an unordered list in a div element that is formatted into a single line by CSS styles.</span></span> <span data-ttu-id="0a57f-331">Он инициализируется и обновляется так же, как и таблица: заменяя заполнители в строке шаблона &lt;Li&gt; и динамически добавляя элементы &lt;Li&gt; в элемент &lt;UL&gt;.</span><span class="sxs-lookup"><span data-stu-id="0a57f-331">The ticker is initialized and updated the same way as the table: by replacing placeholders in a &lt;li&gt; template string and dynamically adding the &lt;li&gt; elements to the &lt;ul&gt; element.</span></span> <span data-ttu-id="0a57f-332">Прокрутка выполняется с помощью функции jQuery анимировать для изменения левого поля неупорядоченного списка в Div.</span><span class="sxs-lookup"><span data-stu-id="0a57f-332">The scrolling is performed by using the jQuery animate function to vary the margin-left of the unordered list within the div.</span></span>

<span data-ttu-id="0a57f-333">HTML-код биржевых котировок:</span><span class="sxs-lookup"><span data-stu-id="0a57f-333">The stock ticker HTML:</span></span>

[!code-html[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample23.html)]

<span data-ttu-id="0a57f-334">Код CSS для биржевых котировок:</span><span class="sxs-lookup"><span data-stu-id="0a57f-334">The stock ticker CSS:</span></span>

[!code-html[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample24.html)]

<span data-ttu-id="0a57f-335">Код jQuery, который выполняет прокрутку:</span><span class="sxs-lookup"><span data-stu-id="0a57f-335">The jQuery code that makes it scroll:</span></span>

[!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample25.js)]

### <a name="additional-methods-on-the-server-that-the-client-can-call"></a><span data-ttu-id="0a57f-336">Дополнительные методы на сервере, который может вызывать клиент</span><span class="sxs-lookup"><span data-stu-id="0a57f-336">Additional methods on the server that the client can call</span></span>

<span data-ttu-id="0a57f-337">Класс Стокктиккерхуб определяет четыре дополнительных метода, которые может вызывать клиент:</span><span class="sxs-lookup"><span data-stu-id="0a57f-337">The StockTickerHub class defines four additional methods that the client can call:</span></span>

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample26.cs)]

<span data-ttu-id="0a57f-338">Опенмаркет, Клосемаркет и Reset вызываются в ответ на кнопки в верхней части страницы.</span><span class="sxs-lookup"><span data-stu-id="0a57f-338">OpenMarket, CloseMarket, and Reset are called in response to the buttons at the top of the page.</span></span> <span data-ttu-id="0a57f-339">Они демонстрируют шаблон одного клиента, который инициирует изменение в состоянии, которое немедленно распространяется на все клиенты.</span><span class="sxs-lookup"><span data-stu-id="0a57f-339">They demonstrate the pattern of one client triggering a change in state that is immediately propagated to all clients.</span></span> <span data-ttu-id="0a57f-340">Каждый из этих методов вызывает метод в классе Стокктиккер, который влияет на изменение состояния рынка, а затем передает новое состояние.</span><span class="sxs-lookup"><span data-stu-id="0a57f-340">Each of these methods calls a method in the StockTicker class that effects the market state change and then broadcasts the new state.</span></span>

<span data-ttu-id="0a57f-341">В классе Стокктиккер состояние рынка поддерживается свойством Маркетстате, которое возвращает значение перечисления Маркетстате:</span><span class="sxs-lookup"><span data-stu-id="0a57f-341">In the StockTicker class, the state of the market is maintained by a MarketState property that returns a MarketState enum value:</span></span>

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample27.cs)]

<span data-ttu-id="0a57f-342">Каждый из методов, изменяющих состояние рынка, выполняет это в блоке блокировки, так как класс Стокктиккер должен быть среадсафе:</span><span class="sxs-lookup"><span data-stu-id="0a57f-342">Each of the methods that change the market state do so inside a lock block because the StockTicker class has to be threadsafe:</span></span>

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample28.cs)]

<span data-ttu-id="0a57f-343">Чтобы убедиться, что этот код является среадсафе, поле \_Маркетстате, которое обеспечивает обратное свойство Маркетстате, помечено как volatile,</span><span class="sxs-lookup"><span data-stu-id="0a57f-343">To ensure that this code is threadsafe, the \_marketState field that backs the MarketState property is marked as volatile,</span></span>

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample29.cs)]

<span data-ttu-id="0a57f-344">Методы Броадкастмаркетстатечанже и Броадкастмаркетресет похожи на метод Броадкастстоккприце, который вы уже видели, за исключением того, что они вызывают различные методы, определенные на клиенте:</span><span class="sxs-lookup"><span data-stu-id="0a57f-344">The BroadcastMarketStateChange and BroadcastMarketReset methods are similar to the BroadcastStockPrice method that you already saw, except they call different methods defined at the client:</span></span>

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample30.cs)]

### <a name="additional-functions-on-the-client-that-the-server-can-call"></a><span data-ttu-id="0a57f-345">Дополнительные функции на клиенте, который может вызывать сервер</span><span class="sxs-lookup"><span data-stu-id="0a57f-345">Additional functions on the client that the server can call</span></span>

<span data-ttu-id="0a57f-346">Функция Упдатестоккприце теперь обрабатывает сетку и отображение импульсов, а также использует jQuery. Color для красных и зеленых цветов Flash.</span><span class="sxs-lookup"><span data-stu-id="0a57f-346">The updateStockPrice function now handles both the grid and the ticker display, and it uses jQuery.Color to flash red and green colors.</span></span>

<span data-ttu-id="0a57f-347">Новые функции в *SignalR. стокктиккер. js* включают и отключают кнопки на основе состояния рынка, а также останавливают или начинают горизонтальную прокрутку окна Tick.</span><span class="sxs-lookup"><span data-stu-id="0a57f-347">New functions in *SignalR.StockTicker.js* enable and disable the buttons based on market state, and they stop or start the ticker window horizontal scrolling.</span></span> <span data-ttu-id="0a57f-348">Так как в средство Tick. Client добавляются несколько функций, для их добавления используется [функция расширения jQuery](http://api.jquery.com/jQuery.extend/) .</span><span class="sxs-lookup"><span data-stu-id="0a57f-348">Since multiple functions are being added to ticker.client, the [jQuery extend function](http://api.jquery.com/jQuery.extend/) is used to add them.</span></span>

[!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample31.js)]

### <a name="additional-client-setup-after-establishing-the-connection"></a><span data-ttu-id="0a57f-349">Дополнительные настройки клиента после установления соединения</span><span class="sxs-lookup"><span data-stu-id="0a57f-349">Additional client setup after establishing the connection</span></span>

<span data-ttu-id="0a57f-350">После того как клиент установит соединение, он попытается выполнить некоторую дополнительную работу: определить, открыт ли или закрыт данный рынк, чтобы вызвать соответствующую функцию Маркетопенед или Маркетклосед и присоединить вызовы серверных методов к кнопкам.</span><span class="sxs-lookup"><span data-stu-id="0a57f-350">After the client establishes the connection, it has some additional work to do: find out if the market is open or closed in order to call the appropriate marketOpened or marketClosed function, and attach the server method calls to the buttons.</span></span>

[!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample32.js)]

<span data-ttu-id="0a57f-351">Методы сервера не привязаны к кнопкам до тех пор, пока соединение не будет установлено, чтобы код не попытается вызвать методы сервера до их доступности.</span><span class="sxs-lookup"><span data-stu-id="0a57f-351">The server methods are not wired up to the buttons until after the connection is established, so that the code can't try to call the server methods before they are available.</span></span>

<a id="nextsteps"></a>

## <a name="next-steps"></a><span data-ttu-id="0a57f-352">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="0a57f-352">Next steps</span></span>

<span data-ttu-id="0a57f-353">В этом учебнике вы узнали, как программировать приложение SignalR, которое передает сообщения с сервера на все подключенные клиенты на периодической основе и в ответ на уведомления от любого клиента.</span><span class="sxs-lookup"><span data-stu-id="0a57f-353">In this tutorial you've learned how to program a SignalR application that broadcasts messages from the server to all connected clients, both on a periodic basis and in response to notifications from any client.</span></span> <span data-ttu-id="0a57f-354">Шаблон использования многопотокового одноэлементного экземпляра для поддержания состояния сервера также можно использовать в сценариях интерактивной игры с несколькими игроками.</span><span class="sxs-lookup"><span data-stu-id="0a57f-354">The pattern of using a multi-threaded singleton instance to maintain server state can also be also used in multi-player online game scenarios.</span></span> <span data-ttu-id="0a57f-355">Пример см. в разделе [игра по воссозданию, основанная на SignalR](https://github.com/NTaylorMullen/ShootR).</span><span class="sxs-lookup"><span data-stu-id="0a57f-355">For an example, see [the ShootR game that is based on SignalR](https://github.com/NTaylorMullen/ShootR).</span></span>

<span data-ttu-id="0a57f-356">Учебники, в которых показаны одноранговые сценарии связи, см. в разделе [Начало работы с SignalR](index.md) и [обновлением в режиме реального времени с помощью SignalR](index.md).</span><span class="sxs-lookup"><span data-stu-id="0a57f-356">For tutorials that show peer-to-peer communication scenarios, see [Getting Started with SignalR](index.md) and [Real-Time Updating with SignalR](index.md).</span></span>

<span data-ttu-id="0a57f-357">Чтобы узнать больше о более сложных концепциях разработки SignalR, посетите следующие сайты с исходным кодом и ресурсами SignalR:</span><span class="sxs-lookup"><span data-stu-id="0a57f-357">To learn more advanced SignalR development concepts, visit the following sites for SignalR source code and resources:</span></span>

- [<span data-ttu-id="0a57f-358">ASP.NET SignalR</span><span class="sxs-lookup"><span data-stu-id="0a57f-358">ASP.NET SignalR</span></span>](https://asp.net/signalr/)
- [<span data-ttu-id="0a57f-359">Проект SignalR</span><span class="sxs-lookup"><span data-stu-id="0a57f-359">SignalR Project</span></span>](http://signalr.net/)
- [<span data-ttu-id="0a57f-360">GitHub и примеры SignalR</span><span class="sxs-lookup"><span data-stu-id="0a57f-360">SignalR Github and Samples</span></span>](https://github.com/SignalR/SignalR)
- [<span data-ttu-id="0a57f-361">Вики-сайт SignalR</span><span class="sxs-lookup"><span data-stu-id="0a57f-361">SignalR Wiki</span></span>](https://github.com/SignalR/SignalR/wiki)
