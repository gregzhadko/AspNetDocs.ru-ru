---
uid: signalr/overview/older-versions/tutorial-server-broadcast-with-aspnet-signalr
title: Учебник. серверное вещание с помощью ASP.NET SignalR 1. x | Документация Майкрософт
author: bradygaster
description: В этом руководстве показано, как создать веб-приложение, которое использует SignalR ASP.NET для предоставления функций серверной широковещательной рассылки. Широковещательная рассылка сервера означает, что Коммуник...
ms.author: bradyg
ms.date: 04/10/2013
ms.assetid: ab7b2554-956a-4f6d-b2a0-4ae0c62e8580
msc.legacyurl: /signalr/overview/older-versions/tutorial-server-broadcast-with-aspnet-signalr
msc.type: authoredcontent
ms.openlocfilehash: 68908be34f6b010e512677fe5f5e31bfdefab592
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78467934"
---
# <a name="tutorial-server-broadcast-with-aspnet-signalr-1x"></a>Учебник. широковещательная рассылка сервера с помощью ASP.NET SignalR 1. x

[Патрик Флетчера](https://github.com/pfletcher), [Tom Dykstra)](https://github.com/tdykstra)

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

> В этом руководстве показано, как создать веб-приложение, которое использует SignalR ASP.NET для предоставления функций серверной широковещательной рассылки. Серверное вещание означает, что связь, отправляемая клиентам, инициируется сервером. В этом сценарии требуется другой подход к программированию, чем в одноранговых сценариях, таких как приложения для разговора, при которых связь, отправляемая клиентам, инициируется одним или несколькими клиентами.
> 
> Приложение, которое будет создано в этом учебнике, имитирует биржевое биржевое, типичный сценарий для серверной функции вещания.
> 
> Комментарии в учебнике — Добро пожаловать. Если у вас есть вопросы, не связанные непосредственно с этим руководством, их можно опубликовать на [форуме ASP.NET SignalR](https://forums.asp.net/1254.aspx/1?ASP+NET+SignalR) или [StackOverflow.com](http://stackoverflow.com).

## <a name="overview"></a>Обзор

Пакет NuGet [Microsoft. AspNet. SignalR. Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) устанавливает пример смоделированного приложения для биржевых котировок в проекте Visual Studio. В первой части этого руководства вы создадите упрощенную версию приложения с нуля. В оставшейся части руководства вы установите пакет NuGet и ознакомьтесь с дополнительными функциями и кодом, который он создает.

Приложение для биржевых котировок является репрезентативным видом приложения в режиме реального времени, в котором требуется периодически "отправлять" или рассылать уведомления от сервера на все подключенные клиенты.

В приложении, которое будет создаваться в первой части этого учебника, отображается сетка с данными об акциях.

![Исходная версия Стокктиккер](tutorial-server-broadcast-with-aspnet-signalr/_static/image1.png)

Периодически сервер обновляет цены на акции и отправляет обновления на все подключенные клиенты. В браузере числа и символы в столбцах **Change** и **%** динамически меняются в ответ на уведомления от сервера. Если открыть дополнительные браузеры для одного и того же URL-адреса, все они будут отображать одни и те же данные и одни и те же изменения данных одновременно.

Этот учебник содержит следующие подразделы:

- [Предварительные требования](#prerequisites)
- [Создание проекта](#createproject)
- [Добавление пакетов NuGet SignalR](#nugetpackages)
- [Настройка серверного кода](#server)
- [Настройка клиентского кода](#client)
- [Тестирование приложения](#test)
- [Включение ведения журналов](#enablelogging)
- [Установка и проверка полного примера Стокктиккер](#fullsample)
- [Дальнейшие действия](#nextsteps)

> [!NOTE]
> Если вы не хотите поработать с этапами создания приложения, можно установить пакет SignalR. Sample в новом **пустом проекте веб-приложения ASP.NET** и прочесть эти шаги, чтобы получить объяснения кода. В первой части руководства рассматривается подмножество SignalR. пример кода, а во второй части объясняются основные возможности дополнительных функциональных возможностей в пакете SignalR. Sample.

<a id="prerequisites"></a>

## <a name="prerequisites"></a>предварительные требования

Прежде чем начать, убедитесь, что на компьютере установлен Visual Studio 2012 или 2010 с пакетом обновления 1 (SP1). Если у вас нет Visual Studio, см. [ASP.net downloads](https://www.asp.net/downloads) , чтобы получить бесплатный выпуск visual Studio 2012 Express для Web.

Если у вас есть Visual Studio 2010, убедитесь, что [NuGet](https://visualstudiogallery.msdn.microsoft.com/27077b70-9dad-4c64-adcf-c7cf6bc9970c) установлен.

<a id="createproject"></a>

## <a name="create-the-project"></a>Создание проекта

1. В меню **Файл** выберите **Новый проект**.
2. В диалоговом окне **Новый проект** разверните узел **C#** **шаблоны** и выберите **веб**.
3. Выберите шаблон **пустое веб-приложение ASP.NET** , назовите проект *SignalR. стокктиккер*и нажмите кнопку **ОК**.

    ![Диалоговое окно «Создание проекта»](tutorial-server-broadcast-with-aspnet-signalr/_static/image2.png)

<a id="nugetpackages"></a>

## <a name="add-the-signalr-nuget-packages"></a>Добавление пакетов NuGet SignalR

### <a name="add-the-signalr-and-jquery-nuget-packages"></a>Добавление пакетов NuGet SignalR и JQuery

Функциональные возможности SignalR можно добавить в проект, установив пакет NuGet.

1. Щелкните **Сервис | Диспетчер пакетов NuGet | Консоль диспетчера пакетов**.
2. Введите следующую команду в диспетчере пакетов.

    [!code-powershell[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample1.ps1)]

    Пакет SignalR устанавливает ряд других пакетов NuGet в качестве зависимостей. По завершении установки у вас будут все компоненты сервера и клиента, необходимые для использования SignalR в приложении ASP.NET.

<a id="server"></a>

## <a name="set-up-the-server-code"></a>Настройка кода сервера

В этом разделе вы настроите код, который выполняется на сервере.

### <a name="create-the-stock-class"></a>Создание класса акции

Начнем с создания класса «складская модель», который будет использоваться для хранения и передачи информации о акции.

1. Создайте новый файл класса в папке проекта, назовите его *Stock.CS*, а затем замените код шаблона следующим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample2.cs)]

    Два свойства, которые вы задаете при создании акций, — это символ (например, MSFT для Майкрософт) и цена. Другие свойства зависят от того, как и когда задается цена. При первом задании цены значение будет распространяться на Дайопен. В последующих случаях при задании цены значения свойств Change и Перцентчанже рассчитываются на основе разницы между ценами и Дайопен.

### <a name="create-the-stockticker-and-stocktickerhub-classes"></a>Создание классов Стокктиккер и Стокктиккерхуб

Для обработки взаимодействия "сервер-клиент" вы будете использовать API концентратора SignalR. Класс Стокктиккерхуб, производный от класса концентратора SignalR, будет выполнять получение подключений и вызовов методов от клиентов. Кроме того, необходимо сохранить данные на бирже и запустить объект таймера для периодического запуска обновлений цен независимо от клиентских подключений. Эти функции нельзя разместить в центральном классе, так как экземпляры концентратора являются временными. Для каждой операции в концентраторе создается экземпляр класса концентратора, например подключения и вызовы от клиента к серверу. Таким образом, механизм, который хранит данные на бирже, обновляет цены и выполняет широковещательную рассылку, должен выполняться в отдельном классе, который наименее Стокктиккер.

![Вещание от Стокктиккер](tutorial-server-broadcast-with-aspnet-signalr/_static/image4.png)

Необходимо, чтобы на сервере выполнялся только один экземпляр класса Стокктиккер, поэтому необходимо настроить ссылку из каждого экземпляра Стокктиккерхуб на одноэлементный экземпляр Стокктиккер. Класс Стокктиккер должен иметь возможность выполнять широковещательную рассылку на клиентах, так как он содержит данные о акции и инициирует обновления, но Стокктиккер не является классом концентратора. Таким образом, класс Стокктиккер должен получить ссылку на объект контекста подключения концентратора SignalR. Затем он может использовать объект контекста подключения SignalR для передачи клиентам.

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите команду **Добавить новый элемент**.
2. Если у вас есть Visual Studio 2012 с [обновлением ASP.NET and Web Tools 2012,2](https://go.microsoft.com/fwlink/?LinkId=279941), щелкните **веб-сайт** в разделе **Visual C#**  и выберите шаблон элемента **класса концентратора SignalR** . В противном случае выберите шаблон **класса** .
3. Назовите новый класс *StockTickerHub.CS*и нажмите кнопку **Добавить**.

    ![Добавить StockTickerHub.cs](tutorial-server-broadcast-with-aspnet-signalr/_static/image5.png)
4. Замените код шаблона следующим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample3.cs)]

    Класс [Hub](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hub(v=vs.111).aspx) используется для определения методов, которые клиенты могут вызывать на сервере. Вы определяете один метод: `GetAllStocks()`. Когда клиент изначально подключается к серверу, он вызывает этот метод, чтобы получить список всех акций с текущими ценами. Метод может выполняться синхронно и возвращать `IEnumerable<Stock>`, так как он возвращает данные из памяти. Если методу пришлось бы получать данные, выполняя что-либо, включающее в себя ожидание, например поиск базы данных или вызов веб-службы, необходимо указать `Task<IEnumerable<Stock>>` как возвращаемое значение, чтобы включить асинхронную обработку. Дополнительные сведения см. [в разделе ASP.NET SignalR Hubs Guide-Server-on to Execute On асинхронное выполнение](index.md).

    Атрибут HubName указывает, как на клиенте будет ссылаться центр кода JavaScript. Имя по умолчанию на клиенте, если этот атрибут не используется, — это версия имени класса в стиле Camel, которая в данном случае будет Стокктиккерхуб.

    Как вы увидите позже при создании класса Стокктиккер, в его свойстве статического экземпляра создается одноэлементный экземпляр этого класса. Этот одноэлементный экземпляр Стокктиккер остается в памяти независимо от того, сколько клиентов подключается или отключается, и что этот экземпляр использует метод Жеталлстоккс для возврата текущих сведений о акции.
5. Создайте новый файл класса в папке проекта, назовите его *StockTicker.CS*, а затем замените код шаблона следующим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample4.cs)]

    Поскольку несколько потоков будут выполнять один и тот же экземпляр Стокктиккер кода, класс Стокктиккер должен быть среадсафе.

    ### <a name="storing-the-singleton-instance-in-a-static-field"></a>Сохранение одноэлементного экземпляра в статическом поле

    Код инициализирует статическое поле экземпляра \_, которое выполняет резервное копирование свойства экземпляра с помощью экземпляра класса, и это единственный экземпляр класса, который можно создать, поскольку конструктор помечен как частный. [Отложенная инициализация](https://msdn.microsoft.com/library/dd997286.aspx) используется для поля экземпляра \_, а не по соображениям производительности, но для обеспечения среадсафе создания экземпляра.

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample5.cs)]

    Каждый раз, когда клиент подключается к серверу, новый экземпляр класса Стокктиккерхуб, выполняющийся в отдельном потоке, получает одноэлементный экземпляр Стокктиккер из статического свойства Стокктиккер. instance, как было показано ранее в классе Стокктиккерхуб.

    ### <a name="storing-stock-data-in-a-concurrentdictionary"></a>Хранение данных о акции в ConcurrentDictionary

    Конструктор инициализирует \_коллекцию акций с помощью некоторых примеров биржевых данных, а Жеталлстоккс возвращает акции. Как было показано ранее, эта коллекция акций в свою очередь возвращается функцией Стокктиккерхуб. Жеталлстоккс, которая является методом сервера в классе Hub, который может вызываться клиентами.

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample6.cs)]

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample7.cs)]

    Коллекция Stocks определяется как тип [ConcurrentDictionary](https://msdn.microsoft.com/library/dd287191.aspx) для потокобезопасности. В качестве альтернативы можно использовать объект [Dictionary](https://msdn.microsoft.com/library/xfhwa508.aspx) и явным образом заблокировать словарь при внесении в него изменений.

    Для этого примера приложения можно сохранить данные приложения в памяти и потерять данные при удалении экземпляра Стокктиккер. В реальном приложении вы бы работали с серверным хранилищем данных, например базой данных.

    ### <a name="periodically-updating-stock-prices"></a>Периодическое обновление цен на акции

    Конструктор запускает объект Timer, который периодически вызывает методы, которые обновляют цены акций на случайном уровне.

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample8.cs)]

    Упдатестоккприцес вызывается таймером, который передает значение NULL в параметре state. Перед обновлением цен на объект \_Упдатестоккприцеслокк будет сделана блокировка. Код проверяет, обновил ли другой поток цены, а затем вызывает Трюпдатестоккприце для каждой акции в списке. Метод Трюпдатестоккприце принимает решение о необходимости изменения стоимости акций и объема ее изменения. Если цена акций изменена, Броадкастстоккприце вызывается для передачи изменений цены акций на все подключенные клиенты.

    Флаг \_Упдатингстоккприцес помечается как [volatile](https://msdn.microsoft.com/library/x13ttww7.aspx) , чтобы обеспечить доступ к нему среадсафе.

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample9.cs)]

    В реальном приложении метод Трюпдатестоккприце вызовет веб-службу для поиска цены; в этом коде используется генератор случайных чисел для внесения изменений случайным образом.

    ### <a name="getting-the-signalr-context-so-that-the-stockticker-class-can-broadcast-to-clients"></a>Получение контекста SignalR, чтобы класс Стокктиккер мог выполнить широковещательную рассылку клиентам

    Поскольку изменения цен происходят в объекте Стокктиккер, это объект, которому требуется вызывать метод Упдатестоккприце на всех подключенных клиентах. В классе концентратора имеется API для вызова клиентских методов, но Стокктиккер не является производным от класса HUB и не имеет ссылки на какой-либо объект концентратора. Поэтому для вещания на подключенных клиентах класс Стокктиккер должен получить экземпляр контекста SignalR для класса Стокктиккерхуб и использовать его для вызова методов на клиентах.

    Код получает ссылку на контекст SignalR при создании экземпляра одноэлементного класса, передает эту ссылку конструктору, а конструктор помещает его в свойство Clients.

    Существует две причины, по которым вы хотите получить контекст только один раз: Получение контекста является дорогостоящей операцией, и получение ее однократно гарантирует, что будет сохранен порядок сообщений, отправленных клиентам.

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample10.cs)]

    Получение свойства Clients контекста и помещение его в свойство Стокктиккерклиент позволяет написать код для вызова клиентских методов, которые выглядят так же, как в классе Hub. Например, для вещания на всех клиентах можно писать клиенты. ALL. Упдатестоккприце (на бирже).

    Метод Упдатестоккприце, который вызывается в Броадкастстоккприце, еще не существует; Он будет добавлен позже при написании кода, выполняемого на клиенте. Здесь можно обратиться к Упдатестоккприце, так как Clients. ALL является динамическим, а это означает, что выражение будет вычисляться во время выполнения. При выполнении этого вызова метода SignalR отправляет клиенту имя метода и значение параметра, а если у клиента есть метод с именем Упдатестоккприце, будет вызван этот метод, и ему будет передано значение параметра.

    Clients. ALL означает Send для всех клиентов. SignalR предоставляет другие возможности для указания клиентов или групп клиентов для отправки. Дополнительные сведения см. в разделе [хубконнектионконтекст](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hubs.hubconnectioncontext(v=vs.111).aspx).

### <a name="register-the-signalr-route"></a>Регистрация маршрута SignalR

Серверу необходимо указать, какой URL-адрес следует перехватить, и направить его в SignalR. Чтобы сделать это, добавьте код в файл *Global. asax* .

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите команду **Добавить новый элемент**.
2. Выберите шаблон элемента **глобального приложения** и нажмите кнопку **Добавить**.

    ![Добавить Global. asax](tutorial-server-broadcast-with-aspnet-signalr/_static/image6.png)
3. Добавьте код регистрации маршрута SignalR в метод\_запуска приложения:

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample11.cs)]

    По умолчанию основным URL-адресом для всего трафика SignalR является "/SignalR", а "/сигналр/хубс" используется для получения динамически создаваемого файла JavaScript, который определяет учетные записи-посредники для всех концентраторов в приложении. Метод Мафубс включает перегрузки, позволяющие указать другой базовый URL-адрес и определенные параметры SignalR в экземпляре класса [хубконфигуратион](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hubconfiguration(v=vs.111).aspx) .
4. Добавьте оператор using в начало файла:

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample12.cs)]
5. Сохраните и закройте файл *Global. asax* и создайте проект.

Настройка кода сервера завершена. В следующем разделе вы настроите клиент.

<a id="client"></a>

## <a name="set-up-the-client-code"></a>Настройка клиентского кода

1. Создайте новый HTML-файл в папке проекта и назовите его *стокктиккер. HTML*.
2. Замените код шаблона следующим кодом:

    [!code-html[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample13.html)]

    HTML создает таблицу с 5 столбцами, строкой заголовка и строкой данных с одной ячейкой, охватывающей все 5 столбцов. В строке данных отображается "Загрузка..." и будут отображаться мгновенно только при запуске приложения. Код JavaScript удалит эту строку и добавит в нее строки с данными, полученными с сервера.

    Теги скрипта указывают файл скрипта jQuery, основной файл скрипта SignalR, файл сценария прокси-сервера SignalR и файл сценария Стокктиккер, который будет создан позже. Файл скрипта прокси SignalR, который указывает URL-адрес "/сигналр/хубс", динамически создается и определяет прокси-методы для методов в классе Hub, в данном случае для Стокктиккерхуб. Жеталлстоккс. При желании вы можете создать этот файл JavaScript вручную с помощью [служебных программ SignalR](http://nuget.org/packages/Microsoft.AspNet.SignalR.Utils/) и отключить динамическое создание файлов при вызове метода мафубс.
3. > [!IMPORTANT]
   > Убедитесь, что ссылки на файл JavaScript в *стокктиккер. HTML* указаны правильно. То есть убедитесь, что версия jQuery в теге скрипта (1.8.2 в примере) совпадает с версией jQuery в папке *Scripts* проекта, и убедитесь, что версия SignalR в теге скрипта совпадает с версией SignalR в папке *Scripts* проекта. При необходимости измените имена файлов в тегах скрипта.
4. В **Обозреватель решений**щелкните правой кнопкой мыши *стокктиккер. HTML*и выберите пункт **задать в качестве начальной страницы**.
5. Создайте новый файл JavaScript в папке проекта и назовите его *стокктиккер. js*.
6. Замените код шаблона следующим кодом:

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample14.js)]

    $. Connection означает прокси-серверы SignalR. Код получает ссылку на прокси-сервер для класса Стокктиккерхуб и помещает его в переменную Tick. Имя прокси-сервера — это имя, заданное атрибутом [HubName]:

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample15.js)]

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample16.cs)]

    После определения всех переменных и функций последняя строка кода в файле инициализирует подключение SignalR, вызывая функцию start SignalR. Функция Start выполняется асинхронно и возвращает [отложенный объект jQuery](http://api.jquery.com/category/deferred-object/), что означает, что можно вызвать функцию done, чтобы указать функцию, вызываемую при завершении асинхронной операции.

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample17.js)]

    Функция init вызывает функцию Жеталлстоккс на сервере и использует сведения, возвращаемые сервером для обновления таблицы хранения данных. Обратите внимание, что по умолчанию для клиента необходимо использовать регистр в стиле Camel, хотя на сервере используется имя метода Pascal. Правило для прописных букв применяется только к методам, а не к объектам. Например, вы ссылаетесь на склад. Symbol и акции. Цена, а не склад. Symbol или акций. Price.

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample18.js)]

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample19.cs)]

    Если вы хотите использовать для клиента регистр на стиле Pascal или хотите использовать совершенно другое имя метода, можно было бы дополнить метод концентратора атрибутом Хубмесоднаме таким же образом, как и сам класс Hub, с атрибутом HubName.

    В методе init HTML для строки таблицы создается для каждого объекта, полученного с сервера, путем вызова Форматстокк для форматирования свойств объекта фондовой, а затем путем вызова функции заменит (которая определена в начале *стокктиккер. js*), чтобы заменить заполнители в переменной ровтемплате значениями свойств объекта «фондовой биржи». Затем полученный код HTML добавляется в таблицу запасов.

    Метод Init вызывается путем передачи его в виде функции обратного вызова, которая выполняется после завершения функции асинхронного запуска. Если после вызова Start вы вызвали init как отдельную инструкцию JavaScript, функция завершится ошибкой, так как она будет выполнена немедленно без ожидания завершения установки соединения функцией start. В этом случае функция init попытается вызвать функцию Жеталлстоккс до установки соединения с сервером.

    Когда сервер изменяет цену на акцию, он вызывает Упдатестоккприце на подключенных клиентах. Функция добавляется в свойство клиента прокси-сервера Стокктиккер, чтобы сделать его доступным для вызовов с сервера.

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample20.js)]

    Функция Упдатестоккприце форматирует объект, полученный с сервера, в строку таблицы таким же образом, как и в функции init. Однако вместо того, чтобы добавлять строку в таблицу, она находит текущую строку складского запаса в таблице и заменяет эту строку новой.

<a id="test"></a>

## <a name="test-the-application"></a>Тестирование приложения

1. Нажмите F5, чтобы выполнить приложение в режиме отладки.

    В таблице «акции» изначально отображается «загрузка...». После небольшой задержки отображается начальные данные о акции, а затем цены на акции начинают изменяться.

    ![Загрузка](tutorial-server-broadcast-with-aspnet-signalr/_static/image7.png)

    ![Начальная таблица запасов](tutorial-server-broadcast-with-aspnet-signalr/_static/image8.png)

    ![Складская таблица, получающая изменения с сервера](tutorial-server-broadcast-with-aspnet-signalr/_static/image9.png)
2. Скопируйте URL-адрес из адресной строки браузера и вставьте его в одно или несколько новых окон браузера.

    Начальное отображение запасов аналогично первому браузеру, и изменения происходят одновременно.
3. Закройте все браузеры и откройте новый браузер, а затем перейдите по тому же URL-адресу.

    Объект одноэлементного объекта Стокктиккер продолжает работать на сервере, поэтому в таблице акций отображается, что акции продолжают изменяться. (Начальная таблица с нулевыми рисунками не отображается).
4. Закройте браузер.

<a id="enablelogging"></a>

## <a name="enable-logging"></a>Включение ведения журналов

SignalR имеет встроенную функцию ведения журнала, которую можно включить на клиенте, чтобы помочь в устранении неполадок. В этом разделе вы включите ведение журнала и просмотрите примеры, демонстрирующие, как журналы указывают, какой из следующих методов транспорта использует.

- [WebSockets](http://en.wikipedia.org/wiki/WebSocket), поддерживаемые службами IIS 8 и текущими браузерами.
- [События, отправленные сервером](http://en.wikipedia.org/wiki/Server-sent_events), поддерживаются обозревателями, отличными от Internet Explorer.
- [Непрерывная рамка](http://en.wikipedia.org/wiki/Comet_(programming)#Hidden_iframe), поддерживаемая Internet Explorer.
- [Длинный опрос Ajax](http://en.wikipedia.org/wiki/Comet_(programming)#Ajax_with_long_polling), поддерживаемый всеми браузерами.

Для любого заданного соединения SignalR выбирает лучший метод транспортировки, который поддерживает сервер и клиент.

1. Откройте *стокктиккер. js* и добавьте строку кода, чтобы включить ведение журнала непосредственно перед кодом, который инициализирует подключение в конце файла:

    [!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample21.js)]
2. Нажмите клавишу F5, чтобы запустить проект.
3. Откройте окно средств разработчика в браузере и выберите консоль, чтобы просмотреть журналы. Может потребоваться обновить страницу, чтобы просмотреть журналы SignalR, согласования транспортного метода для нового подключения.

    Если вы используете Internet Explorer 10 в Windows 8 (IIS 8), метод транспорта — это WebSockets.

    ![Консоль Internet Explorer 10 IIS 8](tutorial-server-broadcast-with-aspnet-signalr/_static/image10.png)

    Если вы используете Internet Explorer 10 в Windows 7 (IIS 7,5), то транспортным методом является IFRAME.

    ![Консоль Internet Explorer 10, IIS 7,5](tutorial-server-broadcast-with-aspnet-signalr/_static/image11.png)

    В браузере Firefox установите надстройку Firebug, чтобы получить окно консоли. Если вы используете Firefox 19 в Windows 8 (IIS 8), метод транспорта — это WebSockets.

    ![WebSocket 19 служб IIS 8](tutorial-server-broadcast-with-aspnet-signalr/_static/image12.png)

    Если вы используете Firefox 19 в Windows 7 (IIS 7,5), метод Transport является серверными событиями.

    ![Консоль IIS Firefox 19 с браузером 7,5](tutorial-server-broadcast-with-aspnet-signalr/_static/image13.png)

<a id="fullsample"></a>

## <a name="install-and-review-the-full-stockticker-sample"></a>Установка и проверка полного примера Стокктиккер

Приложение Стокктиккер, устанавливаемое с помощью пакета [Microsoft. AspNet. SignalR. Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) NuGet, содержит больше функций, чем упрощенная версия, созданная с нуля. В этом разделе руководства вы установите пакет NuGet и ознакомьтесь с новыми функциями и кодом, который их реализует.

### <a name="install-the-signalrsample-nuget-package"></a>Установите пакет NuGet с SignalR. Sample.

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите пункт **Управление пакетами NuGet**.
2. В диалоговом окне **Управление пакетами NuGet** щелкните в **сети**, *введите SignalR. Sample* в поле **Поиск в Интернете** , а затем нажмите кнопку **установить** в пакете **SignalR. Sample** .

    ![Установка SignalR. пример пакета](tutorial-server-broadcast-with-aspnet-signalr/_static/image14.png)
3. В файле *Global. asax* закомментируйте RouteTable. routes. мафубс (); Строка, добавленная ранее в методе\_запуск приложения.

    Код в *Global. asax* больше не нужен, так как этот пакет регистрирует маршрут SignalR в файле *app\_Start/регистерхубс. CS* :

    [!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample22.cs)]

    Класс "Активатор", на который ссылается атрибут сборки, включен в пакет NuGet Вебактиваторекс, который устанавливается как зависимость от SignalR. пример пакета.
4. В **Обозреватель решений**разверните папку *SignalR. Sample* , которая была создана при установке SignalR. пример пакета.
5. В папке *SignalR. Sample* щелкните правой кнопкой мыши *стокктиккер. HTML*и выберите пункт **задать в качестве начальной страницы**.

    > [!NOTE]
    > Установка SignalR. пример пакета NuGet может изменить версию jQuery в папке *Scripts* . Новый файл *стокктиккер. HTML* , устанавливаемый пакетом в папке *SignalR. Sample* , будет синхронизирован с версией jQuery, устанавливаемой пакетом, но если вы хотите снова запустить исходный файл *стокктиккер. HTML* , то, возможно, потребуется сначала обновить ссылку JQuery в теге script.

### <a name="run-the-application"></a>Выполнение приложения

1. Нажмите клавишу F5 для запуска приложения.

    В дополнение к сетке, которую вы видели ранее, в полном приложении для биржевых котировок отображается окно с горизонтальной прокруткой, в котором отображаются одни и те же биржевые данные. При первом запуске приложения "Market" — "Closed", и вы увидите статическую сетку и окно с импульсами, которое не прокручивается.

    ![Начало экрана Стокктиккер](tutorial-server-broadcast-with-aspnet-signalr/_static/image15.png)

    При нажатии кнопки **Открыть рыночный**ящик в **реальном** времени начнет прокручиваться по горизонтали, а сервер начнет периодически рассылать изменения цены акций на случайном уровне. При каждом изменении цены на акцию обновляются как сетка **таблицы запасов в реальном** времени, так и поле **Live биржевое** значение. Если изменение цены на фондовой бирже положительно, то на бумаге отображается зеленый фон, а когда изменение отрицательное, на бумаге отображается красный фон.

    ![Приложение Стокктиккер, открытое на рынке](tutorial-server-broadcast-with-aspnet-signalr/_static/image16.png)

    Кнопка **Закрыть на рынке** останавливает изменения и останавливает прокрутку импульсов, а кнопка **Сброс** сбрасывает все биржевые данные в исходное состояние до начала изменения цены. Если открыть больше окон браузера и перейти к одному и тому же URL-адресу, вы увидите, что одни и те же данные динамически обновляются в каждом браузере. Если щелкнуть одну из кнопок, все браузеры будут отвечать одинаковым образом.

### <a name="live-stock-ticker-display"></a>Отображение биржевых котировок в реальном времени

Отображение **биржевых котировок** — это неупорядоченный список в элементе div, который форматируется в виде одной строки в стилях CSS. Он инициализируется и обновляется так же, как и таблица: заменяя заполнители в строке шаблона &lt;Li&gt; и динамически добавляя элементы &lt;Li&gt; в элемент &lt;UL&gt;. Прокрутка выполняется с помощью функции jQuery анимировать для изменения левого поля неупорядоченного списка в Div.

HTML-код биржевых котировок:

[!code-html[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample23.html)]

Код CSS для биржевых котировок:

[!code-html[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample24.html)]

Код jQuery, который выполняет прокрутку:

[!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample25.js)]

### <a name="additional-methods-on-the-server-that-the-client-can-call"></a>Дополнительные методы на сервере, который может вызывать клиент

Класс Стокктиккерхуб определяет четыре дополнительных метода, которые может вызывать клиент:

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample26.cs)]

Опенмаркет, Клосемаркет и Reset вызываются в ответ на кнопки в верхней части страницы. Они демонстрируют шаблон одного клиента, который инициирует изменение в состоянии, которое немедленно распространяется на все клиенты. Каждый из этих методов вызывает метод в классе Стокктиккер, который влияет на изменение состояния рынка, а затем передает новое состояние.

В классе Стокктиккер состояние рынка поддерживается свойством Маркетстате, которое возвращает значение перечисления Маркетстате:

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample27.cs)]

Каждый из методов, изменяющих состояние рынка, выполняет это в блоке блокировки, так как класс Стокктиккер должен быть среадсафе:

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample28.cs)]

Чтобы убедиться, что этот код является среадсафе, поле \_Маркетстате, которое обеспечивает обратное свойство Маркетстате, помечено как volatile,

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample29.cs)]

Методы Броадкастмаркетстатечанже и Броадкастмаркетресет похожи на метод Броадкастстоккприце, который вы уже видели, за исключением того, что они вызывают различные методы, определенные на клиенте:

[!code-csharp[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample30.cs)]

### <a name="additional-functions-on-the-client-that-the-server-can-call"></a>Дополнительные функции на клиенте, который может вызывать сервер

Функция Упдатестоккприце теперь обрабатывает сетку и отображение импульсов, а также использует jQuery. Color для красных и зеленых цветов Flash.

Новые функции в *SignalR. стокктиккер. js* включают и отключают кнопки на основе состояния рынка, а также останавливают или начинают горизонтальную прокрутку окна Tick. Так как в средство Tick. Client добавляются несколько функций, для их добавления используется [функция расширения jQuery](http://api.jquery.com/jQuery.extend/) .

[!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample31.js)]

### <a name="additional-client-setup-after-establishing-the-connection"></a>Дополнительные настройки клиента после установления соединения

После того как клиент установит соединение, он попытается выполнить некоторую дополнительную работу: определить, открыт ли или закрыт данный рынк, чтобы вызвать соответствующую функцию Маркетопенед или Маркетклосед и присоединить вызовы серверных методов к кнопкам.

[!code-javascript[Main](tutorial-server-broadcast-with-aspnet-signalr/samples/sample32.js)]

Методы сервера не привязаны к кнопкам до тех пор, пока соединение не будет установлено, чтобы код не попытается вызвать методы сервера до их доступности.

<a id="nextsteps"></a>

## <a name="next-steps"></a>Дальнейшие действия

В этом учебнике вы узнали, как программировать приложение SignalR, которое передает сообщения с сервера на все подключенные клиенты на периодической основе и в ответ на уведомления от любого клиента. Шаблон использования многопотокового одноэлементного экземпляра для поддержания состояния сервера также можно использовать в сценариях интерактивной игры с несколькими игроками. Пример см. в разделе [игра по воссозданию, основанная на SignalR](https://github.com/NTaylorMullen/ShootR).

Учебники, в которых показаны одноранговые сценарии связи, см. в разделе [Начало работы с SignalR](index.md) и [обновлением в режиме реального времени с помощью SignalR](index.md).

Чтобы узнать больше о более сложных концепциях разработки SignalR, посетите следующие сайты с исходным кодом и ресурсами SignalR:

- [ASP.NET SignalR](https://asp.net/signalr/)
- [Проект SignalR](http://signalr.net/)
- [GitHub и примеры SignalR](https://github.com/SignalR/SignalR)
- [Вики-сайт SignalR](https://github.com/SignalR/SignalR/wiki)
