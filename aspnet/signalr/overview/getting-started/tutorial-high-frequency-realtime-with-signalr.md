---
uid: signalr/overview/getting-started/tutorial-high-frequency-realtime-with-signalr
title: Учебник. Создание приложения с высокой частотой в реальном времени с помощью SignalR 2 | Документация Майкрософт
author: bradygaster
description: В этом руководстве показано, как создать веб-приложение, которое использует SignalR ASP.NET для предоставления высокоскоростной функции обмена сообщениями.
ms.author: bradyg
ms.date: 01/22/2019
ms.assetid: 9f969dda-78ea-4329-b1e3-e51c02210a2b
msc.legacyurl: /signalr/overview/getting-started/tutorial-high-frequency-realtime-with-signalr
msc.type: authoredcontent
ms.topic: tutorial
ms.openlocfilehash: 2503e90735d6cfa445ee08c9e43f8443aa106096
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78450120"
---
# <a name="tutorial-create-high-frequency-real-time-app-with-signalr-2"></a>Учебник. Создание приложения с высокой частотой в реальном времени с помощью SignalR 2

В этом руководстве показано, как создать веб-приложение, использующее ASP.NET SignalR 2 для обеспечения высокой функциональности обмена сообщениями. В этом случае "обмен сообщениями с высокой частотой" означает, что сервер отправляет обновления с фиксированной скоростью. Вы отправляете до 10 сообщений за секунду.

Создаваемое приложение отображает фигуру, которую пользователи могут перетаскивать. Сервер обновляет расположение фигуры во всех подключенных браузерах в соответствии с положением перетаскивания фигуры с помощью времени обновления.

Основные понятия, представленные в этом руководстве, представляют собой приложения в режиме реального времени и другие приложения моделирования.

Изучив это руководство, вы:

> [!div class="checklist"]
> * Настройка проекта
> * Создание базового приложения
> * Сопоставлять с концентратором при запуске приложения
> * Добавление клиента
> * Запустите приложение
> * Добавление цикла клиента
> * Добавление цикла сервера
> * Добавить плавную анимацию

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

## <a name="prerequisites"></a>предварительные требования

* [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) с рабочей нагрузкой **ASP.NET и веб-разработка**.

## <a name="set-up-the-project"></a>Настройка проекта

В этом разделе вы создадите проект в Visual Studio 2017.

В этом разделе показано, как с помощью Visual Studio 2017 создать пустое веб-приложение ASP.NET и добавить SignalR и библиотеку jQuery. UI.

1. В Visual Studio создайте веб-приложение ASP.NET.

    ![Создание веб-сайта](tutorial-high-frequency-realtime-with-signalr/_static/image1.png)

1. В окне **Создание веб-приложения ASP.NET — мовешапедемо** оставьте **пустым** выбранным и нажмите кнопку **ОК**.

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите **Добавить** > **новый элемент**.

1. В окне **Добавить новый элемент — мовешапедемо**выберите **установлено** > **Visual C#**  > **Web** > **SignalR** , а затем выберите **класс концентратора SignalR (v2)** .

1. Назовите класс *мовешапехуб* и добавьте его в проект.

    На этом шаге создается файл класса *MoveShapeHub.CS* . Одновременно он добавляет набор файлов скриптов и ссылок на сборки, которые поддерживают SignalR для проекта.

1. Выберите **Инструменты** > **Диспетчер пакетов NuGet** > **Консоль диспетчера пакетов**.

1. В **консоли диспетчера пакетов**выполните следующую команду:

    ```console
    Install-Package jQuery.UI.Combined
    ```

    Команда устанавливает библиотеку пользовательского интерфейса jQuery. Он используется для анимации фигуры.

1. В **Обозреватель решений**разверните узел скрипты.

    ![Ссылки на библиотеку скриптов](tutorial-high-frequency-realtime-with-signalr/_static/image2.png)

    Библиотеки скриптов для jQuery, Жкуерюи и SignalR отображаются в проекте.

## <a name="create-the-base-application"></a>Создание базового приложения

В этом разделе вы создадите приложение браузера. Приложение отправляет расположение фигуры на сервер при каждом событии перемещения мыши. Сервер передает эти сведения всем остальным подключенным клиентам в режиме реального времени. Дополнительные сведения об этом приложении см. в следующих разделах.

1. Откройте файл *MoveShapeHub.CS* .

1. Замените код в файле *MoveShapeHub.CS* следующим кодом:

    [!code-csharp[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample1.cs)]

1. Сохраните файл.

Класс `MoveShapeHub` является реализацией концентратора SignalR. Как и в [Начало работы с](tutorial-getting-started-with-signalr.md) руководством по SignalR, центр имеет метод, который клиенты напрямую вызывают. В этом случае клиент отправляет объект с новыми координатами X и Y фигуры на сервер. Эти координаты посылаются на все остальные подключенные клиенты. SignalR автоматически сериализует этот объект с помощью JSON.

Приложение отправляет клиенту объект `ShapeModel`. Он содержит элементы для хранения расположения фигуры. Версия объекта на сервере также имеет член для отслеживания хранения данных клиента. Этот объект не позволяет серверу отправлять данные клиента обратно. Этот элемент использует атрибут `JsonIgnore`, чтобы приложение не было выполнять сериализацию данных и отправлять их обратно клиенту.

## <a name="map-to-the-hub-when-app-starts"></a>Сопоставлять с концентратором при запуске приложения

Затем настройте сопоставление с концентратором при запуске приложения. В SignalR 2 при добавлении класса Startup OWIN создается сопоставление.

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите **Добавить** > **новый элемент**.

1. В **меню Добавить новый элемент — мовешапедемо** выберите **установлено** > **Visual C#**  > **Web** , а затем выберите **класс запуска OWIN**.

1. Назовите класс *Startup* и нажмите кнопку **ОК**.

1. Замените код по умолчанию в файле *Startup.CS* следующим кодом:

    [!code-csharp[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample2.cs)]

Класс запуска OWIN вызывает `MapSignalR`, когда приложение выполняет метод `Configuration`. Приложение добавляет класс в процесс запуска OWIN с помощью атрибута сборки `OwinStartup`.

## <a name="add-the-client"></a>Добавление клиента

Добавьте HTML-страницу для клиента.

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект и выберите **Добавить** > **HTML-страницу**.

1. Присвойте странице имя **по умолчанию** и нажмите кнопку **ОК**.

1. В **Обозреватель решений**щелкните правой кнопкой мыши *Default. HTML* и выберите **задать в качестве начальной страницы**.

1. Замените код по умолчанию в файле *Default. HTML* следующим кодом:

    [!code-html[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample3.html?highlight=14-16)]

1. В **Обозреватель решений**разверните узел **сценарии**.

    Библиотеки скриптов для jQuery и SignalR отображаются в проекте.

    > [!IMPORTANT]
    > Диспетчер пакетов устанавливает более позднюю версию сценариев SignalR.

1. Обновите ссылки на скрипт в блоке кода, чтобы они соответствовали версиям файлов скриптов в проекте.

Этот код HTML и JavaScript создает красный `div` с именем `shape`. Он обеспечивает поведение перетаскивания фигуры с помощью библиотеки jQuery и использует событие `drag` для отправки расположения фигуры на сервер.

## <a name="run-the-app"></a>Запустите приложение

Вы можете запустить приложение, чтобы се'е его работу. При перетаскивании формы вокруг окна браузера фигура также перемещается в другие браузеры.

1. На панели инструментов включите **отладку скриптов** , а затем нажмите кнопку Воспроизведение, чтобы запустить приложение в режиме отладки.

    ![Снимок экрана: Включение режима отладки пользователем и выбор воспроизведения.](tutorial-high-frequency-realtime-with-signalr/_static/image3.png)

    Открывается окно браузера с красной фигурой в правом верхнем углу.

1. Скопируйте URL-адрес страницы.

1. Откройте другой браузер и вставьте URL-адрес в адресную строку.

1. Перетащите фигуру в одно из окон браузера. Форма в другом окне браузера выглядит следующим образом.

Хотя приложение работает с помощью этого метода, это не рекомендуемая модель программирования. Нет верхнего предела числа отправляемых сообщений. В результате клиенты и сервер перегружаются с помощью сообщений и снижает производительность. Кроме того, приложение отображает несвязанную анимацию на стороне клиента. Эта жерки анимация происходит потому, что фигура мгновенно перемещается каждым методом. Это лучше, если фигура плавно перемещается в каждое новое место. Далее вы узнаете, как устранить эти проблемы.

## <a name="add-the-client-loop"></a>Добавление цикла клиента

При отправке расположения фигуры при каждом событии перемещения мыши создается ненужный объем сетевого трафика. Приложение должно регулировать сообщения от клиента.

Используйте функцию `setInterval` JavaScript, чтобы настроить цикл, который отправляет новые сведения о положении на сервер с фиксированной частотой. Этот цикл является базовым представлением "цикла игры". Это многократно именуемая функция, которая управляет всеми функциями игры.

1. Замените код клиента в файле *Default. HTML* следующим кодом:

    [!code-html[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample4.html?highlight=14-16)]

    > [!IMPORTANT]
    > Необходимо снова заменить ссылки на скрипт. Они должны соответствовать версиям скриптов в проекте.

    Этот новый код добавляет функцию `updateServerModel`. Он вызывается с фиксированной частотой. Функция отправляет данные о положении на сервер, когда флаг `moved` указывает на наличие новых данных о расположении для отправки.

1. Нажмите кнопку Воспроизведение, чтобы запустить приложение.

1. Скопируйте URL-адрес страницы.

1. Откройте другой браузер и вставьте URL-адрес в адресную строку.

1. Перетащите фигуру в одно из окон браузера. Форма в другом окне браузера выглядит следующим образом.

Так как приложение регулирует количество сообщений, отправляемых на сервер, анимация не будет отображаться как гладкие.

## <a name="add-the-server-loop"></a>Добавление цикла сервера

В текущем приложении сообщения, отправленные с сервера клиенту, отправляются так часто, как они получены. Этот сетевой трафик представляет аналогичную проблему, как видно на клиенте.

Приложение может отсылать сообщения чаще, чем требуется. Соединение может передаваться в результате. В этом разделе описывается, как обновить сервер, чтобы добавить таймер, который регулирует скорость исходящих сообщений.

1. Замените содержимое `MoveShapeHub.cs` следующим кодом:

    [!code-csharp[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample5.cs)]

1. Нажмите кнопку Воспроизведение, чтобы запустить приложение.

1. Скопируйте URL-адрес страницы.

1. Откройте другой браузер и вставьте URL-адрес в адресную строку.

1. Перетащите фигуру в одно из окон браузера.

Этот код расширяет возможности клиента, добавляя класс `Broadcaster`. Новый класс регулирует исходящие сообщения, используя класс `Timer` из .NET Framework.

Хорошо понять, что концентратор является транзитным. Он создается каждый раз, когда это необходимо. Поэтому приложение создает `Broadcaster` как одноэлементный. Она использует отложенную инициализацию, чтобы отложить создание `Broadcaster`до ее необходимости. Это гарантирует, что приложение создает первый экземпляр концентратора полностью перед запуском таймера.

После этого вызов функции `UpdateShape` клиентов перемещается из метода `UpdateModel` концентратора. Он больше не вызывается немедленно при получении приложением входящих сообщений. Вместо этого приложение отправляет сообщения клиентам с частотой 25 вызовов в секунду. Процесс управляется таймером `_broadcastLoop` в классе `Broadcaster`.

Наконец, вместо непосредственного вызова метода клиента из концентратора `Broadcaster` классу необходимо получить ссылку на текущий центр `_hubContext`. Он получает ссылку с `GlobalHost`.

## <a name="add-smooth-animation"></a>Добавить плавную анимацию

Приложение почти готово, но мы можем сделать еще одно улучшение. Приложение перемещает форму на клиенте в ответ на сообщения сервера. Вместо задания позиции фигуры в новом расположении, заданном сервером, используйте функцию `animate` библиотеки пользовательского интерфейса JQuery. Она может плавно перемещать фигуру между текущей и новой позицией.

1. Обновите метод `updateShape` клиента в файле *Default. HTML* , чтобы он был похож на выделенный код:

    [!code-html[Main](tutorial-high-frequency-realtime-with-signalr/samples/sample6.html?highlight=33-40)]

1. Нажмите кнопку Воспроизведение, чтобы запустить приложение.

1. Скопируйте URL-адрес страницы.

1. Откройте другой браузер и вставьте URL-адрес в адресную строку.

1. Перетащите фигуру в одно из окон браузера.

Перемещение фигуры в другом окне выглядит менее жерки. Приложение интерполирует свое перемещение с течением времени, а не устанавливается один раз для каждого входящего сообщения.

Этот код перемещает фигуру из старого расположения в новое. Сервер задает расположение фигуры на протяжении интервала анимации. В этом случае это 100 миллисекунд. Приложение очищает любую предыдущую анимацию, запущенную на фигуре, до начала новой анимации.

## <a name="get-the-code"></a>Получение кода

[Скачать завершенный проект](https://code.msdn.microsoft.com/SignalR-20-MoveShape-Demo-6285b83a)

## <a name="additional-resources"></a>Дополнительные ресурсы

Парадигма связи, которую вы только что изучили, полезна для разработки Интернет-игр и других симуляций, таких как [игра «прокрутка», созданная с помощью SignalR](https://shootr.azurewebsites.net/).

Дополнительные сведения о SignalR см. в следующих ресурсах:

* [Проект SignalR](http://signalr.net)

* [GitHub и примеры SignalR](https://github.com/SignalR/SignalR)

* [Вики-сайт SignalR](https://github.com/SignalR/SignalR/wiki)

## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Настройка проекта
> * Создано базовое приложение
> * Сопоставлено с концентратором при запуске приложения
> * Добавлен клиент
> * Запустили приложение
> * Добавлен цикл клиента
> * Добавлен цикл сервера
> * Добавлена гладкая анимация

Перейдите к следующей статье, чтобы узнать, как создать веб-приложение, использующее ASP.NET SignalR 2 для предоставления функций серверной широковещательной рассылки.
> [!div class="nextstepaction"]
> [SignalR 2 и трансляция сервера](tutorial-server-broadcast-with-signalr.md)