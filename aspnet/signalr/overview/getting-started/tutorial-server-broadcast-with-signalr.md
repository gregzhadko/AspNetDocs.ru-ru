---
uid: signalr/overview/getting-started/tutorial-server-broadcast-with-signalr
title: 'Учебник: Сервер вещания с SignalR 2 Документы Майкрософт'
author: tdykstra
description: В этом учебнике показано, как создать веб-приложение, которое использует ASP.NET SignalR 2 для обеспечения функциональности вещания сервера.
ms.author: bradyg
ms.date: 01/02/2019
ms.topic: tutorial
ms.assetid: 1568247f-60b5-4eca-96e0-e661fbb2b273
msc.legacyurl: /signalr/overview/getting-started/tutorial-server-broadcast-with-signalr
msc.type: authoredcontent
ms.openlocfilehash: 14924109fff8db3e537e6bc08b6dc868792ee660
ms.sourcegitcommit: ce28244209db8615bc9bdd576a2e2c88174d318d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2020
ms.locfileid: "80675727"
---
# <a name="tutorial-server-broadcast-with-signalr-2"></a>Учебник: Сервер вещания с SignalR 2

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

В этом учебнике показано, как создать веб-приложение, которое использует ASP.NET SignalR 2 для обеспечения функциональности вещания сервера. Трансляция сервера означает, что сервер запускает сообщения, отправленные клиентам.

Приложение, которое вы создадите в этом учебнике, имитирует биржевый тикер, типичный сценарий для функциональности вещания сервера. Периодически сервер случайным образом обновляет цены на акции и транслирует обновления всем подключенным клиентам. В браузере числа и символы **%** в **изменении** и столбцах динамически меняются в ответ на уведомления с сервера. Если вы откроете дополнительные браузеры по тому же URL-, все они отображают одни и те же данные и одинаковые изменения в данных.

![Создание веб-страниц](tutorial-server-broadcast-with-signalr/_static/image1.png)

Изучив это руководство, вы:

> [!div class="checklist"]
> * Создание проекта
> * Настройка кода сервера
> * Изучить код сервера
> * Настройка кода клиента
> * Изучить код клиента
> * Тестирование приложения
> * Включение ведения журналов

> [!IMPORTANT]
> Если вы не хотите работать над этапами создания приложения, вы можете установить пакет SignalR.Sample в новый проект Пустого ASP.NET Web Application. Если вы установите пакет NuGet, не выполняя шагов в этом учебнике, вы должны следовать инструкциям в файле *readme.txt.* Для запуска пакета необходимо добавить класс запуска OWIN, который вызывает `ConfigureSignalR` метод в установленном пакете. Вы получите ошибку, если не добавите класс запуска OWIN. Смотрите раздел [«Установка образца StockTicker»](#install-the-stockticker-sample) в этой статье.

## <a name="prerequisites"></a>Предварительные требования

* [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) с рабочей нагрузкой **ASP.NET и веб-разработка**.

## <a name="create-the-project"></a>Создание проекта

В этом разделе показано, как использовать Visual Studio 2017 для создания пустого веб-приложения ASP.NET.

1. В Visual Studio создайте веб-приложение ASP.NET.

    ![Создание веб-страниц](tutorial-server-broadcast-with-signalr/_static/image2.png)

1. В **Новом ASP.NET веб-приложении - SignalR.StockTicker** окно, оставьте **Пустые** выбранные и выбрать **OK**.

## <a name="set-up-the-server-code"></a>Настройка кода сервера

В этом разделе вы настраиваете код, который работает на сервере.

### <a name="create-the-stock-class"></a>Создание класса stock

Вы начинаете с создания класса *модели Stock,* который вы будете использовать для хранения и передачи информации о запасе.

1. В **Solution Explorer**, правой кнопкой мыши проекта и выберите **Добавить** > **класс**.

1. Назовите класс *Stock* и добавьте его в проект.

1. Замените код в *файле Stock.cs* этим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample1.cs)]

    Два свойства, которые вы установите при `Symbol` создании запасов (например, `Price`MSFT для Microsoft) и . Другие свойства зависят от `Price`того, как и когда вы установите . При первом установке `Price`значение распространяется на. `DayOpen` После этого, когда `Price`вы устанавливаете, `Change` `PercentChange` приложение вычисляет значения `Price` `DayOpen`и свойства на основе разницы между и .

### <a name="create-the-stocktickerhub-and-stockticker-classes"></a>Создание классов StockTickerHub и StockTicker

Для обработки взаимодействия от сервера с клиентом вы будете использовать API концентратора SignalR. Класс, `StockTickerHub` который вытекает из `Hub` класса SignalR, будет обрабатывать прием подключений и методов вызовов от клиентов. Также необходимо поддерживать данные о `Timer` запасах и запускать объект. Объект `Timer` будет периодически запускать обновления цен независимо от клиентских подключений. Вы не можете поместить эти `Hub` функции в класс, потому что концентраторы являются переходными. Приложение создает `Hub` экземпляр класса для каждой задачи в концентраторе, например, соединения и звонки от клиента к серверу. Таким образом, механизм, который хранит данные о запасах, обновляет цены и транслирует обновления цен, должен работать в отдельном классе. Вы назовете класс. `StockTicker`

![Вещание от StockTicker](tutorial-server-broadcast-with-signalr/_static/image3.png)

Требуется только один `StockTicker` экземпляр класса для запуска на сервере, поэтому вам нужно `StockTickerHub` настроить ссылку `StockTicker` из каждого экземпляра на экземпляр синглтона. Класс `StockTicker` должен транслироваться клиентам, потому что он имеет `StockTicker` данные о `Hub` запасах и вызывает обновления, но не является классом. Класс `StockTicker` должен получить ссылку на контекстный объект соединения SignalR Hub. Затем он может использовать контекстный объект соединения SignalR для трансляции для клиентов.

#### <a name="create-stocktickerhubcs"></a>Создание StockTickerHub.cs

1. В **Solution Explorer**, правой кнопкой мыши проекта и выберите **Добавить** > **новый пункт**.

1. В **Добавить новый пункт - SignalR.StockTicker**, выберите **Установленный** > **визуальный C'** > **Web** > **SignalR,** а затем выберите **SignalR концентратор класса (v2)**.

1. Назовите класс *StockTickerHub* и добавьте его в проект.

    Этот шаг создает файл *StockTickerHub.cs* класса. Одновременно он добавляет набор файлов скриптов и ссылок на сборку, которые поддерживают SignalR в проект.

1. Замените код в *файле StockTickerHub.cs* этим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample2.cs)]

1. Сохраните файл.

Приложение использует класс [концентратора](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hub(v=vs.111).aspx) для определения методов, которые клиенты могут вызвать на сервере. Вы определяете один `GetAllStocks()`метод: . Когда клиент первоначально подключается к серверу, он будет называть этот метод, чтобы получить список всех акций с их текущими ценами. Метод может работать синхронно `IEnumerable<Stock>` и возвращаться, поскольку он возвращает данные из памяти.

Если метод должен был получить данные, делая что-то, что предполагает ожидание, например, поиск базы данных или вызов веб-службы, вы бы указали `Task<IEnumerable<Stock>>` в качестве значения возврата для обеспечения асинхронной обработки. Для получения дополнительной информации, см [ASP.NET SignalR концентраторов API Руководство - Сервер - Когда выполнять асинхронно](../guide-to-the-api/hubs-api-guide-server.md#asyncmethods).

Атрибут `HubName` определяет, как приложение будет ссылаться на код Концентратора javaScript на клиенте. Имя клиента по умолчанию, если вы не используете этот атрибут, является верблюжьей `stockTickerHub`версией имени класса, которая в этом случае будет.

Как вы увидите позже `StockTicker` при создании класса, приложение создает единичный `Instance` экземпляр этого класса в своем статичном свойстве. Этот однотонный `StockTicker` экземпляр находится в памяти независимо от того, сколько клиентов подключаются или отключаются. Этот экземпляр является `GetAllStocks()` то, что метод использует для возвращения текущей информации о запасах.

#### <a name="create-stocktickercs"></a>Создание StockTicker.cs

1. В **Solution Explorer**, правой кнопкой мыши проекта и выберите **Добавить** > **класс**.

1. Назовите класс *StockTicker* и добавьте его в проект.

1. Замените код в *файле StockTicker.cs* этим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample3.cs)]

Поскольку все потоки будут работать в одном экземпляре кода StockTicker, класс StockTicker должен быть безопасным для потоков.

### <a name="examine-the-server-code"></a>Изучить код сервера

Если вы изучите код сервера, это поможет вам понять, как работает приложение.

#### <a name="storing-the-singleton-instance-in-a-static-field"></a>Хранение экземпляра синглтона в статичном поле

Код инициализирует `_instance` статическое поле, которое поддерживает `Instance` свойство экземпляром класса. Поскольку конструктор является частным, это единственный экземпляр класса, который может создать приложение. Приложение использует [Ленивый инициализации](/dotnet/framework/performance/lazy-initialization) `_instance` для поля. Это не по причинам производительности. Это, чтобы убедиться, что создание экземпляра является безопасным для потоков.

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample4.cs)]

Каждый раз, когда клиент подключается к серверу, новый экземпляр класса StockTickerHub, работающий `StockTicker.Instance` в отдельном потоке, `StockTickerHub` получает экземпляр StockTicker singleton из статического свойства, как вы видели ранее в классе.

#### <a name="storing-stock-data-in-a-concurrentdictionary"></a>Хранение данных о запасах в параллельном словаре

Конструктор инициализирует коллекцию `_stocks` с некоторыми выборочными данными о запасах и `GetAllStocks` возвращает запасы. Как вы видели ранее, эта коллекция `StockTickerHub.GetAllStocks`акций возвращается, `Hub` который является методом сервера в классе, который клиенты могут позвонить.

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample5.cs)]

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample6.cs)]

Сбор запасов определяется как тип [ConcurrentDictionary](https://msdn.microsoft.com/library/dd287191.aspx) для безопасности потоков. В качестве альтернативы можно использовать объект [словаря](https://msdn.microsoft.com/library/xfhwa508.aspx) и явно заблокировать словарь при внесении изменений в него.

Для этого примера приложения можно хранить данные приложения в памяти и терять `StockTicker` данные, когда приложение избавляется от экземпляра. В реальном приложении вы будете работать с запасом данных бэк-энда, как база данных.

#### <a name="periodically-updating-stock-prices"></a>Периодические обновления цен на акции

Конструктор запускает `Timer` объект, который периодически вызывает методы, которые обновляют цены на акции на случайной основе.

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample7.cs)]

 `Timer`вызовов, `UpdateStockPrices`который проходит в нулевых в параметре состояния. Перед обновлением цен приложение запирает `_updateStockPricesLock` объект. Код проверяет, обновляет ли другой поток цены, `TryUpdateStockPrice` а затем призывает каждую акцию в списке. Метод `TryUpdateStockPrice` решает, следует ли изменить цену акций, и сколько изменить его. Если цена акций меняется, приложение призывает `BroadcastStockPrice` транслировать изменение цены акций для всех подключенных клиентов.

Флаг, `_updatingStockPrices` обозначенный [летучим,](https://msdn.microsoft.com/library/x13ttww7.aspx) чтобы убедиться, что он без покоя.

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample8.cs)]

В реальном приложении `TryUpdateStockPrice` метод вызовет веб-службу, чтобы найти цену. В этом коде приложение использует генератор случайных чисел для внесения изменений случайным образом.

#### <a name="getting-the-signalr-context-so-that-the-stockticker-class-can-broadcast-to-clients"></a>Получение контекста SignalR, чтобы класс StockTicker мог транслировать сядовещание клиентам

Поскольку изменения цен происходят `StockTicker` здесь, в объекте, это `updateStockPrice` объект, который должен вызвать метод на всех подключенных клиентов. В `Hub` классе у вас есть API для вызова `StockTicker` методов клиента, `Hub` но он не вытекает `Hub` из класса и не имеет ссылки на какой-либо объект. Для трансляции подключенным `StockTicker` клиентам класс должен получить экземпляр `StockTickerHub` контекста SignalR для класса и использовать его для вызова методов для клиентов.

Код получает ссылку на контекст SignalR, когда он создает экземпляр класса синглтон, передает эту ссылку `Clients` на конструктор, и конструктор помещает его в свойство.

Существует две причины, по которым вы хотите получить контекст только один раз: получение контекста является дорогостоящей задачей, и получение его один раз гарантирует, что приложение сохраняет предполагаемый порядок сообщений, отправляемых клиентам.

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample9.cs)]

Получение `Clients` свойства контекста и размещение `StockTickerClient` его в свойстве позволяет писать код для вызова клиентских `Hub` методов, который выглядит так же, как это было бы в классе. Например, для трансляции для `Clients.All.updateStockPrice(stock)`всех клиентов вы можете написать .

`updateStockPrice` Метод, который вы вызываете, `BroadcastStockPrice` еще не существует. Вы добавите его позже, когда вы напишете код, который работает на клиенте. Вы можете `updateStockPrice` сослаться `Clients.All` на здесь, потому что это динамическое, что означает, что приложение будет оценивать выражение во время выполнения. Когда вызов этого метода выполняется, SignalR отправит клиенту имя метода и значение `updateStockPrice`параметра, и если у клиента есть метод под названием, приложение вызовет этот метод и передаст ему значение параметра.

`Clients.All`означает отправку всем клиентам. SignalR дает вам другие варианты, чтобы указать, какие клиенты или группы клиентов, чтобы отправить. Для получения дополнительной информации [см.](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hubs.hubconnectioncontext(v=vs.111).aspx)

### <a name="register-the-signalr-route"></a>Регистрация маршрута SignalR

Сервер должен знать, какой URL перехватить и направить на SignalR. Для этого добавьте класс стартапов OWIN:

1. В **Solution Explorer**, правой кнопкой мыши проекта и выберите **Добавить** > **новый пункт**.

1. В **Добавлении Новый пункт - SignalR.StockTicker** выберите **установленный** > **визуальный C'** > **Web,** а затем выберите класс запуска **OWIN**.

1. Назовите класс *Startup* и выберите **OK**.

1. Замените код по умолчанию в *файле Startup.cs* этим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample10.cs)]

Теперь вы закончили настройку серверного кода. В следующем разделе вы настроили клиента.

## <a name="set-up-the-client-code"></a>Настройка кода клиента

В этом разделе вы настраиваете код, который работает на клиенте.

### <a name="create-the-html-page-and-javascript-file"></a>Создание html-страницы и файла JavaScript

Страница HTML будет отображать данные, а файл JavaScript организует данные.

#### <a name="create-stocktickerhtml"></a>Создание StockTicker.html

Во-первых, вы добавите HTML-клиент.

1. В **Solution Explorer**, правой кнопкой мыши проекта и выберите **Добавить** > **HTML Страницы**.

1. Назовите файл *StockTicker* и выберите **OK**.

1. Замените код по умолчанию в файле *StockTicker.html* этим кодом:

    [!code-html[Main](tutorial-server-broadcast-with-signalr/samples/sample11.html?highlight=40-43)]

    HTML создает таблицу с пятью столбцов, строкой заголовка и строкой данных с одной ячейкой, которая охватывает все пять столбцов. Строка данных показывает "загрузку..." на мгновение, когда приложение запускается. Код JavaScript удалит эту строку и добавит в свое место строки с запасами данных, извлеченных с сервера.

    Теги скрипта указывают:

    * Файл скрипта j''s.

    * Файл ядра SignalR.

    * Файл скриптов SignalR.

    * Файл сценария StockTicker, который вы создадите позже.

    Приложение динамически генерирует файл скриптов SignalR. Он определяет URL-адрес "/signalr/hubs" и определяет прокси-методы для методов на классе `StockTickerHub.GetAllStocks`концентратора, в данном случае для . Если вы предпочитаете, вы можете создать этот файл JavaScript вручную с помощью [SignalR Утилиты](http://nuget.org/packages/Microsoft.AspNet.SignalR.Utils/). Не забудьте отключить создание динамического файла в вызове метода. `MapHubs`

1. В **Solution Explorer**расширьте **скрипты.**

    В проекте видны библиотеки сценариев для j''query и SignalR.

    > [!IMPORTANT]
    > Менеджер пакетов установит более позднюю версию скриптов SignalR.

1. Обновление ссылок на сценарий в блоке кода в соответствии с версиями файлов скрипта в проекте.

1. В **Solution Explorer**, правой кнопкой мыши *StockTicker.html*, а затем выберите **Установить в качестве стартовой страницы**.

#### <a name="create-stocktickerjs"></a>Создание StockTicker.js

Теперь создайте файл JavaScript.

1. В **Solution Explorer**, правой кнопкой мыши проекта и выберите **Добавить** > **JavaScript файл**.

1. Назовите файл *StockTicker* и выберите **OK**.

1. Добавьте этот код в файл *StockTicker.js:*

    [!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample12.js)]

### <a name="examine-the-client-code"></a>Изучить код клиента

Если вы изучите клиентский код, это поможет вам узнать, как клиентский код взаимодействует с серверным кодом, чтобы приложение работало.

#### <a name="starting-the-connection"></a>Запуск соединения

`$.connection`относится к прокси SignalR. Код получает ссылку на прокси `StockTickerHub` для класса и `ticker` помещает его в переменную. Имя прокси — это имя, `HubName` которое было установлено атрибутом:

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample13.js)]

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample14.cs)]

После определения всех переменных и функций последняя строка кода в файле инициализирует соединение SignalR, вызывая функцию SignalR. `start` Функция `start` выполняет асинхронно и возвращает [отложенный объект j's'ry.](http://api.jquery.com/category/deferred-object/) Можно вызвать выполненную функцию, чтобы указать функцию вызова, когда приложение завершает асинхронное действие.

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample15.js)]

#### <a name="getting-all-the-stocks"></a>Получение всех запасов

Функция `init` вызывает `getAllStocks` функцию на сервере и использует информацию, которую сервер возвращает для обновления таблицы запасов. Обратите внимание, что по умолчанию, вы должны использовать camelCasing на клиенте, даже если имя метода pascal-cased на сервере. Правило camelCasing применяется только к методам, а не к объектам. Например, вы `stock.Symbol` ссылаетесь `stock.symbol` `stock.price`на и, `stock.Price`нет или .

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample16.js)]

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample17.cs)]

В `init` методе приложение создает HTML для строки таблицы для каждого `formatStock` объекта акций, полученного от сервера, вызывая для формата `stock` свойства объекта, а затем вызывая `supplant` для замены заполнителей в `rowTemplate` переменной значения множества `stock` объектов. Полученный HTML затем пригозывается к таблице запасов.

> [!NOTE]
> Вы `init` звоните, передавая `callback` его в качестве функции, `start` которая выполняет после асинхронной функции заканчивается. Если вы `init` назвали отдельное заявление `start`JavaScript после вызова, функция выйдет из строя, потому что она будет работать немедленно, не дожидаясь завершения работы функции запуска, чтобы закончить создание соединения. В этом случае `init` функция будет пытаться вызвать функцию `getAllStocks` до того, как приложение установит подключение к серверу.

#### <a name="getting-updated-stock-prices"></a>Получение обновленных цен на акции

Когда сервер изменяет цену акции, он `updateStockPrice` вызывает подключенных клиентов. Приложение добавляет функцию в свойство `stockTicker` клиента прокси, чтобы сделать его доступным для звонков с сервера.

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample18.js)]

`updateStockPrice` Функция форматирует объект акции, полученный от сервера, в `init` строку таблицы так же, как и в функции. Вместо того, чтобы привить строку к таблице, он находит текущий ряд акции в таблице и заменяет эту строку на новую.

## <a name="test-the-application"></a>Тестирование приложения

Вы можете проверить приложение, чтобы убедиться, что оно работает. Вы увидите все окна браузера отображать живой стол акции с ценами на акции колеблются.

1. В панели инструментов включите **отладку скриптов,** а затем выберите кнопку воспроизведения для запуска приложения в режиме Debug.

    ![Скриншот включения пользователя в режим отладки и выбора воспроизведения.](tutorial-server-broadcast-with-signalr/_static/image4.png)

    Окно браузера откроется отображение **Live Stock Таблица**. Таблица акций сначала показывает "загрузку..." линия, то, после короткого времени, приложение показывает первоначальные данные акций, а затем цены на акции начинают меняться.

1. Копируйте URL-адрес из браузера, открывай два других браузера и вставьте URL-адреса в адресные бары.

    Первоначальный дисплей акций такой же, как первый браузер и изменения происходят одновременно.

1. Закройте все браузеры, откройте новый браузер и перейдите на тот же URL.

    Объект StockTicker singleton продолжал работать на сервере. **Таблица Live Stock** показывает, что акции продолжают меняться. Исходная таблица не просматривается с нулевыми цифрами изменений.

1. Закройте браузер.

## <a name="enable-logging"></a>Включение ведения журналов

SignalR имеет встроенную функцию регистрации, которую вы можете включить на клиента, чтобы помочь в устранении неполадок. В этом разделе вы можете войти в систему и увидеть примеры, которые показывают, как журналы показывают, какой из следующих методов транспортировки Использует SignalR:

* [WebSockets](http://en.wikipedia.org/wiki/WebSocket), поддерживается IIS 8 и текущих браузеров.

* [События, отправляемые серверами,](http://en.wikipedia.org/wiki/Server-sent_events)поддерживаемые браузерами, помимо Internet Explorer.

* [Навсегда кадр](http://en.wikipedia.org/wiki/Comet_(programming)#Hidden_iframe), поддерживается Internet Explorer.

* [Ajax долго опроса](http://en.wikipedia.org/wiki/Comet_(programming)#Ajax_with_long_polling), поддерживается всеми браузерами.

Для любого данного соединения SignalR выбирает лучший способ транспортировки, который поддерживает ся сервер и клиент.

1. Открыть *StockTicker.js*.

1. Добавьте эту выделенную строку кода, чтобы включить журнал непосредственно перед кодом, который инициализирует соединение в конце файла:

    [!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample19.js?highlight=2)]

1. Нажмите **F5** для запуска проекта.

1. Откройте окно инструментов для разработчиков браузера и выберите консоль, чтобы просмотреть журналы. Возможно, вам придется обновить страницу, чтобы увидеть журналы SignalR переговоров метод транспортировки для нового соединения.

    * Если вы работаете Internet Explorer 10 на Windows 8 (IIS 8), способ транспортировки **WebSockets**.

    * Если вы работаете Internet Explorer 10 на Windows 7 (IIS 7.5), способ транспортировки **iframe**.

    * Если вы работаете Firefox 19 на Windows 8 (IIS 8), способ транспортировки **WebSockets**.

        > [!TIP]
        > В Firefox установите надстройку Firebug, чтобы получить окно консоли.

    * Если вы работаете Firefox 19 на Windows 7 (IIS 7.5), способ транспортировки — это события, **отправляемые сервером.**

## <a name="install-the-stockticker-sample"></a>Установка образца StockTicker

[Microsoft.AspNet.SignalR.Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) устанавливает приложение StockTicker. Пакет NuGet включает в себя больше возможностей, чем упрощенная версия, которую вы создали с нуля. В этом разделе учебника вы устанавливаете пакет NuGet и просматриваете новые функции и код, который их реализует.

> [!IMPORTANT]
> Если вы установите пакет, не выполняя более ранние шаги этого руководства, вы должны добавить класс запуска OWIN в свой проект. Этот файл readme.txt для пакета NuGet объясняет этот шаг.

### <a name="install-the-signalrsample-nuget-package"></a>Установка пакета SignalR.Sample NuGet

1. В **Solution Explorer**, правой кнопкой мыши проекта и выберите Управление **NuGet пакеты**.

1. В **NuGet менеджер пакета: SignalR.StockTicker**, выберите **Просмотр**.

1. Из **источника пакета**выберите **nuget.org**.

1. Введите *SignalR.Sample* в поле поиска и выберите **Microsoft.AspNet.SignalR.Sample** > **Install.**

1. В **Solution Explorer**расширьте папку *SignalR.Sample.*

    Установка пакета SignalR.Sample создала папку и ее содержимое.

1. В папке *SignalR.Sample,* правой кнопкой мыши *StockTicker.html*, а затем выберите **Установить Как стартовая страница**.

    > [!NOTE]
    > Установка пакета SignalR.Sample NuGet может изменить версию j's, которая у вас есть в папке *Скриптов.* Новый файл *StockTicker.html,* который пакет устанавливается в папку *SignalR.Sample,* будет синхронизирован с версией j''ry, которую устанавливает пакет, но если вы хотите запустить исходный файл *StockTicker.html* снова, возможно, вам придется сначала обновить ссылку на j''образ в теге скрипта.

### <a name="run-the-application"></a>Выполнение приложения

 Таблица, которую вы видели в первом приложении, имела полезные функции. Полное приложение биржевых тикеров показывает новые функции: горизонтально прокрутки окна, которые показывают данные о запасах и акции, которые меняют цвет, как они поднимаются и падают.

1. Нажмите клавишу **F5** , чтобы запустить приложение.

     При первом запуске приложения "рынок" "закрыт", и вы видите статичную таблицу и окно тикера, которое не прокручивается.

1. Выберите **открытый рынок**.

    ![Скриншот живого тикера.](tutorial-server-broadcast-with-signalr/_static/image5.png)

    * Коробка **Live Stock Ticker** начинает прокручиваться горизонтально, и сервер начинает периодически транслировать изменения цен на акции на случайной основе.

    * Каждый раз, когда цена акций меняется, приложение обновляет как **Live Stock Table** и Live Stock **Ticker**.

    * Когда изменение цены акции является положительным, приложение показывает акции с зеленым фоном.

    * Когда изменение отрицательное, приложение показывает акции с красным фоном.

1. Выберите **Близкий рынок**.

    * Обновления таблицы останавливаются.

    * Тикер останавливает прокрутку.

1. Выберите **Сброс**.

    * Все данные о запасах сбросить.

    * Приложение восстанавливает исходное состояние до начала изменения цен.

1. Копируйте URL-адрес из браузера, открывай два других браузера и вставьте URL-адреса в адресные бары.

1. В каждом браузере динамически обновляются одни и те же данные.

1. При выборе любого элемента управления все браузеры отвечают одинаково одновременно.

### <a name="live-stock-ticker-display"></a>Live Фондовый Тикер дисплей

Дисплей **Live Stock Ticker** — это `<div>` неупорядоченный список в элементе, отформатированный в одну строку стилями CSS. Приложение инициализирует и обновляет тикер так же, как таблица: путем замены заполнителей `<li>` в строке шаблона и динамического добавления `<li>` элементов в `<ul>` элемент. Приложение включает в себя прокрутку `animate` с помощью функции j'ery, `<div>`чтобы изменять маржу слева от неупорядоченного списка в пределах .

#### <a name="signalrsample-stocktickerhtml"></a>SignalR.Sample StockTicker.html

Фондовый тиккер HTML-код:

[!code-html[Main](tutorial-server-broadcast-with-signalr/samples/sample20.html)]

#### <a name="signalrsample-stocktickercss"></a>SignalR.Sample StockTicker.css

Код биржевого тикера CSS:

[!code-html[Main](tutorial-server-broadcast-with-signalr/samples/sample21.html)]

#### <a name="signalrsample-signalrstocktickerjs"></a>SignalR.Sample SignalR.StockTicker.js

Код j''s, который делает его прокрутки:

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample22.js)]

### <a name="additional-methods-on-the-server-that-the-client-can-call"></a>Дополнительные методы на сервере, которые клиент может вызвать

Чтобы добавить гибкости в приложение, есть дополнительные методы, которые приложение может вызвать.

#### <a name="signalrsample-stocktickerhubcs"></a>SignalR.Образец StockTickerHub.cs

Класс `StockTickerHub` определяет четыре дополнительных метода, которые клиент может вызвать:

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample23.cs)]

Приложение вызывает `OpenMarket` `CloseMarket`, `Reset` , и в ответ на кнопки в верхней части страницы. Они демонстрируют модель одного клиента, вызывающего изменение состояния, немедленно распространяемого для всех клиентов. Каждый из этих методов `StockTicker` вызывает метод в классе, который вызывает изменение состояния рынка, а затем передает новое состояние.

#### <a name="signalrsample-stocktickercs"></a>SignalR.Образец StockTicker.cs

В `StockTicker` классе приложение поддерживает состояние рынка с свойством, `MarketState` которое возвращает `MarketState` значение enum:

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample24.cs)]

Каждый из методов, изменяющие состояние рынка, `StockTicker` делает это внутри блока блокировки, поскольку класс должен быть безопасным для потоков:

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample25.cs)]

Чтобы убедиться, что этот код `_marketState` является безопасным `MarketState` для потоков, поле, которое поддерживает свойство назначено: `volatile`

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample26.cs)]

`BroadcastMarketStateChange` Методы `BroadcastMarketReset` и методы аналогичны методу BroadcastStockPrice, который вы уже видели, за исключением того, что они называют различные методы, определенные в клиенте:

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample27.cs)]

### <a name="additional-functions-on-the-client-that-the-server-can-call"></a>Дополнительные функции клиента, которые сервер может вызвать

Функция `updateStockPrice` теперь обрабатывает как таблицу, так и `jQuery.Color` дисплей тикера, и она использует для вспышки красного и зеленого цветов.

Новые функции в *SignalR.StockTicker.js* позволяют отключить и отключить кнопки в зависимости от состояния рынка. Они также останавливают или начинают горизонтальную прокрутку **Live Stock Ticker.** Так как многие функции добавляются к `ticker.client`, приложение использует [функцию расширения j'sry,](http://api.jquery.com/jQuery.extend/) чтобы добавить их.

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample28.js)]

### <a name="additional-client-setup-after-establishing-the-connection"></a>Дополнительная настройка клиента после установления соединения

После того, как клиент устанавливает соединение, он имеет некоторые дополнительные работы, чтобы сделать:

* Узнайте, открыт ли рынок или закрыт `marketOpened` `marketClosed` для вызова соответствующей или функциональной функции.

* Прикрепите вызовы метода сервера к кнопкам.

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample29.js)]

Методы сервера не подключены к кнопкам до тех пор, пока приложение не установит соединение. Таким образом, код не может вызвать методы сервера до их появления.

## <a name="additional-resources"></a>Дополнительные ресурсы

В этом уроке вы узнали, как запрограммировать приложение SignalR, которое транслирует сообщения с сервера всем подключенным клиентам. Теперь вы можете транслировать сообщения на периодической основе и в ответ на уведомления от любого клиента. Вы можете использовать концепцию многопоточного экземпляра синглтона для поддержания состояния сервера в многопользовательских сценариях онлайн-игр. Например, [см. игру ShootR на основе SignalR](https://github.com/NTaylorMullen/ShootR).

Для учебников, которые показывают одноранговой сценарии общения, [см. Начало работы с SignalR](introduction-to-signalr.md) и [в режиме реального времени обновление с SignalR](tutorial-high-frequency-realtime-with-signalr.md).

Для получения дополнительной информации о SignalR см.

* [ASP.NET SignalR](../../index.md)
* [Проект SignalR](http://signalr.net/)
* [SignalR GitHub и образцы](https://github.com/SignalR/SignalR)
* [SignalR Вики](https://github.com/SignalR/SignalR/wiki)

## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Создан проект
> * Настройка кода сервера
> * Изучение кода сервера
> * Настройка кода клиента
> * Изучение кода клиента
> * тестирование приложения.
> * Включенная регистрация

Перейти к следующей статье, чтобы узнать, как создать веб-приложение в режиме реального времени, который использует ASP.NET SignalR 2.
> [!div class="nextstepaction"]
> [Создание веб-приложения в режиме реального времени с помощью SignalR](real-time-web-applications-with-signalr.md)
