---
uid: web-pages/overview/getting-started/introducing-aspnet-web-pages-2/entering-data
title: Введение веб-страницы ASP.NET ввод данных базы данных с помощью форм | Документация Майкрософт
author: Rick-Anderson
description: В этом учебнике показано, как создать форму ввода, а затем ввести данные, получаемые из формы, в таблицу базы данных при использовании веб-страницы ASP.NET (...
ms.author: riande
ms.date: 05/28/2015
ms.assetid: d37c93fc-25fd-4e94-8671-0d437beef206
msc.legacyurl: /web-pages/overview/getting-started/introducing-aspnet-web-pages-2/entering-data
msc.type: authoredcontent
ms.openlocfilehash: b9354a7b97a7df9020a681f709e16a92650cfcf0
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78506604"
---
# <a name="introducing-aspnet-web-pages---entering-database-data-by-using-forms"></a>Введение веб-страницы ASP.NET ввод данных базы данных с помощью форм

от [Tom фитзмаккен](https://github.com/tfitzmac)

> В этом учебнике показано, как создать форму ввода, а затем ввести данные, получаемые из формы, в таблицу базы данных при использовании веб-страницы ASP.NET (Razor). Предполагается, что вы выполнили серию [из основ HTML-форм в веб-страницы ASP.NET](https://go.microsoft.com/fwlink/?LinkId=251581).
> 
> Из этого руководства вы узнаете, как выполнять такие задачи:
> 
> - Дополнительные сведения об обработке форм ввода.
> - Инструкции по добавлению (вставке) данных в базу данных.
> - Как убедиться, что пользователи указали требуемое значение в форме (проверка вводимых пользователем данных).
> - Как отобразить ошибки проверки.
> - Переход на другую страницу с текущей страницы.
>   
> 
> Обсуждаемые функции и технологии:
> 
> - метод `Database.Execute` ;
> - Инструкция SQL `Insert Into`
> - Вспомогательный метод `Validation`.
> - метод `Response.Redirect` ;

## <a name="what-youll-build"></a>Что вы создадите

В этом руководстве, в котором показано, как создать базу данных, вы указали данные базы данных путем изменения базы данных непосредственно в WebMatrix, работая в рабочей области **базы данных** . Однако в большинстве приложений это не самый практичный способ размещения данных в базе данных. Итак, в этом учебнике вы создадите веб-интерфейс, который позволит пользователям вводить данные и сохранять их в базе данных.

Вы создадите страницу, на которой можно ввести новые фильмы. На странице будет содержаться форма ввода, содержащая поля (текстовые поля), где можно ввести название фильма, жанр и год. Страница будет выглядеть, как на следующей странице:

![Страница "Добавление фильма" в браузере](entering-data/_static/image1.png)

Текстовые поля будут `<input>` HTML-элементы, которые будут выглядеть, как в этой разметке:

`<input type="text" name="genre" value="" />`

## <a name="creating-the-basic-entry-form"></a>Создание базовой формы ввода

Создайте страницу с именем *аддмовие. cshtml*.

Замените содержимое файла следующей разметкой. Перезаписать все; в ближайшее время вы добавите блок кода.

[!code-cshtml[Main](entering-data/samples/sample1.cshtml)]

В этом примере показан типичный код HTML для создания формы. В нем используются элементы `<input>` для текстовых полей и для кнопки отправки. Заголовки для текстовых полей создаются с помощью стандартных элементов `<label>`. Элементы `<fieldset>` и `<legend>` помещают привлекательную рамку вокруг формы.

Обратите внимание, что на этой странице элемент `<form>` использует `post` в качестве значения атрибута `method`. В предыдущем руководстве вы создали форму, в которой использовался метод `get`. Это верно, поскольку хотя в форме отправлены значения на сервер, запрос не сделал никаких изменений. Все это делало выборку данных различными способами. Однако на этой странице *будут* внесены изменения — вы добавите новые записи базы данных. Поэтому в этой форме должен использоваться метод `post`. (Дополнительные сведения о различиях между операциями `GET` и `POST` см. в разделе[Получение, публикация и HTTP-команда безопасность глагола](https://go.microsoft.com/fwlink/?LinkId=251581#GET,_POST,_and_HTTP_Verb_Safety) в предыдущем руководстве.)

Обратите внимание, что каждое текстовое поле содержит элемент `name` (`title`, `genre`, `year`). Как было показано в предыдущем учебном курсе, эти имена важны, так как они должны иметь такие имена, чтобы вы могли получить входные данные пользователя позже. Можно использовать любые имена. Полезно использовать понятные имена, которые помогут вспомнить, с какими данными вы работаете.

Атрибут `value` каждого элемента `<input>` содержит несколько фрагментов кода Razor (например, `Request.Form["title"]`). В предыдущем учебном курсе вы узнали, как сохранить значение, введенное в текстовое поле (если оно имеется) после отправки формы.

## <a name="getting-the-form-values"></a>Получение значений формы

Затем добавьте код, обрабатывающий форму. В структуре вы выполните следующие действия.

1. Проверьте, выполняется ли отправка страницы (отправлена). Необходимо, чтобы код выполнялся только при нажатии пользователем кнопки, а не при первом запуске страницы.
2. Получение значений, вводимых пользователем в текстовые поля. В этом случае, поскольку форма использует команду `POST`, вы получаете значения формы из коллекции `Request.Form`.
3. Вставьте значения в качестве новой записи в таблицу базы данных *фильмов* .

В верхней части файла добавьте следующий код:

[!code-cshtml[Main](entering-data/samples/sample2.cshtml)]

Первые несколько строк создают переменные (`title`, `genre`и `year`) для хранения значений из текстовых полей. Строка `if(IsPost)` гарантирует, что переменные задаются *только* при нажатии пользователем кнопки **Добавить фильм** , т. е. при публикации формы.

Как было показано в предыдущем учебном курсе, значение текстового поля можно получить с помощью выражения, например `Request.Form["name"]`, где *Name* — это имя элемента `<input>`.

Имена переменных (`title`, `genre`и `year`) являются произвольными. Как и имена, назначаемые элементам `<input>`, их можно вызывать любым из них. (Имена переменных не обязательно должны совпадать с атрибутами name элементов `<input>` в форме.) Но, как и в случае с элементами `<input>`, рекомендуется использовать имена переменных, отражающие данные, которые они содержат. При написании кода последовательные имена облегчают запоминание данных, с которыми вы работаете.

## <a name="adding-data-to-the-database"></a>Добавление данных в базу данных

В только что добавленном блоке *кода в* закрывающей фигурной скобке (`}`) блока `if` (не только внутри блока кода) добавьте следующий код:

[!code-csharp[Main](entering-data/samples/sample3.cs)]

Этот пример похож на код, использованный в предыдущем руководстве для выборки и вывода данных. Строка, которая начинается с `db =`, открывает базу данных, как и ранее, а следующая строка определяет инструкцию SQL снова, как показано выше. Однако на этот раз он определяет инструкцию SQL `Insert Into`. В следующем примере показан общий синтаксис оператора `Insert Into`:

`INSERT INTO table (column1, column2, column3, ...) VALUES (value1, value2, value3, ...)`

Иными словами, вы указываете таблицу для вставки, затем перечислите столбцы для вставки, а затем перечислите значения для вставки. (Как отмечалось ранее, SQL не учитывает регистр, но некоторые люди заменяют ключевые слова, чтобы упростить чтение команды.)

Столбцы, в которые вы вставляете, уже указаны в команде — `(Title, Genre, Year)`. Интересной частью является получение значений из текстовых полей в `VALUES` части команды. Вместо фактических значений отображаются `@0`, `@1`и `@2`, которые являются заполнителями курса. При выполнении команды (в строке `db.Execute`) передаются значения, полученные из текстовых полей.

**Важно!** Помните, что единственным способом включения данных, вводимых пользователем в режиме «в сети» в инструкции SQL, является использование заполнителей, как показано здесь (`VALUES(@0, @1, @2)`). При объединении вводимых пользователем данных в инструкцию SQL вы открываете атаки путем внедрения кода SQL, как описано в разделе [основы форм в веб-страницы ASP.NET](https://go.microsoft.com/fwlink/?LinkId=251581) (предыдущее руководство).

По-прежнему внутри блока `if` добавьте следующую строку после строки `db.Execute`:

[!code-css[Main](entering-data/samples/sample4.css)]

После вставки нового фильма в базу данных эта строка перемещает вас (перенаправление) на страницу *фильмов* , чтобы можно было увидеть только что введенный фильм. Оператор `~` означает "корень веб-сайта". (Оператор `~` работает только на страницах ASP.NET, а не в HTML.)

Полный блок кода выглядит как в следующем примере:

[!code-cshtml[Main](entering-data/samples/sample5.cshtml)]

## <a name="testing-the-insert-command-so-far"></a>Тестирование команды INSERT (до сих пор)

Вы еще не сделали этого, но теперь пора протестировать.

В древовидном представлении файлов в WebMatrix щелкните правой кнопкой мыши страницу *аддмовие. cshtml* и выберите пункт **запустить в браузере**.

![Страница "Добавление фильма" в браузере](entering-data/_static/image2.png)

(Если вы работаете с другой страницей в браузере, убедитесь, что URL-адрес имеет `http://localhost:nnnnn/AddMovie`), где *nnnnn* — это номер порта, который вы используете.)

Вы получаете страницу ошибки? Если да, внимательно прочтите его и убедитесь, что код выглядит точно так, как было указано ранее.

Введите фильм в форме &mdash; например, используйте "Кане", "драма" и "1941". (Или любой другой.) Затем щелкните **Добавить фильм**.

Если все работает правильно, вы будете перенаправлены на страницу *фильмов* . Убедитесь, что в списке указан новый фильм.

![На странице фильмов показан недавно добавленный фильм](entering-data/_static/image3.png)

## <a name="validating-user-input"></a>Проверка введенного пользователем

Вернитесь на страницу *аддмовие* или запустите ее снова. Введите другой фильм, но на этот раз введите только заголовок &mdash; например, введите "Сингин' в дождя". Затем щелкните **Добавить фильм**.

Вы снова будете перенаправлены на страницу *фильмов* . Новый фильм можно найти, но он является неполным.

![На странице фильмов отображается новый фильм, в котором отсутствуют некоторые значения](entering-data/_static/image4.png)

При создании таблицы *Movies* вы явно сказали, что ни одно из полей не может иметь значение null. Здесь у вас есть форма для новых фильмов, и вы оставляете поля пустыми. Это ошибка.

В этом случае база данных не вызывает (или не *создает*) ошибку. Вы не преддали жанр или год, поэтому код на странице *аддмовие* обрабатывает эти значения как так называемые *пустые строки*. При выполнении команды SQL `Insert Into` в полях жанр и year не было полезных данных, но они не были равны NULL.

Очевидно, что вы не хотите, чтобы пользователи вводили половину пустую информацию о фильме в базу данных. Решением является проверка входных данных пользователя. Первоначально проверка позволит убедиться, что пользователь вводит значение для всех полей (то есть ни одно из них не содержит пустую строку).

> [!TIP]
> 
> **NULL и пустые строки**
> 
> В программировании существует различие между разными понятиями "нет значения". Как правило, значение равно *null* , если оно никогда не было задано или инициализировано каким-либо образом. Напротив, переменная, которая принимает символьные данные (строки), может быть задана *пустой строкой*. В этом случае значение не равно null; просто явно задана строка символов, длина которых равна нулю. Эти две инструкции показывают разницу:
> 
> [!code-csharp[Main](entering-data/samples/sample6.cs)]
> 
> Это немного сложнее, но важно отметить, что `null` представляет неопределенное состояние.
> 
> Теперь важно понимать, когда значение равно null, и когда это просто пустая строка. В коде для страницы *аддмовие* значения текстовых полей можно получить с помощью `Request.Form["title"]` и т. д. При первом запуске страницы (перед нажатием кнопки) значение `Request.Form["title"]` равно null. Но при отправке формы `Request.Form["title"]` получает значение текстового поля `title`. Это не очевидно, но пустое текстовое поле не равно null; в нем просто содержится пустая строка. Таким образом, когда код выполняется в ответ на нажатие кнопки, `Request.Form["title"]` содержит в нем пустую строку.
> 
> Почему это различие важно? При создании таблицы *Movies* вы явно сказали, что ни одно из полей не может иметь значение null. Но здесь у вас есть форма для новых фильмов, и вы оставляете поля пустыми. При попытке сохранения новых фильмов, которые не имеют значений для жанра или года, будет необходимо, чтобы база данных выглядела бы. Но это точка &mdash; даже если оставить эти текстовые поля пустыми, значения не будут равны NULL. они являются пустыми строками. В результате вы можете сохранять новые фильмы в базе данных, если эти столбцы пусты &mdash; но не равны NULL! значения типа &mdash;. Поэтому необходимо убедиться, что пользователи не отправляют пустую строку, что можно сделать, проверив входные данные пользователя.

### <a name="the-validation-helper"></a>Вспомогательный метод проверки

Веб-страницы ASP.NET включает вспомогательную функцию &mdash; `Validation` вспомогательного &mdash; приложения, которую можно использовать, чтобы убедиться, что пользователи вводят данные, соответствующие вашим требованиям. `Validation` вспомогательное приложение — это один из встроенных средств поддержки веб-страницы ASP.NET, поэтому вам не нужно устанавливать его как пакет с помощью NuGet, так как вы установили вспомогательный модуль граватаров в предыдущем руководстве.

Чтобы проверить входные данные пользователя, выполните следующие действия.

- Используйте код, чтобы указать, что необходимо запрашивать значения в текстовых полях на странице.
- Добавьте тест в код, чтобы сведения о фильме добавлялись в базу данных только в том случае, если все правильно проверяется.
- Добавьте код в разметку для вывода сообщений об ошибках.

В блоке кода на странице *аддмовие* , расположенном в верхней части до объявления переменных, добавьте следующий код:

[!code-csharp[Main](entering-data/samples/sample7.cs)]

Вы вызываете `Validation.RequireField` один раз для каждого поля (`<input>` элемента), где требуется указать запись. Можно также добавить пользовательское сообщение об ошибке для каждого вызова, как показано здесь. (Мы изменяем сообщения только для того, чтобы продемонстрировать, что вы можете вставить в него все, что угодно.)

Если возникла проблема, необходимо предотвратить вставку новых сведений о фильме в базу данных. В блоке `if(IsPost)` используйте `&&` (логическое и), чтобы добавить еще одно условие, которое проверяет `Validation.IsValid()`. Когда все будет готово, весь блок `if(IsPost)` будет выглядеть следующим образом:

[!code-csharp[Main](entering-data/samples/sample8.cs)]

Если при проверке любого из полей, зарегистрированных с помощью вспомогательного метода `Validation`, возникает ошибка проверки, метод `Validation.IsValid` возвращает значение false. В этом случае ни один из кода в этом блоке не будет выполняться, поэтому в базу данных не будут вставлены недопустимые записи фильмов. И, конечно, вы не будете перенаправлены на страницу *фильмов* .

Полный блок кода, включая код проверки, теперь выглядит как в следующем примере:

[!code-cshtml[Main](entering-data/samples/sample9.cshtml?highlight=10)]

## <a name="displaying-validation-errors"></a>Отображение ошибок проверки

Последний шаг — отображение сообщений об ошибках. Можно отображать отдельные сообщения для каждой ошибки проверки, а также отображать сводку или и то, и другое. В рамках этого руководства вы выполните оба действия, чтобы увидеть, как это работает.

Рядом с каждым проверяемым элементом `<input>` вызовите метод `Html.ValidationMessage` и передайте ему имя проверяемого элемента `<input>`. Метод `Html.ValidationMessage` помещается непосредственно в то место, где должно отображаться сообщение об ошибке. При выполнении страницы метод `Html.ValidationMessage` визуализирует элемент `<span>`, в котором произойдет ошибка проверки. (Если ошибок нет, элемент `<span>` отображается, но в нем нет текста.)

Измените разметку на странице, чтобы она включала метод `Html.ValidationMessage` для каждого из трех элементов `<input>` на странице, как показано в следующем примере:

[!code-cshtml[Main](entering-data/samples/sample10.cshtml?highlight=3,8,13)]

Чтобы увидеть, как работает сводка, добавьте следующую разметку и код сразу после элемента `<h1>Add a Movie</h1>` на странице:

[!code-cshtml[Main](entering-data/samples/sample11.cshtml)]

По умолчанию метод `Html.ValidationSummary` отображает все сообщения проверки в списке (элемент `<ul>`, находящиеся внутри элемента `<div>`). Как и в случае с методом `Html.ValidationMessage`, разметка для сводки проверки всегда отображается; Если ошибок нет, элементы списка не отображаются.

Сводка может быть альтернативным способом отобразить сообщения проверки вместо использования метода `Html.ValidationMessage` для вывода каждой ошибки, относящейся к определенному полю. Также можно использовать как сводку, так и сведения. Или можно использовать метод `Html.ValidationSummary` для вывода общей ошибки, а затем использовать отдельные вызовы `Html.ValidationMessage` для вывода сведений.

Теперь полная страница выглядит как в следующем примере:

[!code-cshtml[Main](entering-data/samples/sample12.cshtml)]

Вот и все. Теперь можно протестировать страницу, добавив фильм, но выполнив одно или несколько полей. При этом отображается следующее сообщение об ошибке:

![Страница добавления фильма с сообщениями об ошибках проверки](entering-data/_static/image5.png)

## <a name="styling-the-validation-error-messages"></a>Определение стиля сообщений об ошибках проверки

Видно, что есть сообщения об ошибках, но они не слишком хорошо выделены. Однако существует простой способ стиля сообщений об ошибках.

Чтобы задать стиль отдельных сообщений об ошибках, отображаемых `Html.ValidationMessage`, создайте класс стиля CSS с именем `field-validation-error`. Чтобы определить вид сводки проверки, создайте класс стиля CSS с именем `validation-summary-errors`.

Чтобы увидеть, как работает этот метод, добавьте элемент `<style>` в раздел `<head>` страницы. Затем определите классы стилей с именами `field-validation-error` и `validation-summary-errors`, которые содержат следующие правила.

[!code-cshtml[Main](entering-data/samples/sample13.cshtml?highlight=4-17)]

Обычно можно разместить сведения о стилях в отдельном *CSS* -файле, но для простоты их можно разместить на странице сейчас. (Далее в этом руководстве вы перенесите правила CSS в отдельный *CSS* -файл.)

При возникновении ошибки проверки метод `Html.ValidationMessage` визуализирует элемент `<span>`, который содержит `class="field-validation-error"`. Добавив определение стиля для этого класса, можно настроить то, как выглядит сообщение. При наличии ошибок метод `ValidationSummary` динамически визуализирует `class="validation-summary-errors"`атрибута.

Снова запустите страницу и намеренно оставьте несколько полей. Ошибки теперь более заметны. (На самом деле они переработаны, но это просто покажет, что можно сделать.)

![Страница добавления фильма с показанными ошибками проверки](entering-data/_static/image6.png)

## <a name="adding-a-link-to-the-movies-page"></a>Добавление ссылки на страницу фильмов

Одним из заключительных этапов является упрощение перехода на страницу *аддмовие* из исходного списка фильмов.

Снова откройте страницу *фильмов* . После закрывающего тега `</div>`, который следует за вспомогательным модулем `WebGrid`, добавьте следующую разметку:

[!code-cshtml[Main](entering-data/samples/sample14.cshtml)]

Как было показано ранее, ASP.NET интерпретирует оператор `~` как корень веб-сайта. Не нужно использовать оператор `~`; можно использовать разметку `<a href="./AddMovie">Add a movie</a>` или какой-либо другой способ определения пути, который понимается в HTML. Но оператор `~` является хорошим общим подходом при создании ссылок на страницы Razor, так как делает сайт более гибким — при перемещении текущей страницы во вложенную папку ссылка по-прежнему будет переходить на страницу *аддмовие* . (Помните, что оператор `~` работает только в *CSHTML* -страницах. ASP.NET понимает его, но не является стандартным HTML.)

Когда все будет готово, запустите страницу *фильмов* . Она будет выглядеть, как на следующей странице:

![Страница фильмов со ссылкой на страницу "Добавление фильмов"](entering-data/_static/image7.png)

Щелкните ссылку **Добавить фильм** , чтобы убедиться, что он перейдет на страницу *аддмовие* .

## <a name="coming-up-next"></a>Далее

В следующем руководстве вы узнаете, как разрешить пользователям изменять данные, которые уже находятся в базе данных.

## <a name="complete-listing-for-addmovie-page"></a>Полный список для страницы Аддмовие

[!code-cshtml[Main](entering-data/samples/sample15.cshtml)]

## <a name="additional-resources"></a>Дополнительные ресурсы

- [Введение в веб-программирование ASP.NET с использованием синтаксиса Razor](https://go.microsoft.com/fwlink/?LinkID=202890)
- [Инструкция SQL INSERT INTO](http://www.w3schools.com/sql/sql_insert.asp) на сайте W3Schools
- [Проверка вводимых пользователем данных на веб-страницы ASP.NET сайтах](https://go.microsoft.com/fwlink/?LinkId=253002). Дополнительные сведения о работе с вспомогательным приложением `Validation`.

> [!div class="step-by-step"]
> [Назад](form-basics.md)
> [Вперед](updating-data.md)
