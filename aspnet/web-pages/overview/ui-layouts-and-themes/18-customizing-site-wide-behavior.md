---
uid: web-pages/overview/ui-layouts-and-themes/18-customizing-site-wide-behavior
title: Настройка поведения сайта для сайтов веб-страницы ASP.NET (Razor) | Документация Майкрософт
author: Rick-Anderson
description: В этой главе объясняется, как выполнять параметры для всего веб-сайта или всей папки, а не только для страницы.
ms.author: riande
ms.date: 02/17/2014
ms.assetid: e158bed7-226f-4275-b02e-7553bd58c669
msc.legacyurl: /web-pages/overview/ui-layouts-and-themes/18-customizing-site-wide-behavior
msc.type: authoredcontent
ms.openlocfilehash: f05e05f725d9209bce283ce18659ae5efe4de2ee
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78515250"
---
# <a name="customizing-site-wide-behavior-for-aspnet-web-pages-razor-sites"></a>Настройка поведения сайта для сайтов веб-страницы ASP.NET (Razor)

от [Tom фитзмаккен](https://github.com/tfitzmac)

> В этой статье объясняется, как создавать параметры на стороне сайта для страниц на веб-сайте веб-страницы ASP.NET (Razor).
> 
> Из этого руководства вы узнаете, как выполнять такие задачи:
> 
> - Запуск кода, который позволяет задавать значения (глобальные значения или вспомогательные параметры) для всех страниц сайта.
> - Выполнение кода, который позволяет задавать значения для всех страниц в папке.
> - Выполнение кода до и после загрузки страницы.
> - Отправка ошибок на центральную страницу ошибки.
> - Добавление проверки подлинности ко всем страницам в папке.
>   
> 
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемые в этом руководстве
> 
> 
> - Веб-страницы ASP.NET (Razor) 2
> - WebMatrix 3
> - Библиотека вспомогательных веб-функций ASP.NET (пакет NuGet)
>   
> 
> Этот учебник также работает с веб-страницы ASP.NET 3 и Visual Studio 2013 (или Visual Studio Express 2013 для Web), за исключением того, что нельзя использовать библиотеку веб-вспомогательных функций ASP.NET.

<a id="Adding_Website_Startup_Code"></a>
## <a name="adding-website-startup-code-for-aspnet-web-pages"></a>Добавление кода запуска веб-сайта для веб-страницы ASP.NET

Для большей части кода, который вы пишете в веб-страницы ASP.NET, отдельная страница может содержать весь код, необходимый для этой страницы. Например, если страница отправляет сообщение электронной почты, можно разместить весь код для этой операции на одной странице. Это может быть код для инициализации параметров отправки электронной почты (то есть для SMTP-сервера) и отправки сообщения электронной почты.

Однако в некоторых ситуациях может потребоваться выполнить некоторый код перед выполнением любой страницы на сайте. Это полезно для настройки значений, которые можно использовать в любом месте сайта (называемых *глобальными значениями*). Например, некоторые вспомогательные методы потребовали указать такие значения, как параметры электронной почты или ключи учетной записи. Может быть удобно хранить эти параметры в глобальных значениях.

Это можно сделать, создав страницу с именем *\_AppStart. cshtml* в корне сайта. Если эта страница существует, она выполняется в первый раз, когда запрашивается любая страница на сайте. Поэтому рекомендуется выполнять код для установки глобальных значений. (Поскольку *\_AppStart. cshtml* имеет префикс подчеркивания, ASP.NET не отправляет страницу в браузер, даже если пользователи запрашивают его напрямую.)

На следующей схеме показано, как работает страница *\_AppStart. cshtml* . Когда запрос поступает на страницу, и если это первый запрос для любой страницы сайта, ASP.NET сначала проверяет, существует ли страница *\_AppStart. cshtml* . В этом случае выполняется любой код на странице *\_AppStart. cshtml* , после чего выполняется запрошенная страница.

![[образ]](18-customizing-site-wide-behavior/_static/image1.jpg)

## <a name="setting-global-values-for-your-website"></a>Настройка глобальных значений для веб-сайта

1. В корневой папке веб-сайта WebMatrix создайте файл с именем *\_AppStart. cshtml*. Файл должен находиться в корневом каталоге сайта.
2. Замените имеющееся содержимое следующим: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample1.cshtml)]

    Этот код сохраняет значение в словаре `AppState`, который автоматически доступен для всех страниц сайта. Обратите внимание, что файл *\_AppStart. cshtml* не имеет разметки. Страница запустит код, а затем перенаправит на первоначально запрошенную страницу.

    > [!NOTE]
    > Будьте внимательны при помещении кода в файл *\_AppStart. cshtml* . Если в коде файла *\_AppStart. cshtml* возникли ошибки, веб-сайт не запустится.
3. В корневой папке создайте новую страницу с именем *AppName. cshtml*.
4. Замените разметку и код по умолчанию следующим кодом: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample2.html)]

    Этот код извлекает значение из объекта `AppState`, заданного на странице *\_AppStart. cshtml* .
5. Запустите страницу *AppName. cshtml* в браузере. (Перед выполнением страницы убедитесь, что она выбрана в рабочей области **файлы** .) На странице отображается глобальное значение. 

    ![[образ]](18-customizing-site-wide-behavior/_static/image2.jpg)

<a id="Setting_Values_For_Helpers"></a>
## <a name="setting-values-for-helpers"></a>Настройка значений для вспомогательных функций

Хорошим использованием файла *\_AppStart. cshtml* является установка значений для вспомогательных функций, используемых на сайте и которые должны быть инициализированы. Типичными примерами являются параметры электронной почты для вспомогательного метода `WebMail`, а также закрытый и открытый ключи для вспомогательного метода `ReCaptcha`. В таких случаях значения можно задать один раз в *\_AppStart. cshtml* , а затем они уже заданы для всех страниц на сайте.

В этой процедуре показано, как настроить глобальные параметры `WebMail`. (Дополнительные сведения об использовании вспомогательного метода `WebMail` см. [в разделе Добавление сообщения электронной почты на сайт веб-страницы ASP.NET](../getting-started/11-adding-email-to-your-web-site.md).)

1. Добавьте библиотеку вспомогательных веб-функций ASP.NET на веб-сайт, как описано в разделе [Установка вспомогательных функций на веб-страницы ASP.net сайте](https://go.microsoft.com/fwlink/?LinkId=252372), если вы еще не добавили его.
2. Если у вас еще нет файла *\_AppStart. cshtml* , в корневой папке веб-сайта создайте файл с именем *\_AppStart. cshtml*.
3. Добавьте следующие параметры `WebMail` в файл *\_AppStart. cshtml* : 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample3.cshtml?highlight=2-7)]

    Измените следующие параметры, связанные с электронной почтой, в коде:

   - Присвойте `your-SMTP-host` имя SMTP-сервера, к которому у вас есть доступ.
   - Задайте `your-user-name-here` имя пользователя для учетной записи SMTP-сервера.
   - Задайте `your-account-password` пароль для учетной записи SMTP-сервера.
   - Задайте для `your-email-address-here` собственный адрес электронной почты. Это адрес электронной почты, с которого отправляется сообщение. (Некоторые поставщики электронной почты не позволяют указать другой адрес `From` и будут использовать имя пользователя в качестве адреса `From`.)

     Дополнительные сведения о параметрах SMTP см. в разделе [Настройка параметров электронной почты](https://go.microsoft.com/fwlink/?LinkID=202899#configuring_email_settings) в статье [Отправка сообщения электронной почты с сайта веб-страницы ASP.NET (Razor)](https://go.microsoft.com/fwlink/?LinkID=202899) и [проблемы с отправкой электронной почты](https://go.microsoft.com/fwlink/?LinkId=253001#email) в [руководстве по устранению неполадок веб-страницы ASP.NET (Razor)](https://go.microsoft.com/fwlink/?LinkId=253001).
4. Сохраните файл *\_AppStart. cshtml* и закройте его.
5. В корневой папке веб-сайта создайте новую страницу с именем *тестемаил. cshtml*.
6. Замените имеющееся содержимое следующим: 

     [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample4.cshtml)]
7. Запустите страницу *тестемаил. cshtml* в браузере.
8. Заполните поля, чтобы отправить себе сообщение электронной почты, а затем нажмите кнопку **Отправить**.
9. Проверьте свой адрес электронной почты, чтобы убедиться, что вы получили сообщение.

Важной частью этого примера является то, что параметры, которые обычно не изменяются (например, имя SMTP-сервера и учетные данные электронной почты), задаются в файле *\_AppStart. cshtml* . Таким образом, вам не нужно снова задавать их на каждой странице, где вы отправляете электронную почту. (Хотя по каким-либо причинам необходимо изменить эти параметры, их можно настроить по отдельности на странице.) На странице задаются только значения, которые обычно изменяются каждый раз, как получатель и текст сообщения электронной почты.

<a id="Running_Code_Before_and_After"></a>
## <a name="running-code-before-and-after-files-in-a-folder"></a>Выполнение кода до и после файлов в папке

Так же, как можно использовать *\_AppStart. cshtml* для написания кода перед выполнением страниц на сайте, можно написать код, который будет выполняться до (и после) любой страницы в определенной папке. Это полезно при настройке одной и той же страницы макета для всех страниц в папке или при проверке того, что пользователь вошел в систему перед запуском страницы в папке.

Для страниц в определенных папках можно создать код в файле с именем *\_пажестарт. cshtml*. На следующей схеме показано, как работает страница *\_пажестарт. cshtml* . Когда запрос поступает на страницу, ASP.NET сначала проверяет страницу *\_AppStart. cshtml* и выполняет ее. Затем ASP.NET проверяет, имеется ли страница *\_пажестарт. cshtml* , и, если да, выполняет ее. Затем запускается запрошенная страница.

На странице *\_пажестарт. cshtml* можно указать, где во время обработки необходимо запустить запрашиваемую страницу, включив метод `RunPage`. Это позволяет выполнять код до выполнения запрашиваемой страницы и затем снова после него. Если вы не включаете `RunPage`, выполняется весь код в *\_пажестарт. cshtml* , а затем запрашиваемая страница запускается автоматически.

![[образ]](18-customizing-site-wide-behavior/_static/image3.jpg)

ASP.NET позволяет создать иерархию файлов *\_пажестарт. cshtml* . Файл *\_пажестарт. cshtml* можно разместить в корневом каталоге сайта и во всех вложенных папках. При запросе страницы выполняется *\_файл пажестарт. cshtml* на самом верхнем уровне (ближайший к корню сайта), за которым следует файл *\_пажестарт. cshtml* в следующей вложенной папке и так далее, пока запрос не достигнет папки, содержащей запрошенную страницу. После выполнения всех применимых файлов *\_пажестарт. cshtml* выполняется запрошенная страница.

Например, может иметься следующее сочетание файлов *\_пажестарт. cshtml* и файла *Default. cshtml* :

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample5.cshtml)]

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample6.cshtml)]

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample7.cshtml)]

При запуске */мифолдер/дефаулт.кштмл*вы увидите следующее:

[!code-console[Main](18-customizing-site-wide-behavior/samples/sample8.cmd)]

## <a name="running-initialization-code-for-all-pages-in-a-folder"></a>Выполнение кода инициализации для всех страниц в папке

Хорошим использованием файлов *\_пажестарт. cshtml* является инициализация одной и той же страницы макета для всех файлов в одной папке.

1. В корневой папке создайте новую папку с именем *инитпажес*.
2. В папке *инитпажес* веб-сайта создайте файл с именем *\_пажестарт. cshtml* и замените разметку и код по умолчанию следующим кодом: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample9.cshtml)]
3. В корневом каталоге веб-сайта создайте папку с именем *Shared*.
4. В *общей* папке создайте файл с именем *\_layout1. cshtml* и замените разметку и код по умолчанию следующим кодом: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample10.cshtml)]
5. В папке *инитпажес* создайте файл с именем *Content1. cshtml* и замените имеющееся содержимое следующим: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample11.html)]
6. В папке *инитпажес* создайте другой файл с именем *Content2. cshtml* и замените разметку по умолчанию следующим: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample12.html)]
7. Запустите *Content1. cshtml* в браузере. 

    ![[образ]](18-customizing-site-wide-behavior/_static/image4.jpg)

    При запуске страницы *Content1. cshtml* файл *\_пажестарт. cshtml* задается `Layout` а также задает для `PageData["MyBackground"]` цвет. В *Content1. cshtml*применяются макет и цвет.
8. Отобразить *Content2. cshtml* в браузере. 

    Макет одинаков, так как обе страницы используют одну и ту же страницу и цвет макета, инициализированные в *\_пажестарт. cshtml*.

## <a name="using-_pagestartcshtml-to-handle-errors"></a>Использование \_Пажестарт. cshtml для обработки ошибок

Еще одним хорошим применением файла *\_пажестарт. cshtml* является создание способа для управления ошибками программирования (исключениями), которые могут возникнуть в любой странице. *CSHTML* в папке. В этом примере показан один из способов.

1. В корневой папке создайте папку с именем *иниткатч*.
2. В папке *иниткатч* веб-сайта создайте файл с именем *\_пажестарт. cshtml* и замените существующую разметку и код следующим кодом: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample13.cshtml)]

    В этом коде вы попробуете явно запустить запрошенную страницу, вызвав метод `RunPage` внутри блока `try`. Если на запрошенной странице возникли ошибки программирования, код в блоке `catch` выполняется. В этом случае код перенаправляется на страницу (*Error. cshtml*) и передает имя файла, который вызвал ошибку, в составе URL-адреса. (Вскоре вы создадите страницу.)
3. В папке *иниткатч* веб-сайта создайте файл с именем *Exception. cshtml* и замените существующий код разметки следующим кодом: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample14.cshtml)]

    В этом примере, что вы делаете на этой странице, намеренно создает ошибку, пытаясь открыть несуществующий файл базы данных.
4. В корневой папке создайте файл с именем *Error. cshtml* и замените существующую разметку и код следующим кодом: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample15.html)]

    На этой странице выражение `@Request["source"]` получает значение из URL-адреса и отображает его.
5. На панели инструментов нажмите кнопку **сохранить**.
6. Запустите *Exception. cshtml* в браузере. 

    ![[образ]](18-customizing-site-wide-behavior/_static/image5.jpg)

    Поскольку в *Exception. cshtml*возникает ошибка, страница *\_пажестарт. cshtml* выполняет перенаправление к файлу *Error. cshtml* , который отображает сообщение.

    Дополнительные сведения об исключениях см. в статье [Введение в веб-страницы ASP.NET программирование с помощью синтаксиса Razor](https://go.microsoft.com/fwlink/?LinkID=251587).

<a id="Using__PageStart.cshtml_to_Restrict_Folder_Access"></a>
## <a name="using-_pagestartcshtml-to-restrict-folder-access"></a>Использование \_Пажестарт. cshtml для ограничения доступа к папке

Можно также использовать файл *\_пажестарт. cshtml* для ограничения доступа ко всем файлам в папке.

1. В WebMatrix создайте новый веб-сайт с помощью параметра **сайт из шаблона** .
2. В списке Доступные шаблоны выберите **Начальная сайт**.
3. В корневой папке создайте папку с именем *аусентикатедконтент*.
4. В папке *аусентикатедконтент* создайте файл с именем *\_пажестарт. cshtml* и замените существующую разметку и код следующим кодом: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample16.cshtml)]

    Код начинается с предотвращения кэширования всех файлов в папке. (Это необходимо для таких сценариев, как общедоступные компьютеры, где не нужно, чтобы кэшированные страницы одного пользователя были доступны следующему пользователю.) Затем код определяет, вошел ли пользователь на сайт, прежде чем он сможет просматривать какие-либо страницы в папке. Если пользователь не вошел в систему, код перенаправляется на страницу входа. Страница входа может вернуть пользователя на страницу, которая была первоначально запрошена, если включить значение строки запроса с именем `ReturnUrl`.
5. Создайте новую страницу в папке *аусентикатедконтент* с именем *Page. cshtml*.
6. Замените разметку по умолчанию следующим:  

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample17.cshtml)]
7. Запустите *страницу. cshtml* в браузере. Код перенаправляет вас на страницу входа. Необходимо зарегистрироваться перед входом в систему. После регистрации и входа в систему можно перейти к странице и просмотреть ее содержимое.

<a id="Additional_Resources"></a>
## <a name="additional-resources"></a>Дополнительные ресурсы

[Введение в программирование веб-страницы ASP.NET с помощью синтаксиса Razor](https://go.microsoft.com/fwlink/?LinkID=251587)
