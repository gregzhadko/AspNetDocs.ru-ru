---
uid: web-pages/overview/ui-layouts-and-themes/18-customizing-site-wide-behavior
title: Настройка поведения в масштабах сайта для веб-страниц ASP.NET (Razor) сайтов | Документация Майкрософт
author: Rick-Anderson
description: В этой главе объясняется, как сделать параметры вашего всего веб-сайта или всей папке, а не только к одной странице.
ms.author: riande
ms.date: 02/17/2014
ms.assetid: e158bed7-226f-4275-b02e-7553bd58c669
msc.legacyurl: /web-pages/overview/ui-layouts-and-themes/18-customizing-site-wide-behavior
msc.type: authoredcontent
ms.openlocfilehash: 2763cae0f8124cfcaccfd737622cb17b6dd947e1
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59413299"
---
# <a name="customizing-site-wide-behavior-for-aspnet-web-pages-razor-sites"></a>Настройка поведения сайта для сайтов ASP.NET Web Pages (Razor)

по [Tom FitzMacken](https://github.com/tfitzmac)

> В этой статье объясняется, как сделать параметров на стороне узла для страниц в на веб-сайте ASP.NET Web Pages (Razor).
> 
> Вы узнаете, как:
> 
> - О том, как выполнять код, позволяющий набор значений (глобальные переменные или параметры вспомогательный) для всех страниц узла.
> - Сведения о выполнении кода, который позволяет задавать значения для всех страниц в папке.
> - Как выполнять код до и после того, загружает.
> - Сведения об отправке ошибок на страницу центра ошибки.
> - Как добавить проверку подлинности ко всем страницам в папке.
>   
> 
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемые в этом руководстве
> 
> 
> - Веб-страниц ASP.NET (Razor) 2
> - WebMatrix 3
> - Библиотеку ASP.NET (пакет NuGet)
>   
> 
> Этот учебник также работает с 3 веб-страниц ASP.NET и Visual Studio 2013 (или Visual Studio Express 2013 для Web), за исключением того, вы не может использовать библиотеку ASP.NET.


<a id="Adding_Website_Startup_Code"></a>
## <a name="adding-website-startup-code-for-aspnet-web-pages"></a>Добавление кода запуска веб-сайта для веб-страниц ASP.NET

Для большей части кода, написанный в ASP.NET Web Pages отдельной страницы может содержать весь код, необходимый для этой страницы. Например если страница отправляет сообщение электронной почты, можно поместить весь код для этой операции на одной странице. Это может включать код для инициализации параметров для отправки электронной почты (то есть для SMTP-сервера) и для отправки сообщений электронной почты.

Однако в некоторых ситуациях может потребоваться выполнять определенный код, прежде чем запускать любую страницу на сайте. Это полезно для задания значений, которые могут использоваться в любом месте на сайте (называется *глобальные значения*.) Например некоторые вспомогательные методы требуют предоставления значения, такие как параметры электронной почты или ключи учетной записи. Он может быть удобен для сохранения этих параметров в глобальные значения.

Это можно сделать, создав страницу с именем  *\_AppStart.cshtml* в корень сайта. Если эта страница существует, он выполняется при первом запросе любой страницы на сайте. Таким образом он хорошо подходит для выполнения кода, чтобы задать глобальные значения. (Поскольку  *\_AppStart.cshtml* имеют префикс подчеркивания ASP.NET не будет отправлять страницы в браузер, даже если необходимо отправить запрос напрямую.)

Следующая схема показывает, каким образом  *\_AppStart.cshtml* странице works. При поступлении запроса для страницы, и если это первый запрос для всех страниц на сайте ASP.NET сначала проверяет ли  *\_AppStart.cshtml* страница существует. Если Да, любой код в  *\_AppStart.cshtml* выполняется страница, а затем запускается запрошенной страницы.

![[изображение]](18-customizing-site-wide-behavior/_static/image1.jpg)

## <a name="setting-global-values-for-your-website"></a>Установка глобальных значений для веб-сайта

1. В корневой папке веб-сайта в WebMatrix, создайте файл с именем  *\_AppStart.cshtml*. Файл должен быть в корень сайта.
2. Замените существующее содержимое следующим: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample1.cshtml)]

    Этот код сохраняет значение в `AppState` словаря, который автоматически доступна для всех страниц узла. Обратите внимание, что  *\_AppStart.cshtml* файл не имеет никакой разметки в нем. Страница будет выполнения кода и затем перенаправить на первоначально запрошенную страницу.

    > [!NOTE]
    > Будьте внимательны при помещении кода в  *\_AppStart.cshtml* файла. Если возникли ошибки в коде в  *\_AppStart.cshtml* файл, веб-сайт не запускается.
3. В корневой папке, создать новую страницу с именем *AppName.cshtml*.
4. Замените стандартную разметку и код следующим: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample2.html)]

    Этот код извлекает значение из `AppState` объекта, который задается в  *\_AppStart.cshtml* страницы.
5. Запустите *AppName.cshtml* страницу в браузере. (Убедитесь, что выбран страницы **файлы** рабочей области, прежде чем запускать его.) На странице отображается глобальное значение. 

    ![[изображение]](18-customizing-site-wide-behavior/_static/image2.jpg)

<a id="Setting_Values_For_Helpers"></a>
## <a name="setting-values-for-helpers"></a>Задание значений для вспомогательных функций

Рекомендуется использовать для  *\_AppStart.cshtml* файл является установка значений для вспомогательных функций, которые можно использовать на узле и на которых должны быть инициализированы. Типичными примерами являются параметры электронной почты для `WebMail` вспомогательный метод и открытые и закрытые ключи для `ReCaptcha` вспомогательный. В подобных случаях можно задать значения один раз в  *\_AppStart.cshtml* и затем они уже готово для всех страниц узла.

Эта процедура показывает, как задать `WebMail` параметры глобально. (Дополнительные сведения об использовании `WebMail` вспомогательного приложения, см. в разделе [Добавление электронной почты на сайт веб-страниц ASP.NET](../getting-started/11-adding-email-to-your-web-site.md).)

1. Добавьте библиотеку ASP.NET на веб-сайт, как описано в [Установка вспомогательных функций на сайте веб-страниц ASP.NET](https://go.microsoft.com/fwlink/?LinkId=252372), если не было добавлено.
2. Если у вас нет  *\_AppStart.cshtml* в корневой папке веб-сайта, создайте файл с именем  *\_AppStart.cshtml*.
3. Добавьте следующий `WebMail` параметры  *\_AppStart.cshtml* файла: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample3.cshtml?highlight=2-7)]

    Изменить связанные параметры в коде, электронной почты следующее:

   - Задайте `your-SMTP-host` имя SMTP-сервера, у вас есть доступ к.
   - Задайте `your-user-name-here` имени пользователя для учетной записи сервера SMTP.
   - Задайте `your-account-password` на пароль для учетной записи сервера SMTP.
   - Задайте `your-email-address-here` на адрес электронной почты. Это адрес электронной почты, которые отправляются сообщения. (Некоторые поставщики электронной почты не позволяют задать другой `From` адресов и будет использовать имя пользователя как `From` адрес.)

     Дополнительные сведения о параметрах SMTP см. в разделе [Настройка параметров электронной почты](https://go.microsoft.com/fwlink/?LinkID=202899#configuring_email_settings) в этой статье [отправки электронной почты из веб-узла ASP.NET Web Pages (Razor)](https://go.microsoft.com/fwlink/?LinkID=202899) и [проблемы с отправкой электронной почты](https://go.microsoft.com/fwlink/?LinkId=253001#email)в [веб-страницы ASP.NET (Razor) устранение неполадок](https://go.microsoft.com/fwlink/?LinkId=253001).
4. Сохранить  *\_AppStart.cshtml* файл и закройте его.
5. В корневой папке веб-сайта, создайте новую страницу с именем *TestEmail.cshtml*.
6. Замените существующее содержимое следующим: 

     [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample4.cshtml)]
7. Запустите *TestEmail.cshtml* страницу в браузере.
8. Заполните поля для отправки себе сообщения электронной почты и нажмите кнопку **отправки**.
9. Проверьте свой адрес электронной почты, чтобы убедиться в том, что вы получили сообщение.

Важной частью в этом примере является то, что параметры, которые не изменяются обычно — имя SMTP-сервера и учетные данные электронной почты, например, задаются в  *\_AppStart.cshtml* файла. Таким образом, не нужно задавать их повторно, на каждой странице, куда отправлять по электронной почте. (Несмотря на то, что если для какой-либо причине необходимо изменить эти параметры, можно задать их отдельно на странице.) На странице можно задавать только значения, которые обычно изменяется каждый раз, как и получателя и тело сообщения электронной почты.

<a id="Running_Code_Before_and_After"></a>
## <a name="running-code-before-and-after-files-in-a-folder"></a>Выполнение кода до и после файлов в папке

Так же, как можно использовать  *\_AppStart.cshtml* для написания кода, прежде чем запустить страниц веб-узла, можно написать код, выполняемый до (и после) любой страницы в определенной папке запуска. Это полезно для таких вещей, как и при установке же макет страницы для всех страниц в папке, или для проверки, пользователь вошел перед запуском страницы в папке.

Для страниц, в частности папки, можно создать код в файл с именем  *\_PageStart.cshtml*. Следующая схема показывает, каким образом  *\_PageStart.cshtml* странице works. При поступлении запроса для страницы, ASP.NET сначала проверяет наличие  *\_AppStart.cshtml* странице и которое выполняется. ASP.NET проверяет, существует ли  *\_PageStart.cshtml* странице, и если да, выполняется. Затем он выполняет запрошенную страницу.

Внутри  *\_PageStart.cshtml* страницы, можно указать, где во время обработки требуется для запуска, включая запрошенную страницу `RunPage` метод. Это позволяет выполнять код перед выполнением запрошенной страницы и затем снова после него. Если вы не включаете `RunPage`, весь код в  *\_PageStart.cshtml* запусков, а затем запрошенной страницы выполняется автоматически.

![[изображение]](18-customizing-site-wide-behavior/_static/image3.jpg)

ASP.NET позволяет создать иерархию  *\_PageStart.cshtml* файлов. Вы можете поместить  *\_PageStart.cshtml* файл в корневом каталоге сайта и в любую вложенную папку. При запросе страницы  *\_PageStart.cshtml* файл запуски самого верхнего уровня (ближайший к корню сайта), за которым следует  *\_PageStart.cshtml* файла в течение Вложенная папка, и т. д вниз по структуре вложенную папку, пока не достигнет запрос в папку, содержащую запрошенной страницы. После всех применимых  *\_PageStart.cshtml* запуска файлов, выполняет запрошенную страницу.

Например, может иметь следующее сочетание  *\_PageStart.cshtml* файлы и *Default.cshtml* файла:

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample5.cshtml)]

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample6.cshtml)]

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample7.cshtml)]

При запуске */myfolder/default.cshtml*, вы увидите следующее:

[!code-console[Main](18-customizing-site-wide-behavior/samples/sample8.cmd)]

## <a name="running-initialization-code-for-all-pages-in-a-folder"></a>Выполнение кода инициализации для всех страниц в папке

Рекомендуется использовать для  *\_PageStart.cshtml* файлов состоит в инициализации той же странице макета для всех файлов в одной папке.

1. В корневой папке, создайте новую папку с именем *InitPages*.
2. В *InitPages* папку веб-сайта, создайте файл с именем  *\_PageStart.cshtml* и замените стандартную разметку и код на следующий: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample9.cshtml)]
3. В корне веб-сайта, создайте папку с именем *Shared*.
4. В *Shared* папке создайте файл с именем  *\_Layout1.cshtml* и замените стандартную разметку и код на следующий: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample10.cshtml)]
5. В *InitPages* папке создайте файл с именем *Content1.cshtml* и замените существующее содержимое на следующее: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample11.html)]
6. В *InitPages* папке создайте еще один файл с именем *Content2.cshtml* и замените разметки по умолчанию на следующий: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample12.html)]
7. Запустите *Content1.cshtml* в браузере. 

    ![[изображение]](18-customizing-site-wide-behavior/_static/image4.jpg)

    Когда *Content1.cshtml* выполняется, страница  *\_PageStart.cshtml* файле задает `Layout` , а также задается `PageData["MyBackground"]` цвет. В *Content1.cshtml*, применения макета и цвет.
8. Отображение *Content2.cshtml* в браузере. 

    Макет остается неизменным, так как обе страницы используют те же макет страницы и цвет, как инициализировать в  *\_PageStart.cshtml*.

## <a name="using-pagestartcshtml-to-handle-errors"></a>С помощью \_PageStart.cshtml для обработки ошибок

Использовать другой good  *\_PageStart.cshtml* файл — создать способ обработки ошибок программирования (исключения), которые могут возникнуть в любом *.cshtml* страницу в папке. В этом примере показан один из способов сделать это.

1. В корневой папке создайте папку с именем *InitCatch*.
2. В *InitCatch* папку веб-сайта, создайте файл с именем  *\_PageStart.cshtml* и замените существующую разметку и код на следующий: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample13.cshtml)]

    В этом коде повторите запуск запрошенной страницы явным образом с помощью вызова `RunPage` метод внутри `try` блока. В случае программирования ошибок в запрошенной странице, код внутри `catch` блоке. В этом случае код выполняет перенаправление на страницу (*Error.cshtml*) и передает имя файла, в которых ошибки как часть URL-адрес. (Вы создадите страницу чуть позже.)
3. В *InitCatch* папку веб-сайта, создайте файл с именем *Exception.cshtml* и замените существующую разметку и код на следующий: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample14.cshtml)]

    Для целей этого примера выполняемых на этой странице намеренно создает ошибку при попытке открыть файл базы данных, который не существует.
4. В корневой папке создайте файл с именем *Error.cshtml* и замените существующую разметку и код на следующий: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample15.html)]

    На этой странице, выражение `@Request["source"]` возвращает значение из URL-адрес и отображает его.
5. На панели инструментов нажмите кнопку **Сохранить**.
6. Запустите *Exception.cshtml* в браузере. 

    ![[изображение]](18-customizing-site-wide-behavior/_static/image5.jpg)

    Так как произошла ошибка в *Exception.cshtml*,  *\_PageStart.cshtml* страница перенаправляет на *Error.cshtml* файл, который выводит сообщение.

    Дополнительные сведения об исключениях см. в разделе [введение в ASP.NET веб-страниц программирование с использованием синтаксиса Razor](https://go.microsoft.com/fwlink/?LinkID=251587).

<a id="Using__PageStart.cshtml_to_Restrict_Folder_Access"></a>
## <a name="using-pagestartcshtml-to-restrict-folder-access"></a>С помощью \_PageStart.cshtml, чтобы ограничить доступ к папкам

Можно также использовать  *\_PageStart.cshtml* файл, чтобы ограничить доступ ко всем файлам в папке.

1. В WebMatrix, создайте новый веб-сайт с помощью **Site From Template** параметр.
2. Из доступных шаблонов, выберите **начального сайта**.
3. В корневой папке создайте папку с именем *AuthenticatedContent*.
4. В *AuthenticatedContent* папке создайте файл с именем  *\_PageStart.cshtml* и замените существующую разметку и код на следующий: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample16.cshtml)]

    Код начинается, предотвращая все файлы в папке кэширования. (Это необходимо для таких сценариев, как общедоступные компьютеры, где вы не хотите один пользователь кэшированных страниц доступными для следующего пользователя.) Затем код определяет ли пользователь вошел в узле прежде, чем они могут просматривать любой из страниц в папке. Если пользователь не выполнил вход, код выполняет перенаправление на страницу входа. На страницу входа может возвращать пользователя к странице, первоначально запрошенную при включении значения строки запроса с именем `ReturnUrl`.
5. Создать новую страницу в *AuthenticatedContent* папку с именем *Page.cshtml*.
6. Замените разметки по умолчанию следующим:  

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample17.cshtml)]
7. Запустите *Page.cshtml* в браузере. Код выполняет перенаправление на страницу входа. Необходимо зарегистрировать, прежде чем войти в. После регистрации и входа, можно перейти на страницу и просмотреть его содержимое.

<a id="Additional_Resources"></a>
## <a name="additional-resources"></a>Дополнительные ресурсы

[Введение в программирование с использованием синтаксиса Razor веб-страниц ASP.NET](https://go.microsoft.com/fwlink/?LinkID=251587)
