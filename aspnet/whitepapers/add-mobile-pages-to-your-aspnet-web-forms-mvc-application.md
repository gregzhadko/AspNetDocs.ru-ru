---
uid: whitepapers/add-mobile-pages-to-your-aspnet-web-forms-mvc-application
title: Как добавить мобильные страницы в веб-формы ASP.NET или приложение MVC | Документация Майкрософт
author: rick-anderson
description: В этом разделе описываются различные способы обслуживания страниц, оптимизированных для мобильных устройств, из веб-форм ASP.NET и приложения MVC и предлагаются архитектурные и...
ms.author: riande
ms.date: 01/20/2011
ms.assetid: 3124f28e-cc32-418a-afe3-519fa56f4c36
msc.legacyurl: /whitepapers/add-mobile-pages-to-your-aspnet-web-forms-mvc-application
msc.type: content
ms.openlocfilehash: 63c555358d06a9506bb5c8c993800c3307108192
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78462216"
---
# <a name="how-to-add-mobile-pages-to-your-aspnet-web-forms--mvc-application"></a>Как добавить мобильные страницы в веб-формы ASP.NET или приложение MVC

> **Применимо к**
> 
> - Веб-формы ASP.NET версии 4,0
> - ASP.NET MVC версии 3,0
> 
> **Сводка**
> 
> В этом разделе описываются различные способы обслуживания страниц, оптимизированных для мобильных устройств, из веб-форм ASP.NET и приложения MVC, а затем рассматриваются вопросы архитектуры и проектирования, которые следует учитывать при нацеливании на широкий спектр устройств. В этом документе также объясняется, почему ASP.NET мобильные элементы управления от ASP.NET 2,0 до 3,5 теперь устарели и обсуждаются некоторые современные альтернативы.

## <a name="contents"></a>Содержимое

- Обзор
- Параметры архитектуры
- Обнаружение браузеров и устройств
- Как приложения веб-форм ASP.NET могут представлять страницы для мобильных устройств
- Как приложения ASP.NET MVC могут представлять страницы для мобильных устройств
- Дополнительные ресурсы

Примеры кода для загрузки, демонстрирующие методы ASP.NET Web Forms и MVC, см. в статье [мобильные приложения & сайтах с ASP.NET](https://docs.microsoft.com/aspnet/mobile/overview).

## <a name="overview"></a>Обзор

Мобильные устройства — смартфоны, телефоны функций и планшеты — продолжают расти популярность как средства для доступа в Интернет. Для многих веб-разработчиков и веб-компаний это означает, что все больше важно обеспечить удобную работу с посетителями для посетителей, использующих эти устройства.

### <a name="how-earlier-versions-of-aspnet-supported-mobile-browsers"></a>Как ранние версии ASP.NET поддерживали мобильные браузеры

ASP.NET версии 2,0 – 3,5 включали *ASP.NET мобильные элементы управления*: набор серверных элементов управления для мобильных устройств в сборке *System. Web. Mobile. dll* и пространство имен *System. Web. UI. мобилеконтролс* . Сборка по-прежнему включается в ASP.NET 4, но не рекомендуется. Разработчикам рекомендуется перейти на более современные подходы, например, описанные в этом документе.

Причина, по которой ASP.NET мобильные элементы управления помечена как устаревшая, заключается в том, что их дизайн ориентирован на мобильные телефоны, которые были общими около 2005 и более ранних версий. Элементы управления в основном предназначены для отображения разметки WML или cHTML (вместо обычного HTML) для браузеров WAP этой эры. Но WAP, WML и cHTML больше не важны для большинства проектов, поскольку HTML теперь стал повсеместным языком разметки для мобильных и настольных браузеров.

### <a name="the-challenges-of-supporting-mobile-devices-today"></a>Проблемы, связанные с поддержкой мобильных устройств сегодня

Несмотря на то, что мобильные браузеры в настоящее время поддерживают HTML, вы по-прежнему сталкиваетесь с множеством проблем, когда надежде для создания привлекательных возможностей мобильного обзора:

- ***Размер экрана*** — мобильные устройства значительно отличаются в форме, и их экраны зачастую намного меньше, чем мониторы настольных систем. Поэтому для них может потребоваться разработать совершенно разные макеты страниц.
- ***Методы ввода*** — на некоторых устройствах есть клавиатуры, некоторые из которых имеют свои планшеты, другие используют сенсорный ввод. Может потребоваться рассмотреть несколько механизмов навигации и методов ввода данных.
- ***Соответствие стандартам*** — многие мобильные браузеры не поддерживают новейшие стандарты HTML, CSS или JavaScript.
- ***Пропускная способность*** — производительность сети сотовой связи меняется, а некоторые конечные пользователи — в тариффс, которые взимается по мегабайтам.

Такого решения нет ни для одного размера. приложение будет работать по-разному в соответствии с устройством, осуществляющим доступ к нему. В зависимости от того, какой уровень мобильной поддержки вам нужен, это может быть более сложной задачей для веб-разработчиков, чем настольная «Browser Звездные».

Разработчики, приближающиеся к поддержке мобильных браузеров в первый раз, часто считают, что это только важно для поддержки новейших и более сложных смартфонов (например, Windows Phone 7, iPhone или Android), возможно, из-за того, что разработчики часто владеют такими устройствах. Однако более низкие телефоны по-прежнему являются чрезвычайно популярными, и их владельцы используют их для просмотра Интернета, особенно в тех странах, где мобильные телефоны проще, чем высокоскоростное подключение. Вашему бизнесу необходимо решить, какой диапазон устройств следует поддерживать, с учетом наиболее вероятных клиентов. Если вы создаете Интернет-буклет для проверки работоспособности люкс, вы можете принимать решение только для опытных смартфонов, а если вы создаете систему резервирования билетов для рекламы в кинотеатрах, вам, скорее всего, придется учитывать посетителей с менее мощными функциями. звонят.

## <a name="architectural-options"></a>Параметры архитектуры

Прежде чем перейти к конкретным техническим деталям веб-форм ASP.NET или MVC, обратите внимание, что веб-разработчики в целом имеют три основных возможных варианта поддержки мобильных браузеров:

1. ***Ничего не делать —*** Вы можете просто создать стандартное веб-приложение, ориентированное на настольное устройство, и использовать мобильные браузеры для его приемлемого отображения. 

    - **Преимущество**: это самый дешевый вариант для реализации и обслуживания – не дополнительная работа
    - **Недостаток**: обеспечивает наихудшие возможности для конечных пользователей: 

        - Последние смартфоны могут визуализировать код HTML так же, как и браузер настольных систем, но для использования содержимого на маленьком экране пользователи по-прежнему будут вынуждены изменять масштаб и прокручивать горизонтально и вертикально. Это далеко не оптимально.
        - Более старые устройства и телефоны функций могут не иметь удовлетворительной визуализации разметки.
        - Даже на последних планшетных устройствах (экраны которых могут быть как экраны ноутбуков), применяются различные правила взаимодействия. Ввод на основе сенсорного ввода лучше всего подходит для более масштабных кнопок и ссылок, и в этом случае не удается навести курсор мыши на всплывающее меню.
2. ***Решение проблемы на клиенте* —** с помощью тщательного использования CSS и [последовательного расширения](http://en.wikipedia.org/wiki/Progressive_enhancement) можно создавать разметку, стили и сценарии, которые адаптируются к любому браузеру. Например, при использовании [запросов мультимедиа CSS 3](http://www.w3.org/TR/2010/CR-css3-mediaqueries-20100727/)можно создать макет с несколькими столбцами, который преобразуется в один столбец на устройствах, экраны которых будут узким, чем выбранное пороговое значение. 

    - **Преимущество**: оптимизирует отрисовку для конкретного используемого устройства, даже для неизвестных будущих устройств в зависимости от того, какие характеристики экрана и входных данных они имеют.
    - **Преимущество**. простое позволяет совместно использовать логику на стороне сервера для всех типов устройств — минимальное дублирование кода или усилий
    - **Недостаток**: мобильные устройства так отличаются от настольных устройств, на которых вы действительно хотите, чтобы мобильные страницы полностью отличались от страниц настольных ПК, отображая разные сведения. Такие вариации могут быть неэффективными или невозможными для обеспечения надежности только с помощью CSS, особенно учитывая, как несогласованные старые устройства преобразуют правила CSS. Это особенно справедливо для атрибутов CSS 3.
    - **Недостаток**: не поддерживает различные серверные логики и рабочие процессы для различных устройств. Вы не можете, например, реализовать упрощенный рабочий процесс извлечения корзины для мобильных пользователей с помощью только CSS.
    - **Недостаток**: использование неэффективного пропускной способности. Возможно, сервер должен передать разметку и стили, которые применяются ко всем возможным устройствам, даже если целевое устройство будет использовать только подмножество этих сведений.
3. ***Устраните проблему на сервере* —** Если сервер знает, какое устройство обращается к нему, или по крайней мере характеристики этого устройства, такие как размер экрана и метод ввода, а также является ли оно мобильным устройством, оно может запускать другую логику и выводить другую разметку HTML. 

    - **Преимущества:** Максимальная гибкость. Не существует ограничений на то, сколько можно изменить логику на стороне сервера для мобильных устройств, или оптимизировать разметку для нужной структуры конкретного устройства.
    - **Преимущества:** Эффективное использование пропускной способности. Необходимо передать только сведения о разметке и стилизации, которые будет использовать целевое устройство.
    - **Недостаток:** Иногда выполняет принудительное повторение усилий или кода (например, создание похожих, но слегка отличающихся копий страниц веб-форм или представлений MVC). Там, где это возможно, вы выберете общую логику в базовый слой или службу, но все же может потребоваться дублировать некоторые части кода пользовательского интерфейса или разметки, а затем поддерживаться параллельно.
    - **Недостаток:** Обнаружение устройств не является тривиальным. Для этого требуется список или база данных известных типов устройств и их характеристики (которые могут не всегда быть актуальными) и не гарантировано точно соответствуют всем входящим запросам. В этом документе описаны некоторые параметры и их ошибки.

Чтобы получить лучшие результаты, большинство разработчиков найдут, что им нужно объединить параметры (2) и (3). Небольшие стилистические различия лучше всего подходят для клиента с помощью CSS или даже JavaScript, тогда как основные различия в данных, рабочем процессе или разметке наиболее эффективно реализуются в коде на стороне сервера.

### <a name="this-paper-focuses-on-server-side-techniques"></a>Эта статья посвящена методам на стороне сервера

Так как веб-формы ASP.NET и MVC являются главными серверными технологиями, в этом техническом документе основное внимание уделяется методам на стороне сервера, которые позволяют создавать различные разметки и логику для мобильных браузеров. Разумеется, это можно также сочетать с любой методикой на стороне клиента (например, запросы к носителю CSS 3, последовательное улучшение кода JavaScript), но это не так важно, как веб-проект, а не ASP.NETная разработка.

## <a name="browser-and-device-detection"></a>Обнаружение браузеров и устройств

Ключевым условием для всех серверных методов для поддержки мобильных устройств является знание того, какое устройство использует посетитель. На самом деле, даже лучше, чем знать изготовителя и номер модели этого устройства, вы узнаете о *характеристиках* устройства. Характеристики могут включать:

- Это мобильное устройство?
- Метод ввода (мышь/клавиатура, касание, клавиатура, джойстик,...)
- Размер экрана (физически и в пикселях)
- Поддерживаемые носители и форматы данных
- Прочее

Лучше принимать решения на основе характеристик, превышающих номер модели, так как тогда вы будете лучше поддерживать будущие устройства.

### <a name="using-aspnets-built-in-browser-detection-support"></a>Использование ASP. Встроенная поддержка обнаружения в браузере NET

Веб-формы ASP.NET и разработчики MVC могут немедленно обнаружить важные характеристики посещаемого браузера, изучив свойства объекта *request. browser* . Например, см.

- Request. browser. Исмобиледевице
- Request. browser. Мобиледевицемануфактурер, Request. browser. Мобиледевицемодел
- Request. browser. Скринпикселсвидс
- Request. browser. Суппортсксмлхттп
- ...и многие другие

В фоновом режиме платформа ASP.NET сопоставляет заголовок HTTP входящего *агента пользователя* (UA) с регулярными выражениями в наборе XML-файлов определения браузера. По умолчанию платформа включает определения для многих распространенных мобильных устройств, и вы можете добавить пользовательские файлы определения браузера для других пользователей, которые вы хотите распознать. Дополнительные сведения см. в разделе [веб-серверные элементы управления и возможности браузера](https://msdn.microsoft.com/library/x3k2ssx2.aspx)на странице MSDN Page ASP.NET.

### <a name="using-the-wurfl-device-database-via-51degreesmobi-foundation"></a>Использование базы данных устройств WURFL с помощью 51Degrees.mobi Foundation

Хотя ASP. Встроенная поддержка обнаружения в браузере NET будет достаточной для многих приложений, но в некоторых случаях может быть недостаточно.

- Необходимо ***распознать последние устройства***(без создания файлов определения браузера для них вручную). Обратите внимание, что файлы определения браузера .NET 4 неактуальны для распознавания Windows Phone 7, телефонов Android, мобильных браузеров Opera или Apple iPad.
- ***Требуются более подробные сведения о***возможностях устройств. Может потребоваться узнать о методе ввода устройства (например, о сенсорной клавиатуре VS) или о том, какие форматы звука поддерживает браузер. Эта информация недоступна в стандартных файлах определения браузера.

Проект [ *беспроводного файла универсальных ресурсов* (WURFL)](http://wurfl.sourceforge.net/) поддерживает гораздо более актуальную и подробную информацию о мобильных устройствах, используемых сегодня.

Отличная новость для разработчиков .NET заключается в том, что ASP. Функция обнаружения обозревателя NET является расширяемой, поэтому ее можно усовершенствовать, чтобы преодолеть эти проблемы. Например, можно добавить в проект библиотеку [*51Degrees.mobi Foundation*](https://github.com/51Degrees/dotNET-Device-Detection) с открытым кодом. Это ASP.NET интерфейс IHttpModule или поставщик возможностей браузера (который можно использовать как в веб-формах, так и в приложениях MVC), который напрямую считывает данные WURFL и привязывает их к ASP. Встроенный механизм обнаружения в браузере NET. После установки модуля *запрос. браузер* внезапно будет содержать гораздо более точную и подробную информацию: он будет правильно распознать многие из упомянутых ранее устройств и составить список их возможностей (включая дополнительные возможности, такие как метод ввода). Дополнительные сведения см. в документации по проекту.

## <a name="how-web-forms-applications-can-present-mobile-specific-pages"></a>Как приложения Web Forms могут представлять страницы для мобильных устройств

По умолчанию здесь показано, как новое приложение Web Forms отображается на общих мобильных устройствах:

![](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/_static/image1.png)

Очевидно, что ни одна из макетов не выглядит очень удобной для мобильных устройств. Эта страница предназначена для крупных, альбомных, ориентированных на страницы мониторов, а не для небольших дисплеев. Итак, что же можно сделать?

Как обсуждалось ранее в этом документе, существует множество способов адаптации страниц к мобильным устройствам. Некоторые методы основаны на сервере, другие работают на клиенте.

### <a name="creating-a-mobile-specific-master-page"></a>Создание главной страницы для мобильных устройств

В зависимости от требований вы можете использовать одни и те же веб-формы для всех посетителей, но две отдельные главные страницы: одна для посетителей настольных систем, другая для посетителей мобильных устройств. Это обеспечивает гибкость изменения таблицы стилей CSS или разметки HTML верхнего уровня в соответствии с мобильными устройствами, не требуя дублирования какой-либо логики страницы.

Это легко сделать. Например, можно добавить обработчик инициализации, такой как следующий, в веб-форму:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample1.cs)]

Теперь создайте главную страницу с именем Mobile. master в папке верхнего уровня приложения и будет использоваться при обнаружении мобильного устройства. При необходимости Главная страница мобильной связи может ссылаться на таблицу стилей CSS, относящуюся к мобильному приложению. Посетители рабочего стола будут по-прежнему видеть главную страницу по умолчанию, а не мобильную.

### <a name="creating-independent-mobile-specific-web-forms"></a>Создание независимых веб-форм для мобильных устройств

Для максимальной гибкости можно не только иметь отдельные главные страницы для различных типов устройств. Можно реализовать два *совершенно отдельных набора страниц Web Forms* — один набор для браузеров настольных систем, другой набор для мобильных устройств. Это работает наилучшим образом, если вы хотите предоставить очень разные сведения или рабочие процессы мобильным посетителям. В оставшейся части этого раздела подробно описывается этот подход.

Если у вас уже есть приложение Web Forms, предназначенное для браузеров для настольных систем, проще всего создать вложенную папку с именем "Mobile" в проекте и создать на ней мобильные страницы. Вы можете создать весь дочерний сайт со своими собственными главными страницами, таблицами стилей и страницами, используя те же методы, что и для любого другого приложения веб-форм. Вам не обязательно создавать эквиваленты для мобильных устройств для *каждой* страницы на рабочем столе; можно выбрать, какое подмножество функций имеет смысл для посетителей мобильных устройств.

При желании ваши мобильные страницы могут совместно использовать общие статические ресурсы (например, изображения, JavaScript или файлы CSS) с обычными страницами. Так как папка "Mobile" *не* будет помечена как отдельное приложение при размещении в службах IIS (это просто обычная вложенная папка страниц веб-форм), она также будет использовать ту же конфигурацию, данные сеанса и другую инфраструктуру как страницы рабочего стола.

> [!NOTE]
> Так как этот подход обычно включает в себя некоторое дублирование кода (мобильные страницы, скорее всего, могут поделиться с страницами рабочего стола), важно разложить любую общую бизнес-логику или код доступа к данным в общий нижележащий слой или службу. В противном случае Вы удваиваете усилия по созданию и обслуживанию приложения.

#### <a name="redirecting-mobile-visitors-to-your-mobile-pages"></a>Перенаправление посетителей мобильных устройств на мобильные страницы

Часто бывает удобно перенаправить посетителей мобильных устройств на мобильные страницы только при *первом* запросе в сеансе обзора (а не при каждом запросе в сеансе), поскольку:

- После этого можно легко разрешить посетителям мобильных устройств доступ к страницам рабочего стола, если это нужно, просто поместив ссылку на главную страницу, которая переходит на версию Desktop. Посетитель не будет перенаправлен обратно на мобильную страницу, так как он больше не является первым запросом в своем сеансе.
- Это позволяет избежать риска противоречить запросам для любых динамических ресурсов, совместно используемых настольными и мобильными частями вашего сайта (например, при наличии общей веб-формы, которая настольной и мобильной части отображаются в IFRAME или определенных обработчиках AJAX).

Для этого можно поместить логику перенаправления в **сеанс\_метод Start** . Например, добавьте следующий метод в файл Global.asax.cs:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample2.cs)]

#### <a name="configuring-forms-authentication-to-respect-your-mobile-pages"></a>Настройка проверки подлинности с помощью форм для соблюдения мобильных страниц

Обратите внимание, что проверка подлинности с помощью форм дает определенные предположения о том, где можно перенаправлять посетителей во время и после процесса проверки подлинности

- Когда пользователь должен пройти проверку подлинности, аутентификация с помощью форм перенаправит их на страницу входа на Рабочий стол, независимо от того, является ли он настольным или мобильным пользователем (так как у него есть только *один* URL-адрес для входа). Если вы хотите изменить стиль страницы входа в систему по-разному, необходимо улучшить страницу входа на Рабочий стол, чтобы она перенаправляла мобильные пользователи на отдельную мобильную страницу входа. Например, добавьте следующий код на страницу с кодом программной части для входа на **Рабочий стол** : 

    [!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample3.cs)]
- После успешного входа пользователя в систему проверка подлинности на формах будет по умолчанию перенаправлены на домашнюю страницу рабочего стола (так как в ней имеется только *одна* страница по умолчанию). Необходимо расширить мобильную страницу входа, чтобы она перенаправлялась на домашнюю страницу мобильного устройства после успешного входа. Например, добавьте следующий код на страницу с кодом программной части для **мобильного** входа: 

    [!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample4.cs)]
  
  В этом коде предполагается, что на странице есть серверный элемент управления Login с именем Логинусер, как в шаблоне проекта по умолчанию.

### <a name="working-with-output-caching"></a>Работа с кэшированием выходных данных

Если вы используете кэширование вывода, учтите, что по умолчанию пользователь настольной системы может посетить определенный URL-адрес (в результате чего его выходные данные будут кэшироваться), а затем — мобильный пользователь, который получит кэшированные выходные данные рабочего стола. Это предупреждение относится к тому, что вы просто изменяли главную страницу по типу устройства или реализуете совершенно отдельные веб-формы для каждого типа устройства.

Чтобы избежать этой проблемы, можно указать ASP.NET изменять запись кэша в зависимости от того, использует ли посетитель мобильное устройство. Добавьте параметр VaryByCustom в объявление OutputCache страницы следующим образом:

[!code-aspx[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample5.aspx)]

Затем определите *исмобиледевице* в качестве настраиваемого параметра кэша, добавив следующее переопределение метода в файл Global.asax.cs:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample6.cs)]

Это обеспечит, чтобы посетители мобильных устройств не получали данные, ранее помещаемые в кэш посетителем рабочего стола.

### <a name="a-working-example"></a>Рабочий пример

Чтобы увидеть эти методы в действии, скачайте [примеры кода для этого технического документа](https://docs.microsoft.com/aspnet/mobile/overview). Пример приложения веб-форм автоматически перенаправляет пользователей мобильных устройств на набор страниц для мобильных устройств, находящийся в подпапке Mobile. Разметка и стили этих страниц лучше оптимизированы для мобильных браузеров, как видно на следующих снимках экрана:

![](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/_static/image2.png)

Дополнительные советы по оптимизации разметки и CSS для мобильных браузеров см. в подразделе «стилизация мобильных страниц для мобильных браузеров» далее в этом документе.

## <a name="how-aspnet-mvc-applications-can-present-mobile-specific-pages"></a>Как приложения ASP.NET MVC могут представлять страницы для мобильных устройств

Поскольку шаблон "модель-представление-контроллер" разделяет логику приложения (в контроллерах) от логики представления (в представлениях), можно выбрать любой из следующих подходов к обработке мобильной поддержки в коде на стороне сервера:

1. ***использовать одни и те же контроллеры и представления для настольных и мобильных браузеров, но отображать представления с разными макетами Razor в зависимости от типа устройства *.** Этот вариант лучше всего подходит, если на всех устройствах отображаются идентичные данные, но просто требуется предоставить разные таблицы стилей CSS или изменить несколько элементов HTML верхнего уровня для мобильных устройств.
2. ***Используйте одни и те же контроллеры для настольных и мобильных браузеров, но выводите различные представления в зависимости от типа устройства***. Этот вариант работает лучше, если вы видите примерно те же данные и предоставляете те же рабочие процессы для конечных пользователей, но хотите, чтобы в соответствии с используемым устройством отображалась совершенно другая разметка HTML.
3. ***создавать отдельные области для браузеров для настольных и мобильных устройств, реализовывать независимые контроллеры и представления для каждого *.** Этот вариант работает наилучшим образом, если отображаются очень разные экраны, содержащие различные сведения и ведущие пользователя через различные процессы, оптимизированные для их типа устройств. Это может означать некоторое повторение кода, но его можно уменьшить, выполнив разложение общей логики в нижележащий слой или службу.

Если вы хотите использовать **первый** вариант и изменить только макет Razor для каждого типа устройства, это очень просто. Просто измените файл \_Виевстарт. cshtml следующим образом:

[!code-cshtml[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample7.cshtml)]

Теперь можно создать макет для мобильных устройств, именуемый \_Лайаутмобиле. cshtml со структурой страницы и правилами CSS, оптимизированными для мобильных устройств.

Если вы хотите, чтобы **второй** параметр отображался совершенно по-разному в соответствии с типом устройства посетителя, см. [запись блога Скотта Hanselman](http://www.hanselman.com/blog/ABetterASPNETMVCMobileDeviceCapabilitiesViewEngine.aspx).

Оставшаяся часть статьи посвящена **третьему** варианту: создание отдельных контроллеров *и* представлений для мобильных устройств. Таким образом, вы можете контролировать, какое именно подмножество функций предлагается для мобильных посетителей.

### <a name="setting-up-a-mobile-area-within-your-aspnet-mvc-application"></a>Настройка мобильной области в приложении ASP.NET MVC

Можно добавить область с именем "Mobile" в существующее приложение ASP.NET MVC обычным образом: щелкните правой кнопкой мыши имя проекта в обозреватель решений, а затем выберите Добавить продажам область. Затем можно добавить контроллеры и представления, как и для любой другой области в приложении ASP.NET MVC. Например, добавьте в мобильную область новый контроллер с именем HomeController, который будет использоваться в качестве домашней страницы для посетителей мобильных устройств.

### <a name="ensuring-the-url-mobile-reaches-the-mobile-homepage"></a>Обеспечение того, что URL-адрес/Мобиле достиг домашней страницы мобильного устройства

Если вы хотите, чтобы URL-адрес/Мобиле к действию индекса в HomeController в вашей мобильной области, необходимо внести два небольших изменения в конфигурацию маршрутизации. Сначала обновите класс Мобилеареарегистратион, чтобы HomeController был контроллером по умолчанию в вашей мобильной области, как показано в следующем коде:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample8.cs)]

Это означает, что домашняя страница мобильного устройства теперь находится по адресу/Мобиле, а не/Мобиле/Хоме, так как "Home" теперь является неявным именем контроллера по умолчанию для мобильных страниц.

Обратите внимание, что, добавив второй HomeController в приложение (т. е. мобильное устройство, в дополнение к существующему рабочему столу), вы перейдете к обычной домашней странице рабочего стола. Она завершится ошибкой "*обнаружено несколько типов, соответствующих контроллеру с именем" Home "* . Чтобы устранить эту проблему, обновите конфигурацию маршрутизации верхнего уровня (в Global.asax.cs), чтобы указать, что рабочий стол HomeController должен иметь приоритет при неоднозначности:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample9.cs)]

Теперь произойдет ошибка, и URL-адрес http:\/\/*йоурсите*/будет достигать домашней страницы рабочего стола, а http:\/\/*йоурсите*/Мобиле/будет достигать домашней страницы мобильного устройства.

### <a name="redirecting-mobile-visitors-to-your-mobile-area"></a>Перенаправление посетителей мобильных устройств в мобильную область

В ASP.NET MVC существует множество различных точек расширения, поэтому существует множество способов вставки логики перенаправления. Один из вариантов — создать атрибут фильтра [Редиректмобиледевицестомобилеареа], который выполняет перенаправление при соблюдении следующих условий.

1. Это первый запрос в сеансе пользователя (т. е. Session. Исневсессион имеет значение true)
2. Запрос поступает из браузера мобильного устройства (т. е. Request. browser. Исмобиледевице имеет значение true)
3. Пользователь еще не запросил ресурс в мобильной области (т. е. часть *пути* URL-адреса не начинается с/Мобиле).

Загружаемый пример, прилагаемый к этому техническом документу, включает реализацию этой логики. Он реализуется как фильтр авторизации, производный от AuthorizeAttribute. Это означает, что он может работать правильно даже при использовании кэширования вывода (в противном случае, если посетитель настольного приложения сначала обращается к определенному URL-адресу, выходные данные рабочего стола могут кэшироваться, а затем обрабатываться в последующие мобильные посетители).

Так как это фильтр, можно выбрать способ применения его к конкретным контроллерам и действиям, например,

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample10.cs)]

… Кроме того, его можно применить ко всем контроллерам и действиям в качестве *глобального фильтра* MVC 3 в файле Global.asax.cs:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample11.cs)]

В загружаемом образце также показано, как можно создать подклассы этого атрибута, перенаправляемые в определенные расположения в вашей мобильной области. Это означает, например, что вы можете:

- Зарегистрируйте глобальный фильтр, как показано выше, который по умолчанию отправляет мобильные Посетители на домашнюю страницу мобильных устройств.
- Также примените Специальный фильтр [Редиректмобиледевицестомобилепродуктпаже] к действию "Просмотр продукта", которое позволяет посетителям мобильных устройств перейти на мобильную версию какой-либо страницы продукта, которую они запросили.
- Также примените другие специальные подклассы фильтра к определенным действиям, перенаправляющие посетителей мобильных устройств на эквивалентную мобильную страницу.

### <a name="configuring-forms-authentication-to-respect-your-mobile-pages"></a>Настройка проверки подлинности с помощью форм для соблюдения мобильных страниц

Если вы используете проверку подлинности с помощью форм, следует отметить, что когда пользователь должен войти в систему, он автоматически перенаправит пользователя по отдельному URL-адресу для входа, который по умолчанию — **/аккаунт/Логон**. Это означает, что мобильные пользователи могут перенаправляться в действие "вход в систему" на рабочем столе.

Чтобы избежать этой проблемы, добавьте логику к рабочему столу "вход в систему", чтобы пользователи мобильных устройств перенаправлялись на мобильное действие "вход в систему". Если вы используете шаблон приложения ASP.NET MVC по умолчанию, обновите действие входа AccountController, как показано ниже.

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample12.cs)]

… Затем реализуйте подходящее действие входа в систему на контроллере, который называется AccountController в вашей мобильной области.

### <a name="working-with-output-caching"></a>Работа с кэшированием выходных данных

Если вы используете фильтр [OutputCache], необходимо принудительно затребовать, чтобы запись кэша заменяться типом устройства. Например, напишите:

[!code-javascript[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample13.js)]

Затем добавьте в файл Global.asax.cs следующий метод:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample14.cs)]

Это обеспечит, чтобы посетители мобильных устройств не получали данные, ранее помещаемые в кэш посетителем рабочего стола.

### <a name="a-working-example"></a>Рабочий пример

Чтобы увидеть эти методы в действии, скачайте [примеры кода, связанные с этим](https://docs.microsoft.com/aspnet/mobile/overview)документом. Этот пример включает приложение ASP.NET MVC 3 (версия-кандидат), расширенное для поддержки мобильных устройств с помощью описанных выше методов.

## <a name="further-guidance-and-suggestions"></a>Дополнительные рекомендации и предложения

Следующее обсуждение применимо как к веб-формам, так и к разработчикам MVC, которые используют методики, описанные в этом документе.

### <a name="enhancing-your-redirection-logic-using-51degreesmobi-foundation"></a>Повышение логики перенаправления с помощью 51Degrees.mobi Foundation

Логика перенаправления, показанная в этом документе, может быть вполне достаточна для вашего приложения, но она не будет работать, если необходимо отключить сеансы или в мобильных браузерах, отклоняя файлы cookie (они не могут быть сеансами), так как они не будут знать, является ли данный запрос Первый из этого посетителя.

Вы уже узнали, как открытый исходный код 51Degrees.mobi Foundation может улучшить точность ASP. Обнаружение обозревателя NET. Она также имеет встроенную возможность перенаправлять посетителей мобильных устройств в определенные места, настроенные в файле Web. config. Он может работать вне зависимости от сеансов ASP.NET (и, следовательно, файлов cookie), сохраняя временный журнал хэшей заголовков HTTP посетителей и IP-адресов, поэтому он знает, является ли каждый запрос первым из заданной вистор.

Следующий элемент, добавленный в раздел Фифтйоне файла Web. config, перенаправит первый запрос с обнаруженного мобильного устройства на страницу ~/Мобиле/дефаулт.аспкс. Любые запросы к страницам в мобильной папке *не* будут перенаправляться независимо от типа устройства. Если мобильное устройство было неактивным в течение 20 минут или больше, устройство будет утрачено, а последующие запросы будут рассматриваться как новые в целях перенаправления.

[!code-xml[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample15.xml)]

Дополнительные сведения см. в [документации по 51Degrees.mobi Foundation](https://github.com/51Degrees/dotNET-Device-Detection).

> [!NOTE]
> Вы *можете* использовать функцию перенаправления 51Degrees.mobi Foundation в приложениях ASP.NET MVC, но необходимо определить конфигурацию перенаправления с точки зрения простых URL-адресов, а не с точки зрения параметров маршрутизации или путем добавления фильтров MVC к действиям. Это происходит потому, что (на момент написания статьи) 51Degrees.mobi Foundation не распознает фильтры или маршрутизацию.

### <a name="disabling-transcoders-and-proxy-servers"></a>Отключение трансагентов и прокси-серверов

Операторы мобильной сети имеют две широкие цели в своем подходе к мобильным Интернет:

1. Укажите как можно больше релевантного содержимого
2. Максимальное число клиентов, которые могут совместно использовать ограниченную пропускную способность сети

Так как большинство веб-страниц разрабатывались для крупных экранов рабочего стола и высокоскоростных широкополосных подключений, многие *операторы используют программы* -программы или *серверы* , которые динамически изменяют веб-содержимое. Они могут изменять разметку HTML или CSS в соответствии с мелкими экранами (особенно для "сотовых телефонов", которые не имеют вычислительной мощности для обработки сложных макетов) и могут повторно сжимать изображения (значительно уменьшая их качество) для повышения скорости доставки страниц.

Но если вы предоставили усилия по созданию версии сайта, оптимизированной для мобильных устройств, вы, вероятно, не хотите, чтобы оператор сети не влиял на него. Можно добавить следующую строку на страницу\_загрузки в любой веб-форме ASP.NET:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample16.cs)]

Для контроллера MVC ASP.NET можно добавить следующее переопределение метода, чтобы оно применялось ко всем действиям на этом контроллере:

[!code-csharp[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample17.cs)]

Полученное сообщение HTTP информирует совместимые с W3C преобразования и прокси-серверы, не изменяя содержимое. Конечно, нет никакой гарантии, что операторы мобильной сети будут учитывать это сообщение.

### <a name="styling-mobile-pages-for-mobile-browsers"></a>Стилизация страниц мобильных устройств для браузеров мобильных устройств

Он выходит за рамки этого документа, чтобы подробно описать, какие виды разметки HTML работают правильно или какие методы веб-дизайна максимально упрощают удобство использования на определенных устройствах. Вы можете найти достаточно простой макет, оптимизированный для экрана с мобильным размером, без использования ненадежных HTML или приемов позиционирования CSS. Однако один важный подход, который стоит упомянуть, — это *тег META окна просмотра*.

В некоторых современных мобильных браузерах веб-страницы, предназначенные для мониторов настольных систем, подготавливаются к просмотру страницы на виртуальном холсте, также называемом «окном просмотра» (например, виртуальное окно просмотра имеет ширину 980 пикселей на iPhone и 850 пикселей на уровне Opera Mobile по умолчанию), а затем масштабировать результат в соответствии с физическими пикселами на экране. Затем пользователь может увеличить и сдвинуть это окно просмотра. Это дает возможность браузеру отображать страницу в ее предполагаемом макете, но у нее также есть недостаток, который вызывает изменение масштаба и панорамирование, что неудобно для пользователя. Если вы разрабатываете для мобильных устройств, лучше разрабатывать узкие экраны, чтобы не требовалось изменять масштаб или горизонтальную прокрутку.

Способ сообщить мобильному браузеру, насколько широким окном просмотра, — через нестандартный тег META *окна просмотра* . Например, если добавить следующий фрагмент в заголовок страницы,

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample18.html)]

… затем Поддержка браузеров смартфонов приведет к размещению страницы на виртуальном холсте размером 480 пикселей. Это означает, что если элементы HTML определяют свои значения ширины в процентах, то проценты будут интерпретироваться в соответствии с шириной 480 пикселей, а не с шириной окна просмотра по умолчанию. В результате пользователь, скорее всего, должен иметь возможность изменять масштаб и панорамирование по горизонтали — значительно улучшая возможности мобильного просмотра.

Если требуется, чтобы ширина окна просмотра совпадала с физическими пикселами устройства, можно указать следующее:

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample19.html)]

Чтобы это работало правильно, не следует явно заставлять элементы, превышающие эту ширину (например, с помощью атрибута *Width* или свойства CSS), в противном случае браузер будет вынужден использовать большее окно просмотра, независимо от того, что оно использует. См. также [Дополнительные сведения о нестандартном теге окна просмотра](https://developer.apple.com/library/safari/#documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html).

Большинство современных смартфонов поддерживают *двойную ориентацию*: они могут храниться в книжном или альбомном режиме. Поэтому важно не делать предположения относительно ширины экрана в пикселях. Даже не следует думать, что ширина экрана фиксирована, так как пользователь может изменить ориентацию устройства, находясь на странице.

Старые устройства Windows Mobile и BlackBerry могут также принять следующие теги META в заголовке страницы, чтобы сообщить, что содержимое было оптимизировано для мобильных устройств и поэтому не должно преобразовываться.

[!code-html[Main](add-mobile-pages-to-your-aspnet-web-forms-mvc-application/samples/sample20.html)]

## <a name="additional-resources"></a>Дополнительные ресурсы

Список эмуляторов и симуляторов мобильных устройств, которые можно использовать для тестирования веб-приложения Mobile ASP.NET, см. на странице [имитация популярных мобильных устройств для тестирования](../mobile/device-simulators.md).

## <a name="credits"></a>Баллы

- Первичный Автор: Стивен Сандерсон
- Рецензенты/дополнительные модули записи содержимого: Джеймс Росевелл, Mikael Сöдерстрöм, Скотт Hanselman, Скотт Хантер
