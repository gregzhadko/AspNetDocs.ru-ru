---
uid: web-forms/overview/older-versions-getting-started/aspnet-ajax/understanding-asp-net-ajax-web-services
title: Общие сведения о веб-службах ASP.NET AJAX | Документация Майкрософт
author: scottcate
description: Веб-службы являются неотъемлемой частью платформы .NET Framework, обеспечивающей кросс-платформенное решение для обмена данными между распределенными системами. Хотя веб...
ms.author: riande
ms.date: 03/28/2008
ms.assetid: 3332d6e7-e2e1-4144-b805-e71d51e7e415
msc.legacyurl: /web-forms/overview/older-versions-getting-started/aspnet-ajax/understanding-asp-net-ajax-web-services
msc.type: authoredcontent
ms.openlocfilehash: eac3d53fd871d0cb5a2870488ce752c057cc5b1a
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "86162843"
---
# <a name="understanding-aspnet-ajax-web-services"></a>Общие сведения о веб-службах ASP.NET AJAX

по [Скотт Cate](https://github.com/scottcate)

[Загрузить PDF-файл](https://download.microsoft.com/download/C/1/9/C19A3451-1D14-477C-B703-54EF22E197EE/AJAX_tutorial05_Web_Services_with_MS_Ajax_cs.pdf)

> Веб-службы являются неотъемлемой частью платформы .NET Framework, обеспечивающей кросс-платформенное решение для обмена данными между распределенными системами. Хотя веб-службы обычно используются для предоставления различных операционных систем, объектных моделей и языков программирования для отправки и получения данных, их также можно использовать для динамического введения данных в ASP.NET AJAX-страницу или отправки данных со страницы в серверную систему. Все это можно сделать, не прибегая к операциям обратной передачи.

## <a name="calling-web-services-with-aspnet-ajax"></a>Вызов веб-служб с помощью ASP.NET AJAX

Вахлин "+ +"

Веб-службы являются неотъемлемой частью платформы .NET Framework, обеспечивающей кросс-платформенное решение для обмена данными между распределенными системами. Хотя веб-службы обычно используются для предоставления различных операционных систем, объектных моделей и языков программирования для отправки и получения данных, их также можно использовать для динамического введения данных в ASP.NET AJAX-страницу или отправки данных со страницы в серверную систему. Все это можно сделать, не прибегая к операциям обратной передачи.

Хотя элемент управления UpdatePanel в ASP.NET AJAX предоставляет простой способ реализации AJAX для любой страницы ASP.NET, иногда возникает необходимость динамического доступа к данным на сервере без использования UpdatePanel. В этой статье вы узнаете, как это сделать, создав и используя веб-службы на страницах ASP.NET AJAX.

Эта статья посвящена функциональным возможностям, доступным в основных расширениях ASP.NET AJAX, а также элементу управления с поддержкой веб-службы в наборе ASP.NET AJAX Toolkit, именуемом Аутокомплетикстендер. Рассматриваемые темы включают в себя определение веб-служб с поддержкой AJAX, создание клиентских прокси и вызов веб-служб с помощью JavaScript. Вы также узнаете, как вызовы веб-служб можно выполнять непосредственно в методах страниц ASP.NET.

## <a name="web-services-configuration"></a>Настройка веб-служб

При создании нового проекта веб-сайта с помощью Visual Studio 2008 файл web.config содержит ряд новых дополнений, которые могут быть незнакомы пользователям предыдущих версий Visual Studio. Некоторые из этих изменений сопоставляют префикс "ASP" с ASP.NET элементами управления AJAX, чтобы их можно было использовать на страницах, а другие определяют необходимые HttpHandlers и HttpModules. В листинге 1 показаны изменения, внесенные в `<httpHandlers>` элемент в web.config, которые влияют на вызовы веб-служб. Обработчик, используемый по умолчанию для обработки вызовов ASMX, удаляется и заменяется классом Скрипсандлерфактори, расположенным в сборке System.Web.Extensions.dll. System.Web.Extensions.dll содержит все основные функции, используемые ASP.NET AJAX.

**Листинг 1. Конфигурация обработчика веб-службы AJAX ASP.NET**

[!code-xml[Main](understanding-asp-net-ajax-web-services/samples/sample1.xml)]

Эта замена HttpHandler выполняется, чтобы разрешить вызовы нотация объектов JavaScript (JSON) из страниц ASP.NET AJAX в веб-службы .NET с помощью прокси веб-службы JavaScript. ASP.NET AJAX отправляет сообщения JSON в веб-службы, а не стандартные вызовы протокола SOAP, обычно связанные с веб-службами. Это приводит к уменьшению объема сообщений запросов и ответов. Он также обеспечивает более эффективную обработку данных на стороне клиента, так как библиотека ASP.NET AJAX JavaScript оптимизирована для работы с объектами JSON. В листинге 2 и листинге 3 показаны примеры сообщений о запросах и ответах веб-службы, сериализованных в формат JSON. Сообщение запроса, показанное в листинге 2, передает параметр Country со значением «Бельгия», а ответное сообщение в листинге 3 передает массив объектов Customer и связанных с ними свойств.

**Листинг 2. Сообщение запроса веб-службы, сериализованное в JSON**

[!code-json[Main](understanding-asp-net-ajax-web-services/samples/sample2.json)]

> *>[!NOTE]имя операции определяется как часть URL веб-службы; Кроме того, сообщения запросов не всегда передаются через JSON. Веб-службы могут использовать атрибут ScriptMethod с параметром Усехттпжет, для которого задано значение true, что приводит к передаче параметров через параметры строки запроса.*

**Листинг 3. Ответное сообщение веб-службы, сериализованное в JSON**

[!code-json[Main](understanding-asp-net-ajax-web-services/samples/sample3.json)]

В следующем разделе вы узнаете, как создавать веб-службы, способные обрабатывать сообщения запросов JSON и реагировать на простые и сложные типы.

## <a name="creating-ajax-enabled-web-services"></a>Создание веб-служб с поддержкой AJAX

Платформа ASP.NET AJAX предоставляет несколько различных способов вызова веб-служб. Можно использовать элемент управления Аутокомплетикстендер (доступен в наборе средств ASP.NET AJAX Toolkit) или JavaScript. Однако перед вызовом службы необходимо включить ее в AJAX, чтобы ее можно было вызывать с помощью кода клиентского скрипта.

Независимо от того, вы не знакомы с веб-службами ASP.NET, вы сможете легко создавать и включать службы AJAX. Платформа .NET Framework поддерживала создание веб-служб ASP.NET с момента ее первоначального выпуска в 2002, а расширения AJAX ASP.NET предоставляют дополнительные функциональные возможности AJAX, основанные на наборе функций .NET Framework по умолчанию. Бета-версия 2 Visual Studio .NET 2008 имеет встроенную поддержку создания файлов веб-службы ASMX и автоматически извлекает связанный код рядом с классами из класса System. Web. Services. WebService. При добавлении методов в класс необходимо применить атрибут WebMethod, чтобы они вызывались потребителями веб-служб.

В листинге 4 показан пример применения атрибута WebMethod к методу с именем Жеткустомерсбикаунтри ().

**Листинг 4. Использование атрибута WebMethod в веб-службе**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample4.cs)]

Метод Жеткустомерсбикаунтри () принимает параметр Country и возвращает массив объектов Customer. Значение страны, передаваемое в метод, пересылается классу бизнес-уровня, который, в свою очередь, вызывает класс уровня данных для получения данных из базы данных, заполнения свойств объекта Customer данными и возвращения массива.

## <a name="using-the-scriptservice-attribute"></a>Использование атрибута ScriptService

Хотя добавление атрибута WebMethod позволяет клиентам, которые отправляют стандартные сообщения SOAP в веб-службу, вызывать метод Жеткустомерсбикаунтри (), он не разрешает делать вызовы JSON из приложений ASP.NET AJAX. Чтобы разрешить вызовы JSON, необходимо применить атрибут расширения AJAX ASP.NET `ScriptService` к классу веб-службы. Это позволяет веб-службе отправлять ответные сообщения, отформатированные с помощью JSON, и позволяет клиентскому сценарию вызывать службу путем отправки сообщений JSON.

В листинге 5 показан пример применения атрибута ScriptService к классу веб-службы с именем Кустомерссервице.

**Листинг 5. Использование атрибута ScriptService для включения веб-службы в AJAX**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample5.cs)]

Атрибут ScriptService выступает в качестве маркера, который указывает, что его можно вызывать из кода скрипта AJAX. В действительности он не обрабатывает ни одну из задач сериализации или десериализации JSON, которые происходят в фоновом режиме. Скрипсандлерфактори (настроенный в web.config) и другие связанные классы выполняют большую часть обработки JSON.

## <a name="using-the-scriptmethod-attribute"></a>Использование атрибута ScriptMethod

Атрибут ScriptService является единственным атрибутом ASP.NET AJAX, который должен быть определен в веб-службе .NET, чтобы его можно было использовать на страницах AJAX ASP.NET. Однако другой атрибут с именем ScriptMethod также можно применить непосредственно к веб-методам в службе. ScriptMethod определяет три свойства `UseHttpGet` , включая, `ResponseFormat` и `XmlSerializeString` . Изменение значений этих свойств может быть полезно в случаях, когда тип запроса, принимаемого веб-методом, должен быть изменен для получения, когда веб-метод должен вернуть необработанные XML-данные в форме `XmlDocument` `XmlElement` объекта или или когда данные, возвращаемые службой, всегда должны быть сериализованы как XML, а не как JSON.

Свойство Усехттпжет можно использовать, когда веб-метод должен принимать запросы GET, а не запросы POST. Запросы отправляются с использованием URL-адреса с входными параметрами веб-метода, преобразованными в параметры строки запроса. Свойство Усехттпжет по умолчанию имеет значение false и должно быть установлено в только тогда, когда известно, что `true` операции являются надежными, а конфиденциальные данные не передаются в веб-службу. В листинге 6 показан пример использования атрибута ScriptMethod со свойством Усехттпжет.

**Листинг 6. Использование атрибута ScriptMethod со свойством Усехттпжет.**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample6.cs)]

Ниже показаны примеры заголовков, отправленных при вызове веб-метода Хттпжетечо, показанного в листинге 6:

`GET /CustomerViewer/DemoService.asmx/HttpGetEcho?input=%22Input Value%22 HTTP/1.1`

Помимо предоставления веб-методам запросов GET HTTP, атрибут ScriptMethod также можно использовать, если требуется возвратить ответы XML из службы, а не из JSON. Например, веб-служба может извлечь канал RSS с удаленного сайта и вернуть его в виде объекта XmlDocument или XmlElement. Затем обработка XML-данных может выполняться на клиенте.

В листинге 7 показан пример использования свойства ResponseFormat для указания того, что XML-данные должны возвращаться из веб метода.

**Листинг 7. Использование атрибута ScriptMethod со свойством ResponseFormat.**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample7.cs)]

Свойство ResponseFormat также можно использовать вместе со свойством Ксмлсериализестринг. Свойство Ксмлсериализестринг имеет значение по умолчанию false, что означает, что все возвращаемые типы, за исключением строк, возвращаемых из веб-метода, сериализуются как XML, если `ResponseFormat` свойство имеет значение `ResponseFormat.Xml` . Если параметр `XmlSerializeString` имеет значение `true` , все типы, возвращаемые из веб-метода, СЕРИАЛИЗУЮТСЯ как XML, включая типы String. Если свойство ResponseFormat имеет значение `ResponseFormat.Json` , свойство ксмлсериализестринг игнорируется.

В листинге 8 показан пример использования свойства Ксмлсериализестринг для принудительного сериализации строк в формате XML.

**Листинг 8. Использование атрибута ScriptMethod со свойством Ксмлсериализестринг**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample8.cs)]

Далее показано значение, возвращаемое при вызове веб-метода Жетксмлстринг, показанного в листинге 8:

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample9.cs)]

Несмотря на то, что формат JSON по умолчанию уменьшает общий размер сообщений запросов и ответов и более широко используется клиентами ASP.NET AJAX в межбраузерном режиме, свойства ResponseFormat и Ксмлсериализестринг можно использовать, когда клиентские приложения, такие как Internet Explorer 5 или более поздней версии, предполагают возврат XML-данных из веб метода.

## <a name="working-with-complex-types"></a>Работа со сложными типами

В листинге 5 показан пример возврата сложного типа с именем Customer из веб-службы. Класс Customer определяет несколько различных простых типов внутренне, как свойства FirstName и LastName. Сложные типы, используемые в качестве входного параметра или возвращаемого типа в веб-методе с поддержкой AJAX, автоматически сериализуются в JSON перед отправкой на клиентскую часть. Однако вложенные сложные типы (определяемые внутри другого типа) не предоставляются клиенту в качестве отдельных объектов по умолчанию.

В случаях, когда вложенный сложный тип, используемый веб-службой, также должен использоваться на клиентской странице, атрибут ASP.NET AJAX Женератескрипттипе можно добавить в веб-службу. Например, класс Кустомердетаилс, показанный в листинге 9, содержит свойства Address и Gender, которые ***представляют вложенные сложные типы.***

**Листинг 9. Показанный здесь класс Кустомердетаилс содержит два вложенных составных типа.**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample10.cs)]

Объекты Address и Gender, определенные в классе Кустомердетаилс, показанном в листинге 9, не будут автоматически доступны для использования на стороне клиента через JavaScript, так как они являются вложенными типами (Address является классом, а Gender — перечислением). В ситуациях, когда вложенный тип, используемый в веб-службе, должен быть доступен на стороне клиента, можно использовать атрибут Женератескрипттипе, упомянутый ранее (см. список 10). Этот атрибут можно добавить несколько раз в случаях, когда из службы возвращаются различные вложенные сложные типы. Его можно применить непосредственно к классу веб-службы или к конкретным веб-методам.

**Список 10. Использование атрибута Женератескриптсервице для определения вложенных типов, которые должны быть доступны клиенту.**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample11.cs)]

Применяя `GenerateScriptType` атрибут к веб-службе, типы Address и Gender автоматически становятся доступными для использования кодом JavaScript ASP.NET AJAX на стороне клиента. Пример кода JavaScript, который автоматически создается и отправляется клиенту путем добавления атрибута Женератескрипттипе в веб-службе, показан в листинге 11. Далее в этой статье вы узнаете, как использовать вложенные сложные типы.

**Листинг 11. Вложенные сложные типы, доступные для страницы ASP.NET AJAX.**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample12.cs)]

Теперь, когда вы узнали, как создавать веб-службы и сделать их доступными для ASP.NET страниц AJAX, давайте посмотрим, как создавать и использовать прокси-серверы JavaScript, чтобы данные могли быть получены или отправлены в Web Services.

## <a name="creating-javascript-proxies"></a>Создание прокси-серверов JavaScript

Вызов стандартной веб-службы (.NET или другой платформы), как правило, предполагает создание прокси-объекта, который изолирует вас от сложностей отправки сообщений SOAP-запросов и ответов. С помощью вызовов веб-службы ASP.NET AJAX можно создавать и использовать прокси JavaScript для простого вызова служб, не беспокоясь о сериализации и десериализации сообщений JSON. Прокси-серверы JavaScript можно автоматически создавать с помощью элемента управления ScriptManager ASP.NET AJAX.

Создание прокси JavaScript, который может вызывать веб-службы, осуществляется с помощью свойства службы ScriptManager. Это свойство позволяет определить одну или несколько служб, которые страница ASP.NET AJAX может вызывать асинхронно для отправки или получения данных, не требуя операций обратной передачи. Вы определяете службу с помощью `ServiceReference` элемента управления AJAX ASP.NET и назначаете URL-адрес для свойства элемента управления `Path` . В листинге 12 показан пример ссылки на службу с именем Кустомерссервице. asmx.

[!code-aspx[Main](understanding-asp-net-ajax-web-services/samples/sample13.aspx)]

**Листинг 12. Определение веб-службы, используемой на странице ASP.NET AJAX.**

Добавление ссылки на Кустомерссервице. asmx через элемент управления ScriptManager вызывает динамическое создание прокси-сервера JavaScript и ссылки на страницу. Прокси-сервер внедряется с помощью &lt; &gt; тега script и динамически загружается путем вызова файла кустомерссервице. asmx и добавления переключателем/JS в конец. В следующем примере показано, как прокси-сервер JavaScript внедряется на страницу при отключении отладки в web.config.

[!code-html[Main](understanding-asp-net-ajax-web-services/samples/sample14.html)]

> *>[!NOTE]Если вы хотите увидеть фактический код прокси-сервера JavaScript, который создается, можно ввести URL-адрес нужной веб-службы .NET в поле адрес Internet Explorer и добавить переключателем/JS в конец.*

Если отладка включена в web.config отладочная версия прокси-сервера JavaScript будет внедрена на страницу, как показано далее:

[!code-html[Main](understanding-asp-net-ajax-web-services/samples/sample15.html)]

Прокси-сервер JavaScript, созданный ScriptManager, можно также внедрить непосредственно в страницу, а не ссылаться на него с помощью &lt; &gt; атрибута src тега script. Это можно сделать, задав для свойства InlineScript элемента управления укзать значение true (значение по умолчанию — false). Это может быть полезно, если прокси-сервер не является общим для нескольких страниц и необходимо уменьшить количество сетевых вызовов, выполняемых на сервере. Если для InlineScript задано значение true, скрипт прокси-сервера не кэшируется браузером, поэтому рекомендуется использовать значение по умолчанию false в случаях, когда прокси-сервер используется несколькими страницами в приложении AJAX ASP.NET. Ниже приведен пример использования свойства InlineScript.

[!code-aspx[Main](understanding-asp-net-ajax-web-services/samples/sample16.aspx)]

## <a name="using-javascript-proxies"></a>Использование прокси-серверов JavaScript

После ссылки на веб-службу на странице ASP.NET AJAX с помощью элемента управления ScriptManager можно выполнить вызов веб-службы, а возвращаемые данные можно обработать с помощью функций обратного вызова. Веб-служба вызывается с помощью ссылки на ее пространство имен (если оно существует), имя класса и имя веб-метода. Любые параметры, передаваемые в веб-службу, можно определить вместе с функцией обратного вызова, которая обрабатывает возвращаемые данные.

Пример использования прокси JavaScript для вызова веб-метода с именем Жеткустомерсбикаунтри () показан в листинге 13. Функция Жеткустомерсбикаунтри () вызывается, когда пользователь нажимает кнопку на странице.

**Листинг 13. Вызов веб-службы с помощью прокси-сервера JavaScript.**

[!code-javascript[Main](understanding-asp-net-ajax-web-services/samples/sample17.js)]

Этот вызов ссылается на пространство имен Интерфацетраининг, класс Кустомерссервице и веб-метод Жеткустомерсбикаунтри, определенный в службе. Он передает значение страны, полученное из текстового поля, а также функцию обратного вызова с именем Онвсрекуесткомплете, которая должна вызываться при возвращении асинхронного вызова веб-службы. Онвсрекуесткомплете обрабатывает массив объектов Customer, возвращенных из службы, и преобразует их в таблицу, которая отображается на странице. Выходные данные, созданные при вызове, показаны на рис. 1.

[![Привязка данных, полученных путем выполнения асинхронного вызова AJAX к веб-службе.](understanding-asp-net-ajax-web-services/_static/image2.png)](understanding-asp-net-ajax-web-services/_static/image1.png)

**Рис. 1**. Привязка данных, полученных путем выполнения асинхронного вызова Ajax к веб-службе.  ([Щелкните, чтобы просмотреть изображение с полным размером](understanding-asp-net-ajax-web-services/_static/image3.png))

Прокси JavaScript также может выполнять односторонние вызовы веб-служб в случаях, когда необходимо вызвать веб-метод, но прокси не должен ждать ответа. Например, может потребоваться вызвать веб-службу, чтобы запустить процесс, например рабочий поток, но не дожидаться возврата значения от службы. В случаях, когда необходимо выполнить односторонний вызов к службе, функцию обратного вызова, показанную в листинге 13, можно просто опустить. Так как функция обратного вызова не определена, прокси-объект не будет ждать возврата данных от Интернета.

## <a name="handling-errors"></a>Обработка ошибок

Асинхронные обратные вызовы к веб-службам могут столкнуться с различными типами ошибок, такими как сеть не работает, веб-служба недоступна или возвращаемое исключение. К счастью, прокси-объекты JavaScript, создаваемые ScriptManager, позволяют определить несколько обратных вызовов для работы с ошибками и сбоями в дополнение к показанному выше обратному вызову успешного выполнения. Функцию обратного вызова ошибки можно определить сразу после стандартной функции обратного вызова в вызове веб-метода, как показано в листинге 14.

**Листинг 14. Определение функции обратного вызова ошибок и отображение ошибок.**

[!code-javascript[Main](understanding-asp-net-ajax-web-services/samples/sample18.js)]

Ошибки, возникающие при вызове веб-службы, активируют функцию обратного вызова Онвсрекуестфаилед (), которая принимает объект, представляющий ошибку, в качестве параметра. Объект Error предоставляет несколько различных функций для определения причины ошибки, а также время ожидания вызова. В листинге 14 показан пример использования различных функций ошибок, а на рис. 2 показан пример выходных данных, создаваемых функциями.

[![Выходные данные, создаваемые вызовом функций ошибок AJAX ASP.NET.](understanding-asp-net-ajax-web-services/_static/image5.png)](understanding-asp-net-ajax-web-services/_static/image4.png)

**Рис. 2**. вывод, формируемый вызовом функций ошибок AJAX ASP.NET.  ([Щелкните, чтобы просмотреть изображение с полным размером](understanding-asp-net-ajax-web-services/_static/image6.png))

## <a name="handling-xml-data-returned-from-a-web-service"></a>Обработка данных XML, возвращаемых веб-службой

Ранее было показано, как веб-метод может возвращать необработанные данные XML с помощью атрибута ScriptMethod вместе со свойством ResponseFormat. Если ResponseFormat имеет значение ResponseFormat.Xml, данные, возвращаемые веб-службой, сериализуются как XML, а не как JSON. Это может быть полезно, если XML-данные необходимо передать непосредственно клиенту для обработки с помощью JavaScript или XSLT. В настоящее время Internet Explorer 5 или более поздней версии предоставляет лучшую объектную модель на стороне клиента для анализа и фильтрации XML-данных из-за встроенной поддержки MSXML.

Извлечение данных XML из веб-службы не отличается от получения других типов данных. Начните с вызова прокси-сервера JavaScript для вызова соответствующей функции и определения функции обратного вызова. После того как вызов вернет значение, можно обработать данные в функции обратного вызова.

В листинге 15 показан пример вызова веб-метода с именем Жетрссфид (), который возвращает объект XmlElement. Жетрссфид () принимает один параметр, представляющий URL-адрес канала RSS для извлечения.

**Листинг 15. Работа с XML-данными, возвращаемыми из веб-службы.**

[!code-html[Main](understanding-asp-net-ajax-web-services/samples/sample19.html)]

В этом примере URL-адрес передается в канал RSS и обрабатывает возвращенные XML-данные в функции Онвсрекуесткомплете (). Сначала Онвсрекуесткомплете () проверяет, доступен ли анализатор MSXML в обозревателе Internet Explorer. Если это так, то для размещения всех &lt; &gt; тегов элементов в RSS-канале используется инструкция XPath. Затем каждый элемент просматривается, а связанный &lt; заголовок &gt; и &lt; теги ссылки &gt; размещаются и обрабатываются для вывода данных каждого элемента. На рис. 3 показан пример выходных данных, формируемых при вызове ASP.NET AJAX через прокси-сервер JavaScript для метода Жетрссфид ().

## <a name="handling-complex-types"></a>Обработка сложных типов

Сложные типы, принятые или возвращаемые веб-службой, автоматически предоставляются через прокси-сервер JavaScript. Однако вложенные сложные типы не доступны напрямую на стороне клиента, если только атрибут Женератескрипттипе не применен к службе, как обсуждалось ранее. Зачем использовать вложенный сложный тип на стороне клиента?

Чтобы ответить на этот вопрос, предположим, что страница AJAX ASP.NET отображает данные клиента и позволяет конечным пользователям обновлять адрес клиента. Если веб-служба указывает, что тип адреса (сложный тип, определенный в классе Кустомердетаилс) может быть отправлен клиенту, то процесс обновления можно разделить на отдельные функции для дальнейшего повторного использования кода.

[![Вывод, создающий из вызова веб-службы, которая возвращает данные RSS.](understanding-asp-net-ajax-web-services/_static/image8.png)](understanding-asp-net-ajax-web-services/_static/image7.png)

**Рис. 3**. вывод, создающий из вызова веб-службы, которая ВОЗВРАЩАЕТ данные RSS.  ([Щелкните, чтобы просмотреть изображение с полным размером](understanding-asp-net-ajax-web-services/_static/image9.png))

В листинге 16 показан пример кода на стороне клиента, который вызывает объект Address, определенный в пространстве имен модели, заполняет его обновленными данными и присваивает ему свойство Address объекта Кустомердетаилс. Затем объект Кустомердетаилс передается в веб-службу для обработки.

**Листинг 16. Использование вложенных сложных типов**

[!code-javascript[Main](understanding-asp-net-ajax-web-services/samples/sample20.js)]

## <a name="creating-and-using-page-methods"></a>Создание и использование методов страницы

Веб-службы предоставляют отличный способ предоставления повторного использования служб различным клиентам, включая ASP.NET AJAX Pages. Однако могут возникнуть ситуации, когда странице требуется получить данные, которые не используются или не являются общими для других страниц. В этом случае создание ASMX-файла, разрешающего странице доступ к данным, может показаться избыточным, так как служба используется только одной страницей.

ASP.NET AJAX предоставляет еще один механизм для выполнения вызовов, аналогичных веб-службам, без создания автономных файлов ASMX. Для этого используется методика, называемая "методами страниц". Методы страницы являются статическими методами (Shared in VB.NET), встроенными непосредственно в страницу или файл кода поддержки, к которым применен атрибут WebMethod. Применяя атрибут WebMethod, их можно вызывать с помощью специального объекта JavaScript с именем Pagemethod, который создается динамически во время выполнения. Объект Pagemethod выступает в качестве прокси-сервера, который изолирует вас от процесса сериализации и десериализации JSON. Обратите внимание, что для использования объекта Pagemethod необходимо задать для свойства Енаблепажемесодс ScriptManager значение true.

[!code-aspx[Main](understanding-asp-net-ajax-web-services/samples/sample21.aspx)]

В листинге 17 показан пример определения двух методов страницы в классе кода для ASP.NET. Эти методы извлекают данные из класса бизнес-уровня, расположенного в \_ папке кода приложения веб-сайта.

**Листинг 17. Определение методов страницы.**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample22.cs)]

Когда диспетчер ScriptManager обнаруживает наличие веб-методов на странице, он создает динамическую ссылку на объект Pagemethod, упомянутый ранее. Вызов веб-метода осуществляется путем ссылки на класс Pagemethod, за которым следует имя метода и все необходимые данные параметров, которые должны быть переданы. В листинге 18 показаны примеры вызова двух методов страницы, показанных ранее.

**Листинг 18. Вызов методов страницы с помощью объекта JavaScript Pagemethod.**

[!code-javascript[Main](understanding-asp-net-ajax-web-services/samples/sample23.js)]

Использование объекта Pagemethod очень похоже на использование прокси-объекта JavaScript. Сначала необходимо указать все данные параметров, которые должны быть переданы в метод страницы, а затем определить функцию обратного вызова, которая должна вызываться при возврате асинхронного вызова. Также можно указать обратный вызов сбоя (см. список 14 для примера ошибок обработки).

## <a name="the-autocompleteextender-and-the-aspnet-ajax-toolkit"></a>Аутокомплетикстендер и ASP.NET AJAX Toolkit

Набор средств ASP.NET AJAX Toolkit (доступен в [http://ajax.asp.net](http://ajax.asp.net) ) предлагает несколько элементов управления, которые можно использовать для доступа к веб-службам. В частности, набор средств содержит полезный элемент управления с именем `AutoCompleteExtender` , который можно использовать для вызова веб-служб и отображения данных на страницах без написания кода JavaScript.

Элемент управления Аутокомплетикстендер можно использовать для расширения существующих функциональных возможностей текстового поля и упрощения поиска искомых данных. При вводе в текстовое поле элемент управления может использоваться для запроса веб-службы и отображает результаты под текстовым полем динамически. На рис. 4 показан пример использования элемента управления Аутокомплетикстендер для отображения идентификаторов клиентов для приложения поддержки. По мере того, как пользователь вводит в текстовое поле разные символы, на основе их ввода будут отображаться различные элементы. Затем пользователи могут выбрать нужный идентификатор клиента.

Использование Аутокомплетикстендер на странице AJAX ASP.NET требует добавления AjaxControlToolkit.dll сборки в папку Bin веб-сайта. После добавления сборки набора инструментов необходимо сослаться на нее в web.config, чтобы элементы управления, которые она содержит, были доступны для всех страниц в приложении. Это можно сделать, добавив следующий тег в &lt; тег элементов управления web.config &gt; :

[!code-xml[Main](understanding-asp-net-ajax-web-services/samples/sample24.xml)]

В случаях, когда необходимо использовать элемент управления только на определенной странице, можно ссылаться на него, добавив директиву Reference в верхнюю часть страницы, как показано ниже, а не обновлять web.config:

[!code-aspx[Main](understanding-asp-net-ajax-web-services/samples/sample25.aspx)]

[![Использование элемента управления Аутокомплетикстендер.](understanding-asp-net-ajax-web-services/_static/image11.png)](understanding-asp-net-ajax-web-services/_static/image10.png)

**Рис. 4**. Использование элемента управления аутокомплетикстендер.  ([Щелкните, чтобы просмотреть изображение с полным размером](understanding-asp-net-ajax-web-services/_static/image12.png))

После настройки веб-сайта для использования набора средств AJAX ASP.NET можно добавить элемент управления Аутокомплетикстендер на страницу, что очень похоже на добавление обычного серверного элемента управления ASP.NET. В листинге 19 показан пример использования элемента управления для вызова веб-службы.

**Листинг 19. С помощью элемента управления Аутокомплетикстендер ASP.NET AJAX Toolkit.**

[!code-aspx[Main](understanding-asp-net-ajax-web-services/samples/sample26.aspx)]

Аутокомплетикстендер имеет несколько различных свойств, включая стандартные ИДЕНТИФИКАТОРы и свойства runat, найденные в серверных элементах управления. Кроме того, он позволяет определить, сколько символов имеет тип конечного пользователя, прежде чем веб-служба запрашивает данные. Свойство MinimumPrefixLength, показанное в листинге 19, вызывает вызов службы каждый раз при вводе символа в текстовое поле. Это значение следует устанавливать с осторожностью, поскольку каждый раз, когда пользователь вводит символ, который будет вызывать веб-служба для поиска значений, соответствующих символам в текстовом поле. Веб-служба для вызова, а также целевой веб-метод определяется с помощью свойств Сервицепас и Сервицемесод, соответственно. Наконец, свойство TargetControlID определяет, в какое текстовое поле следует привязать элемент управления Аутокомплетикстендер к.

Для вызова веб-службы необходимо применить атрибут ScriptService, как обсуждалось ранее, а целевой веб-метод должен принимать два параметра с именами Префикстекст и Count. Параметр Префикстекст представляет символы, введенные конечным пользователем, а параметр Count — количество возвращаемых элементов (значение по умолчанию — 10). В листинге 20 показан пример веб-метода, вызываемого элементом управления Аутокомплетикстендер, показанным выше в листинге 19. Веб-метод вызывает метод бизнес-уровня, который, в свою очередь, вызывает метод уровня данных, который обрабатывает фильтрацию данных и возвращает результаты сопоставления. Код для метода уровня данных показан в листинге 21.

**Листинг 20. Фильтрация данных, отправляемых из элемента управления Аутокомплетикстендер.**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample27.cs)]

**Листинг 21. Фильтрация результатов на основе ввода конечных пользователей.**

[!code-csharp[Main](understanding-asp-net-ajax-web-services/samples/sample28.cs)]

## <a name="conclusion"></a>Заключение

ASP.NET AJAX обеспечивает отличную поддержку вызова веб-служб без написания большого объема пользовательского кода JavaScript для работы с запросами и ответными сообщениями. В этой статье вы узнали, как AJAX-включить веб-службы .NET, чтобы разрешить им обрабатывать сообщения JSON и как определять прокси JavaScript с помощью элемента управления ScriptManager. Вы также узнали, как использовать прокси JavaScript для вызова веб-служб, обрабатывать простые и сложные типы и работать со сбоями. Наконец, вы узнали, как можно использовать методы страницы для упрощения процесса создания и выполнения вызовов веб-служб, а также как элемент управления Аутокомплетикстендер может обеспечить помощь конечным пользователям по мере их ввода. Хотя UpdatePanel, доступная в ASP.NET AJAX, определенно является выбором для многих программистов AJAX в связи с простотой, знание способов вызова веб-служб через прокси JavaScript может быть полезным во многих приложениях.

## <a name="bio"></a>Биография

"Вахлин" (самый ценный специалист корпорации Майкрософт для ASP.NET и веб-служб XML) — это консультант по разработке и архитектуре разработки .NET в техническом обучении интерфейса ( [http://www.interfacett.com](http://www.interfacett.com) ). Г., посвященный веб-узлу разработчиков XML для ASP.NET ([www.XMLforASP.NET](http://www.XMLforASP.NET)), находится в бюро докладчика INETA и говорит на нескольких конференциях. Г. профессионально разработанная профессиональная Windows ДНК (Wrox), ASP.NET: советы, учебники и код (Sams), решения для предварительной оценки ASP.NET 1,1, профессиональная ASP.NET 2,0 AJAX (Wrox), ASP.NET 2,0 MVP и авторский XML для ASP.NET разработчиков (Sams). Когда он не пишет код, статьи или книги, самое время пишет и записывает музыку и воспроизводила гольф и баскетбол с его женойами и детьми.

Скотт Cate работал с веб-технологиями Майкрософт с 1997 и является президентом myKB.com ([www.myKB.com](http://www.myKB.com)), где он специализируется на написании приложений ASP.NET на базе знаний, посвященных программным решениям. Скотт может связаться по электронной почте по адресу [scott.cate@myKB.com](mailto:scott.cate@myKB.com) или в блоге по адресу [ScottCate.com](http://ScottCate.com)

> [!div class="step-by-step"]
> [Назад](understanding-asp-net-ajax-localization.md)
> [Вперед](understanding-asp-net-ajax-debugging-capabilities.md)
