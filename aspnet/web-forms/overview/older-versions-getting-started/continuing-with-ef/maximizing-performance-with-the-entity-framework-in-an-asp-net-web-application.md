---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
title: Увеличение производительности с помощью Entity Framework 4,0 в веб-приложении ASP.NET 4 | Документация Майкрософт
author: tdykstra
description: Эта серия руководств основана на веб-приложении университета Contoso, которое создается начало работы с руководством по Entity Framework 4,0. Он...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 4e43455e-dfa1-42db-83cb-c987703f04b5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 5630200a1ad1d30f6d89b38e15179f15b699fa9f
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78439266"
---
# <a name="maximizing-performance-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="7fd79-104">Увеличение производительности с помощью Entity Framework 4,0 в веб-приложении ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="7fd79-104">Maximizing Performance with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="7fd79-105">от [Tom Dykstra)](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="7fd79-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="7fd79-106">Эта серия руководств основана на веб-приложении университета Contoso, которое создается [Начало работы с руководством по Entity Framework 4,0](https://asp.net/entity-framework/tutorials#Getting%20Started) .</span><span class="sxs-lookup"><span data-stu-id="7fd79-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="7fd79-107">Если вы не выполнили предыдущие учебники, в качестве отправной точки для этого учебника вы можете скачать созданное [приложение](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) .</span><span class="sxs-lookup"><span data-stu-id="7fd79-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="7fd79-108">Вы также можете [скачать приложение](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , созданное с помощью полной серии руководств.</span><span class="sxs-lookup"><span data-stu-id="7fd79-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="7fd79-109">Если у вас есть вопросы о учебниках, их можно опубликовать на [форуме ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="7fd79-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="7fd79-110">В предыдущем руководстве вы узнали, как справляться с конфликтами параллелизма.</span><span class="sxs-lookup"><span data-stu-id="7fd79-110">In the previous tutorial, you saw how to handle concurrency conflicts.</span></span> <span data-ttu-id="7fd79-111">В этом руководстве приведены параметры для повышения производительности веб-приложения ASP.NET, использующего Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="7fd79-111">This tutorial shows options for improving the performance of an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="7fd79-112">Вы узнаете о нескольких методах максимизации производительности или диагностике проблем с производительностью.</span><span class="sxs-lookup"><span data-stu-id="7fd79-112">You'll learn several methods for maximizing performance or for diagnosing performance problems.</span></span>

<span data-ttu-id="7fd79-113">Сведения, представленные в следующих разделах, скорее всего, будут полезны в самых разных сценариях:</span><span class="sxs-lookup"><span data-stu-id="7fd79-113">Information presented in the following sections is likely to be useful in a broad variety of scenarios:</span></span>

- <span data-ttu-id="7fd79-114">Эффективная загрузка связанных данных.</span><span class="sxs-lookup"><span data-stu-id="7fd79-114">Efficiently load related data.</span></span>
- <span data-ttu-id="7fd79-115">Управление состоянием представления.</span><span class="sxs-lookup"><span data-stu-id="7fd79-115">Manage view state.</span></span>

<span data-ttu-id="7fd79-116">Сведения, представленные в следующих разделах, могут быть полезны при наличии отдельных запросов, представляющих проблемы с производительностью.</span><span class="sxs-lookup"><span data-stu-id="7fd79-116">Information presented in the following sections might be useful if you have individual queries that present performance problems:</span></span>

- <span data-ttu-id="7fd79-117">Используйте параметр слияния `NoTracking`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-117">Use the `NoTracking` merge option.</span></span>
- <span data-ttu-id="7fd79-118">Предварительно компилировать запросы LINQ.</span><span class="sxs-lookup"><span data-stu-id="7fd79-118">Pre-compile LINQ queries.</span></span>
- <span data-ttu-id="7fd79-119">Проверьте команды запроса, отправленные в базу данных.</span><span class="sxs-lookup"><span data-stu-id="7fd79-119">Examine query commands sent to the database.</span></span>

<span data-ttu-id="7fd79-120">Сведения, представленные в следующем разделе, потенциально полезны для приложений с очень большими моделями данных:</span><span class="sxs-lookup"><span data-stu-id="7fd79-120">Information presented in the following section is potentially useful for applications that have extremely large data models:</span></span>

- <span data-ttu-id="7fd79-121">Предварительно создавать представления.</span><span class="sxs-lookup"><span data-stu-id="7fd79-121">Pre-generate views.</span></span>

> [!NOTE]
> <span data-ttu-id="7fd79-122">Производительность веб-приложений зависит от многих факторов, в том числе от размера данных запроса и ответа, скорости запросов к базе данных, количества запросов, которые сервер может поставить в очередь, а также от того, насколько быстро он может их обслуживать, а также эффективность любого библиотеки клиентских скриптов, которые вы можете использовать.</span><span class="sxs-lookup"><span data-stu-id="7fd79-122">Web application performance is affected by many factors, including things like the size of request and response data, the speed of database queries, how many requests the server can queue and how quickly it can service them, and even the efficiency of any client-script libraries you might be using.</span></span> <span data-ttu-id="7fd79-123">Если в вашем приложении важна производительность или если тестирование или опыт показывает, что производительность приложения не подходит, следует соблюдать стандартный протокол для настройки производительности.</span><span class="sxs-lookup"><span data-stu-id="7fd79-123">If performance is critical in your application, or if testing or experience shows that application performance isn't satisfactory, you should follow normal protocol for performance tuning.</span></span> <span data-ttu-id="7fd79-124">Определите, где возникают узкие места производительности, а затем разрешите области, которые будут оказывать наибольшее влияние на общую производительность приложения.</span><span class="sxs-lookup"><span data-stu-id="7fd79-124">Measure to determine where performance bottlenecks are occurring, and then address the areas that will have the greatest impact on overall application performance.</span></span>
> 
> <span data-ttu-id="7fd79-125">В этом разделе основное внимание уделяется способам, с помощью которых можно улучшить производительность специально для Entity Framework в ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="7fd79-125">This topic focuses mainly on ways in which you can potentially improve the performance specifically of the Entity Framework in ASP.NET.</span></span> <span data-ttu-id="7fd79-126">Рекомендации здесь полезны, если вы определили, что доступ к данным является одним из узких мест производительности в приложении.</span><span class="sxs-lookup"><span data-stu-id="7fd79-126">The suggestions here are useful if you determine that data access is one of the performance bottlenecks in your application.</span></span> <span data-ttu-id="7fd79-127">Если не указано иное, описанные здесь методы не должны рассматриваться &quot;рекомендациями&quot; в целом, многие из них подходят только в исключительных ситуациях или для решения самых узких мест, связанных с производительностью.</span><span class="sxs-lookup"><span data-stu-id="7fd79-127">Except as noted, the methods explained here shouldn't be considered &quot;best practices&quot; in general — many of them are appropriate only in exceptional situations or to address very specific kinds of performance bottlenecks.</span></span>

<span data-ttu-id="7fd79-128">Чтобы начать работу с руководством, запустите Visual Studio и откройте веб-приложение Contoso университета, с которым вы работали в предыдущем руководстве.</span><span class="sxs-lookup"><span data-stu-id="7fd79-128">To start the tutorial, start Visual Studio and open the Contoso University web application that you were working with in the previous tutorial.</span></span>

## <a name="efficiently-loading-related-data"></a><span data-ttu-id="7fd79-129">Эффективная загрузка связанных данных</span><span class="sxs-lookup"><span data-stu-id="7fd79-129">Efficiently Loading Related Data</span></span>

<span data-ttu-id="7fd79-130">Существует несколько способов, с помощью которых Entity Framework может загружать связанные данные в свойства навигации сущности:</span><span class="sxs-lookup"><span data-stu-id="7fd79-130">There are several ways that the Entity Framework can load related data into the navigation properties of an entity:</span></span>

- <span data-ttu-id="7fd79-131">*Отложенная загрузка*.</span><span class="sxs-lookup"><span data-stu-id="7fd79-131">*Lazy loading*.</span></span> <span data-ttu-id="7fd79-132">При первом чтении сущности связанные данные не извлекаются.</span><span class="sxs-lookup"><span data-stu-id="7fd79-132">When the entity is first read, related data isn't retrieved.</span></span> <span data-ttu-id="7fd79-133">Однако при первой попытке доступа к свойству навигации необходимые для этого свойства навигации данные извлекаются автоматически.</span><span class="sxs-lookup"><span data-stu-id="7fd79-133">However, the first time you attempt to access a navigation property, the data required for that navigation property is automatically retrieved.</span></span> <span data-ttu-id="7fd79-134">В результате в базу данных отправляются несколько запросов — одна для самой сущности, а другая — каждый раз, когда необходимо извлечь связанные данные для сущности.</span><span class="sxs-lookup"><span data-stu-id="7fd79-134">This results in multiple queries sent to the database — one for the entity itself and one each time that related data for the entity must be retrieved.</span></span> 

    <span data-ttu-id="7fd79-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="7fd79-136">*Безотложная загрузка*.</span><span class="sxs-lookup"><span data-stu-id="7fd79-136">*Eager loading*.</span></span> <span data-ttu-id="7fd79-137">При чтении сущности связанные данные извлекаются вместе с ней.</span><span class="sxs-lookup"><span data-stu-id="7fd79-137">When the entity is read, related data is retrieved along with it.</span></span> <span data-ttu-id="7fd79-138">Обычно такая загрузка представляет собой одиночный запрос с соединением, который получает все необходимые данные.</span><span class="sxs-lookup"><span data-stu-id="7fd79-138">This typically results in a single join query that retrieves all of the data that's needed.</span></span> <span data-ttu-id="7fd79-139">Вы указываете безотлагательную загрузку с помощью метода `Include`, как вы уже видели в этих учебниках.</span><span class="sxs-lookup"><span data-stu-id="7fd79-139">You specify eager loading by using the `Include` method, as you've seen already in these tutorials.</span></span>

<span data-ttu-id="7fd79-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

- <span data-ttu-id="7fd79-141">*Явная загрузка*.</span><span class="sxs-lookup"><span data-stu-id="7fd79-141">*Explicit loading*.</span></span> <span data-ttu-id="7fd79-142">Это похоже на отложенную загрузку за исключением того, что вы явно извлечете связанные данные в коде. Это не происходит автоматически при доступе к свойству навигации.</span><span class="sxs-lookup"><span data-stu-id="7fd79-142">This is similar to lazy loading, except that you explicitly retrieve the related data in code; it doesn't happen automatically when you access a navigation property.</span></span> <span data-ttu-id="7fd79-143">Связанные данные загружаются вручную с помощью метода `Load` свойства навигации для коллекций или с помощью метода `Load` ссылочного свойства для свойств, содержащих один объект.</span><span class="sxs-lookup"><span data-stu-id="7fd79-143">You load related data manually using the `Load` method of the navigation property for collections, or you use the `Load` method of the reference property for properties that hold a single object.</span></span> <span data-ttu-id="7fd79-144">(Например, вызов метода `PersonReference.Load` для загрузки свойства навигации `Person` сущности `Department`.)</span><span class="sxs-lookup"><span data-stu-id="7fd79-144">(For example, you call the `PersonReference.Load` method to load the `Person` navigation property of a `Department` entity.)</span></span>

    <span data-ttu-id="7fd79-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="7fd79-146">Поскольку они не извлекают значения свойств немедленно, отложенная загрузка и явная загрузка также называются *отложенной загрузкой*.</span><span class="sxs-lookup"><span data-stu-id="7fd79-146">Because they don't immediately retrieve the property values, lazy loading and explicit loading are also both known as *deferred loading*.</span></span>

<span data-ttu-id="7fd79-147">Отложенная загрузка является поведением по умолчанию для контекста объекта, созданного конструктором.</span><span class="sxs-lookup"><span data-stu-id="7fd79-147">Lazy loading is the default behavior for an object context that has been generated by the designer.</span></span> <span data-ttu-id="7fd79-148">При открытии файла *SchoolModel.Designer.CS* , определяющего класс контекста объекта, можно найти три метода конструктора, каждый из которых включает следующую инструкцию:</span><span class="sxs-lookup"><span data-stu-id="7fd79-148">If you open the *SchoolModel.Designer.cs* file that defines the object context class, you'll find three constructor methods, and each of them includes the following statement:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="7fd79-149">Как правило, если известно, что для каждой полученной сущности необходимы связанные данные, безотлагательная загрузка обеспечивает наилучшую производительность, поскольку один запрос, отправленный в базу данных, обычно более эффективен, чем отдельные запросы для каждой полученной сущности.</span><span class="sxs-lookup"><span data-stu-id="7fd79-149">In general, if you know you need related data for every entity retrieved, eager loading offers the best performance, because a single query sent to the database is typically more efficient than separate queries for each entity retrieved.</span></span> <span data-ttu-id="7fd79-150">С другой стороны, если нужно получить доступ к свойствам навигации сущности только редко или только для небольшого набора сущностей, отложенная загрузка или явная загрузка может оказаться более эффективной, поскольку при безотлагательной загрузке будут извлекаться больше данных, чем требуется.</span><span class="sxs-lookup"><span data-stu-id="7fd79-150">On the other hand, if you need to access an entity's navigation properties only infrequently or only for a small set of the entities, lazy loading or explicit loading may be more efficient, because eager loading would retrieve more data than you need.</span></span>

<span data-ttu-id="7fd79-151">В веб-приложении отложенная загрузка может быть относительно незначительной величиной, так как действия пользователя, влияющие на необходимость связанных данных, выполняются в браузере, который не имеет соединения с контекстом объекта, который визуализирует страницу.</span><span class="sxs-lookup"><span data-stu-id="7fd79-151">In a web application, lazy loading may be of relatively little value anyway, because user actions that affect the need for related data take place in the browser, which has no connection to the object context that rendered the page.</span></span> <span data-ttu-id="7fd79-152">С другой стороны, при привязку элемента управления, как правило, известно, какие данные вам нужны, и, как правило, лучше выбрать нерешенную загрузку или отложенную загрузку в зависимости от того, что подходит для каждого сценария.</span><span class="sxs-lookup"><span data-stu-id="7fd79-152">On the other hand, when you databind a control, you typically know what data you need, and so it's generally best to choose eager loading or deferred loading based on what's appropriate in each scenario.</span></span>

<span data-ttu-id="7fd79-153">Кроме того, элемент управления с привязкой к данным может использовать объект сущности после удаления контекста объекта.</span><span class="sxs-lookup"><span data-stu-id="7fd79-153">In addition, a databound control might use an entity object after the object context is disposed.</span></span> <span data-ttu-id="7fd79-154">В этом случае попытка отложенной загрузки свойства навигации завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="7fd79-154">In that case, an attempt to lazy-load a navigation property would fail.</span></span> <span data-ttu-id="7fd79-155">Полученное сообщение об ошибке можно очистить: &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span><span class="sxs-lookup"><span data-stu-id="7fd79-155">The error message you receive is clear: &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span></span>

<span data-ttu-id="7fd79-156">Элемент управления `EntityDataSource` отключает отложенную загрузку по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7fd79-156">The `EntityDataSource` control disables lazy loading by default.</span></span> <span data-ttu-id="7fd79-157">Для элемента управления `ObjectDataSource`, который вы используете для текущего учебника (или при доступе к контексту объекта из кода страницы), существует несколько способов сделать отложенную загрузку отключенной по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7fd79-157">For the `ObjectDataSource` control that you're using for the current tutorial (or if you access the object context from page code), there are several ways you can make lazy loading disabled by default.</span></span> <span data-ttu-id="7fd79-158">Его можно отключить при создании экземпляра контекста объекта.</span><span class="sxs-lookup"><span data-stu-id="7fd79-158">You can disable it when you instantiate an object context.</span></span> <span data-ttu-id="7fd79-159">Например, в метод конструктора класса `SchoolRepository` можно добавить следующую строку:</span><span class="sxs-lookup"><span data-stu-id="7fd79-159">For example, you can add the following line to the constructor method of the `SchoolRepository` class:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="7fd79-160">Для приложения университета Contoso вы сделаете контекст объекта автоматически отключать отложенную загрузку, чтобы это свойство не запускалось при создании экземпляра контекста.</span><span class="sxs-lookup"><span data-stu-id="7fd79-160">For the Contoso University application, you'll make the object context automatically disable lazy loading so that this property doesn't have to be set whenever a context is instantiated.</span></span>

<span data-ttu-id="7fd79-161">Откройте модель данных *счулмодел. EDMX* , щелкните область конструктора, а затем в области Свойства установите для свойства **Enabled отложенная загрузка** значение `False`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-161">Open the *SchoolModel.edmx* data model, click the design surface, and then in the properties pane set the **Lazy Loading Enabled** property to `False`.</span></span> <span data-ttu-id="7fd79-162">Сохраните и закройте модель данных.</span><span class="sxs-lookup"><span data-stu-id="7fd79-162">Save and close the data model.</span></span>

<span data-ttu-id="7fd79-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

## <a name="managing-view-state"></a><span data-ttu-id="7fd79-164">Управление состоянием представления</span><span class="sxs-lookup"><span data-stu-id="7fd79-164">Managing View State</span></span>

<span data-ttu-id="7fd79-165">Чтобы обеспечить функциональность обновления, на веб-странице ASP.NET должны храниться исходные значения свойств сущности при подготовке страницы к просмотру.</span><span class="sxs-lookup"><span data-stu-id="7fd79-165">In order to provide update functionality, an ASP.NET web page must store the original property values of an entity when a page is rendered.</span></span> <span data-ttu-id="7fd79-166">Во время обработки обратной передачи элемент управления может повторно создать исходное состояние сущности и вызвать метод `Attach` сущности перед применением изменений и вызовом метода `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-166">During postback processing the control can re-create the original state of the entity and call the entity's `Attach` method before applying changes and calling the `SaveChanges` method.</span></span> <span data-ttu-id="7fd79-167">По умолчанию ASP.NET элементы управления данными веб-форм используют состояние представления для хранения исходных значений.</span><span class="sxs-lookup"><span data-stu-id="7fd79-167">By default, ASP.NET Web Forms data controls use view state to store the original values.</span></span> <span data-ttu-id="7fd79-168">Однако состояние представления может повлиять на производительность, так как оно хранится в скрытых полях, что может существенно увеличить размер страницы, отправляемой в браузер и из нее.</span><span class="sxs-lookup"><span data-stu-id="7fd79-168">However, view state can affect performance, because it's stored in hidden fields that can substantially increase the size of the page that's sent to and from the browser.</span></span>

<span data-ttu-id="7fd79-169">Методы управления состоянием представления или такие альтернативы, как состояние сеанса, не уникальны для Entity Framework, поэтому в этом учебнике подробно рассматривается этот раздел.</span><span class="sxs-lookup"><span data-stu-id="7fd79-169">Techniques for managing view state, or alternatives such as session state, aren't unique to the Entity Framework, so this tutorial doesn't go into this topic in detail.</span></span> <span data-ttu-id="7fd79-170">Дополнительные сведения см. по ссылкам в конце этого руководства.</span><span class="sxs-lookup"><span data-stu-id="7fd79-170">For more information see the links at the end of the tutorial.</span></span>

<span data-ttu-id="7fd79-171">Однако версия 4 ASP.NET предоставляет новый способ работы с состоянием представления, который должен знать каждый разработчик ASP.NET приложений веб-форм: `ViewStateMode` свойство.</span><span class="sxs-lookup"><span data-stu-id="7fd79-171">However, version 4 of ASP.NET provides a new way of working with view state that every ASP.NET developer of Web Forms applications should be aware of: the `ViewStateMode` property.</span></span> <span data-ttu-id="7fd79-172">Это новое свойство может быть задано на уровне страницы или элемента управления и позволяет отключать состояние представления по умолчанию для страницы и включать его только для элементов управления, которым она нужна.</span><span class="sxs-lookup"><span data-stu-id="7fd79-172">This new property can be set at the page or control level, and it enables you to disable view state by default for a page and enable it only for controls that need it.</span></span>

<span data-ttu-id="7fd79-173">Для приложений, в которых важна производительность, рекомендуется всегда отключать состояние просмотра на уровне страницы и включать его только для элементов управления, которым он необходим.</span><span class="sxs-lookup"><span data-stu-id="7fd79-173">For applications where performance is critical, a good practice is to always disable view state at the page level and enable it only for controls that require it.</span></span> <span data-ttu-id="7fd79-174">Размер представления на страницах университета Contoso не был существенно уменьшен с помощью этого метода, но чтобы увидеть, как он работает, вы сделаете это на странице *инструкторы. aspx* .</span><span class="sxs-lookup"><span data-stu-id="7fd79-174">The size of view state in the Contoso University pages wouldn't be substantially decreased by this method, but to see how it works, you'll do it for the *Instructors.aspx* page.</span></span> <span data-ttu-id="7fd79-175">Эта страница содержит множество элементов управления, в том числе элемент управления `Label` с отключенным состоянием представления.</span><span class="sxs-lookup"><span data-stu-id="7fd79-175">That page contains many controls, including a `Label` control that has view state disabled.</span></span> <span data-ttu-id="7fd79-176">Ни один из элементов управления на этой странице не должен включать состояние просмотра.</span><span class="sxs-lookup"><span data-stu-id="7fd79-176">None of the controls on this page actually need to have view state enabled.</span></span> <span data-ttu-id="7fd79-177">(Свойство `DataKeyNames` элемента управления `GridView` указывает состояние, которое должно поддерживаться между обратными передачами, но эти значения хранятся в состоянии элемента управления, которое не зависит от свойства `ViewStateMode`.)</span><span class="sxs-lookup"><span data-stu-id="7fd79-177">(The `DataKeyNames` property of the `GridView` control specifies state that must be maintained between postbacks, but these values are kept in control state, which isn't affected by the `ViewStateMode` property.)</span></span>

<span data-ttu-id="7fd79-178">Директива `Page` и разметка элемента управления `Label` в данный момент напоминает следующий пример:</span><span class="sxs-lookup"><span data-stu-id="7fd79-178">The `Page` directive and `Label` control markup currently resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="7fd79-179">Выполните следующие изменения:</span><span class="sxs-lookup"><span data-stu-id="7fd79-179">Make the following changes:</span></span>

- <span data-ttu-id="7fd79-180">Добавьте `ViewStateMode="Disabled"` в директиву `Page`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-180">Add `ViewStateMode="Disabled"` to the `Page` directive.</span></span>
- <span data-ttu-id="7fd79-181">Удалите `ViewStateMode="Disabled"` из элемента управления `Label`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-181">Remove `ViewStateMode="Disabled"` from the `Label` control.</span></span>

<span data-ttu-id="7fd79-182">Теперь разметка напоминает следующий пример:</span><span class="sxs-lookup"><span data-stu-id="7fd79-182">The markup now resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="7fd79-183">Состояние представления теперь отключено для всех элементов управления.</span><span class="sxs-lookup"><span data-stu-id="7fd79-183">View state is now disabled for all controls.</span></span> <span data-ttu-id="7fd79-184">Если позднее добавить элемент управления, который должен использовать состояние представления, то все, что нужно, — это включить атрибут `ViewStateMode="Enabled"` для этого элемента управления.</span><span class="sxs-lookup"><span data-stu-id="7fd79-184">If you later add a control that does need to use view state, all you need to do is include the `ViewStateMode="Enabled"` attribute for that control.</span></span>

## <a name="using-the-notracking-merge-option"></a><span data-ttu-id="7fd79-185">Использование параметра слияния with Tracking</span><span class="sxs-lookup"><span data-stu-id="7fd79-185">Using The NoTracking Merge Option</span></span>

<span data-ttu-id="7fd79-186">Когда контекст объекта получает строки базы данных и создает объекты сущностей, которые их представляют, по умолчанию они также отслеживают эти объекты сущностей с помощью диспетчера состояний объектов.</span><span class="sxs-lookup"><span data-stu-id="7fd79-186">When an object context retrieves database rows and creates entity objects that represent them, by default it also tracks those entity objects using its object state manager.</span></span> <span data-ttu-id="7fd79-187">Эти данные отслеживания действуют как кэш и используются при обновлении сущности.</span><span class="sxs-lookup"><span data-stu-id="7fd79-187">This tracking data acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="7fd79-188">Так как веб-приложение обычно имеет кратковременные экземпляры контекста объектов, запросы часто возвращают данные, которые не нужно относить, так как контекст объекта, считывающий их, будет удален до тех пор, пока не будут использованы операции чтения.</span><span class="sxs-lookup"><span data-stu-id="7fd79-188">Because a web application typically has short-lived object context instances, queries often return data that doesn't need to be tracked, because the object context that reads them will be disposed before any of the entities it reads are used again or updated.</span></span>

<span data-ttu-id="7fd79-189">В Entity Framework можно указать, будет ли контекст объекта отслеживать объекты сущностей, установив *параметр слияния*.</span><span class="sxs-lookup"><span data-stu-id="7fd79-189">In the Entity Framework, you can specify whether the object context tracks entity objects by setting a *merge option*.</span></span> <span data-ttu-id="7fd79-190">Параметр MERGE можно задать для отдельных запросов или для наборов сущностей.</span><span class="sxs-lookup"><span data-stu-id="7fd79-190">You can set the merge option for individual queries or for entity sets.</span></span> <span data-ttu-id="7fd79-191">Если задать его для набора сущностей, то это означает, что вы устанавливаете параметр слияния по умолчанию для всех запросов, создаваемых для этого набора сущностей.</span><span class="sxs-lookup"><span data-stu-id="7fd79-191">If you set it for an entity set, that means that you're setting the default merge option for all queries that are created for that entity set.</span></span>

<span data-ttu-id="7fd79-192">Для приложения университета Contoso отслеживание не требуется для всех наборов сущностей, доступ к которым осуществляется из репозитория, поэтому можно установить параметр слияния для `NoTracking` этих наборов сущностей при создании экземпляра контекста объекта в классе репозитория.</span><span class="sxs-lookup"><span data-stu-id="7fd79-192">For the Contoso University application, tracking isn't needed for any of the entity sets that you access from the repository, so you can set the merge option to `NoTracking` for those entity sets when you instantiate the object context in the repository class.</span></span> <span data-ttu-id="7fd79-193">(Обратите внимание, что в этом руководстве Установка параметра слияния не оказывает заметного влияния на производительность приложения.</span><span class="sxs-lookup"><span data-stu-id="7fd79-193">(Note that in this tutorial, setting the merge option won't have a noticeable effect on the application's performance.</span></span> <span data-ttu-id="7fd79-194">Параметр `NoTracking`, скорее всего, сделает наблюдаемое улучшение производительности только в определенных сценариях с большими объемами данных.)</span><span class="sxs-lookup"><span data-stu-id="7fd79-194">The `NoTracking` option is likely to make an observable performance improvement only in certain high-data-volume scenarios.)</span></span>

<span data-ttu-id="7fd79-195">В папке DAL откройте файл *SchoolRepository.CS* и добавьте метод-конструктор, который задает параметр Merge для наборов сущностей, к которым обращается репозиторий:</span><span class="sxs-lookup"><span data-stu-id="7fd79-195">In the DAL folder, open the *SchoolRepository.cs* file and add a constructor method that sets the merge option for the entity sets that the repository accesses:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

## <a name="pre-compiling-linq-queries"></a><span data-ttu-id="7fd79-196">Предварительная компиляция запросов LINQ</span><span class="sxs-lookup"><span data-stu-id="7fd79-196">Pre-Compiling LINQ Queries</span></span>

<span data-ttu-id="7fd79-197">В первый раз, когда Entity Framework выполняет Entity SQL запрос в течение жизненного цикла данного экземпляра `ObjectContext`, компиляция запроса занимает некоторое время.</span><span class="sxs-lookup"><span data-stu-id="7fd79-197">The first time that the Entity Framework executes an Entity SQL query within the life of a given `ObjectContext` instance, it takes some time to compile the query.</span></span> <span data-ttu-id="7fd79-198">Результат компиляции кэшируется, что означает, что последующие выполнения запроса выполняются гораздо быстрее.</span><span class="sxs-lookup"><span data-stu-id="7fd79-198">The result of compilation is cached, which means that subsequent executions of the query are much quicker.</span></span> <span data-ttu-id="7fd79-199">Запросы LINQ соответствуют аналогичному шаблону, за исключением того, что некоторые операции, необходимые для компиляции запроса, выполняются при каждом выполнении запроса.</span><span class="sxs-lookup"><span data-stu-id="7fd79-199">LINQ queries follow a similar pattern, except that some of the work required to compile the query is done every time the query is executed.</span></span> <span data-ttu-id="7fd79-200">Иными словами, для запросов LINQ по умолчанию кэшируются не все результаты компиляции.</span><span class="sxs-lookup"><span data-stu-id="7fd79-200">In other words, for LINQ queries, by default not all of the results of compilation are cached.</span></span>

<span data-ttu-id="7fd79-201">При наличии запроса LINQ, который будет повторяться в течение всего времени существования контекста объекта, можно написать код, который вызывает кэширование всех результатов компиляции при первом выполнении запроса LINQ.</span><span class="sxs-lookup"><span data-stu-id="7fd79-201">If you have a LINQ query that you expect to run repeatedly in the life of an object context, you can write code that causes all of the results of compilation to be cached the first time the LINQ query is run.</span></span>

<span data-ttu-id="7fd79-202">Как показано на рисунке, это делается для двух `Get` методов в классе `SchoolRepository`, один из которых не принимает никаких параметров (метод `GetInstructorNames`) и один, для которого требуется параметр (метод `GetDepartmentsByAdministrator`).</span><span class="sxs-lookup"><span data-stu-id="7fd79-202">As an illustration, you'll do this for two `Get` methods in the `SchoolRepository` class, one of which doesn't take any parameters (the `GetInstructorNames` method), and one that does require a parameter (the `GetDepartmentsByAdministrator` method).</span></span> <span data-ttu-id="7fd79-203">Эти методы, в действительности, не должны компилироваться, так как они не являются запросами LINQ:</span><span class="sxs-lookup"><span data-stu-id="7fd79-203">These methods as they stand now actually don't need to be compiled because they aren't LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

<span data-ttu-id="7fd79-204">Однако, чтобы можно было испытать скомпилированные запросы, вы продолжите, как если бы они были написаны в виде следующих запросов LINQ:</span><span class="sxs-lookup"><span data-stu-id="7fd79-204">However, so that you can try out compiled queries, you'll proceed as if these had been written as the following LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="7fd79-205">Вы можете изменить код в этих методах на показанный выше и запустить приложение, чтобы убедиться, что оно работает, прежде чем продолжить.</span><span class="sxs-lookup"><span data-stu-id="7fd79-205">You could change the code in these methods to what's shown above and run the application to verify that it works before continuing.</span></span> <span data-ttu-id="7fd79-206">Но приведенные ниже инструкции позволяют сразу перейти к созданию предварительно скомпилированных версий.</span><span class="sxs-lookup"><span data-stu-id="7fd79-206">But the following instructions jump right into creating pre-compiled versions of them.</span></span>

<span data-ttu-id="7fd79-207">Создайте файл класса в папке *DAL* , назовите его *SchoolEntities.CS*и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="7fd79-207">Create a class file in the *DAL* folder, name it *SchoolEntities.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="7fd79-208">Этот код создает разделяемый класс, расширяющий автоматически созданный класс контекста объекта.</span><span class="sxs-lookup"><span data-stu-id="7fd79-208">This code creates a partial class that extends the automatically generated object context class.</span></span> <span data-ttu-id="7fd79-209">Разделяемый класс включает два скомпилированных запроса LINQ с помощью метода `Compile` класса `CompiledQuery`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-209">The partial class includes two compiled LINQ queries using the `Compile` method of the `CompiledQuery` class.</span></span> <span data-ttu-id="7fd79-210">Он также создает методы, которые можно использовать для вызова запросов.</span><span class="sxs-lookup"><span data-stu-id="7fd79-210">It also creates methods that you can use to call the queries.</span></span> <span data-ttu-id="7fd79-211">Сохраните и закройте этот файл.</span><span class="sxs-lookup"><span data-stu-id="7fd79-211">Save and close this file.</span></span>

<span data-ttu-id="7fd79-212">Затем в *SchoolRepository.CS*измените существующие методы `GetInstructorNames` и `GetDepartmentsByAdministrator` в классе репозитория так, чтобы они вызывали скомпилированные запросы:</span><span class="sxs-lookup"><span data-stu-id="7fd79-212">Next, in *SchoolRepository.cs*, change the existing `GetInstructorNames` and `GetDepartmentsByAdministrator` methods in the repository class so that they call the compiled queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

<span data-ttu-id="7fd79-213">Запустите страницу *departmentss. aspx* , чтобы убедиться, что она работает, как и раньше.</span><span class="sxs-lookup"><span data-stu-id="7fd79-213">Run the *Departments.aspx* page to verify that it works as it did before.</span></span> <span data-ttu-id="7fd79-214">Метод `GetInstructorNames` вызывается для заполнения раскрывающегося списка администратором, а метод `GetDepartmentsByAdministrator` вызывается при нажатии кнопки **Обновить** , чтобы убедиться, что ни один из преподавателей не является администратором нескольких отделов.</span><span class="sxs-lookup"><span data-stu-id="7fd79-214">The `GetInstructorNames` method is called in order to populate the administrator drop-down list, and the `GetDepartmentsByAdministrator` method is called when you click **Update** in order to verify that no instructor is an administrator of more than one department.</span></span>

<span data-ttu-id="7fd79-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

<span data-ttu-id="7fd79-216">Вы выполнили предварительно скомпилированные запросы в приложении Contoso университета, чтобы узнать, как это сделать, не так как это значительно улучшает бы повысить производительность.</span><span class="sxs-lookup"><span data-stu-id="7fd79-216">You've pre-compiled queries in the Contoso University application only to see how to do it, not because it would measurably improve performance.</span></span> <span data-ttu-id="7fd79-217">Предварительная компиляция запросов LINQ добавляет к коду уровень сложности, поэтому убедитесь, что он выполняется только для запросов, которые представляют узкие места производительности в приложении.</span><span class="sxs-lookup"><span data-stu-id="7fd79-217">Pre-compiling LINQ queries does add a level of complexity to your code, so make sure you do it only for queries that actually represent performance bottlenecks in your application.</span></span>

## <a name="examining-queries-sent-to-the-database"></a><span data-ttu-id="7fd79-218">Проверка запросов, отправленных в базу данных</span><span class="sxs-lookup"><span data-stu-id="7fd79-218">Examining Queries Sent to the Database</span></span>

<span data-ttu-id="7fd79-219">При изучении проблем с производительностью иногда бывает полезно определить точные команды SQL, отправляемые Entity Framework в базу данных.</span><span class="sxs-lookup"><span data-stu-id="7fd79-219">When you're investigating performance issues, sometimes it's helpful to know the exact SQL commands that the Entity Framework is sending to the database.</span></span> <span data-ttu-id="7fd79-220">Если вы работаете с объектом `IQueryable`, одним из способов сделать это является использование метода `ToTraceString`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-220">If you're working with an `IQueryable` object, one way to do this is to use the `ToTraceString` method.</span></span>

<span data-ttu-id="7fd79-221">В *SchoolRepository.CS*измените код в методе `GetDepartmentsByName` в соответствии со следующим примером:</span><span class="sxs-lookup"><span data-stu-id="7fd79-221">In *SchoolRepository.cs*, change the code in the `GetDepartmentsByName` method to match the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.cs)]

<span data-ttu-id="7fd79-222">`departments` переменная должна быть приведена к типу `ObjectQuery` только потому, что метод `Where` в конце предыдущей строки создает объект `IQueryable`. без метода `Where` приведение не потребуется.</span><span class="sxs-lookup"><span data-stu-id="7fd79-222">The `departments` variable must be cast to an `ObjectQuery` type only because the `Where` method at the end of the preceding line creates an `IQueryable` object; without the `Where` method, the cast would not be necessary.</span></span>

<span data-ttu-id="7fd79-223">Установите точку останова на `return` строке, а затем запустите страницу *departmentss. aspx* в отладчике.</span><span class="sxs-lookup"><span data-stu-id="7fd79-223">Set a breakpoint on the `return` line, and then run the *Departments.aspx* page in the debugger.</span></span> <span data-ttu-id="7fd79-224">При достижении точки останова изучите переменную `commandText` в окне **локальные** и используйте визуализатор текста (лупа в столбце **значение** ), чтобы отобразить его значение в окне **визуализатора текста** .</span><span class="sxs-lookup"><span data-stu-id="7fd79-224">When you hit the breakpoint, examine the `commandText` variable in the **Locals** window and use the text visualizer (the magnifying glass in the **Value** column) to display its value in the **Text Visualizer** window.</span></span> <span data-ttu-id="7fd79-225">Можно увидеть всю команду SQL, полученную в результате этого кода:</span><span class="sxs-lookup"><span data-stu-id="7fd79-225">You can see the entire SQL command that results from this code:</span></span>

<span data-ttu-id="7fd79-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="7fd79-227">В качестве альтернативы функция IntelliTrace в Visual Studio Ultimate предоставляет способ просмотра команд SQL, созданных Entity Framework, которые не нуждаются в изменении кода или даже задании точки останова.</span><span class="sxs-lookup"><span data-stu-id="7fd79-227">As an alternative, the IntelliTrace feature in Visual Studio Ultimate provides a way to view SQL commands generated by the Entity Framework that doesn't require you to change your code or even set a breakpoint.</span></span>

> [!NOTE]
> <span data-ttu-id="7fd79-228">Следующие процедуры можно выполнять только в том случае, если у вас Visual Studio Ultimate.</span><span class="sxs-lookup"><span data-stu-id="7fd79-228">You can perform the following procedures only if you have Visual Studio Ultimate.</span></span>

<span data-ttu-id="7fd79-229">Восстановите исходный код в методе `GetDepartmentsByName`, а затем запустите страницу *departmentss. aspx* в отладчике.</span><span class="sxs-lookup"><span data-stu-id="7fd79-229">Restore the original code in the `GetDepartmentsByName` method, and then run the *Departments.aspx* page in the debugger.</span></span>

<span data-ttu-id="7fd79-230">В Visual Studio выберите меню **Отладка** , затем **IntelliTrace**, а затем **события IntelliTrace**.</span><span class="sxs-lookup"><span data-stu-id="7fd79-230">In Visual Studio, select the **Debug** menu, then **IntelliTrace**, and then **IntelliTrace Events**.</span></span>

<span data-ttu-id="7fd79-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="7fd79-232">В окне **IntelliTrace** щелкните **прервать все**.</span><span class="sxs-lookup"><span data-stu-id="7fd79-232">In the **IntelliTrace** window, click **Break All**.</span></span>

<span data-ttu-id="7fd79-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="7fd79-234">В окне **IntelliTrace** отображается список недавних событий:</span><span class="sxs-lookup"><span data-stu-id="7fd79-234">The **IntelliTrace** window displays a list of recent events:</span></span>

<span data-ttu-id="7fd79-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="7fd79-236">Щелкните строку **ADO.NET** .</span><span class="sxs-lookup"><span data-stu-id="7fd79-236">Click the **ADO.NET** line.</span></span> <span data-ttu-id="7fd79-237">Он разворачивается для отображения текста команды:</span><span class="sxs-lookup"><span data-stu-id="7fd79-237">It expands to show you the command text:</span></span>

<span data-ttu-id="7fd79-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="7fd79-239">Вы можете скопировать всю строку текста команды в буфер обмена из окна **локальные** .</span><span class="sxs-lookup"><span data-stu-id="7fd79-239">You can copy the entire command text string to the clipboard from the **Locals** window.</span></span>

<span data-ttu-id="7fd79-240">Предположим, что вы работали с базой данных с большим количеством таблиц, связей и столбцов, чем у простой `School` базы данных.</span><span class="sxs-lookup"><span data-stu-id="7fd79-240">Suppose you were working with a database with more tables, relationships, and columns than the simple `School` database.</span></span> <span data-ttu-id="7fd79-241">Может оказаться, что запрос, собирающий всю необходимую информацию в одной `Select` инструкции, содержащей несколько `Join`ных предложений, станет слишком сложной для эффективной работы.</span><span class="sxs-lookup"><span data-stu-id="7fd79-241">You might find that a query that gathers all the information you need in a single `Select` statement containing multiple `Join` clauses becomes too complex to work efficiently.</span></span> <span data-ttu-id="7fd79-242">В этом случае можно переключиться с безотлагательной загрузки на явную загрузку, чтобы упростить запрос.</span><span class="sxs-lookup"><span data-stu-id="7fd79-242">In that case you can switch from eager loading to explicit loading to simplify the query.</span></span>

<span data-ttu-id="7fd79-243">Например, попробуйте изменить код в методе `GetDepartmentsByName` в *SchoolRepository.CS*.</span><span class="sxs-lookup"><span data-stu-id="7fd79-243">For example, try changing the code in the `GetDepartmentsByName` method in *SchoolRepository.cs*.</span></span> <span data-ttu-id="7fd79-244">В настоящее время в этом методе имеется запрос объектов, который содержит `Include` методы для свойств навигации `Person` и `Courses`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-244">Currently in that method you have an object query that has `Include` methods for the `Person` and `Courses` navigation properties.</span></span> <span data-ttu-id="7fd79-245">Замените инструкцию `return` кодом, который выполняет явную загрузку, как показано в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="7fd79-245">Replace the `return` statement with code that performs explicit loading, as shown in the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="7fd79-246">Запустите страницу *departmentss. aspx* в отладчике и снова проверьте окно **IntelliTrace** .</span><span class="sxs-lookup"><span data-stu-id="7fd79-246">Run the *Departments.aspx* page in the debugger and check the **IntelliTrace** window again as you did before.</span></span> <span data-ttu-id="7fd79-247">Теперь, когда ранее существовал один запрос, вы увидите их длинную последовательность.</span><span class="sxs-lookup"><span data-stu-id="7fd79-247">Now, where there was a single query before, you see a long sequence of them.</span></span>

<span data-ttu-id="7fd79-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="7fd79-249">Щелкните первую строку **ADO.NET** , чтобы увидеть, что произошло с сложным запросом, который вы просматривали ранее.</span><span class="sxs-lookup"><span data-stu-id="7fd79-249">Click the first **ADO.NET** line to see what has happened to the complex query you viewed earlier.</span></span>

<span data-ttu-id="7fd79-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

<span data-ttu-id="7fd79-251">Запрос из отделов стал простым `Select`ным запросом без предложения `Join`, но за ним следуют отдельные запросы, которые извлекают связанные курсы и администратора, используя набор из двух запросов для каждого отдела, возвращенного исходным запросом.</span><span class="sxs-lookup"><span data-stu-id="7fd79-251">The query from Departments has become a simple `Select` query with no `Join` clause, but it's followed by separate queries that retrieve related courses and an administrator, using a set of two queries for each department returned by the original query.</span></span>

> [!NOTE]
> <span data-ttu-id="7fd79-252">Если вы оставляете отложенную загрузку, то шаблон, который вы видите здесь, с тем же запросом повторяется несколько раз, может быть результатом отложенной загрузки.</span><span class="sxs-lookup"><span data-stu-id="7fd79-252">If you leave lazy loading enabled, the pattern you see here, with the same query repeated many times, might result from lazy loading.</span></span> <span data-ttu-id="7fd79-253">Шаблон, который, как правило, следует избегать, — это данные, связанные с отложенной загрузкой для каждой строки основной таблицы.</span><span class="sxs-lookup"><span data-stu-id="7fd79-253">A pattern that you typically want to avoid is lazy-loading related data for every row of the primary table.</span></span> <span data-ttu-id="7fd79-254">Если вы не прошли проверку того, что один запрос на соединение слишком сложен, чтобы быть эффективным, вы, как правило, сможете повысить производительность в таких случаях, изменив основной запрос для использования безотлагательной загрузки.</span><span class="sxs-lookup"><span data-stu-id="7fd79-254">Unless you've verified that a single join query is too complex to be efficient, you'd typically be able to improve performance in such cases by changing the primary query to use eager loading.</span></span>

## <a name="pre-generating-views"></a><span data-ttu-id="7fd79-255">Предварительное создание представлений</span><span class="sxs-lookup"><span data-stu-id="7fd79-255">Pre-Generating Views</span></span>

<span data-ttu-id="7fd79-256">Когда объект `ObjectContext` впервые создается в новом домене приложения, Entity Framework создает набор классов, используемых для доступа к базе данных.</span><span class="sxs-lookup"><span data-stu-id="7fd79-256">When an `ObjectContext` object is first created in a new application domain, the Entity Framework generates a set of classes that it uses to access the database.</span></span> <span data-ttu-id="7fd79-257">Эти классы называются *представлениями*. при наличии очень большой модели данных создание этих представлений может замедлить ответ веб-сайта на первый запрос страницы после инициализации нового домена приложения.</span><span class="sxs-lookup"><span data-stu-id="7fd79-257">These classes are called *views*, and if you have a very large data model, generating these views can delay the web site's response to the first request for a page after a new application domain is initialized.</span></span> <span data-ttu-id="7fd79-258">Эту задержку первого запроса можно сократить, создав представления во время компиляции, а не во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="7fd79-258">You can reduce this first-request delay by creating the views at compile time rather than at run time.</span></span>

> [!NOTE]
> <span data-ttu-id="7fd79-259">Если приложение не имеет чрезвычайно большой модели данных или имеет большую модель данных, но вы не беспокоитесь о проблеме с производительностью, которая влияет только на самый первый запрос страницы после перезапуска IIS, этот раздел можно пропустить.</span><span class="sxs-lookup"><span data-stu-id="7fd79-259">If your application doesn't have an extremely large data model, or if it does have a large data model but you aren't concerned about a performance problem that affects only the very first page request after IIS is recycled, you can skip this section.</span></span> <span data-ttu-id="7fd79-260">Создание представления не происходит при каждом создании экземпляра объекта `ObjectContext`, так как представления кэшируются в домене приложения.</span><span class="sxs-lookup"><span data-stu-id="7fd79-260">View creation doesn't happen every time you instantiate an `ObjectContext` object, because the views are cached in the application domain.</span></span> <span data-ttu-id="7fd79-261">Таким образом, если вы часто не используете приложение в IIS, очень небольшое количество запросов страниц может оказаться выгодным для предварительно созданных представлений.</span><span class="sxs-lookup"><span data-stu-id="7fd79-261">Therefore, unless you're frequently recycling your application in IIS, very few page requests would benefit from pre-generated views.</span></span>

<span data-ttu-id="7fd79-262">Представления можно предварительно создавать с помощью программы командной строки *EdmGen. exe* или шаблона средства *преобразования текстовых шаблонов* (T4).</span><span class="sxs-lookup"><span data-stu-id="7fd79-262">You can pre-generate views using the *EdmGen.exe* command-line tool or by using a *Text Template Transformation Toolkit* (T4) template.</span></span> <span data-ttu-id="7fd79-263">В этом учебнике используется шаблон T4.</span><span class="sxs-lookup"><span data-stu-id="7fd79-263">In this tutorial you'll use a T4 template.</span></span>

<span data-ttu-id="7fd79-264">В папке *DAL* добавьте файл с помощью шаблона **текстового шаблона** (он находится в узле **Общие** в списке **установленные шаблоны** ) и назовите его *SchoolModel.views.TT*.</span><span class="sxs-lookup"><span data-stu-id="7fd79-264">In the *DAL* folder, add a file using the **Text Template** template (it's under the **General** node in the **Installed Templates** list), and name it *SchoolModel.Views.tt*.</span></span> <span data-ttu-id="7fd79-265">Замените существующий код в файле следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="7fd79-265">Replace the existing code in the file with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

<span data-ttu-id="7fd79-266">Этот код создает представления для файла *EDMX* , расположенного в той же папке, что и шаблон, и имеет то же имя, что и файл шаблона.</span><span class="sxs-lookup"><span data-stu-id="7fd79-266">This code generates views for an *.edmx* file that's located in the same folder as the template and that has the same name as the template file.</span></span> <span data-ttu-id="7fd79-267">Например, если файл шаблона называется *SchoolModel.views.TT*, он будет искать файл модели данных с именем *счулмодел. EDMX*.</span><span class="sxs-lookup"><span data-stu-id="7fd79-267">For example, if your template file is named *SchoolModel.Views.tt*, it will look for a data model file named *SchoolModel.edmx*.</span></span>

<span data-ttu-id="7fd79-268">Сохраните файл, щелкните его правой кнопкой мыши в **Обозреватель решений** и выберите пункт **запустить настраиваемый инструмент**.</span><span class="sxs-lookup"><span data-stu-id="7fd79-268">Save the file, then right-click the file in **Solution Explorer** and select **Run Custom Tool**.</span></span>

<span data-ttu-id="7fd79-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="7fd79-270">Visual Studio создает файл кода, который создает представления с именем *SchoolModel.views.CS* на основе шаблона.</span><span class="sxs-lookup"><span data-stu-id="7fd79-270">Visual Studio generates a code file that creates the views, which is named *SchoolModel.Views.cs* based on the template.</span></span> <span data-ttu-id="7fd79-271">(Возможно, вы заметили, что файл кода создается даже перед нажатием на кнопку **Запустить пользовательский инструмент**, как только вы сохраните файл шаблона.)</span><span class="sxs-lookup"><span data-stu-id="7fd79-271">(You might have noticed that the code file is generated even before you select **Run Custom Tool**, as soon as you save the template file.)</span></span>

<span data-ttu-id="7fd79-272">[![image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="7fd79-272">[![Image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="7fd79-273">Теперь можно запустить приложение и убедиться, что оно работает, как было раньше.</span><span class="sxs-lookup"><span data-stu-id="7fd79-273">You can now run the application and verify that it works as it did before.</span></span>

<span data-ttu-id="7fd79-274">Дополнительные сведения о предварительно созданных представлениях см. в следующих ресурсах:</span><span class="sxs-lookup"><span data-stu-id="7fd79-274">For more information about pre-generated views, see the following resources:</span></span>

- <span data-ttu-id="7fd79-275">[Пошаговое руководство. Предварительное создание представлений для повышения производительности запросов](https://msdn.microsoft.com/library/bb896240.aspx) на веб-сайте MSDN.</span><span class="sxs-lookup"><span data-stu-id="7fd79-275">[How to: Pre-Generate Views to Improve Query Performance](https://msdn.microsoft.com/library/bb896240.aspx) on the MSDN web site.</span></span> <span data-ttu-id="7fd79-276">Объясняется, как использовать средство командной строки `EdmGen.exe` для предварительного создания представлений.</span><span class="sxs-lookup"><span data-stu-id="7fd79-276">Explains how to use the `EdmGen.exe` command-line tool to pre-generate views.</span></span>
- <span data-ttu-id="7fd79-277">[Изоляция производительности с предкомпилированными или предварительно созданными представлениями в Entity Framework 4](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx) в блоге группы консультирования клиентов Windows Server AppFabric.</span><span class="sxs-lookup"><span data-stu-id="7fd79-277">[Isolating Performance with Precompiled/Pre-generated Views in the Entity Framework 4](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx) on the Windows Server AppFabric Customer Advisory Team blog.</span></span>

<span data-ttu-id="7fd79-278">Это завершает вводные сведения о повышении производительности веб-приложения ASP.NET, использующего Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="7fd79-278">This completes the introduction to improving performance in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="7fd79-279">Для получения дополнительных сведений см. следующие ресурсы:</span><span class="sxs-lookup"><span data-stu-id="7fd79-279">For more information, see the following resources:</span></span>

- <span data-ttu-id="7fd79-280">[Рекомендации по производительности (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) на веб-сайте MSDN.</span><span class="sxs-lookup"><span data-stu-id="7fd79-280">[Performance Considerations (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) on the MSDN web site.</span></span>
- <span data-ttu-id="7fd79-281">[Записи, связанные с производительностью, в блоге Entity Framework Team](https://blogs.msdn.com/b/adonet/archive/tags/performance/).</span><span class="sxs-lookup"><span data-stu-id="7fd79-281">[Performance-related posts on the Entity Framework Team blog](https://blogs.msdn.com/b/adonet/archive/tags/performance/).</span></span>
- <span data-ttu-id="7fd79-282">[Параметры слияния EF и скомпилированные запросы](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx).</span><span class="sxs-lookup"><span data-stu-id="7fd79-282">[EF Merge Options and Compiled Queries](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx).</span></span> <span data-ttu-id="7fd79-283">Запись блога, объясняющая непредвиденное поведение скомпилированных запросов и параметров слияния, таких как `NoTracking`.</span><span class="sxs-lookup"><span data-stu-id="7fd79-283">Blog post that explains unexpected behaviors of compiled queries and merge options such as `NoTracking`.</span></span> <span data-ttu-id="7fd79-284">Если вы планируете использовать скомпилированные запросы или манипулировать параметрами слияния в приложении, сначала прочтите этот параметр.</span><span class="sxs-lookup"><span data-stu-id="7fd79-284">If you plan to use compiled queries or manipulate merge option settings in your application, read this first.</span></span>
- <span data-ttu-id="7fd79-285">Записи, [связанные с Entity Framework, в блоге группы консультирования по клиентам данных и моделирования](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/).</span><span class="sxs-lookup"><span data-stu-id="7fd79-285">[Entity Framework-related posts in the Data and Modeling Customer Advisory Team blog](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/).</span></span> <span data-ttu-id="7fd79-286">Включает записи в скомпилированные запросы и использование профилировщика Visual Studio 2010 для обнаружения проблем с производительностью.</span><span class="sxs-lookup"><span data-stu-id="7fd79-286">Includes posts on compiled queries and using the Visual Studio 2010 Profiler to discover performance issues.</span></span>
- <span data-ttu-id="7fd79-287">[Entity Framework обсуждение с рекомендациями по повышению производительности запросов с высокой степенью сложности](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6).</span><span class="sxs-lookup"><span data-stu-id="7fd79-287">[Entity Framework forum thread with advice on improving performance of highly complex queries](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6).</span></span>
- <span data-ttu-id="7fd79-288">[Рекомендации по управлению состоянием ASP.NET](https://msdn.microsoft.com/library/z1hkazw7.aspx).</span><span class="sxs-lookup"><span data-stu-id="7fd79-288">[ASP.NET State Management Recommendations](https://msdn.microsoft.com/library/z1hkazw7.aspx).</span></span>
- <span data-ttu-id="7fd79-289">[С помощью Entity Framework и элемента ObjectDataSource: Custom paging](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx).</span><span class="sxs-lookup"><span data-stu-id="7fd79-289">[Using the Entity Framework and the ObjectDataSource: Custom Paging](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx).</span></span> <span data-ttu-id="7fd79-290">Запись блога, которая основана на приложении ContosoUniversity, созданном в этих руководствах, чтобы объяснить, как реализовать разбиение на страницы на странице *Departments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="7fd79-290">Blog post that builds on the ContosoUniversity application created in these tutorials to explain how to implement paging in the *Departments.aspx* page.</span></span>

<span data-ttu-id="7fd79-291">В следующем учебнике рассматриваются некоторые важные улучшения Entity Framework, новые в версии 4.</span><span class="sxs-lookup"><span data-stu-id="7fd79-291">The next tutorial reviews some of the important enhancements to the Entity Framework that are new in version 4.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="7fd79-292">[Назад](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
> [Вперед](what-s-new-in-the-entity-framework-4.md)</span><span class="sxs-lookup"><span data-stu-id="7fd79-292">[Previous](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
[Next](what-s-new-in-the-entity-framework-4.md)</span></span>
