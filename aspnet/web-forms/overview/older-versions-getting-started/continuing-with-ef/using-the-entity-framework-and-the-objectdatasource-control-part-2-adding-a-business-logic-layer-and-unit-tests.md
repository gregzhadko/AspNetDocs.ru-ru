---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: С помощью Entity Framework 4,0 и элемента управления ObjectDataSource, часть 2. Добавление уровня бизнес-логики и модульных тестов | Документация Майкрософт
author: tdykstra
description: Эта серия руководств основана на веб-приложении университета Contoso, которое создается начало работы с руководством по Entity Framework 4,0. Он...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: 24344cc33d7c26d7c408db26c0530ef2c708a7d3
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78439956"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="2f0ca-104">Использование Entity Framework 4,0 и элемента управления ObjectDataSource, часть 2. Добавление уровня бизнес-логики и модульных тестов</span><span class="sxs-lookup"><span data-stu-id="2f0ca-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>

<span data-ttu-id="2f0ca-105">от [Tom Dykstra)](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="2f0ca-106">Эта серия руководств основана на веб-приложении университета Contoso, которое создается [Начало работы с руководством по Entity Framework 4,0](https://asp.net/entity-framework/tutorials#Getting%20Started) .</span><span class="sxs-lookup"><span data-stu-id="2f0ca-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="2f0ca-107">Если вы не выполнили предыдущие учебники, в качестве отправной точки для этого учебника вы можете скачать созданное [приложение](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) .</span><span class="sxs-lookup"><span data-stu-id="2f0ca-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="2f0ca-108">Вы также можете [скачать приложение](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , созданное с помощью полной серии руководств.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="2f0ca-109">Если у вас есть вопросы о учебниках, их можно опубликовать на [форуме ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="2f0ca-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="2f0ca-110">В предыдущем учебном курсе было создано n-уровневое веб-приложение с помощью Entity Framework и элемента управления `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="2f0ca-111">В этом учебнике показано, как добавить бизнес-логику, разделив уровень бизнес-логики (BLL) и уровень доступа к данным (DAL), и покажет, как создавать автоматические модульные тесты для слоя BLL.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="2f0ca-112">В этом учебнике вы выполните следующие задачи:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="2f0ca-113">Создайте интерфейс репозитория, объявляющий необходимые методы доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="2f0ca-114">Реализуйте интерфейс репозитория в классе репозитория.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="2f0ca-115">Создайте класс бизнес-логики, который вызывает класс репозитория для выполнения функций доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="2f0ca-116">Подключите элемент управления `ObjectDataSource` к классу бизнес-логики, а не к классу репозитория.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="2f0ca-117">Создайте проект модульного теста и класс репозитория, который использует коллекции в памяти для своего хранилища данных.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="2f0ca-118">Создайте модульный тест для бизнес-логики, которую необходимо добавить к классу Business Logic, а затем запустите тест и посмотрите на ошибку.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="2f0ca-119">Реализуйте бизнес-логику в классе логики бизнеса, а затем повторно запустите модульный тест и посмотрите на него.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="2f0ca-120">Вы будете работать с страницами *Departments. aspx* и *департментсадд. aspx* , созданными в предыдущем руководстве.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="2f0ca-121">Создание интерфейса репозитория</span><span class="sxs-lookup"><span data-stu-id="2f0ca-121">Creating a Repository Interface</span></span>

<span data-ttu-id="2f0ca-122">Начнем с создания интерфейса репозитория.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="2f0ca-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="2f0ca-124">В папке *DAL* создайте новый файл класса, назовите его *ISchoolRepository.CS*и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="2f0ca-125">Интерфейс определяет один метод для каждого метода CRUD (создание, чтение, обновление, удаление), созданного в классе репозитория.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="2f0ca-126">В классе `SchoolRepository` в *SchoolRepository.CS*укажите, что этот класс реализует интерфейс `ISchoolRepository`:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="2f0ca-127">Создание класса бизнес-логики</span><span class="sxs-lookup"><span data-stu-id="2f0ca-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="2f0ca-128">Далее предстоит создать класс бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="2f0ca-129">Это можно сделать, чтобы добавить бизнес-логику, которая будет выполняться элементом управления `ObjectDataSource`, хотя это пока не будет сделано.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="2f0ca-130">Сейчас новый класс бизнес-логики будет выполнять те же операции CRUD, что и репозиторий.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="2f0ca-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="2f0ca-132">Создайте новую папку и назовите ее *BLL*.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="2f0ca-133">(В реальном приложении уровень бизнес-логики обычно реализуется как библиотека классов — отдельный проект, но для упрощения этого учебника классы BLL будут храниться в папке проекта.)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="2f0ca-134">В папке *BLL* создайте новый файл класса, назовите его *SchoolBL.CS*и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="2f0ca-135">Этот код создает те же методы CRUD, которые вы видели ранее в классе репозитория, но вместо доступа к методам Entity Framework напрямую он вызывает методы класса репозитория.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="2f0ca-136">Переменная класса, содержащая ссылку на класс репозитория, определяется как тип интерфейса, а код, который создает экземпляр класса репозитория, содержится в двух конструкторах.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="2f0ca-137">Конструктор без параметров будет использоваться элементом управления `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="2f0ca-138">Он создает экземпляр класса `SchoolRepository`, который был создан ранее.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="2f0ca-139">Другой конструктор позволяет любому коду, который создает класс бизнес-логики, передавать любой объект, реализующий интерфейс репозитория.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="2f0ca-140">Методы CRUD, которые вызывают класс репозитория и два конструктора, позволяют использовать класс бизнес-логики с любым выбранным внутренним хранилищем данных.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="2f0ca-141">Классу бизнес-логики не нужно знать, как класс, который он вызывает, сохраняет данные.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="2f0ca-142">(Это часто называется *сохраняемостью игнорирования*.) Это упрощает модульное тестирование, так как вы можете подключить класс бизнес-логики к реализации репозитория, которая использует что-то простое, как `List` коллекции в памяти для хранения данных.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="2f0ca-143">Технически объекты сущностей по-прежнему не поддерживают сохранение — игнорирующих, так как они создаются из классов, наследующих от класса `EntityObject` Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="2f0ca-144">Для полного сохранения игнорирования можно использовать *простые старые объекты CLR*или *POCO*вместо объектов, которые наследуются от класса `EntityObject`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="2f0ca-145">Использование POCO выходит за рамки данного учебника.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="2f0ca-146">Дополнительные сведения см. в разделе [пригодность для тестирования и Entity Framework 4,0](https://msdn.microsoft.com/library/ff714955.aspx) на веб-сайте MSDN.)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>

<span data-ttu-id="2f0ca-147">Теперь можно подключить элементы управления `ObjectDataSource` к классу бизнес-логики, а не к репозиторию и убедиться, что все работает как раньше.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="2f0ca-148">В *Departments. aspx* и *департментсадд. aspx*измените каждое вхождение `TypeName="ContosoUniversity.DAL.SchoolRepository"` на `TypeName="ContosoUniversity.BLL.SchoolBL`".</span><span class="sxs-lookup"><span data-stu-id="2f0ca-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="2f0ca-149">(Существует четыре экземпляра.)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-149">(There are four instances in all.)</span></span>

<span data-ttu-id="2f0ca-150">Запустите страницы *Departments. aspx* и *департментсадд. aspx* , чтобы убедиться, что они все еще работают, как и раньше.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="2f0ca-151">[![image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="2f0ca-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="2f0ca-153">Создание проекта модульных тестов и реализация репозитория</span><span class="sxs-lookup"><span data-stu-id="2f0ca-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="2f0ca-154">Добавьте новый проект в решение с помощью шаблона **тестового проекта** и назовите его `ContosoUniversity.Tests`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="2f0ca-155">В тестовом проекте добавьте ссылку на `System.Data.Entity` и добавьте ссылку на проект `ContosoUniversity`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="2f0ca-156">Теперь можно создать класс репозитория, который будет использоваться с модульными тестами.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="2f0ca-157">Хранилище данных для этого репозитория будет находиться в пределах класса.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="2f0ca-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="2f0ca-159">В тестовом проекте создайте новый файл класса, назовите его *MockSchoolRepository.CS*и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="2f0ca-160">Этот класс репозитория имеет те же методы CRUD, что и тот, который обращается к Entity Framework напрямую, но они работают с `List` коллекциями в памяти, а не с базой данных.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="2f0ca-161">Это упрощает для тестового класса настройку и проверку модульных тестов для класса бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="2f0ca-162">Создание модульных тестов</span><span class="sxs-lookup"><span data-stu-id="2f0ca-162">Creating Unit Tests</span></span>

<span data-ttu-id="2f0ca-163">Шаблон **тестового** проекта создал класс модульного теста-заглушки, и ваша следующая задача — изменить этот класс, добавив в него методы модульного теста для бизнес-логики, которую необходимо добавить в класс Business Logic.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="2f0ca-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="2f0ca-165">В университете Contoso любой отдельный инструктор может быть только администратором одного отдела, и вам нужно добавить бизнес-логику для применения этого правила.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="2f0ca-166">Вы начнете с добавления тестов и выполнения тестов, чтобы увидеть их сбой.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="2f0ca-167">Затем вы добавите код и перезапустите тесты, ожидающие проверки.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="2f0ca-168">Откройте файл *UnitTest1.CS* и добавьте инструкции `using` для уровней бизнес-логики и доступа к данным, созданных в проекте ContosoUniversity:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="2f0ca-169">Замените метод `TestMethod1` следующими методами:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="2f0ca-170">Метод `CreateSchoolBL` создает экземпляр класса репозитория, созданный для проекта модульного теста, который затем передается в новый экземпляр класса бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="2f0ca-171">Затем метод использует класс бизнес-логики для вставки трех отделов, которые можно использовать в методах теста.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="2f0ca-172">Методы теста проверяют, что класс бизнес-логики создает исключение, если кто-то пытается вставить новый отдел с тем же администратором, что и существующий отдел, или если кто-то пытается обновить администратора отдела, указав для него идентификатор человека. кто уже является администратором другого отдела.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="2f0ca-173">Вы еще не создали класс Exception, поэтому этот код не будет компилироваться.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="2f0ca-174">Чтобы скомпилировать его, щелкните правой кнопкой мыши `DuplicateAdministratorException` и выберите **создать**, а затем — **класс**.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="2f0ca-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="2f0ca-176">Будет создан класс в тестовом проекте, который можно удалить после создания класса Exception в основном проекте.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="2f0ca-177">и реализовали бизнес-логику.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-177">and implemented the business logic.</span></span>

<span data-ttu-id="2f0ca-178">Запустите тестовый проект.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-178">Run the test project.</span></span> <span data-ttu-id="2f0ca-179">Как и ожидалось, тесты завершаются ошибкой.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-179">As expected, the tests fail.</span></span>

<span data-ttu-id="2f0ca-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="2f0ca-181">Добавление бизнес-логики для выполнения теста</span><span class="sxs-lookup"><span data-stu-id="2f0ca-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="2f0ca-182">Далее вы реализуете бизнес-логику, которая делает невозможным задание в качестве администратора отдела, который уже является администратором другого отдела.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="2f0ca-183">Исключение создается на уровне бизнес-логики, а затем перехватывается на уровне представления, если пользователь редактирует отдел и нажимает кнопку **Обновить** после выбора пользователя, который уже является администратором.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="2f0ca-184">(Преподаватели можно также удалить из раскрывающегося списка, который уже является администратором, прежде чем визуализировать страницу, но цель этой задачи — работать с уровнем бизнес-логики.)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="2f0ca-185">Начните с создания класса исключений, который будет создаваться, когда пользователь пытается сделать лектора администратором нескольких отделов.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="2f0ca-186">В основном проекте создайте новый файл класса в папке *BLL* , назовите его *DuplicateAdministratorException.CS*и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="2f0ca-187">Теперь удалите временный файл *DuplicateAdministratorException.CS* , созданный в тестовом проекте ранее, чтобы иметь возможность компилировать.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="2f0ca-188">В основном проекте откройте файл *SchoolBL.CS* и добавьте следующий метод, содержащий логику проверки.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="2f0ca-189">(Код ссылается на метод, который вы создадите позже.)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="2f0ca-190">Этот метод вызывается при вставке или обновлении сущностей `Department`, чтобы проверить, имеет ли другой отдел тот же администратор.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="2f0ca-191">Код вызывает метод для поиска в базе данных `Department` сущности, которая имеет то же значение `Administrator` свойства, что и сущность, вставляемую или обновляемую.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="2f0ca-192">Если он найден, код создает исключение.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="2f0ca-193">Проверка не требуется, если вставляемая или обновляемая сущность не имеет `Administrator` значения, и исключение не создается, если метод вызывается во время обновления, а найденная сущность `Department` соответствует обновляемой сущности `Department`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="2f0ca-194">Вызовите новый метод из методов `Insert` и `Update`:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="2f0ca-195">В *ISchoolRepository.CS*добавьте следующее объявление для нового метода доступа к данным:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="2f0ca-196">В *SchoolRepository.CS*добавьте следующую инструкцию `using`:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="2f0ca-197">В *SchoolRepository.CS*добавьте следующий новый метод доступа к данным:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="2f0ca-198">Этот код извлекает `Department` сущности с указанным администратором.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="2f0ca-199">Должен быть найден только один отдел (если таковой имеется).</span><span class="sxs-lookup"><span data-stu-id="2f0ca-199">Only one department should be found (if any).</span></span> <span data-ttu-id="2f0ca-200">Однако, поскольку в базе данных не встроено ограничение, тип возвращаемого значения — это коллекция в случае, если найдено несколько отделов.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="2f0ca-201">По умолчанию, когда контекст объекта получает сущности из базы данных, он отслеживает их в диспетчере состояний объектов.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="2f0ca-202">Параметр `MergeOption.NoTracking` указывает, что это отслеживание не будет выполняться для этого запроса.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="2f0ca-203">Это необходимо, поскольку запрос может вернуть точную сущность, которую вы пытаетесь обновить, а затем вы не сможете присоединить эту сущность.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="2f0ca-204">Например, если изменить отдел журнала на странице *Departments. aspx* и оставить администратора без изменений, этот запрос вернет сведения о штатном отделе.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="2f0ca-205">Если `NoTracking` не задано, контекст объекта уже будет иметь сущность «журнал отделов» в диспетчере состояний объектов.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="2f0ca-206">Затем, когда вы подключаете сущность в виде журнала, созданную повторно из состояния представления, контекст объекта вызовет исключение, которое говорит `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="2f0ca-207">(В качестве альтернативы указанию `MergeOption.NoTracking`можно создать новый контекст объекта только для этого запроса.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="2f0ca-208">Поскольку новый контекст объекта будет иметь собственный диспетчер состояний объектов, конфликт при вызове метода `Attach` будет отсутствовать.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="2f0ca-209">Новый контекст объекта будет совместно использовать метаданные и подключение к базе данных с исходным контекстом объекта, поэтому снижение производительности этого альтернативного подхода будет минимальным.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="2f0ca-210">При этом подходе, показанном здесь, введен параметр `NoTracking`, который можно использовать в других контекстах.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="2f0ca-211">Параметр `NoTracking` обсуждается далее в последующем учебнике этой серии.)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="2f0ca-212">В тестовом проекте добавьте новый метод доступа к данным в *MockSchoolRepository.CS*:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="2f0ca-213">Этот код использует LINQ для выполнения того же выбора данных, который `ContosoUniversity` репозитории проекта использует LINQ to Entities для.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="2f0ca-214">Снова запустите тестовый проект.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-214">Run the test project again.</span></span> <span data-ttu-id="2f0ca-215">Результат на этот раз положительный.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-215">This time the tests pass.</span></span>

<span data-ttu-id="2f0ca-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="2f0ca-217">Обработка исключений ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="2f0ca-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="2f0ca-218">В проекте `ContosoUniversity` запустите страницу *departmentss. aspx* и попытайтесь изменить администратора отдела на того, кто уже является администратором другого отдела.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="2f0ca-219">(Помните, что вы можете изменять только те отделы, которые были добавлены в этом руководстве, так как база данных предварительно загружена с недопустимыми данными.) Появится следующая страница ошибки сервера:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="2f0ca-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="2f0ca-221">Пользователи не должны видеть эту страницу ошибки, поэтому необходимо добавить код обработки ошибок.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="2f0ca-222">Откройте элемент *departmentss. aspx* и укажите обработчик для события `OnUpdated` `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="2f0ca-223">Открывающий тег `ObjectDataSource` теперь напоминает следующий пример.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="2f0ca-224">В *Departments.aspx.CS*добавьте следующую инструкцию `using`:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="2f0ca-225">Добавьте следующий обработчик для события `Updated`:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="2f0ca-226">Если `ObjectDataSource` элемент управления перехватывает исключение при попытке выполнить обновление, оно передает исключение в аргументе события (`e`) в этот обработчик.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="2f0ca-227">Код в обработчике проверяет, является ли исключение дублирующим исключением администратора.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="2f0ca-228">Если это так, код создает проверяющий элемент управления, который содержит сообщение об ошибке для отображаемого элемента управления `ValidationSummary`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="2f0ca-229">Запустите страницу и попытайтесь сделать администратора двух отделов еще раз.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="2f0ca-230">На этот раз элемент управления `ValidationSummary` отображает сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="2f0ca-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="2f0ca-232">Внесите аналогичные изменения на странице *департментсадд. aspx* .</span><span class="sxs-lookup"><span data-stu-id="2f0ca-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="2f0ca-233">В *департментсадд. aspx*укажите обработчик для события `OnInserted` `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="2f0ca-234">Полученная разметка будет выглядеть примерно так:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="2f0ca-235">В *DepartmentsAdd.aspx.CS*Добавьте ту же инструкцию `using`:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="2f0ca-236">Добавьте следующий обработчик событий:</span><span class="sxs-lookup"><span data-stu-id="2f0ca-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="2f0ca-237">Теперь можно протестировать страницу *DepartmentsAdd.aspx.CS* , чтобы убедиться, что она также правильно обрабатывает попытки сделать одного пользователя администратором более одного отдела.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="2f0ca-238">Это завершает вводные сведения о реализации шаблона репозитория для использования элемента управления `ObjectDataSource` с Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="2f0ca-239">Дополнительные сведения о шаблоне репозитория и пригодности для тестирования см. в техническом документе MSDN [testing и Entity Framework 4,0](https://msdn.microsoft.com/library/ff714955.aspx).</span><span class="sxs-lookup"><span data-stu-id="2f0ca-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="2f0ca-240">В следующем учебнике вы узнаете, как добавить в приложение функции сортировки и фильтрации.</span><span class="sxs-lookup"><span data-stu-id="2f0ca-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="2f0ca-241">[Назад](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
> [Вперед](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="2f0ca-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
