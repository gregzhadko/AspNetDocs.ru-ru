---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/what-s-new-in-the-entity-framework-4
title: Новые возможности Entity Framework 4,0 | Документация Майкрософт
author: tdykstra
description: Эта серия руководств основана на веб-приложении университета Contoso, которое создается начало работы с руководством по Entity Framework 4,0. Он...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 393df4a8-b1db-44c4-9db7-2b533ca887d0
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/what-s-new-in-the-entity-framework-4
msc.type: authoredcontent
ms.openlocfilehash: 29d2bd61e8361b130e7b9415dad4fe1d5b847945
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78522150"
---
# <a name="whats-new-in-the-entity-framework-40"></a>Новые возможности .NET Framework 4.0

от [Tom Dykstra)](https://github.com/tdykstra)

> Эта серия руководств основана на веб-приложении университета Contoso, которое создается [Начало работы с помощью Entity Framework](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) серии руководств. Если вы не выполнили предыдущие учебники, в качестве отправной точки для этого учебника вы можете скачать созданное [приложение](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) . Вы также можете [скачать приложение](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , созданное с помощью полной серии руководств. Если у вас есть вопросы о учебниках, их можно опубликовать на [форуме ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).

В предыдущем учебнике были рассмотрены методы максимизации производительности веб-приложения, использующего Entity Framework. В этом руководстве рассматриваются некоторые наиболее важные новые функции в версии 4 Entity Framework, а также ссылки на ресурсы, которые предоставляют более полное представление о всех новых функциях. К функциям, выделенным в этом руководстве, относятся следующие.

- Связи с внешним ключом.
- Исполнение определяемых пользователем команд SQL.
- Разработка с моделью-First.
- Поддержка POCO.

Кроме того, в этом учебнике кратко рассматривается *Разработка кода*, которая будет возникать в следующем выпуске Entity Framework.

Чтобы начать работу с руководством, запустите Visual Studio и откройте веб-приложение Contoso университета, с которым вы работали в предыдущем руководстве.

## <a name="foreign-key-associations"></a>Связи с внешним ключом

Версия 3,5 Entity Framework включала свойства навигации, но не включала в себя свойства внешнего ключа в модели данных. Например, столбцы `CourseID` и `StudentID` таблицы `StudentGrade` будут пропущены в сущности `StudentGrade`.

[![image01](what-s-new-in-the-entity-framework-4/_static/image2.png)](what-s-new-in-the-entity-framework-4/_static/image1.png)

Причина этого подхода заключается в том, что строго говоря, внешние ключи являются сведениями о физической реализации и не принадлежат концептуальной модели данных. Однако в качестве практического занятия часто бывает проще работать с сущностями в коде, если у вас есть прямой доступ к внешним ключам.

Чтобы получить пример того, как внешние ключи в модели данных могут упростить код, подумайте, как было бы пришлось бы кодировать страницу *департментсадд. aspx* без них. В сущности `Department` свойство `Administrator` является внешним ключом, который соответствует `PersonID` в сущности `Person`. Чтобы установить связь между новым Отделом и его администратором, достаточно было установить значение свойства `Administrator` в обработчике событий `ItemInserting` элемента управления DataBound:

[!code-csharp[Main](what-s-new-in-the-entity-framework-4/samples/sample1.cs)]

Без внешних ключей в модели данных `Inserting` событие элемента управления источника данных, а не `ItemInserting` событие элемента управления с привязкой к данным, чтобы получить ссылку на саму сущность перед добавлением сущности в набор сущностей. При наличии этой ссылки вы устанавливаете ассоциацию с помощью кода, как показано в следующих примерах:

[!code-csharp[Main](what-s-new-in-the-entity-framework-4/samples/sample2.cs)]

[!code-csharp[Main](what-s-new-in-the-entity-framework-4/samples/sample3.cs)]

Как можно видеть в записи блога команды Entity Framework [в связи с внешними ключами](https://blogs.msdn.com/b/efdesign/archive/2009/03/16/foreign-keys-in-the-entity-framework.aspx), существуют и другие случаи, в которых сложность кода значительно выше. Для удовлетворения потребностей тех, кто предпочитает использовать сведения о реализации в концептуальной модели данных для упрощения кода, Entity Framework теперь предоставляет возможность включения внешних ключей в модель данных.

В Entity Framework терминологию при включении внешних ключей в модель данных, где используются *связи с внешними ключами*, и при исключении внешних ключей, для которых используются *независимые ассоциации*.

## <a name="executing-user-defined-sql-commands"></a>Исполнение определяемых пользователем команд SQL

В более ранних версиях Entity Framework не существовало простого способа создания собственных команд SQL на ходу и их запуска. Либо Entity Framework динамически создаваемые команды SQL, либо создали хранимую процедуру и импортировали ее как функцию. В версии 4 добавлены методы `ExecuteStoreQuery` и `ExecuteStoreCommand`, которые упрощают передачу любого запроса непосредственно в базу данных с помощью класса `ObjectContext`.

Предположим, что администраторам университета Contoso нужно иметь возможность выполнять групповые изменения в базе данных, не выполняя процесс создания хранимой процедуры и ее импорта в модель данных. Их первый запрос — для страницы, которая позволяет им изменить количество кредитов для всех курсов в базе данных. На веб-странице им нужно иметь возможность ввести число, которое будет использоваться для умножения значения каждой `Credits` столбца `Course` строки.

Создайте новую страницу, использующую главную страницу *site. master* и назовите ее *упдатекредитс. aspx*. Затем добавьте следующую разметку в элемент управления `Content` с именем `Content2`:

[!code-aspx[Main](what-s-new-in-the-entity-framework-4/samples/sample4.aspx)]

Эта разметка создает `TextBox` элемент управления, в котором пользователь может ввести значение множителя, элемент управления `Button`, чтобы щелкнуть, чтобы выполнить команду, и элемент управления `Label` для указания количества затронутых строк.

Откройте *UpdateCredits.aspx.CS*и добавьте следующую инструкцию `using` и обработчик для события `Click` кнопки:

[!code-csharp[Main](what-s-new-in-the-entity-framework-4/samples/sample5.cs)]

[!code-csharp[Main](what-s-new-in-the-entity-framework-4/samples/sample6.cs)]

Этот код выполняет команду SQL `Update`, используя значение в текстовом поле, и использует эту метку для вывода количества затронутых строк. Перед запуском страницы запустите страницу *Courses. aspx* , чтобы получить изображение некоторых данных.

[![Image02](what-s-new-in-the-entity-framework-4/_static/image4.png)](what-s-new-in-the-entity-framework-4/_static/image3.png)

Запустите *упдатекредитс. aspx*, введите 10 в качестве множителя и нажмите кнопку **выполнить**.

[![Image03](what-s-new-in-the-entity-framework-4/_static/image6.png)](what-s-new-in-the-entity-framework-4/_static/image5.png)

Снова запустите страницу *Courses. aspx* , чтобы просмотреть измененные данные.

[![Image04](what-s-new-in-the-entity-framework-4/_static/image8.png)](what-s-new-in-the-entity-framework-4/_static/image7.png)

(Если вы хотите, чтобы число кредитов было возвращено к исходным значениям, в поле *UpdateCredits.aspx.CS* Change `Credits * {0}` to `Credits / {0}` и повторно запустите страницу, введя 10 в качестве делителя.)

Дополнительные сведения о выполнении запросов, определяемых в коде, см. [в разделе инструкции. непосредственное выполнение команд в источнике данных](https://msdn.microsoft.com/library/ee358769.aspx).

## <a name="model-first-development"></a>Разработка с моделью-First

В этих пошаговых руководствах сначала была создана база данных, а затем создана модель данных на основе структуры базы данных. В Entity Framework 4 можно начать с модели данных, а затем создать базу данных на основе структуры модели данных. Если вы создаете приложение, для которого база данных еще не существует, подход с моделью-First позволяет создавать сущности и отношения, которые имеют смысл для приложения, не беспокоясь о физических деталях реализации. . (Это остается верным только на начальных этапах разработки. В конечном итоге база данных будет создана и будет содержать в ней рабочие данные, и ее повторное создание из модели станет непрактичной. на этом этапе вы вернетесь к подходу базы данных в первую очередь.)

В этом разделе руководства вы создадите простую модель данных и создадите из нее базу данных.

В **Обозреватель решений**щелкните правой кнопкой мыши папку *DAL* и выберите команду **Добавить новый элемент**. В диалоговом окне **Добавление нового элемента** в разделе **Установленные шаблоны** выберите **данные** , а затем выберите шаблон **ADO.NET EDM** . Назовите новый файл *алумниассоЦиатионмодел. EDMX* и нажмите кнопку **Добавить**.

[![Image06](what-s-new-in-the-entity-framework-4/_static/image10.png)](what-s-new-in-the-entity-framework-4/_static/image9.png)

Запустится мастер EDM. На шаге **Выбор содержимого модели** выберите **Пустая модель** и нажмите кнопку **Готово**.

[![Image07](what-s-new-in-the-entity-framework-4/_static/image12.png)](what-s-new-in-the-entity-framework-4/_static/image11.png)

**Конструктор EDM** откроется с пустой областью конструктора. Перетащите элемент **сущности** из **панели элементов** в область конструктора.

[![Image08](what-s-new-in-the-entity-framework-4/_static/image14.png)](what-s-new-in-the-entity-framework-4/_static/image13.png)

Измените имя сущности с `Entity1` на `Alumnus`, измените имя свойства `Id` на `AlumnusId`и добавьте новое скалярное свойство с именем `Name`. Чтобы добавить новые свойства, нажмите клавишу ВВОД после изменения имени `Id` столбца или щелкните сущность правой кнопкой мыши и выберите **Добавить скалярное свойство**. Тип по умолчанию для новых свойств — `String`, что прекрасно подходит для этой простой демонстрации, но, конечно, вы можете изменить такие вещи, как тип данных, в окне **Свойства** .

Создайте другую сущность таким же образом и назовите ее `Donation`. Измените свойство `Id` на `DonationId` и добавьте скалярное свойство с именем `DateAndAmount`.

[![Image09](what-s-new-in-the-entity-framework-4/_static/image16.png)](what-s-new-in-the-entity-framework-4/_static/image15.png)

Чтобы добавить ассоциацию между этими двумя сущностями, щелкните правой кнопкой мыши сущность `Alumnus`, выберите **Добавить**, а затем выберите **Ассоциация**.

[![Image10](what-s-new-in-the-entity-framework-4/_static/image18.png)](what-s-new-in-the-entity-framework-4/_static/image17.png)

Значения по умолчанию в диалоговом окне **Добавление ассоциации** — это то, что требуется (один ко многим, включить свойства навигации, включить внешние ключи), поэтому просто нажмите кнопку **ОК**.

[![Image11](what-s-new-in-the-entity-framework-4/_static/image20.png)](what-s-new-in-the-entity-framework-4/_static/image19.png)

Конструктор добавляет линию связи и свойство внешнего ключа.

[![Image12](what-s-new-in-the-entity-framework-4/_static/image22.png)](what-s-new-in-the-entity-framework-4/_static/image21.png)

Теперь можно приступать к созданию базы данных. Щелкните правой кнопкой мыши область конструктора и выберите команду **создать базу данных из модели**.

[![Image13](what-s-new-in-the-entity-framework-4/_static/image24.png)](what-s-new-in-the-entity-framework-4/_static/image23.png)

Запустится мастер создания базы данных. (Если отображаются предупреждения о том, что сущности не сопоставлены, их можно игнорировать в течение времени.)

На шаге **Выбор подключения к данным** нажмите кнопку **создать подключение**.

[![Image14](what-s-new-in-the-entity-framework-4/_static/image26.png)](what-s-new-in-the-entity-framework-4/_static/image25.png)

В диалоговом окне **Свойства соединения** выберите локальный экземпляр SQL Server Express и назовите `AlumniAssociation`базы данных.

[![Image15](what-s-new-in-the-entity-framework-4/_static/image28.png)](what-s-new-in-the-entity-framework-4/_static/image27.png)

При появлении запроса на создание базы данных нажмите кнопку **Да** . После повторного отображения шага **Выбор подключения к данным** нажмите кнопку **Далее**.

На шаге **Сводка и параметры** нажмите кнопку **Готово**.

[![Image18](what-s-new-in-the-entity-framework-4/_static/image30.png)](what-s-new-in-the-entity-framework-4/_static/image29.png)

Будет создан *SQL* -файл с командами языка описания данных (DDL), но команды еще не были запущены.

[![Image20](what-s-new-in-the-entity-framework-4/_static/image32.png)](what-s-new-in-the-entity-framework-4/_static/image31.png)

Используйте такое средство, как **SQL Server Management Studio** , чтобы запустить скрипт и создать таблицы, как это было сделано при создании базы данных `School` для [первого руководства в серии руководств по начало работы](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md). (Если база данных не загружена.)

Теперь можно использовать модель данных `AlumniAssociation` на веб-страницах так же, как и модель `School`. Чтобы испытать это, добавьте в таблицы некоторые данные и создайте веб-страницу, на которой отображаются данные.

С помощью **Обозреватель сервера**добавьте следующие строки в таблицы `Alumnus` и `Donation`.

[![Image21](what-s-new-in-the-entity-framework-4/_static/image34.png)](what-s-new-in-the-entity-framework-4/_static/image33.png)

Создайте новую веб-страницу с именем *Алумни. aspx* , которая использует главную страницу *site. master* . Добавьте следующую разметку в элемент управления `Content` с именем `Content2`:

[!code-aspx[Main](what-s-new-in-the-entity-framework-4/samples/sample7.aspx)]

Эта разметка создает вложенные элементы управления `GridView`, внешний элемент для вывода имен Алумни и внутренних элементов для вывода дат и сумм пожертвований.

Откройте *Alumni.aspx.CS*. Добавьте `using`ную инструкцию для уровня доступа к данным и обработчика для события `RowDataBound` внешнего элемента управления `GridView`:

[!code-csharp[Main](what-s-new-in-the-entity-framework-4/samples/sample8.cs)]

Этот код привязывает внутренний элемент управления `GridView`, используя свойство навигации `Donations` для сущности `Alumnus` текущей строки.

Запустите страницу.

[![Image22](what-s-new-in-the-entity-framework-4/_static/image36.png)](what-s-new-in-the-entity-framework-4/_static/image35.png)

(Примечание. Эта страница включена в загружаемый проект, но для его работы необходимо создать базу данных в локальном экземпляре SQL Server Express. база данных не входит в файл *MDF* в папку *данных приложения\_* .)

Дополнительные сведения об использовании функции "модель-первый" в Entity Framework см. [в разделе Модель-First в Entity Framework 4](https://msdn.microsoft.com/data/ff830362.aspx).

## <a name="poco-support"></a>Поддержка POCO

При использовании методологии проектирования на основе домена вы разрабатываете классы данных, представляющие данные и поведение, относящиеся к домену бизнеса. Эти классы должны быть независимыми от какой-либо конкретной технологии, используемой для хранения (сохранения) данных. Иными словами, они должны быть *игнорирующих сохраняемости*. Игнорирования сохраняемости также может упростить модульный тест, так как проект модульного теста может использовать любую технологию сохраняемости, наиболее удобную для тестирования. В более ранних версиях Entity Framework предлагалась ограниченная поддержка сохраняемости игнорирования, так как классы сущностей наследовали от класса `EntityObject` и, таким же, включали значительную часть функций, характерных для Entity Framework.

В Entity Framework 4 введена возможность использования классов сущностей, которые не наследуются от класса `EntityObject` и поэтому являются сохраняемыми игнорирующих. В контексте Entity Framework такие классы обычно называются *обычными объектами CLR* (POCO или POCO). Классы POCO можно создавать вручную или автоматически на основе существующей модели данных с помощью шаблонов средств преобразования текстовых шаблонов (T4), предоставляемых Entity Framework.

Дополнительные сведения об использовании POCO в Entity Framework см. в следующих ресурсах:

- [Работа с сущностями POCO](https://msdn.microsoft.com/library/dd456853.aspx). Это документ MSDN, содержащий общие сведения о POCO, а также ссылки на другие документы с более подробными сведениями.
- [Пошаговое руководство. Шаблон POCO для Entity Framework](https://blogs.msdn.com/b/adonet/archive/2010/01/25/walkthrough-poco-template-for-the-entity-framework.aspx) Это запись блога от команды разработчиков Entity Framework, со ссылками на другие записи блога о POCO.

## <a name="code-first-development"></a>Разработка с начала кода

Поддержка POCO в Entity Framework 4 по-прежнему требует создания модели данных и связывания классов сущностей с моделью данных. В следующем выпуске Entity Framework будет реализована функция, называемая *разработкой кода — First*. Эта функция позволяет использовать Entity Framework с собственными классами POCO, не требуя использования конструктора моделей данных или XML-файла модели данных. (Поэтому этот параметр также называется « *только код»* ; один и тот же Entity Frameworkный компонент можно использовать только для *кода* и *кода* .)

Дополнительные сведения об использовании подхода Code-First к разработке см. в следующих ресурсах:

- [Разработка на основе кода с Entity Framework 4](https://weblogs.asp.net/scottgu/archive/2010/07/16/code-first-development-with-entity-framework-4.aspx). Это запись блога, которую Скотт Гатри (в разработке кода.
- [Блог группы разработки Entity Framework — публикации с тегами Кодеонли](https://blogs.msdn.com/b/efdesign/archive/tags/codeonly/)
- [Блог группы разработки Entity Framework — публикации с тегами Code First](https://blogs.msdn.com/b/efdesign/archive/tags/code+first/)
- [Учебник по музыкальному хранилищу MVC. часть 4. модели и доступ к данным](../../../../mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-4.md)
- [Начало работы с MVC 3 — часть 4: Разработка с использованием кода Entity Framework](../../../../mvc/overview/older-versions/getting-started-with-aspnet-mvc3/cs/adding-a-model.md)

Кроме того, новый учебник по коду MVC, который создает приложение, аналогичное приложению университета Contoso, публикуется в пружине 2011 на [https://asp.net/entity-framework/tutorials](../../../../entity-framework.md)

## <a name="more-information"></a>Дополнительные сведения

В этом обзоре вы можете найти новые возможности Entity Framework и продолжить работу с серией руководств Entity Framework. Дополнительные сведения о новых функциях в Entity Framework 4, которые здесь не рассматриваются, см. в следующих ресурсах:

- [Новые возможности в ADO.NET](https://msdn.microsoft.com/library/ex6y04yf.aspx) Раздел MSDN, посвященный новым функциям в версии 4 Entity Framework.
- [Объявление о выпуске Entity Framework 4](https://blogs.msdn.com/b/efdesign/archive/2010/04/12/announcing-the-release-of-entity-framework-4.aspx) В блоге группы разработки Entity Framework, посвященной новым возможностям в версии 4.

> [!div class="step-by-step"]
> [Назад](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)
