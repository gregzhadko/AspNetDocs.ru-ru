---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-vb
title: Ведение журнала сведений об ошибках с помощью мониторинга работоспособности ASP.NET (VB) | Документация Майкрософт
author: rick-anderson
description: Система мониторинга работоспособности Майкрософт предоставляет простой и настраиваемый способ записи в журнал различных веб-событий, включая необработанные исключения. В этом руководстве рассматривается фи...
ms.author: riande
ms.date: 06/09/2009
ms.assetid: 09a6c74e-936a-4c04-8547-5bb313a4e4a3
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-vb
msc.type: authoredcontent
ms.openlocfilehash: f57aca41771adfd9a7c7f38da1916db9197262da
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78507600"
---
# <a name="logging-error-details-with-aspnet-health-monitoring-vb"></a>Запись в журнал сведений об ошибках с помощью наблюдения за состоянием системы ASP.NET (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_13_VB.zip) или [скачать PDF](https://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial13_HealthMonitoring_vb.pdf)

> Система мониторинга работоспособности Майкрософт предоставляет простой и настраиваемый способ записи в журнал различных веб-событий, включая необработанные исключения. В этом руководстве описывается настройка системы мониторинга работоспособности для записи необработанных исключений в базу данных и уведомления разработчиков по электронной почте.

## <a name="introduction"></a>Введение

Ведение журнала — это полезный инструмент для мониторинга работоспособности развернутого приложения и диагностики проблем, которые могут возникнуть. Особенно важно записывать в журнал ошибки, возникающие в развернутом приложении, чтобы их можно было исправлено. Событие `Error` возникает при возникновении необработанного исключения в приложении ASP.NET; в [предыдущем учебнике](processing-unhandled-exceptions-vb.md) было показано, как уведомить разработчика об ошибке и записать сведения о нем, создав обработчик событий для события `Error`. Однако создание обработчика `Error` событий для регистрации сведений об ошибке и уведомления разработчика не требуется, так как эта задача может быть выполнена ASP. *Система мониторинга работоспособности*сети.

Система мониторинга работоспособности появилась в ASP.NET 2,0 и предназначена для отслеживания работоспособности развернутого приложения ASP.NET, записывая в журнал события, происходящие во время существования приложения или запроса. События, регистрируемые системой мониторинга работоспособности, называются *событиями мониторинга работоспособности* или *веб-событиями*, включая:

- События времени существования приложения, например при запуске или остановке приложения
- События безопасности, включая неудачные попытки входа и неудачные запросы авторизации URL-адресов
- Ошибки приложения, включая необработанные исключения, исключения анализа состояния представления, исключения проверки запросов и ошибки компиляции, среди других типов ошибок.

При возникновении события наблюдения за работоспособностью его можно записывать в любое количество указанных *источников журналов*. Система мониторинга работоспособности поставляется с источниками журналов, которые зарегистрируют веб-события в Microsoft SQL Server базу данных, в журнал событий Windows или через сообщение электронной почты, помимо прочего. Вы также можете создавать собственные источники журналов.

События, заданные в журнале системы мониторинга работоспособности вместе с используемыми источниками журналов, определяются в `Web.config`. С помощью нескольких строк разметки конфигурации можно использовать мониторинг работоспособности для регистрации всех необработанных исключений в базе данных и уведомления об исключении по электронной почте.

## <a name="exploring-the-health-monitoring-systems-configuration"></a>Изучение конфигурации системы мониторинга работоспособности

Поведение системы мониторинга работоспособности определяется сведениями о конфигурации, которые находятся в [элементе`<healthMonitoring>`](https://msdn.microsoft.com/library/2fwh2ss9.aspx) в `Web.config`. Этот раздел конфигурации определяет, помимо прочего, следующие три важных аспекта информации:

1. События мониторинга работоспособности, которые, при возникновении, должны быть занесены в журнал,
2. Источники журнала и
3. Способ сопоставления каждого события мониторинга работоспособности, определенного в (1), с источниками журналов, определенными в (2).

Эти сведения задаются с помощью трех дочерних элементов конфигурации: [`<eventMappings>`](https://msdn.microsoft.com/library/yc5yk01w.aspx), [`<providers>`](https://msdn.microsoft.com/library/zaa41kz1.aspx)и [`<rules>`](https://msdn.microsoft.com/library/fe5wyxa0.aspx)соответственно.

Сведения о конфигурации системы мониторинга работоспособности по умолчанию можно найти в файле `Web.config` в папке `%WINDIR%\Microsoft.NET\Framework\version\CONFIG`. Эти сведения о конфигурации по умолчанию, в которых для краткости была удалена определенная разметка, показаны ниже:

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-vb/samples/sample1.xml)]

Интересующие события мониторинга работоспособности определяются в элементе `<eventMappings>`, который предоставляет удобное для человека имя классу событий мониторинга работоспособности. В приведенной выше разметке элемент `<eventMappings>` назначает понятное имя "все ошибки" событиям мониторинга работоспособности типа `WebBaseErrorEvent` и имени "аудиты сбоев" для событий мониторинга работоспособности типа "`WebFailureAuditEvent`".

Элемент `<providers>` определяет источники журнала, предоставляя им понятное имя и указывая любые сведения о конфигурации, относящиеся к источнику журнала. Первый элемент `<add>` определяет поставщик "Евентлогпровидер", который записывает в журнал указанные события мониторинга работоспособности с помощью класса `EventLogWebEventProvider`. Класс `EventLogWebEventProvider` записывает событие в журнал событий Windows. Второй элемент `<add>` определяет поставщик "SqlWebEventProvider", который регистрирует события в Microsoft SQL Server базе данных через класс `SqlWebEventProvider`. В конфигурации "SqlWebEventProvider" указывается строка подключения базы данных (`connectionStringName`) между другими параметрами конфигурации.

Элемент `<rules>` сопоставляет события, указанные в элементе `<eventMappings>`, с источниками журнала в элементе `<providers>`. По умолчанию веб-приложения ASP.NET регистрируют все необработанные исключения и произошел сбой аудита в журнале событий Windows.

## <a name="logging-events-to-a-database"></a>Ведение журнала событий в базе данных

Конфигурацию системы мониторинга работоспособности по умолчанию можно настроить на уровне веб-приложений, добавив раздел `<healthMonitoring>` в файл `Web.config` приложения. В разделы `<eventMappings>`, `<providers>`и `<rules>` можно включить дополнительные элементы с помощью элемента `<add>`. Чтобы удалить параметр из конфигурации по умолчанию, используйте элемент `<remove>` или используйте `<clear />`, чтобы удалить все значения по умолчанию из одного из этих разделов. Давайте настроим веб-приложение «проверки книги» для записи всех необработанных исключений в Microsoft SQL Server базу данных с помощью класса `SqlWebEventProvider`.

Класс `SqlWebEventProvider` входит в систему мониторинга работоспособности и регистрирует событие мониторинга работоспособности в указанной базе данных SQL Server. Класс `SqlWebEventProvider` предполагает, что указанная база данных содержит хранимую процедуру с именем `aspnet_WebEvent_LogEvent`. Эта хранимая процедура передает сведения о событии и добавляется в список хранения сведений о событии. Хорошая новость заключается в том, что для хранения сведений о событии не нужно создавать хранимую процедуру и таблицу. Эти объекты можно добавить в базу данных с помощью средства `aspnet_regsql.exe`.

> [!NOTE]
> Средство `aspnet_regsql.exe` было рассмотрено в разделе [ *Настройка веб-сайта, использующего службы приложений учебник,* ](configuring-a-website-that-uses-application-services-vb.md) когда мы добавили поддержку ASP. Службы приложений NET. Следовательно, база данных веб-сайта проверки книги уже содержит хранимую процедуру `aspnet_WebEvent_LogEvent`, которая хранит сведения о событии в таблице с именем `aspnet_WebEvent_Events`.

После того как в базу данных будет добавлена необходимая хранимая процедура и таблица, остается только указать, что мониторинг работоспособности регистрирует все необработанные исключения в базе данных. Для этого добавьте следующую разметку в файл `Web.config` веб-сайта:

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-vb/samples/sample2.xml)]

В разметке конфигурации мониторинга работоспособности выше используются элементы `<clear />` для очистки предварительно определенных сведений о конфигурации мониторинга работоспособности из разделов `<eventMappings>`, `<providers>`и `<rules>`. Затем в каждый из этих разделов добавляется одна запись.

- Элемент `<eventMappings>` определяет одно событие мониторинга работоспособности с именем "ALL Errors" (все ошибки), которое возникает при возникновении необработанного исключения.
- Элемент `<providers>` определяет один источник журнала с именем «SqlWebEventProvider», использующий класс `SqlWebEventProvider`. Атрибуту `connectionStringName` было присвоено значение "Ревиевсконнектионстринг", которое представляет собой имя строки подключения, определенной в разделе `<connectionStrings>`.
- Наконец, элемент&gt; Rules &lt;указывает, что при возникновении события «ALL Errors», которое должно быть зарегистрировано с помощью поставщика «SqlWebEventProvider».

Эта информация о конфигурации указывает системе мониторинга работоспособности регистрировать все необработанные исключения в базе данных рецензий книги.

> [!NOTE]
> Событие `WebBaseErrorEvent` возникает только для ошибок сервера; Он не вызывается для ошибок HTTP, таких как запрос ресурса ASP.NET, который не найден. Это отличается от поведения `Error` события класса `HttpApplication`, которое вызывается для ошибок сервера и HTTP.

Чтобы просмотреть систему мониторинга работоспособности в действии, посетите веб-сайт и создайте ошибку времени выполнения, посетив `Genre.aspx?ID=foo`. Должна отобразиться соответствующая страница ошибки — либо желтый экран "сведения об исключении" на момент смерти (при посещении локально), либо настраиваемая страница ошибки (при посещении сайта в рабочей среде). В фоновом режиме система мониторинга работоспособности зарегистрировала сведения об ошибке в базе данных. В таблице `aspnet_WebEvent_Events` должна быть одна запись (см. **рис. 1**); Эта запись содержит сведения о возникшей ошибке среды выполнения.

[![](logging-error-details-with-asp-net-health-monitoring-vb/_static/image2.png)](logging-error-details-with-asp-net-health-monitoring-vb/_static/image1.png)

**Рис. 1**. сведения об ошибке записаны в таблицу `aspnet_WebEvent_Events`  
([Щелкните, чтобы просмотреть изображение с полным размером](logging-error-details-with-asp-net-health-monitoring-vb/_static/image3.png))

### <a name="displaying-the-error-log-in-a-web-page"></a>Отображение журнала ошибок на веб-странице

При текущей конфигурации веб-сайта система мониторинга работоспособности регистрирует все необработанные исключения в базе данных. Однако наблюдение за работоспособностью не предоставляет механизма просмотра журнала ошибок через веб-страницу. Однако можно создать страницу ASP.NET, которая отображает эти сведения из базы данных. (Как мы увидим мгновенно, вы можете отправить вам сведения об ошибке в сообщении электронной почты.)

Если вы создаете такую страницу, убедитесь, что вы разрешаете только пользователям, прошедшим проверку подлинности, просматривать сведения об ошибке. Если сайт уже использует учетные записи пользователей, можно использовать правила авторизации URL-адресов, чтобы ограничить доступ к странице определенными пользователями или ролями. Дополнительные сведения о том, как предоставить или ограничить доступ к веб-страницам на основе вошедшего в систему пользователя, см. в [руководствах по безопасности веб-сайтов](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md).

> [!NOTE]
> В следующем руководстве рассматривается альтернативная система ведения журнала ошибок и уведомления с именем ELMAH. ELMAH включает встроенный механизм для просмотра журнала ошибок как на веб-странице, так и в виде канала RSS.

## <a name="logging-events-to-email"></a>Ведение журнала событий по электронной почте

Система мониторинга работоспособности включает поставщика источника журнала, который регистрирует событие в сообщении электронной почты. Источник журнала содержит те же сведения, которые записываются в базу данных в тексте сообщения электронной почты. Этот источник журнала можно использовать для уведомления разработчика при возникновении определенного события мониторинга работоспособности.

Давайте попробуем обновить конфигурацию веб-сайта проверки книги, чтобы при возникновении исключения мы получили сообщение электронной почты. Для этого необходимо выполнить три задачи:

1. Настройте веб-приложение ASP.NET для отправки электронной почты. Это достигается путем указания того, как сообщения электронной почты отправляются через элемент конфигурации `<system.net>`. Дополнительные сведения об отправке сообщений электронной почты в приложении ASP.NET см. в статье [Отправка электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx) и [вопросы и ответы о системе .NET. mail](http://systemnetmail.com/).
2. Зарегистрируйте поставщик источника журнала электронной почты в элементе `<providers>` и
3. Добавьте запись в элемент `<rules>`, который сопоставляет событие "все ошибки" с поставщиком источника журнала, добавленным на шаге (2).

Система мониторинга работоспособности включает два класса поставщиков источников журнала электронной почты: `SimpleMailWebEventProvider` и `TemplatedMailWebEventProvider`. [Класс`SimpleMailWebEventProvider`](https://msdn.microsoft.com/library/system.web.management.simplemailwebeventprovider.aspx) отправляет сообщение электронной почты в виде обычного текста, которое содержит сведения о событии, и предоставляет небольшую настройку текста сообщения. С помощью [класса`TemplatedMailWebEventProvider`](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) вы указываете страницу ASP.NET, в которой в качестве текста сообщения электронной почты используется визуализированная разметка. [Класс`TemplatedMailWebEventProvider`](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) предоставляет намного больший контроль над содержимым и форматом сообщения электронной почты, но требует более длительной работы, так как необходимо создать страницу ASP.NET, которая создает текст сообщения электронной почты. В этом учебнике рассматривается использование класса `SimpleMailWebEventProvider`.

Обновите элемент `<providers>` системы мониторинга работоспособности в файле `Web.config`, чтобы включить источник журнала для класса `SimpleMailWebEventProvider`:

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-vb/samples/sample3.xml)]

Приведенная выше разметка использует класс `SimpleMailWebEventProvider` в качестве поставщика источника журнала и присваивает ему понятное имя "Емаилвебевентпровидер". Более того, атрибут `<add>` включает дополнительные параметры конфигурации, такие как адреса, отправляемые в сообщение электронной почты и обратно.

После определения источника журнала электронной почты остается только указать системе мониторинга работоспособности использовать этот источник для «журнала» необработанных исключений. Это достигается путем добавления нового правила в раздел `<rules>`:

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-vb/samples/sample4.xml)]

Раздел `<rules>` теперь содержит два правила. Первый из них с именем «все ошибки в электронную почту» отправляет все необработанные исключения в источник журнала «Емаилвебевентпровидер». Это правило влияет на отправку сведений об ошибках на веб-сайте по указанному адресу. Правило «все ошибки в базе данных» записывает сведения об ошибке в базу данных сайта. Следовательно, каждый раз, когда на сайте происходит необработанное исключение, его сведения регистрируются в базе данных и отправляются на указанный адрес электронной почты.

На **рис. 2** показано сообщение электронной почты, созданное классом `SimpleMailWebEventProvider` при посещении `Genre.aspx?ID=foo`.

[![](logging-error-details-with-asp-net-health-monitoring-vb/_static/image5.png)](logging-error-details-with-asp-net-health-monitoring-vb/_static/image4.png)

**Рис. 2**. сведения об ошибке отправляются в сообщении электронной почты  
([Щелкните, чтобы просмотреть изображение с полным размером](logging-error-details-with-asp-net-health-monitoring-vb/_static/image6.png))

## <a name="summary"></a>Сводка

Система мониторинга работоспособности ASP.NET разработана, чтобы позволить администраторам отслеживать работоспособность развернутого веб-приложения. События мониторинга работоспособности возникают при unfold определенных действий, например при остановке приложения, при успешном входе пользователя в сайт или при возникновении необработанного исключения. Эти события можно записывать в любое количество источников журнала. В этом учебнике было показано, как записывать сведения о необработанных исключениях в базу данных и через сообщение электронной почты.

В этом учебнике рассматривается использование мониторинга работоспособности для ведения журнала необработанных исключений, но следует помнить, что мониторинг работоспособности предназначен для измерения общей работоспособности развернутого приложения ASP.NET и включает множество событий мониторинга работоспособности и источников журналов. рассмотрено здесь. Более того, вы можете создавать собственные события мониторинга работоспособности и источники журналов, если это необходимо. Если вы заинтересованы в изучении мониторинга работоспособности, лучше всего прочесть раздел [вопросы и ответы по мониторингу работоспособности](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx) [Эрик Реитан](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx). Ниже приведены сведения [о том, как использовать мониторинг работоспособности в ASP.NET 2,0](https://msdn.microsoft.com/library/ms998306.aspx).

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Общие сведения о мониторинге работоспособности ASP.NET](https://msdn.microsoft.com/library/bb398933.aspx)
- [Настройка и настройка системы мониторинга работоспособности ASP.NET](http://dotnetslackers.com/articles/aspnet/ConfiguringAndCustomizingTheHealthMonitoringSystemOfASPNET.aspx)
- [Часто задаваемые вопросы — мониторинг работоспособности в ASP.NET 2,0](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)
- [Как отправлять электронную почту для уведомлений мониторинга работоспособности](https://msdn.microsoft.com/library/ms227553.aspx)
- [Как использовать наблюдение за работоспособностью в ASP.NET](https://msdn.microsoft.com/library/ms998306.aspx)
- [Мониторинг работоспособности в ASP.NET](http://aspnet.4guysfromrolla.com/articles/031407-1.aspx)

> [!div class="step-by-step"]
> [Назад](processing-unhandled-exceptions-vb.md)
> [Вперед](logging-error-details-with-elmah-vb.md)
