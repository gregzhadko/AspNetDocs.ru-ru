---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-cs
title: Обработка необработанных исключений (C#) | Документация Майкрософт
author: rick-anderson
description: При возникновении ошибки времени выполнения для веб-приложения в рабочей среде важно уведомить разработчика и зарегистрировать ошибку, чтобы ее можно было диагностировать в La...
ms.author: riande
ms.date: 06/09/2009
ms.assetid: 5bc1afd5-2484-4528-b158-ab218ba150e8
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-cs
msc.type: authoredcontent
ms.openlocfilehash: 27d827238d944f86cd913d2b8ecd12729b99f391
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78510660"
---
# <a name="processing-unhandled-exceptions-c"></a><span data-ttu-id="29c3f-103">Обработка необработанных исключений (C#)</span><span class="sxs-lookup"><span data-stu-id="29c3f-103">Processing Unhandled Exceptions (C#)</span></span>

<span data-ttu-id="29c3f-104">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="29c3f-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="29c3f-105">[Просмотреть или скачать образец кода](https://github.com/dotnet/AspNetDocs/tree/master/aspnet/web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-cs/samples) ([как скачивать](/aspnet/core/tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="29c3f-105">[View or download sample code](https://github.com/dotnet/AspNetDocs/tree/master/aspnet/web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-cs/samples) ([how to download](/aspnet/core/tutorials/index#how-to-download-a-sample))</span></span>

> <span data-ttu-id="29c3f-106">При возникновении ошибки времени выполнения для веб-приложения в рабочей среде важно уведомить разработчика и зарегистрировать ошибку, чтобы ее можно было диагностировать в более поздней момент времени.</span><span class="sxs-lookup"><span data-stu-id="29c3f-106">When a runtime error occurs on a web application in production it is important to notify a developer and to log the error so that it may be diagnosed at a later point in time.</span></span> <span data-ttu-id="29c3f-107">В этом учебнике содержатся общие сведения о том, как ASP.NET обрабатывает ошибки времени выполнения и просматривает один из способов выполнения пользовательского кода всякий раз, когда необработанное исключение передается в среду выполнения ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="29c3f-107">This tutorial provides an overview of how ASP.NET processes runtime errors and looks at one way to have custom code execute whenever an unhandled exception bubbles up to the ASP.NET runtime.</span></span>

## <a name="introduction"></a><span data-ttu-id="29c3f-108">Введение</span><span class="sxs-lookup"><span data-stu-id="29c3f-108">Introduction</span></span>

<span data-ttu-id="29c3f-109">Когда в приложении ASP.NET возникает необработанное исключение, оно передается в среду выполнения ASP.NET, которая вызывает событие `Error` и отображает соответствующую страницу ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-109">When an unhandled exception occurs in an ASP.NET application, it bubbles up to the ASP.NET runtime, which raises the `Error` event and displays the appropriate error page.</span></span> <span data-ttu-id="29c3f-110">Существует три разных типа страниц ошибок: желтый экран "ошибка времени выполнения" (ИСОД); Сведения об исключении ИСОД; и пользовательские страницы ошибок.</span><span class="sxs-lookup"><span data-stu-id="29c3f-110">There are three different types of error pages: the Runtime Error Yellow Screen of Death (YSOD); the Exception Details YSOD; and custom error pages.</span></span> <span data-ttu-id="29c3f-111">В [предыдущем учебном курсе](displaying-a-custom-error-page-cs.md) мы настроили приложение на использование настраиваемой страницы ошибок для удаленных пользователей и сведений об исключении, исод для пользователей, посещенных локально.</span><span class="sxs-lookup"><span data-stu-id="29c3f-111">In the [preceding tutorial](displaying-a-custom-error-page-cs.md) we configured the application to use a custom error page for remote users and the Exception Details YSOD for users visiting locally.</span></span>

<span data-ttu-id="29c3f-112">Использование удобной для пользователя настраиваемой страницы ошибок, которая соответствует внешнему интерфейсу веб-узла, является предпочтительным для ошибки времени выполнения по умолчанию ИСОД, но отображение пользовательской страницы ошибки — лишь одна часть комплексного решения по обработке ошибок.</span><span class="sxs-lookup"><span data-stu-id="29c3f-112">Using a human-friendly custom error page that matches the look and feel of the site is preferred to the default Runtime Error YSOD, but displaying a custom error page is only one part of a comprehensive error handling solution.</span></span> <span data-ttu-id="29c3f-113">При возникновении ошибки в приложении в рабочей среде важно, чтобы разработчики получали извещение об ошибке, чтобы они могли неземлеть причину исключения и устранить ее.</span><span class="sxs-lookup"><span data-stu-id="29c3f-113">When an error occurs in an application in production, it is important that the developers are notified of the error so that they can unearth the cause of the exception and address it.</span></span> <span data-ttu-id="29c3f-114">Более того, сведения об ошибке необходимо регистрировать, чтобы можно было исследовать и диагностировать ошибку в более позднем моменте времени.</span><span class="sxs-lookup"><span data-stu-id="29c3f-114">Furthermore, the error's details should be logged so that the error can be examined and diagnosed at a later point in time.</span></span>

<span data-ttu-id="29c3f-115">В этом руководстве показано, как получить доступ к сведениям о необработанном исключении, чтобы они могли быть зарегистрированы и были уведомлены для разработчиков.</span><span class="sxs-lookup"><span data-stu-id="29c3f-115">This tutorial shows how to access the details of an unhandled exception so that they can be logged and a developer notified.</span></span> <span data-ttu-id="29c3f-116">В двух учебниках, которые следуют за этим одним из этих руководств, рассматриваются библиотеки регистрации ошибок, которые после установки ряда настроек автоматически уведомляют разработчиков об ошибках времени выполнения и записывает сведения о них.</span><span class="sxs-lookup"><span data-stu-id="29c3f-116">The two tutorials following this one explore error logging libraries that, after a bit of configuration, will automatically notify developers of runtime errors and log their details.</span></span>

> [!NOTE]
> <span data-ttu-id="29c3f-117">Сведения, которые проверяются в этом учебнике, наиболее полезны, если необходимо обрабатывать необработанные исключения особым образом или индивидуально.</span><span class="sxs-lookup"><span data-stu-id="29c3f-117">The information examined in this tutorial is most useful if you need to process unhandled exceptions in some unique or customized manner.</span></span> <span data-ttu-id="29c3f-118">В случаях, когда требуется только регистрировать исключение и уведомлять разработчика, можно использовать библиотеку регистрации ошибок.</span><span class="sxs-lookup"><span data-stu-id="29c3f-118">In cases where you only need to log the exception and notify a developer, using an error logging library is the way to go.</span></span> <span data-ttu-id="29c3f-119">В следующих двух учебниках представлен обзор двух таких библиотек.</span><span class="sxs-lookup"><span data-stu-id="29c3f-119">The next two tutorials provide an overview of two such libraries.</span></span>

## <a name="executing-code-when-theerrorevent-is-raised"></a><span data-ttu-id="29c3f-120">Исполнение кода при возникновении события`Error`</span><span class="sxs-lookup"><span data-stu-id="29c3f-120">Executing Code When The`Error`Event Is Raised</span></span>

<span data-ttu-id="29c3f-121">События предоставляют объекту механизм для сигнализации о том, что произошло нечто интересное, а другой объект — для выполнения кода в ответе.</span><span class="sxs-lookup"><span data-stu-id="29c3f-121">Events provide an object a mechanism for signaling that something interesting has occurred, and for another object to execute code in response.</span></span> <span data-ttu-id="29c3f-122">Как разработчик ASP.NET вы привыкли думать о событиях.</span><span class="sxs-lookup"><span data-stu-id="29c3f-122">As an ASP.NET developer you are accustomed to thinking in terms of events.</span></span> <span data-ttu-id="29c3f-123">Если вы хотите выполнить некоторый код, когда посетитель щелкнет определенную кнопку, создайте обработчик событий для `Click` события этой кнопки и разместите код там.</span><span class="sxs-lookup"><span data-stu-id="29c3f-123">If you want to run some code when the visitor clicks a particular Button, you create an event handler for that Button's `Click` event and put your code there.</span></span> <span data-ttu-id="29c3f-124">Учитывая, что среда выполнения ASP.NET создает свое [событие`Error`](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx) всякий раз, когда возникает необработанное исключение, он следует за тем, чтобы код, который записывает сведения об ошибке, перейдет в обработчик событий.</span><span class="sxs-lookup"><span data-stu-id="29c3f-124">Given that the ASP.NET runtime raises its [`Error` event](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx) whenever an unhandled exception occurs, it follows that the code for logging the error's details would go in an event handler.</span></span> <span data-ttu-id="29c3f-125">Но как создать обработчик событий для `Error` события?</span><span class="sxs-lookup"><span data-stu-id="29c3f-125">But how do you create an event handler for the `Error` event?</span></span>

<span data-ttu-id="29c3f-126">Событие `Error` является одним из многих событий в [классе`HttpApplication`](https://msdn.microsoft.com/library/system.web.httpapplication.aspx) , которые вызываются на определенных этапах конвейера HTTP в течение времени существования запроса.</span><span class="sxs-lookup"><span data-stu-id="29c3f-126">The `Error` event is one of many events in the [`HttpApplication` class](https://msdn.microsoft.com/library/system.web.httpapplication.aspx) that are raised at certain stages in the HTTP pipeline during the lifetime of a request.</span></span> <span data-ttu-id="29c3f-127">Например, [событие`BeginRequest`](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx) класса `HttpApplication` возникает в начале каждого запроса. его [`AuthenticateRequest` событие](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) возникает, когда модуль безопасности определил запрашивающий.</span><span class="sxs-lookup"><span data-stu-id="29c3f-127">For example, the `HttpApplication` class's [`BeginRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx) is raised at the start of every request; its [`AuthenticateRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) is raised when a security module has identified the requestor.</span></span> <span data-ttu-id="29c3f-128">Эти `HttpApplication` события дают разработчику страницы возможность выполнять пользовательскую логику в различных точках времени существования запроса.</span><span class="sxs-lookup"><span data-stu-id="29c3f-128">These `HttpApplication` events give the page developer a means to execute custom logic at the various points in the lifetime of a request.</span></span>

<span data-ttu-id="29c3f-129">Обработчики событий для событий `HttpApplication` можно поместить в специальный файл с именем `Global.asax`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-129">Event handlers for the `HttpApplication` events can be placed in a special file named `Global.asax`.</span></span> <span data-ttu-id="29c3f-130">Чтобы создать этот файл на веб-сайте, добавьте новый элемент в корневую папку веб-сайта, используя шаблон глобального класса приложений с именем `Global.asax`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-130">To create this file in your website, add a new item to the root of your website using the Global Application Class template with the name `Global.asax`.</span></span>

[![](processing-unhandled-exceptions-cs/_static/image2.png)](processing-unhandled-exceptions-cs/_static/image1.png)

<span data-ttu-id="29c3f-131">**Рис. 1**. Добавление `Global.asax` в веб-приложение</span><span class="sxs-lookup"><span data-stu-id="29c3f-131">**Figure 1**: Add `Global.asax` To Your Web Application</span></span>  
<span data-ttu-id="29c3f-132">([Щелкните, чтобы просмотреть изображение с полным размером](processing-unhandled-exceptions-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="29c3f-132">([Click to view full-size image](processing-unhandled-exceptions-cs/_static/image3.png))</span></span>

<span data-ttu-id="29c3f-133">Содержимое и структура файла `Global.asax`, созданного Visual Studio, немного отличаются в зависимости от того, используется ли проект веб-приложения (WAP) или проект веб-сайта (WSP).</span><span class="sxs-lookup"><span data-stu-id="29c3f-133">The contents and structure of the `Global.asax` file created by Visual Studio differ slightly based on whether you are using a Web Application Project (WAP) or Web Site Project (WSP).</span></span> <span data-ttu-id="29c3f-134">С помощью WAP `Global.asax` реализуется как два отдельных файла — `Global.asax` и `Global.asax.cs`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-134">With a WAP, the `Global.asax` is implemented as two separate files - `Global.asax` and `Global.asax.cs`.</span></span> <span data-ttu-id="29c3f-135">Файл `Global.asax` не содержит ничего, Кроме директивы `@Application`, которая ссылается на файл `.cs`; интересующие вас обработчики событий определяются в файле `Global.asax.cs`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-135">The `Global.asax` file contains nothing but an `@Application` directive that references the `.cs` file; the event handlers of interest are defined in the `Global.asax.cs` file.</span></span> <span data-ttu-id="29c3f-136">Для ВСПС создается только один файл, `Global.asax`, а обработчики событий определяются в блоке `<script runat="server">`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-136">For WSPs, only a single file is created, `Global.asax`, and the event handlers are defined in a `<script runat="server">` block.</span></span>

<span data-ttu-id="29c3f-137">Файл `Global.asax`, созданный в шаблоне глобального приложения WAP в Visual Studio, содержит обработчики событий с именами `Application_BeginRequest`, `Application_AuthenticateRequest`и `Application_Error`, которые являются обработчиками событий `HttpApplication` `BeginRequest`, `AuthenticateRequest`и `Error`соответственно.</span><span class="sxs-lookup"><span data-stu-id="29c3f-137">The `Global.asax` file created in a WAP by Visual Studio's Global Application Class template includes event handlers named `Application_BeginRequest`, `Application_AuthenticateRequest`, and `Application_Error`, which are event handlers for the `HttpApplication` events `BeginRequest`, `AuthenticateRequest`, and `Error`, respectively.</span></span> <span data-ttu-id="29c3f-138">Существуют также обработчики событий с именами `Application_Start`, `Session_Start`, `Application_End`и `Session_End`. это обработчики событий, которые срабатывают при запуске веб-приложения, когда запускается новый сеанс, когда приложение завершается и когда сеанс завершается соответственно.</span><span class="sxs-lookup"><span data-stu-id="29c3f-138">There are also event handlers named `Application_Start`, `Session_Start`, `Application_End`, and `Session_End`, which are event handlers that fire when the web application starts, when a new session starts, when the application ends, and when a session ends, respectively.</span></span> <span data-ttu-id="29c3f-139">Файл `Global.asax`, созданный в WSP Visual Studio, содержит только обработчики событий `Application_Error`, `Application_Start`, `Session_Start`, `Application_End`и `Session_End`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-139">The `Global.asax` file created in a WSP by Visual Studio contains just the `Application_Error`, `Application_Start`, `Session_Start`, `Application_End`, and `Session_End` event handlers.</span></span>

> [!NOTE]
> <span data-ttu-id="29c3f-140">При развертывании приложения ASP.NET необходимо скопировать файл `Global.asax` в рабочую среду.</span><span class="sxs-lookup"><span data-stu-id="29c3f-140">When deploying the ASP.NET application you need to copy the `Global.asax` file to the production environment.</span></span> <span data-ttu-id="29c3f-141">Файл `Global.asax.cs`, созданный в WAP, не нужно копировать в рабочую среду, так как этот код компилируется в сборку проекта.</span><span class="sxs-lookup"><span data-stu-id="29c3f-141">The `Global.asax.cs` file, which is created in the WAP, does not need to be copied to production because this code is compiled into the project's assembly.</span></span>

<span data-ttu-id="29c3f-142">Обработчики событий, созданные с помощью шаблона глобального приложения Visual Studio, не являются исчерпывающими.</span><span class="sxs-lookup"><span data-stu-id="29c3f-142">The event handlers created by Visual Studio's Global Application Class template are not exhaustive.</span></span> <span data-ttu-id="29c3f-143">Можно добавить обработчик событий для любого `HttpApplication` события, назвав `Application_EventName`обработчика событий.</span><span class="sxs-lookup"><span data-stu-id="29c3f-143">You can add an event handler for any `HttpApplication` event by naming the event handler `Application_EventName`.</span></span> <span data-ttu-id="29c3f-144">Например, можно добавить следующий код в файл `Global.asax`, чтобы создать обработчик событий для [события`AuthorizeRequest`](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx):</span><span class="sxs-lookup"><span data-stu-id="29c3f-144">For example, you could add the following code to the `Global.asax` file to create an event handler for the [`AuthorizeRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx):</span></span>

[!code-cs[Main](processing-unhandled-exceptions-cs/samples/sample1.cs)]

<span data-ttu-id="29c3f-145">Аналогичным образом можно удалить все обработчики событий, созданные ненужным шаблоном глобального класса приложений.</span><span class="sxs-lookup"><span data-stu-id="29c3f-145">Likewise, you can remove any event handlers created by the Global Application Class template that are not needed.</span></span> <span data-ttu-id="29c3f-146">В этом руководстве для события `Error` требуется только обработчик событий. Вы можете удалить другие обработчики событий из файла `Global.asax`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-146">For this tutorial we only require an event handler for the `Error` event; feel free to remove the other event handlers from the `Global.asax` file.</span></span>

> [!NOTE]
> <span data-ttu-id="29c3f-147">*HTTP-модули* предлагают еще один способ определения обработчиков событий для `HttpApplication` событий.</span><span class="sxs-lookup"><span data-stu-id="29c3f-147">*HTTP Modules* offer another way to define event handlers for `HttpApplication` events.</span></span> <span data-ttu-id="29c3f-148">Модули HTTP создаются как файл класса, который можно разместить непосредственно в проекте веб-приложения или разделить в отдельную библиотеку классов.</span><span class="sxs-lookup"><span data-stu-id="29c3f-148">HTTP Modules are created as a class file that can be placed directly within the web application project or separated out into a separate class library.</span></span> <span data-ttu-id="29c3f-149">Так как они могут быть разделены на библиотеку классов, модули HTTP предлагают более гибкую и многократно используемую модель для создания `HttpApplication` обработчиков событий.</span><span class="sxs-lookup"><span data-stu-id="29c3f-149">Because they can be separated out into a class library, HTTP Modules offer a more flexible and reusable model for creating `HttpApplication` event handlers.</span></span> <span data-ttu-id="29c3f-150">В то время как файл `Global.asax` зависит от веб-приложения, в котором оно находится, модули HTTP могут быть скомпилированы в сборки, после чего Добавление модуля HTTP на веб-сайт выполняется так же просто, как удаление сборки из папки `Bin` и регистрация модуля в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-150">Whereas the `Global.asax` file is specific to the web application where it resides, HTTP Modules can be compiled into assemblies, at which point adding the HTTP Module to a website is as simple as dropping the assembly in the `Bin` folder and registering the Module in `Web.config`.</span></span> <span data-ttu-id="29c3f-151">В этом учебнике не рассматривается создание и использование модулей HTTP, но две библиотеки регистрации ошибок, используемые в следующих двух учебниках, реализуются как модули HTTP.</span><span class="sxs-lookup"><span data-stu-id="29c3f-151">This tutorial does not look at creating and using HTTP Modules, but the two error logging libraries used in the following two tutorials are implemented as HTTP Modules.</span></span> <span data-ttu-id="29c3f-152">Дополнительные сведения о преимуществах модулей HTTP см. в статье [Использование модулей и обработчиков HTTP для создания подключаемых компонентов ASP.NET](https://msdn.microsoft.com/library/aa479332.aspx).</span><span class="sxs-lookup"><span data-stu-id="29c3f-152">For more background on the benefits of HTTP Modules refer to [Using HTTP Modules and Handlers to Create Pluggable ASP.NET Components](https://msdn.microsoft.com/library/aa479332.aspx).</span></span>

## <a name="retrieving-information-about-the-unhandled-exception"></a><span data-ttu-id="29c3f-153">Получение сведений о необработанном исключении</span><span class="sxs-lookup"><span data-stu-id="29c3f-153">Retrieving Information About the Unhandled Exception</span></span>

<span data-ttu-id="29c3f-154">На этом этапе у нас есть файл Global. asax с обработчиком событий `Application_Error`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-154">At this point we have a Global.asax file with an `Application_Error` event handler.</span></span> <span data-ttu-id="29c3f-155">При выполнении этого обработчика событий необходимо уведомить разработчика об ошибке и записать сведения о нем.</span><span class="sxs-lookup"><span data-stu-id="29c3f-155">When this event handler executes we need to notify a developer of the error and log its details.</span></span> <span data-ttu-id="29c3f-156">Для выполнения этих задач сначала необходимо определить сведения о возникшем исключении.</span><span class="sxs-lookup"><span data-stu-id="29c3f-156">To accomplish these tasks we first need to determine the details of the exception that was raised.</span></span> <span data-ttu-id="29c3f-157">Используйте [метод`GetLastError`](https://msdn.microsoft.com/library/system.web.httpserverutility.getlasterror.aspx) объекта Server для получения сведений о необработанном исключении, которое привело к срабатыванию события `Error`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-157">Use the Server object's [`GetLastError` method](https://msdn.microsoft.com/library/system.web.httpserverutility.getlasterror.aspx) to retrieve details of the unhandled exception that caused the `Error` event to fire.</span></span>

[!code-csharp[Main](processing-unhandled-exceptions-cs/samples/sample2.cs)]

<span data-ttu-id="29c3f-158">Метод `GetLastError` возвращает объект типа `Exception`, который является базовым типом для всех исключений в .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="29c3f-158">The `GetLastError` method returns an object of type `Exception`, which is the base type for all exceptions in the .NET Framework.</span></span> <span data-ttu-id="29c3f-159">Однако в приведенном выше коде объект исключения, возвращенный `GetLastError`, передается в объект `HttpException`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-159">However, in the code above I am casting the Exception object returned by `GetLastError` into an `HttpException` object.</span></span> <span data-ttu-id="29c3f-160">Если событие `Error` срабатывает из-за возникновения исключения во время обработки ресурса ASP.NET, то созданное исключение упаковывается в `HttpException`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-160">If the `Error` event is being fired because an exception was thrown during the processing of an ASP.NET resource then the exception that was thrown is wrapped within an `HttpException`.</span></span> <span data-ttu-id="29c3f-161">Чтобы получить фактическое исключение, причиной событие ошибки, используйте свойство `InnerException`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-161">To get the actual exception that precipitated the Error event use the `InnerException` property.</span></span> <span data-ttu-id="29c3f-162">Если событие `Error` возникло из-за исключения на основе HTTP, например запроса к несуществующей странице, создается `HttpException`, но нет внутреннего исключения.</span><span class="sxs-lookup"><span data-stu-id="29c3f-162">If the `Error` event was raised because of an HTTP-based exception, such as a request for a non-existent page, an `HttpException` is thrown, but it does not have an inner exception.</span></span>

<span data-ttu-id="29c3f-163">Следующий код использует `GetLastErrormessage` для получения сведений об исключении, вызвавшем событие `Error`, сохраняя `HttpException` в переменной с именем `lastErrorWrapper`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-163">The following code uses the `GetLastErrormessage` to retrieve information about the exception that triggered the `Error` event, storing the `HttpException` in a variable named `lastErrorWrapper`.</span></span> <span data-ttu-id="29c3f-164">Затем он сохраняет тип, сообщение и трассировку стека исходного исключения в трех строковых переменных, проверяя, является ли `lastErrorWrapper` фактическим исключением, вызвавшим событие `Error` (в случае с исключениями на основе HTTP) или только оболочкой для исключения, созданного при обработке запроса.</span><span class="sxs-lookup"><span data-stu-id="29c3f-164">It then stores the type, message, and stack trace of the originating exception in three string variables, checking to see if the `lastErrorWrapper` is the actual exception that triggered the `Error` event (in the case of HTTP-based exceptions) or if it's merely a wrapper for an exception that was thrown while processing the request.</span></span>

[!code-csharp[Main](processing-unhandled-exceptions-cs/samples/sample3.cs)]

<span data-ttu-id="29c3f-165">На этом этапе у вас есть вся информация, необходимая для написания кода, который будет записывать сведения об исключении в таблицу базы данных.</span><span class="sxs-lookup"><span data-stu-id="29c3f-165">At this point you have all the information you need to write code that will log the exception's details to a database table.</span></span> <span data-ttu-id="29c3f-166">Можно создать таблицу базы данных со столбцами для каждой из подробных сведений об ошибках — типа, сообщения, трассировки стека и т. д. Вместе с другими полезными сведениями, такими как URL-адрес запрашиваемой страницы и имя пользователя, выполнившего вход в систему.</span><span class="sxs-lookup"><span data-stu-id="29c3f-166">You could create a database table with columns for each of the error details of interest - the type, the message, the stack trace, and so on - along with other useful pieces of information, such as the URL of the requested page and the name of the currently logged on user.</span></span> <span data-ttu-id="29c3f-167">В обработчике событий `Application_Error` можно подключиться к базе данных и вставить запись в таблицу.</span><span class="sxs-lookup"><span data-stu-id="29c3f-167">In the `Application_Error` event handler you would then connect to the database and insert a record into the table.</span></span> <span data-ttu-id="29c3f-168">Аналогичным образом можно добавить код для оповещения разработчика об ошибке по электронной почте.</span><span class="sxs-lookup"><span data-stu-id="29c3f-168">Likewise, you could add code to alert a developer of the error via email.</span></span>

<span data-ttu-id="29c3f-169">Библиотеки регистрации ошибок, проверенные в следующих двух учебниках, обеспечивают такую функциональность, поэтому нет необходимости самостоятельно создавать журнал и уведомления об ошибках.</span><span class="sxs-lookup"><span data-stu-id="29c3f-169">The error logging libraries examined in the next two tutorials provide such functionality out of the box, so there's no need to build this error logging and notification yourself.</span></span> <span data-ttu-id="29c3f-170">Однако, чтобы продемонстрировать, что возникает событие `Error` и можно использовать обработчик событий `Application_Error` для регистрации сведений об ошибках и уведомления разработчика, добавим код, уведомляющий разработчика о возникновении ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-170">However, to illustrate that the `Error` event is being raised and that the `Application_Error` event handler can be used to log error details and notify a developer, let's add code that notifies a developer when an error occurs.</span></span>

## <a name="notifying-a-developer-when-an-unhandled-exception-occurs"></a><span data-ttu-id="29c3f-171">Уведомление разработчика при возникновении необработанного исключения</span><span class="sxs-lookup"><span data-stu-id="29c3f-171">Notifying a Developer When an Unhandled Exception Occurs</span></span>

<span data-ttu-id="29c3f-172">При возникновении необработанного исключения в рабочей среде важно оповещать группу разработчиков о том, что они могут оценить ошибку и определить, какие действия необходимо предпринять.</span><span class="sxs-lookup"><span data-stu-id="29c3f-172">When an unhandled exception occurs in the production environment it is important to alert the development team so that they can assess the error and determine what actions need to be taken.</span></span> <span data-ttu-id="29c3f-173">Например, если при подключении к базе данных возникает ошибка, необходимо дважды проверить строку подключения и, возможно, открыть запрос в службу поддержки с вашей компанией для размещения в Интернете.</span><span class="sxs-lookup"><span data-stu-id="29c3f-173">For example, if there is an error in connecting to the database then you'll need to double check your connection string and, perhaps, open a support ticket with your web hosting company.</span></span> <span data-ttu-id="29c3f-174">Если исключение возникло из-за ошибки программирования, может потребоваться добавить дополнительный код или логику проверки, чтобы предотвратить возникновение таких ошибок в будущем.</span><span class="sxs-lookup"><span data-stu-id="29c3f-174">If the exception occurred because of a programming error, additional code or validation logic may need to be added to prevent such errors in the future.</span></span>

<span data-ttu-id="29c3f-175">.NET Framework классы в [пространстве имен`System.Net.Mail`](https://msdn.microsoft.com/library/system.net.mail.aspx) упрощают отправку сообщения электронной почты.</span><span class="sxs-lookup"><span data-stu-id="29c3f-175">The .NET Framework classes in the [`System.Net.Mail` namespace](https://msdn.microsoft.com/library/system.net.mail.aspx) make it easy to send an email.</span></span> <span data-ttu-id="29c3f-176">[Класс`MailMessage`](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) представляет сообщение электронной почты и имеет такие свойства, как `To`, `From`, `Subject`, `Body`и `Attachments`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-176">The [`MailMessage` class](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) represents an email message and has properties like `To`, `From`, `Subject`, `Body`, and `Attachments`.</span></span> <span data-ttu-id="29c3f-177">`SmtpClass` используется для отправки объекта `MailMessage` с помощью указанного SMTP-сервера; параметры SMTP-сервера можно указать программно или декларативно в [элементе`<system.net>`](https://msdn.microsoft.com/library/6484zdc1.aspx) в `Web.config file`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-177">The `SmtpClass` is used to send a `MailMessage` object using a specified SMTP server; the SMTP server settings can be specified programmatically or declaratively in the [`<system.net>` element](https://msdn.microsoft.com/library/6484zdc1.aspx) in the `Web.config file`.</span></span> <span data-ttu-id="29c3f-178">Дополнительные сведения об отправке сообщений электронной почты в приложении ASP.NET см. в статье [Отправка электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)и [часто задаваемые вопросы о системе .NET. mail](http://systemnetmail.com/).</span><span class="sxs-lookup"><span data-stu-id="29c3f-178">For more information on sending email messages in an ASP.NET application check out my article, [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx), and the [System.Net.Mail FAQ](http://systemnetmail.com/).</span></span>

> [!NOTE]
> <span data-ttu-id="29c3f-179">Элемент `<system.net>` содержит параметры SMTP-сервера, используемые классом `SmtpClient` при отправке сообщения электронной почты.</span><span class="sxs-lookup"><span data-stu-id="29c3f-179">The `<system.net>` element contains the SMTP server settings used by the `SmtpClient` class when sending an email.</span></span> <span data-ttu-id="29c3f-180">У компании, в которой размещен веб-узел, вероятно, есть SMTP-сервер, который можно использовать для отправки электронной почты из приложения.</span><span class="sxs-lookup"><span data-stu-id="29c3f-180">Your web hosting company likely has an SMTP server that you can use to send email from your application.</span></span> <span data-ttu-id="29c3f-181">Дополнительные сведения о параметрах SMTP-сервера, которые следует использовать в приложении, см. в разделе о поддержке веб-узла.</span><span class="sxs-lookup"><span data-stu-id="29c3f-181">Consult your web host's support section for information on the SMTP server settings you should use in your web application.</span></span>

<span data-ttu-id="29c3f-182">Добавьте следующий код в обработчик событий `Application_Error`, чтобы отправить разработчику сообщение электронной почты при возникновении ошибки:</span><span class="sxs-lookup"><span data-stu-id="29c3f-182">Add the following code to the `Application_Error` event handler to send a developer an email when an error occurs:</span></span>

[!code-csharp[Main](processing-unhandled-exceptions-cs/samples/sample4.cs)]

<span data-ttu-id="29c3f-183">Хотя приведенный выше код довольно длинный, основная часть этого кода создает код HTML, который отображается в сообщении электронной почты, отправленном разработчику.</span><span class="sxs-lookup"><span data-stu-id="29c3f-183">While the above code is quite lengthy, the bulk of it creates the HTML that appears in the email sent to the developer.</span></span> <span data-ttu-id="29c3f-184">Код начинается с ссылки на `HttpException`, возвращаемый методом `GetLastError` (`lastErrorWrapper`).</span><span class="sxs-lookup"><span data-stu-id="29c3f-184">The code starts by referencing the `HttpException` returned by the `GetLastError` method (`lastErrorWrapper`).</span></span> <span data-ttu-id="29c3f-185">Фактическое исключение, вызванное запросом, извлекается с помощью `lastErrorWrapper.InnerException` и присваивается переменной `lastError`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-185">The actual exception that was raised by the request is retrieved via `lastErrorWrapper.InnerException` and is assigned to the variable `lastError`.</span></span> <span data-ttu-id="29c3f-186">Сведения о типе, сообщении и трассировке стека извлекаются из `lastError` и хранятся в трех строковых переменных.</span><span class="sxs-lookup"><span data-stu-id="29c3f-186">The type, message, and stack trace information is retrieved from `lastError` and stored in three string variables.</span></span>

<span data-ttu-id="29c3f-187">Затем создается объект `MailMessage` с именем `mm`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-187">Next, a `MailMessage` object named `mm` is created.</span></span> <span data-ttu-id="29c3f-188">Текст сообщения электронной почты форматируется в формате HTML и отображает URL-адрес запрашиваемой страницы, имя пользователя, выполнившего вход в систему, и сведения об исключении (тип, сообщение и трассировка стека).</span><span class="sxs-lookup"><span data-stu-id="29c3f-188">The email body is HTML formatted and displays the URL of the requested page, the name of the currently logged on user, and information about the exception (the type, message, and stack trace).</span></span> <span data-ttu-id="29c3f-189">Одно из замечательных особенностей класса `HttpException` заключается в том, что можно создать HTML-код, используемый для создания желтого экрана сведений об исключении (ИСОД), вызвав [метод жестмлеррормессаже](https://msdn.microsoft.com/library/system.web.httpexception.gethtmlerrormessage.aspx).</span><span class="sxs-lookup"><span data-stu-id="29c3f-189">One of the cool things about the `HttpException` class is that you can generate the HTML used to create the Exception Details Yellow Screen of Death (YSOD) by calling the [GetHtmlErrorMessage method](https://msdn.microsoft.com/library/system.web.httpexception.gethtmlerrormessage.aspx).</span></span> <span data-ttu-id="29c3f-190">Этот метод используется здесь для получения сведений об исключении ИСОД разметки и ее добавления в сообщение электронной почты в качестве вложения.</span><span class="sxs-lookup"><span data-stu-id="29c3f-190">This method is used here to retrieve the Exception Details YSOD markup and add it to the email as an attachment.</span></span> <span data-ttu-id="29c3f-191">Одно слово предостережения: Если исключение, вызвавшее событие `Error`, было исключением на основе HTTP (например, запрос несуществующей страницы), метод `GetHtmlErrorMessage` возвратит `null`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-191">One word of caution: if the exception that triggered the `Error` event was an HTTP-based exception (such as a request for a non-existent page) then the `GetHtmlErrorMessage` method will return `null`.</span></span>

<span data-ttu-id="29c3f-192">Последним шагом является отправка `MailMessage`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-192">The final step is to send the `MailMessage`.</span></span> <span data-ttu-id="29c3f-193">Это можно сделать, создав новый метод `SmtpClient` и вызвав его метод `Send`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-193">This is done by creating a new `SmtpClient` method and calling its `Send` method.</span></span>

> [!NOTE]
> <span data-ttu-id="29c3f-194">Перед использованием этого кода в веб-приложении необходимо изменить значения в константах `ToAddress` и `FromAddress` support@example.com на любой адрес электронной почты, на который будет отправлено электронное письмо с уведомлением об ошибке и откуда они берутся.</span><span class="sxs-lookup"><span data-stu-id="29c3f-194">Before using this code in your web application you'll want to change the values in the `ToAddress` and `FromAddress` constants from support@example.com to whatever email address the error notification email should be sent to and originate from.</span></span> <span data-ttu-id="29c3f-195">Кроме того, необходимо указать параметры SMTP-сервера в разделе `<system.net>` в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-195">You'll also need to specify SMTP server settings in the `<system.net>` section in `Web.config`.</span></span> <span data-ttu-id="29c3f-196">Обратитесь к поставщику веб-узла, чтобы определить параметры SMTP-сервера для использования.</span><span class="sxs-lookup"><span data-stu-id="29c3f-196">Consult your web host provider to determine the SMTP server settings to use.</span></span>

<span data-ttu-id="29c3f-197">С помощью этого кода в любое время при наличии ошибки разработчик отправляет сообщение электронной почты с описанием ошибки и содержит ИСОД.</span><span class="sxs-lookup"><span data-stu-id="29c3f-197">With this code in place anytime there's an error the developer is sent an email message that summarizes the error and includes the YSOD.</span></span> <span data-ttu-id="29c3f-198">В предыдущем учебном курсе мы продемонстрировали ошибку во время выполнения, посетив жанр. aspx и передавая недопустимое значение `ID` через строку запроса, например `Genre.aspx?ID=foo`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-198">In the preceding tutorial we demonstrated a runtime error by visiting Genre.aspx and passing in an invalid `ID` value through the querystring, like `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="29c3f-199">При посещении страницы с файлом `Global.asax` на месте создается то же взаимодействие с пользователем, что и в предыдущем учебнике. в среде разработки вы увидите желтое окно сведений об исключении, а в рабочей среде появится страница настраиваемой ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-199">Visiting the page with the `Global.asax` file in place produces the same user experience as in the preceding tutorial - in the development environment you'll continue to see the Exception Details Yellow Screen of Death, while in the production environment you'll see the custom error page.</span></span> <span data-ttu-id="29c3f-200">В дополнение к этому существующему поведению, разработчику отправляется сообщение электронной почты.</span><span class="sxs-lookup"><span data-stu-id="29c3f-200">In addition to this existing behavior, the developer is sent an email.</span></span>

<span data-ttu-id="29c3f-201">На **рис. 2** показано сообщение электронной почты, полученное при посещении `Genre.aspx?ID=foo`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-201">**Figure 2** shows the email received when visiting `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="29c3f-202">В тексте электронного письма суммируются сведения об исключении, а в `YSOD.htm` вложения отображается содержимое, отображаемое в сведениях об исключении ИСОД (см. **рис. 3**).</span><span class="sxs-lookup"><span data-stu-id="29c3f-202">The email body summarizes the exception information, while the `YSOD.htm` attachment displays the content that is shown in the Exception Details YSOD (see **Figure 3**).</span></span>

[![](processing-unhandled-exceptions-cs/_static/image5.png)](processing-unhandled-exceptions-cs/_static/image4.png)

<span data-ttu-id="29c3f-203">**Рис. 2**. разработчик отправил уведомление по электронной почте при наличии необработанного исключения</span><span class="sxs-lookup"><span data-stu-id="29c3f-203">**Figure 2**: The Developer Is Sent An Email Notification Whenever There's An Unhandled Exception</span></span>  
<span data-ttu-id="29c3f-204">([Щелкните, чтобы просмотреть изображение с полным размером](processing-unhandled-exceptions-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="29c3f-204">([Click to view full-size image](processing-unhandled-exceptions-cs/_static/image6.png))</span></span>

[![](processing-unhandled-exceptions-cs/_static/image8.png)](processing-unhandled-exceptions-cs/_static/image7.png)

<span data-ttu-id="29c3f-205">**Рис. 3**. уведомление по электронной почте содержит сведения об исключении Исод в виде вложения</span><span class="sxs-lookup"><span data-stu-id="29c3f-205">**Figure 3**: The Email Notification Includes the Exception Details YSOD As An Attachment</span></span>  
<span data-ttu-id="29c3f-206">([Щелкните, чтобы просмотреть изображение с полным размером](processing-unhandled-exceptions-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="29c3f-206">([Click to view full-size image](processing-unhandled-exceptions-cs/_static/image9.png))</span></span>

## <a name="what-about-using-the-custom-error-page"></a><span data-ttu-id="29c3f-207">Что насчет использования пользовательской страницы ошибок</span><span class="sxs-lookup"><span data-stu-id="29c3f-207">What About Using the Custom Error Page?</span></span>

<span data-ttu-id="29c3f-208">В этом учебнике было показано, как использовать `Global.asax` и обработчик событий `Application_Error` для выполнения кода при возникновении необработанного исключения.</span><span class="sxs-lookup"><span data-stu-id="29c3f-208">This tutorial showed how to use `Global.asax` and the `Application_Error` event handler to execute code when an unhandled exception occurs.</span></span> <span data-ttu-id="29c3f-209">В частности, мы использовали этот обработчик событий для уведомления разработчика об ошибке; Мы можем расширить его, чтобы также регистрировать сведения об ошибке в базе данных.</span><span class="sxs-lookup"><span data-stu-id="29c3f-209">Specifically, we used this event handler to notify a developer of an error; we could extend it to also log the error details in a database.</span></span> <span data-ttu-id="29c3f-210">Присутствие обработчика событий `Application_Error` не влияет на работу конечного пользователя.</span><span class="sxs-lookup"><span data-stu-id="29c3f-210">The presence of the `Application_Error` event handler does not affect the end user's experience.</span></span> <span data-ttu-id="29c3f-211">Они по-прежнему видят настроенную страницу ошибки, сведения об ошибке ИСОД, ошибку времени выполнения ИСОД или настраиваемую страницу ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-211">They still see the configured error page, be it the Error Details YSOD, the Runtime Error YSOD, or the custom error page.</span></span>

<span data-ttu-id="29c3f-212">Естественно определить, требуется ли `Global.asax` файл и `Application_Error` событие при использовании настраиваемой страницы ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-212">It's natural to wonder whether the `Global.asax` file and `Application_Error` event is necessary when using a custom error page.</span></span> <span data-ttu-id="29c3f-213">При возникновении ошибки пользователь отображается на странице настраиваемой ошибки, поэтому не удается разместить код для уведомления разработчика и записать сведения об ошибке в класс кода программной части настраиваемой страницы ошибки?</span><span class="sxs-lookup"><span data-stu-id="29c3f-213">When an error occurs the user is shown the custom error page so why can't we put the code to notify the developer and log the error details into the code-behind class of the custom error page?</span></span> <span data-ttu-id="29c3f-214">Хотя можно добавить код в класс кода программной части пользовательской страницы ошибок, у вас нет доступа к сведениям об исключении, вызвавшем событие `Error`, при использовании методики, рассмотренной в предыдущем руководстве.</span><span class="sxs-lookup"><span data-stu-id="29c3f-214">While you can certainly add code to the custom error page's code-behind class you do not have access to the details of the exception that triggered the `Error` event when using the technique we explored in the preceding tutorial.</span></span> <span data-ttu-id="29c3f-215">Вызов метода `GetLastError` со страницы настраиваемой ошибки возвращает `Nothing`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-215">Calling the `GetLastError` method from the custom error page returns `Nothing`.</span></span>

<span data-ttu-id="29c3f-216">Причина этого поведения заключается в том, что пользовательская страница ошибок достигается с помощью перенаправления.</span><span class="sxs-lookup"><span data-stu-id="29c3f-216">The reason for this behavior is because the custom error page is reached via a redirect.</span></span> <span data-ttu-id="29c3f-217">Когда необработанное исключение достигает среды выполнения ASP.NET, обработчик ASP.NET создает свое событие `Error` (которое выполняет `Application_Error` обработчик событий), а затем *перенаправляет* пользователя на настраиваемую страницу ошибки, выполняя `Response.Redirect(customErrorPageUrl)`.</span><span class="sxs-lookup"><span data-stu-id="29c3f-217">When an unhandled exception reaches the ASP.NET runtime the ASP.NET engine raises its `Error` event (which executes the `Application_Error` event handler) and then *redirects* the user to the custom error page by issuing a `Response.Redirect(customErrorPageUrl)`.</span></span> <span data-ttu-id="29c3f-218">Метод `Response.Redirect` отправляет клиенту ответ с кодом состояния HTTP 302, что дает возможность браузеру запрашивать новый URL-адрес, а именно — страницу настраиваемой ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-218">The `Response.Redirect` method sends a response to the client with an HTTP 302 status code, instructing the browser to request a new URL, namely the custom error page.</span></span> <span data-ttu-id="29c3f-219">Затем браузер автоматически запрашивает эту новую страницу.</span><span class="sxs-lookup"><span data-stu-id="29c3f-219">The browser then automatically requests this new page.</span></span> <span data-ttu-id="29c3f-220">Вы можете указать, что пользовательская страница ошибки была запрошена отдельно от страницы, на которой возникла ошибка, поскольку адресная строка браузера изменится на URL-адрес пользовательской страницы ошибок (см. **рис. 4**).</span><span class="sxs-lookup"><span data-stu-id="29c3f-220">You can tell that the custom error page was requested separately from the page where the error originated because the browser's Address bar changes to the custom error page URL (see **Figure 4**).</span></span>

[![](processing-unhandled-exceptions-cs/_static/image11.png)](processing-unhandled-exceptions-cs/_static/image10.png)

<span data-ttu-id="29c3f-221">**Рис. 4**. при возникновении ошибки браузер перенаправляется на URL-адрес настраиваемой страницы ошибок</span><span class="sxs-lookup"><span data-stu-id="29c3f-221">**Figure 4**: When an Error Occurs the Browser Gets Redirected to the Custom Error Page URL</span></span>  
<span data-ttu-id="29c3f-222">([Щелкните, чтобы просмотреть изображение с полным размером](processing-unhandled-exceptions-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="29c3f-222">([Click to view full-size image](processing-unhandled-exceptions-cs/_static/image12.png))</span></span>

<span data-ttu-id="29c3f-223">Побочным результатом является то, что запрос, в котором произошло необработанное исключение, заканчивается, когда сервер отвечает на перенаправление HTTP 302.</span><span class="sxs-lookup"><span data-stu-id="29c3f-223">The net effect is that the request where the unhandled exception occurred ends when the server responds with the HTTP 302 redirect.</span></span> <span data-ttu-id="29c3f-224">Последующий запрос к пользовательской странице ошибок — это новый запрос. к этому моменту модуль ASP.NET отменил сведения об ошибке и, более того, не имеет способа связать необработанное исключение в предыдущем запросе с новым запросом для настраиваемой страницы ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-224">The subsequent request to the custom error page is a brand new request; by this point the ASP.NET engine has discarded the error information and, moreover, has no way to associate the unhandled exception in the previous request with the new request for the custom error page.</span></span> <span data-ttu-id="29c3f-225">Именно поэтому `GetLastError` возвращает `null` при вызове со страницы настраиваемой ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-225">This is why `GetLastError` returns `null` when called from the custom error page.</span></span>

<span data-ttu-id="29c3f-226">Тем не менее, пользовательская страница ошибок может быть выполнена во время того же запроса, что привело к ошибке.</span><span class="sxs-lookup"><span data-stu-id="29c3f-226">However, it is possible to have the custom error page executed during the same request that caused the error.</span></span> <span data-ttu-id="29c3f-227">Метод [`Server.Transfer(url)`](https://msdn.microsoft.com/library/system.web.httpserverutility.transfer.aspx) передает выполнение на указанный URL-адрес и обрабатывает его в рамках одного запроса.</span><span class="sxs-lookup"><span data-stu-id="29c3f-227">The [`Server.Transfer(url)`](https://msdn.microsoft.com/library/system.web.httpserverutility.transfer.aspx) method transfers execution to the specified URL and processes it within the same request.</span></span> <span data-ttu-id="29c3f-228">Код можно переместить в обработчик событий `Application_Error` в класс кода программной части пользовательской страницы ошибки, заменив его в `Global.asax` следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="29c3f-228">You could move the code in the `Application_Error` event handler to the custom error page's code-behind class, replacing it in `Global.asax` with the following code:</span></span>

[!code-csharp[Main](processing-unhandled-exceptions-cs/samples/sample5.cs)]

<span data-ttu-id="29c3f-229">Теперь при возникновении необработанного исключения обработчик событий `Application_Error` передает управление соответствующей пользовательской странице ошибок на основе кода состояния HTTP.</span><span class="sxs-lookup"><span data-stu-id="29c3f-229">Now when an unhandled exception occurs the `Application_Error` event handler transfers control to the appropriate custom error page based on the HTTP status code.</span></span> <span data-ttu-id="29c3f-230">Так как управление было передано, пользовательская страница ошибки имеет доступ к необработанным сведениям об исключении через `Server.GetLastError` и может уведомлять разработчика об ошибке и регистрировать ее сведения.</span><span class="sxs-lookup"><span data-stu-id="29c3f-230">Because control was transferred, the custom error page has access to the unhandled exception information via `Server.GetLastError` and can notify a developer of the error and log its details.</span></span> <span data-ttu-id="29c3f-231">Вызов `Server.Transfer` останавливает перенаправление пользователя на настраиваемую страницу ошибки с помощью ASP.NET Engine.</span><span class="sxs-lookup"><span data-stu-id="29c3f-231">The `Server.Transfer` call stops the ASP.NET engine from redirecting the user to the custom error page.</span></span> <span data-ttu-id="29c3f-232">Вместо этого содержимое страницы пользовательской ошибки возвращается в качестве ответа на страницу, вызвавшую ошибку.</span><span class="sxs-lookup"><span data-stu-id="29c3f-232">Instead, the custom error page's content is returned as the response to the page that generated the error.</span></span>

## <a name="summary"></a><span data-ttu-id="29c3f-233">Сводка</span><span class="sxs-lookup"><span data-stu-id="29c3f-233">Summary</span></span>

<span data-ttu-id="29c3f-234">Когда в веб-приложении ASP.NET возникает необработанное исключение, среда выполнения ASP.NET вызывает событие `Error` и отображает настроенную страницу ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-234">When an unhandled exception occurs in an ASP.NET web application the ASP.NET runtime raises the `Error` event and displays the configured error page.</span></span> <span data-ttu-id="29c3f-235">Мы можем уведомить разработчика об ошибке, записать сведения о ней или обработать ее другим способом, создав обработчик событий для события ошибки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-235">We can notify the developer of the error, log its details, or process it in some other fashion, by creating an event handler for the Error event.</span></span> <span data-ttu-id="29c3f-236">Существует два способа создания обработчика событий для `HttpApplication` событий, таких как `Error`: в `Global.asax` файле или из модуля HTTP.</span><span class="sxs-lookup"><span data-stu-id="29c3f-236">There are two ways to create an event handler for `HttpApplication` events like `Error`: in the `Global.asax` file or from an HTTP Module.</span></span> <span data-ttu-id="29c3f-237">В этом учебнике было показано, как создать обработчик событий `Error` в `Global.asax` файле, который уведомляет разработчиков об ошибке с помощью сообщения электронной почты.</span><span class="sxs-lookup"><span data-stu-id="29c3f-237">This tutorial showed how to create an `Error` event handler in the `Global.asax` file that notifies developers of an error by means of an email message.</span></span>

<span data-ttu-id="29c3f-238">Создание обработчика `Error` событий полезно, если необходимо обрабатывать необработанные исключения в определенном уникальном или настраиваемом виде.</span><span class="sxs-lookup"><span data-stu-id="29c3f-238">Creating an `Error` event handler is useful if you need to process unhandled exceptions in some unique or customized manner.</span></span> <span data-ttu-id="29c3f-239">Тем не менее, создание собственного обработчика `Error` событий для регистрации исключения или уведомления разработчика не является самым эффективным способом, поскольку уже существуют бесплатные и удобные в использовании библиотеки регистрации ошибок, которые можно настроить в течение нескольких минут.</span><span class="sxs-lookup"><span data-stu-id="29c3f-239">However, creating your own `Error` event handler to log the exception or to notify a developer is not the most efficient use of your time as there already exist free and easy to use error logging libraries that can be setup in a matter of minutes.</span></span> <span data-ttu-id="29c3f-240">В следующих двух учебниках рассматриваются две такие библиотеки.</span><span class="sxs-lookup"><span data-stu-id="29c3f-240">The next two tutorials examine two such libraries.</span></span>

<span data-ttu-id="29c3f-241">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="29c3f-241">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="29c3f-242">Дополнительные материалы</span><span class="sxs-lookup"><span data-stu-id="29c3f-242">Further Reading</span></span>

<span data-ttu-id="29c3f-243">Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:</span><span class="sxs-lookup"><span data-stu-id="29c3f-243">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="29c3f-244">ASP.NET HTTP-модули и общие сведения о обработчиках HTTP</span><span class="sxs-lookup"><span data-stu-id="29c3f-244">ASP.NET HTTP Modules and HTTP Handlers Overview</span></span>](https://support.microsoft.com/kb/307985)
- [<span data-ttu-id="29c3f-245">Корректное реагирование на необработанные исключения — обработка необработанных исключений</span><span class="sxs-lookup"><span data-stu-id="29c3f-245">Gracefully Responding to Unhandled Exceptions - Processing Unhandled Exceptions</span></span>](http://aspnet.4guysfromrolla.com/articles/091306-1.aspx)
- [<span data-ttu-id="29c3f-246">Класс `HttpApplication` и объект приложения ASP.NET</span><span class="sxs-lookup"><span data-stu-id="29c3f-246">`HttpApplication` Class and the ASP.NET Application Object</span></span>](http://www.eggheadcafe.com/articles/20030211.asp)
- [<span data-ttu-id="29c3f-247">Обработчики HTTP и HTTP-модули в ASP.NET</span><span class="sxs-lookup"><span data-stu-id="29c3f-247">HTTP Handlers and HTTP Modules in ASP.NET</span></span>](http://www.15seconds.com/Issue/020417.htm)
- [<span data-ttu-id="29c3f-248">Отправка электронной почты в ASP.NET</span><span class="sxs-lookup"><span data-stu-id="29c3f-248">Sending Email in ASP.NET</span></span>](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)
- [<span data-ttu-id="29c3f-249">Основные сведения о файле `Global.asax`</span><span class="sxs-lookup"><span data-stu-id="29c3f-249">Understanding the `Global.asax` File</span></span>](http://aspalliance.com/1114_Understanding_the_Globalasax_file.all)
- [<span data-ttu-id="29c3f-250">Использование модулей и обработчиков HTTP для создания подключаемых компонентов ASP.NET</span><span class="sxs-lookup"><span data-stu-id="29c3f-250">Using HTTP Modules and Handlers to Create Pluggable ASP.NET Components</span></span>](https://msdn.microsoft.com/library/aa479332.aspx)
- [<span data-ttu-id="29c3f-251">Работа с файлом `Global.asax` ASP.NET</span><span class="sxs-lookup"><span data-stu-id="29c3f-251">Working with the ASP.NET `Global.asax` File</span></span>](http://articles.techrepublic.com.com/5100-10878_11-5771721.html)
- [<span data-ttu-id="29c3f-252">Работа с экземплярами `HttpApplication`</span><span class="sxs-lookup"><span data-stu-id="29c3f-252">Working with `HttpApplication` Instances</span></span>](https://msdn.microsoft.com/library/a0xez8f2.aspx)

> [!div class="step-by-step"]
> <span data-ttu-id="29c3f-253">[Назад](displaying-a-custom-error-page-cs.md)
> [Вперед](logging-error-details-with-asp-net-health-monitoring-cs.md)</span><span class="sxs-lookup"><span data-stu-id="29c3f-253">[Previous](displaying-a-custom-error-page-cs.md)
[Next](logging-error-details-with-asp-net-health-monitoring-cs.md)</span></span>
