---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-vb
title: Обработка необработанных исключений (VB) | Документация Майкрософт
author: rick-anderson
description: При возникновении ошибки времени выполнения для веб-приложения в рабочей среде важно уведомить разработчика и зарегистрировать ошибку, чтобы ее можно было диагностировать в La...
ms.author: riande
ms.date: 06/09/2009
ms.assetid: 051296f0-9519-4e78-835c-d868da13b0a0
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-vb
msc.type: authoredcontent
ms.openlocfilehash: 8d2e12af29bd95ce9898fa6a5e81be8b7a761f76
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78473640"
---
# <a name="processing-unhandled-exceptions-vb"></a>Обработка необработанных исключений (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Просмотреть или скачать образец кода](https://github.com/dotnet/AspNetDocs/tree/master/aspnet/web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-vb/samples) ([как скачивать](/aspnet/core/tutorials/index#how-to-download-a-sample))

> При возникновении ошибки времени выполнения для веб-приложения в рабочей среде важно уведомить разработчика и зарегистрировать ошибку, чтобы ее можно было диагностировать в более поздней момент времени. В этом учебнике содержатся общие сведения о том, как ASP.NET обрабатывает ошибки времени выполнения и просматривает один из способов выполнения пользовательского кода всякий раз, когда необработанное исключение передается в среду выполнения ASP.NET.

## <a name="introduction"></a>Введение

Когда в приложении ASP.NET возникает необработанное исключение, оно передается в среду выполнения ASP.NET, которая вызывает событие `Error` и отображает соответствующую страницу ошибки. Существует три разных типа страниц ошибок: желтый экран "ошибка времени выполнения" (ИСОД); Сведения об исключении ИСОД; и пользовательские страницы ошибок. В [предыдущем учебном курсе](displaying-a-custom-error-page-vb.md) мы настроили приложение на использование настраиваемой страницы ошибок для удаленных пользователей и сведений об исключении, исод для пользователей, посещенных локально.

Использование удобной для пользователя настраиваемой страницы ошибок, которая соответствует внешнему интерфейсу веб-узла, является предпочтительным для ошибки времени выполнения по умолчанию ИСОД, но отображение пользовательской страницы ошибки — лишь одна часть комплексного решения по обработке ошибок. При возникновении ошибки в приложении в рабочей среде важно, чтобы разработчики получали извещение об ошибке, чтобы они могли неземлеть причину исключения и устранить ее. Более того, сведения об ошибке необходимо регистрировать, чтобы можно было исследовать и диагностировать ошибку в более позднем моменте времени.

В этом руководстве показано, как получить доступ к сведениям о необработанном исключении, чтобы они могли быть зарегистрированы и были уведомлены для разработчиков. В двух учебниках, которые следуют за этим одним из этих руководств, рассматриваются библиотеки регистрации ошибок, которые после установки ряда настроек автоматически уведомляют разработчиков об ошибках времени выполнения и записывает сведения о них.

> [!NOTE]
> Сведения, которые проверяются в этом учебнике, наиболее полезны, если необходимо обрабатывать необработанные исключения особым образом или индивидуально. В случаях, когда требуется только регистрировать исключение и уведомлять разработчика, можно использовать библиотеку регистрации ошибок. В следующих двух учебниках представлен обзор двух таких библиотек.

## <a name="executing-code-when-theerrorevent-is-raised"></a>Исполнение кода при возникновении события`Error`

События предоставляют объекту механизм для сигнализации о том, что произошло нечто интересное, а другой объект — для выполнения кода в ответе. Как разработчик ASP.NET вы привыкли думать о событиях. Если вы хотите выполнить некоторый код, когда посетитель щелкнет определенную кнопку, создайте обработчик событий для `Click` события этой кнопки и разместите код там. Учитывая, что среда выполнения ASP.NET создает свое [событие`Error`](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx) всякий раз, когда возникает необработанное исключение, он следует за тем, чтобы код, который записывает сведения об ошибке, перейдет в обработчик событий. Но как создать обработчик событий для `Error` события?

Событие `Error` является одним из многих событий в [классе`HttpApplication`](https://msdn.microsoft.com/library/system.web.httpapplication.aspx) , которые вызываются на определенных этапах конвейера HTTP в течение времени существования запроса. Например, [событие`BeginRequest`](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx) класса `HttpApplication` возникает в начале каждого запроса. его [`AuthenticateRequest` событие](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) возникает, когда модуль безопасности определил запрашивающий. Эти `HttpApplication` события дают разработчику страницы возможность выполнять пользовательскую логику в различных точках времени существования запроса.

Обработчики событий для событий `HttpApplication` можно поместить в специальный файл с именем `Global.asax`. Чтобы создать этот файл на веб-сайте, добавьте новый элемент в корневую папку веб-сайта, используя шаблон глобального класса приложений с именем `Global.asax`.

[![](processing-unhandled-exceptions-vb/_static/image2.png)](processing-unhandled-exceptions-vb/_static/image1.png)

**Рис. 1**. Добавление `Global.asax` в веб-приложение  
 ([Щелкните, чтобы просмотреть изображение с полным размером](processing-unhandled-exceptions-vb/_static/image3.png))

Содержимое и структура файла `Global.asax`, созданного Visual Studio, немного отличаются в зависимости от того, используется ли проект веб-приложения (WAP) или проект веб-сайта (WSP). С помощью WAP `Global.asax` реализуется как два отдельных файла — `Global.asax` и `Global.asax.vb`. Файл `Global.asax` не содержит ничего, Кроме директивы `@Application`, которая ссылается на файл `.vb`; интересующие вас обработчики событий определяются в файле `Global.asax.vb`. Для ВСПС создается только один файл, `Global.asax`, а обработчики событий определяются в блоке `<script runat="server">`.

Файл `Global.asax`, созданный в шаблоне глобального приложения WAP в Visual Studio, содержит обработчики событий с именами `Application_BeginRequest`, `Application_AuthenticateRequest`и `Application_Error`, которые являются обработчиками событий `HttpApplication` `BeginRequest`, `AuthenticateRequest`и `Error`соответственно. Существуют также обработчики событий с именами `Application_Start`, `Session_Start`, `Application_End`и `Session_End`. это обработчики событий, которые срабатывают при запуске веб-приложения, когда запускается новый сеанс, когда приложение завершается и когда сеанс завершается соответственно. Файл `Global.asax`, созданный в WSP Visual Studio, содержит только обработчики событий `Application_Error`, `Application_Start`, `Session_Start`, `Application_End`и `Session_End`.

> [!NOTE]
> При развертывании приложения ASP.NET необходимо скопировать файл `Global.asax` в рабочую среду. Файл `Global.asax.vb`, созданный в WAP, не нужно копировать в рабочую среду, так как этот код компилируется в сборку проекта.

Обработчики событий, созданные с помощью шаблона глобального приложения Visual Studio, не являются исчерпывающими. Можно добавить обработчик событий для любого `HttpApplication` события, назвав `Application_EventName`обработчика событий. Например, можно добавить следующий код в файл `Global.asax`, чтобы создать обработчик событий для [события`AuthorizeRequest`](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx):

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample1.vb)]

Аналогичным образом можно удалить все обработчики событий, созданные ненужным шаблоном глобального класса приложений. В этом руководстве для события `Error` требуется только обработчик событий. Вы можете удалить другие обработчики событий из файла `Global.asax`.

> [!NOTE]
> *HTTP-модули* предлагают еще один способ определения обработчиков событий для `HttpApplication` событий. Модули HTTP создаются как файл класса, который можно разместить непосредственно в проекте веб-приложения или разделить в отдельную библиотеку классов. Так как они могут быть разделены на библиотеку классов, модули HTTP предлагают более гибкую и многократно используемую модель для создания `HttpApplication` обработчиков событий. В то время как файл `Global.asax` зависит от веб-приложения, в котором оно находится, модули HTTP могут быть скомпилированы в сборки, после чего Добавление модуля HTTP на веб-сайт выполняется так же просто, как удаление сборки из папки `Bin` и регистрация модуля в `Web.config`. В этом учебнике не рассматривается создание и использование модулей HTTP, но две библиотеки регистрации ошибок, используемые в следующих двух учебниках, реализуются как модули HTTP. Дополнительные сведения о преимуществах модулей HTTP см. в статье [Использование модулей и обработчиков HTTP для создания подключаемых компонентов ASP.NET](https://msdn.microsoft.com/library/aa479332.aspx).

## <a name="retrieving-information-about-the-unhandled-exception"></a>Получение сведений о необработанном исключении

На этом этапе у нас есть файл Global. asax с обработчиком событий `Application_Error`. При выполнении этого обработчика событий необходимо уведомить разработчика об ошибке и записать сведения о нем. Для выполнения этих задач сначала необходимо определить сведения о возникшем исключении. Используйте [метод`GetLastError`](https://msdn.microsoft.com/library/system.web.httpserverutility.getlasterror.aspx) объекта Server для получения сведений о необработанном исключении, которое привело к срабатыванию события `Error`.

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample2.vb)]

Метод `GetLastError` возвращает объект типа `Exception`, который является базовым типом для всех исключений в .NET Framework. Однако в приведенном выше коде объект исключения, возвращенный `GetLastError`, передается в объект `HttpException`. Если событие `Error` срабатывает из-за возникновения исключения во время обработки ресурса ASP.NET, то созданное исключение упаковывается в `HttpException`. Чтобы получить фактическое исключение, причиной событие ошибки, используйте свойство `InnerException`. Если событие `Error` возникло из-за исключения на основе HTTP, например запроса к несуществующей странице, создается `HttpException`, но нет внутреннего исключения.

Следующий код использует `GetLastErrormessage` для получения сведений об исключении, вызвавшем событие `Error`, сохраняя `HttpException` в переменной с именем `lastErrorWrapper`. Затем он сохраняет тип, сообщение и трассировку стека исходного исключения в трех строковых переменных, проверяя, является ли `lastErrorWrapper` фактическим исключением, вызвавшим событие `Error` (в случае с исключениями на основе HTTP) или только оболочкой для исключения, созданного при обработке запроса.

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample3.vb)]

На этом этапе у вас есть вся информация, необходимая для написания кода, который будет записывать сведения об исключении в таблицу базы данных. Можно создать таблицу базы данных со столбцами для каждой из подробных сведений об ошибках — типа, сообщения, трассировки стека и т. д. Вместе с другими полезными сведениями, такими как URL-адрес запрашиваемой страницы и имя пользователя, выполнившего вход в систему. В обработчике событий `Application_Error` можно подключиться к базе данных и вставить запись в таблицу. Аналогичным образом можно добавить код для оповещения разработчика об ошибке по электронной почте.

Библиотеки регистрации ошибок, проверенные в следующих двух учебниках, обеспечивают такую функциональность, поэтому нет необходимости самостоятельно создавать журнал и уведомления об ошибках. Однако, чтобы продемонстрировать, что возникает событие `Error` и можно использовать обработчик событий `Application_Error` для регистрации сведений об ошибках и уведомления разработчика, добавим код, уведомляющий разработчика о возникновении ошибки.

## <a name="notifying-a-developer-when-an-unhandled-exception-occurs"></a>Уведомление разработчика при возникновении необработанного исключения

При возникновении необработанного исключения в рабочей среде важно оповещать группу разработчиков о том, что они могут оценить ошибку и определить, какие действия необходимо предпринять. Например, если при подключении к базе данных возникает ошибка, необходимо дважды проверить строку подключения и, возможно, открыть запрос в службу поддержки с вашей компанией для размещения в Интернете. Если исключение возникло из-за ошибки программирования, может потребоваться добавить дополнительный код или логику проверки, чтобы предотвратить возникновение таких ошибок в будущем.

.NET Framework классы в [пространстве имен`System.Net.Mail`](https://msdn.microsoft.com/library/system.net.mail.aspx) упрощают отправку сообщения электронной почты. [Класс`MailMessage`](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) представляет сообщение электронной почты и имеет такие свойства, как `To`, `From`, `Subject`, `Body`и `Attachments`. `SmtpClass` используется для отправки объекта `MailMessage` с помощью указанного SMTP-сервера; параметры SMTP-сервера можно указать программно или декларативно в [элементе`<system.net>`](https://msdn.microsoft.com/library/6484zdc1.aspx) в `Web.config file`. Дополнительные сведения об отправке сообщений электронной почты в приложении ASP.NET см. в статье [Отправка электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)и [часто задаваемые вопросы о системе .NET. mail](http://systemnetmail.com/).

> [!NOTE]
> Элемент `<system.net>` содержит параметры SMTP-сервера, используемые классом `SmtpClient` при отправке сообщения электронной почты. У компании, в которой размещен веб-узел, вероятно, есть SMTP-сервер, который можно использовать для отправки электронной почты из приложения. Дополнительные сведения о параметрах SMTP-сервера, которые следует использовать в приложении, см. в разделе о поддержке веб-узла.

Добавьте следующий код в обработчик событий `Application_Error`, чтобы отправить разработчику сообщение электронной почты при возникновении ошибки:

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample4.vb)]

Хотя приведенный выше код довольно длинный, основная часть этого кода создает код HTML, который отображается в сообщении электронной почты, отправленном разработчику. Код начинается с ссылки на `HttpException`, возвращаемый методом `GetLastError` (`lastErrorWrapper`). Фактическое исключение, вызванное запросом, извлекается с помощью `lastErrorWrapper.InnerException` и присваивается переменной `lastError`. Сведения о типе, сообщении и трассировке стека извлекаются из `lastError` и хранятся в трех строковых переменных.

Затем создается объект `MailMessage` с именем `mm`. Текст сообщения электронной почты форматируется в формате HTML и отображает URL-адрес запрашиваемой страницы, имя пользователя, выполнившего вход в систему, и сведения об исключении (тип, сообщение и трассировка стека). Одно из замечательных особенностей класса `HttpException` заключается в том, что можно создать HTML-код, используемый для создания желтого экрана сведений об исключении (ИСОД), вызвав [метод жестмлеррормессаже](https://msdn.microsoft.com/library/system.web.httpexception.gethtmlerrormessage.aspx). Этот метод используется здесь для получения сведений об исключении ИСОД разметки и ее добавления в сообщение электронной почты в качестве вложения. Одно слово предостережения: Если исключение, вызвавшее событие `Error`, было исключением на основе HTTP (например, запрос несуществующей страницы), метод `GetHtmlErrorMessage` возвратит `null`.

Последним шагом является отправка `MailMessage`. Это можно сделать, создав новый метод `SmtpClient` и вызвав его метод `Send`.

> [!NOTE]
> Перед использованием этого кода в веб-приложении необходимо изменить значения в константах `ToAddress` и `FromAddress` support@example.com на любой адрес электронной почты, на который будет отправлено электронное письмо с уведомлением об ошибке и откуда они берутся. Кроме того, необходимо указать параметры SMTP-сервера в разделе `<system.net>` в `Web.config`. Обратитесь к поставщику веб-узла, чтобы определить параметры SMTP-сервера для использования.

С помощью этого кода в любое время при наличии ошибки разработчик отправляет сообщение электронной почты с описанием ошибки и содержит ИСОД. В предыдущем учебном курсе мы продемонстрировали ошибку во время выполнения, посетив жанр. aspx и передавая недопустимое значение `ID` через строку запроса, например `Genre.aspx?ID=foo`. При посещении страницы с файлом `Global.asax` на месте создается то же взаимодействие с пользователем, что и в предыдущем учебнике. в среде разработки вы увидите желтое окно сведений об исключении, а в рабочей среде появится страница настраиваемой ошибки. В дополнение к этому существующему поведению, разработчику отправляется сообщение электронной почты.

На **рис. 2** показано сообщение электронной почты, полученное при посещении `Genre.aspx?ID=foo`. В тексте электронного письма суммируются сведения об исключении, а в `YSOD.htm` вложения отображается содержимое, отображаемое в сведениях об исключении ИСОД (см. **рис. 3**).

[![](processing-unhandled-exceptions-vb/_static/image5.png)](processing-unhandled-exceptions-vb/_static/image4.png)

**Рис. 2**. разработчик отправил уведомление по электронной почте при наличии необработанного исключения  
 ([Щелкните, чтобы просмотреть изображение с полным размером](processing-unhandled-exceptions-vb/_static/image6.png))

[![](processing-unhandled-exceptions-vb/_static/image8.png)](processing-unhandled-exceptions-vb/_static/image7.png)

**Рис. 3**. уведомление по электронной почте содержит сведения об исключении Исод в виде вложения  
 ([Щелкните, чтобы просмотреть изображение с полным размером](processing-unhandled-exceptions-vb/_static/image9.png))

## <a name="what-about-using-the-custom-error-page"></a>Что насчет использования пользовательской страницы ошибок

В этом учебнике было показано, как использовать `Global.asax` и обработчик событий `Application_Error` для выполнения кода при возникновении необработанного исключения. В частности, мы использовали этот обработчик событий для уведомления разработчика об ошибке; Мы можем расширить его, чтобы также регистрировать сведения об ошибке в базе данных. Присутствие обработчика событий `Application_Error` не влияет на работу конечного пользователя. Они по-прежнему видят настроенную страницу ошибки, сведения об ошибке ИСОД, ошибку времени выполнения ИСОД или настраиваемую страницу ошибки.

Естественно определить, требуется ли `Global.asax` файл и `Application_Error` событие при использовании настраиваемой страницы ошибки. При возникновении ошибки пользователь отображается на странице настраиваемой ошибки, поэтому не удается разместить код для уведомления разработчика и записать сведения об ошибке в класс кода программной части настраиваемой страницы ошибки? Хотя можно добавить код в класс кода программной части пользовательской страницы ошибок, у вас нет доступа к сведениям об исключении, вызвавшем событие `Error`, при использовании методики, рассмотренной в предыдущем руководстве. Вызов метода `GetLastError` со страницы настраиваемой ошибки возвращает `Nothing`.

Причина этого поведения заключается в том, что пользовательская страница ошибок достигается с помощью перенаправления. Когда необработанное исключение достигает среды выполнения ASP.NET, обработчик ASP.NET создает свое событие `Error` (которое выполняет `Application_Error` обработчик событий), а затем *перенаправляет* пользователя на настраиваемую страницу ошибки, выполняя `Response.Redirect(customErrorPageUrl)`. Метод `Response.Redirect` отправляет клиенту ответ с кодом состояния HTTP 302, что дает возможность браузеру запрашивать новый URL-адрес, а именно — страницу настраиваемой ошибки. Затем браузер автоматически запрашивает эту новую страницу. Вы можете указать, что пользовательская страница ошибки была запрошена отдельно от страницы, на которой возникла ошибка, поскольку адресная строка браузера изменится на URL-адрес пользовательской страницы ошибок (см. **рис. 4**).

[![](processing-unhandled-exceptions-vb/_static/image11.png)](processing-unhandled-exceptions-vb/_static/image10.png)

**Рис. 4**. при возникновении ошибки браузер перенаправляется на URL-адрес настраиваемой страницы ошибок  
 ([Щелкните, чтобы просмотреть изображение с полным размером](processing-unhandled-exceptions-vb/_static/image12.png))

Побочным результатом является то, что запрос, в котором произошло необработанное исключение, заканчивается, когда сервер отвечает на перенаправление HTTP 302. Последующий запрос к пользовательской странице ошибок — это новый запрос. к этому моменту модуль ASP.NET отменил сведения об ошибке и, более того, не имеет способа связать необработанное исключение в предыдущем запросе с новым запросом для настраиваемой страницы ошибки. Именно поэтому `GetLastError` возвращает `null` при вызове со страницы настраиваемой ошибки.

Тем не менее, пользовательская страница ошибок может быть выполнена во время того же запроса, что привело к ошибке. Метод [`Server.Transfer(url)`](https://msdn.microsoft.com/library/system.web.httpserverutility.transfer.aspx) передает выполнение на указанный URL-адрес и обрабатывает его в рамках одного запроса. Код можно переместить в обработчик событий `Application_Error` в класс кода программной части пользовательской страницы ошибки, заменив его в `Global.asax` следующим кодом:

[!code-vb[Main](processing-unhandled-exceptions-vb/samples/sample5.vb)]

Теперь при возникновении необработанного исключения обработчик событий `Application_Error` передает управление соответствующей пользовательской странице ошибок на основе кода состояния HTTP. Так как управление было передано, пользовательская страница ошибки имеет доступ к необработанным сведениям об исключении через `Server.GetLastError` и может уведомлять разработчика об ошибке и регистрировать ее сведения. Вызов `Server.Transfer` останавливает перенаправление пользователя на настраиваемую страницу ошибки с помощью ASP.NET Engine. Вместо этого содержимое страницы пользовательской ошибки возвращается в качестве ответа на страницу, вызвавшую ошибку.

## <a name="summary"></a>Сводка

Когда в веб-приложении ASP.NET возникает необработанное исключение, среда выполнения ASP.NET вызывает событие `Error` и отображает настроенную страницу ошибки. Мы можем уведомить разработчика об ошибке, записать сведения о ней или обработать ее другим способом, создав обработчик событий для события ошибки. Существует два способа создания обработчика событий для `HttpApplication` событий, таких как `Error`: в `Global.asax` файле или из модуля HTTP. В этом учебнике было показано, как создать обработчик событий `Error` в `Global.asax` файле, который уведомляет разработчиков об ошибке с помощью сообщения электронной почты.

Создание обработчика `Error` событий полезно, если необходимо обрабатывать необработанные исключения в определенном уникальном или настраиваемом виде. Тем не менее, создание собственного обработчика `Error` событий для регистрации исключения или уведомления разработчика не является самым эффективным способом, поскольку уже существуют бесплатные и удобные в использовании библиотеки регистрации ошибок, которые можно настроить в течение нескольких минут. В следующих двух учебниках рассматриваются две такие библиотеки.

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [ASP.NET HTTP-модули и общие сведения о обработчиках HTTP](https://support.microsoft.com/kb/307985)
- [Корректное реагирование на необработанные исключения — обработка необработанных исключений](http://aspnet.4guysfromrolla.com/articles/091306-1.aspx)
- [Класс `HttpApplication` и объект приложения ASP.NET](http://www.eggheadcafe.com/articles/20030211.asp)
- [Обработчики HTTP и HTTP-модули в ASP.NET](http://www.15seconds.com/Issue/020417.htm)
- [Отправка электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)
- [Основные сведения о файле `Global.asax`](http://aspalliance.com/1114_Understanding_the_Globalasax_file.all)
- [Использование модулей и обработчиков HTTP для создания подключаемых компонентов ASP.NET](https://msdn.microsoft.com/library/aa479332.aspx)
- [Работа с файлом `Global.asax` ASP.NET](http://articles.techrepublic.com.com/5100-10878_11-5771721.html)
- [Работа с экземплярами `HttpApplication`](https://msdn.microsoft.com/library/a0xez8f2.aspx)

> [!div class="step-by-step"]
> [Назад](displaying-a-custom-error-page-vb.md)
> [Вперед](logging-error-details-with-asp-net-health-monitoring-vb.md)
