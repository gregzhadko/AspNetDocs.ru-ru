---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/strategies-for-database-development-and-deployment-cs
title: Стратегии разработки и развертывания баз данных (C#) | Документация Майкрософт
author: rick-anderson
description: При первом развертывании приложения, управляемого данными, можно в первый раз скопировать базу данных в среду разработки в рабочую среду. B...
ms.author: riande
ms.date: 04/23/2009
ms.assetid: 3e8b0627-3eb7-488e-807e-067cba7cec05
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/strategies-for-database-development-and-deployment-cs
msc.type: authoredcontent
ms.openlocfilehash: 4d9dbaf41926b43af171619ee34f58da84b5dab1
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78509388"
---
# <a name="strategies-for-database-development-and-deployment-c"></a>Стратегии разработки и развертывания баз данных (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать в формате PDF](https://download.microsoft.com/download/C/3/9/C391A649-B357-4A7B-BAA4-48C96871FEA6/aspnet_tutorial10_DBDevel_cs.pdf)

> При первом развертывании приложения, управляемого данными, можно в первый раз скопировать базу данных в среду разработки в рабочую среду. Но при последующих развертываниях при выполнении скрытой копии все данные, содержащиеся в рабочей базе данных, будут перезаписаны. Вместо этого развертывание базы данных включает в себя применение изменений, внесенных в базу данных разработки с момента последнего развертывания в рабочей базе данных. В этом учебнике рассматриваются эти проблемы и предлагаются различные стратегии для помощи с хрониками и применением изменений, внесенных в базу данных с момента последнего развертывания.

## <a name="introduction"></a>Введение

Как обсуждалось в предыдущих руководствах, развертывание приложения ASP.NET влечет за собой копирование нужного содержимого из среды разработки в рабочую среду. Развертывание — это не одноразовое событие, но и то, что происходит каждый раз при выпуске новой версии программного обеспечения, а также при обнаружении и устранении ошибок или проблем безопасности. При копировании страниц ASP.NET, изображений, файлов JavaScript и других таких файлов в рабочую среду не нужно беспокоиться о том, как этот файл был изменен с момента последнего развертывания. Вы можете просто скопировать файл в рабочую среду, перезаписав существующее содержимое. К сожалению, эта простота не распространяется на развертывание базы данных.

При первом развертывании приложения, управляемого данными, можно в первый раз скопировать базу данных в среду разработки в рабочую среду. Но при последующих развертываниях при выполнении скрытой копии все данные, содержащиеся в рабочей базе данных, будут перезаписаны. Вместо этого развертывание базы данных включает в себя применение *изменений* , внесенных в базу данных разработки с момента последнего развертывания в рабочей базе данных. В этом учебнике рассматриваются эти проблемы и предлагаются различные стратегии для помощи с хрониками и применением изменений, внесенных в базу данных с момента последнего развертывания.

## <a name="the-challenges-of-deploying-a-database"></a>Проблемы развертывания базы данных

Перед развертыванием приложения, управляемого данными, в первый раз существует только одна база данных, а именно база данных в среде разработки. Почему при первом развертывании приложения, управляемого данными, можно в первый раз скопировать базу данных в среда разработки в рабочей среде. Но после развертывания приложения существует две копии базы данных: одна в разработке и одна в рабочей среде.

Между развертываниями базы данных разработки и рабочей среды могут стать несинхронизированными. Несмотря на то, что схема рабочей базы данных не изменяется, схема базы данных разработки может измениться по мере добавления новых функций. Вы можете добавлять или удалять столбцы, таблицы, представления или хранимые процедуры. Также могут быть важные данные, добавляемые в базу данных разработки. Многие приложения, управляемые данными, включают таблицы подстановки, заполненные жестко заданными данными приложения, которые не могут быть изменены пользователем. Например, веб-сайт аукциона может иметь раскрывающийся список с вариантами, описывающими условия для создаваемого элемента: новое, хорошее и справедливое. Вместо того, чтобы жестко программировать эти параметры непосредственно в раскрывающемся списке, обычно лучше поместить их в таблицу базы данных. Если во время разработки в таблицу добавляется новое условие с именем «плохое», то при развертывании приложения эта же запись должна быть добавлена в таблицу уточняющих запросов рабочей базы данных.

В идеале развертывание базы данных влечет за собой копирование базы данных из среды разработки в рабочую среду. Но помните, что после развертывания приложения и возобновления разработки Рабочая база данных заполняется реальными данными от реальных пользователей. Таким образом, если бы вы просто скопировали базу данных из среды разработки в рабочую среду при следующем развертывании, вы перезапишете рабочую базу данных и потеряли ее существующие данные. В итоге развертывание базы данных сводится к применению изменений, внесенных в базу данных разработки с момента последнего развертывания.

Поскольку развертывание базы данных включает в себя применение изменений в схеме и, возможно, данных с момента последнего развертывания, необходимо сохранить журнал изменений (или определить во время развертывания), чтобы эти изменения можно было применить в рабочей среде. Существует множество методов управления изменениями и их применения к модели данных.

### <a name="defining-the-baseline"></a>Определение базовых показателей

Чтобы сохранить изменения в базе данных приложения, необходимо иметь некоторое начальное состояние — базовый уровень, к которому применяются изменения. В одном крайнем случае начальное состояние может быть пустой базой данных без таблиц, представлений или хранимых процедур. Такой базовый план приводит к большому журналу изменений, так как он должен включать создание всех таблиц, представлений и хранимых процедур базы данных, а также любые изменения, внесенные после первоначального развертывания. На другом конце спектра можно задать базовую базу в качестве версии базы данных, изначально развернутой в рабочей среде. Этот вариант приводит к значительно меньшему журналу изменений, поскольку он включает только изменения, внесенные в базу данных после первого развертывания. Это предпочтительный подход. И, конечно, можно выбрать более середину пути, определив базовую основу в качестве некоторой точки между первоначальным созданием базы данных и моментом развертывания базы данных.

После выбора базового плана рассмотрите возможность создания скрипта SQL, который можно выполнить для повторного создания базовой версии. Такой сценарий позволяет быстро воссоздать базовую версию базы данных. Эта функция особенно полезна в больших проектах, где может быть несколько разработчиков, работающих над проектом или в дополнительных средах, таких как тестирование или промежуточное развертывание, для каждой из которых требуется собственная копия базы данных.

Существует множество средств для создания скрипта SQL базовой версии. В SQL Server Management Studio (SSMS) можно щелкнуть правой кнопкой мыши базу данных, открыть подменю задачи и выбрать параметр Создать скрипты. Запустится мастер скриптов, который позволит создать файл, содержащий команды SQL для создания объектов базы данных. Другой вариант — Мастер публикации баз данных, который может создавать команды SQL, чтобы не только создать схему базы данных, но и данные в таблицах базы данных. Мастер публикации баз данных был подробно проанализирован в учебнике *развертывание базы данных* . Независимо от используемого средства в конце должен быть файл скрипта, который можно использовать для повторного создания базовой версии базы данных, если это необходимо.

## <a name="documenting-the-database-changes-in-prose"></a>Документирование изменений базы данных в Prose

Самый простой способ сохранить журнал изменений в модели данных на этапе разработки — записать изменения в prose. Например, если во время разработки уже развернутого приложения вы добавляете новый столбец в `Employees` таблицу, удаляете столбец из таблицы `Orders` и добавляете новую таблицу (`ProductCategories`), вы сохраняете текстовый файл или документ Microsoft Word со следующим журналом:

<a id="0.4_table01"></a>

| **Дата изменения** | **Изменить сведения** |
| --- | --- |
| 2009-02-03: | В таблицу `Employees` добавлен столбец `DepartmentID` (`int`, а не NULL). Добавлено ограничение внешнего ключа из `Departments.DepartmentID` в `Employees.DepartmentID`. |
| 2009-02-05: | Удален столбец `TotalWeight` из таблицы `Orders`. Данные, уже захваченные в связанных записях `OrderDetails`. |
| 2009-02-12: | Создана таблица `ProductCategories`. Существует три столбца: `ProductCategoryID` (`int`, `IDENTITY`, `NOT NULL`), `CategoryName` (`nvarchar(50)`, `NOT NULL`) и `Active` (`bit`, `NOT NULL`). Для `ProductCategoryID`Добавлено ограничение первичного ключа, а для `Active`значение по умолчанию — 1. |

Этот подход имеет ряд недостатков. Для начинающих не существует никаких предникаких средств для автоматизации. Каждый раз, когда эти изменения необходимо применить к базе данных, например при развертывании приложения, разработчик должен вручную реализовать каждое изменение по одному. Более того, если необходимо восстановить определенную версию базы данных из базового плана с помощью журнала изменений, то это займет больше времени, чем растет размер журнала. Другой недостаток этого метода заключается в том, что ясность и уровень детализации каждой записи журнала изменений остается для человека, записывающего изменение. В группе с несколькими разработчиками некоторые разработчики могут создавать более подробные, более удобочитаемые и более точные записи, чем другие. Кроме того, возможны опечатки и другие ошибки ввода данных, связанные с человеком.

Основное преимущество документирования изменений в базе данных в prose — простота. Вам не нужно знать синтаксис SQL для создания и изменения объектов базы данных. Вместо этого можно записать изменения в prose и реализовать их с помощью графического пользовательского интерфейса SQL Server Management Studio s.

Обслуживание журнала изменений в prose, конечно, не очень сложно и не будет работать с определенными проектами, например большими в области охвата, часто изменять модель данных или включать несколько разработчиков. Но я видел, что этот подход хорошо работает в небольших, односторонних проектах, которые имеют только случайные изменения в модели данных, и если у разработчика Solo нет строгого опыта в синтаксисе SQL для создания и изменения объектов базы данных.

> [!NOTE]
> Хотя сведения в журнале изменений, технически, необходимы только до времени развертывания, я рекомендую сохранить историю изменений. Но вместо того, чтобы хранить один постоянно увеличивающийся файл журнала изменений, рассмотрите возможность наличия другого файла журнала изменений для каждой версии базы данных. Обычно потребуется версия базы данных при каждом развертывании. Сохраняя журнал изменений, вы можете, начиная с базового плана, повторно создавать любую версию базы данных, выполняя сценарии журнала изменений, начиная с версии 1, и продолжая до тех пор, пока не будет достигнута версия, которую необходимо создать заново.

## <a name="recording-the-sql-change-statements"></a>Запись инструкций SQL Change

Основным недостатком поддержки журнала изменений в prose является отсутствие автоматизации. В идеале для реализации изменений базы данных в рабочей базе данных во время развертывания можно было бы просто нажать кнопку, чтобы выполнить сценарий, а не вручную выполнить список инструкций. Такую автоматизацию можно выполнить, сохранив журнал изменений, содержащий команды SQL, используемые для изменения модели данных.

Синтаксис SQL включает несколько инструкций для создания и изменения различных объектов базы данных. Например, при выполнении [*инструкции CREATE TABLE*](https://msdn.microsoft.com/library/ms174979.aspx)создает новую таблицу с указанными столбцами и ограничениями. [*Инструкция ALTER TABLE*](https://msdn.microsoft.com/library/ms190273.aspx) изменяет существующую таблицу, добавляя, удаляя или изменяя ее столбцы или ограничения. Существуют также инструкции для создания, изменения и удаления индексов, представлений, определяемых пользователем функций, хранимых процедур, триггеров и других объектов базы данных.

Вернувшись к предыдущему примеру, образ, который во время разработки уже развернутого приложения добавляет новый столбец в `Employees` таблицу, удаляет столбец из таблицы `Orders` и добавляет новую таблицу (`ProductCategories`). Такие действия приведут к созданию файла журнала изменений с помощью следующих команд SQL:

[!code-sql[Main](strategies-for-database-development-and-deployment-cs/samples/sample1.sql)]

Принудительная отправка этих изменений в рабочую базу данных во время развертывания — это операция, выполняемая одним щелчком: откройте SQL Server Management Studio, подключитесь к рабочей базе данных, откройте новое окно запроса, вставьте содержимое журнала изменений и нажмите кнопку выполнить, чтобы запустить скрипт.

## <a name="using-a-comparison-tool-to-synchronize-the-data-models"></a>Использование средства сравнения для синхронизации моделей данных

Документирование изменений в базе данных в prose несложно, но реализация изменений требует от разработчика вносить каждое изменение в рабочую базу данных по одному за раз. Документирование команд изменений SQL упрощает реализацию этих изменений в рабочей базе данных и позволяет быстро и просто нажать кнопку, но требует изучения инструкций SQL и синтаксиса для создания и изменения объектов базы данных. Средства сравнения баз данных лучше использовать оба подхода и отбросить худшее.

Средство сравнения баз данных сравнивает схему или данные двух баз данных и отображает сводный отчет, в котором показано, как отличаются базы данных. Затем, нажав кнопку, можно создать команды SQL для синхронизации одного или нескольких объектов базы данных. В двух словах, средство сравнения баз данных можно использовать для сравнения баз данных разработки и рабочей среды во время развертывания, создавая файл, содержащий команды SQL, которые при исполнении применяют изменения к схеме рабочей базы данных, чтобы она отражает схему базы данных разработки.

Существует множество сторонних средств сравнения баз данных, предлагаемых многими разными поставщиками. Одним из таких примеров является [*Сравнение SQL*](http://www.red-gate.com/products/SQL_Compare/)с помощью [*программного обеспечения Красного шлюза*](http://www.red-gate.com/). Давайте разберем процесс использования сравнения SQL для сравнения и синхронизации схем разработки и рабочей базы данных.

> [!NOTE]
> На момент написания этой статьи в качестве текущей версии SQL Compare использовалась версия 7,1 со стандартными затратами на выпуск $395. Вы можете выполнить процедуру, загрузив бесплатную 14-дневную пробную версию.

При запуске сравнения SQL открывается диалоговое окно проекты сравнения, в котором отображаются сохраненные проекты SQL Compare. Создайте новый проект. Запустится мастер настройки проекта, в котором запрашиваются сведения о сравниваемых базах данных (см. рис. 1). Введите сведения для баз данных разработки и рабочей среды.

[![сравнения баз данных разработки и рабочей среды](strategies-for-database-development-and-deployment-cs/_static/image2.jpg)](strategies-for-database-development-and-deployment-cs/_static/image1.jpg)

**Рис. 1**. Сравнение баз данных для разработки и рабочей среды ([щелкните, чтобы просмотреть изображение с полным размером](strategies-for-database-development-and-deployment-cs/_static/image3.jpg))

> [!NOTE]
> Если база данных среды разработки представляет собой файл базы данных SQL Express Edition, расположенный в папке `App_Data` веб-сайта, необходимо зарегистрировать базу данных на сервере базы данных SQL Server Express, чтобы выбрать ее из диалогового окна, показанного на рис. 1. Самый простой способ сделать это — открыть SQL Server Management Studio (SSMS), подключиться к серверу базы данных SQL Server Express и присоединить базу данных. Если на компьютере не установлена среда SSMS, можно загрузить и установить бесплатную [*версию бесплатной SQL Server 2008 Management Studio Basic*](https://www.microsoft.com/downloads/details.aspx?FamilyId=7522A683-4CB2-454E-B908-E805E9BD4E28&amp;displaylang=en).

Помимо выбора сравниваемых баз данных, на вкладке Параметры можно также указать различные параметры сравнения. Одним из вариантов, который вы можете включить, является "игнорировать ограничения и имена индексов". Вспомним, что в предыдущем руководстве мы добавили объекты базы данных служб приложений в базы данных разработки и рабочей среде. Если для создания этих объектов в рабочей базе данных использовалось средство `aspnet_regsql.exe`, вы обнаружите, что имена первичного ключа и уникального ограничения между базами данных разработки и рабочей базой различаются. Следовательно, SQL Compare пометит все таблицы служб приложений как отличающиеся. Можно либо оставить флажок игнорировать ограничения и имена индексов неустановленным и синхронизировать имена ограничений, либо поручить SQL Compare игнорировать эти различия.

Выбрав базы данных для сравнения (и просмотрев параметры сравнения), нажмите кнопку сравнить Now, чтобы начать сравнение. В течение следующих нескольких секунд сравнение SQL анализирует схемы двух баз данных и формирует отчет о том, как они отличаются. Я сохранил намеренно, внеся некоторые изменения в базу данных разработки, чтобы продемонстрировать, как эти несоответствия отмечены в интерфейсе SQL Compare. Как показано на рис. 2, я добавил столбец `BirthDate` в таблицу `Authors`, удалил столбец `ISBN` из таблицы `Books` и добавил новую таблицу `Ratings`, которая позволяет пользователям посетить веб-сайт, оценить прорецензированные книги.

> [!NOTE]
> Изменения модели данных, внесенные в этом руководстве, иллюстрируют использование средства сравнения баз данных. Эти изменения не будут найдены в базе данных в следующих учебных курсах.

[![SQL Compare перечисляет различия между базами данных разработки и рабочей базой](strategies-for-database-development-and-deployment-cs/_static/image5.jpg)](strategies-for-database-development-and-deployment-cs/_static/image4.jpg)

**Рис. 2**. Сравнение баз данных Development и Production в SQL Compare ([щелкните, чтобы просмотреть изображение с полным размером](strategies-for-database-development-and-deployment-cs/_static/image6.jpg))

SQL Compare разделяет объекты базы данных на группы, быстро отображая объекты, существующие в обеих базах данных, но разные объекты, которые находятся в одной базе данных, но не являются объектами, и какие объекты идентичны. Как видите, существуют два объекта, которые существуют в обеих базах данных, но различаются: таблица `Authors`, в которой был добавлен столбец, и таблица `Books`, в которой была удалена одна. Существует один объект, который существует только в базе данных разработки, а именно вновь созданной `Ratings` таблице. И существует 117 объектов, идентичных в обеих базах данных.

При выборе объекта базы данных отображается окно различия в SQL, в котором показано, как эти объекты отличаются. Окно "различия в SQL", отображаемое в нижней части на рис. 2, демонстрирует, что таблица `Authors` в базе данных разработки содержит столбец `BirthDate`, который не найден в таблице `Authors` в рабочей базе данных.

После рассмотрения различий и выбора объектов, которые необходимо синхронизировать, следующим шагом является создание команд SQL, необходимых для обновления схемы рабочей базы данных в соответствии с базой данных разработки. Это выполняется с помощью мастера синхронизации. Мастер синхронизации подтверждает, какие объекты следует синхронизировать, и суммирует план действий (см. рис. 3). Можно немедленно синхронизировать базы данных или создать скрипт с командами SQL, которые можно запустить в свободное время.

[![использовании мастера синхронизации для синхронизации схем баз данных](strategies-for-database-development-and-deployment-cs/_static/image8.jpg)](strategies-for-database-development-and-deployment-cs/_static/image7.jpg)

**Рис. 3**. синхронизация схем баз данных с помощью мастера синхронизации ([щелкните, чтобы просмотреть изображение с полным размером](strategies-for-database-development-and-deployment-cs/_static/image9.jpg))

Средства сравнения баз данных, такие как сравнение SQL с помощью Red Gate, применяют изменения к схеме базы данных разработки в рабочую базу данных так же просто, как и щелчок.

> [!NOTE]
> SQL Compare сравнивает и синхронизирует две *схемы*баз данных. К сожалению, она не сравнивает и не синхронизирует данные в двух таблицах базы данных. В программном обеспечении "Красное шлюз" предлагается продукт с именем [*SQL Data Compare*](http://www.red-gate.com/products/SQL_Data_Compare/) , который сравнивает и синхронизирует данные между двумя базами данных, но это отдельный продукт от SQL Compare и другие затраты $395.

## <a name="taking-the-application-offline-during-deployment"></a>Перевод приложения в автономный режим во время развертывания

Как мы видели в этих учебниках, развертывание — это процесс, включающий в себя несколько этапов: копирование страниц ASP.NET, главных страниц, CSS-файлов, файлов JavaScript, изображений и другого необходимого содержимого из среды разработки в рабочую среду. PXE При необходимости скопируйте сведения о конфигурации рабочей среды. и применение изменений к модели данных с момента последнего развертывания. В зависимости от количества файлов и сложности изменений базы данных выполнение этих действий может занять от нескольких секунд до нескольких минут. В этом окне веб-приложение находится в Flux, а пользователи, посещающие сайт, могут столкнуться с ошибками или непредвиденным поведением.

При развертывании веб-сайта лучше перевести веб-приложение в автономный режим до завершения развертывания. Перевод приложения в автономный режим (и его восстановление после завершения процесса развертывания) — это так же просто, как передача файла и последующее его удаление. Начиная с ASP.NET 2,0, достаточное присутствие файла с именем `app_offline.htm` в корневом каталоге приложения переводит весь веб-сайт в автономный режим. Любой запрос к странице ASP.NET на этом сайте автоматически подает ответ с содержимым файла `app_offline.htm`. После удаления файла приложение возвращается в режим «в сети».

Перевод приложения в автономный режим во время развертывания — это просто передача файла `app_offline.htm` в корневой каталог рабочей среды до начала процесса развертывания, а затем его удаление (или переименование в другом месте) после завершения развертывания. Дополнительные сведения об этом способе см. в статье Джон Петерсон s (перевод [*приложения ASP.NET в автономный режим*](http://www.15seconds.com/issue/061207.htm)).

## <a name="summary"></a>Сводка

Основной задачей при развертывании центров приложений на основе данных, связанных с развертыванием базы данных. Поскольку существует две версии базы данных — одна в среде разработки, а другая — в рабочей среде, эти две схемы баз данных могут стать синхронизированными, так как новые функции добавляются в разработку. Что еще больше, поскольку Рабочая база данных заполняется реальными данными от реальных пользователей, нельзя перезаписывать рабочую базу данных с измененной базой данных разработки, как при развертывании файлов, составляющих приложение (страницы ASP.NET). файлы изображений и т. д.). Вместо этого развертывание базы данных влечет за собой реализацию точного набора изменений, внесенных в базу данных разработки в рабочей базе данных с момента последнего развертывания.

В этом учебнике рассмотрены три методики обслуживания и применения журнала изменений в базе данных. Самый простой подход — записать изменения в prose. Хотя эта способов делает реализацию этих изменений в рабочей базе данных в ручном режиме, ей не требуются знания о командах SQL для создания и изменения объектов базы данных. Более сложный подход, который гораздо более терпима в крупных проектах или проектах с несколькими разработчиками, заключается в записи изменений в виде последовательности команд SQL. Это значительно хастенс эти изменения в целевую базу данных. Лучшее из обоих подходов можно достичь с помощью средства сравнения баз данных, такого как "Сравнение SQL" по сравнению с Red Gate.

В этом руководстве мы заключительным руководством по развертыванию приложения, управляемого данными. В следующем наборе руководств рассматриваются способы реагирования на ошибки в рабочей среде. Мы рассмотрим, как отобразить понятную страницу ошибки вместо желтого экрана смерти. Мы покажем, как заносить в журнал сведения об ошибках и как оповещать вас при возникновении таких ошибок.

Поздравляем с программированием!

> [!div class="step-by-step"]
> [Назад](configuring-a-website-that-uses-application-services-cs.md)
> [Вперед](displaying-a-custom-error-page-cs.md)
