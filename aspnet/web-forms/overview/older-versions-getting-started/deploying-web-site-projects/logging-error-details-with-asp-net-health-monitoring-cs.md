---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-cs
title: Записи сведений об ошибках с помощью ASP.NET Health Monitoring (C#) | Документация Майкрософт
author: rick-anderson
description: Система наблюдения за работоспособностью корпорации Майкрософт предоставляет простой и настраиваемый способ входа различных веб-события, включая необработанных исключений. В этом учебнике должен быть...
ms.author: riande
ms.date: 06/09/2009
ms.assetid: b1abb452-642a-4ff3-8504-37b85590ff79
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-cs
msc.type: authoredcontent
ms.openlocfilehash: 52b1aec577634dfb9fec7753e4f9b8bf46d159f0
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59416264"
---
# <a name="logging-error-details-with-aspnet-health-monitoring-c"></a>Запись в журнал сведений об ошибках с помощью наблюдения за состоянием системы ASP.NET (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_13_CS.zip) или [скачать PDF](http://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial13_HealthMonitoring_cs.pdf)

> Система наблюдения за работоспособностью корпорации Майкрософт предоставляет простой и настраиваемый способ входа различных веб-события, включая необработанных исключений. Этом руководстве описаны шаги по настройке система наблюдения за работоспособностью для журнала необработанных исключений в базу данных и для уведомления разработчиков через сообщение электронной почты.


## <a name="introduction"></a>Вступление

Ведение журнала является удобным инструментом для мониторинга работоспособности развернутого приложения, а также для диагностики проблем, которые могут возникнуть. Это особенно важно для ведения журнала ошибок, возникающих в развернутом приложении, таким образом, чтобы их можно исправить. `Error` Событие вызывается при возникновении необработанного исключения в приложении ASP.NET; [предыдущем учебном курсе](processing-unhandled-exceptions-cs.md) было показано, как можно уведомить разработчик ошибки и журналов сведения о нем, Создание обработчика событий для `Error` событий. Тем не менее, создание `Error` обработчик событий в журнал сведения об ошибке, а также отправлять уведомления разработчик необязателен, так как эта задача может выполняться по ASP. NET *система наблюдения за работоспособностью*.

Система наблюдения за работоспособностью появилась в ASP.NET 2.0 и предназначен для мониторинга работоспособности развернутого приложения ASP.NET с помощью записи событий, возникающих во время приложения или время существования запроса. События в журнале, система наблюдения за работоспособностью, называются *событий мониторинга состояния* или *веб-события*и включают:

- События времени существования приложения, например когда приложение запускает или останавливает
- События безопасности, включая неудачных попыток входа и невыполненные запросы авторизации URL-адрес
- Ошибки приложений, включая необработанные исключения, состояние представления синтаксический анализ исключений, запрос проверки исключений и ошибок компиляции, помимо других типов ошибок.

При возникновении события мониторинга работоспособности его можно записать в любое количество указанного *журнала источников*. Система наблюдения за работоспособностью поставляется с источники журналов, которые входят веб-события в базу данных Microsoft SQL Server, или через сообщение электронной почты, среди прочего в журнале событий Windows. Можно также создать свои собственные источники журналов.

События, журналы система наблюдения за работоспособностью, а также источники журналов, которые использовали, определены в `Web.config`. Всего несколько строк конфигурации разметки можно использовать мониторинг для входа в базу данных все необработанные исключения и сообщить исключения по электронной почте.

## <a name="exploring-the-health-monitoring-systems-configuration"></a>Изучение системы мониторинга работоспособности

Поведение системы мониторинга работоспособности определяется сведения о конфигурации, который находится в [ `<healthMonitoring>` элемент](https://msdn.microsoft.com/library/2fwh2ss9.aspx) в `Web.config`. Этот раздел конфигурации определяет, помимо прочего, следующие три важных элемента информации:

1. Наблюдение за событиями работоспособности, когда возникло, следует записывать в журнал
2. Источники журналов, и
3. Сопоставление каждого события, определенные в (1) мониторинга состояния источники журналов, определенные в (2).

Эта информация указывается с помощью тремя дочерними элементами конфигурации: [ `<eventMappings>` ](https://msdn.microsoft.com/library/yc5yk01w.aspx), [ `<providers>` ](https://msdn.microsoft.com/library/zaa41kz1.aspx), и [ `<rules>` ](https://msdn.microsoft.com/library/fe5wyxa0.aspx), соответственно.

Сведения о конфигурации системы мониторинга работоспособности по умолчанию можно найти в `Web.config` файл `%WINDIR%\Microsoft.NET\Framework\version\CONFIG` папки. Сведений о конфигурации по умолчанию, некоторые разметкой, удалены для краткости, показан ниже:

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample1.xml)]

Работоспособность интерес для мониторинга событий определяются в `<eventMappings>` элемент, который предоставляет имя понятном для класса событий мониторинга работоспособности. В разметке выше `<eventMappings>` элемент присваивает имя понятном «Все ошибки» для мониторинга событий типа работоспособности `WebBaseErrorEvent` и имя «сбоев аудита» для мониторинга событий типа работоспособности `WebFailureAuditEvent`.

`<providers>` Элемент определяет источники журналов, присваивая имен понятном и указав все сведения о конфигурации зависящие от источника журнала. Первый `<add>` элемент определяет поставщика «EventLogProvider», который заносит в журнал мониторинга событий с помощью указанного состояния `EventLogWebEventProvider` класса. `EventLogWebEventProvider` Класс регистрирует событие в журнале событий Windows. Второй `<add>` элемент определяет поставщика «SqlWebEventProvider», который записывает события в базе данных Microsoft SQL Server через `SqlWebEventProvider` класса. Конфигурация «SqlWebEventProvider» указывает строку подключения базы данных (`connectionStringName`) среди других параметров конфигурации.

`<rules>` Сопоставляет события, заданные параметром `<eventMappings>` элемент вход источников `<providers>` элемент. По умолчанию веб-приложений ASP.NET, регистрировать все необработанные исключения и аудита сбоев в журнале событий Windows.

## <a name="logging-events-to-a-database"></a>События ведения журнала в базе данных

Конфигурации по умолчанию системы мониторинга работоспособности можно настроить на основе приложений с веб-приложения web, добавив `<healthMonitoring>` раздел, чтобы приложения `Web.config` файл. Можно включить дополнительные элементы в `<eventMappings>`, `<providers>`, и `<rules>` разделы с помощью `<add>` элемент. Для удаления параметров с использованием конфигурации по умолчанию `<remove>` элемент, или используйте `<clear />` для удаления всех значений по умолчанию из одного из этих разделов. Давайте настроим рецензий веб-приложения в журнал всех необработанных исключений в базе данных Microsoft SQL Server с помощью `SqlWebEventProvider` класса.

`SqlWebEventProvider` Класс является частью система наблюдения за работоспособностью и записывает события в указанную базу данных SQL Server мониторинга состояния. `SqlWebEventProvider` Класс ожидает, что указанная база данных содержит хранимую процедуру с именем `aspnet_WebEvent_LogEvent`. Эта хранимая процедура передается сведения о событии и является поставили задачу сохранять сведения о событии. Хорошо то, что не нужно создавать Эта хранимая процедура, ни таблицы для хранения сведений о событии. Эти объекты можно добавить базу данных с помощью `aspnet_regsql.exe` средство.

> [!NOTE]
> `aspnet_regsql.exe` Средства, которые обсуждались в [ *Настройка веб-сайт, использует службы приложений* руководстве](configuring-a-website-that-uses-application-services-cs.md) когда мы добавили поддержку для ASP. Службы приложений NET. Следовательно, веб-сайт рецензий база данных уже содержит `aspnet_WebEvent_LogEvent` хранимые процедуры, которая сохраняет информацию о событиях в таблицу с именем `aspnet_WebEvent_Events`.


Получив необходимые хранимая процедура и таблица добавлена в базу данных, остается только для указания работоспособности, мониторинга, чтобы регистрировать все необработанные исключения в базу данных. Это сделать, добавив следующую разметку на веб-сайт `Web.config` файла:

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample2.xml)]

Мониторинг разметку настройки выше используется `<clear />` элементы для очистки мониторинга сведений о конфигурации из предварительно определенных работоспособности `<eventMappings>`, `<providers>`, и `<rules>` разделы. Затем добавляется одна запись для каждого из этих разделов.

- `<eventMappings>` Элемент определяет работоспособности выполняется один с именем «Все ошибки», которое происходит всякий раз, когда необработанное исключение происходит определенное событие.
- `<providers>` Элемент определяет источник одного журнала с именем «SqlWebEventProvider», который использует `SqlWebEventProvider` класса. `connectionStringName` Установлен атрибут «ReviewsConnectionString», которое является именем подключения строке, заданной в `<connectionStrings>` разделе.
- Наконец &lt;правила&gt; элемент указывает, когда событие «Все ошибки» процесс, который он занесение с помощью поставщика «SqlWebEventProvider».

Эти сведения конфигурации указывает, что в системе, чтобы регистрировать все необработанные исключения в базу данных рецензий мониторинга состояния.

> [!NOTE]
> `WebBaseErrorEvent` Событие создается только для ошибок сервера; оно не возникает ошибок HTTP, например запрос для ресурса ASP.NET, который не найден. Это отличается от поведения `HttpApplication` класса `Error` события, которое вызывается для сервера и ошибки HTTP.


Для просмотра в системе в действии мониторинга состояния, на веб-узле и создать ошибку во время выполнения, посетив `Genre.aspx?ID=foo`. Вы увидите соответствующее сообщение об ошибке страницы - исключение сведения желтый экрана из смертью (при посещении локально) или пользовательскую страницу ошибки (при посещении сайта в рабочей среде). На самом деле система наблюдения за работоспособностью в журнал сведения об ошибке в базу данных. Должна существовать одна запись в `aspnet_WebEvent_Events` таблицы (см. в разделе **рис.1**); эта запись содержит сведения об ошибке среды выполнения, которая только что была выполнена.

[![](logging-error-details-with-asp-net-health-monitoring-cs/_static/image2.png)](logging-error-details-with-asp-net-health-monitoring-cs/_static/image1.png)

**Рис. 1**: Сведения об ошибке были зарегистрированы в журнале для `aspnet_WebEvent_Events` таблицы  
([Просмотр полноразмерного изображения](logging-error-details-with-asp-net-health-monitoring-cs/_static/image3.png))

### <a name="displaying-the-error-log-in-a-web-page"></a>Отображение журнала ошибок в веб-страницы

Текущая конфигурация веб сайта система наблюдения за работоспособностью входит все необработанные исключения в базу данных. Тем не менее наблюдение за работоспособностью предоставляет механизм для просмотра журнала ошибок через веб-страницы. Тем не менее можно создать страницу ASP.NET, отображения этой информации из базы данных. (Как мы увидим моментально, вы можете иметь сведения об ошибке, отправленном вам по электронной почте.)

При создании такой страницы, убедитесь, что выполнить действия, чтобы разрешить только авторизованные пользователи просмотреть сведения об ошибке. Если сайт уже использует учетные записи пользователей можно использовать правила авторизации URL-адрес для ограничения доступа к странице для определенных пользователей или ролей. Дополнительные сведения о том, как предоставить или ограничить доступ к веб-страниц, в зависимости от вошедшего в систему пользователя см. Мой [учебники по безопасности веб-сайт](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md).

> [!NOTE]
> Последующие руководства рассматриваются альтернативные Ошибка ведения журнала и уведомления систему с именем ELMAH. ELMAH включает встроенный механизм для просмотра журнала ошибок на страницу веб- и как RSS-канала.


## <a name="logging-events-to-email"></a>Ведение журнала событий на адрес электронной почты

Система наблюдения за работоспособностью включает регистратор источника, «журналы» события в сообщение электронной почты. Источник журнала включает в себя те же сведения, которые регистрируются в базе данных в теле сообщения электронной почты. Этот источник журнала можно использовать для уведомления разработчик, при возникновении определенных событий мониторинга работоспособности.

Давайте обновим рецензий на книги, таким образом, мы получали сообщения электронной почты каждый раз, когда исключение происходит конфигурации веб-сайта. Для выполнения этой задачи необходимо выполнить три задачи:

1. Настройка веб-приложение ASP.NET для отправки электронной почты. Это достигается путем указания того, как сообщения электронной почты отправляются через `<system.net>` элемента конфигурации. Дополнительные сведения об отправке по электронной почте сообщения в приложении ASP.NET, ссылаться на [отправки электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx) и [System.Net.Mail часто задаваемые вопросы о](http://systemnetmail.com/).
2. Зарегистрировать поставщик источника журнала по электронной почте в `<providers>` элемент, и
3. Добавить запись `<rules>` сопоставляет события «Все ошибки» в регистратор источника, добавленным на шаге (2).

Система наблюдения за работоспособностью включает два класса поставщика источника журнала по электронной почте: `SimpleMailWebEventProvider` и `TemplatedMailWebEventProvider`. [ `SimpleMailWebEventProvider` Класс](https://msdn.microsoft.com/library/system.web.management.simplemailwebeventprovider.aspx) отправляет сообщение электронной почты в формате обычного текста, содержащее события подробно и предоставляет Настройка текста сообщения электронной почты. С помощью [ `TemplatedMailWebEventProvider` класс](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) указать страницу ASP.NET, в которых уже визуализированной разметке используется в теле сообщения электронной почты. [ `TemplatedMailWebEventProvider` Класс](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) обеспечивает больший контроль над содержимое и формат сообщения электронной почты, но требует немного больше усилий переднего плана, как вам нужно создать страницу ASP.NET, создающий текст сообщения электронной почты. Этот учебник посвящен использованию `SimpleMailWebEventProvider` класса.

Обновление системы мониторинга работоспособности `<providers>` элемент в `Web.config` файл источника журнала для `SimpleMailWebEventProvider` класса:

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample3.xml)]

Приведенная выше разметка использует `SimpleMailWebEventProvider` класс как поставщик источника журнала и присваивает его понятное имя «EmailWebEventProvider». Кроме того `<add>` атрибут содержит дополнительные параметры конфигурации, такие как Кому и из адреса сообщения электронной почты.

Источник журнала по электронной почте, в определенные все, что остается лишь указать работоспособности, мониторинг системы, чтобы использовать этот источник для необработанных исключений «вход». Это достигается путем добавления нового правила в `<rules>` разделе:

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample4.xml)]

`<rules>` Раздел теперь включает два правила. Первое, с именем «Всех ошибок для сообщений электронной почты», отправляет все необработанные исключения источник журнала «EmailWebEventProvider». Это правило действует как при отправке сведений об ошибках веб-сайта в указанный адрес. Правило «Всех ошибок для базы данных» база данных сайта регистрирует сведения об ошибке. Следовательно каждый раз, когда происходит необработанное исключение на сайте сведения о нем обе записи в базу данных и отправке на указанный адрес электронной почты.

**Рис. 2** показано сообщение электронной почты, созданных `SimpleMailWebEventProvider` класса при посещении `Genre.aspx?ID=foo`.

[![](logging-error-details-with-asp-net-health-monitoring-cs/_static/image5.png)](logging-error-details-with-asp-net-health-monitoring-cs/_static/image4.png)

**Рис. 2**: Сведения об ошибке отправляются в сообщении электронной почты  
([Просмотр полноразмерного изображения](logging-error-details-with-asp-net-health-monitoring-cs/_static/image6.png))

## <a name="summary"></a>Сводка

Система наблюдения за работоспособностью ASP.NET позволяет администраторам отслеживать работоспособность развернутого веб-приложения. События мониторинга работоспособности вызываются в том случае, когда unfold определенные действия, например, при остановке приложения, когда пользователь успешно входит на сайт, или возникает необработанное исключение. Эти события могут регистрироваться в любое количество источников журнала. Этом руководстве показано, как для записи сведений о необработанных исключений, в базе данных и через сообщение электронной почты.

В этом руководстве описывается по использованию мониторинга журнала необработанных исключений, но имейте в виду, что наблюдение за работоспособностью предназначен для оценки общей работоспособности развернутого приложения ASP.NET и содержат множество событий мониторинга состояния и журнала источников не работоспособности Рассмотренные здесь. Что такое дополнительные, можно создать собственные мониторинг событий и источники журналов, в случае необходимости возникают. Если вы заинтересованы в ознакомлении наблюдение за работоспособностью, хорошим первым шагом является прочтите [Erik Reitan](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx) [мониторинга часто задаваемые вопросы о работоспособности](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx). После этого, обратитесь к [How To: Использовать наблюдение за работоспособностью в ASP.NET 2.0](https://msdn.microsoft.com/library/ms998306.aspx).

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Обзор наблюдения за состоянием системы ASP.NET](https://msdn.microsoft.com/library/bb398933.aspx)
- [Конфигурации и настройке мониторинга системы ASP.NET работоспособности](http://dotnetslackers.com/articles/aspnet/ConfiguringAndCustomizingTheHealthMonitoringSystemOfASPNET.aspx)
- [Часто задаваемые вопросы — наблюдение за работоспособностью в ASP.NET 2.0](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)
- [Как выполнить: Отправить сообщение электронной почты для мониторинга уведомлений о работоспособности](https://msdn.microsoft.com/library/ms227553.aspx)
- [Как выполнить: Использовать наблюдение за работоспособностью в ASP.NET](https://msdn.microsoft.com/library/ms998306.aspx)
- [Наблюдение за работоспособностью в ASP.NET](http://aspnet.4guysfromrolla.com/articles/031407-1.aspx)

> [!div class="step-by-step"]
> [Назад](processing-unhandled-exceptions-cs.md)
> [Вперед](logging-error-details-with-elmah-cs.md)
