---
uid: web-forms/overview/older-versions-getting-started/deployment-to-a-hosting-provider/deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12
title: 'Развертывание веб-приложения ASP.NET с SQL Server Compact с помощью Visual Studio или Visual Web Developer: переход на SQL Server-10 из 12 | Документация Майкрософт'
author: tdykstra
description: В этой серии учебников показано, как развернуть (опубликовать) проект веб-приложения ASP.NET, включающий базу данных SQL Server Compact, с помощью Visual Stu...
ms.author: riande
ms.date: 11/17/2011
ms.assetid: a89d6f32-b71b-4036-8ff7-5f8ac2a6eca8
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deployment-to-a-hosting-provider/deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12
msc.type: authoredcontent
ms.openlocfilehash: c5281a42596d95e725b32e652c75785abe0fd64e
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74640574"
---
# <a name="deploying-an-aspnet-web-application-with-sql-server-compact-using-visual-studio-or-visual-web-developer-migrating-to-sql-server---10-of-12"></a>Развертывание веб-приложения ASP.NET с SQL Server Compact с помощью Visual Studio или Visual Web Developer: переход на SQL Server-10 из 12

от [Tom Dykstra)](https://github.com/tdykstra)

[Скачать начальный проект](https://code.msdn.microsoft.com/Deploying-an-ASPNET-Web-4e31366b)

> В этой серии учебников показано, как развернуть (опубликовать) проект веб-приложения ASP.NET, включающий базу данных SQL Server Compact, с помощью Visual Studio 2012 RC или Visual Studio Express 2012 RC для Web. При установке обновления веб-публикации можно также использовать Visual Studio 2010. Введение в серию см. [в первом учебнике серии](deployment-to-a-hosting-provider-introduction-1-of-12.md).
> 
> Руководство, в котором показаны функции развертывания, появившиеся после выпуска версии-КАНДИДАТа Visual Studio 2012, демонстрирует развертывание SQL Server выпусков, отличных от SQL Server Compact, и демонстрация развертывания в веб-приложениях службы приложений Azure см. в разделе [ASP.NET Web Deploying using Visual Studio](../../deployment/visual-studio-web-deployment/introduction.md).

## <a name="overview"></a>Обзор

В этом учебнике показано, как выполнить миграцию с SQL Server Compact на SQL Server. Одной из причин может потребоваться воспользоваться преимуществами SQL Server функций, которые SQL Server Compact не поддерживает, например хранимые процедуры, триггеры, представления или репликация. Дополнительные сведения о различиях между SQL Server Compact и SQL Server см. в руководстве по [развертыванию SQL Server Compact](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12.md) .

### <a name="sql-server-express-versus-full-sql-server-for-development"></a>SQL Server Express и полная SQL Server для разработки

Когда вы решили обновить систему до SQL Server, вы можете использовать SQL Server или SQL Server Express в средах разработки и тестирования. Помимо различий в поддержке средств и функций ядра СУБД, существуют различия в реализации поставщиков между SQL Server Compact и другими версиями SQL Server. Эти различия могут привести к тому, что один и тот же код выдаст разные результаты. Поэтому, если вы решили SQL Server Compact в качестве базы данных разработки, следует тщательно протестировать сайт в SQL Server или SQL Server Express в тестовой среде перед каждым развертыванием в рабочую среду.

В отличие от SQL Server Compact SQL Server Express по сути является одним и тем же ядром СУБД и использует тот же поставщик .NET, что и полный SQL Server. При тестировании с SQL Server Express можно получить те же результаты, что и в SQL Server. Большинство тех же инструментов для работы с базами данных можно использовать с SQL Server Express, которые можно использовать с SQL Server (важное исключение [SQL Server Profiler](https://msdn.microsoft.com/library/ms181091.aspx)) и поддерживает другие функции SQL Server, такие как хранимые процедуры, представления, триггеры и репликация. (Обычно необходимо использовать полный SQL Server на рабочем веб-сайте. SQL Server Express может выполняться в общей среде размещения, но она не предназначена для этого, и многие поставщики услуг размещения не поддерживают их.)

Если вы используете Visual Studio 2012, для среды разработки обычно выбирается SQL Server Express LocalDB, так как именно это устанавливается по умолчанию в Visual Studio. Однако LocalDB не работает в службах IIS, поэтому для тестовой среды необходимо использовать либо SQL Server, либо SQL Server Express.

### <a name="combining-databases-versus-keeping-them-separate"></a>Объединение баз данных и их отделение

Приложение университета Contoso имеет две SQL Server Compact базы данных: база данных членства (*ASPNET. sdf*) и база данных приложения (*School. sdf*). При миграции эти базы данных можно перенести в две отдельные базы данных или в одну базу данных. Их можно объединить, чтобы упростить объединение баз данных между базой данных приложения и базой данных членства. План размещения также может предоставить причину для их объединения. Например, поставщик услуг размещения может взимать дополнительную плату за несколько баз данных или даже может не допускать более одной базы данных. Это так с учетной записью размещения Цитаниум Lite, которая используется в этом руководстве, что позволяет использовать только одну базу данных SQL Server.

В этом руководстве вы перенесите две базы данных следующим образом:

- Переход на две базы данных LocalDB в среде разработки.
- Переход на две базы данных SQL Server Express в тестовой среде.
- Переход на одну объединенную полную базу данных SQL Server в рабочей среде.

Напоминание. Если вы получаете сообщение об ошибке или что-то не работает при работе с этим руководством, обязательно ознакомьтесь со [страницей устранения неполадок](deployment-to-a-hosting-provider-creating-and-installing-deployment-packages-12-of-12.md).

## <a name="installing-sql-server-express"></a>Установка SQL Server Express

SQL Server Express по умолчанию автоматически устанавливается в Visual Studio 2010, но по умолчанию он не устанавливается вместе с Visual Studio 2012. Чтобы установить SQL Server 2012 Express, щелкните следующую ссылку.

- [SQL Server Express 2012](https://www.microsoft.com/download/details.aspx?id=29062)

Выберите *RUS/x64/SQLEXPR\_x64\_RUS. exe* или *RUS/x86/SQLEXPR\_x86\_RUS. exe*, и в мастере установки примите параметры по умолчанию. Дополнительные сведения о параметрах установки см. в разделе [Install SQL Server 2012 мастера установки (программа установки)](https://msdn.microsoft.com/library/ms143219.aspx).

## <a name="creating-sql-server-express-databases-for-the-test-environment"></a>Создание баз данных SQL Server Express для тестовой среды

Следующим шагом является создание базы данных ASP.NET Membership и School.

В меню **вид** выберите **Обозреватель сервера** (**Обозреватель базы данных** в Visual Web Developer), а затем щелкните правой кнопкой мыши **подключения к данным** и выберите команду **создать новую базу данных SQL Server**.

![Selecting_Create_New_SQL_Server_Database](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image1.png)

В диалоговом окне **Создание новой SQL Server базы данных** введите ".\SQLEXPRESS" в поле **имя сервера** , а в поле **имя новой базы данных** — "ASPNET-Test", а затем нажмите кнопку **ОК**.

![Create_New_SQL_Server_Database_aspnet](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image2.png)

Выполните ту же процедуру, чтобы создать новую SQL Server Express учебную базу данных с именем School-Test.

(Вы добавляете "тест" к этим именам баз данных, так как позднее вы создадите дополнительный экземпляр каждой базы данных для среды разработки, и вам нужно будет отличать два набора баз данных.)

В **Обозреватель сервера** теперь отображаются две новые базы данных.

![New_databases_in_Server_Explorer](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image3.png)

## <a name="creating-a-grant-script-for-the-new-databases"></a>Создание скрипта предоставления для новых баз данных

Когда приложение запускается в службах IIS на компьютере разработчика, оно получает доступ к базе данных, используя учетные данные пула приложений по умолчанию. Однако по умолчанию удостоверение пула приложений не имеет разрешения на открытие баз данных. Поэтому для предоставления этого разрешения необходимо выполнить сценарий. В этом разделе вы создадите скрипт, который будет выполняться позже, чтобы приложение могла открывать базы данных при запуске в службах IIS.

В папке *солутионфилес* решения, созданной в учебнике [развертывание в рабочей среде](deployment-to-a-hosting-provider-deploying-to-the-production-environment-7-of-12.md) , создайте новый файл SQL с именем *GRANT. SQL*. Скопируйте следующие команды SQL в файл, а затем сохраните и закройте файл:

[!code-sql[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample1.sql)]

> [!NOTE]
> Этот сценарий предназначен для работы с SQL Server 2008 и параметрами IIS в Windows 7, как указано в этом руководстве. Если вы используете другую версию SQL Server или Windows, или если службы IIS настроены по-разному, может потребоваться внести изменения в этот сценарий. Дополнительные сведения о скриптах SQL Server см. в разделе [Электронная документация на SQL Server](https://go.microsoft.com/fwlink/?LinkId=132511).

> [!NOTE] 
> 
> **Примечание по безопасности** Этот скрипт предоставляет базе данных\_разрешения владельца, которые обращаются к этой БД во время выполнения, что будет в рабочей среде. В некоторых сценариях может потребоваться указать пользователя, имеющего полные разрешения на обновление схемы базы данных только для развертывания, и указать для времени выполнения другой пользователь, имеющий разрешения только на чтение и запись данных. Дополнительные сведения см. в разделе **Просмотр автоматических изменений Web. config для Code First migrations** при [развертывании служб в IIS в качестве тестовой среды](deployment-to-a-hosting-provider-deploying-to-iis-as-a-test-environment-5-of-12.md).

## <a name="configuring-database-deployment-for-the-test-environment"></a>Настройка развертывания базы данных для тестовой среды

Далее предстоит настроить Visual Studio таким образом, чтобы она выполнит следующие задачи для каждой базы данных:

- Создайте скрипт SQL, который создает структуру базы данных-источника (таблицы, столбцы, ограничения и т. д.) в целевой базе данных.
- Создание скрипта SQL, который вставляет данные базы данных-источника в таблицы в целевой базе данных.
- Запустите созданные скрипты и созданный скрипт предоставления в целевой базе данных.

Откройте окно **Свойства проекта** и выберите вкладку **Пакет/Публикация SQL** .

Убедитесь, что в раскрывающемся списке **Конфигурация** выбрано значение **Активный (выпуск)** или **выпуск** .

Щелкните **включить эту страницу**.

![Package_Publish_SQL_tab_Enable_This_page](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image4.png)

Обычно вкладка **Пакет/Публикация SQL** отключена, так как указывает устаревший метод развертывания. В большинстве случаев следует настроить развертывание базы данных в мастере **публикации веб-сайта** . Переход с SQL Server Compact на SQL Server или SQL Server Express является особым случаем, когда этот метод является хорошим выбором.

Щелкните **Импорт из файла Web. config**.

![Selecting_Import_from_Web. config](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image5.png)

Visual Studio ищет строки подключения в файле *Web. config* , находит один для базы данных членства, а другой для базы данных School и добавляет строку, соответствующую каждой строке подключения в таблице **записей базы данных** . Найденные строки подключения предназначены для существующих баз данных SQL Server Compact, и следующим шагом будет настройка того, как и где развертывать эти базы данных.

Параметры развертывания базы данных вводятся в разделе « **сведения о записи базы данных** » под таблицей « **записи базы данных** ». Параметры, показанные в разделе **сведения о записи базы данных** , относятся к любой строке таблицы **записи базы данных** , как показано на следующем рисунке.

![Database_Entry_Details_section_of_Package_Publish_SQL_tab](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image6.png)

### <a name="configuring-deployment-settings-for-the-membership-database"></a>Настройка параметров развертывания для базы данных членства

Выберите строку **DefaultConnection-Deployment** в таблице **записей базы данных** , чтобы настроить параметры, которые применяются к базе данных членства.

В поле **строка подключения для целевой базы данных**введите строку подключения, которая указывает на новую базу данных членства SQL Server Express. Вы можете получить необходимую строку подключения из **Обозреватель сервера**. В **Обозреватель сервера**разверните **подключения к данным** и выберите базу данных **аспнеттест** , а затем в окне " **Свойства** " скопируйте значение **строки подключения** .

![aspnet_connection_string_in_Server_Explorer](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image7.png)

Та же строка подключения воспроизводится следующим образом:

[!code-console[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample2.cmd)]

Скопируйте и вставьте эту строку подключения в **строку подключения для целевой базы данных** на вкладке **Пакет/Публикация SQL** .

Убедитесь, что выбраны **данные для извлечения и (или) схемы из существующей базы данных** . Это приводит к тому, что скрипты SQL автоматически создаются и выполняются в целевой базе данных.

**Строка подключения для значения базы данных-источника** извлекается из файла *Web. config* и указывает на базу данных Development SQL Server Compact. Это база данных-источник, которая будет использоваться для создания скриптов, которые будут выполняться позже в целевой базе данных. Так как вы хотите развернуть рабочую версию базы данных, измените "АСПнет-дев. sdf" на "АСПнет-прод. sdf".

Измените **Параметры создания скриптов базы данных** со **схемы** на **схему и данные**, так как необходимо скопировать данные (учетные записи пользователей и роли), а также структуру базы данных.

Чтобы настроить развертывание для выполнения скриптов предоставления, созданных ранее, необходимо добавить их в раздел **скриптов базы данных** . Нажмите кнопку **Добавить скрипт**и в диалоговом окне **Добавление скриптов SQL** перейдите в папку, в которой сохранен сценарий предоставления (это папка, содержащая файл решения). Выберите файл с именем *GRANT. SQL*и нажмите кнопку **Открыть**.

[![Select_File_dialog_box_grant_script](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image9.png)](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image8.png)

Параметры для строки **DefaultConnection-Deployment** в **записях базы данных** теперь выглядят, как показано на следующем рисунке:

![Database_Entry_Details_for_DefaultConnection_Test](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image10.png)

### <a name="configuring-deployment-settings-for-the-school-database"></a>Настройка параметров развертывания для базы данных School

Затем выберите строку **SchoolContext-Deployment** в таблице **записей базы данных** , чтобы настроить параметры развертывания для базы данных School.

Вы можете использовать тот же метод, который использовался ранее, чтобы получить строку подключения для новой базы данных SQL Server Express. Скопируйте эту строку подключения в **строку подключения для целевой базы данных** на вкладке **Пакет/Публикация SQL** .

[!code-console[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample3.cmd)]

Убедитесь, что выбраны **данные для извлечения и (или) схемы из существующей базы данных** .

**Строка подключения для значения базы данных-источника** извлекается из файла *Web. config* и указывает на базу данных Development SQL Server Compact. Измените "Счул-дев. sdf" на "Счул-прод. sdf", чтобы развернуть рабочую версию базы данных. (Вы никогда не создавали файл Счул-прод. sdf в папке App\_Data, поэтому этот файл будет скопирован из тестовой среды в папку приложения\_данных в папке проекта ContosoUniversity позже.)

Измените **Параметры создания скриптов базы данных** на **схемы и данные**.

Кроме того, необходимо выполнить скрипт, чтобы предоставить удостоверению пула приложений разрешение на чтение и запись для этой базы данных, поэтому добавьте файл сценария *GRANT. SQL* , как это делалось для базы данных членства.

По завершении настройки строки **SchoolContext-Deployment** в **записях базы данных** будут выглядеть так, как показано на следующем рисунке:

![Database_Entry_Details_for_SchoolContext_Test](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image11.png)

Сохраните изменения на вкладке **Пакет/Публикация SQL** .

Скопируйте файл *счул-прод. sdf* из папки *к:\инетпуб\ввврут\контосауниверсити\апп\_Data* в папку *app\_Data* в проекте ContosoUniversity.

### <a name="specifying-transacted-mode-for-the-grant-script"></a>Указание режима транзакций для сценария предоставления прав

В процессе развертывания создаются скрипты, которые развертывают схему и данные базы данных. По умолчанию эти скрипты выполняются в транзакции. Однако пользовательские скрипты (например, скрипты предоставления) по умолчанию не выполняются в транзакции. Если процесс развертывания смешивает режимы транзакций, то при выполнении скриптов во время развертывания может возникнуть ошибка времени ожидания. В этом разделе вы измените файл проекта, чтобы настроить пользовательские скрипты для выполнения в транзакции.

В **Обозреватель решений**щелкните правой кнопкой мыши проект **ContosoUniversity** и выберите команду **Выгрузить проект**.

![Unload_Project_in_Solution_Explorer](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image12.png)

Затем снова щелкните проект правой кнопкой мыши и выберите **изменить ContosoUniversity. csproj**.

![Edit_Project_in_Solution_Explorer](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image13.png)

В редакторе Visual Studio отображается XML-содержимое файла проекта. Обратите внимание, что имеется несколько элементов `PropertyGroup`. (На изображении содержимое элементов `PropertyGroup` опущено.)

![Окно редактора файлов проекта](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image15.png)

Первый из них, не имеющий атрибута `Condition`, относится к параметрам, применяемым независимо от конфигурации сборки. Один элемент `PropertyGroup` применяется только к конфигурации отладочной сборки (Обратите внимание на атрибут `Condition`), один применяется только к конфигурации сборки выпуска, а один применяется только к конфигурации тестового построения. В элементе `PropertyGroup` для конфигурации сборки выпуска вы увидите элемент `PublishDatabaseSettings`, содержащий параметры, введенные на вкладке **Пакет/Публикация SQL** . Существует элемент `Object`, соответствующий каждому из указанных скриптов предоставления прав (Обратите внимание на два экземпляра "Grant. SQL"). По умолчанию атрибутом `Transacted` элемента `Source` для каждого скрипта предоставления прав является `False`.

![Transacted_false](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image16.png)

Измените значение атрибута `Transacted` элемента `Source` на `True`.

![Transacted_true](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image17.png)

Сохраните и закройте файл проекта, щелкните правой кнопкой мыши проект в **Обозреватель решений** и выберите **Перезагрузить проект**.

![Reload_project](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image18.png)

## <a name="setting-up-webconfig-transformations-for-the-connection-strings"></a>Настройка преобразований Web. config для строк подключения

Строки подключения для новых баз данных SQL Express, введенные на вкладке **Пакет/Публикация SQL** , используются веб-развертывание только для обновления целевой базы данных во время развертывания. По-прежнему необходимо настроить преобразования *Web. config* таким образом, чтобы строки подключения в развернутом файле *Web. config* указывали на новые базы данных SQL Server Express. (При использовании вкладки **Пакет/Публикация SQL** нельзя настроить строки подключения в профиле публикации.)

Откройте *файл Web. Test. config* и замените элемент `connectionStrings` на элемент `connectionStrings` в следующем примере. (Убедитесь, что только вы скопировали элемент connectionString, а не окружающий код, который показан здесь для предоставления контекста.)

[!code-xml[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample4.xml?highlight=2-11)]

Этот код вызывает замену `connectionString` и `providerName` атрибутов каждого элемента `add` в развернутом файле *Web. config* . Эти строки подключения не идентичны тем, которые были введены на вкладке **Пакет/Публикация SQL** . В них добавлен параметр "MultipleActiveResultSets = true", так как он необходим для Entity Framework и универсальные поставщики.

## <a name="installing-sql-server-compact"></a>Установка SQL Server Compact

Пакет NuGet Склсерверкомпакт предоставляет SQL Server Compact сборки ядра СУБД для приложения университета Contoso. Но теперь это не приложение, но веб-развертывание, которое должно иметь возможность считывать SQL Server Compact базы данных, чтобы создавать скрипты для запуска в базах данных SQL Server. Чтобы разрешить веб-развертывание читать базы данных SQL Server Compact, установите SQL Server Compact на компьютере разработчика, используя следующую ссылку: [Microsoft SQL Server Compact 4,0](https://www.microsoft.com/downloads/details.aspx?FamilyID=15F7C9B3-A150-4AD2-823E-E4E0DCF85DF6).

## <a name="deploying-to-the-test-environment"></a>Развертывание в тестовой среде

Для публикации в тестовой среде необходимо создать профиль публикации, настроенный на использование вкладки **Пакет/Публикация SQL** для публикации базы данных вместо параметров базы данных профиля публикации.

Сначала удалите существующий профиль тестирования.

В **Обозреватель решений**щелкните правой кнопкой мыши проект ContosoUniversity и выберите пункт **опубликовать**.

Перейдите на вкладку **профиль** .

Щелкните **Управление профилями**.

Выберите **тест**, щелкните **Удалить**, а затем нажмите кнопку **Закрыть**.

Закройте мастер **публикации веб-сайта** , чтобы сохранить это изменение.

Затем создайте новый профиль тестирования и используйте его для публикации проекта.

В **Обозреватель решений**щелкните правой кнопкой мыши проект ContosoUniversity и выберите пункт **опубликовать**.

Перейдите на вкладку **профиль** .

Выберите **&lt;New...&gt;** из раскрывающегося списка и введите "Test" в качестве имени профиля.

В поле **URL-адрес службы** введите *localhost*.

В поле **сайт/приложение** введите *Default Web site/ContosoUniversity*.

В поле **URL-адрес назначения** введите `http://localhost/ContosoUniversity/`.

Нажмите кнопку **Далее**.

На вкладке **Параметры** выводится предупреждение о том, что вкладка **Пакет/Публикация SQL** настроена, и она дает возможность переопределить их, нажав кнопку включить новые улучшения публикации базы данных. Для этого развертывания не нужно переопределять параметры вкладки **Пакет/Публикация SQL** , поэтому просто нажмите кнопку **Далее**.

![Publish_Web_wizard_Settings_tab_Migrate](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image19.png)

Сообщение на вкладке **Предварительный просмотр** указывает, что **базы данных не выбраны для публикации**, но это означает, что публикация базы данных не настроена в профиле публикации.

Нажмите кнопку **Опубликовать**.

![Publish_Web_wizard_Preview_tab_Migrate](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image20.png)

Visual Studio развертывает приложение и открывает браузер на домашней странице сайта в тестовой среде. Запустите страницу инструкторы, чтобы увидеть, что в ней отображаются те же данные, которые вы видели ранее. Выполните страницу **Добавление учащихся** , добавьте нового учащегося, а затем просмотрите нового учащегося на странице **учащихся** . Это подтверждает, что можно обновить базу данных. Перейдите на страницу **Обновление кредитов** (необходимо войти), чтобы убедиться, что база данных членства была развернута и у вас есть доступ к ней.

## <a name="creating-a-sql-server-database-for-the-production-environment"></a>Создание базы данных SQL Server для рабочей среды

Теперь, когда вы развернули в тестовую среду, можно приступать к настройке развертывания в рабочей среде. Начнем с создания тестовой среды, создав базу данных для развертывания. Как вы помните из обзора, план размещения Цитаниум Lite допускает только одну базу данных SQL Server, поэтому вы настроите только одну базу данных, а не две. Все таблицы и данные из баз данных Membership and School SQL Server Compact будут развернуты в одной SQL Server базе данных в рабочей среде.

Перейдите на панель управления Цитаниум по адресу [http://panel.cytanium.com](http://panel.cytanium.com). Наведите указатель мыши на **базы данных** и выберите **SQL Server 2008**.

[![Selecting_Databases_in_Control_Panel](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image22.png)](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image21.png)

На странице **SQL Server 2008** щелкните **создать базу данных**.

[![Selecting_Create_Database](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image24.png)](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image23.png)

Присвойте базе данных имя School и нажмите кнопку **сохранить**. (Страница автоматически добавляет префикс «контосау», поэтому действующее имя будет «Контосаусчул».)

[![Naming_the_database](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image26.png)](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image25.png)

На той же странице щелкните **создать пользователя**. На серверах Цитаниум вместо встроенной системы безопасности Windows и разрешив удостоверению пула приложений открыть базу данных, вы создадите пользователя, обладающего полномочиями на открытие базы данных. Вы добавите учетные данные пользователя в строки подключения, которые попадают в рабочий файл *Web. config* . На этом шаге вы создадите эти учетные данные.

[![Creating_a_database_user](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image28.png)](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image27.png)

Заполните обязательные поля на странице **свойств пользователя SQL** :

- В качестве имени введите "Контосауниверситюсер".
- Введите пароль.
- Выберите **контосаусчул** в качестве базы данных по умолчанию.
- Установите флажок **контосаусчул** .

[![SQL_User_Properties_page](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image30.png)](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image29.png)

## <a name="configuring-database-deployment-for-the-production-environment"></a>Настройка развертывания базы данных для рабочей среды

Теперь можно приступать к настройке параметров развертывания базы данных на вкладке **Пакет/Публикация SQL** , как это было сделано ранее для тестовой среды.

Откройте окно **Свойства проекта** , выберите вкладку **Пакет/Публикация SQL** и убедитесь, что в раскрывающемся списке **Конфигурация** выбрано значение **Активный (выпуск)** или **выпуск** .

При настройке параметров развертывания для каждой базы данных основное различие между действиями, выполняемыми в рабочей и тестовой средах, заключается в настройке строк подключения. Для тестовой среды введены разные строки подключения к целевой базе данных, но для рабочей среды строка подключения назначения будет одинаковой для обеих баз данных. Это связано с тем, что обе базы данных развертываются в одной базе данных в рабочей среде.

### <a name="configuring-deployment-settings-for-the-membership-database"></a>Настройка параметров развертывания для базы данных членства

Чтобы настроить параметры, которые применяются к базе данных членства, выберите строку **DefaultConnection-Deployment** в таблице **записей базы данных** .

В поле **строка подключения для целевой базы данных**введите строку подключения, указывающую на только что созданную базу данных Production SQL Server. Строку подключения можно получить в приветственном сообщении электронной почты. Соответствующая часть сообщения электронной почты содержит следующий пример строки подключения:

[!code-console[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample5.cmd)]

После замены трех переменных нужная строка подключения выглядит как в следующем примере:

[!code-console[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample6.cmd)]

Скопируйте и вставьте эту строку подключения в **строку подключения для целевой базы данных** на вкладке **Пакет/Публикация SQL** .

Убедитесь, что выбраны **данные для извлечения и (или) схемы из существующей базы данных** , и что **Параметры создания скриптов базы данных** по-прежнему являются **схемами и данными**.

В поле **скрипты базы данных** снимите флажок для скрипта GRANT. SQL.

![Disable_Grant_script](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/_static/image31.png)

### <a name="configuring-deployment-settings-for-the-school-database"></a>Настройка параметров развертывания для базы данных School

Затем выберите строку **SchoolContext-Deployment** в таблице **записей базы данных** , чтобы настроить параметры базы данных School.

Скопируйте ту же строку подключения в **строку соединения для целевой базы** данных, скопированную в это поле для базы данных членства.

Убедитесь, что выбраны **данные для извлечения и (или) схемы из существующей базы данных** , и что **Параметры создания скриптов базы данных** по-прежнему являются **схемами и данными**.

В поле **скрипты базы данных** снимите флажок для скрипта GRANT. SQL.

Сохраните изменения на вкладке **Пакет/Публикация SQL** .

## <a name="setting-up-webconfig-transforms-for-the-connection-strings-to-production-databases"></a>Настройка преобразований Web. config для строк подключения к рабочим базам данных

Далее предстоит настроить преобразования *Web. config* таким образом, чтобы строки подключения в развернутом файле *Web. config* указывали на новую рабочую базу данных. Строка подключения, введенная на вкладке " **Пакет/Публикация SQL** " для веб-развертывание, совпадает с той, что используется приложением, за исключением добавления параметра `MultipleResultSets`.

Откройте *файл Web. Production. config* и замените элемент `connectionStrings` на элемент `connectionStrings`, который выглядит, как в следующем примере. (Скопируйте только элемент `connectionStrings`, а не окружающие теги, предоставленные для отображения контекста.)

[!code-xml[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample7.xml?highlight=2-11)]

Иногда вы видите уведомление о том, что необходимо всегда шифровать строки подключения в файле *Web. config* . Это может быть уместно при развертывании на серверах в сети вашей организации. Однако при развертывании в общедоступной среде размещения вы доверяете рекомендациям по обеспечению безопасности поставщика услуг размещения, и нет необходимости или практично шифровать строки подключения.

## <a name="deploying-to-the-production-environment"></a>Развертывание в рабочей среде

Теперь вы готовы к развертыванию в рабочей среде. Веб-развертывание будет считывать SQL Server Compact базы данных в папке *данных приложения\_* проекта и повторно создавать все их таблицы и данные в рабочей базе данных SQL Server. Для публикации с использованием параметров **веб-вкладки Пакет/Публикация** необходимо создать новый профиль публикации для рабочей среды.

Сначала удалите существующий рабочий профиль, так как вы ранее проходили тестовый профиль.

В **Обозреватель решений**щелкните правой кнопкой мыши проект ContosoUniversity и выберите пункт **опубликовать**.

Перейдите на вкладку **профиль** .

Щелкните **Управление профилями**.

Выберите **Рабочая**, нажмите кнопку **Удалить**, а затем кнопку **Закрыть**.

Закройте мастер **публикации веб-сайта** , чтобы сохранить это изменение.

Затем создайте новый рабочий профиль и используйте его для публикации проекта.

В **Обозреватель решений**щелкните правой кнопкой мыши проект ContosoUniversity и выберите пункт **опубликовать**.

Перейдите на вкладку **профиль** .

Нажмите кнопку **Импорт**и выберите скачанный ранее файл publishsettings.

На вкладке **Подключение** измените **URL-адрес назначения** на правильный временный URL-адрес, который в этом примере http://contosouniversity.com.vserver01.cytanium.com.

Переименуйте профиль в рабочую среду. (Чтобы сделать это, выберите вкладку **профиль** и щелкните **Управление профилями** .)

Закройте мастер **публикации веб-сайта** , чтобы сохранить изменения.

В реальных приложениях, в которых база данных была обновлена в рабочей среде, перед публикацией необходимо выполнить два дополнительных действия.

1. Отправьте *приложение\_offline. htm*, как показано в учебнике [развертывание в рабочей среде](deployment-to-a-hosting-provider-deploying-to-the-production-environment-7-of-12.md) .
2. С помощью компонента **диспетчера файлов** на панели управления цитаниум скопируйте файлы *АСПнет-прод. sdf* и *счул-прод. sdf* с рабочего сайта в папку *приложения\_данных* проекта ContosoUniversity. Это гарантирует, что данные, развертываемые в новую базу данных SQL Server, будут содержать последние обновления, выполненные рабочим веб-сайтом.

На панели инструментов **веб-публикация одним щелчком** убедитесь, что выбран параметр **Рабочий** профиль, и нажмите кнопку **опубликовать**.

Если вы перегрузили <em>приложение\_offline. htm</em> перед публикацией, необходимо использовать служебную программу <strong>диспетчера файлов</strong> на панели управления цитаниум, чтобы удалить <em>приложение\_автономно.</em> htm перед тестированием. Кроме того, в то же время можно удалить <em>SDF</em> файлы из папки <em>данных приложения\_</em> .

Теперь можно открыть браузер и перейти по URL-адресу общедоступного сайта, чтобы протестировать приложение так же, как и после развертывания в тестовой среде.

## <a name="switching-to-sql-server-express-localdb-in-development"></a>Переход на SQL Server Express LocalDB в разработке

Как было объяснено в обзоре, обычно лучше использовать то же ядро СУБД в разработке, которое используется в тестовой и рабочей среде. (Помните, что преимущество использования SQL Server Express в разработке заключается в том, что база данных будет работать так же, как в среде разработки, тестирования и рабочих средах.) В этом разделе вы настроите проект ContosoUniversity для использования SQL Server Express LocalDB при запуске приложения из Visual Studio.

Самый простой способ выполнить эту миграцию — позволить Code First и системе членства создавать новые базы данных разработки. Использование этого метода для миграции требует выполнения трех шагов:

1. Измените строки подключения, чтобы указать новые базы данных SQL Express LocalDB.
2. Запустите средство администрирования веб-сайта, чтобы создать пользователя с правами администратора. Будет создана база данных членства.
3. Используйте команду Code First Migrations Update-Database, чтобы создать и заполнить базу данных приложения.

### <a name="updating-connection-strings-in-the-webconfig-file"></a>Обновление строк подключения в файле Web. config

Откройте файл *Web. config* и замените элемент `connectionStrings` следующим кодом:

[!code-xml[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample8.xml)]

### <a name="creating-the-membership-database"></a>Создание базы данных членства

В **Обозреватель решений**выберите проект ContosoUniversity, а затем в меню **проект** выберите пункт **Конфигурация ASP.NET** .

Перейдите на вкладку Безопасность.

Щелкните **Создание ролей или управление ими**, а затем создайте роль **администратора** .

Вернитесь на вкладку Безопасность.

Щелкните **создать пользователя**, а затем установите флажок **Администратор** и создайте пользователя с именем admin.

Закройте **средство администрирования веб-сайта**.

### <a name="creating-the-school-database"></a>Создание базы данных School

Откройте окно консоли диспетчера пакетов.

В раскрывающемся списке **проект по умолчанию** выберите проект CONTOSOUNIVERSITY. DAL.

Введите следующую команду:

[!code-powershell[Main](deployment-to-a-hosting-provider-migrating-to-sql-server-10-of-12/samples/sample9.ps1)]

Code First Migrations применяет начальную миграцию, которая создает базу данных, а затем применяет Аддбирсдате миграцию, а затем запускает метод SEED.

Запустите сайт, нажав клавиши CTRL + F5. Как и в тестовой и рабочей средах, выполните страницу **Добавление учащихся** , добавьте нового учащегося, а затем просмотрите новый учащийся на странице **учащихся** . Это подтверждает, что база данных School была создана и инициализирована и у вас есть доступ к ней для чтения и записи.

Перейдите на страницу **Обновление кредитов** и войдите в систему, чтобы убедиться, что база данных членства была развернута и у вас есть доступ к ней. Если вы не переносите учетные записи пользователей, создайте учетную запись администратора, а затем щелкните страницу **Обновление кредитов** , чтобы убедиться, что она работает.

## <a name="cleaning-up-sql-server-compact-files"></a>Очистка файлов SQL Server Compact

Вам больше не нужны файлы и пакеты NuGet, которые были добавлены для поддержки SQL Server Compact. Если требуется (этот шаг не является обязательным), можно очистить ненужные файлы и ссылки.

В **Обозреватель решений**удалите *SDF* файлы из папки *данных приложения\_* , а также папки *AMD64* и *x86* из папки *bin* .

В **Обозреватель решений**щелкните правой кнопкой мыши решение (не один из проектов), а затем выберите пункт **Управление пакетами NuGet для решения**.

В левой области диалогового окна **Управление пакетами NuGet** выберите **установленные пакеты**.

Выберите пакет **EntityFramework. склсерверкомпакт** и щелкните **Управление**.

В диалоговом окне **Выбор проектов** выбираются оба проекта. Чтобы удалить пакет в обоих проектах, снимите оба флажка, а затем нажмите кнопку **ОК**.

В диалоговом окне с запросом на удаление зависимых пакетов и нажмите кнопку нет. Один из них — это пакет Entity Framework, который необходимо удержать.

Выполните ту же процедуру, чтобы удалить пакет **склсерверкомпакт** . (Пакеты должны быть удалены в указанном порядке, так как пакет **EntityFramework. склсерверкомпакт** зависит от пакета **склсерверкомпакт** .)

Теперь вы успешно выполнили миграцию на SQL Server Express и полную SQL Server. В следующем учебном курсе вы измените другую базу данных, и вы увидите, как развертывать изменения базы данных, когда в тестовых и рабочих базах данных используются SQL Server Express и полные SQL Server.

> [!div class="step-by-step"]
> [Назад](deployment-to-a-hosting-provider-deploying-a-database-update-9-of-12.md)
> [Вперед](deployment-to-a-hosting-provider-deploying-a-sql-server-database-update-11-of-12.md)
