---
uid: web-forms/overview/older-versions-getting-started/deployment-to-a-hosting-provider/deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12
title: 'Развертывание веб-приложения ASP.NET с SQL Server Compact с помощью Visual Studio или Visual Web Developer: преобразования файла Web. config — 3 из 12 | Документация Майкрософт'
author: tdykstra
description: В этой серии учебников показано, как развернуть (опубликовать) проект веб-приложения ASP.NET, включающий базу данных SQL Server Compact, с помощью Visual Stu...
ms.author: riande
ms.date: 11/17/2011
ms.assetid: 2b0df3d9-450b-4ea6-b315-4c9650722cad
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deployment-to-a-hosting-provider/deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12
msc.type: authoredcontent
ms.openlocfilehash: fe71e6cfb0f4c5f1d99b326e9d90edb6c8c5feee
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74600540"
---
# <a name="deploying-an-aspnet-web-application-with-sql-server-compact-using-visual-studio-or-visual-web-developer-webconfig-file-transformations---3-of-12"></a>Развертывание веб-приложения ASP.NET с SQL Server Compact с помощью Visual Studio или Visual Web Developer: преобразования файла Web. config — 3 из 12

от [Tom Dykstra)](https://github.com/tdykstra)

[Скачать начальный проект](https://code.msdn.microsoft.com/Deploying-an-ASPNET-Web-4e31366b)

> В этой серии учебников показано, как развернуть (опубликовать) проект веб-приложения ASP.NET, включающий базу данных SQL Server Compact, с помощью Visual Studio 2012 RC или Visual Studio Express 2012 RC для Web. При установке обновления веб-публикации можно также использовать Visual Studio 2010. Введение в серию см. [в первом учебнике серии](deployment-to-a-hosting-provider-introduction-1-of-12.md).
> 
> Руководство, в котором показаны функции развертывания, появившиеся после выпуска версии-КАНДИДАТа Visual Studio 2012, демонстрирует развертывание SQL Server выпусков, отличных от SQL Server Compact, и демонстрация развертывания в веб-приложениях службы приложений Azure см. в разделе [ASP.NET Web Deploying using Visual Studio](../../deployment/visual-studio-web-deployment/introduction.md).

## <a name="overview"></a>Обзор

В этом учебнике показано, как автоматизировать процесс изменения файла *Web. config* при его развертывании в различных целевых средах. Большинство приложений имеют параметры в файле *Web. config* , которые должны отличаться при развертывании приложения. Автоматизация процесса внесения этих изменений позволяет не выполнять их вручную при каждом развертывании, что может быть утомительным и подверженным ошибкам.

Напоминание. Если вы получаете сообщение об ошибке или что-то не работает при работе с этим руководством, обязательно ознакомьтесь со [страницей устранения неполадок](deployment-to-a-hosting-provider-creating-and-installing-deployment-packages-12-of-12.md).

## <a name="webconfig-transformations-versus-web-deploy-parameters"></a>Преобразования Web. config и параметры веб-развертывание

Существует два способа автоматизации процесса изменения параметров файла *Web. config* : [преобразования Web. config](https://msdn.microsoft.com/library/dd465326.aspx) и [веб-развертывание параметров](https://msdn.microsoft.com/library/ff398068.aspx). Файл преобразования *Web. config* содержит XML-разметку, которая определяет способ изменения файла *Web. config* при его развертывании. Можно указать различные изменения для конкретных конфигураций сборки и для конкретных профилей публикации. Конфигурации сборки по умолчанию — Debug и Release, а также можно создавать пользовательские конфигурации сборки. Профиль публикации обычно соответствует целевой среде. (Дополнительные сведения о профилях публикации см. в учебнике [развертывание в службах IIS в качестве тестовой среды](deployment-to-a-hosting-provider-deploying-to-iis-as-a-test-environment-5-of-12.md) .)

Параметры веб-развертывание можно использовать для указания множества различных типов параметров, которые должны быть настроены во время развертывания, включая параметры, которые находятся в файлах *Web. config* . При использовании для указания изменений в файле *Web. config* веб-развертывание параметры более сложны для настройки, но они могут оказаться полезными, если вы не уверены, что значение должно быть задано до развертывания. Например, в корпоративной среде вы можете создать *пакет развертывания* и передать его пользователю в ИТ-отделе для установки в рабочую среду, и этот человек должен иметь возможность вводить строки подключения или пароли, которые незнакомы.

В рамках сценария, который рассматривается в этом руководстве, вы узнаете все, что нужно сделать с файлом *Web. config* , поэтому не нужно использовать веб-развертывание параметры. Вы настроите некоторые преобразования, которые различаются в зависимости от используемой конфигурации сборки, и некоторые из них различаются в зависимости от используемого профиля публикации.

## <a name="creating-transformation-files-for-publish-profiles"></a>Создание файлов преобразования для профилей публикации

В **Обозреватель решений**разверните файл *Web. config* , чтобы просмотреть файлы преобразования *Web. Debug. config* и *Web. Release. config* , которые создаются по умолчанию для двух конфигураций сборки по умолчанию.

![Web. config_transform_files](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image1.png)

Чтобы создать файлы преобразования для пользовательских конфигураций сборки, щелкните правой кнопкой мыши файл Web. config и в контекстном меню выберите команду **Добавить преобразования конфигурации** , но в этом учебнике это не требуется.

Для настройки изменений, связанных с назначением развертывания, а не с конфигурацией сборки, требуется еще два файла преобразования. Типичный пример такого рода параметров — конечная точка WCF, которая отличается для тестирования в сравнении с рабочими средами. В последующих руководствах вы создадите профили публикации с именем Test и Production, поэтому вам потребуется файл *Web. Test. config* и файл *Web. Production. config* .

Файлы преобразования, привязанные к профилям публикации, необходимо создавать вручную. В **Обозреватель решений**щелкните правой кнопкой мыши проект ContosoUniversity и выберите пункт **Открыть папку в проводнике Windows**.

![Open_folder_in_Windows_Explorer](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image2.png)

В **проводнике Windows**выберите файл *Web. Release. config* , скопируйте файл и вставьте две копии. Переименуйте эти копии *Web. Production. config* и *Web. Test. config*, а затем закройте **проводник Windows**.

В **Обозреватель решений**нажмите кнопку **Обновить** , чтобы просмотреть новые файлы.

Выберите новые файлы, щелкните правой кнопкой мыши и выберите пункт **включить в проект** в контекстном меню.

![Включение тестовых и рабочих файлов конфигурации в проект](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image3.png)

Чтобы предотвратить развертывание этих файлов, выберите их в **Обозреватель решений**, а затем в окне **Свойства** измените свойство **действие сборки** с **Content** на **None**. (Файлы преобразования, основанные на конфигурациях сборки, автоматически не разворачиваются.)

Теперь все готово для ввода преобразований *Web. config* в файлы преобразования *Web. config* .

## <a name="limiting-error-log-access-to-administrators"></a>Ограничение доступа к журналам ошибок администраторам

Если во время выполнения приложения произошла ошибка, приложение отображает общую страницу ошибки вместо страницы ошибки, сформированной системой, и использует [пакет NuGet ELMAH](http://www.hanselman.com/blog/NuGetPackageOfTheWeek7ELMAHErrorLoggingModulesAndHandlersWithSQLServerCompact.aspx) для ведения журнала ошибок и создания отчетов. Элемент `customErrors` в файле *Web. config* указывает страницу ошибки:

[!code-xml[Main](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/samples/sample1.xml)]

Чтобы просмотреть страницу ошибки, временно измените атрибут `mode` элемента `customErrors` с "RemoteOnly" на "on" и запустите приложение из Visual Studio. Вызвать ошибку, запросив недопустимый URL-адрес, например *студентскскскс. aspx*. Вместо страницы ошибки "страница не найдена", созданной в IIS, отображается страница *женерицеррорпаже. aspx* .

[![Error_page](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image5.png)](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image4.png)

Чтобы просмотреть журнал ошибок, замените все значение URL-адреса после номера порта *ELMAH. axd* (для примера на снимке экрана `http://localhost:51130/elmah.axd`) и нажмите клавишу ВВОД:

[![Elmah_log_page](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image7.png)](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image6.png)

Не забудьте установить элемент `customErrors` обратно в режим "RemoteOnly" по завершении.

На компьютере разработчика удобно разрешить бесплатный доступ к странице журнала ошибок, но в рабочей среде это может представлять угрозу безопасности. Для рабочего сайта можно добавить правило авторизации, которое будет ограничивать доступ к журналу ошибок только для администраторов, настроив преобразование в файле *Web. Production. config* .

Откройте *файл Web. Production. config* и добавьте новый элемент `location` сразу после открывающего тега `configuration`, как показано ниже. (Убедитесь, что добавлен только элемент `location`, а не окружающая разметка, которая показана здесь только для предоставления некоторого контекста.)

[!code-xml[Main](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/samples/sample2.xml?highlight=2-9)]

Значение атрибута `Transform` "Insert" приводит к тому, что элемент `location` добавляется в качестве одноуровневого элемента в любые существующие элементы `location` в файле *Web. config* . (Уже имеется один элемент `location`, указывающий правила авторизации для страницы **Обновление кредитов** .) При тестировании рабочего сайта после развертывания вы проверите, действительно ли это правило авторизации.

Вам не нужно ограничивать доступ к журналу ошибок в тестовой среде, поэтому вам не нужно добавлять этот код в файл *Web. Test. config* .

> [!NOTE] 
> 
> **Примечание по безопасности** Никогда не отображать сведения об ошибках в рабочем приложении или хранить их в общедоступном месте. Злоумышленники могут использовать сведения об ошибке для обнаружения уязвимостей на сайте. Если вы используете ELMAH в своем приложении, не забудьте изучить способы настройки ELMAH, чтобы снизить риски безопасности. Пример ELMAH в этом учебнике не следует рассматривать как рекомендуемую конфигурацию. Это пример, который был выбран для того, чтобы продемонстрировать, как обрабатывать папку, в которой приложение должно иметь возможность создавать файлы.

## <a name="setting-an-environment-indicator"></a>Настройка индикатора среды

Распространенный сценарий состоит в том, что параметры файла *Web. config* должны быть разными в каждой среде, развертываемой в. Например, приложению, которое вызывает службу WCF, может потребоваться другая конечная точка в тестовой и рабочей средах. Кроме того, приложение университета Contoso включает параметр этого типа. Этот параметр управляет видимым индикатором на страницах сайта с указанием среды, в которой вы являетесь, например, для разработки, тестирования или производства. Значение параметра определяет, будет ли приложение добавлять "(dev)" или "(тест)" к главному заголовку на главной странице *site. master* :

[![Environment_indicator](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image9.png)](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/_static/image8.png)

При выполнении приложения в рабочей среде индикатор среды опускается.

Веб-страницы университета Contoso считывают значение, заданное в `appSettings` в файле *Web. config* , чтобы определить, в какой среде выполняется приложение.

[!code-xml[Main](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/samples/sample3.xml)]

Значение должно быть "Test" в тестовой среде и "Production" в рабочей среде.

Откройте *файл Web. Production. config* и добавьте элемент `appSettings` непосредственно перед открывающим тегом элемента `location`, который вы добавили ранее.

[!code-xml[Main](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/samples/sample4.xml)]

Значение атрибута `xdt:Transform` "Сетаттрибутес" указывает, что назначение этого преобразования заключается в изменении значений атрибутов существующего элемента в файле *Web. config* . Значение атрибута `xdt:Locator` "Match (ключ)" указывает, что изменяемый элемент является элементом, атрибут `key` которого соответствует атрибуту `key`, указанному здесь. Единственным другим атрибутом элемента `add` является `value`, который будет изменен в развернутом файле *Web. config* . Этот код приводит к тому, что атрибуту `value` элемента `Environment` `appSettings` присваивается значение "Production" в файле *Web. config* , который развертывается в рабочей среде.

Затем примените то же изменение к файлу *Web. Test. config* , за исключением того, что для параметра `value` значение "Test", а не "произв.". По завершении раздел `appSettings` в *файле Web. Test. config* будет выглядеть, как в следующем примере:

[!code-xml[Main](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/samples/sample5.xml)]

## <a name="disabling-debug-mode"></a>Отключение режима отладки

Для сборки выпуска отладка не должна включаться независимо от среды, в которой выполняется развертывание. По умолчанию файл преобразования *Web. Release. config* создается автоматически с кодом, который удаляет атрибут `debug` из элемента `compilation`:

[!code-xml[Main](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/samples/sample6.xml)]

Атрибут `Transform` вызывает пропуск атрибута `debug` в развернутом файле *Web. config* при каждом развертывании сборки выпуска.

Это же преобразование находится в тестовых и рабочих файлах преобразования, так как вы создали их путем копирования файла преобразования выпуска. Он не нужен, поэтому следует открыть каждый из этих файлов, удалить элемент **компиляции** и сохранить и закрыть каждый файл.

## <a name="setting-connection-strings"></a>Настройка строк подключения

В большинстве случаев нет необходимости настраивать преобразования строк подключения, так как строки подключения можно указать в профиле публикации. Но при развертывании базы данных SQL Server Compact возникает исключение, а для обновления базы данных на целевом сервере используется Entity Framework Code First Migrations. В этом сценарии необходимо указать дополнительную строку подключения, которая будет использоваться на сервере для обновления схемы базы данных. Чтобы настроить это преобразование, добавьте элемент **&lt;connectionstring&gt;** непосредственно после открывающего тега **&lt;Configuration&gt;** в файлах преобразования *Web. Test. config* и *Web. Production. config* .

[!code-xml[Main](deployment-to-a-hosting-provider-web-config-file-transformations-3-of-12/samples/sample7.xml)]

Атрибут `Transform` указывает, что эта строка подключения будет добавлена в элемент *ConnectionString* в развернутом файле *Web. config* . (Процесс публикации создает эту дополнительную строку подключения автоматически, если она не существует, но по умолчанию атрибуту **providerName** присваивается значение `System.Data.SqlClient`, которое не работает для SQL Server Compact. Добавляя строку подключения вручную, вы сохраняете в процессе развертывания создание элемента строки подключения с неправильным именем поставщика.)

Теперь вы указали все преобразования *Web. config* , необходимые для развертывания приложения университета Contoso в тестировании и производстве. В следующем учебнике будут рассмотрены задачи настройки развертывания, требующие настройки свойств проекта.

## <a name="more-information"></a>Дополнительные сведения

Дополнительные сведения о темах, описываемых в этом руководстве, см. в описании сценария преобразования Web. config в [карте содержимого развертывания ASP.NET](https://msdn.microsoft.com/library/bb386521.aspx).

> [!div class="step-by-step"]
> [Назад](deployment-to-a-hosting-provider-deploying-sql-server-compact-databases-2-of-12.md)
> [Вперед](deployment-to-a-hosting-provider-configuring-project-properties-4-of-12.md)
