---
uid: web-forms/overview/older-versions-getting-started/master-pages/nested-master-pages-vb
title: Вложенные главные страницы (VB) | Документация Майкрософт
author: rick-anderson
description: Показывает, как вложить одну главную страницу в другую.
ms.author: riande
ms.date: 07/28/2008
ms.assetid: 14d9aa1b-4dca-43a0-aa9d-a6e891fee019
msc.legacyurl: /web-forms/overview/older-versions-getting-started/master-pages/nested-master-pages-vb
msc.type: authoredcontent
ms.openlocfilehash: 9bb39712855c37f5cbcbb447f7691e9451b8dc92
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74642023"
---
# <a name="nested-master-pages-vb"></a>Вложенные эталонные страницы (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/d/6/6/d66ad554-afdd-409e-a5c3-201b774fbb31/ASPNET_MasterPages_Tutorial_10_VB.zip) или [скачать PDF](https://download.microsoft.com/download/d/6/6/d66ad554-afdd-409e-a5c3-201b774fbb31/ASPNET_MasterPages_Tutorial_10_VB.pdf)

> Показывает, как вложить одну главную страницу в другую.

## <a name="introduction"></a>Введение

В течение прошлых девяти учебников мы рассмотрели, как реализовать макет на уровне сайта с помощью главных страниц. В двух словах, Главная страница позволяет разработчику страницы определить общую разметку на главной странице вместе с конкретными регионами, которые можно настроить на странице содержимого по содержимому. Элементы управления ContentPlaceHolder на главной странице указывают на настраиваемые регионы. настроенная разметка для элементов управления ContentPlaceHolder определяется на странице содержимого с помощью элементов управления содержимым.

Методы главной страницы, которые мы рассматривали до сих пор, прекрасно подходят, если используется один макет для всего сайта. Однако многие крупные веб-сайты имеют макет сайта, настроенный в различных разделах. Например, рассмотрим приложение для здравоохранения, используемое сотрудниками больницы для управления информацией о пациентах, действиями и выставлением счетов. В этом приложении может быть три типа веб-страниц:

- Страницы, относящиеся к сотрудникам, на которых сотрудники могут обновлять доступность, просматривать расписания или запрашивать время отпуска.
- Страницы, связанные с пациентами, в которых сотрудники просматривают или изменяют сведения о конкретном пациенте.
- Страницы, относящиеся к выставлению счетов, где бухгалтеры просматривают текущие состояния утверждений и финансовые отчеты.

На каждой странице может использоваться общий макет, например меню в верхней части и ряд часто используемых ссылок внизу. Но сотрудникам, пациентам и конкретным вопросам выставления счетов может потребоваться настроить этот общий макет. Например, все страницы, относящиеся к персоналу, должны включать календарь и список задач, в которых отображаются сведения о доступности и ежедневном планировании текущего пользователя. Возможно, все страницы, относящиеся к пациентам, должны отображать имя, адрес и страховую информацию для пациента, сведения о котором редактируются.

Такие настраиваемые макеты можно создавать с помощью *вложенных главных страниц*. Для реализации описанного выше сценария мы начнем с создания главной страницы, определяющей макет всего сайта, содержимое меню и нижнего колонтитула с элементов управления ContentPlaceHolder, определяющим настраиваемые регионы. Затем мы создадим три вложенных главных страницы — по одной для каждого типа веб-страницы. Каждая вложенная эталонная страница определяет содержимое по типу страниц содержимого, использующих главную страницу. Другими словами, вложенная эталонная страница для страниц содержимого, относящихся к пациентам, должна включать разметку и программную логику для отображения сведений об изменяемом пациенте. При создании страницы, относящейся к пациенту, ее следует привязать к этой вложенной главной странице.

Этот учебник начинается с выделения преимуществ вложенных главных страниц. Затем показано, как создавать и использовать вложенные главные страницы.

> [!NOTE]
> Вложенные главные страницы могли быть доступны после .NET Framework версии 2,0. Однако Visual Studio 2005 не включала поддержку времени разработки для вложенных главных страниц. Хорошая новость заключается в том, что Visual Studio 2008 предлагает широкие возможности разработки вложенных главных страниц. Если вы заинтересованы в использовании вложенных главных страниц, но все еще используете Visual Studio 2005, ознакомьтесь с записью блога [Скотта Гатри (](https://weblogs.asp.net/scottgu/), [советами по вложенным главным страницам в VS 2005 во время разработки](https://weblogs.asp.net/scottgu/archive/2005/11/11/430382.aspx).

## <a name="the-benefits-of-nested-master-pages"></a>Преимущества вложенных главных страниц

Многие веб-сайты имеют раздельную структуру сайта, а также более настраиваемые разработки, характерные для определенных типов страниц. Например, в нашем демонстрационном веб-приложении мы создали раздел "элементарное Администрирование" (страницы в папке `~/Admin`). В настоящее время веб-страницы в папке `~/Admin` используют ту же главную страницу, что и страницы, не находящиеся в разделе Администрирование (а именно, `Site.master` или `Alternate.master`в зависимости от выбора пользователя).

> [!NOTE]
> Сейчас представьте, что наш сайт содержит только одну главную страницу, `Site.master`. Далее в этом руководстве мы будем использовать вложенные главные страницы с двумя (или более) главными страницами, начинающимися с «Использование вложенной главной страницы для администрирования».

Представьте, что нам было предложено настроить макет страниц администрирования для включения дополнительных сведений или ссылок, которые в других страницах сайта не будут представлены другим способом. Существует четыре метода реализации этого требования:

1. Вручную добавьте сведения, относящиеся к администрированию, и ссылки на каждую страницу содержимого в папке `~/Admin`.
2. Обновите главную страницу `Site.master`, включив в нее сведения и ссылки, связанные с разделом администрирования, а затем добавьте код на главную страницу, чтобы показать или скрыть эти разделы в зависимости от того, посещается ли одна из страниц администрирования.
3. Создайте новую главную страницу специально для раздела Администрирование, скопируйте разметку из `Site.master`, добавьте сведения о разделе администрирования и ссылки, а затем обновите страницы содержимого в папке `~/Admin`, чтобы использовать эту новую главную страницу.
4. Создайте вложенную главную страницу, которая привязывается к `Site.master` и страницы содержимого в папке `~/Admin` используйте эту новую вложенную главную страницу. Эта вложенная эталонная страница будет включать только дополнительные сведения и ссылки, относящиеся к страницам администрирования, и не придется повторять разметку, уже определенную в `Site.master`.

Первым параметром является наименьший терпима. Вся точка использования главных страниц заключается в том, чтобы отказаться от необходимости вручную копировать и вставлять общую разметку на новые страницы ASP.NET. Второй вариант является приемлемым, но делает приложение менее обслуживаемым, так как в нем настраиваются основные страницы с разметкой, которая может отображаться только в момент времени и требует от разработчиков редактирования главной страницы для обхода этой разметки и необходимости помнить, когда, в точности, определенная разметка отображается и скрыта. Этот подход будет менее тенабле в качестве настроек из большего числа веб-страниц, необходимых для размещения этой отдельной главной страницы.

Третий вариант устраняет проблемы ненужных и сложных задач, выводит второй вариант. Однако при выборе трех основных недостатков необходимо скопировать и вставить общий макет из `Site.master` на новую главную страницу администрирования. Если позже мы решили изменить макет в масштабе всего сайта, нужно не забыть изменить его в двух местах.

Четвертый вариант, вложенные главные страницы, дают нам лучшее из второго и третьего вариантов. Сведения о макете для всего сайта хранятся в одном файле — главной странице верхнего уровня, в то время как содержимое, относящееся к конкретным регионам, разделяется на разные файлы.

В этом учебнике начинается создание и использование простой вложенной главной страницы. Мы создадим новую главную страницу верхнего уровня, две вложенные главные страницы и две страницы содержимого. Начиная с «Использование вложенной главной страницы для администрирования», мы рассмотрим обновление существующей архитектуры главной страницы, чтобы включить использование вложенных главных страниц. В частности, мы создаем вложенную главную страницу и используем ее для включения дополнительного пользовательского содержимого для страниц содержимого в папке `~/Admin`.

## <a name="step-1-creating-a-simple-top-level-master-page"></a>Шаг 1. Создание простой главной страницы верхнего уровня

Создание вложенной главной страницы на основе одной из существующих главных страниц и последующее обновление существующей страницы содержимого для использования этой новой вложенной главной странице, а не главной страницы верхнего уровня, усложняется, так как существующие страницы содержимого уже предполагают определенные Элементы управления ContentPlaceHolder, определенные на главной странице верхнего уровня. Поэтому вложенная эталонная страница также должна содержать те же элементы управления ContentPlaceHolder с теми же именами. Кроме того, в нашем конкретном демонстрационном приложении есть две главные страницы (`Site.master` и `Alternate.master`), которые динамически назначаются странице содержимого на основе предпочтений пользователя, которые дополнительно добавляются к этой сложности. Мы рассмотрим обновление существующего приложения для использования вложенных главных страниц далее в этом руководстве, но давайте сначала рассмотрим простой пример вложенных главных страниц.

Создайте новую папку с именем `NestedMasterPages`, а затем добавьте в нее новый файл главной страницы с именем `Simple.master`. (На рисунке 1 показан снимок экрана обозреватель решений после добавления этой папки и файла.) Перетащите `AlternateStyles.css` файл таблицы стилей из обозреватель решений в конструктор. В результате элемент `<link>` добавляется в файл таблицы стилей в элементе `<head>`, после чего разметка элемента `<head>` главной страницы должна выглядеть следующим образом:

[!code-aspx[Main](nested-master-pages-vb/samples/sample1.aspx)]

Затем добавьте следующую разметку в веб-форму `Simple.master`:

[!code-aspx[Main](nested-master-pages-vb/samples/sample2.aspx)]

Эта разметка отображает ссылку "вложенные главные страницы (простые)" в верхней части страницы в виде большого белого шрифта на фоне ВМФ. Под заголовком `MainContent` ContentPlaceHolder. На рис. 1 показана Главная страница `Simple.master` при загрузке в конструкторе Visual Studio.

[![вложенная эталонная страница определяет содержимое, относящееся к страницам в разделе "Администрирование"](nested-master-pages-vb/_static/image2.png)](nested-master-pages-vb/_static/image1.png)

**Рис. 01**. вложенная эталонная страница определяет содержимое, относящееся к страницам в разделе "Администрирование" ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image3.png))

## <a name="step-2-creating-a-simple-nested-master-page"></a>Шаг 2. Создание простой вложенной главной страницы

`Simple.master` содержит два элемента управления ContentPlaceHolder: `MainContent` ContentPlaceHolder, добавленный в веб-форму вместе с `head` ContentPlaceHolder в элементе `<head>`. Если бы нам пришлось создать страницу содержимого и привязать ее к `Simple.master` страница содержимого будет иметь два элемента управления содержимым, ссылающихся на два элементов управления ContentPlaceHolder. Аналогичным образом, если создать вложенную главную страницу и привязать ее к `Simple.master` то вложенная эталонная страница будет иметь два элемента управления содержимым.

Добавим новую вложенную главную страницу в папку `NestedMasterPages` с именем `SimpleNested.master`. Щелкните правой кнопкой мыши папку `NestedMasterPages` и выберите команду Добавить новый элемент. Откроется диалоговое окно Добавление нового элемента, показанное на рис. 2. Выберите тип шаблона шаблон главной страницы и введите имя новой главной страницы. Чтобы указать, что новая Главная страница должна быть вложенной главной страницей, установите флажок "выбрать главную страницу".

Затем нажмите кнопку Добавить. При этом будет отображаться диалоговое окно Выбор главной страницы, отображаемое при привязке страницы содержимого к главной странице (см. рис. 3). Выберите главную страницу `Simple.master` в папке `NestedMasterPages` и нажмите кнопку ОК.

> [!NOTE]
> Если вы создали веб-сайт ASP.NET с помощью модели проекта веб-приложения вместо модели проекта веб-сайта, флажок "выбрать главную страницу" в диалоговом окне "Добавление нового элемента", показанном на рис. 2, отображаться не будет. Чтобы создать вложенную главную страницу при использовании модели проекта веб-приложения, необходимо выбрать шаблон вложенной главной страницы (вместо шаблона главной страницы). После выбора шаблона вложенной главной страницы и нажатия кнопки «Добавить» появится диалоговое окно Выбор главной страницы, показанное на рис. 3.

[![установите флажок &quot;выбрать главную страницу&quot;, чтобы добавить вложенную главную страницу.](nested-master-pages-vb/_static/image5.png)](nested-master-pages-vb/_static/image4.png)

**Рис. 02**. Установка флажка "выбрать главную страницу" для добавления вложенной главной страницы ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image6.png))

[![привязать вложенную главную страницу к простой главной странице мастера](nested-master-pages-vb/_static/image8.png)](nested-master-pages-vb/_static/image7.png)

**Рис. 03**. Привязка вложенной главной страницы к главной странице `Simple.master` ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image9.png))

Декларативная разметка вложенной главной страницы, показанная ниже, содержит два элемента управления содержимым, ссылающихся на два элемента управления ContentPlaceHolder главной страницы верхнего уровня.

[!code-aspx[Main](nested-master-pages-vb/samples/sample3.aspx)]

За исключением директивы `<%@ Master %>`, начальная декларативная разметка вложенной главной страницы идентична разметке, первоначально формируемой при привязке страницы содержимого к той же главной странице верхнего уровня. Как и директива `<%@ Page %>` страницы содержимого, директива `<%@ Master %>` здесь включает атрибут `MasterPageFile`, указывающий родительскую главную страницу вложенной главной страницы. Основное различие между вложенной главной страницей и страницей содержимого, привязанной к одной главной странице верхнего уровня, заключается в том, что вложенная эталонная страница может включать элементы управления ContentPlaceHolder. Элементы управления ContentPlaceHolder вложенной главной страницы определяют регионы, в которых страницы содержимого могут настраивать разметку.

Обновите эту вложенную главную страницу, чтобы она отображала текст "Hello, from Симпленестед!". в элементе управления содержимым, соответствующем элементу управления `MainContent` ContentPlaceHolder.

[!code-aspx[Main](nested-master-pages-vb/samples/sample4.aspx)]

После выполнения этого добавления сохраните вложенную главную страницу, а затем добавьте новую страницу содержимого в папку `NestedMasterPages` с именем `Default.aspx`и привяжите ее к главной странице `SimpleNested.master`. После добавления этой страницы может быть удивлено, что она не содержит элементов управления содержимым (см. рис. 4)! Страница содержимого может обращаться только к элементов управления ContentPlaceHolder *родительской* главной страницы. `SimpleNested.master` не содержит элементов управления ContentPlaceHolder; Таким образом, любая страница содержимого, привязанная к этой главной странице, не может содержать элементы управления содержимым.

[![страница "Создание содержимого" не содержит элементов управления содержимым](nested-master-pages-vb/_static/image11.png)](nested-master-pages-vb/_static/image10.png)

**Рис. 04**. страница "новое содержимое" не содержит элементов управления содержимым ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image12.png))

Нам нужно обновить вложенную главную страницу (`SimpleNested.master`), чтобы включить элементы управления ContentPlaceHolder. Обычно необходимо, чтобы вложенные главные страницы включали ContentPlaceHolder для каждого элемента ContentPlaceHolder, определенного родительской главной страницей, тем самым позволяя дочерней главной странице или странице содержимого работать с любым элементом ContentPlaceHolder главной страницы верхнего уровня. элементы управления.

Обновите главную страницу `SimpleNested.master`, чтобы включить ContentPlaceHolder в два элемента управления содержимым. Присвойте элементам управления ContentPlaceHolder имя, совпадающее с именем элемента управления ContentPlaceHolder, на которое ссылается элемент управления содержимым. То есть добавьте элемент управления ContentPlaceHolder с именем `MainContent` в элемент управления содержимым в `SimpleNested.master`, который ссылается на `MainContent` ContentPlaceHolder в `Simple.master`. Сделайте то же самое в элементе управления содержимым, который ссылается на `head` ContentPlaceHolder.

> [!NOTE]
> Хотя я рекомендую назвать элементы управления ContentPlaceHolder во вложенной главной странице так же, как элементов управления ContentPlaceHolder на главной странице верхнего уровня, это имя не является обязательным. Можно присвоить элементам управления ContentPlaceHolder во вложенной главной странице любое имя. Однако я могу легко запомнить, что элементов управления ContentPlaceHolder соответствует каким областям страницы, если Главная страница верхнего уровня и вложенные главные страницы используют одни и те же имена.

После внесения этих дополнений декларативная разметка `SimpleNested.master` главной страницы должна выглядеть следующим образом:

[!code-aspx[Main](nested-master-pages-vb/samples/sample5.aspx)]

Удалите только что созданную страницу содержимого `Default.aspx`, а затем добавьте ее повторно, привязывая ее к главной странице `SimpleNested.master`. На этот раз Visual Studio добавляет два элемента управления содержимым в `Default.aspx`, ссылаясь на элементов управления ContentPlaceHolder, которая теперь определена в `SimpleNested.master` (см. рис. 6). Добавьте текст "Привет, из default. aspx!" в элементе управления содержимым, на который указывает ссылка `MainContent`.

На рис. 5 показаны три участвующие здесь сущности — `Simple.master`, `SimpleNested.master`и `Default.aspx`, а также их связь друг с другом. Как видно на диаграмме, вложенная эталонная страница реализует элементы управления содержимым для своего родительского элемента ContentPlaceHolder. Если эти регионы должны быть доступны для страницы содержимого, вложенная Главная страница должна добавить собственные элементов управления ContentPlaceHolder к элементам управления содержимым.

[![Главная страница верхнего уровня и вложенные главные страницы определяют макет страницы содержимого](nested-master-pages-vb/_static/image14.png)](nested-master-pages-vb/_static/image13.png)

**Рис. 05**. Главная страница верхнего уровня и вложенные главные страницы определяют макет страницы содержимого ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image15.png))

Это поведение показывает, как страница содержимого или эталонная страница Компания cognizant только ее родительской главной страницы. Это поведение также обозначается конструктором Visual Studio. На рис. 6 показан конструктор для `Default.aspx`. Хотя в конструкторе ясно видно, какие регионы доступны для редактирования на странице содержимого, а какие нет, не следует определять, какие неизменяемые регионы находятся на вложенной главной странице и какие регионы находятся на главной странице верхнего уровня.

[![страница содержимого теперь включает элементы управления содержимым для элементов управления ContentPlaceHolder вложенной главной страницы.](nested-master-pages-vb/_static/image17.png)](nested-master-pages-vb/_static/image16.png)

**Рис. 6**. страница содержимого теперь включает элементы управления содержимым для элементов управления ContentPlaceHolder вложенной главной страницы ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image18.png))

## <a name="step-3-adding-a-second-simple-nested-master-page"></a>Шаг 3. Добавление второй простой вложенной главной страницы

Преимущество вложенных главных страниц более очевидно при наличии нескольких вложенных главных страниц. Чтобы продемонстрировать это преимущество, создайте еще одну вложенную главную страницу в папке `NestedMasterPages`. Назовите эту новую вложенную главную страницу `SimpleNestedAlternate.master` и привяжите ее к главной странице `Simple.master`. Добавьте элементы управления ContentPlaceHolder в два элемента управления содержимым вложенной главной страницы, как в шаге 2. Также добавьте текст "Hello, from Симпленестедалтернате!" в элементе управления содержимым, который соответствует `MainContent` ContentPlaceHolder главной страницы верхнего уровня. После внесения этих изменений декларативная разметка новой вложенной главной страницы должна выглядеть следующим образом:

[!code-aspx[Main](nested-master-pages-vb/samples/sample6.aspx)]

Создайте страницу содержимого с именем `Alternate.aspx` в папке `NestedMasterPages` и привяжите ее к `SimpleNestedAlternate.master` вложенной главной странице. Добавьте текст "Привет, из альтернативного!" в элементе управления содержимым, соответствующем `MainContent`. На рис. 7 показано, `Alternate.aspx` при просмотре в конструкторе Visual Studio.

[![альтернативный aspx-элемент привязан к главной странице Симпленестедалтернате. master](nested-master-pages-vb/_static/image20.png)](nested-master-pages-vb/_static/image19.png)

**Рис. 07**. `Alternate.aspx` привязан к главной странице `SimpleNestedAlternate.master` ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image21.png))

Сравните конструктор на рис. 7 с конструктором на рис. 6. Обе страницы содержимого имеют одинаковый макет, определенный на главной странице верхнего уровня (`Simple.master`), а именно, заголовок «учебник по вложенным главным страницам (простой)». Однако в их родительских главных страницах определено отдельное содержимое — текст «Hello, from Симпленестед!». на рис. 6 и «Hello, from Симпленестедалтернате!» на рис. 7. Разумеется, эти различия являются тривиальными, но можно расширить этот пример, чтобы включить более значимые различия. Например, страница `SimpleNested.master` может включать меню с параметрами, относящимися к его страницам содержимого, тогда как `SimpleNestedAlternate.master` может содержать сведения, относящиеся к страницам содержимого, которые привязаны к нему.

Теперь представьте, что нам нужно внести изменения в макет сайта с перераспределением. Например, представьте, что нам нужно добавить список общих ссылок на все страницы содержимого. Для этого мы обновляем главную страницу верхнего уровня `Simple.master`. Все изменения немедленно отражаются во вложенных главных страницах и по расширениям, на страницах содержимого.

Чтобы продемонстрировать простоту, с которой можно изменить макет сайта с перераспределением, откройте `Simple.master` главную страницу и добавьте следующую разметку между `topContent`ными и `mainContent` `<div>`ными элементами:

[!code-aspx[Main](nested-master-pages-vb/samples/sample7.aspx)]

Это приводит к добавлению двух ссылок в верхнюю часть каждой страницы, которая привязывается к `Simple.master`, `SimpleNested.master`или `SimpleNestedAlternate.master`. Эти изменения немедленно применяются ко всем вложенным главным страницам и страницам содержимого. На рис. 8 показано, `Alternate.aspx` при просмотре в браузере. Обратите внимание на добавление ссылок в верхней части страницы (по сравнению с рис. 7).

[![, измененные на главную страницу верхнего уровня, немедленно отражаются во вложенных главных страницах и их страницах содержимого.](nested-master-pages-vb/_static/image23.png)](nested-master-pages-vb/_static/image22.png)

**Рис. 08**. Изменение главной страницы верхнего уровня немедленно отражается во вложенных главных страницах и их страницах содержимого ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image24.png))

## <a name="using-a-nested-master-page-for-the-administration-section"></a>Использование вложенной главной страницы для раздела "Администрирование"

На этом этапе мы рассмотрели преимущества вложенных главных страниц и увидели, как их создавать и использовать в приложении ASP.NET. В примерах, описанных в шагах 1, 2 и 3, участвует создание главной страницы верхнего уровня, новые вложенные главные страницы и новые страницы содержимого. Что насчет добавления новой вложенной главной страницы на веб-сайт с существующей главной страницей верхнего уровня и страницами содержимого?

Интеграция вложенной главной страницы в существующий веб-сайт и связывание ее с существующими страницами содержимого требует немного больше усилий, чем начиная с нуля. В шагах 4, 5, 6 и 7 рассматриваются эти проблемы, когда мы дополним демонстрационное приложение, включив в него новую вложенную главную страницу с именем `AdminNested.master`, которая содержит инструкции для администратора и используется страницами ASP.NET в папке `~/Admin`.

Интеграция вложенной главной страницы в наше демонстрационное приложение приводит к следующим недостаткам:

- Существующие страницы содержимого в папке `~/Admin` имеют определенные ожидания на главной странице. Для начала они хотят, чтобы были представлены определенные элементы управления ContentPlaceHolder. Кроме того, страницы `~/Admin/AddProduct.aspx` и `~/Admin/Products.aspx` вызывают открытый метод `RefreshRecentProductsGrid` главной страницы, устанавливают его свойство `GridMessageText` или имеют обработчик событий для его `PricesDoubled` события. Следовательно, наша вложенная Главная страница должна предоставлять те же элементов управления ContentPlaceHolder и открытые члены.
- В предыдущем учебном курсе мы улучшили класс `BasePage` для динамического задания свойства `MasterPageFile` объекта `Page` на основе переменной сеанса. Поддержка динамических главных страниц при использовании вложенных главных страниц

Эти две проблемы появятся при создании вложенной главной страницы и использовании ее из существующих страниц содержимого. Мы будем исследовать и сурмаунт эти проблемы по мере их возникновения.

## <a name="step-4-creating-the-nested-master-page"></a>Шаг 4. Создание вложенной главной страницы

Первая задача — создать вложенную главную страницу, которая будет использоваться страницами в разделе Администрирование. Как было показано на шаге 2, при добавлении новой вложенной главной страницы необходимо указать родительскую главную страницу вложенной главной страницы. Но у нас есть две главные страницы верхнего уровня: `Site.master` и `Alternate.master`. Вспомним, что мы создали `Alternate.master` в предыдущем руководстве и написали код в `BasePage`ном классе, который задает свойство `MasterPageFile` объекта `Page` во время выполнения равным `Site.master` или `Alternate.master` в зависимости от значения переменной сеанса `MyMasterPage`.

Как настроить вложенную главную страницу так, чтобы она использовала соответствующую главную страницу верхнего уровня? У нас есть два варианта:

- Создайте две вложенные главные страницы, `AdminNestedSite.master` и `AdminNestedAlternate.master`и привяжите их к главным страницам верхнего уровня `Site.master` и `Alternate.master`соответственно. В `BasePage`необходимо установить `MasterPageFile` объекта `Page` на соответствующую вложенную главную страницу.
- Создание одной вложенной главной страницы и использование страниц содержимого этой конкретной главной страницей. Затем во время выполнения нам нужно было бы задать свойство `MasterPageFile` вложенной главной страницы соответствующей главной странице верхнего уровня во время выполнения. (Как вы, возможно, поняли, на главной странице также имеется свойство `MasterPageFile`.)

Давайте будем использовать второй вариант. Создайте один вложенный файл главной страницы в папке `~/Admin` с именем `AdminNested.master`. Так как `Site.master` и `Alternate.master` имеют одинаковый набор элементов управления ContentPlaceHolder, не имеет значения, к какой главной странице она привязана, хотя я рекомендую привязать его к `Site.master` для обеспечения согласованности.

[![добавить вложенную главную страницу в папку ~/admin.](nested-master-pages-vb/_static/image26.png)](nested-master-pages-vb/_static/image25.png)

**Рис. 09**. Добавление вложенной главной страницы в папку `~/Admin`. ([Щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image27.png))

Так как вложенная эталонная страница привязана к главной странице с четырьмя элементами управления ContentPlaceHolder, Visual Studio добавляет четыре элемента управления содержимым в исходную разметку файла вложенной главной страницы. Как и в шагах 2 и 3, добавьте элемент управления ContentPlaceHolder в каждый элемент управления содержимым, присваивая ему то же имя, что и элемент управления ContentPlaceHolder главной страницы верхнего уровня. Также добавьте следующую разметку в элемент управления содержимым, соответствующий `MainContent` ContentPlaceHolder:

[!code-html[Main](nested-master-pages-vb/samples/sample8.html)]

Затем определите класс `instructions` CSS в файлах `Styles.css` и `AlternateStyles.css` CSS. Следующие правила CSS приводят к тому, что элементы HTML, отмеченные классом `instructions`, отображаются с светло-желтым цветом фона и черной сплошной границей:

[!code-css[Main](nested-master-pages-vb/samples/sample9.css)]

Поскольку эта разметка была добавлена на вложенную главную страницу, она будет отображаться только на тех страницах, которые используют эту вложенную главную страницу (а именно страницы в разделе Администрирование).

После внесения этих дополнений в вложенную главную страницу ее декларативная разметка должна выглядеть следующим образом:

[!code-aspx[Main](nested-master-pages-vb/samples/sample10.aspx)]

Обратите внимание, что каждый элемент управления содержимым имеет элемент управления ContentPlaceHolder и свойствам элемента управления ContentPlaceHolder ' `ID` присваиваются те же значения, что и соответствующие элементы управления ContentPlaceHolder на главной странице верхнего уровня. Более того, разметка, относящаяся к разделу администрирования, отображается в `MainContent` ContentPlaceHolder.

На рис. 10 показана `AdminNested.master` вложенная Главная страница при просмотре в конструкторе Visual Studio. Вы можете увидеть инструкции в желтом поле в верхней части `MainContent` элемента управления содержимым.

[![вложенная эталонная страница расширяет главную страницу верхнего уровня, добавляя инструкции для администратора.](nested-master-pages-vb/_static/image29.png)](nested-master-pages-vb/_static/image28.png)

**Рис. 10**. вложенная эталонная страница расширяет главную страницу верхнего уровня, добавляя инструкции для администратора. ([Щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image30.png))

## <a name="step-5-updating-the-existing-content-pages-to-use-the-new-nested-master-page"></a>Шаг 5. обновление существующих страниц содержимого для использования новой вложенной главной страницы

В любой момент, когда мы добавим новую страницу содержимого в раздел Администрирование, необходимо привязать ее к только что созданной главной странице `AdminNested.master`. Но как насчет существующих страниц содержимого? В настоящее время все страницы содержимого на сайте являются производными от класса `BasePage`, который программно задает главную страницу страницы содержимого во время выполнения. Это не то, что нужно для страниц содержимого в разделе Администрирование. Вместо этого мы хотим, чтобы эти страницы содержимого всегда использовали страницу `AdminNested.master`. Для выбора правой страницы содержимого верхнего уровня во время выполнения будет использоваться вложенная эталонная страница.

Чтобы лучше добиться такого поведения, создайте новый пользовательский класс базовой страницы с именем `AdminBasePage`, который расширяет класс `BasePage`. `AdminBasePage` может переопределить `SetMasterPageFile` и задать для `MasterPageFile` `Page` объекта жестко заданное значение "~/админ/админнестед.Мастер". Таким образом, любая страница, производная от `AdminBasePage` будет использовать `AdminNested.master`, в то время как для любой страницы, производной от `BasePage`, ее свойство `MasterPageFile` будет динамически задано как "~/Сите.Мастер" или "~/Алтернате.Мастер" на основе значения переменной сеанса `MyMasterPage`.

Начните с добавления нового файла класса в папку `App_Code` с именем `AdminBasePage.vb`. `AdminBasePage` расширить `BasePage`, а затем переопределить метод `SetMasterPageFile`. В этом методе присвойте `MasterPageFile` значение "~/админ/админнестед.Мастер". После внесения этих изменений файл класса должен выглядеть следующим образом:

[!code-vb[Main](nested-master-pages-vb/samples/sample11.vb)]

Теперь необходимо, чтобы существующие страницы содержимого в разделе "Администрирование" были производными от `AdminBasePage` вместо `BasePage`. Перейдите к файлу класса кода программной части для каждой страницы содержимого в папке `~/Admin` и внесите это изменение. Например, в `~/Admin/Default.aspx` вы измените объявление класса кода программной части из:

[!code-vb[Main](nested-master-pages-vb/samples/sample12.vb)]

До.

[!code-vb[Main](nested-master-pages-vb/samples/sample13.vb)]

На рис. 11 показано, как Главная страница верхнего уровня (`Site.master` или `Alternate.master`), вложенная Главная страница (`AdminNested.master`) и страницы содержимого раздела Администрирование связаны друг с другом.

[![вложенная эталонная страница определяет содержимое, относящееся к страницам в разделе "Администрирование"](nested-master-pages-vb/_static/image32.png)](nested-master-pages-vb/_static/image31.png)

**Рис. 11**. вложенная эталонная страница определяет содержимое, относящееся к страницам в разделе "Администрирование" ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image33.png))

## <a name="step-6-mirroring-the-master-pages-public-methods-and-properties"></a>Шаг 6. зеркальное отображение открытых методов и свойств главной страницы

Помните, что страницы `~/Admin/AddProduct.aspx` и `~/Admin/Products.aspx` взаимодействуют программно с главной страницей: `~/Admin/AddProduct.aspx` вызывает открытый метод `RefreshRecentProductsGrid` главной страницы и задает его свойство `GridMessageText`; `~/Admin/Products.aspx` имеет обработчик событий для события `PricesDoubled`. В предыдущем учебном курсе мы создали класс `MustInherit` `BaseMasterPage`, который определил эти открытые члены.

На страницах `~/Admin/AddProduct.aspx` и `~/Admin/Products.aspx` предполагается, что их Главная страница является производной от класса `BaseMasterPage`. Однако страница `AdminNested.master`, в настоящее время, расширяет класс `System.Web.UI.MasterPage`. В результате при посещении `~/Admin/Products.aspx` создается `InvalidCastException` с сообщением: "не удалось привести объект типа" ASP. admin\_админнестед\_Master "к типу" Басемастерпаже ".

Чтобы устранить эту проблему, необходимо расширить `BaseMasterPage`класса кода программной части `AdminNested.master`. Обновите объявление класса кода программной части вложенной главной страницы из:

[!code-vb[Main](nested-master-pages-vb/samples/sample14.vb)]

До.

[!code-vb[Main](nested-master-pages-vb/samples/sample15.vb)]

Мы еще не сделали этого. Необходимо переопределить элементы, помеченные как `MustOverride`, а именно `RefreshRecentProductsGrid` и `GridMessageText`. Эти члены используются главными страницами верхнего уровня для обновления своих пользовательских интерфейсов. (На самом деле, только Главная страница `Site.master` использует эти методы, хотя обе главные страницы верхнего уровня реализуют эти методы, так как оба расширения `BaseMasterPage`.)

Хотя нам нужно реализовать эти члены в `AdminNested.master`, все эти реализации должны просто вызвать тот же элемент на главной странице верхнего уровня, который используется вложенной главной страницей. Например, когда страница содержимого в разделе Администрирование вызывает метод `RefreshRecentProductsGrid` для вложенной главной страницы, вся вложенная Главная страница должна, в свою очередь, вызывать метод `Site.master` или `Alternate.master``RefreshRecentProductsGrid`.

Чтобы добиться этого, начните с добавления следующей директивы `@MasterType` в начало `AdminNested.master`:

[!code-aspx[Main](nested-master-pages-vb/samples/sample16.aspx)]

Помните, что директива `@MasterType` добавляет строго типизированное свойство в класс кода программной части с именем `Master`. Затем переопределите `RefreshRecentProductsGrid` и `GridMessageText` члены и просто делегируйте вызов соответствующему методу `Master`:

[!code-vb[Main](nested-master-pages-vb/samples/sample17.vb)]

Используя этот код, вы сможете посетить и использовать страницы содержимого в разделе Администрирование. На рис. 12 показана страница `~/Admin/Products.aspx` при просмотре в браузере. Как видите, страница содержит окно инструкции по администрированию, которое определено во вложенной главной странице.

[![страниц содержимого в разделе "Администрирование" включает инструкции в верхней части каждой страницы.](nested-master-pages-vb/_static/image35.png)](nested-master-pages-vb/_static/image34.png)

**Рис. 12**. страницы содержимого в разделе "Администрирование" содержат инструкции в верхней части каждой страницы ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image36.png))

## <a name="step-7-using-the-appropriate-top-level-master-page-at-runtime"></a>Шаг 7. использование соответствующей главной страницы верхнего уровня во время выполнения

Хотя все страницы содержимого в разделе Администрирование полностью работоспособны, все они используют одну главную страницу верхнего уровня и игнорируют главную страницу, выбранную пользователем на `ChooseMasterPage.aspx`. Это происходит из-за того, что вложенная эталонная страница имеет свойство `MasterPageFile` статически установлено в `Site.master` в своей директиве `<%@ Master %>`.

Чтобы использовать главную страницу верхнего уровня, выбранную конечным пользователем, необходимо задать для свойства `MasterPageFile` `AdminNested.master`значение в переменной сеанса `MyMasterPage`. Так как мы устанавливаем свойства страниц содержимого `MasterPageFile` в `BasePage`, можно подумать, что мы бы настроили свойство `MasterPageFile` вложенной главной страницы в `BaseMasterPage` или в классе кода программной части `AdminNested.master`. Однако это не сработает, поскольку необходимо задать свойство `MasterPageFile` в конце этапа предварительной инициализации. Самое раннее время, которое мы можем программно коснуться в жизненном цикле страницы с главной страницы, — этап init (который выполняется после этапа предварительной инициализации).

Поэтому необходимо задать свойство `MasterPageFile` для вложенной главной страницы на страницах содержимого. Только страницы содержимого, использующие главную страницу `AdminNested.master`, являются производными от `AdminBasePage`. Поэтому эту логику можно разместить там. На шаге 5 мы переопределили метод `SetMasterPageFile`, установив для свойства `MasterPageFile` объекта страницы значение "~/админ/админнестед.Мастер". Обновите `SetMasterPageFile`, чтобы задать для свойства `MasterPageFile` главной страницы результат, хранящийся в сеансе:

[!code-vb[Main](nested-master-pages-vb/samples/sample18.vb)]

Метод `GetMasterPageFileFromSession`, добавленный в класс `BasePage` в предыдущем руководстве, возвращает соответствующий путь к файлу главной страницы на основе значения переменной сеанса.

После этого изменения выбор главной страницы пользователя переносится в раздел Администрирование. На рис. 13 показана та же страница, что и на рис. 12, но после того, как пользователь изменил выбор главной страницы на `Alternate.master`.

[![на странице вложенного администрирования используется Главная страница верхнего уровня, выбранная пользователем.](nested-master-pages-vb/_static/image38.png)](nested-master-pages-vb/_static/image37.png)

**Рис. 13**. страница вложенного администрирования использует главную страницу верхнего уровня, выбранную пользователем ([щелкните, чтобы просмотреть изображение с полным размером](nested-master-pages-vb/_static/image39.png))

## <a name="summary"></a>Сводка

Подобно тому, как страницы содержимого могут быть привязаны к главной странице, можно создавать вложенные главные страницы, применяя к родительской главной странице привязку дочерней главной страницы. Дочерняя главная страница может определять элементы управления содержимым для каждого из его родительских элементов управления ContentPlaceHolder. Затем он может добавить собственные элементы управления ContentPlaceHolder (а также другую разметку) к этим элементам управления содержимым. Вложенные главные страницы весьма полезны в больших веб-приложениях, где все страницы совместно используют внешний вид, но некоторые разделы узла нуждаются в уникальных настройках.

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Вложенные главные страницы ASP.NET](https://msdn.microsoft.com/library/x2b3ktt7.aspx)
- [Советы по вложенным главным страницам и времени разработки VS 2005](https://weblogs.asp.net/scottgu/archive/2005/11/11/430382.aspx)
- [Поддержка вложенных главных страниц VS 2008](https://weblogs.asp.net/scottgu/archive/2007/07/09/vs-2008-nested-master-page-support.aspx)

### <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 3,5 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672329972/4guysfromrollaco). Скотт можно получить по адресу [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com) или через свой блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Хотите ознакомиться с моими будущими статьями MSDN? Если да, расположите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](specifying-the-master-page-programmatically-vb.md)
