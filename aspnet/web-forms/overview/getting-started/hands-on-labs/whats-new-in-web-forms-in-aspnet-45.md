---
uid: web-forms/overview/getting-started/hands-on-labs/whats-new-in-web-forms-in-aspnet-45
title: Новые возможности веб-форм в ASP.NET 4,5 | Документация Майкрософт
author: rick-anderson
description: Новая версия веб-форм ASP.NET предоставляет ряд усовершенствований, позволяющих улучшить взаимодействие с пользователем при работе с данными. В предыдущих версиях...
ms.author: riande
ms.date: 02/18/2013
ms.assetid: 0a1f88bd-97da-4ed1-86f1-605199dc75a4
msc.legacyurl: /web-forms/overview/getting-started/hands-on-labs/whats-new-in-web-forms-in-aspnet-45
msc.type: authoredcontent
ms.openlocfilehash: 301af8ed877b58624e419c04f605c41f27dbdd0c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78421926"
---
# <a name="whats-new-in-web-forms-in-aspnet-45"></a>Новые возможности веб-форм в ASP.NET 4.5

по [веб-Camp командам](https://twitter.com/webcamps)

> Новая версия веб-форм ASP.NET предоставляет ряд усовершенствований, позволяющих улучшить взаимодействие с пользователем при работе с данными.
> 
> В предыдущих версиях веб-форм при использовании привязки данных для выдачи значения члена объекта использовались выражения привязки данных Bind () или eval (). В новой версии ASP.NET вы можете объявить, к какому типу данных будет привязан элемент управления, используя новое свойство ItemType. Задание этого свойства позволит использовать строго типизированную переменную для получения полных преимуществ интерфейса разработки Visual Studio, таких как IntelliSense, Навигация по элементам и проверка во время компиляции.
> 
> С помощью элементов управления с привязкой к данным теперь можно также указать собственные пользовательские методы для выбора, обновления, удаления и вставки данных, упрощая взаимодействие между элементами управления страницы и логикой приложения. Кроме того, в ASP.NET добавлены возможности привязки модели, что означает возможность сопоставлять данные из страницы непосредственно с параметрами типа метода.
> 
> Проверка вводимых пользователем данных должна быть также проще благодаря последней версии веб-форм. Теперь можно снабдить классы модели атрибутами проверки из пространства имен **System. ComponentModel. аннотации** и запросить, что все элементы управления сайта проверяют введенные пользователем данные с помощью этих сведений. Проверка на стороне клиента в веб-формах теперь интегрирована с jQuery, предоставляя программный код на стороне клиента и ненавязчивые функции JavaScript.
> 
> В области проверки запросов были внесены улучшения, упрощающие Выборочное отключение проверки запросов для конкретных частей приложения или чтение недействительных данных запроса.
> 
> Некоторые усовершенствования были внесены в серверные элементы управления Web Forms, чтобы воспользоваться преимуществами новых возможностей HTML5:
> 
> - Свойство TextMode элемента управления TextBox Обновлено для поддержки новых типов входных данных HTML5, таких как электронная почта, DateTime и т. д.
> - Элемент управления FileUpload теперь поддерживает несколько отправок файлов из браузеров, поддерживающих эту функцию HTML5.
> - Проверяющие элементы управления теперь поддерживают проверку элементов ввода HTML5.
> - Новые элементы HTML5 с атрибутами, представляющими URL-адрес, теперь поддерживают&quot;сервера runat =&quot;. В результате вы можете использовать соглашения ASP.NET в путях URL-адресов, например оператор ~ для представления корня приложения (например, &lt;Video runat =&quot;Server&quot; src =&quot;~/Мивидео.ВМВ&quot;&gt;&lt;/Video&gt;).
> - Элемент управления UpdatePanel зафиксирован для поддержки отправки полей ввода HTML5.
> 
> На официальном портале ASP.NET можно найти дополнительные примеры новых функций в ASP.NET WebForms 4,5: новые возможности [в ASP.NET 4,5 и Visual Studio 2012](../../../../whitepapers/whats-new-in-aspnet-45-and-visual-studio-2012.md#_Toc318097385)
> 
> Все примеры кода и фрагментов включены в комплект обучающих курсов Web Camp, доступный по адресу [https://go.microsoft.com/fwlink/?LinkID=248297&clcid=0x409](https://go.microsoft.com/fwlink/?LinkID=248297&clcid=0x409).

<a id="Objectives"></a>
### <a name="objectives"></a>Цели

В этой практической лабораторной работе вы узнаете, как выполнять следующие задачи:

- Использование строго типизированных выражений привязки данных
- Использование новых функций привязки модели в веб-формах
- Использование поставщиков значений для сопоставления данных страницы с методами кода программной части
- Использование заметок к данным для проверки вводимых пользователем данных
- Воспользуйтесь преимуществами ненавязчивой клиентской проверки с jQuery в веб-формах
- Реализация детализированной проверки запросов
- Реализация асинхронной обработки страниц в веб-формах

<a id="Prerequisites"></a>
### <a name="prerequisites"></a>предварительные требования

Для выполнения этой лабораторной работы необходимо иметь следующие элементы:

- [Microsoft Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/eng/products/visual-studio-express-for-web) или старше (см. [приложение а](#AppendixA) для получения инструкций по его установке).

<a id="Setup"></a>
### <a name="setup"></a>Настройка

**Установка фрагментов кода**

Для удобства большая часть кода, который вы будете управлять в этой лаборатории, доступна в виде фрагментов кода Visual Studio. Чтобы установить фрагменты кода, запустите файл **.\саурце\сетуп\кодесниппетс.ВСИ** .

Если вы не знакомы с фрагментами кода Visual Studio Code и хотите узнать, как их использовать, см. приложение в этом документе &quot;[приложении C: использование фрагментов кода](#AppendixC)&quot;.

<a id="Exercises"></a>
## <a name="exercises"></a>Полнят

Эта практическая лабораторная работа включает в себя следующие упражнения:

1. [Упражнение 1. привязка модели в веб-формах ASP.NET](#Exercise1)
2. [Упражнение 2. Проверка данных](#Exercise2)
3. [Упражнение 3. асинхронная обработка страниц в веб-формах ASP.NET](#Exercise3)

> [!NOTE]
> Каждое упражнение сопровождается **конечной** папкой, содержащей итоговое решение, которое следует получить после завершения упражнений. Это решение можно использовать в качестве инструкции, если вам нужна дополнительная помощь по работе с упражнениями.

Предполагаемое время выполнения этой лабораторной работы: **60 минут**.

<a id="Exercise1"></a>

<a id="Exercise_1_Model_Binding_in_ASPNET_Web_Forms"></a>
### <a name="exercise-1-model-binding-in-aspnet-web-forms"></a>Упражнение 1. привязка модели в веб-формах ASP.NET

Новая версия веб-форм ASP.NET предоставляет ряд улучшений, которые посвящены улучшению работы с данными. В рамках этого упражнения вы узнаете о строго типизированных элементах управления данными и привязке модели.

<a id="Task_1_-_Using_Strongly-Typed_Data-Bindings"></a>
#### <a name="task-1---using-strongly-typed-data-bindings"></a>Задача 1. Использование строго типизированных привязок данных

В этой задаче вы обнаружите новые строго типизированные привязки, доступные в ASP.NET 4,5.

1. Откройте **Начальное** решение, расположенное по адресу **Source/EX1-моделбиндинг/Begin/** Folder.

   1. Перед продолжением необходимо загрузить некоторые недостающие пакеты NuGet. Для этого в меню **проект** выберите пункт **Управление пакетами NuGet**.
   2. В диалоговом окне **Управление пакетами NuGet** нажмите кнопку **восстановить** , чтобы скачать недостающие пакеты.
   3. Наконец, создайте решение, щелкнув **build** | **Build Solution**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является то, что вам не нужно поставлять все библиотеки в проекте, уменьшая размер проекта. С помощью средств управления питанием NuGet, указав версии пакетов в файле Packages. config, вы сможете скачать все необходимые библиотеки при первом запуске проекта. Именно поэтому после открытия существующего решения из этой лабораторной работы потребуется выполнить следующие действия.
2. Откройте страницу **Customers. aspx** . Поместите Ненумерованный список в основной элемент управления и включите элемент управления Repeater внутри для перечисления каждого клиента. Задайте для имени повторителя значение **кустомерсрепеатер** , как показано в следующем коде.

    В предыдущих версиях веб-форм при использовании привязки данных для выдачи значения элемента в объекте, к которому выполняется привязка данных, следует использовать выражение привязки данных вместе с вызовом метода eval, передав имя члена в виде строки.

    Во время выполнения эти вызовы метода eval будут использовать отражение для объекта, привязанного к текущему объекту, для считывания значения элемента с заданным именем и отображения результата в HTML. Такой подход упрощает привязку данных к произвольным, нефигурным данным.

    К сожалению, многие из замечательных функций времени разработки в Visual Studio теряются, включая IntelliSense для имен членов, поддержку навигации (например, переход к определению) и проверку во время компиляции.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample1.aspx)]
3. Откройте файл **Customers.aspx.CS** .
4. Добавьте следующую инструкцию using.

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample2.cs)]
5. В методе **загрузки страницы\_** добавьте код для заполнения элемента Repeater списком клиентов.

    (Фрагмент кода- *Web Forms Lab-Ex01-BIND Customer Data Source*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample3.cs)]

    Решение использует EntityFramework вместе с Кодефирст для создания базы данных и доступа к ней. В следующем коде Кустомерсрепеатер привязан к материализованным запросам, которые возвращают всех клиентов из базы данных.
6. Нажмите клавишу **F5** , чтобы запустить решение, и перейдите на страницу **Клиенты** , чтобы увидеть элемент Repeater в действии. Так как решение использует Кодефирст, база данных будет создана и заполнена в локальном экземпляре SQL Express при запуске приложения.

    ![Перечисление клиентов с помощью элемента Repeater](whats-new-in-web-forms-in-aspnet-45/_static/image1.png "Перечисление клиентов с помощью элемента Repeater")

    *Перечисление клиентов с помощью элемента Repeater*

    > [!NOTE]
    > В Visual Studio 2012 IIS Express является сервером веб-разработки по умолчанию.
7. Закройте браузер и вернитесь в Visual Studio.
8. Теперь замените реализацию на использование строго типизированных привязок. Откройте страницу **Customers. aspx** и используйте новый атрибут **ItemType** в элементе Repeater, чтобы задать тип **клиента** в качестве типа привязки.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample4.aspx)]

    Свойство ItemType позволяет объявить, к какому типу данных будет привязан элемент управления, и использовать строго типизированную привязку внутри элемента управления с привязкой к данным.
9. Замените содержимое ItemTemplate следующим кодом.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample5.aspx)]

    Недостатком описанных выше подходов является то, что вызовы методов Eval () и Bind () имеют позднюю границу. Это означает, что вы передаете строки для представления имен свойств. Это означает, что вы не получаете IntelliSense для имен членов, поддерживает навигацию по коду (например, Go To Definition), а также поддержку проверки во время компиляции.

    Установка свойства ItemType приводит к созданию двух новых типизированных переменных в области выражений привязки данных: **Item** и **биндитем**. Эти строго типизированные переменные можно использовать в выражениях привязки данных и получить все преимущества разработки Visual Studio.

    &quot; **:** &quot;, используемое в выражении, автоматически кодирует выходные данные в формате HTML во избежание проблем безопасности (например, атак с использованием межузловых сценариев). Эта нотация была доступна, начиная с .NET 4 для написания ответа, но теперь также доступна в выражениях привязки данных.

    > [!NOTE]
    > Элемент item работает для односторонней привязки. Если вы хотите выполнить двустороннюю привязку, используйте элемент **биндитем** .

    ![Поддержка IntelliSense в строго типизированной привязке](whats-new-in-web-forms-in-aspnet-45/_static/image2.png "Поддержка IntelliSense в строго типизированной привязке")

    *Поддержка IntelliSense в строго типизированной привязке*
10. Нажмите клавишу **F5** , чтобы запустить решение, и перейдите на страницу клиенты, чтобы убедиться, что изменения работают должным образом.

    ![Получение сведений о клиенте](whats-new-in-web-forms-in-aspnet-45/_static/image3.png "Получение сведений о клиенте")

    *Получение сведений о клиенте*
11. Закройте браузер и вернитесь в Visual Studio.

<a id="Task_2_-_Introducing_Model_Binding_in_Web_Forms"></a>
#### <a name="task-2---introducing-model-binding-in-web-forms"></a>Задача 2. Введение в привязку модели в веб-формах

В предыдущих версиях ASP.NET Web Forms, когда требуется выполнить двустороннюю привязку данных для получения и обновления данных, необходимо использовать объект источника данных. Это может быть источник данных объекта, источник данных SQL, источник данных LINQ и т. д. Однако если в сценарии требуется пользовательский код для обработки данных, необходимо использовать источник данных Object, и это привела некоторые недостатки. Например, необходимо избежать сложных типов и при необходимости обработки исключений при выполнении логики проверки.

В новой версии веб-форм ASP.NET элементы управления с привязкой к данным поддерживают привязку модели. Это означает, что можно указать методы Select, Update, INSERT и DELETE непосредственно в элементе управления с привязкой к данным, чтобы вызвать логику из файла кода программной части или из другого класса.

Чтобы узнать об этом, вы будете использовать GridView для перечисления категорий продуктов с помощью нового атрибута **SelectMethod** . Этот атрибут позволяет указать метод для получения данных GridView.

1. Откройте страницу **Products. aspx** и включите **GridView**. Настройте GridView, как показано ниже, чтобы использовать строго типизированные привязки и включить сортировку и разбиение на страницы.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample6.aspx)]
2. Используйте новый атрибут **SelectMethod** , чтобы настроить GridView для вызова метода **Categories** , чтобы выбрать данные.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample7.aspx)]
3. Откройте файл кода программной части **Products.aspx.CS** и добавьте следующие операторы using.

    (Фрагмент кода — *веб-формы Lab-Ex01-Namespaces*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample8.cs)]
4. Добавьте закрытый член в класс **Products** и назначьте новый экземпляр **продуктсконтекст**. Это свойство хранит контекст данных Entity Framework, который позволяет подключаться к базе данных.

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample9.cs)]
5. Создайте метод **Categories** для получения списка категорий с помощью LINQ. Запрос будет включать свойство **Products** , поэтому GridView может показывать количество продуктов для каждой категории. Обратите внимание, что метод возвращает Необработанный объект IQueryable, который представляет запрос, который будет выполнен позже в жизненном цикле страницы.

    (Фрагмент кода — *Web Forms Lab-Ex01-Categories*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample10.cs)]

    > [!NOTE]
    > В предыдущих версиях веб-форм ASP.NET включить сортировку и разбиение по страницам с помощью собственной логики репозитория в контексте источника данных объекта, необходимой для написания собственного кода и получения всех необходимых параметров. Теперь, поскольку методы привязки данных могут возвращать IQueryable, а это представляет собой запрос, по-прежнему выполняемый, ASP.NET может позаботиться об изменении запроса, чтобы добавить соответствующие параметры сортировки и разбиения по страницам.
6. Нажмите клавишу **F5** , чтобы начать отладку сайта, и перейдите на страницу Products (продукты). Вы должны увидеть, что GridView заполняется категориями, возвращаемыми методом Categories.

    ![Заполнение элемента GridView с помощью привязки модели](whats-new-in-web-forms-in-aspnet-45/_static/image4.png "Заполнение элемента GridView с помощью привязки модели")

    *Заполнение элемента GridView с помощью привязки модели*
7. Нажмите клавиши **SHIFT**+**F5** отключить отладку.

<a id="Task_3_-_Value_Providers_in_Model_Binding"></a>
#### <a name="task-3---value-providers-in-model-binding"></a>Задачи 3 — поставщики значений в привязке модели

Привязка модели не только позволяет указывать пользовательские методы для работы с данными непосредственно в элементе управления с привязкой к данным, но также позволяет сопоставлять данные из страницы с параметрами этих методов. В параметре метода можно использовать атрибуты поставщика значений для указания источника данных значения. Пример:

- Элементы управления на странице
- Значения строки запроса
- Просмотр данных
- Состояние сеанса
- Файлы cookie
- Опубликованные данные формы
- Состояние представления
- Также поддерживаются пользовательские поставщики значений

Если вы использовали ASP.NET MVC 4, вы увидите, что поддержка привязки модели аналогична. Действительно, эти функции были взяты из ASP.NET MVC и перемещены в сборку **System. Web** , чтобы иметь возможность использовать их в веб-формах.

В этой задаче вы обновите GridView, чтобы отфильтровать результаты по количеству продуктов для каждой категории, получив параметр фильтра с привязкой модели.

1. Вернитесь на страницу **Products. aspx** .
2. В верхней части GridView добавьте **метку** и **поле со списком** , чтобы выбрать количество продуктов для каждой категории, как показано ниже.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample11.aspx)]
3. Добавьте **емптидататемплате** в GridView для отображения сообщения, если нет категорий с выбранным количеством продуктов.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample12.aspx)]
4. Откройте код программной части **Products.aspx.CS** и добавьте следующий оператор using.

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample13.cs)]
5. Измените метод **Categories** , чтобы он получал целочисленный аргумент **минпродуктскаунт** и отфильтровать возвращаемые результаты. Для этого замените метод следующим кодом.

    (Фрагмент кода — *Web Forms Lab-Ex01-Categories 2*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample14.cs)]

    Новый атрибут **[Control]** в аргументе **минпродуктскаунт** позволит ASP.NET понять, что его значение должно быть заполнено с помощью элемента управления на странице. ASP.NET будет искать любой элемент управления, соответствующий имени аргумента (Минпродуктскаунт), и выполнить необходимое сопоставление и преобразование для заполнения параметра значением элемента управления.

    Кроме того, атрибут предоставляет перегруженный конструктор, который позволяет указать элемент управления, с которого нужно получить значение.

    > [!NOTE]
    > Одной из целей функций привязки данных является сокращение объема кода, который необходимо написать для взаимодействия со страницей. Помимо поставщика значений [Control], в параметрах метода можно использовать другие поставщики привязки моделей. Некоторые из них перечислены в статье Введение в задачу.
6. Нажмите клавишу **F5** , чтобы начать отладку сайта, и перейдите на страницу Products (продукты). В раскрывающемся списке выберите ряд продуктов и обратите внимание на то, как теперь элемент управления GridView обновляется.

    ![Фильтрация элемента управления GridView с помощью раскрывающегося списка](whats-new-in-web-forms-in-aspnet-45/_static/image5.png "Фильтрация элемента управления GridView с помощью раскрывающегося списка")

    *Фильтрация элемента управления GridView с помощью раскрывающегося списка*
7. Остановите отладку.

<a id="Task_4_-_Using_Model_Binding_for_Filtering"></a>
#### <a name="task-4---using-model-binding-for-filtering"></a>Задача 4. Использование привязки модели для фильтрации

В этой задаче будет добавлен второй дочерний элемент управления GridView для отображения продуктов в выбранной категории.

1. Откройте страницу **Products. aspx** и обновите элемент управления "категории" в GridView, чтобы автоматически создать кнопку "выбрать".

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample15.aspx)]
2. Добавьте второй элемент управления **GridView** с именем **продуктсгрид** внизу. Присвойте параметру **ItemType** значение **вебформслаб. Model. Product**, **DataKeyNames** значение **ProductID** и **SelectMethod** для **продуктов**. Задайте для аутоженератеколумнс **значение false** и добавьте столбцы для ProductID, ProductName, Description и UnitPrice.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample16.aspx)]
3. Откройте файл кода программной части **Products.aspx.CS** . Реализуйте метод **Products** для получения идентификатора категории из GridView по категории и фильтрации продуктов. Привязка модели задаст значение параметра, используя выбранную строку в **категориесгрид**. Поскольку имя аргумента и имя элемента управления не совпадают, необходимо указать имя элемента управления в поставщике контрольного значения.

    (Фрагмент кода — *Web Forms Lab-Ex01-Products*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample17.cs)]

    > [!NOTE]
    > Такой подход упрощает модульное тестирование этих методов. В контексте модульного теста, где не выполняются веб-формы, атрибут [Control] не выполняет никаких действий.
4. Откройте страницу **Products. aspx** и выберите элемент GridView. Обновите GridView продуктов, чтобы отобразить ссылку для изменения выбранного продукта.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample18.aspx)]
5. Откройте страницу кода программной части **продуктдетаилс. aspx** и замените метод **селектпродукт** следующим кодом.

    (Фрагмент кода- *Web Forms Lab-Ex01-Селектпродукт Method*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample19.cs)]

    > [!NOTE]
    > Обратите внимание, что атрибут **[QueryString]** используется для заполнения параметра метода из параметра ProductID в строке запроса.
6. Нажмите клавишу **F5** , чтобы начать отладку сайта, и перейдите на страницу Products (продукты). Выберите любую категорию в GridView и обратите внимание, что элемент управления GridView обновляется.

    ![Отображение продуктов из выбранной категории](whats-new-in-web-forms-in-aspnet-45/_static/image6.png "Отображение продуктов из выбранной категории")

    *Отображение продуктов из выбранной категории*
7. Щелкните ссылку **View (просмотреть** ) в продукте, чтобы открыть страницу продуктдетаилс. aspx.

    Обратите внимание, что страница извлекает продукт с помощью метода SelectMethod, используя параметр productId из строки запроса.

    ![Просмотр сведений о продукте](whats-new-in-web-forms-in-aspnet-45/_static/image7.png "Просмотр сведений о продукте")

    *Просмотр сведений о продукте*

    > [!NOTE]
    > Возможность ввода описания HTML будет реализована в следующем упражнении.

<a id="Task_5_-_Using_Model_Binding_for_Update_Operations"></a>
#### <a name="task-5---using-model-binding-for-update-operations"></a>Задача 5. Использование привязки модели для операций обновления

В предыдущей задаче вы использовали привязку модели в основном для выбора данных. в этой задаче будет показано, как использовать привязку модели в операциях обновления.

Вы обновите элемент управления "категории", чтобы разрешить пользователям изменять категории.

1. Откройте страницу **Products. aspx** и обновите элемент управления "категории" в GridView, чтобы автоматически создать кнопку "Изменить", и используйте новый атрибут **UpdateMethod** , чтобы указать метод **упдатекатегори** для обновления выбранного элемента.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample20.aspx)]

    Атрибут DataKeyNames в элементе GridView определяет, какие элементы уникально идентифицируют объект, привязанный к модели, и, следовательно, параметры, которые метод Update должен иметь по крайней мере получить.
2. Откройте файл кода программной части **Products.aspx.CS** и реализуйте метод **упдатекатегори** . Метод должен получить идентификатор категории для загрузки текущей категории, заполнить значения из GridView, а затем обновить категорию.

    (Фрагмент кода — *Web Forms Lab-Ex01-упдатекатегори*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample21.cs)]

    Новый метод **трюпдатемодел** в классе Page отвечает за заполнение объекта модели, используя значения из элементов управления на странице. В этом случае он заменит обновленные значения из текущей строки GridView, изменяемой в объект **Category** .

    > [!NOTE]
    > В следующем упражнении будет объяснено использование ModelState. IsValid для проверки данных, вводимых пользователем при редактировании объекта.
3. Запустите сайт и перейдите на страницу Products (продукты). Изменение категории. Введите новое имя и нажмите кнопку **Обновить** , чтобы сохранить изменения.

    ![Изменение категорий](whats-new-in-web-forms-in-aspnet-45/_static/image8.png "Изменение категорий")

    *Изменение категорий*

<a id="Exercise2"></a>

<a id="Exercise_2_Data_Validation"></a>
### <a name="exercise-2-data-validation"></a>Упражнение 2. Проверка данных

В этом упражнении вы узнаете о новых возможностях проверки данных в ASP.NET 4,5. Вы изучите новые функции ненавязчивой проверки в Web Forms. Вы будете использовать заметки к данным в классах модели приложения для проверки вводимых пользователем данных, и, наконец, вы узнаете, как включить или отключить проверку запросов для отдельных элементов управления на странице.

<a id="Task_1_-_Unobtrusive_Validation"></a>
#### <a name="task-1---unobtrusive-validation"></a>Задача 1 — ненавязчивая проверка

Формы со сложными данными, в том числе проверяющие элементы управления, обычно создают на странице слишком много кода JavaScript, что может представлять примерно 60% кода. При включении ненавязчивой проверки код HTML будет выглядеть как очиститель и аккуратная.

В этом разделе вы включите ненавязчивую проверку в ASP.NET, чтобы сравнить код HTML, формируемый обеими конфигурациями.

1. Откройте **Visual Studio 2012** и откройте **Начальное** решение, расположенное в папке **Source\Ex2-Validation\Begin** этой лабораторной работы. Кроме того, можно продолжить работу над существующим решением из предыдущего упражнения.

   1. Если вы открыли предоставленное **Начальное** решение, перед продолжением потребуется загрузить некоторые недостающие пакеты NuGet. Для этого в обозреватель решений щелкните проект **Вебформслаб** **Управление пакетами NuGet**.
   2. В диалоговом окне **Управление пакетами NuGet** нажмите кнопку **восстановить** , чтобы скачать недостающие пакеты.
   3. Наконец, создайте решение, щелкнув **build** | **Build Solution**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является то, что вам не нужно поставлять все библиотеки в проекте, уменьшая размер проекта. С помощью средств управления питанием NuGet, указав версии пакетов в файле Packages. config, вы сможете скачать все необходимые библиотеки при первом запуске проекта. Именно поэтому после открытия существующего решения из этой лабораторной работы потребуется выполнить следующие действия.
2. Нажмите клавишу **F5** , чтобы запустить веб-приложение. Перейдите на страницу клиенты и щелкните ссылку **Добавить новый клиент** .
3. Щелкните страницу браузера правой кнопкой мыши и выберите пункт **Просмотр исходного** кода, чтобы открыть код HTML, созданный приложением.

    ![Отображение страницы HTML-код](whats-new-in-web-forms-in-aspnet-45/_static/image9.png "Отображение страницы HTML-код")

    *Отображение страницы HTML-код*
4. Прокрутите исходный код страницы и обратите внимание, что ASP.NET содержит внедренный код JavaScript и проверяющие элементы управления на странице для выполнения проверок и отображения списка ошибок.

    ![Код JavaScript для проверки на странице Кустомердетаилс](whats-new-in-web-forms-in-aspnet-45/_static/image10.png "Код JavaScript для проверки на странице Кустомердетаилс")

    *Код JavaScript для проверки на странице Кустомердетаилс*
5. Закройте браузер и вернитесь в Visual Studio.
6. Теперь вы включите ненавязчивую проверку. Откройте **файл Web. config** и выберите в разделе **appSettings** ключ **ValidationSettings: унобтрусивевалидатионмоде** **.** Задайте для ключа значение **WebForms**.

    [!code-xml[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample22.xml)]

    > [!NOTE]
    > Это свойство также можно задать на &quot;**странице\_Load**&quot;, если вы хотите включить ненавязчивую проверку только для некоторых страниц.
7. Откройте **кустомердетаилс. aspx** и нажмите клавишу **F5** , чтобы запустить веб-приложение.
8. Нажмите клавишу F12, чтобы открыть инструменты для разработчиков IE. После открытия инструментов разработчика перейдите на вкладку Скрипт. в меню выберите **кустомердетаилс. aspx** и обратите внимание, что сценарии, необходимые для запуска jQuery на странице, загружены в браузер с локального сайта.

    ![Загрузка файлов JavaScript jQuery непосредственно с локального сервера IIS](whats-new-in-web-forms-in-aspnet-45/_static/image11.png "Загрузка файлов JavaScript jQuery непосредственно с локального сервера IIS")

    *Загрузка файлов JavaScript jQuery непосредственно с локального сервера IIS*
9. Закройте браузер, чтобы вернуться в Visual Studio. Снова откройте файл **site. master** и перейдите к **диспетчеру ScriptManager**. Добавьте свойство **енаблекдн** атрибута со значением **true**. Это приведет к загрузке jQuery из URL-адреса в Интернете, а не с URL-адреса локального сайта.
10. Откройте **кустомердетаилс. aspx** в Visual Studio. Нажмите клавишу F5, чтобы запустить сайт. После открытия Internet Explorer нажмите клавишу F12, чтобы открыть средства разработчика. Перейдите на вкладку **Скрипт** и просмотрите раскрывающийся список. Обратите внимание, что файлы JavaScript jQuery больше не загружаются с локального сайта, а из сети jQuery CDN.

    ![Загрузка файлов JavaScript jQuery из CDN](whats-new-in-web-forms-in-aspnet-45/_static/image12.png "Загрузка файлов JavaScript jQuery из CDN")

    *Загрузка файлов JavaScript jQuery из CDN*
11. Снова откройте исходный код HTML-страницы с помощью параметра Просмотр исходного кода в браузере. Обратите внимание, что включение ненавязчивой проверки ASP.NET заменяет вставленный код JavaScript атрибутами \*данных.

    ![Ненавязчивый код проверки](whats-new-in-web-forms-in-aspnet-45/_static/image13.png "Ненавязчивый код проверки")

    *Ненавязчивый код проверки*

    > [!NOTE]
    > В этом примере вы увидели, что сводка проверки с заметками данных была упрощена до нескольких строк HTML и JavaScript. Ранее, без ненавязчивой проверки, чем больше элементов управления проверки, тем больше размер кода проверки JavaScript будет расти.

<a id="Task_2_-_Validating_the_Model_with_Data_Annotations"></a>
#### <a name="task-2---validating-the-model-with-data-annotations"></a>Задача 2. Проверка модели с помощью заметок к данным

В ASP.NET 4,5 введена проверка заметок к данным для веб-форм. Вместо элемента управления проверки на каждом входе теперь можно определять ограничения в классах модели и использовать их во всех веб-приложениях. В этом разделе вы узнаете, как использовать заметки к данным для проверки формы нового или измененного клиента.

1. Откройте страницу **кустомердетаил. aspx** . Обратите внимание, что имя и второе имя клиента в разделах **EditItemTemplate** и **InsertItemTemplate** проверяются с помощью элементов управления RequiredFieldValidator. Каждый проверяющий элемент управления связан с определенным условием, поэтому необходимо включить столько проверяющих элементов управления, сколько проверяемые условия.
2. Добавьте заметки к данным, чтобы проверить класс клиентской модели. Откройте класс **Customer.CS** в папке **model** *и добавьте* каждое свойство, используя атрибуты аннотации данных.

    (Фрагмент кода — *Web Forms Lab-Ex02-аннотации данных*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample23.cs)]

    > [!NOTE]
    > .NET Framework 4,5 расширена существующая коллекция заметок к данным. Ниже приведены некоторые аннотации данных, которые можно использовать: [CreditCard], [Phone], [EmailAddress], [диапазон], [сравнить], [URL], [FileExtensions], [обязательный параметр], [Key], [RegularExpression].
    > 
    > Некоторые примеры использования:
    > 
    > [Key]: Specifies that an attribute is the unique identifier
    > 
    > [Range(0.4, 0.5, ErrorMessage=&quot;{Write an error message}&quot;]: Double range
    > 
    > [EmailAddress(ErrorMessage=&quot;Invalid Email&quot;), MaxLength(56)]: Two annotations in the same line.
    > 
    > Можно также определить собственные сообщения об ошибках в пределах каждого атрибута.
3. Откройте **кустомердетаилс. aspx** и удалите все рекуиредфиелдвалидаторс для полей First и Last Name в разделах в EditItemTemplate и InsertItemTemplate элемента управления FormView.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample24.aspx)]

    > [!NOTE]
    > Одним из преимуществ использования заметок к данным является то, что логика проверки не дублируется на страницах приложения. Он определяется один раз в модели и используется на всех страницах приложения, работающих с данными.
4. Откройте код программной части **кустомердетаилс. aspx** и перейдите к методу савекустомер. Этот метод вызывается при вставке нового клиента и получении параметра клиента из значений элемента управления FormView. Когда происходит сопоставление между элементами управления страницы и объектом Parameter, ASP.NET выполняет проверку модели для всех атрибутов аннотации данных и заполняет словарь ModelState с обнаруженными ошибками, если таковые имеются.

    ModelState. IsValid возвращает значение true, только если все поля в модели действительны после выполнения проверки.

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample25.cs)]
5. Добавьте элемент управления **ValidationSummary** в конце страницы кустомердетаилс, чтобы отобразить список ошибок модели.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample26.aspx)]

    **Шовмоделстатиррорс** — это новое свойство элемента управления ValidationSummary, которое имеет значение **true**, а элемент управления будет показывать ошибки из словаря ModelState. Эти ошибки поступают из проверки заметок данных.
6. Нажмите клавишу **F5** , чтобы запустить веб-приложение. Заполните форму, указав некоторые ошибочные значения, и нажмите кнопку **сохранить** , чтобы выполнить проверку. Обратите внимание на сводку ошибок внизу.

    ![Проверка с помощью заметок к данным](whats-new-in-web-forms-in-aspnet-45/_static/image14.png "Проверка с помощью заметок к данным")

    *Проверка с помощью заметок к данным*

<a id="Task_3_-_Handling_Custom_Database_Errors_with_ModelState"></a>
#### <a name="task-3---handling-custom-database-errors-with-modelstate"></a>Задача 3. Обработка ошибок пользовательской базы данных с помощью ModelState

В предыдущей версии веб-форм обработка ошибок базы данных, таких как слишком длинная строка или нарушение уникального ключа, может привести к порождению исключений в коде репозитория, а затем обработке исключений в коде программной части для вывода сообщения об ошибке. Чтобы сделать что-то относительно простое, требуется большой объем кода.

В веб-формах 4,5 объект ModelState можно использовать для просмотра ошибок на странице либо из модели, либо из базы данных согласованным образом.

В этой задаче будет добавлен код для правильной работы с исключениями базы данных и отображения соответствующего сообщения пользователю с помощью объекта ModelState.

1. Пока приложение все еще выполняется, попробуйте обновить имя категории, используя повторяющееся значение.

    ![Обновление категории с совпадающим именем](whats-new-in-web-forms-in-aspnet-45/_static/image15.png "Обновление категории с совпадающим именем")

    *Обновление категории с совпадающим именем*

    Обратите внимание, что исключение создается из-за &quot;уникального ограничения&quot; столбца **CategoryName** .

    ![Исключение для повторяющихся имен категорий](whats-new-in-web-forms-in-aspnet-45/_static/image16.png "Исключение для повторяющихся имен категорий")

    *Исключение для повторяющихся имен категорий*
2. Остановите отладку. В файле кода программной части **Products.aspx.CS** Обновите метод **упдатекатегори** для обработки исключений, создаваемых базой данных. Вызов метода SaveChanges () и Добавление ошибки в объект **ModelState** .

    Новый метод **трюпдатемодел** обновляет объект category, полученный из базы данных, с помощью данных формы, предоставленных пользователем.

    (Фрагмент кода — *Web Forms Lab-Ex02-Упдатекатегори Handle Errors*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample27.cs)]

    > [!NOTE]
    > В идеале необходимо определить причину Дбупдатиксцептион и проверить, является ли основная причина нарушением ограничения уникального ключа.
3. Откройте **Products. aspx** и добавьте элемент управления **ValidationSummary** под элементом "категории" GridView, чтобы отобразить список ошибок модели.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample28.aspx)]
4. Запустите сайт и перейдите на страницу Products (продукты). Попробуйте обновить имя категории, используя повторяющееся значение.

    Обратите внимание, что исключение обработано, и в элементе управления **ValidationSummary** появляется сообщение об ошибке.

    ![Ошибка дублирования категории](whats-new-in-web-forms-in-aspnet-45/_static/image17.png "Ошибка дублирования категории")

    *Ошибка дублирования категории*

<a id="Task_4_-_Request_Validation_in_ASPNET_Web_Forms_45"></a>
#### <a name="task-4---request-validation-in-aspnet-web-forms-45"></a>Задача 4. запрос проверки в ASP.NET Web Forms 4,5

Функция проверки запросов в ASP.NET предоставляет определенный уровень защиты по умолчанию от атак с использованием межсайтовых сценариев (XSS). В предыдущих версиях ASP.NET проверка запросов была включена по умолчанию и может быть отключена только для всей страницы. Благодаря новой версии веб-форм ASP.NET можно отключить проверку запросов для одного элемента управления, выполнить отложенную проверку запросов или доступ к непроверенным данным запроса (Будьте внимательны, если это сделано).

1. Нажмите клавиши **CTRL + F5** , чтобы запустить сайт без отладки и перейти на страницу продукты. Выберите категорию, а затем щелкните ссылку **Edit (изменить** ) для любого из продуктов.
2. Введите описание, содержащее потенциально опасное содержимое, например теги HTML. Обратите внимание на исключение, возникшее из-за проверки запроса.

    ![Изменение продукта с потенциально опасным содержимым](whats-new-in-web-forms-in-aspnet-45/_static/image18.png "Изменение продукта с потенциально опасным содержимым")

    *Изменение продукта с потенциально опасным содержимым*

    ![Возникло исключение, вызванное проверкой запроса](whats-new-in-web-forms-in-aspnet-45/_static/image19.png "Возникло исключение, вызванное проверкой запроса")

    *Возникло исключение, вызванное проверкой запроса*
3. Закройте страницу и в Visual Studio нажмите клавиши **SHIFT + F5** , чтобы отключить отладку.
4. Откройте страницу **продуктдетаилс. aspx** и перейдите в текстовое поле **Description (описание** ).
5. Добавьте новое свойство **валидатерекуестмоде** в текстовое поле и присвойте ему значение **Disabled (отключено**).

    Новый атрибут **валидатерекуестмоде** позволяет детально отключить проверку запросов для каждого элемента управления. Это полезно, если необходимо использовать входные данные, которые могут получить код HTML, но при этом необходимо обеспечить работу проверки на остальной части страницы.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample29.aspx)]
6. Нажмите клавишу **F5** , чтобы запустить веб-приложение. Снова откройте страницу изменить продукт и заполните описание продукта, включая теги HTML. Обратите внимание, что теперь в описание можно добавить HTML-содержимое.

    ![Проверка запросов отключена для описания продукта](whats-new-in-web-forms-in-aspnet-45/_static/image20.png "Проверка запросов отключена для описания продукта")

    *Проверка запросов отключена для описания продукта*

    > [!NOTE]
    > В рабочем приложении следует очистить HTML-код, введенный пользователем, чтобы убедиться в том, что введены только надежные HTML-теги (например, нет &lt;скриптов&gt; тегов). Для этого можно использовать [веб-библиотеку Microsoft Web Protection](https://www.nuget.org/packages/AntiXSS).
7. Измените продукт еще раз. Введите код HTML в поле имя и нажмите кнопку **сохранить**. Обратите внимание, что проверка запросов отключена только для поля Описание, а остальные поля по-прежнему проверяются на потенциально опасном содержимом.

    ![Проверка запросов включена в остальных полях](whats-new-in-web-forms-in-aspnet-45/_static/image21.png "Проверка запросов включена в остальных полях")

    *Проверка запросов включена в остальных полях*

    ASP.NET Web Forms 4,5 включает новый режим проверки запросов для неактивной проверки запросов. Если для режима проверки запроса задано значение **4,5**, то если фрагмент кода обращается к *запросу. Форма [&quot;Key&quot;]* , проверка запроса ASP.NET 4.5 активирует только проверку запроса для этого конкретного элемента в коллекции форм.

    Кроме того, ASP.NET 4,5 теперь включает основные подпрограммы кодирования из библиотеки Microsoft Anti-XSS Library v 4.0. Подпрограммы кодирования Anti-XSS реализуются новым типом *AntiXssEncoder* , который находится в новом пространстве имен **System. Web. Security. антикссс** . При использовании параметра **енкодертипе** , настроенного для использования *AntiXssEncoder*, вся кодировка выходных данных в ASP.NET автоматически использует новые подпрограммы кодирования.
8. ASP.NET 4,5. Проверка запросов также поддерживает непроверенный доступ к данным запроса. ASP.NET 4,5 добавляет новое свойство коллекции в объект **HttpRequest** , вызываемый **непроверенным**. При переходе в **HttpRequest. unvalidateed** вы можете получить доступ ко всем общим частям запроса данных, включая формы, строки запроса, файлы cookie, URL-адреса и т. д.

    ![Запрос. непроверенный объект](whats-new-in-web-forms-in-aspnet-45/_static/image22.png "Запрос. непроверенный объект")

    *Запрос. непроверенный объект*

    > [!NOTE]
    > **Используйте свойство HttpRequest. unvalidateed с осторожностью!** Обязательно выполните пользовательскую проверку данных необработанных запросов, чтобы убедиться, что опасный текст не является циклическим, и отрисовывается в подозрительной стороне клиентов!

<a id="Exercise3"></a>

<a id="Exercise_3_Asynchronous_Page_Processing_in_ASPNET_Web_Forms"></a>
### <a name="exercise-3-asynchronous-page-processing-in-aspnet-web-forms"></a>Упражнение 3. асинхронная обработка страниц в веб-формах ASP.NET

В этом упражнении будут представлены новые функции асинхронной обработки страниц в веб-формах ASP.NET.

<a id="Task_1_-_Updating_the_Product_Details_Page_to_Upload_and_Show_Images"></a>
#### <a name="task-1---updating-the-product-details-page-to-upload-and-show-images"></a>Задача 1. обновление страницы сведений о продукте для отправки и отображения изображений

В этой задаче будет обновлена страница сведений о продукте, позволяющая пользователю указать URL-адрес изображения для продукта и отобразить его в представлении, доступном только для чтения. Вы создадите локальную копию указанного образа, загрузив ее синхронно. В следующей задаче вы обновите эту реализацию, чтобы она работала асинхронно.

1. Откройте **Visual Studio 2012** и загрузите решение **Начало** работы, расположенное в **Source\Ex3-Async\Begin** , из папки этого лабораторного занятия. Кроме того, можно продолжить работу над существующим решением из предыдущих упражнений.

   1. Если вы открыли предоставленное **Начальное** решение, перед продолжением потребуется загрузить некоторые недостающие пакеты NuGet. Для этого в обозреватель решений щелкните проект **вебформслаб** и выберите **Управление пакетами NuGet**.
   2. В диалоговом окне **Управление пакетами NuGet** нажмите кнопку **восстановить** , чтобы скачать недостающие пакеты.
   3. Наконец, создайте решение, щелкнув **build** | **Build Solution**.

      > [!NOTE]
      > Одним из преимуществ использования NuGet является то, что вам не нужно поставлять все библиотеки в проекте, уменьшая размер проекта. С помощью средств управления питанием NuGet, указав версии пакетов в файле Packages. config, вы сможете скачать все необходимые библиотеки при первом запуске проекта. Именно поэтому после открытия существующего решения из этой лабораторной работы потребуется выполнить следующие действия.
2. Откройте страницу **продуктдетаилс. aspx** и добавьте поле в ItemTemplate элемента FormView, чтобы отобразить изображение продукта.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample30.aspx)]
3. Добавьте поле, чтобы указать URL-адрес изображения в Едиттемплате FormView.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample31.aspx)]
4. Откройте файл кода программной части **ProductDetails.aspx.CS** и добавьте следующие директивы пространства имен.

    (Фрагмент кода — *веб-формы Lab-Ex03-Namespaces*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample32.cs)]
5. Создайте метод **упдатепродуктимаже** для хранения удаленных образов в папке "Локальные **образы** " и обновите сущность Product, указав новое значение расположения образа.

    (Фрагмент кода — *Web Forms Lab-Ex03-упдатепродуктимаже*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample33.cs)]
6. Обновите метод **UpdateProduct** , чтобы вызвать метод **упдатепродуктимаже** .

    (Фрагмент кода- *Web Forms Lab-Ex03-Упдатепродуктимаже Call*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample34.cs)]
7. Запустите приложение и попытайтесь отправить образ для продукта. Например, можно использовать следующий URL-адрес изображения из Clip Искусство: [ [http://officeimg.vo.msecnd.net/images/MB900437099.jpg](http://officeimg.vo.msecnd.net/images/MB900437099.jpg)](http://officeimg.vo.msecnd.net/images/MB900437099.jpg)

    ![Задание образа для продукта](whats-new-in-web-forms-in-aspnet-45/_static/image23.png "Задание образа для продукта")

    *Задание образа для продукта*

<a id="Task_2_-_Adding_Asynchronous_Processing_to_the_Product_Details_Page"></a>
#### <a name="task-2---adding-asynchronous-processing-to-the-product-details-page"></a>Задача 2. Добавление асинхронной обработки на страницу сведений о продукте

В этой задаче будет обновлена страница сведений о продукте, чтобы она работала асинхронно. Вы улучшите длительную задачу — процесс загрузки образа — с помощью асинхронной обработки страниц ASP.NET 4,5.

Асинхронные методы в веб-приложениях можно использовать для оптимизации способа использования пулов потоков ASP.NET. В ASP.NET существует ограниченное количество потоков в пуле потоков для запросов на посещение, поэтому, когда все потоки заняты, ASP.NET начинает отклонять новые запросы, отправляет сообщения об ошибках приложений и делает сайт недоступным.

Длительные операции на веб-сайте являются хорошим кандидатом на асинхронное программирование, так как они занимают назначенный поток на длительное время. Сюда входят длительные запросы, страницы с множеством различных элементов и страниц, для которых требуются автономные операции, такие как запрос к базе данных или доступ к внешнему веб-серверу. Преимущество заключается в том, что если для этих операций используются асинхронные методы, то во время обработки страницы поток освобождается и возвращается в пул потоков, и его можно использовать для участия в новом запросе страницы. Это означает, что страница начнет обрабатываться в одном потоке из пула потоков и может завершить обработку в другом, после завершения асинхронной обработки.

1. Откройте страницу **продуктдетаилс. aspx** . Добавьте атрибут **Async** в элемент **Page** и задайте для него значение **true**. Этот атрибут указывает ASP.NET реализовать интерфейс IHttpAsyncHandler.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample35.aspx)]
2. Добавьте метку в нижней части страницы, чтобы просмотреть сведения о потоках, выполняющих страницу.

    [!code-aspx[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample36.aspx)]
3. Откройте **ProductDetails.aspx.CS** и добавьте следующие директивы пространства имен.

    (Фрагмент кода — *веб-формы Lab-Ex03-Namespaces 2*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample37.cs)]
4. Измените метод **упдатепродуктимаже** , чтобы загрузить образ с асинхронной задачей. Метод **DownloadFile** для **WebClient** будет заменен методом **довнлоадфилетаскасинк** и включать ключевое слово **await** .

    (Фрагмент кода — *Web Forms Lab-Ex03-Упдатепродуктимаже Async*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample38.cs)]

    Метод RegisterAsyncTask регистрирует асинхронную задачу новой страницы для выполнения в другом потоке. Он получает лямбда-выражение с выполняемой задачей (t). Ключевое слово **await** в методе **довнлоадфилетаскасинк** преобразует оставшуюся часть метода в обратный вызов, который вызывается асинхронно после завершения метода **довнлоадфилетаскасинк** . ASP.NET возобновит выполнение метода, автоматически сохраняя все исходные значения HTTP-запроса. Новая модель асинхронного программирования в .NET 4,5 позволяет создавать асинхронный код, который во многом напоминает синхронный код и позволяет компилятору обрабатывают сложности функций обратного вызова или кода продолжения.
    > [!NOTE]
    > Метод RegisterAsyncTask и PageAsyncTask уже доступны с момента выпуска .NET 2,0. Ключевое слово await является новым из модели асинхронного программирования .NET 4,5 и может использоваться вместе с новыми методами Таскасинк из объекта .NET WebClient.
5. Добавьте код для вывода потоков, в которых код был запущен и завершен. Для этого обновите метод **упдатепродуктимаже** , используя следующий код.

    (Фрагмент кода — *веб-формы Lab-Ex03-показывать потоки*)

    [!code-csharp[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample39.cs)]
6. Откройте файл **Web. config** веб-сайта. Добавьте следующую переменную appSetting.

    [!code-xml[Main](whats-new-in-web-forms-in-aspnet-45/samples/sample40.xml)]
7. Нажмите клавишу **F5** , чтобы запустить приложение и отправить изображение для продукта. Обратите внимание, что идентификатор потоков, в котором запущен и завершен код, может отличаться. Это связано с тем, что асинхронные задачи выполняются в отдельном потоке из пула потоков ASP.NET. После завершения задачи ASP.NET помещает задачу обратно в очередь и назначает любой из доступных потоков.

    ![Асинхронная загрузка образа](whats-new-in-web-forms-in-aspnet-45/_static/image24.png "Асинхронная загрузка образа")

    *Асинхронная загрузка образа*

> [!NOTE]
> Кроме того, это приложение можно развернуть в Azure в [приложении б: Публикация приложения ASP.NET MVC 4 с помощью веб-развертывание](#AppendixB).

---

<a id="Summary"></a>
## <a name="summary"></a>Сводка

В этой практической лабораторной работе были рассмотрены и рассмотрены следующие концепции:

- Использование строго типизированных выражений привязки данных
- Использование новых функций привязки модели в веб-формах
- Использование поставщиков значений для сопоставления данных страницы с методами кода программной части
- Использование заметок к данным для проверки вводимых пользователем данных
- Воспользуйтесь преимуществами ненавязчивой клиентской проверки с jQuery в веб-формах
- Реализация детализированной проверки запросов
- Реализация асинхронной обработки страниц в веб-формах

<a id="AppendixA"></a>

<a id="Appendix_A_Installing_Visual_Studio_Express_2012_for_Web"></a>
## <a name="appendix-a-installing-visual-studio-express-2012-for-web"></a>Приложение а. Установка Visual Studio Express 2012 для Web

Вы можете установить **Microsoft Visual Studio Express 2012 для Web** или другой &quot;Express&quot; версии с помощью **[установщик веб-платформы Майкрософт](https://www.microsoft.com/web/downloads/platform.aspx)** . Следующие инструкции помогут вам выполнить действия, необходимые для установки *Visual Studio Express 2012 для Web* с помощью *установщик веб-платформы Майкрософт*.

1. Перейдите в [[https://go.microsoft.com/?linkid=9810169](https://go.microsoft.com/?linkid=9810169)](https://go.microsoft.com/?linkid=9810169). Кроме того, если у вас уже установлен установщик веб-платформы, вы можете открыть его и найти продукт &quot;<em>Visual Studio Express 2012 для Web с пакетом Azure SDK</em>&quot;.
2. Щелкните **Install Now (установить сейчас**). Если у вас нет **установщика веб-платформы** , вы будете сначала перенаправлены на загрузку и установку.
3. После открытия **установщика веб-платформы** нажмите кнопку **установить** , чтобы начать установку.

    ![Установка Visual Studio Express](whats-new-in-web-forms-in-aspnet-45/_static/image25.png "Установка Visual Studio Express")

    *Установка Visual Studio Express*
4. Прочитайте все лицензии и условия продуктов и нажмите кнопку " **принять** ", чтобы продолжить.

    ![Принятие условий лицензии](whats-new-in-web-forms-in-aspnet-45/_static/image26.png)

    *Принятие условий лицензии*
5. Дождитесь завершения процесса загрузки и установки.

    ![Ход установки](whats-new-in-web-forms-in-aspnet-45/_static/image27.png)

    *Ход установки*
6. После завершения установки нажмите кнопку **Готово**.

    ![Установка завершена](whats-new-in-web-forms-in-aspnet-45/_static/image28.png)

    *Установка завершена*
7. Нажмите кнопку **выход** , чтобы закрыть установщик веб-платформы.
8. Чтобы открыть Visual Studio Express для Интернета, перейдите на **начальный** экран и начните запись &quot;**VS Express**&quot;, а затем щелкните плитку **VS Express для Web** .

    ![Плитка VS Express для Web](whats-new-in-web-forms-in-aspnet-45/_static/image29.png)

    *Плитка VS Express для Web*

<a id="AppendixB"></a>

<a id="Appendix_B_Publishing_an_ASPNET_MVC_4_Application_using_Web_Deploy"></a>
## <a name="appendix-b-publishing-an-aspnet-mvc-4-application-using-web-deploy"></a>Приложение б. Публикация приложения ASP.NET MVC 4 с помощью веб-развертывание

В этом приложении показано, как создать новый веб-сайт на портале Azure и опубликовать полученное приложение, выполнив следующие лабораторные занятия, используя возможности публикации веб-развертывание, предоставляемые Azure.

<a id="ApxBTask1"></a>

<a id="Task_1_-_Creating_a_New_Web_Site_from_the_Windows_Azure_Portal"></a>
#### <a name="task-1---creating-a-new-web-site-from-the-azure-portal"></a>Задача 1. Создание нового веб-сайта на портале Azure

1. Перейдите в [портал управления Azure](https://manage.windowsazure.com/) и выполните вход с использованием учетных данных Майкрософт, связанных с подпиской.

    > [!NOTE]
    > С помощью Azure вы можете бесплатно разместить 10 веб-сайтов ASP.NET, а затем масштабировать их по мере роста объема трафика. Вы можете зарегистрироваться [здесь](https://aka.ms/aspnet-hol-azure).

    ![Вход в Windows портал Azure](whats-new-in-web-forms-in-aspnet-45/_static/image30.png "Вход в Windows портал Azure")

    *Вход на портал*
2. На панели команд щелкните **создать** .

    ![Создание нового веб-сайта](whats-new-in-web-forms-in-aspnet-45/_static/image31.png "Создание нового веб-сайта")

    *Создание нового веб-сайта*
3. Щелкните **Compute** | **веб-сайт**. Затем выберите пункт **Быстрое создание** . Предоставьте доступный URL-адрес для нового веб-сайта и щелкните **создать веб-сайт**.

    > [!NOTE]
    > Azure — это узел для веб-приложения, работающего в облаке, которое можно контролировать и управлять ими. Параметр Быстрое создание позволяет развернуть завершенное веб-приложение в Azure за пределами портала. Он не включает шаги по настройке базы данных.

    ![Создание нового веб-сайта с помощью быстрого создания](whats-new-in-web-forms-in-aspnet-45/_static/image32.png "Создание нового веб-сайта с помощью быстрого создания")

    *Создание нового веб-сайта с помощью быстрого создания*
4. Дождитесь создания нового **веб-сайта** .
5. После создания веб-сайта щелкните ссылку в столбце **URL-адрес** . Убедитесь, что новый веб-сайт работает.

    ![Обзор нового веб-сайта](whats-new-in-web-forms-in-aspnet-45/_static/image33.png "Обзор нового веб-сайта")

    *Обзор нового веб-сайта*

    ![Веб-сайт работает](whats-new-in-web-forms-in-aspnet-45/_static/image34.png "Веб-сайт работает")

    *Веб-сайт работает*
6. Вернитесь на портал и щелкните имя веб-сайта в столбце **имя** , чтобы отобразить страницы управления.

    ![Открытие страниц управления веб-сайтом](whats-new-in-web-forms-in-aspnet-45/_static/image35.png "Открытие страниц управления веб-сайтом")

    *Открытие страниц управления веб-сайтом*
7. На странице **панель мониторинга** в разделе **краткий обзор** щелкните ссылку **скачать профиль публикации** .

    > [!NOTE]
    > *Профиль публикации* содержит все сведения, необходимые для публикации веб-приложения в Azure для каждого включенного метода публикации. Профиль публикации содержит URL-адреса, учетные данные пользователей и строки для открытия базы данных, которые необходимы для проверки подлинности и подключения к каждой из конечных точек, соответствующей разрешенному методу публикации. **Microsoft WebMatrix 2**, **Microsoft Visual Studio Express для Web** и **Microsoft Visual Studio 2012** поддерживают чтение профилей публикации для автоматизации настройки этих программ для публикации веб-приложений в Azure.

    ![Скачивание профиля публикации веб-сайта](whats-new-in-web-forms-in-aspnet-45/_static/image36.png "Скачивание профиля публикации веб-сайта")

    *Скачивание профиля публикации веб-сайта*
8. Скачайте файл профиля публикации в известное расположение. Далее в этом упражнении вы узнаете, как использовать этот файл для публикации веб-приложения в Azure из Visual Studio.

    ![Сохранение файла профиля публикации](whats-new-in-web-forms-in-aspnet-45/_static/image37.png "Сохранение профиля публикации")

    *Сохранение файла профиля публикации*

<a id="ApxBTask2"></a>

<a id="Task_2_-_Configuring_the_Database_Server"></a>
#### <a name="task-2---configuring-the-database-server"></a>Задача 2. Настройка сервера базы данных

Если приложение использует SQL Server базы данных, потребуется создать сервер базы данных SQL. Если вы хотите развернуть простое приложение, которое не использует SQL Server вы можете пропустить эту задачу.

1. Для хранения базы данных приложения необходим сервер базы данных SQL. Серверы базы данных SQL можно просмотреть в подписке на портале управления Azure в **базах данных sql** | **серверы** | **панели мониторинга сервера**. Если сервер не создан, можно создать его с помощью кнопки **Добавить** на панели команд. Запишите **имя сервера и URL-адрес, имя для входа администратора и пароль**, так как они будут использоваться в следующих задачах. Пока не создавайте базу данных, так как она будет создана на более позднем этапе.

    ![Панель мониторинга сервера базы данных SQL](whats-new-in-web-forms-in-aspnet-45/_static/image38.png "Панель мониторинга сервера базы данных SQL")

    *Панель мониторинга сервера базы данных SQL*
2. В следующей задаче вы проверите подключение к базе данных из Visual Studio. по этой причине необходимо включить локальный IP-адрес в список **разрешенных IP-адресов**сервера. Для этого нажмите кнопку **настроить**, выберите IP-адрес из **текущего IP-адреса клиента** и вставьте его в текстовые поля **начальный IP-адрес** и **конечный IP** -адрес и нажмите кнопку ![добавить-клиент-IP – адрес-OK-кнопка](whats-new-in-web-forms-in-aspnet-45/_static/image39.png).

    ![Добавление IP-адреса клиента](whats-new-in-web-forms-in-aspnet-45/_static/image40.png)

    *Добавление IP-адреса клиента*
3. После добавления **IP-адреса клиента** в список Разрешенные IP-адреса нажмите кнопку **сохранить** , чтобы подтвердить изменения.

    ![Подтверждение изменений](whats-new-in-web-forms-in-aspnet-45/_static/image41.png)

    *Подтверждение изменений*

<a id="ApxBTask3"></a>

<a id="Task_3_-_Publishing_an_ASPNET_MVC_4_Application_using_Web_Deploy"></a>
#### <a name="task-3---publishing-an-aspnet-mvc-4-application-using-web-deploy"></a>Задача 3. Публикация приложения ASP.NET MVC 4 с помощью веб-развертывание

1. Вернитесь к решению ASP.NET MVC 4. В **Обозреватель решений**щелкните правой кнопкой мыши проект веб-сайта и выберите **опубликовать**.

    ![Публикация приложения](whats-new-in-web-forms-in-aspnet-45/_static/image42.png "Публикация приложения")

    *Публикация веб-сайта*
2. Импортируйте профиль публикации, сохраненный в первой задаче.

    ![Импорт профиля публикации](whats-new-in-web-forms-in-aspnet-45/_static/image43.png "Импорт профиля публикации")

    *Импорт профиля публикации*
3. Щелкните **проверить подключение**. После завершения проверки нажмите кнопку **Далее**.

    > [!NOTE]
    > Проверка завершится, когда появится зеленая галочка рядом с кнопкой проверить подключение.

    ![Проверка подключения](whats-new-in-web-forms-in-aspnet-45/_static/image44.png "Проверка подключения")

    *Проверка подключения*
4. На странице **Параметры** в разделе **базы данных** нажмите кнопку рядом с текстовым полем подключения к базе данных (т. е. **DefaultConnection**).

    ![Конфигурация веб-развертывания](whats-new-in-web-forms-in-aspnet-45/_static/image45.png "Конфигурация веб-развертывания")

    *Конфигурация веб-развертывания*
5. Настройте подключение к базе данных следующим образом.

   - В поле **имя сервера** введите URL-адрес сервера базы данных SQL с помощью префикса *TCP:* .
   - В окне **имя пользователя** введите имя для входа администратора сервера.
   - В окне **пароль** введите пароль для входа администратора сервера.
   - Введите новое имя базы данных.

     ![Настройка строки подключения к целевому объекту](whats-new-in-web-forms-in-aspnet-45/_static/image46.png "Настройка строки подключения к целевому объекту")

     *Настройка строки подключения к целевому объекту*
6. Нажмите кнопку **ОК**. При появлении запроса на создание базы данных нажмите кнопку **Да**.

    ![Создание базы данных](whats-new-in-web-forms-in-aspnet-45/_static/image47.png "Создание строки базы данных")

    *Создание базы данных*
7. Строка подключения, которая будет использоваться для подключения к базе данных SQL в Azure, отображается в текстовом поле подключения по умолчанию. Затем нажмите кнопку **Далее**.

    ![Строка подключения, указывающая на базу данных SQL](whats-new-in-web-forms-in-aspnet-45/_static/image48.png "Строка подключения, указывающая на базу данных SQL")

    *Строка подключения, указывающая на базу данных SQL*
8. На странице **Предварительный просмотр** нажмите кнопку **опубликовать**.

    ![Публикация веб-приложения](whats-new-in-web-forms-in-aspnet-45/_static/image49.png "Публикация веб-приложения")

    *Публикация веб-приложения*
9. По завершении процесса публикации браузер по умолчанию будет открывать опубликованный веб-сайт.

<a id="AppendixC"></a>

<a id="Appendix_C_Using_Code_Snippets"></a>
## <a name="appendix-c-using-code-snippets"></a>Приложение в. Использование фрагментов кода

С помощью фрагментов кода вы можете получить все необходимые вам коды. В лабораторном документе вы узнаете, когда можно использовать их, как показано на следующем рисунке.

![Использование фрагментов кода Visual Studio для вставки кода в проект](whats-new-in-web-forms-in-aspnet-45/_static/image50.png "Использование фрагментов кода Visual Studio для вставки кода в проект")

*Использование фрагментов кода Visual Studio для вставки кода в проект*

***Добавление фрагмента кода с помощью клавиатуры (C# только)***

1. Поместите курсор в то место, куда вы хотите вставить код.
2. Начните вводить имя фрагмента (без пробелов или дефисов).
3. Посмотрите, как IntelliSense отображает соответствующие имена фрагментов кода.
4. Выберите правильный фрагмент кода (или вводите его, пока не будет выбрано имя всего фрагмента).
5. Дважды нажмите клавишу TAB, чтобы вставить фрагмент в позицию курсора.

![Начните вводить имя фрагмента](whats-new-in-web-forms-in-aspnet-45/_static/image51.png "Начните вводить имя фрагмента")

*Начните вводить имя фрагмента*

![Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.](whats-new-in-web-forms-in-aspnet-45/_static/image52.png "Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.")

*Нажмите клавишу TAB, чтобы выбрать выделенный фрагмент.*

![Снова нажмите клавишу TAB, и фрагмент развернется](whats-new-in-web-forms-in-aspnet-45/_static/image53.png "Снова нажмите клавишу TAB, и фрагмент развернется")

*Снова нажмите клавишу TAB, и фрагмент развернется*

***Добавление фрагмента кода с помощью мыши (C#, Visual Basic и XML)*** одного. Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода.

1. Выберите **Вставить фрагмент** , за которым следуют **фрагменты кода**.
2. Выберите соответствующий фрагмент из списка, щелкнув его.

![Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.](whats-new-in-web-forms-in-aspnet-45/_static/image54.png "Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.")

*Щелкните правой кнопкой мыши место, куда нужно вставить фрагмент кода, и выберите пункт Вставить фрагмент.*

![Выберите соответствующий фрагмент из списка, щелкнув его.](whats-new-in-web-forms-in-aspnet-45/_static/image55.png "Выберите соответствующий фрагмент из списка, щелкнув его.")

*Выберите соответствующий фрагмент из списка, щелкнув его.*
