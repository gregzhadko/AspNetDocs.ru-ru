---
uid: web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/shopping-cart
title: Покупательская корзина | Документация Майкрософт
author: Erikre
description: В этой серии руководств вы узнаете об основах создания приложения ASP.NET Web Forms с помощью ASP.NET 4,5 и Microsoft Visual Studio Express 2013...
ms.author: riande
ms.date: 09/08/2014
ms.assetid: 6898c601-6c31-432f-8388-e6843f8a17cb
msc.legacyurl: /web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/shopping-cart
msc.type: authoredcontent
ms.openlocfilehash: d3b619ebd9448d30857ffbaf17fd245b1d54a662
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78521118"
---
# <a name="shopping-cart"></a>Корзина для покупок

по [Эрик Реитан](https://github.com/Erikre)

[Скачайте образец проекта Wingtip Toys (C#)](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) или [Загрузите электронную книгу (PDF)](https://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20ASP.NET%204.5%20Web%20Forms%20and%20Visual%20Studio%202013.pdf)

> В этой серии руководств вы узнаете об основах создания приложения ASP.NET Web Forms с помощью ASP.NET 4,5 и Microsoft Visual Studio Express 2013 для Web. Для этой серии руководств доступен [проект Visual Studio 2013 с C# исходным кодом](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) .

В этом учебнике описывается бизнес-логика, необходимая для добавления корзины для покупок в приложение веб-форм Wingtip Toys с примером ASP.NET. Это руководство построено на предыдущем учебном курсе "Отображение элементов данных и сведений" и является частью руководства по магазину Wingtip Toy Store. По завершении работы с этим руководством пользователи вашего примера приложения смогут добавлять, удалять и изменять продукты в своей корзине для покупок.

## <a name="what-youll-learn"></a>Из этого руководства вы узнаете, как выполнять такие задачи:

1. Создание корзины для веб-приложения.
2. Как разрешить пользователям добавлять элементы в корзину для покупок.
3. Добавление элемента управления [GridView](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview(v=vs.110).aspx#introduction) для отображения сведений о корзине для покупок.
4. Как вычислить и отобразить итоги заказа.
5. Удаление и обновление элементов в корзине для покупок.
6. Включение счетчика корзины для покупок.

## <a name="code-features-in-this-tutorial"></a>Возможности кода в этом учебнике:

1. Entity Framework Code First
2. Заметки к данным
3. Строго типизированные элементы управления данными
4. Привязка модели

## <a name="creating-a-shopping-cart"></a>Создание корзины для покупок

Ранее в этой серии руководств были добавлены страницы и код для просмотра данных о продуктах из базы данных. В этом учебнике вы создадите покупательскую корзину для управления продуктами, которые пользователи заинтересованы в покупке. Пользователи смогут просматривать и добавлять элементы в корзину покупок, даже если они не зарегистрированы или не вошли в систему. Чтобы управлять доступом к корзине для покупок, вы назначаете пользователям уникальный `ID` с помощью глобального уникального идентификатора (GUID), когда пользователь впервые обращается к корзине для покупок. Вы храните этот `ID` с помощью состояния сеанса ASP.NET.

> [!NOTE] 
> 
> Состояние сеанса ASP.NET — это удобное место для хранения сведений, относящихся к пользователю, срок действия которых истекает после выхода пользователя из сайта. В то время как неправильное использование состояния сеанса может негативно сказаться на производительности на больших сайтах, в демонстрационных целях вполне удобно использовать состояние сеанса. В примере проекта Wingtip Toys показано, как использовать состояние сеанса без внешнего поставщика, где состояние сеанса хранится в процессе на веб-сервере, где размещается сайт. Для больших сайтов, которые предоставляют несколько экземпляров приложения или для сайтов, на которых запущено несколько экземпляров приложения на разных серверах, рассмотрите возможность использования **службы кэша Windows Azure**. Эта служба кэша предоставляет распределенную службу кэширования, которая является внешней по отношению к веб-сайту, и решает проблему использования внутрипроцессного состояния сеанса. Дополнительные сведения см. [в разделе Использование состояния сеанса ASP.NET с веб-сайтами Windows Azure](https://docs.microsoft.com/azure/redis-cache/cache-aspnet-session-state-provider).

### <a name="add-cartitem-as-a-model-class"></a>Добавление Картитем в качестве класса модели

Ранее в этой серии руководств вы определили схему для данных категории и продукта, создав классы `Category` и `Product` в папке *Models* . Теперь добавьте новый класс, чтобы определить схему для корзины для покупок. Далее в этом руководстве вы добавите класс для управления доступом к данным в `CartItem` таблице. Этот класс предоставит бизнес-логику для добавления, удаления и обновления элементов в корзине для покупок.

1. Щелкните правой кнопкой мыши папку *Models* и выберите **Добавить** -&gt; **новый элемент**. 

    ![Корзина для покупок — новый элемент](shopping-cart/_static/image1.png)
2. Откроется диалоговое окно **Добавление нового элемента** . Выберите **код**, а затем выберите **класс**. 

    ![Корзина для покупок — диалоговое окно "Добавление нового элемента"](shopping-cart/_static/image2.png)
3. Назовите этот новый класс *CartItem.CS*.
4. Нажмите кнопку **Добавить**.  
   В редакторе отобразится новый файл класса.
5. Замените код по умолчанию на приведенный ниже:   

    [!code-csharp[Main](shopping-cart/samples/sample1.cs)]

Класс `CartItem` содержит схему, которая будет определять каждый продукт, добавляемый пользователем в корзину для покупок. Этот класс похож на другие классы схем, созданные ранее в этой серии руководств. По соглашению Entity Framework Code First ожидает, что первичный ключ для `CartItem` таблицы будет либо `CartItemId`, либо `ID`. Однако код переопределяет поведение по умолчанию с помощью атрибута `[Key]` аннотации данных. Атрибут `Key` свойства ItemId указывает, что свойство `ItemID` является первичным ключом.

Свойство `CartId` указывает `ID` пользователя, связанного с приобретаемым элементом. Вы добавите код для создания этого пользователя `ID`, когда пользователь попытается получить доступ к корзине для покупок. Этот `ID` также будет храниться как переменная сеанса ASP.NET.

### <a name="update-the-product-context"></a>Обновление контекста продукта

Помимо добавления класса `CartItem` необходимо обновить класс контекста базы данных, управляющий классами сущностей и предоставляющий доступ к базе данных. Для этого в класс `ProductContext` будет добавлен созданный класс модели `CartItem`.

1. В **Обозреватель решений**найдите и откройте файл *ProductContext.CS* в папке *Models* .
2. Добавьте выделенный код в файл *ProductContext.CS* следующим образом:  

    [!code-csharp[Main](shopping-cart/samples/sample2.cs?highlight=14)]

Как упоминалось ранее в этой серии руководств, код в файле *ProductContext.CS* добавляет пространство имен `System.Data.Entity`, чтобы получить доступ ко всем основным функциональным возможностям Entity Framework. Эта функция включает в себя возможность запрашивать, вставлять, обновлять и удалять данные, работая со строго типизированными объектами. Класс `ProductContext` добавляет доступ к только что добавленному классу модели `CartItem`.

### <a name="managing-the-shopping-cart-business-logic"></a>Управление бизнес-логикой покупательской корзины

Далее предстоит создать класс `ShoppingCart` в новой папке *логики* . Класс `ShoppingCart` обрабатывает доступ к данным `CartItem` таблице. Класс также будет включать бизнес-логику для добавления, удаления и обновления элементов в корзине для покупок.

Логика корзины для покупок, которую вы добавите, будет содержать функции для управления следующими действиями:

1. Добавление элементов в корзину для покупок
2. Удаление элементов из корзины для покупок
3. Получение идентификатора корзины для покупок
4. Получение элементов из корзины для покупок
5. Суммарный объем всех элементов корзины для покупок
6. Обновление данных корзины для покупок

Для доступа к данным корзины можно использовать страницу покупательской корзины (*ShoppingCart. aspx*) и класс корзины для покупок. На странице Корзина для покупок отобразятся все элементы, добавленные пользователем в корзину для покупок. Помимо страницы и класса покупательской корзины Вы создадите страницу (*аддтокарт. aspx*) для добавления продуктов в корзину для покупок. Вы также добавите код на страницу *ProductList. aspx* и страницу *продуктдетаилс. aspx* , которая предоставит ссылку на страницу *аддтокарт. aspx* , чтобы пользователь мог добавлять продукты в корзину для покупок.

На следующей схеме показан базовый процесс, который происходит, когда пользователь добавляет продукт в корзину для покупок.

![Покупательская корзина — Добавление в корзину для покупок](shopping-cart/_static/image3.png)

Когда пользователь щелкает ссылку **Добавить в корзину** на странице *ProductList. aspx* или *продуктдетаилс. aspx* , приложение будет переходить на страницу *аддтокарт. aspx* , а затем автоматически на страницу *ShoppingCart. aspx* . Страница *аддтокарт. aspx* добавит продукт SELECT в корзину для покупок, вызвав метод в классе ShoppingCart. На странице *ShoppingCart. aspx* отобразятся продукты, добавленные в корзину для покупок.

#### <a name="creating-the-shopping-cart-class"></a>Создание класса корзины для покупок

Класс `ShoppingCart` будет добавлен в отдельную папку в приложении, чтобы существовало четкое различие между моделью (папкой Models), страницами (корневая папка) и логикой (логическая папка).

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект **WingtipToys**и выберите **добавить**-&gt;**Новая папка**. Назовите новую *логику*папки.
2. Щелкните правой кнопкой мыши папку *Logic* и выберите **Добавить** -&gt; **новый элемент**.
3. Добавьте новый файл класса с именем *ShoppingCartActions.CS*.
4. Замените код по умолчанию на приведенный ниже:   

    [!code-csharp[Main](shopping-cart/samples/sample3.cs)]

`AddToCart` метод позволяет включать отдельные продукты в корзину для покупок на основе `ID`продукта. Продукт добавляется в корзину, или если корзина уже содержит элемент для этого продукта, количество увеличивается.

Метод `GetCartId` возвращает `ID` корзины для пользователя. Корзина `ID` используется для контроля элементов, которые пользователь имеет в корзине для покупок. Если у пользователя нет существующей корзины `ID`, для них создается новая корзина `ID`. Если пользователь вошел в систему как зарегистрированный пользователь, для `ID` корзины задается имя пользователя. Однако если пользователь не вошел в учетную запись, для `ID` корзины задается уникальное значение (GUID). Идентификатор GUID гарантирует, что для каждого пользователя создается только одна корзина на основе сеанса.

Метод `GetCartItems` возвращает список элементов корзины покупок для пользователя. Далее в этом руководстве вы увидите, что привязка модели используется для показа элементов корзины в корзине для покупок с помощью метода `GetCartItems`.

### <a name="creating-the-add-to-cart-functionality"></a>Создание функции "надстройка — Корзина"

Как упоминалось ранее, вы создадите страницу обработки с именем *аддтокарт. aspx* , которая будет использоваться для добавления новых продуктов в корзину для покупок пользователя. Эта страница будет вызывать метод `AddToCart` в только что созданном классе `ShoppingCart`. Страница *аддтокарт. aspx* будет предполагать, что в нее передается `ID` продукта. Этот `ID` продукта будет использоваться при вызове метода `AddToCart` в классе `ShoppingCart`.

> [!NOTE] 
> 
> Вы будете изменять код программной части (*AddToCart.aspx.CS*) для этой страницы, а не пользовательский интерфейс страницы (*аддтокарт. aspx*).

#### <a name="to-create-the-add-to-cart-functionality"></a>Чтобы создать функцию "надстройка-Корзина", сделайте следующее:

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект **WingtipToys**и выберите **добавить** -&gt; **новый элемент**.  
   Откроется диалоговое окно **Добавление нового элемента** .
2. Добавьте стандартную новую страницу (веб-форму) в приложение с именем *аддтокарт. aspx*. 

    ![Корзина для покупок — Добавление веб-формы](shopping-cart/_static/image4.png)
3. В **Обозреватель решений**щелкните правой кнопкой мыши страницу *аддтокарт. aspx* и выберите пункт **Просмотреть код**. Файл кода программной части *AddToCart.aspx.CS* открывается в редакторе.
4. Замените существующий код в коде программной части *AddToCart.aspx.CS* следующим кодом:   

    [!code-csharp[Main](shopping-cart/samples/sample4.cs)]

При загрузке страницы *аддтокарт. aspx* из строки запроса извлекается `ID` продукта. Затем создается экземпляр класса корзины для покупок, который используется для вызова метода `AddToCart`, добавленного ранее в этом руководстве. Метод `AddToCart`, содержащийся в файле *ShoppingCartActions.CS* , включает логику для добавления выбранного продукта в корзину для покупок или увеличения количества продуктов выбранного продукта. Если продукт не был добавлен в корзину для покупок, продукт добавляется в таблицу `CartItem` базы данных. Если продукт уже добавлен в корзину для покупок и пользователь добавляет дополнительный элемент того же продукта, количество товара увеличивается в таблице `CartItem`. Наконец, страница перенаправляется обратно на страницу *ShoppingCart. aspx* , которая будет добавлена на следующем шаге, где пользователь увидит обновленный список элементов в корзине.

Как упоминалось ранее, пользовательское `ID` используется для поиска продуктов, связанных с конкретным пользователем. Эта `ID` добавляется в строку таблицы `CartItem` каждый раз, когда пользователь добавляет продукт в корзину для покупок.

### <a name="creating-the-shopping-cart-ui"></a>Создание пользовательского интерфейса корзины для покупок

На странице *ShoppingCart. aspx* отобразятся продукты, добавленные пользователем в корзину для покупок. Кроме того, она позволяет добавлять, удалять и обновлять элементы в корзине для покупок.

1. В **Обозреватель решений**щелкните правой кнопкой мыши **WingtipToys**, выберите **добавить** -&gt; **новый элемент**.  
   Откроется диалоговое окно **Добавление нового элемента** .
2. Добавьте новую страницу (веб-форму), содержащую главную страницу, выбрав **веб-форму с помощью главной страницы**. Назовите новую страницу *ShoppingCart. aspx*.
3. Выберите **site. master** , чтобы присоединить главную страницу к только что созданной странице *. aspx* .
4. На странице *ShoppingCart. aspx* замените существующую разметку следующей разметкой:   

    [!code-aspx[Main](shopping-cart/samples/sample5.aspx)]

Страница *ShoppingCart. aspx* включает элемент управления **GridView** с именем `CartList`. Этот элемент управления использует привязку модели для привязки данных корзины покупок из базы данных к элементу управления **GridView** . При задании свойства `ItemType` элемента управления **GridView** выражение привязки данных `Item` доступно в разметке элемента управления, а элемент управления становится строго типизированным. Как упоминалось ранее в этой серии руководств, можно выбрать сведения об объекте `Item` с помощью IntelliSense. Чтобы настроить элемент управления данными для использования привязки модели для выбора данных, необходимо задать свойство `SelectMethod` элемента управления. В приведенной выше разметке задается `SelectMethod` для использования метода Жетшоппингкартитемс, возвращающего список объектов `CartItem`. Элемент управления данными **GridView** вызывает метод в соответствующее время в жизненном цикле страницы и автоматически привязывает возвращенные данные. Метод `GetShoppingCartItems` по-прежнему должен быть добавлен.

#### <a name="retrieving-the-shopping-cart-items"></a>Получение элементов корзины для покупок

Затем добавьте код в код программной части *ShoppingCart.aspx.CS* , чтобы получить и заполнить пользовательский интерфейс корзины для покупок.

1. В **Обозреватель решений**щелкните правой кнопкой мыши страницу *ShoppingCart. aspx* и выберите пункт **Просмотреть код**. Файл кода программной части *ShoppingCart.aspx.CS* открывается в редакторе.
2. Замените существующий код следующим кодом:  

    [!code-csharp[Main](shopping-cart/samples/sample6.cs)]

Как упоминалось выше, `GridView` элемент управления данными вызывает метод `GetShoppingCartItems` в соответствующее время жизненного цикла страницы и автоматически привязывает возвращенные данные. Метод `GetShoppingCartItems` создает экземпляр объекта `ShoppingCartActions`. Затем код использует этот экземпляр для возврата элементов в корзине путем вызова метода `GetCartItems`.

### <a name="adding-products-to-the-shopping-cart"></a>Добавление продуктов в корзину для покупок

При отображении страницы *ProductList. aspx* или *продуктдетаилс. aspx* пользователь сможет добавить продукт в корзину для покупок с помощью ссылки. При щелчке по ссылке приложение переходит на страницу обработки с именем *аддтокарт. aspx*. Страница *аддтокарт. aspx* будет вызывать метод `AddToCart` в классе `ShoppingCart`, который был добавлен ранее в этом руководстве.

Теперь вы добавите ссылку **Добавить в корзину** как на страницу *ProductList. aspx* , так и на страницу *продуктдетаилс. aspx* . Эта ссылка будет содержать продукт `ID`, полученный из базы данных.

1. В **Обозреватель решений**найдите и откройте страницу с именем *ProductList. aspx*.
2. Добавьте разметку, выделенную желтым цветом, на страницу *ProductList. aspx* , чтобы вся страница выявлялась следующим образом:  

    [!code-aspx[Main](shopping-cart/samples/sample7.aspx?highlight=50-54)]

### <a name="testing-the-shopping-cart"></a>Тестирование корзины для покупок

Запустите приложение, чтобы увидеть, как вы добавляете продукты в корзину для покупок.

1. Нажмите клавишу **F5** для запуска приложения.  
 После того, как проект воссоздаст базу данных, откроется браузер и отобразится страница *Default. aspx* .
2. В меню навигации по категориям выберите **автомобили** .  
 Отобразится страница *ProductList. aspx* , на которой отображаются только продукты, включенные в категорию "автомобили". 

    ![Покупательская корзина — автомобили](shopping-cart/_static/image5.png)
3. Щелкните ссылку **Добавить в корзину** рядом с первым продуктом в списке (преобразованный автомобиль).   
 Отобразится страница *ShoppingCart. aspx* , в которой отображается выбор в корзине для покупок. 

    ![Корзина для покупок](shopping-cart/_static/image6.png)
4. Просмотрите дополнительные продукты, выбрав **плоскости** в меню навигации по категории.
5. Щелкните ссылку **Добавить в корзину** рядом с первым продуктом в списке.  
 Отобразится страница *ShoppingCart. aspx* с дополнительным элементом.
6. Закройте браузер.

### <a name="calculating-and-displaying-the-order-total"></a>Вычисление и отображение итога заказа

Помимо добавления продуктов в корзину для покупок, добавьте метод `GetTotal` в класс `ShoppingCart` и отобразите общую сумму заказа на странице покупательская корзина.

1. В **Обозреватель решений**откройте файл *ShoppingCartActions.CS* в папке *Logic* .
2. Добавьте следующий метод `GetTotal`, выделенный желтым цветом, в класс `ShoppingCart`, чтобы класс выявлялся следующим образом:   

    [!code-csharp[Main](shopping-cart/samples/sample8.cs?highlight=85-97)]

Сначала метод `GetTotal` возвращает идентификатор корзины для пользователя. Затем метод возвращает сумму корзины, умножая цену продукта на количество продуктов для каждого продукта, указанного в корзине.

> [!NOTE] 
> 
> В приведенном выше коде используется тип, допускающий значение null "`int?`". Типы, допускающие значение null, могут представлять все значения базового типа, а также как значение null. Дополнительные сведения см. в разделе [Использование типов, допускающих значение NULL](https://msdn.microsoft.com/library/2cf62fcy(v=vs.110).aspx).

### <a name="modify-the-shopping-cart-display"></a>Изменение экрана корзины для покупок

Далее предстоит изменить код для страницы *ShoppingCart. aspx* , чтобы вызвать метод `GetTotal` и отобразить это итоговое значение на странице *ShoppingCart. aspx* при загрузке страницы.

1. В **Обозреватель решений**щелкните правой кнопкой мыши страницу *ShoppingCart. aspx* и выберите команду **Просмотреть код**.
2. В файле *ShoppingCart.aspx.CS* обновите обработчик `Page_Load`, добавив следующий код, выделенный желтым цветом:   

    [!code-csharp[Main](shopping-cart/samples/sample9.cs?highlight=16-31)]

Когда страница *ShoppingCart. aspx* загружается, она загружает объект корзины для покупок, а затем получает итоговую корзину, вызывая метод `GetTotal` класса `ShoppingCart`. Если корзина для покупок пуста, отобразится сообщение с этим действием.

### <a name="testing-the-shopping-cart-total"></a>Тестирование всего покупательской корзины

Запустите приложение, чтобы увидеть, как можно не только добавить продукт в корзину для покупок, но и просмотреть итоги в корзине для покупок.

1. Нажмите клавишу **F5** для запуска приложения.  
 Откроется браузер и отобразится страница *Default.aspx* .
2. В меню навигации по категориям выберите **автомобили** .
3. Щелкните ссылку **Добавить в корзину** рядом с первым продуктом.   
 Отобразится страница *ShoppingCart. aspx* с итоговым порядком. 

    ![Корзина для покупок — итоговая корзина](shopping-cart/_static/image7.png)
4. Добавьте в корзину некоторые другие продукты (например, плоскость).
5. Отобразится страница *ShoppingCart. aspx* с обновленным итогом для всех добавленных продуктов. 

    ![Корзина для покупок — несколько продуктов](shopping-cart/_static/image8.png)
6. Закройте работающее приложение, закрыв окно браузера.

### <a name="adding-update-and-checkout-buttons-to-the-shopping-cart"></a>Добавление кнопок обновления и извлечения в корзину для покупок

Чтобы разрешить пользователям изменять корзину для покупок, добавьте кнопку **обновления** и кнопку « **Извлечение** » на страницу покупательской корзины. Кнопка **извлечь** не используется до тех пор, пока не будет приведена эта серия руководств.

1. В **Обозреватель решений**откройте страницу *ShoppingCart. aspx* в корне проекта веб-приложения.
2. Чтобы добавить кнопку " **Обновить** " и кнопку " **извлечь** " на страницу *ShoppingCart. aspx* , добавьте разметку, выделенную желтым цветом, в существующую разметку, как показано в следующем коде:   

    [!code-aspx[Main](shopping-cart/samples/sample10.aspx?highlight=36-45)]

Когда пользователь нажимает кнопку " **Обновить** ", будет вызван обработчик событий `UpdateBtn_Click`. Этот обработчик событий вызовет код, который будет добавлен на следующем шаге.

Затем можно обновить код, содержащийся в файле *ShoppingCart.aspx.CS* , для циклического прохода по элементам корзины и вызова методов `RemoveItem` и `UpdateItem`.

1. В **Обозреватель решений**откройте файл *ShoppingCart.aspx.CS* в корне проекта веб-приложения.
2. Добавьте в файл *ShoppingCart.aspx.CS* следующие разделы кода, выделенные желтым цветом:   

    [!code-csharp[Main](shopping-cart/samples/sample11.cs?highlight=9-11,33,44-89)]

Когда пользователь нажимает кнопку **Обновить** на странице *ShoppingCart. aspx* , вызывается метод упдатекартитемс. Метод Упдатекартитемс получает обновленные значения для каждого элемента в корзине для покупок. Затем метод Упдатекартитемс вызывает метод `UpdateShoppingCartDatabase` (добавлен и описан на следующем шаге) для добавления или удаления элементов из корзины для покупок. После обновления базы данных для отражения обновлений в корзине для покупок элемент управления **GridView** обновляется на странице Корзина для покупок путем вызова метода `DataBind` для **GridView**. Кроме того, Общая сумма заказа на странице покупательской корзины обновляется, чтобы отразить обновленный список элементов.

### <a name="updating-and-removing-shopping-cart-items"></a>Обновление и удаление элементов корзины для покупок

На странице *ShoppingCart. aspx* можно увидеть элементы управления, добавленные для обновления количества элементов и удаления элемента. Теперь добавьте код, который сделает эти элементы управления работоспособными.

1. В **Обозреватель решений**откройте файл *ShoppingCartActions.CS* в папке *Logic* .
2. Добавьте следующий код, выделенный желтым цветом, в файл класса *ShoppingCartActions.CS* :   

    [!code-csharp[Main](shopping-cart/samples/sample12.cs?highlight=99-213)]

Метод `UpdateShoppingCartDatabase`, вызываемый из метода `UpdateCartItems` на странице *ShoppingCart.aspx.CS* , содержит логику обновления или удаления элементов из корзины для покупок. Метод `UpdateShoppingCartDatabase` выполняет итерацию по всем строкам в списке покупательской корзины. Если элемент корзины для покупок был помечен для удаления или количество меньше единицы, вызывается метод `RemoveItem`. В противном случае элемент корзины для покупок проверяется на наличие обновлений при вызове метода `UpdateItem`. После удаления или обновления элемента корзины для покупок изменения базы данных сохраняются.

Структура `ShoppingCartUpdates` используется для хранения всех элементов корзины покупок. Метод `UpdateShoppingCartDatabase` использует структуру `ShoppingCartUpdates` для определения необходимости обновления или удаления какого либо из элементов.

В следующем руководстве вы будете использовать метод `EmptyCart` для очистки корзины для покупок после приобретения продуктов. Но пока вы будете использовать метод `GetCount`, который вы только что добавили в файл *ShoppingCartActions.CS* , чтобы определить, сколько элементов находится в корзине для покупок.

### <a name="adding-a-shopping-cart-counter"></a>Добавление счетчика корзины для покупок

Чтобы разрешить пользователю просматривать общее количество элементов в корзине для покупок, необходимо добавить счетчик на страницу *site. master* . Этот счетчик также будет действовать как ссылка на корзину для покупок.

1. В **Обозреватель решений**откройте страницу *site. master* .
2. Измените разметку, добавив ссылку счетчика корзины для покупок, как показано желтым цветом, в раздел навигации, чтобы он отображался следующим образом:  

    [!code-html[Main](shopping-cart/samples/sample13.html?highlight=6)]
3. Затем обновите код программной части файла *site.master.CS* , добавив код, выделенный желтым цветом, следующим образом:  

    [!code-csharp[Main](shopping-cart/samples/sample14.cs?highlight=11,77-84)]

Перед отображением страницы в формате HTML возникает событие `Page_PreRender`. В обработчике `Page_PreRender` общее число покупательской корзины определяется путем вызова метода `GetCount`. Возвращаемое значение добавляется к `cartCount`ному диапазону, включенному в разметку страницы *site. master* . Теги `<span>` позволяют правильно подготавливать внутренние элементы. При отображении любой страницы сайта отобразится итоговая корзина для покупок. Пользователь также может щелкнуть итог в корзине для покупок, чтобы отобразить корзину для покупок.

## <a name="testing-the-completed-shopping-cart"></a>Тестирование готовой корзины для покупок

Теперь можно запустить приложение, чтобы увидеть, как можно добавлять, удалять и обновлять элементы в корзине для покупок. Итоговая корзина для покупок будет отражать общую стоимость всех товаров в корзине для покупок.

1. Нажмите клавишу **F5** для запуска приложения.  
 Откроется браузер и отобразится страница *Default. aspx* .
2. В меню навигации по категориям выберите **автомобили** .
3. Щелкните ссылку **Добавить в корзину** рядом с первым продуктом.   
 Отобразится страница *ShoppingCart. aspx* с итоговым порядком.
4. В меню навигации по категориям выберите **плоскости** .
5. Щелкните ссылку **Добавить в корзину** рядом с первым продуктом.
6. Задайте количество первого элемента в корзине для покупок равным 3 и установите флажок **удалить элемент** второго элемента.<a id="a"></a>
7. Нажмите кнопку **Обновить** , чтобы обновить страницу покупательской корзины и отобразить новый итог заказа. 

    ![Корзина для покупок — обновление корзины](shopping-cart/_static/image9.png)

## <a name="summary"></a>Сводка

В этом руководстве вы создали корзину для работы с примером приложения веб-форм Wingtip Toys. Во время работы с этим руководством вы использовали Entity Framework Code First, заметки к данным, строго типизированные элементы управления данными и привязку модели.

Покупательская корзина поддерживает добавление, удаление и обновление элементов, выбранных пользователем для покупки. Помимо реализации функции корзины для покупок вы узнали, как отображать элементы корзины для покупок в элементе управления **GridView** и вычислять итоги заказа.

Чтобы понять, как описанная функциональность работает в реальных бизнес-приложениях, можно просмотреть пример корзины для покупок с открытым исходным кодом на основе [nopCommerce](https://github.com/nopSolutions/nopCommerce) -ASP.NET. Изначально она была разработана на основе веб-форм и в течение нескольких лет, которые были перенесены в MVC и теперь ASP.NET Core.

## <a name="addition-information"></a>Дополнительные сведения

[Общие сведения о состоянии сеанса ASP.NET](https://msdn.microsoft.com/library/ms178581.aspx)

> [!div class="step-by-step"]
> [Назад](display_data_items_and_details.md)
> [Вперед](checkout-and-payment-with-paypal.md)
