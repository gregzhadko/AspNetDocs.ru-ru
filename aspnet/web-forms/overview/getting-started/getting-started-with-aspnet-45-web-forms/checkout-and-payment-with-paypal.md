---
uid: web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
title: Оформление и оплата с помощью PayPal Документы Майкрософт
author: Erikre
description: Эта серия учебников научит вас основам создания приложения web-форм ASP.NET с использованием ASP.NET 4.5 и Microsoft Visual Studio Express 2013 для We...
ms.author: riande
ms.date: 09/08/2014
ms.assetid: 664ec95e-b0c9-4f43-a39f-798d0f2a7e08
msc.legacyurl: /web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
msc.type: authoredcontent
ms.openlocfilehash: 62d00a86c6c5845fb894896df65002c7086d039f
ms.sourcegitcommit: ce28244209db8615bc9bdd576a2e2c88174d318d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2020
ms.locfileid: "80675691"
---
# <a name="checkout-and-payment-with-paypal"></a>Оформление заказа и оплата по PayPal

[Эрик Рейтан](https://github.com/Erikre)

[Скачать Wingtip Игрушки Пример проекта (КЗ)](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) или [Скачать электронную книгу (PDF)](https://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20ASP.NET%204.5%20Web%20Forms%20and%20Visual%20Studio%202013.pdf)

> Эта серия учебников научит вас основам создания приложения ASP.NET Web Forms с использованием ASP.NET 4.5 и Microsoft Visual Studio Express 2013 для Web. Проект Visual Studio 2013 [с исходным кодом Си-Кз](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) доступен для сопровождения этой серии учебников.

В этом учебнике описывается, как изменить образец приложения Wingtip Toys, включив в него авторизацию, регистрацию и оплату с помощью PayPal. Только пользователи, которые вошли в систему, будут иметь разрешение на покупку продуктов. Встроенная функциональность регистрации пользователей шаблона ASP.NET web-forms 4.5 Web Forms уже включает в себя большую часть того, что вам нужно. Вы добавите функциональность PayPal Express Checkout. В этом учебнике вы используете среду тестирования разработчика PayPal, поэтому фактические средства не будут переведены. В конце урока вы проверите приложение, выбрав продукты для добавления в корзину, нажав кнопку оформления и перенося данные на веб-сайт тестирования PayPal. На веб-сайте тестирования PayPal вы подтвердите свою информацию о доставке и оплате, а затем вернетесь в местное приложение для получения образца Wingtip Toys для подтверждения и завершения покупки.

Есть несколько опытных сторонних платежных процессоров, которые специализируются на интернет-магазинах, которые касаются масштабируемости и безопасности. ASP.NET разработчики должны рассмотреть преимущества использования решения о платежах сторонних разработчиков перед внедрением решения для покупок и покупки.

> [!NOTE] 
> 
> Образец приложения Wingtip Toys был разработан с учетом конкретных ASP.NET концепций и функций, доступных ASP.NET веб-разработчикам. Это применение образца не было оптимизировано для всех возможных обстоятельств в отношении масштабируемости и безопасности.

## <a name="what-youll-learn"></a>Из этого руководства вы узнаете, как выполнять такие задачи:

- Как ограничить доступ к определенным страницам в папке.
- Как создать известную корзину из анонимной корзины.
- Как включить SSL для проекта.
- Как добавить поставщика OAuth в проект.
- Как использовать PayPal для покупки продуктов, использующих среду тестирования PayPal.
- Как отобразить детали от PayPal в **управлении DetailsView.**
- Как обновить базу данных приложения Wingtip Toys с деталями, полученными от PayPal.

## <a name="adding-order-tracking"></a>Добавление отслеживания заказов

В этом уроке вы создадите два новых класса для отслеживания данных из заказа, созданного пользователем. Классы будут отслеживать данные о доставке информации, общей сумме покупки и подтверждении оплаты.

### <a name="add-the-order-and-orderdetail-model-classes"></a>Добавить порядок и порядокDetail Модели классы

Ранее в этой серии учебников, вы определили схему для категорий, продуктов и корзины пунктов, создавая `Category` `Product`, и `CartItem` классы в папке *Модели.* Теперь вы добавите два новых класса для определения схемы для заказа продукта и деталей заказа.

1. В папку **«Модели»** добавьте новый класс под названием *Order.cs.*   
   Файл нового класса отображается в редакторе.
2. Замените его код по умолчанию на следующий код.   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample1.cs)]
3. Добавьте *OrderDetail.cs* класс в папку *«Модели».*
4. Замените код по умолчанию на приведенный ниже:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample2.cs)]

`Order` Классы `OrderDetail` содержат схему определения информации о заказе, используемой для покупки и доставки.

Кроме того, необходимо обновить класс контекста базы данных, который управляет классами сущностей и обеспечивает доступ к базе данных. Для этого вы добавите в `OrderDetail` `ProductContext` класс недавно созданные классы заказов и моделей.

1. В **Solution Explorer**найдите и откройте *ProductContext.cs* файл.
2. Добавьте выделенный код в файл *ProductContext.cs,* как показано ниже:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample3.cs?highlight=14-15)]

Как упоминалось ранее в этой серии учебников, код в *ProductContext.cs* файла добавляет пространство `System.Data.Entity` имен, так что у вас есть доступ ко всем основным функциональным возможностям рамочной системы entity. Эта функциональность включает в себя возможность запроса, вставки, обновления и удаления данных при работе с сильно набранными объектами. Вышеупомянутый код `ProductContext` в классе добавляет доступ `Order` к `OrderDetail` инфраструктуре сущности к вновь добавленным и классам.

## <a name="adding-checkout-access"></a>Добавление доступа к кассе

Образец приложения Wingtip Toys позволяет анонимным пользователям просматривать и добавлять продукты в корзину. Однако, когда анонимные пользователи предпочитают покупать продукты, которые они добавили в корзину, они должны войти на сайт. После входа в систему они могут получить доступ к ограниченным страницам веб-приложения, которые обрабатывают процесс оформления и покупки. Эти ограниченные страницы содержатся в папке *Checkout* приложения.

### <a name="add-a-checkout-folder-and-pages"></a>Добавить фадер и страницы для проверки

Теперь вы создадите папку *Checkout* и страницы в ней, которые клиент увидит во время процесса оформления. Вы будете обновлять эти страницы позже в этом учебнике.

1. Нажмите правой кнопкой мыши название проекта (**Wingtip Игрушки**) в **Solution Explorer** и выберите **Добавить новый Folder**. 

    ![Оформление и оплата с помощью PayPal - Новые Известия](checkout-and-payment-with-paypal/_static/image1.png)
2. Назовите новую папку *Checkout.*
3. Нажмите правой кнопкой папку *Checkout,* а затем выберите **Добавить**-&gt;**новый пункт.** 

    ![Оформление и оплата с помощью PayPal - Новый пункт](checkout-and-payment-with-paypal/_static/image2.png)
4. Откроется диалоговое окно **Добавление нового элемента** .
5. Выберите группу **веб-шаблонов** **Visual C'**  - &gt; слева. Затем, из среднего стекла, выберите **веб-форму с Master Page**и назовите ее *CheckoutStart.aspx*. 

    ![Оформление и оплата с помощью PayPal - Добавить новый элемент Диалог](checkout-and-payment-with-paypal/_static/image3.png)
6. Как и прежде, выберите файл *Site.Master* в качестве главной страницы.
7. Добавьте следующие дополнительные страницы в папку *Checkout,* используя те же следующие шаги:   

    - CheckoutReview.aspx
    - CheckoutComplete.aspx
    - CheckoutCancel.aspx
    - CheckoutError.aspx

### <a name="add-a-webconfig-file"></a>Добавить файл Web.config

Добавив новый файл *Web.config* в папку *Checkout,* вы сможете ограничить доступ ко всем страницам, содержащимся в папке.

1. Нажмите правой кнопкой папку *Checkout* и выберите **Добавить**  - &gt; **новый пункт**.  
   Откроется диалоговое окно **Добавление нового элемента** .
2. Выберите группу **веб-шаблонов** **Visual C'**  - &gt; слева. Затем, из среднего стекла, выберите **веб-файл конфигурации,** принять имя по умолчанию *Web.config*, а затем выберите **Добавить**.
3. Замените существующее XML-содержимое в файле *Web.config* на следующее:  

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample4.xml)]
4. Сохраните файл *Web.config*.

В файле *Web.config* указывается, что всем неизвестным пользователям веб-приложения должно быть отказано в доступе к страницам, содержащимся в папке *Checkout.* Однако, если пользователь зарегистрировал учетную запись и вошел в систему, он будет известным пользователем и будет иметь доступ к страницам в папке *Checkout.*

Важно отметить, что ASP.NET конфигурации следует иерархии, где каждый файл *Web.config* применяет настройки конфигурации к папке, в которой она находится, и ко всем каталогам детей под ней.

<a id="SSLWebForms"></a>
## <a name="enable-ssl-for-the-project"></a>Включение SSL для проекта

 Secure Sockets Layer (SSL) — это протокол, позволяющие веб-серверам и веб-клиентам более безопасно обмениваться данными с помощью шифрования. Если протокол SSL не используется, пакеты данных, передаваемые между клиентом и сервером, открыты для сканирования любому человеку с физическим доступом к сети. Кроме того, некоторые распространенные схемы проверки подлинности небезопасны при использовании простого HTTP. В частности, базовая проверка подлинности и формы проверки подлинности отправляют незашифрованные учетные данные. Чтобы обеспечить безопасность, эти схемы проверки подлинности должны использовать протокол SSL. 

1. В **Solution Explorer**нажмите на проект **WingtipToys,** а затем нажмите **F4,** чтобы отобразить окно **Properties.**
2. Изменение **SSL** `true`позволяет .
3. Скопируйте **URL-адрес SSL** для дальнейшего использования.   
 URL SSL `https://localhost:44300/` будет, если вы ранее не создали веб-сайты SSL (как показано ниже).   
    ![Свойства проекта](checkout-and-payment-with-paypal/_static/image4.png)
4. В **Solution Explorer**, право нажмите на проект **WingtipToys** и нажмите **Свойства**.
5. На левой вкладке щелкните **Интернет**.
6. Измените **Url проекта,** чтобы использовать **SSL URL,** сохраненный ранее.   
    ![Веб-свойства проекта](checkout-and-payment-with-paypal/_static/image5.png)
7. Сохраните страницу, нажав **CTRL+S**.
8. Нажмите **на Ctrl-F5,** чтобы запустить приложение. В Visual Studio будет отображаться параметр, который позволяет отключить предупреждающие сообщения SSL.
9. Нажмите **Да** , чтобы начать доверять сертификату IIS Express SSL и продолжить работу.   
    ![Сведения о сертификате IIS Express SSL](checkout-and-payment-with-paypal/_static/image6.png)  
  Отобразится предупреждение системы безопасности.
10. Нажмите **Да** , чтобы установить сертификат для вашего localhost.   
    ![Диалоговое окно "Предупреждение системы безопасности"](checkout-and-payment-with-paypal/_static/image7.png)  
  Откроется окно браузера.

Теперь вы можете легко протестировать веб-приложение локально с помощью SSL.

<a id="OAuthWebForms"></a>
## <a name="add-an-oauth-20-provider"></a>Добавление поставщика OAuth 2.0

Веб-формы ASP.NET предлагают расширенные параметры для членства и проверки подлинности. К этим расширениям относится OAuth. OAuth — это открытый протокол, обеспечивающий безопасную авторизацию простым и стандартным методом из веб-приложений, мобильных и настольных приложений. Шаблон ASP.NET Web Forms использует OAuth для того, чтобы разоблачить Facebook, Twitter, Google и Microsoft в качестве поставщиков аутентификации. В этом учебнике в качестве поставщика проверки подлинности используется только Google, но вы легко можете изменить код, чтобы использовать любой другой поставщик. Шаги по реализации других поставщиков очень похожи на шаги, представленные в этом учебнике.

Помимо проверки подлинности в учебнике будут использоваться роли для реализации авторизации. Только пользователи, добавленные в роль `canEdit` , смогут изменять данные (создавать, изменять и удалять контакты).

> [!NOTE] 
> 
> Приложения Windows Live принимают только url-адрес для рабочего веб-сайта, поэтому вы не можете использовать URL-адрес локального веб-сайта для тестирования логинов.

В последующих шагах вы сможете добавить поставщика проверки подлинности Google.

1. Откройте файл *App\_Start-Startup.Auth.cs.*
2. Удалите символы комментариев из метода `app.UseGoogleAuthentication()` , чтобы метод выглядел следующим образом: 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample5.cs)]
3. Перейдите к [Консоли разработчиков Google](https://console.developers.google.com/). Вам также потребуется выполнить вход со своей учетной записью электронной почты разработчика Google (gmail.com). Если отсутствует учетная запись Google, выберите ссылку **Создать учетную запись** .   
   Далее вы ознакомитесь с **консолью разработчиков Google**.   
    ![Консоли разработчиков Google](checkout-and-payment-with-paypal/_static/image8.png)
4. Нажмите кнопку **«Создать проект»** и введите имя проекта и идентификатор (можно использовать значения по умолчанию). Затем щелкните **флажок соглашения** и кнопку **«Создание».**  

    ![Google - Новый проект](checkout-and-payment-with-paypal/_static/image9.png)

    Через несколько секунд будет создан новый проект, а в браузере будет отображаться новая страница проектов.
5. В левой вкладке, нажмите **AIS &amp; auth**, а затем нажмите **credentials**.
6. Нажмите на **создание нового идентификатора клиента** под **OAuth**.   
   Откроется диалоговое окно **Создание идентификатора клиента** .   
    ![Google — создать идентификатор клиента](checkout-and-payment-with-paypal/_static/image10.png)
7. В диалоге **«Создать идентификатор клиента»** сохраните **web-приложение** по умолчанию для типа приложения.
8. Установите **авторизованные истоки JavaScript** на URL SSL, который вы использовали ранее в этом учебнике (если`https://localhost:44300/` вы не создали другие SSL-проекты).   
   Этот URL-адрес является источником вашего приложения. В нашем примере вводится только тестовый URL-адрес localhost. Тем не менее, можно ввести несколько URL-адресов для учета локального и производственного.
9. Задайте в поле **Авторизованный URI перенаправления** следующее значение: 

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample6.html)]

   Это значение представляет собой URI, который ASP.NET OAuth использует для обмена данными с сервером Google OAuth. Помните URL SSL, `https://localhost:44300/` который вы использовали выше (если вы не создали другие проекты SSL).
10. Нажмите кнопку **Create Client ID.**
11. В левом меню консоли Google Developers, нажмите пункт меню **экрана Согласие,** а затем установить адрес электронной почты и название продукта. Когда вы завершили форму, нажмите **Сохранить**.
12. Нажмите пункт меню **API,** прокрутите вниз и нажмите кнопку **выключения** рядом с **API Google.**   
    Принятие этой опции позволит aPI Google.
13. Вы также должны обновить пакет **Microsoft.Owin** NuGet до версии 3.0.0.   
    Из меню **Инструментов** выберите **менеджер пакетов NuGet,** а затем выберите **пакеты Управления NuGet для решения.**  
    Из окна **Пакетов Управления NuGet** найдите и обновите пакет **Microsoft.Owin** до версии 3.0.0.
14. В Visual Studio `UseGoogleAuthentication` обновите метод *Startup.Auth.cs* страницы, копируя и вставив в метод **идентификатор клиента** и **секрет клиента.** Значения **идентификатора клиента** и **клиентской тайны,** приведенные ниже, являются образцами и не будут работать. 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample7.cs?highlight=64-65)]
15. Нажмите **на CTRL-F5,** чтобы построить и запустить приложение. Щелкните ссылку **Войти в систему** .
16. Под **использованием другой службы для входа в систему,** нажмите **Google**.  
    ![Вход](checkout-and-payment-with-paypal/_static/image11.png)
17. Если будет необходимо ввести учетные данные, произойдет перенаправление на сайт Google, где можно будет ввести свои учетные данные.  
    ![Google — вход](checkout-and-payment-with-paypal/_static/image12.png)
18. После ввода учетных данных вам будет предложено дать разрешения только что созданного веб-приложению.  
    ![Учетная запись службы проекта по умолчанию](checkout-and-payment-with-paypal/_static/image13.png)
19. Нажмите **Принять**. Теперь вы будете перенаправлены обратно на страницу **Регистрации** приложения **WingtipToys,** где вы можете зарегистрировать свою учетную запись Google.  
    ![Регистрация с помощью учетной записи Google](checkout-and-payment-with-paypal/_static/image14.png)
20. У вас есть возможность изменить локальное имя регистрации электронной почты, используемое для вашей учетной записи Gmail, но вы, как правило, хотите сохранить псевдоним электронной почты по умолчанию (то есть тот, который вы использовали для проверки подлинности). Нажмите **Войти в,** как показано выше.

### <a name="modifying-login-functionality"></a>Изменение функциональности входа

Как упоминалось ранее в этой серии учебников, большая часть функциональности регистрации пользователей была включена в шаблон ASP.NET Web Forms по умолчанию. Теперь вы измените страницы *Login.aspx* и *Register.aspx* по умолчанию для вызова метода. `MigrateCart` Метод `MigrateCart` связывает недавно зарегистрированного пользователя с анонимной корзиной. Связывая пользователя и корзину, образец приложения Wingtip Toys сможет поддерживать корзину между посещениями.

1. В **Solution Explorer**найдите и откройте папку *счета.*
2. Измените страницу с кодом, названную *Login.aspx.cs* включить код, выделенный желтым цветом, чтобы он отосвазался следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample8.cs?highlight=41-43)]
3. Сохранить *файл Login.aspx.cs.*

На данный момент можно проигнорировать предупреждение об `MigrateCart` отсутствии определения метода. Вы будете добавлять его немного позже в этом учебнике.

Файл *Login.aspx.cs* за кодом поддерживает метод LogIn. При осмотре страницы Login.aspx вы увидите, что эта страница включает в себя `LogIn` кнопку "Вход в систему", которая при нажатии нажимает обработчик на коде сзади.

При `Login` вызове метода на *Login.aspx.cs* создается новый `usersShoppingCart` экземпляр названной корзины. Идентификатор корзины (GUID) извлекается `cartId` и устанавливается на переменную. `MigrateCart` Затем метод вызывается, передавая `cartId` этому методу как имя, так и имя зарегистрированного пользователя. При миграции корзины GUID, используемой для идентификации анонимной корзины, заменяется именем пользователя.

В дополнение к изменению *Login.aspx.cs* файла с кодом для переноса корзины при входе пользователя в систему необходимо также изменить *Register.aspx.cs файл с кодом,* чтобы перенести корзину, когда пользователь создает новую учетную запись и входит в систему.

1. В папке *Счета* откройте файл с кодом под названием *Register.aspx.cs*.
2. Изменяем файл сзади кода, включив код в желтый цвет, чтобы он отосвазан следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample9.cs?highlight=28-32)]
3. Сохранить *файл Register.aspx.cs.* Еще раз, игнорировать предупреждение `MigrateCart` о методе.

Обратите внимание, что код, используемый в обработчике `CreateUser_Click` `LogIn` событий, очень похож на код, который использовался в методе. Когда пользователь регистрируется или входит в сайт, будет `MigrateCart` сделан звонок на метод.

## <a name="migrating-the-shopping-cart"></a>Миграция корзины

Теперь, когда процесс входа в систему и регистрации обновлен, можно `MigrateCart` добавить код для переноса корзины с помощью метода.

1. В **Solution Explorer**найдите папку *логики* и откройте файл *класса ShoppingCartActions.cs.*
2. Добавьте код, выделенный желтым цветом, к существующему коду в *ShoppingCartActions.cs* файле, чтобы код в *ShoppingCartActions.cs* файле отогнал следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample10.cs?highlight=215-224)]

Метод `MigrateCart` использует существующий cartId для поиска корзины пользователя. Далее код просматривает все элементы корзины `CartId` и заменяет свойство (как указано `CartItem` в схеме) на имя пользователя, зарегистрированного в журнале.

### <a name="updating-the-database-connection"></a>Обновление подключения к базе данных

Если вы следите за этим учебником, используя **предварительно построенное** приложение Wingtip Toys, необходимо воссоздать базу данных членства по умолчанию. Изменяя строку соединения по умолчанию, база данных членства будет создана при следующем запуске приложения.

1. Откройте файл *Web.config* в корне проекта.
2. Обновление строки соединения по умолчанию так, чтобы она отослалася следующим образом:   

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample11.xml)]

<a id="PayPalWebForms"></a>
## <a name="integrating-paypal"></a>Интеграция PayPal

PayPal - это веб-платежная платформа, которая принимает платежи онлайн-торговцев. Далее в этом уроке объясняется, как интегрировать функцию Экспресс-кассы PayPal в ваше приложение. Экспресс-касса позволяет вашим клиентам использовать PayPal для оплаты товаров, которые они добавили в корзину.

### <a name="create-paypal-test-accounts"></a>Создание тестовых учетных записей PayPal

Чтобы использовать среду тестирования PayPal, необходимо создать и проверить тестовую учетную запись разработчика. Вы будете использовать тестовую учетную запись разработчика для создания тестовой учетной записи покупателя и тестовой учетной записи продавца. Учетные данные учетной записи тестирования разработчика также позволят образецу приложения Wingtip Toys получить доступ к среде тестирования PayPal.

1. В браузере перейдите на сайт тестирования разработчиков PayPal:   
    [https://developer.paypal.com](https://developer.paypal.com/)
2. Если у вас нет учетной записи разработчика PayPal, создайте новую учетную запись, нажав **на кнопку Зарегистрируйтесь**и после того, как вы можете зарегистрироваться. Если у вас есть существующая учетная запись разработчика PayPal, войдите в систему, нажав **на Log In**. Вам понадобится ваша учетная запись разработчика PayPal для тестирования образец приложения Wingtip Toys позже в этом учебнике.
3. Если вы только что зарегистрировались на учетную запись разработчика PayPal, возможно, вам придется проверить свою учетную запись разработчика PayPal в PayPal. Вы можете проверить свою учетную запись, выполнив шаги, которые PayPal отправил аименной учетной записи электронной почты. После проверки учетной записи разработчика PayPal войдите обратно на сайт тестирования разработчиков PayPal.
4. После входа в систему на сайт разработчика PayPal с учетной записью разработчика PayPal вам необходимо создать тестовую учетную запись покупателя PayPal, если у вас ее еще нет. Чтобы создать тестовую учетную запись покупателя, на сайте PayPal нажмите на вкладку **Приложения,** а затем нажмите **sandbox счета**.   
 Отображается страница **учетных записей теста Sandbox.**   

    > [!NOTE] 
    > 
    > Сайт Разработчика PayPal уже предоставляет учетную запись торгового теста.

    ![Оформление и оплата с помощью тестовых учетных записей PayPal - Sandbox](checkout-and-payment-with-paypal/_static/image15.png)
5. На странице тестовых учетных записей Sandbox нажмите **«Создайте учетную запись».**
6. На странице **тестовой учетной записи Create** выберите электронную почту тестовой учетной записи покупателя и пароль по вашему выбору.   

    > [!NOTE] 
    > 
    > Вам понадобится адреса электронной почты покупателя и пароль для проверки Wingtip Игрушки образца приложения в конце этого учебника.

    ![Оформление и оплата с помощью тестовых учетных записей PayPal - Sandbox](checkout-and-payment-with-paypal/_static/image16.png)
7. Создайте тестовую учетную запись покупателя, нажав кнопку **«Создать учетную запись».**  
 Отображается страница **учетных записей Sandbox Test.** 

    ![Оформление и оплата с помощью PayPal - Счета PayPal](checkout-and-payment-with-paypal/_static/image17.png)
8. На странице **тестовых учетных записей Sandbox** щелкните учетную запись электронной почты **посредника.**  
    **Появляются** параметры профиля и **уведомления.**
9. Выберите опцию **Профиля,** а затем нажмите **учетные данные API,** чтобы просмотреть учетные данные API для учетной записи тестового торгового центра.
10. Копирование учетных данных TEST API в блокнот.

Вам понадобятся отображенные учетные данные Classic TEST API (имя пользователя, пароль и подпись) для того, чтобы делать вызовы API из примерного приложения Wingtip Toys в среду тестирования PayPal. Вы добавите учетные данные на следующем этапе.

### <a name="add-paypal-class-and-api-credentials"></a>Добавление учетных данных класса PayPal и API

Вы разместите большую часть кода PayPal в одном классе. Этот класс содержит методы, используемые для связи с PayPal. Кроме того, вы добавите свои учетные данные PayPal в этот класс.

1. В Wingtip Игрушки образца приложения в Visual Studio, право йгнул папку **логики,** а затем выберите **Добавить**  - &gt; **новый пункт**.   
   Откроется диалоговое окно **Добавление нового элемента** .
2. Под **визуальным C'** из **установленного** стекла слева выберите **Код**.
3. Из среднего стекла выберите **класс.** Назовите этот новый класс **PayPalFunctions.cs**.
4. Нажмите кнопку **Добавить**.  
   Файл нового класса отображается в редакторе.
5. Замените код по умолчанию на приведенный ниже:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample12.cs)]
6. Добавьте учетные данные Торгового API (имя пользователя, пароль и подпись), которые вы отображали ранее в этом учебнике, чтобы вы могли совершать вызовы функций в среду тестирования PayPal.  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample13.cs)]

> [!NOTE] 
> 
> В этом примере приложения вы просто добавляете учетные данные в файл C's (.cs). Однако в реализованном решении следует рассмотреть вопрос о шифровании учетных данных в файле конфигурации.

Класс NVPAPICaller содержит большую часть функциональности PayPal. Код в классе предоставляет методы, необходимые для тестовой покупки в среде тестирования PayPal. Для совершения покупок используются следующие три функции PayPal:

- Функция `SetExpressCheckout`
- Функция `GetExpressCheckoutDetails`
- Функция `DoExpressCheckoutPayment`

Метод `ShortcutExpressCheckout` собирает информацию о покупке теста и детали продукта `SetExpressCheckout` из корзины и вызывает функцию PayPal. Метод `GetCheckoutDetails` подтверждает детали покупки и `GetExpressCheckoutDetails` вызывает функцию PayPal перед сделать покупку испытания. Метод `DoCheckoutPayment` завершает тестовую покупку из среды `DoExpressCheckoutPayment` тестирования, позвонив в функцию PayPal. Оставшийся код поддерживает методы и процесс PayPal, такие как кодирование строк, декодирование строк, обработка массивов и определение учетных данных.

> [!NOTE] 
> 
> PayPal позволяет включать дополнительные сведения о покупке на основе [спецификации API PayPal.](https://cms.paypal.com/us/cgi-bin/?cmd=_render-content&amp;content_ID=developer/e_howto_api_nvp_r_SetExpressCheckout) Расширяя код в примере приложения Wingtip Toys, вы можете включить детали локализации, описания продуктов, налог, номер обслуживания клиентов, а также многие другие дополнительные поля.

Обратите внимание, что при возврате и отмене URL-адресов, указанных в методе **ShortcutExpressCheckout,** используется номер порта.

[!code-html[Main](checkout-and-payment-with-paypal/samples/sample14.html)]

Когда Визуальный веб-разработчик запускает веб-проект с использованием SSL, обычно порт 44300 используется для веб-сервера. Как показано выше, номер порта 44300. При запуске приложения можно было увидеть другой номер порта. Ваш номер порта должен быть правильно установлен в коде, так что вы можете успешно запустить Wingtip Toys пример приложения в конце этого учебника. В следующем разделе этого учебника объясняется, как получить номер порта местного хозяина и обновить класс PayPal.

### <a name="update-the-localhost-port-number-in-the-paypal-class"></a>Обновление номера порта LocalHost в классе PayPal

Образец приложения Wingtip Toys припокупки продуктов, передвигаясь на полигон PayPal и возвращаясь к локальному экземпляру образца приложения Wingtip Toys. Для того, чтобы PayPal вернулся к правильному URL-адресу, необходимо указать номер порта локально работаемого образца приложения в коде PayPal, упомянутом выше.

1. Нажмите правой кнопкой мыши название проекта (**WingtipToys**) в **Solution Explorer** и выберите **Свойства**.
2. В левой колонке выберите **вкладку Web.**
3. Извлеките номер порта из коробки **Project Url.**
4. При необходимости `returnURL` обновите и `cancelURL` `NVPAPICaller`в классе PayPal () в файле *PayPalFunctions.cs* использовать номер порта вашего веб-приложения:   

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample15.html?highlight=1-2)]

Теперь код, который вы добавили, будет соответствовать ожидаемому порту для локального веб-приложения. PayPal сможет вернуться к правильному URL-адресу на локальной машине.

### <a name="add-the-paypal-checkout-button"></a>Добавить кнопку PayPal Оформление

Теперь, когда основные функции PayPal были добавлены в пример приложения, вы можете начать добавлять разметку и код, необходимый для вызова этих функций. Во-первых, необходимо добавить кнопку оформления чека, которую пользователь увидит на странице корзины.

1. Откройте файл *ShoppingCart.aspx.*
2. Прокрутите в нижней `<!--Checkout Placeholder -->` части файла и найдите комментарий.
3. Замените комментарий `ImageButton` элементом управления, чтобы разметка была заменена следующим образом:  

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample16.aspx)]
4. В *ShoppingCart.aspx.cs* файле `UpdateBtn_Click` после того, как обработчик `CheckOutBtn_Click` события приближается к концу файла, добавьте обработчик события:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample17.cs)]
5. Также в *ShoppingCart.aspx.cs* файла добавьте `CheckoutBtn`ссылку на кнопку ,, чтобы новая кнопка изображения была отсылка следующим образом:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample18.cs?highlight=18)]
6. Сохраните изменения как в файле *ShoppingCart.aspx,* так и в *ShoppingCart.aspx.cs* файле.
7. Из меню выберите **Debug**-&gt;**Build WingtipToys.**  
   Проект будет перестроен с помощью недавно добавленного управления **ImageButton.**

### <a name="send-purchase-details-to-paypal"></a>Отправка информации о покупках в PayPal

Когда пользователь нажимает кнопку **Оформление** на странице корзины покупок *(ShoppingCart.aspx),* они начнут процесс покупки. Следующий код вызывает первую функцию PayPal, необходимую для покупки продуктов.

1. Из папки *Checkout* откройте файл с кодом под названием *CheckoutStart.aspx.cs.*   
   Обязательно откройте файл с кодом.
2. Замените существующий код следующим кодом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample19.cs)]

Когда пользователь приложения нажимает кнопку **Оформления** на странице корзины, браузер будет перемещаться по странице *CheckoutStart.aspx.* При загрузке страницы *CheckoutStart.aspx* `ShortcutExpressCheckout` метод вызывается. В этот момент пользователь передается на веб-сайт тестирования PayPal. На сайте PayPal пользователь вводит свои учетные данные PayPal, просматривает сведения о покупке, принимает соглашение PayPal и возвращается в примерное приложение Wingtip Toys, где `ShortcutExpressCheckout` метод завершается. Когда `ShortcutExpressCheckout` метод будет завершен, он перенаправит пользователя на страницу *CheckoutReview.aspx,* указанную в методе. `ShortcutExpressCheckout` Это позволяет пользователю просматривать детали заказа из примера приложения Wingtip Toys.

### <a name="review-order-details"></a>Подробная информация о заказе

После возвращения из PayPal, *CheckoutReview.aspx* страница Wingtip Игрушки образца приложения отображает детали заказа. Эта страница позволяет пользователю просматривать детали заказа перед покупкой продуктов. Страница *CheckoutReview.aspx* должна быть создана следующим образом:

1. В папке *Checkout* откройте страницу под названием *CheckoutReview.aspx*.
2. Замените существующую разметку следующим:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample20.aspx)]
3. Откройте страницу с кодом с названием *CheckoutReview.aspx.cs* и замените существующий код следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample21.cs)]

Элемент управления **DetailsView** используется для отображения деталей заказа, которые были возвращены из PayPal. Кроме того, приведенный выше код сохраняет сведения о заказе в базе данных Wingtip Toys как `OrderDetail` объект. Когда пользователь нажимает на кнопку **«Полный заказ»,** он перенаправляется на страницу *CheckoutComplete.aspx.*

> [!NOTE] 
> 
> **Совет**
> 
> На разметке страницы *CheckoutReview.aspx* `<ItemStyle>` обратите внимание, что тег используется для изменения стиля элементов в элементах управления **DetailsView** в нижней части страницы. Просматривая страницу в **Design View** (выбрав **Дизайн** в левом нижнем углу Visual Studio), затем выбрав управление **DetailsView** и выбрав **Smart Tag** (значок стрелки в правом верхнем углу элемента управления), вы сможете увидеть **задачи DetailsView.**
> 
> ![Оформление и оплата с помощью PayPal - Отстеченные поля](checkout-and-payment-with-paypal/_static/image18.png)
> 
> При выборе **Edit Fields**появится диалоговая коробка **Fields.** В этом диалоговом поле вы можете легко управлять визуальными свойствами, такими как **ItemStyle,** управления **DetailsView.**
> 
> ![Оформление и оплата с помощью PayPal - Fields Dialog](checkout-and-payment-with-paypal/_static/image19.png)

### <a name="complete-purchase"></a>Полная покупка

*CheckoutComplete.aspx* страница делает покупку от PayPal. Как уже упоминалось выше, пользователь должен нажать на кнопку **Полный заказ,** прежде чем приложение будет перемещаться на странице *CheckoutComplete.aspx.*

1. В папке *Checkout* откройте страницу под названием *CheckoutComplete.aspx*.
2. Замените существующую разметку следующим:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample22.aspx)]
3. Откройте страницу с кодом под названием *CheckoutComplete.aspx.cs* и замените существующий код следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample23.cs)]

При загрузке страницы *CheckoutComplete.aspx* `DoCheckoutPayment` метод вызывается. Как упоминалось `DoCheckoutPayment` ранее, метод завершает покупку из среды тестирования PayPal. После того, как PayPal завершила покупку заказа, страница *CheckoutComplete.aspx* отображает платежную транзакцию `ID` покупателю.

### <a name="handle-cancel-purchase"></a>Ручка Отменить покупку

Если пользователь решит отменить покупку, он будет направлен на страницу *CheckoutCancel.aspx,* где он увидит, что его заказ отменен.

1. Откройте страницу под названием *CheckoutCancel.aspx* в папке *Checkout.*
2. Замените существующую разметку следующим:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample24.aspx)]

### <a name="handle-purchase-errors"></a>Обработка ошибок покупки

Ошибки во время процесса покупки будут обрабатываться на странице *CheckoutError.aspx.* Код-за *страницы CheckoutStart.aspx,* *CheckoutReview.aspx* страницы, и *CheckoutComplete.aspx* страница будет каждый перенаправить на *странице CheckoutError.aspx,* если ошибка происходит.

1. Откройте страницу под названием *CheckoutError.aspx* в папке *Checkout.*
2. Замените существующую разметку следующим:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample25.aspx)]

Страница *CheckoutError.aspx* отображается с деталями ошибки, когда ошибка происходит во время процесса оформления.

## <a name="running-the-application"></a>Запуск приложения

Запустите приложение, чтобы узнать, как приобрести продукты. Обратите внимание, что вы будете работать в среде тестирования PayPal. Никакие фактические деньги не обмениваются.

1. Убедитесь, что все ваши файлы сохранены в Visual Studio.
2. Откройте веб-браузер [https://developer.paypal.com](https://developer.paypal.com/)и перейдите к .
3. Войти с вашей учетной записью разработчика PayPal, которую вы создали ранее в этом учебнике.  
   Для песочницы разработчика PayPal необходимо войти в [https://developer.paypal.com](https://developer.paypal.com/) систему для тестирования экспресс-кассы. Это относится только к тестированию песочницы PayPal, а не к живой среде PayPal.
4. В Visual Studio нажмите **F5,** чтобы запустить образец приложения Wingtip Toys.  
   После восстановления базы данных браузер откроется и покажет страницу *Default.aspx.*
5. Добавьте три различных продукта в корзину, выбрав категорию продукта, например ,Cars", а затем нажав Добавить в **корзину** рядом с каждым продуктом.  
   В корзине будет отображаться выбранный вами продукт.
6. Нажмите кнопку **PayPal** для оформления регистрации. 

    ![Оформление и оплата с Помощью PayPal - Корзина](checkout-and-payment-with-paypal/_static/image20.png)

   Выезд потребует, чтобы у вас была учетная запись пользователя для образца приложения Wingtip Toys.
7. Нажмите на ссылку **Google** справа от страницы, чтобы войти в систему с существующей учетной записью электронной почты gmail.com.  
   Если у вас нет gmail.com учетной записи, вы можете создать ее для тестирования в [www.gmail.com](https://www.gmail.com/). Вы также можете использовать стандартный локальный аккаунт, нажав кнопку "Регистрация". 

    ![Оформление и оплата с помощью PayPal - Войти в систему](checkout-and-payment-with-paypal/_static/image21.png)
8. Вопийте с учетной записью gmail и паролем. 

    ![Оформление и оплата с помощью PayPal - Gmail Войти](checkout-and-payment-with-paypal/_static/image22.png)
9. Нажмите кнопку **входа в систему,** чтобы зарегистрировать свою учетную запись gmail с вашим именем пользователя образца приложения Wingtip Toys. 

    ![Оформление и оплата с помощью PayPal - Регистрационный счет](checkout-and-payment-with-paypal/_static/image23.png)
10. На тестовом сайте PayPal добавьте адрес электронной почты **покупателя** и пароль, созданный ранее в этом учебнике, а затем нажмите кнопку **входа в систему.** 

    ![Оформление и оплата с помощью PayPal - PayPal Войти](checkout-and-payment-with-paypal/_static/image24.png)
11. Согласитесь с политикой PayPal и нажмите кнопку **«Согласен и продолжайте».**  
    Обратите внимание, что эта страница отображается только при первом использовании этой учетной записи PayPal. Опять же обратите внимание, что это тестовый счет, никаких реальных денег не обменивается. 

    ![Оформление и оплата с помощью PayPal - Политика PayPal](checkout-and-payment-with-paypal/_static/image25.png)
12. Просмотрите информацию о заказе на странице обзора среды тестирования PayPal и нажмите **Кнопка Продолжить**. 

    ![Оформление и оплата с помощью PayPal - Информация о просмотре](checkout-and-payment-with-paypal/_static/image26.png)
13. На странице *CheckoutReview.aspx* проверьте сумму заказа и просмотрите сгенерированный адрес доставки. Затем нажмите кнопку **«Полный заказ».** 

    ![Оформление заказа и оплата с помощью PayPal - Обзор заказа](checkout-and-payment-with-paypal/_static/image27.png)
14. Страница **CheckoutComplete.aspx** отображается с идентификатором платежной транзакции. 

    ![Оформление и оплата с Помощью PayPal - Оформление завершено](checkout-and-payment-with-paypal/_static/image28.png)

<a id="ReviewDBWebForms"></a>
## <a name="reviewing-the-database"></a>Обзор базы данных

Изучив обновленные данные в базе примеров приложений Wingtip Toys после запуска приложения, можно увидеть, что приложение успешно зафиксировало покупку продуктов.

Вы можете проверить данные, содержащиеся в файле базы данных *Wingtiptoys.mdf,* используя окно **Database Explorer** (окно**Server Explorer** в Visual Studio), как это было ранее в этой серии учебников.

1. Закройте окно браузера, если оно все еще открыто.
2. В Visual Studio выберите значок **Show All Files** в верхней части Solution **Explorer,** чтобы расширить папку **\_App Data.**
3. Расширьте папку **\_App Data.**  
 Возможно, вам придется выбрать значок **Show All Files** для папки.
4. Справа щелкните файл базы данных *Wingtiptoys.mdf* и выберите **Open.**  
    **Отображается исследователь серверов.**
5. Разверните папку **Таблицы**.
6. Нажмите правой кнопкой мыши таблицы **заказов**и выберите **Показать таблицы данных**.  
 Отображается таблица **заказов.**
7. Просмотрите столбец **PaymentTransactionID** для подтверждения успешных транзакций. 

    ![Оформление и оплата с помощью PayPal - База данных обзоров](checkout-and-payment-with-paypal/_static/image29.png)
8. Закройте окно таблицы **Заказов.**
9. В Server Explorer щелкните по таблице **OrderDetails** и выберите **Данные таблицы Show**Table.
10. `OrderId` Просмотрите `Username` и значения в таблице **OrderDetails.** Обратите внимание, что `OrderId` эти `Username` значения соответствуют значениям и значениям, включенным в таблицу **заказов.**
11. Закройте окно стола **OrderDetails.**
12. Нажмите правой кнопкой мыши файл базы данных Wingtip Toys *(Wingtiptoys.mdf)* и выберите **Close Connection.**
13. Если вы не видите окно **Solution Explorer,** нажмите **Solution Explorer** в нижней части окна **Server Explorer,** чтобы показать **Explorer решений** снова.

## <a name="summary"></a>Сводка

В этом учебнике вы добавили схемы заказа и заказа деталей для отслеживания покупки продуктов. Вы также интегрировали функциональность PayPal в образец приложения Wingtip Toys.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Обзор конфигурации ASP.NET](https://msdn.microsoft.com/library/ms178683(v=vs.100).aspx)  
[Развертывание приложения «Безопасные ASP.NET веб-формы» с членством, Базой данных OAuth и S'L в службу приложений Azure](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-deploy-aspnet-webforms-app-membership-oauth-sql-database/)  
[Microsoft Azure - Бесплатная пробная версия](https://azure.microsoft.com/pricing/free-trial/)

## <a name="disclaimer"></a>Отказ от ответственности

Этот учебник содержит пример кода. Такой пример кода предоставляется "как есть" без гарантии любого рода. Соответственно, корпорация Майкрософт не гарантирует точность, целостность или качество образца кода. Вы соглашаетесь использовать образец кода на свой страх и риск. Ни при каких обстоятельствах корпорация Майкрософт не несет ответственности перед вами в любом случае за любой образец кода, содержания, включая, но не ограничивающихся, любые ошибки или упущения в любом образе кода, содержании или любых потерях или повреждениях любого рода, понесенных в результате использования любого образца кода. Настоящим вы уведомлены и делать настоящим согласиться на возмещение, сохранить и держать Microsoft безвредны от и против любых и всех потерь, претензий потери, травмы или повреждения любого рода, включая, без ограничений, тех, которые вызваны или вытекающих из материала, который вы публикуете, передавать, использовать или полагаться на в том числе, но не ограничиваясь, мнения, выраженные в ней.

> [!div class="step-by-step"]
> [Назад](shopping-cart.md)
> [Вперед](membership-and-administration.md)
