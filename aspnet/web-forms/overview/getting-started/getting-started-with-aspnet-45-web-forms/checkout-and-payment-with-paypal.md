---
uid: web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
title: Оформление и оплата с помощью PayPal | Документация Майкрософт
author: Erikre
description: В этой серии руководств вы узнаете об основах создания приложения ASP.NET Web Forms с помощью ASP.NET 4,5 и Microsoft Visual Studio Express 2013...
ms.author: riande
ms.date: 09/08/2014
ms.assetid: 664ec95e-b0c9-4f43-a39f-798d0f2a7e08
msc.legacyurl: /web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
msc.type: authoredcontent
ms.openlocfilehash: 62d00a86c6c5845fb894896df65002c7086d039f
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74615150"
---
# <a name="checkout-and-payment-with-paypal"></a>Оформление заказа и оплата по PayPal

по [Эрик Реитан](https://github.com/Erikre)

[Скачайте образец проекта Wingtip Toys (C#)](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) или [Загрузите электронную книгу (PDF)](https://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20ASP.NET%204.5%20Web%20Forms%20and%20Visual%20Studio%202013.pdf)

> В этой серии руководств вы узнаете об основах создания приложения ASP.NET Web Forms с помощью ASP.NET 4,5 и Microsoft Visual Studio Express 2013 для Web. Для этой серии руководств доступен [проект Visual Studio 2013 с C# исходным кодом](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) .

В этом руководстве описывается, как изменить пример приложения Wingtip Toys, чтобы включить авторизацию пользователей, регистрацию и оплату с помощью PayPal. Только пользователи, вошедшие в систему, будут иметь авторизацию для приобретения продуктов. Встроенные функции регистрации пользователей в шаблоне проекта веб-форм ASP.NET 4,5 уже содержат много необходимых вам возможностей. Вы добавите функцию PayPal Express recheckout. В этом учебнике вы используете среду тестирования для разработчиков PayPal, поэтому фактические фонды не передаются. По завершении работы с этим руководством вы протестируете приложение, выбрав продукты для добавления в корзину покупок, нажав кнопку извлечь и передавая данные на веб-сайт тестирования PayPal. На веб-сайте тестирования PayPal вы подтвердите сведения о доставке и оплате, а затем вернитесь к локальному примеру приложения Wingtip Toys, чтобы подтвердить и завершить покупку.

Существует несколько опытных процессорных платежных систем, специализирующихся на интерактивных покупках, которые устраняют масштабируемость и безопасность. Разработчикам ASP.NET следует рассмотреть преимущества использования стороннего платежного решения перед внедрением решения по покупке и покупке.

> [!NOTE] 
> 
> Пример приложения Wingtip Toys был разработан для отображения конкретных понятий и функций ASP.NET, доступных для веб-разработчиков ASP.NET. Этот пример приложения не был оптимизирован для всех возможных обстоятельств в отношении масштабируемости и безопасности.

## <a name="what-youll-learn"></a>Что вы узнаете:

- Ограничение доступа к определенным страницам в папке.
- Как создать известную корзину для покупок из корзины анонимных покупок.
- Включение SSL для проекта.
- Добавление поставщика OAuth в проект.
- Использование PayPal для приобретения продуктов с помощью среды тестирования PayPal.
- Отображение сведений из PayPal в элементе управления **DetailsView** .
- Обновление базы данных приложения Wingtip Toys с помощью сведений, полученных из PayPal.

## <a name="adding-order-tracking"></a>Добавление отслеживания заказов

В этом учебнике вы создадите два новых класса для мониторинга данных из заказа, созданного пользователем. Классы будут отслеживанием данных о доставке, общем количестве покупок и подтверждении оплаты.

### <a name="add-the-order-and-orderdetail-model-classes"></a>Добавление классов Order и OrderDetail Model

Ранее в этой серии руководств вы определили схему для элементов «категории», «продукты» и «корзина», создав классы `Category`, `Product`и `CartItem` в папке *Models* . Теперь вы добавите два новых класса для определения схемы для заказа продукта и подробностей заказа.

1. В папке **Models** добавьте новый класс с именем *Order.CS*.   
   В редакторе отобразится новый файл класса.
2. Замените его код по умолчанию на следующий код.   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample1.cs)]
3. Добавьте класс *OrderDetail.CS* в папку *Models* .
4. Замените код по умолчанию следующим кодом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample2.cs)]

Классы `Order` и `OrderDetail` содержат схему для определения сведений о заказах, используемых для приобретения и доставки.

Кроме того, необходимо обновить класс контекста базы данных, управляющий классами сущностей и предоставляющий доступ к базе данных. Для этого вы добавите новые классы Order и `OrderDetail` модели в `ProductContext` класс.

1. В **Обозреватель решений**найдите и откройте файл *ProductContext.CS* .
2. Добавьте выделенный код в файл *ProductContext.CS* , как показано ниже:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample3.cs?highlight=14-15)]

Как упоминалось ранее в этой серии руководств, код в файле *ProductContext.CS* добавляет пространство имен `System.Data.Entity`, чтобы получить доступ ко всем основным функциональным возможностям Entity Framework. Эта функция включает в себя возможность запрашивать, вставлять, обновлять и удалять данные, работая со строго типизированными объектами. Приведенный выше код класса `ProductContext` добавляет Entity Framework доступ к вновь добавленным классам `Order` и `OrderDetail`.

## <a name="adding-checkout-access"></a>Добавление доступа для извлечения

Пример приложения Wingtip Toys позволяет анонимным пользователям просматривать и добавлять продукты в корзину для покупок. Однако, если анонимные пользователи решили приобрести продукты, добавленные в корзину для покупок, они должны войти на сайт. После входа они могут получить доступ к ограниченным страницам веб-приложения, которые обрабатывают процесс извлечения и приобретения. Эти страницы с ограниченным доступом содержатся в папке *извлечения* приложения.

### <a name="add-a-checkout-folder-and-pages"></a>Добавление папки и страниц извлечения

Теперь вы создадите папку *извлечения* и страницы в ней, которые клиент увидит в процессе извлечения. Эти страницы будут обновлены далее в этом руководстве.

1. Щелкните правой кнопкой мыши имя проекта (**Wingtip Toys**) в **Обозреватель решений** и выберите пункт **Добавить новую папку**. 

    ![Оформление и оплата с помощью PayPal — Новая папка](checkout-and-payment-with-paypal/_static/image1.png)
2. Назовите новую папку для *извлечения*.
3. Щелкните правой кнопкой мыши папку *Checkout* и выберите **Добавить**-&gt;**новый элемент**. 

    ![Оформление и оплата с помощью PayPal — новый элемент](checkout-and-payment-with-paypal/_static/image2.png)
4. Откроется диалоговое окно **Добавление нового элемента**.
5. Выберите в левой части группы **веб-** шаблоны **Visual C#**  -&gt;. Затем в средней области выберите **веб-форма с главной страницей**и назовите ее *чеккаутстарт. aspx*. 

    ![Оформление и оплата с помощью PayPal — диалоговое окно добавления нового элемента](checkout-and-payment-with-paypal/_static/image3.png)
6. Как и ранее, выберите файл *site. master* в качестве главной страницы.
7. Добавьте следующие дополнительные страницы в папку *Checkout* , выполнив те же действия.   

    - Чеккаутревиев. aspx
    - Чеккауткомплете. aspx
    - Чеккаутканцел. aspx
    - Чеккаутеррор. aspx

### <a name="add-a-webconfig-file"></a>Добавление файла Web. config

Добавив новый файл *Web. config* в папку *Checkout* , вы сможете ограничить доступ ко всем страницам, содержащимся в папке.

1. Щелкните правой кнопкой мыши папку *Checkout* и выберите **Добавить** -&gt; **новый элемент**.  
   Откроется диалоговое окно **Добавление нового элемента**.
2. Выберите в левой части группы **веб-** шаблоны **Visual C#**  -&gt;. Затем в средней области выберите **файл веб-конфигурации**, примите имя файла *Web. config*по умолчанию и нажмите кнопку **добавить**.
3. Замените существующее XML-содержимое в файле *Web. config* следующим кодом:  

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample4.xml)]
4. Сохраните файл *Web. config* .

Файл *Web. config* указывает, что всем неизвестным пользователям веб-приложения необходимо запретить доступ к страницам, содержащимся в папке *Checkout* . Однако если пользователь зарегистрировал учетную запись и вошел в систему, он будет известным пользователем и будет иметь доступ к страницам в папке *Checkout* .

Важно отметить, что конфигурация ASP.NET соответствует иерархии, где каждый файл *Web. config* применяет параметры конфигурации к папке, в которой он находится, и ко всем дочерним каталогам, расположенным под ним.

<a id="SSLWebForms"></a>
## <a name="enable-ssl-for-the-project"></a>Включение SSL для проекта

 SSL (SSL) — это протокол, определенный для обеспечения безопасного обмена данными между веб-серверами и веб-клиентами с помощью шифрования. Если протокол SSL не используется, данные, передаваемые между клиентом и сервером, открываются для перехвата пакетов любым пользователем с физическим доступом к сети. Кроме того, некоторые распространенные схемы проверки подлинности не являются безопасными по сравнению с простым HTTP. В частности, обычная аутентификация и проверка подлинности на формах отправляют незашифрованные учетные данные. Для обеспечения безопасности эти схемы проверки подлинности должны использовать SSL. 

1. В **Обозреватель решений**щелкните проект **WingtipToys** , а затем нажмите клавишу **F4** , чтобы открыть окно **Свойства** .
2. Измените значение **SSL с Enabled** на `true`.
3. Скопируйте **URL-адрес SSL** , чтобы его можно было использовать позже.   
 URL-адрес SSL будет `https://localhost:44300/`, если вы ранее не создали веб-сайты SSL (как показано ниже).   
    ![Свойства проекта](checkout-and-payment-with-paypal/_static/image4.png)
4. В **Обозреватель решений**щелкните правой кнопкой мыши проект **WingtipToys** и выберите пункт **Свойства**.
5. На вкладке слева щелкните **веб**.
6. Измените **URL-адрес проекта** , чтобы использовать **URL-адрес SSL** , который вы сохранили ранее.   
    ![веб-свойства проекта](checkout-and-payment-with-paypal/_static/image5.png)
7. Сохраните страницу, нажав клавиши **CTRL + S**.
8. Нажмите клавиши **CTRL+F5**, чтобы запустить приложение. В Visual Studio отобразится параметр, позволяющий избежать предупреждений SSL.
9. Щелкните **Да** , чтобы ДОВЕРЯТЬ IIS Express SSL-сертификату и продолжить.   
    ![IIS Express сведения о SSL-сертификате](checkout-and-payment-with-paypal/_static/image6.png)  
 Отобразится предупреждение системы безопасности.
10. Нажмите кнопку **Да** , чтобы установить сертификат на локальном компьютере.   
    ![диалоговое окно "предупреждение системы безопасности"](checkout-and-payment-with-paypal/_static/image7.png)  
 Откроется окно браузера.

Теперь вы можете легко протестировать веб-приложение локально с помощью SSL.

<a id="OAuthWebForms"></a>
## <a name="add-an-oauth-20-provider"></a>Добавление поставщика OAuth 2,0

ASP.NET Web Forms предоставляет расширенные возможности для членства и проверки подлинности. Эти улучшения включают в себя OAuth. OAuth — это открытый протокол, который обеспечивает безопасную авторизацию в простом и стандартном методе из веб-, мобильных и настольных приложений. Шаблон веб-форм ASP.NET использует OAuth для предоставления доступа к Facebook, Twitter, Google и Майкрософт в качестве поставщиков проверки подлинности. Хотя в этом руководстве в качестве поставщика проверки подлинности используется только Google, вы можете легко изменить код для использования любого из поставщиков. Действия по реализации других поставщиков очень похожи на шаги, которые вы увидите в этом учебнике.

Помимо проверки подлинности, в учебнике также будут использоваться роли для реализации авторизации. Только пользователи, добавленные в роль `canEdit`, смогут изменять данные (создавать, изменять и удалять контакты).

> [!NOTE] 
> 
> Приложения Windows Live принимают только URL-адрес для рабочего веб-сайта, поэтому вы не можете использовать URL-адрес локального веб-сайта для проверки имен входа.

Следующие шаги позволяют добавить поставщик проверки подлинности Google.

1. Откройте файл *\_приложения старт\стартуп.АУС.КС* .
2. Удалите символы комментария из метода `app.UseGoogleAuthentication()`, чтобы метод выявлялся следующим образом: 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample5.cs)]
3. Перейдите в [консоль разработчиков Google](https://console.developers.google.com/). Вам также потребуется выполнить вход с помощью учетной записи электронной почты разработчика Google (gmail.com). Если у вас нет учетной записи Google, щелкните ссылку **создать учетную запись** .   
   Далее вы увидите **консоль разработчиков Google**.   
    Консоль ![Google Developers](checkout-and-payment-with-paypal/_static/image8.png)
4. Нажмите кнопку **создать проект** и введите имя и идентификатор проекта (можно использовать значения по умолчанию). Затем установите **флажок соглашение** и нажмите кнопку **создать** .  

    ![Новый проект Google](checkout-and-payment-with-paypal/_static/image9.png)

   Через несколько секунд будет создан новый проект, и браузер отобразит страницу «Создание проектов».
5. На вкладке слева щелкните **интерфейсы api &amp; auth**, а затем щелкните **учетные данные**.
6. Щелкните **создать новый идентификатор клиента** в **OAuth**.   
   Откроется диалоговое окно **Создание идентификатора клиента** .   
    ![Google — Создание идентификатора клиента](checkout-and-payment-with-paypal/_static/image10.png)
7. В диалоговом окне **создать идентификатор клиента** следует использовать **веб-приложение** по умолчанию для типа приложения.
8. Задайте для **полномочных источников JavaScript** URL-адрес SSL, который вы использовали ранее в этом учебнике (`https://localhost:44300/`, если не созданы другие проекты SSL).   
   Этот URL-адрес является источником для приложения. В этом примере будет введен только тестовый URL-адрес localhost. Однако можно ввести несколько URL-адресов для учетных записей localhost и Production.
9. Задайте для подходящего **URI перенаправления** следующее: 

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample6.html)]

   Это значение представляет собой универсальный код ресурса (URI), ASP.NET пользователей OAuth для взаимодействия с сервером Google OAuth. Запомните URL-адрес SSL, который вы использовали ранее (`https://localhost:44300/`, если не созданы другие проекты SSL).
10. Нажмите кнопку **создать идентификатор клиента** .
11. В меню слева консоли разработчиков Google щелкните пункт меню **экрана согласия** , а затем укажите адрес электронной почты и название продукта. Завершив работу с формой, нажмите кнопку **сохранить**.
12. Щелкните пункт меню **API** , прокрутите вниз и нажмите кнопку **выкл** рядом с **Google + API**.   
    При принятии этого параметра будет включен API Google +.
13. Необходимо также обновить пакет NuGet **Microsoft. Owin** до версии 3.0.0.   
    В меню **Сервис** выберите **Диспетчер пакетов NuGet** , а затем щелкните **Управление пакетами NuGet для решения**.  
    В окне **Управление пакетами NuGet** найдите и обновите пакет **Microsoft. Owin** до версии 3.0.0.
14. В Visual Studio Обновите метод `UseGoogleAuthentication` страницы *Startup.auth.CS* , скопировав и вставляя **идентификатор клиента** и **секрет клиента** в метод. Значения **идентификатора клиента** и **секрета клиента** , приведенные ниже, являются примерами и не будут работать. 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample7.cs?highlight=64-65)]
15. Нажмите клавиши **CTRL + F5** , чтобы создать и запустить приложение. Щелкните ссылку **Вход** .
16. В разделе **использовать другую службу для входа**щелкните **Google**.  
    ![войти](checkout-and-payment-with-paypal/_static/image11.png)
17. Если вам нужно ввести свои учетные данные, вы будете перенаправлены на сайт Google, где вы будете вводить свои учетные данные.  
    ![Вход в Google](checkout-and-payment-with-paypal/_static/image12.png)
18. После ввода учетных данных вам будет предложено предоставить разрешения только что созданному веб-приложению.  
    ![Учетная запись службы по умолчанию для проекта](checkout-and-payment-with-paypal/_static/image13.png)
19. Нажмите кнопку **принять**. Теперь вы будете перенаправлены обратно на страницу **регистрации** приложения **WingtipToys** , где можно зарегистрировать учетную запись Google.  
    ![зарегистрироваться в учетной записи Google](checkout-and-payment-with-paypal/_static/image14.png)
20. Вы можете изменить имя регистрации локального адреса электронной почты, используемое для учетной записи Gmail, но в общем случае необходимо использовать псевдоним электронной почты по умолчанию (то есть тот, который использовался для проверки подлинности). Нажмите кнопку **войти** , как показано выше.

### <a name="modifying-login-functionality"></a>Изменение функций входа

Как уже упоминалось в этой серии руководств, большая часть функций регистрации пользователей включена по умолчанию в шаблон веб-форм ASP.NET. Теперь вы измените страницы *Login. aspx* и *Register. aspx* по умолчанию для вызова метода `MigrateCart`. Метод `MigrateCart` связывает недавно вошедший пользователь с корзиной анонимных покупок. Связав учетную запись пользователя и покупательской корзины, пример приложения Wingtip Toys сможет поддерживать покупательскую корзину пользователя между посещениями.

1. В **Обозреватель решений**найдите и откройте папку *учетной записи* .
2. Измените страницу кода программной части с именем *Login.aspx.CS* , чтобы включить код, выделенный желтым цветом, чтобы он выявлялся следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample8.cs?highlight=41-43)]
3. Сохраните файл *Login.aspx.CS* .

Сейчас можно проигнорировать предупреждение о том, что для метода `MigrateCart` нет определения. Далее в этом руководстве вы добавите его чуть позже.

Файл кода программной части *Login.aspx.CS* поддерживает метод входа в систему. Проверив страницу Login. aspx, вы увидите, что эта страница содержит кнопку "войти", которая при нажатии кнопки "триггер" вызывает обработчик `LogIn` в коде программной части.

При вызове метода `Login` в *Login.aspx.CS* создается новый экземпляр корзины для покупок с именем `usersShoppingCart`. Идентификатор корзины для покупок (GUID) извлекается и устанавливается в переменную `cartId`. Затем вызывается метод `MigrateCart`, передающий в этот метод как `cartId`, так и имя вошедшего в систему пользователя. При переносе корзины для покупок идентификатор GUID, используемый для обнаружения корзины анонимных покупок, заменяется именем пользователя.

Помимо изменения файла кода программной части *Login.aspx.CS* для переноса корзины для покупок при входе пользователя в систему, необходимо также изменить *файл кода программной части Register.aspx.CS* , чтобы перенести корзину для покупок, когда пользователь создаст новую учетную запись и войдет в систему.

1. В папке *учетной записи* откройте файл кода программной части с именем *Register.aspx.CS*.
2. Измените файл кода программной части, включив в него желтый код, чтобы он выявлялся следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample9.cs?highlight=28-32)]
3. Сохраните файл *Register.aspx.CS* . Опять же, пропустите предупреждение о методе `MigrateCart`.

Обратите внимание, что код, используемый в обработчике событий `CreateUser_Click`, очень похож на код, используемый в методе `LogIn`. Когда пользователь регистрируется на сайте или входит в систему, будет выполнен вызов метода `MigrateCart`.

## <a name="migrating-the-shopping-cart"></a>Перенос корзины для покупок

Теперь, когда процесс входа и регистрации обновлен, можно добавить код для переноса корзины для покупок с помощью метода `MigrateCart`.

1. В **Обозреватель решений**найдите папку *Logic* и откройте файл класса *ShoppingCartActions.CS* .
2. Добавьте код, выделенный желтым цветом, в существующий код в файле *ShoppingCartActions.CS* , чтобы код в файле *ShoppingCartActions.CS* выглядит следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample10.cs?highlight=215-224)]

Метод `MigrateCart` использует существующий Картид, чтобы найти покупательскую корзину пользователя. Затем код выполняет цикл по всем элементам корзины и заменяет свойство `CartId` (как указано в схеме `CartItem`) на имя пользователя, выполнившего вход.

### <a name="updating-the-database-connection"></a>Обновление подключения к базе данных

Если вы используете этот учебник с помощью предварительно **созданного** примера приложения Wingtip Toys, необходимо повторно создать базу данных членства по умолчанию. Изменяя строку подключения по умолчанию, база данных членства будет создана при следующем запуске приложения.

1. Откройте файл *Web. config* в корне проекта.
2. Обновите строку подключения по умолчанию, чтобы она выводится следующим образом:   

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample11.xml)]

<a id="PayPalWebForms"></a>
## <a name="integrating-paypal"></a>Интеграция PayPal

PayPal — это веб-платформа для выставления счетов, которая принимает платежи через Интернет-магазины. В этом руководстве показано, как интегрировать функции Express recheckout в приложение. Экспресс – извлечение позволяет клиентам платить за элементы, добавленные в корзину для покупок.

### <a name="create-paypal-test-accounts"></a>Создание тестовых учетных записей PayPal

Чтобы использовать среду тестирования PayPal, необходимо создать и проверить тестовую учетную запись разработчика. Для создания тестовой учетной записи покупателя и тестовой учетной записи продавца будет использоваться тестовая учетная запись разработчика. Учетные данные тестовой учетной записи разработчика также позволяют образцу приложения Wingtip Toys получать доступ к среде тестирования PayPal.

1. В браузере перейдите на сайт тестирования для разработчиков PayPal:   
    [https://developer.paypal.com](https://developer.paypal.com/)
2. Если у вас нет учетной записи разработчика PayPal, создайте новую учетную запись, нажав кнопку **Регистрация**и следуя указаниям в статье регистрация. Если у вас есть учетная запись разработчика PayPal, войдите, щелкнув **войти**. Вам потребуется учетная запись разработчика PayPal, чтобы протестировать пример приложения Wingtip Toys позже в этом руководстве.
3. Если вы только что подписались на учетную запись разработчика PayPal, вам может потребоваться проверить учетную запись разработчика PayPal с помощью PayPal. Чтобы проверить учетную запись, выполните действия, которые PayPal отправил в вашу учетную запись электронной почты. После проверки учетной записи разработчика PayPal Войдите на сайт тестирования PayPal для разработчиков.
4. После входа на сайт разработчика PayPal с помощью учетной записи разработчика PayPal необходимо создать тестовую учетную запись закупщика PayPal, если она еще не создана. Чтобы создать тестовую учетную запись покупателя, на сайте PayPal перейдите на вкладку **приложения** и щелкните **учетные записи песочницы**.   
 Отобразится страница **тестовые учетные записи "песочницы"** .   

    > [!NOTE] 
    > 
    > Сайт разработчика PayPal уже предоставляет учетную запись для тестирования продавцов.

    ![Оформление и оплата с помощью PayPal. тестовые учетные записи "песочницы"](checkout-and-payment-with-paypal/_static/image15.png)
5. На странице тестовые учетные записи "песочницы" щелкните **создать учетную запись**.
6. На странице **Создание тестовой учетной записи** выберите адрес электронной почты тестовой учетной записи покупателя и пароль по своему усмотрению.   

    > [!NOTE] 
    > 
    > Потребуются адреса электронной почты и пароль покупателя для тестирования примера приложения Wingtip Toys в конце этого руководства.

    ![Оформление и оплата с помощью PayPal. тестовые учетные записи "песочницы"](checkout-and-payment-with-paypal/_static/image16.png)
7. Создайте тестовую учетную запись покупателя, нажав кнопку **создать учетную запись** .  
 Откроется страница **тестовые учетные записи "песочницы"** . 

    ![Оформление и оплата с помощью PayPal. учетные записи PayPal](checkout-and-payment-with-paypal/_static/image17.png)
8. На странице **тестовые учетные записи "песочницы** " щелкните учетную запись **организатора** электронной почты.  
    Отобразятся параметры **профиля** и **уведомления** .
9. Выберите параметр **профиль** , а затем щелкните **учетные данные API** , чтобы просмотреть учетные данные API для тестовой учетной записи получателя.
10. Скопируйте учетные данные API тестирования в Блокнот.

Вам понадобятся учетные данные классического ТЕСТового API (имя пользователя, пароль и подпись), чтобы вызывать API из примера приложения Wingtip Toys в среду тестирования PayPal. Вы добавите учетные данные на следующем шаге.

### <a name="add-paypal-class-and-api-credentials"></a>Добавление учетных данных класса PayPal и API

Большая часть кода PayPal будет размещена в одном классе. Этот класс содержит методы, используемые для связи с PayPal. Кроме того, вы добавите учетные данные PayPal в этот класс.

1. В образце приложения Wingtip Toys в Visual Studio щелкните правой кнопкой мыши папку **Logic** и выберите **Добавить** -&gt; **новый элемент**.   
   Откроется диалоговое окно **Добавление нового элемента**.
2. В **разделе C# визуальный** элемент на панели **установленные** слева выберите **код**.
3. В средней области выберите **класс**. Назовите этот новый класс **PayPalFunctions.CS**.
4. Нажмите кнопку **Добавить**.  
   В редакторе отобразится новый файл класса.
5. Замените код по умолчанию следующим кодом:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample12.cs)]
6. Добавьте учетные данные API-интерфейса продавца (имя пользователя, пароль и подпись), которые вы выводите ранее в этом учебнике, чтобы можно было вызывать функции в среде тестирования PayPal.  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample13.cs)]

> [!NOTE] 
> 
> В этом примере приложения вы просто добавляете учетные данные C# в файл (CS). Однако в реализованном решении следует использовать шифрование учетных данных в файле конфигурации.

Класс Нвпапикаллер содержит большинство функций PayPal. Код в классе предоставляет методы, необходимые для выполнения тестовой покупки из среды тестирования PayPal. Для совершения покупок используются следующие три функции PayPal:

- Функция `SetExpressCheckout`
- Функция `GetExpressCheckoutDetails`
- Функция `DoExpressCheckoutPayment`

Метод `ShortcutExpressCheckout` собирает сведения о приобретении теста и сведения о продукте из корзины для покупок и вызывает функцию `SetExpressCheckout` PayPal. Метод `GetCheckoutDetails` подтверждает сведения о приобретении и вызывает `GetExpressCheckoutDetails` функцию PayPal перед выполнением тестовой покупки. Метод `DoCheckoutPayment` завершает тестовую покупку из среды тестирования, вызывая функцию `DoExpressCheckoutPayment` PayPal. Оставшийся код поддерживает методы и процессы PayPal, такие как строки кодировки, декодирование строк, обработка массивов и определение учетных данных.

> [!NOTE] 
> 
> PayPal позволяет включать дополнительные сведения о приобретении на основе [спецификации API PayPal](https://cms.paypal.com/us/cgi-bin/?cmd=_render-content&amp;content_ID=developer/e_howto_api_nvp_r_SetExpressCheckout). Расширяя код в примере приложения Wingtip Toys, вы можете включить сведения о локализации, описания продуктов, налог, номер службы клиента, а также множество других дополнительных полей.

Обратите внимание, что URL-адреса возврата и отмены, указанные в методе **шорткутекспрессчеккаут** , используют номер порта.

[!code-html[Main](checkout-and-payment-with-paypal/samples/sample14.html)]

Когда Visual Web Developer запускает веб-проект с использованием SSL, обычно для веб-сервера используется порт 44300. Как показано выше, номер порта — 44300. При запуске приложения можно увидеть другой номер порта. Номер порта должен быть правильно задан в коде, чтобы можно было успешно запустить пример приложения Wingtip Toys в конце этого руководства. В следующем разделе этого руководства объясняется, как получить номер порта локального узла и обновить класс PayPal.

### <a name="update-the-localhost-port-number-in-the-paypal-class"></a>Обновление номера порта LocalHost в классе PayPal

Пример приложения Wingtip Toys закупает продукты, перейдя на сайт тестирования PayPal и вернувшись к локальному экземпляру примера приложения Wingtip Toys. Чтобы приложение PayPal возвращало правильный URL-адрес, необходимо указать номер порта локально запущенного примера приложения в коде PayPal, упомянутом выше.

1. Щелкните правой кнопкой мыши имя проекта (**WingtipToys**) в **Обозреватель решений** и выберите пункт **Свойства**.
2. В левом столбце выберите вкладку **веб** .
3. Получите номер порта из поля **URL-адрес проекта** .
4. При необходимости обновите `returnURL` и `cancelURL` в классе PayPal (`NVPAPICaller`) в файле *PayPalFunctions.CS* , чтобы использовать номер порта веб-приложения:   

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample15.html?highlight=1-2)]

Теперь добавленный код будет соответствовать ожидаемому порту локального веб-приложения. PayPal сможет вернуться к правильному URL-адресу на локальном компьютере.

### <a name="add-the-paypal-checkout-button"></a>Добавление кнопки извлечения из PayPal

Теперь, когда основные функции PayPal добавлены в пример приложения, можно приступить к добавлению разметки и кода, необходимого для вызова этих функций. Во-первых, необходимо добавить кнопку извлечения, которую пользователь увидит на странице покупательская корзина.

1. Откройте файл *ShoppingCart. aspx* .
2. Прокрутите файл вниз и найдите комментарий `<!--Checkout Placeholder -->`.
3. Замените комментарий на элемент управления `ImageButton`, чтобы заменять метку следующим образом:  

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample16.aspx)]
4. В файле *ShoppingCart.aspx.CS* после обработчика событий `UpdateBtn_Click` в конце файла добавьте `CheckOutBtn_Click` обработчик событий:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample17.cs)]
5. Кроме того, в файле *ShoppingCart.aspx.CS* добавьте ссылку на `CheckoutBtn`, чтобы на кнопке Создать изображение ссылались следующим образом:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample18.cs?highlight=18)]
6. Сохраните изменения как в файле *ShoppingCart. aspx* , так и в файле *ShoppingCart.aspx.CS* .
7. В меню выберите **отладка**-&gt;**Сборка WingtipToys**.  
   Проект будет перестроен с добавлением только что добавленного элемента управления **ImageButton** .

### <a name="send-purchase-details-to-paypal"></a>Отправка сведений о приобретении в PayPal

Когда пользователь нажимает кнопку " **извлечь** " на странице покупательской корзины (*ShoppingCart. aspx*), он начинает процесс покупки. Следующий код вызывает первую функцию PayPal, необходимую для приобретения продуктов.

1. В папке " *Извлечение* " Откройте файл кода программной части с именем *CheckoutStart.aspx.CS*.   
   Не забудьте открыть файл кода программной части.
2. Замените существующий код следующим кодом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample19.cs)]

Когда пользователь приложения нажимает кнопку " **извлечь** " на странице покупательской корзины, браузер переходит на страницу *чеккаутстарт. aspx* . При загрузке страницы *чеккаутстарт. aspx* вызывается метод `ShortcutExpressCheckout`. На этом этапе пользователь передается на веб-сайт тестирования PayPal. На сайте PayPal пользователь вводит свои учетные данные PayPal, просматривает сведения о покупке, принимает соглашение PayPal и возвращает его в пример приложения Wingtip Toys, в котором завершается метод `ShortcutExpressCheckout`. Когда метод `ShortcutExpressCheckout` будет завершен, он перенаправит пользователя на страницу *чеккаутревиев. aspx* , указанную в методе `ShortcutExpressCheckout`. Это позволяет пользователю просматривать сведения о заказе в образце приложения Wingtip Toys.

### <a name="review-order-details"></a>Сведения о заказе на проверку

После возврата из PayPal на странице *чеккаутревиев. aspx* примера приложения Wingtip Toys отображаются сведения о заказе. Эта страница позволяет пользователю просматривать сведения о заказе перед покупкой продуктов. Страница *чеккаутревиев. aspx* должна быть создана следующим образом:

1. В папке *Checkout* откройте страницу с именем *чеккаутревиев. aspx*.
2. Замените существующую разметку следующим:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample20.aspx)]
3. Откройте страницу кода программной части с именем *CheckoutReview.aspx.CS* и замените существующий код следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample21.cs)]

Элемент управления **DetailsView** используется для вывода сведений о заказе, возвращенных из PayPal. Кроме того, приведенный выше код сохраняет сведения о заказе в базе данных Wingtip Toys как объект `OrderDetail`. Когда пользователь нажимает кнопку **завершить заказ** , он перенаправляется на страницу *чеккауткомплете. aspx* .

> [!NOTE] 
> 
> **Советы**
> 
> Обратите внимание, что в разметке страницы *чеккаутревиев. aspx* для изменения стиля элементов в элементе управления **DetailsView** в нижней части страницы используется тег `<ItemStyle>`. Просмотрев страницу в **режиме конструктора** (выбрав пункт **конструктор** в левом нижнем углу Visual Studio), а затем выбрав элемент управления **DetailsView** и выбрав **смарт-тег** (значок стрелки в верхнем правом углу элемента управления), вы увидите **Задачи DetailsView**.
> 
> ![Оформление и оплата с помощью PayPal — изменение полей](checkout-and-payment-with-paypal/_static/image18.png)
> 
> Если выбрать пункт **изменить поля**, появится диалоговое окно **поля** . В этом диалоговом окне можно легко управлять визуальными свойствами, такими как **итемстиле**, элемента управления **DetailsView** .
> 
> ![Извлечение и оплата с помощью диалогового окна PayPal — поля](checkout-and-payment-with-paypal/_static/image19.png)

### <a name="complete-purchase"></a>Завершить покупку

Страница *чеккауткомплете. aspx* выполняет покупку из PayPal. Как упоминалось выше, пользователь должен нажать кнопку **завершить заказ** , прежде чем приложение перейдет на страницу *чеккауткомплете. aspx* .

1. В папке *Checkout* откройте страницу с именем *чеккауткомплете. aspx*.
2. Замените существующую разметку следующим:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample22.aspx)]
3. Откройте страницу кода программной части с именем *CheckoutComplete.aspx.CS* и замените существующий код следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample23.cs)]

При загрузке страницы *чеккауткомплете. aspx* вызывается метод `DoCheckoutPayment`. Как упоминалось ранее, метод `DoCheckoutPayment` завершает покупку из среды тестирования PayPal. После того как PayPal закончит покупку заказа, на странице *чеккауткомплете. aspx* отобразится платежная транзакция, `ID` покупательу.

### <a name="handle-cancel-purchase"></a>Обработайте отмену покупки

Если пользователь решает отменить покупку, он будет перенаправлен на страницу *чеккаутканцел. aspx* , где они увидят, что их порядок был отменен.

1. Откройте страницу с именем *чеккаутканцел. aspx* в папке *Checkout* .
2. Замените существующую разметку следующим:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample24.aspx)]

### <a name="handle-purchase-errors"></a>Обработку ошибок покупки

Ошибки во время процесса покупки будут обрабатываться страницей *чеккаутеррор. aspx* . Код программной части страницы *чеккаутстарт. aspx* , страница *чеккаутревиев. aspx* и страница *чеккауткомплете. aspx* будут перенаправлены на страницу *чеккаутеррор. aspx* при возникновении ошибки.

1. Откройте страницу с именем *чеккаутеррор. aspx* в папке *Checkout* .
2. Замените существующую разметку следующим:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample25.aspx)]

При возникновении ошибки в процессе извлечения отображается страница *чеккаутеррор. aspx* со сведениями об ошибке.

## <a name="running-the-application"></a>Запуск приложения

Запустите приложение, чтобы узнать, как приобрести продукты. Обратите внимание, что вы будете работать в среде тестирования PayPal. Не выполняется обмен фактическими средствами.

1. Убедитесь, что все файлы сохранены в Visual Studio.
2. Откройте веб-браузер и перейдите по адресу [https://developer.paypal.com](https://developer.paypal.com/).
3. Войдите с помощью учетной записи разработчика PayPal, созданной ранее в этом руководстве.  
   Для песочницы разработчика PayPal необходимо войти в [https://developer.paypal.com](https://developer.paypal.com/) , чтобы проверить Экспресс-извлечение. Это относится только к тестированию песочницы PayPal, а не к реальной среде PayPal.
4. В Visual Studio нажмите клавишу **F5** , чтобы запустить пример приложения Wingtip Toys.  
   После пересборки базы данных браузер откроется и отобразит страницу *Default. aspx* .
5. Добавьте три различных продукта в корзину для покупок, выбрав категорию продуктов, например "автомобили", а затем щелкнув **Добавить в корзину** рядом с каждым продуктом.  
   В корзине для покупок будет отображаться выбранный продукт.
6. Нажмите кнопку **PayPal** , чтобы извлечь его. 

    ![Оформление и оплата с помощью PayPal. корзина](checkout-and-payment-with-paypal/_static/image20.png)

   Для извлечения потребуется учетная запись пользователя для примера приложения Wingtip Toys.
7. Щелкните ссылку **Google** справа от страницы, чтобы войти в систему с помощью существующей учетной записи электронной почты Gmail.com.  
   Если у вас нет учетной записи gmail.com, вы можете создать ее для тестирования в [www.Gmail.com](https://www.gmail.com/). Вы также можете использовать стандартную локальную учетную запись, нажав кнопку "зарегистрировать". 

    ![Оформление и оплата с помощью PayPal. вход в систему](checkout-and-payment-with-paypal/_static/image21.png)
8. Войдите с помощью учетной записи Gmail и пароля. 

    ![Извлечение и оплата с помощью PayPal — вход в Gmail](checkout-and-payment-with-paypal/_static/image22.png)
9. Нажмите кнопку **Вход** , чтобы зарегистрировать учетную запись Gmail с именем пользователя примера приложения Wingtip Toys. 

    ![Оформление и оплата с помощью PayPal — регистрация учетной записи](checkout-and-payment-with-paypal/_static/image23.png)
10. На тестовом сайте PayPal добавьте адрес электронной почты **покупателя** и пароль, созданные ранее в этом руководстве, а затем нажмите кнопку **Вход** . 

    ![Оформление и оплата с помощью PayPal. вход в PayPal](checkout-and-payment-with-paypal/_static/image24.png)
11. Примите условия политики PayPal и нажмите кнопку " **принять и продолжить** ".  
    Обратите внимание, что эта страница отображается только при первом использовании этой учетной записи PayPal. Опять же, обратите внимание, что это тестовая учетная запись, обмен реальными денежными средствами не осуществляется. 

    ![Оформление и оплата с помощью PayPal. Политика PayPal](checkout-and-payment-with-paypal/_static/image25.png)
12. Просмотрите сведения о заказе на странице проверки тестовой среды PayPal и нажмите кнопку **продолжить**. 

    ![Оформление и оплата с помощью PayPal. сведения для проверки](checkout-and-payment-with-paypal/_static/image26.png)
13. На странице *чеккаутревиев. aspx* Проверьте сумму заказа и просмотрите созданный адрес доставки. Затем нажмите кнопку **завершить заказ** . 

    ![Извлечение и оплата с помощью PayPal — проверка заказа](checkout-and-payment-with-paypal/_static/image27.png)
14. Отобразится страница **чеккауткомплете. aspx** с идентификатором транзакции оплаты. 

    ![Извлечение и оплата с помощью PayPal — Извлечение завершено](checkout-and-payment-with-paypal/_static/image28.png)

<a id="ReviewDBWebForms"></a>
## <a name="reviewing-the-database"></a>Проверка базы данных

Просмотрев обновленные данные в образце базы данных приложения Wingtip Toys после запуска приложения, вы видите, что приложение успешно зарегистрировало покупку продуктов.

Данные, содержащиеся в файле базы данных *wingtiptoys. mdf* , можно проверить с помощью окна **Обозреватель базы данных** (**Обозреватель сервера** окно в Visual Studio), как было сделано ранее в этой серии руководств.

1. Закройте окно браузера, если оно все еще открыто.
2. В Visual Studio щелкните значок « **Показывать все файлы** » в верхней части **Обозреватель решений** , чтобы можно было развернуть папку « **приложение\_данных** ».
3. Разверните папку " **приложение\_данных** ".  
 Может потребоваться установить значок " **Показывать все файлы** " для папки.
4. Щелкните правой кнопкой мыши файл базы данных *wingtiptoys. mdf* и выберите команду **Открыть**.  
    Отображается **Обозреватель сервера** .
5. Разверните папку **таблицы** .
6. Щелкните правой кнопкой мыши таблицу **заказы**и выберите команду **отобразить данные таблицы**.  
 Отобразится таблица **Orders** .
7. Проверьте столбец **пайменттрансактионид** , чтобы подтвердить успешные транзакции. 

    ![Оформление и оплата с помощью PayPal. база данных проверки](checkout-and-payment-with-paypal/_static/image29.png)
8. Закройте окно Таблица **Orders** .
9. В обозреватель сервера щелкните правой кнопкой мыши таблицу **OrderDetails** и выберите команду **отобразить данные таблицы**.
10. Проверьте значения `OrderId` и `Username` в таблице **OrderDetails** . Обратите внимание, что эти значения соответствуют `OrderId` и `Username` значений, включаемых в таблицу **Orders** .
11. Закройте окно таблицы **OrderDetails** .
12. Щелкните правой кнопкой мыши файл базы данных Wingtip Toys (*wingtiptoys. mdf*) и выберите **закрыть подключение**.
13. Если окно **Обозреватель решений** не отображается, щелкните **Обозреватель решений** в нижней части окна **обозреватель сервера** , чтобы снова отобразить **Обозреватель решений** .

## <a name="summary"></a>Сводка

В этом руководстве вы добавили схемы заказа и подробностей заказа для учета приобретенных продуктов. Вы также интегрированы функции PayPal в пример приложения Wingtip Toys.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Общие сведения о конфигурации ASP.NET](https://msdn.microsoft.com/library/ms178683(v=vs.100).aspx)  
[Развертывание безопасного приложения веб-форм ASP.NET с членством, OAuth и базой данных SQL в службе приложений Azure](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-deploy-aspnet-webforms-app-membership-oauth-sql-database/)  
[Бесплатная пробная версия Microsoft Azure](https://azure.microsoft.com/pricing/free-trial/)

## <a name="disclaimer"></a>Заявление

В этом учебнике содержится пример кода. Такой пример кода предоставляется "как есть" без каких-либо гарантий. Соответственно, корпорация Майкрософт не гарантирует точность, целостность и качество образца кода. Вы соглашаетесь использовать пример кода на свой собственный риск. В отсутствие каких-либо обстоятельств Майкрософт не несет ответственности за любой из примеров кода, содержимого, включая (но не ограниченных) любые ошибки или пропуски в любом образце кода, содержимом или любых потерь или повреждения любого типа в результате использования любого примера кода. Настоящим вы получаете извещение о том, что они согласны с освободить от ответственности, сэкономить и удержать Майкрософт от любых и всех потерь, утверждений об утере, травме или ущербе любого рода, включая, без ограничений, те, кто или что отказывается от публикуемых материалов. передача, использование или полагаться на включение, но не ограничиваются в представлениях, выраженных в нем.

> [!div class="step-by-step"]
> [Назад](shopping-cart.md)
> [Вперед](membership-and-administration.md)
