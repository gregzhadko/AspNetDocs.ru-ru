---
uid: web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
title: Оформление заказа и Оплата по PayPal | Документация Майкрософт
author: Erikre
description: В этой серии руководств будет основы создания приложений веб-форм ASP.NET с помощью ASP.NET 4.5 и Microsoft Visual Studio Express 2013 для мы...
ms.author: riande
ms.date: 09/08/2014
ms.assetid: 664ec95e-b0c9-4f43-a39f-798d0f2a7e08
msc.legacyurl: /web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
msc.type: authoredcontent
ms.openlocfilehash: 0fc4e85a86289667566a76537dd1573f4d9b2bf0
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65131731"
---
# <a name="checkout-and-payment-with-paypal"></a>Оформление заказа и оплата по PayPal

по [Erik Reitan](https://github.com/Erikre)

[Скачайте пример проекта Wingtip Toys (C#)](http://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) или [скачайте электронную книгу (PDF)](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20ASP.NET%204.5%20Web%20Forms%20and%20Visual%20Studio%202013.pdf)

> В этой серии руководств будет основы создания приложений веб-форм ASP.NET с помощью ASP.NET 4.5 и Microsoft Visual Studio Express 2013 для Web. Visual Studio 2013 [проект с исходным кодом C#](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) доступен на следующей странице этой серии руководств.

Это руководство содержит инструкции изменить пример приложения Wingtip Toys Включение авторизации пользователей, регистрации и оплаты, с помощью PayPal. Только пользователи, вошедшие в будет иметь авторизации для приобретения продуктов. Функции регистрации встроенного пользовательского шаблона проекта веб-форм ASP.NET 4.5 уже содержит большую, чем нужно. Вы добавите функции извлечения Express PayPal. В этом руководстве вы используете PayPal разработчик среды, тестирования, поэтому не фактический денежные средства будут передаваться. В конце этого руководства вы проверите приложение, выбрав продукты для добавления Корзина для покупок, нажав кнопку извлечения и передачи данных в PayPal тестирования веб-сайта. На веб-сайте тестирования PayPal будет подтвердите свои сведения оплаты и доставки, а затем вернитесь в локальном пример приложения Wingtip Toys для подтверждения и завершения покупки.

Существует несколько опытным оплаты сторонних процессоров, специализирующихся в покупке товаров через Интернет, адрес масштабируемости и безопасности. Преимущества использования стороннего решения оплаты до реализации корзине и приобретения решения должны учитывать разработчики ASP.NET.

> [!NOTE] 
> 
> Пример приложения Wingtip Toys была разработана для показано определенные понятия ASP.NET и функциях, доступных разработчикам веб-страниц ASP.NET. В этом образце приложения не был оптимизирован для всех возможных ситуациях соображениям масштабируемости и безопасности.

## <a name="what-youll-learn"></a>Вы узнаете, как:

- Как ограничить доступ для определенных страниц в папке.
- Как создать корзины для покупок из анонимного корзины.
- Инструкции по включению SSL для проекта.
- Как добавить поставщика OAuth в проект.
- Как использовать PayPal для приобретения продуктов с использованием среды тестирования PayPal.
- Как отобразить сведения из PayPal в **DetailsView** элемента управления.
- Как обновить базу данных приложения Wingtip Toys со сведениями, полученный из PayPal.

## <a name="adding-order-tracking"></a>Добавление отслеживания заказа

В этом руководстве вы создадите два новых класса, для отслеживания данных из порядке, в котором создан пользователь. Классы будет отслеживать данные, касающиеся сведений о доставке, сумма покупки и подтверждение оплаты.

### <a name="add-the-order-and-orderdetail-model-classes"></a>Добавьте Order и OrderDetail модели классов

Ранее в этой серии руководств вы определили схемы для категорий, продуктов, и элементы корзину для покупок с помощью создания `Category`, `Product`, и `CartItem` классы в *моделей* папки. Теперь добавим два новых класса, чтобы определить схему для заказа продукта и сведения о заказе.

1. В **моделей** папки, добавьте новый класс с именем *Order.cs*.   
   Новый файл класса отображается в редакторе.
2. Замените код по умолчанию следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample1.cs)]
3. Добавить *OrderDetail.cs* класс *моделей* папки.
4. Замените код по умолчанию следующим кодом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample2.cs)]

`Order` И `OrderDetail` классов содержит схему для определения порядка сведения, используемые для покупки и доставки.

Кроме того необходимо будет обновить класс контекста базы данных, который управляет классы сущностей и который предоставляет доступ к данным к базе данных. Для этого необходимо добавить только что созданного заказа и `OrderDetail` классов для модели `ProductContext` класса.

1. В **обозревателе решений**найдите и откройте *ProductContext.cs* файла.
2. Добавьте выделенный код, который *ProductContext.cs* файл, как показано ниже:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample3.cs?highlight=14-15)]

Как упоминалось ранее в этой серии руководств, код в *ProductContext.cs* добавляет файл `System.Data.Entity` пространства имен таким образом, чтобы у вас есть доступ ко всем функциям платформы Entity Framework core. Эта функция включает в себя возможность запроса, вставки, обновления и удаления данных, работая с строго типизированных объектов. Приведенный выше код в `ProductContext` класс добавляет Entity Framework доступ к только что добавленного `Order` и `OrderDetail` классы.

## <a name="adding-checkout-access"></a>Добавление доступа к извлечения

Пример приложения Wingtip Toys позволяет анонимным пользователям просмотреть и добавить продукты в корзину для покупок. Тем не менее когда анонимными пользователями приобрести продукты, которые они добавлены в корзину покупок, их необходимо войти на сайт. После вошедшим в систему, они доступны ограниченные страницы веб-приложения, которые обрабатывают извлечение и приобрести процесс. Эти страницы с ограниченным доступом, содержащиеся в *извлечения* папку приложения.

### <a name="add-a-checkout-folder-and-pages"></a>Добавление страницу и папка извлечения

Теперь вы создадите *извлечения* папки и страниц в нем, которое клиент увидит процессе оформления покупки. Далее в этом руководстве вы обновите эти страницы.

1. Щелкните правой кнопкой мыши имя проекта (**Wingtip Toys**) в **обозревателе решений** и выберите **добавьте новую папку**. 

    ![Оформление заказа и Оплата по PayPal - новая папка](checkout-and-payment-with-paypal/_static/image1.png)
2. Назовите новую папку *извлечения*.
3. Щелкните правой кнопкой мыши *извлечения* папку, а затем выберите **добавить**-&gt;**новый элемент**. 

    ![Оформление заказа и Оплата по PayPal - новый элемент](checkout-and-payment-with-paypal/_static/image2.png)
4. Откроется диалоговое окно **Добавление нового элемента**.
5. Выберите **Visual C#**  - &gt; **Web** группы шаблонов в левой части. Затем в средней области выберите **веб-форма с главной страницы**и назовите его *CheckoutStart.aspx*. 

    ![Оформление заказа и Оплата по PayPal - новый диалоговое окно добавления элемента](checkout-and-payment-with-paypal/_static/image3.png)
6. Как и ранее, выберите *Site.Master* файл в качестве главной страницы.
7. Добавьте следующие дополнительные страницы, на *извлечения* папки, используя те же шаги:   

    - CheckoutReview.aspx
    - CheckoutComplete.aspx
    - CheckoutCancel.aspx
    - CheckoutError.aspx

### <a name="add-a-webconfig-file"></a>Добавьте файл Web.config

Добавив новое *Web.config* файл *извлечения* папки, можно ограничить доступ ко всем страницам, содержащиеся в папке.

1. Щелкните правой кнопкой мыши *извлечения* папку и выберите **добавить**  - &gt; **новый элемент**.  
   Откроется диалоговое окно **Добавление нового элемента**.
2. Выберите **Visual C#**  - &gt; **Web** группы шаблонов в левой части. Затем в средней области выберите **файл веб-конфигурации**, примите имя по умолчанию *Web.config*, а затем выберите **добавить**.
3. Замените существующий XML-содержимое в *Web.config* файл со следующими:  

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample4.xml)]
4. Сохранить *Web.config* файл.

*Web.config* файла указывает, что всех неизвестных пользователей веб-приложения должен быть запрещен доступ к страниц, содержащихся в *извлечения* папки. Тем не менее, если пользователь зарегистрировал учетную запись и войти в систему, они будут известного пользователя и будет иметь доступ к страницам в *извлечения* папки.

Важно отметить, что конфигурация ASP.NET соответствует иерархии, где каждый *Web.config* файла применяются параметры конфигурации в папку, в и на всех его дочерних каталогов.

<a id="SSLWebForms"></a>
## <a name="enable-ssl-for-the-project"></a>Включение SSL для проекта

 Secure Sockets Layer (SSL) — это протокол, указано, что позволяет веб-серверов и веб-клиентам более безопасно обмениваться данными с помощью шифрования. Если не используется протокол SSL, данные, передаваемые между клиентом и сервером открыт для пакета сканирования любому человеку с физическим доступом к сети. Кроме того несколько распространенных схем проверки подлинности не являются безопасными через простой HTTP. В частности Обычная проверка подлинности и проверки подлинности форм отправляют незашифрованные учетные данные. Чтобы обеспечить безопасность, эти схемы проверки подлинности, необходимо использовать SSL. 

1. В **обозревателе решений**, нажмите кнопку **WingtipToys** проекта, а затем нажмите клавишу **F4** для отображения **свойства** окна.
2. Изменение **SSL включен** для `true`.
3. Копировать **URL-адрес SSL** , его можно использовать позже.   
 URL-адрес SSL будет `https://localhost:44300/` Если вы уже создали веб-сайтов SSL (как показано ниже).   
    ![Свойства проекта](checkout-and-payment-with-paypal/_static/image4.png)
4. В **обозревателе решений**, щелкните правой кнопкой мыши **WingtipToys** проекта и нажмите кнопку **свойства**.
5. На левой вкладке щелкните **Web**.
6. Изменение **URL-адрес проекта** использовать **URL-адрес SSL** , сохраненный ранее.   
    ![Веб-свойства проекта](checkout-and-payment-with-paypal/_static/image5.png)
7. Сохраните страницу, нажав клавишу **CTRL + S**.
8. Нажмите клавиши **CTRL+F5**, чтобы запустить приложение. Visual Studio будет отображаться параметр, чтобы можно было предупреждающие сообщения SSL.
9. Нажмите кнопку **Да** доверять сертификату IIS Express SSL и продолжить.   
    ![Сведения о сертификате IIS Express SSL](checkout-and-payment-with-paypal/_static/image6.png)  
 Отображается предупреждение системы безопасности.
10. Нажмите кнопку **Да** установите сертификат для вашего localhost.   
    ![Диалоговое окно предупреждения безопасности](checkout-and-payment-with-paypal/_static/image7.png)  
 Откроется окно браузера.

Теперь можно легко проверить веб-приложения локально с помощью SSL.

<a id="OAuthWebForms"></a>
## <a name="add-an-oauth-20-provider"></a>Добавление поставщика OAuth 2.0

Веб-формы ASP.NET предлагают расширенные параметры для членства и проверки подлинности. Этим расширениям относится OAuth. OAuth — это открытый протокол, обеспечивающий безопасную авторизацию простым и стандартным способом из веб-приложений, мобильных и настольных приложений. Шаблон веб-форм ASP.NET используется OAuth для предоставления Facebook, Twitter, Google и Майкрософт в качестве поставщиков проверки подлинности. Служба проверки подлинности в этом учебнике используется только Google, вы легко можете изменить код, чтобы использовать любого поставщика. Шаги по реализации других поставщиков очень похожи на шаги, вы увидите в этом руководстве.

Помимо аутентификации руководства будут использоваться роли для реализации авторизации. Только пользователи, добавленные `canEdit` роли будут иметь возможность изменять данные (Создание, изменение или удаление контактов).

> [!NOTE] 
> 
> Приложения Windows Live принимать динамический URL-адрес для работающего веб-сайта, только в том случае, поэтому ее невозможно использовать URL-адрес локального веб-сайта для тестирования имен входа.

Следующие действия можно добавить поставщик проверки подлинности Google.

1. Откройте *приложения\_Start\Startup.Auth.cs* файла.
2. Удалите символы комментария из `app.UseGoogleAuthentication()` таким образом, чтобы метод отображается в виде следует: 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample5.cs)]
3. Перейдите к [Google Developers Console](https://console.developers.google.com/). Также необходимо будет выполнить вход с учетной записью электронной почты разработчика Google (gmail.com). Если у вас нет учетной записи Google, выберите **создать учетную запись** ссылку.   
   После этого вы увидите **Google Developers Console**.   
    ![Консоли разработчиков Google](checkout-and-payment-with-paypal/_static/image8.png)
4. Нажмите кнопку **Создание проекта** кнопку и введите имя проекта и идентификатор (можно использовать значения по умолчанию). Щелкните **флажок соглашения** и **создать** кнопки.  

    ![Google — создать проект](checkout-and-payment-with-paypal/_static/image9.png)

   Через несколько секунд будет создан новый проект и в браузере будет отображаться новая страница проектов.
5. На левой вкладке щелкните **API-интерфейсы &amp; auth**, а затем нажмите кнопку **учетные данные**.
6. Нажмите кнопку **создать новый идентификатор клиента** под **OAuth**.   
   **Создание идентификатора клиента** откроется диалоговое окно.   
    ![Google — создать идентификатор клиента](checkout-and-payment-with-paypal/_static/image10.png)
7. В **Создание идентификатора клиента** диалоговое окно, оставьте значение по умолчанию **веб-приложение** для типа приложения.
8. Задайте **Authorized JavaScript Origins** на URL-адрес SSL, использованные ранее в этом руководстве (`https://localhost:44300/` Если вы создали другие проекты SSL).   
   Этот URL-адрес является источником для вашего приложения. В этом примере вводится только тестовый URL-адрес localhost. Тем не менее можно ввести несколько URL-адресов для учетной записи для localhost и производства.
9. Задайте **авторизованный URI перенаправления** следующим: 

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample6.html)]

   Это значение представляет собой URI, который ASP.NET OAuth использует для обмена данными с сервером google OAuth. Помните, приведенном выше URL-адрес SSL ( `https://localhost:44300/` Если вы создали другие проекты SSL).
10. Нажмите кнопку **Создание идентификатора клиента** кнопки.
11. В меню слева в Google Developers Console щелкните **экран согласия** пункта меню, задайте адрес и продукта имени электронной почты. Когда вы заполните форму, щелкните **Сохранить**.
12. Нажмите кнопку **API-интерфейсы** пункта меню, прокрутите вниз и щелкните **off** рядом с пунктом **Google + API**.   
    Принимая этот параметр позволит API Google +.
13. Вы также должны обновить **Microsoft.Owin** пакет NuGet до версии 3.0.0.   
    Из **средства** меню, выберите **диспетчер пакетов NuGet** , а затем выберите **управление пакетами NuGet для решения**.  
    Из **управление пакетами NuGet** окна "," Найти "и" update **Microsoft.Owin** пакет до версии 3.0.0.
14. В Visual Studio, обновите `UseGoogleAuthentication` метод *Startup.Auth.cs* страницы путем копирования и вставки **идентификатор клиента** и **секрет клиента** в метод. **Идентификатор клиента** и **секрет клиента** значений, приведенных ниже примеров и не будет работать. 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample7.cs?highlight=64-65)]
15. Нажмите клавишу **CTRL + F5** для сборки и запуска приложения. Нажмите кнопку **вход** ссылку.
16. В разделе **вход с помощью другой службы**, нажмите кнопку **Google**.  
    ![Войти](checkout-and-payment-with-paypal/_static/image11.png)
17. Если вам нужно ввести учетные данные, вы будете перенаправлены на сайт google, где можно будет ввести свои учетные данные.  
    ![Google — вход](checkout-and-payment-with-paypal/_static/image12.png)
18. После того как вы введете свои учетные данные, вам будет предложено предоставить разрешения на доступ к веб-приложение, которое вы только что создали.  
    ![Учетная запись службы проекта по умолчанию](checkout-and-payment-with-paypal/_static/image13.png)
19. Нажмите кнопку **принимать**. Вы будете перенаправлены обратно **зарегистрировать** странице **WingtipToys** приложения, где можно зарегистрировать учетную запись Google.  
    ![Регистрация с помощью учетной записи Google](checkout-and-payment-with-paypal/_static/image14.png)
20. Вы можете изменить имя регистрации локальной электронной почты для учетной записи Gmail, но обычно требуется сохранить псевдоним электронной почты по умолчанию (то есть той, которая используется для проверки подлинности). Нажмите кнопку **вход** как показано выше.

### <a name="modifying-login-functionality"></a>Изменение функции входа в систему

Как упоминалось ранее в этой серии руководств большая часть функции регистрации пользователя было включено в шаблоне веб-форм ASP.NET по умолчанию. Теперь вы измените значение по умолчанию *Login.aspx* и *Register.aspx* страниц для вызова `MigrateCart` метод. `MigrateCart` Метод связывает вновь вошедшего в систему пользователя с анонимного корзины. Путем сопоставления пользователя и Корзина для покупок, пример приложения Wingtip Toys будет в состоянии поддерживать в корзину для покупок пользователя посещениях.

1. В **обозревателе решений**найдите и откройте *учетной записи* папки.
2. Изменение кода программной части с именем *Login.aspx.cs* в него код, выделенное желтым цветом, таким образом, чтобы он выглядит следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample8.cs?highlight=41-43)]
3. Сохранить *Login.aspx.cs* файла.

Пока проигнорируйте предупреждение, которое не заданы для `MigrateCart` метод. Вы добавите его чуть позже в этом руководстве.

*Login.aspx.cs* файл с выделенным кодом поддерживает метода входа в систему. Путем проверки на страницу Login.aspx, вы увидите, что эта страница содержит кнопки «Вход» что если щелкните триггеры `LogIn` обработчиком для кода.

Когда `Login` метод *Login.aspx.cs* вызывается новый экземпляр класса с именем Корзина для покупок `usersShoppingCart` создается. Идентификатор Корзина для покупок (GUID) извлекается и присвоено `cartId` переменной. Затем `MigrateCart` вызывается метод, передав оба `cartId` и имя пользователя вошедшего в систему для этого метода. При миграции Корзина для покупок, GUID, используемый для определения анонимного корзину заменяется на имя пользователя.

А также изменения *Login.aspx.cs* файл с выделенным кодом для переноса в корзину для покупок, при входе пользователя в, необходимо также изменить *файл с выделенным кодом Register.aspx.cs* для переноса в корзину для покупок Когда пользователь создает новую учетную запись и выполнение входа.

1. В *учетной записи* папку, откройте файл с выделенным кодом с именем *Register.aspx.cs*.
2. Измените файл кода путем включения кода желтым цветом, таким образом, чтобы он выглядит следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample9.cs?highlight=28-32)]
3. Сохранить *Register.aspx.cs* файла. Опять же, пропустите предупреждение о `MigrateCart` метод.

Обратите внимание на то, что код, используемый в `CreateUser_Click` обработчик событий очень похож на код, используемый в `LogIn` метод. Когда пользователь регистрирует или вошел в систему на узле, вызов `MigrateCart` выполняется метод.

## <a name="migrating-the-shopping-cart"></a>Миграция в корзину для покупок

Теперь, когда у вас есть обновить процесс входа и регистрации, можно добавить код для переноса в корзину для покупок с помощью `MigrateCart` метод.

1. В **обозревателе решений**, найти *логики* и откройте *ShoppingCartActions.cs* файл класса.
2. Добавьте выделенный желтым в существующий код в код *ShoppingCartActions.cs* файл, таким образом, чтобы код в *ShoppingCartActions.cs* файла выглядит следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample10.cs?highlight=215-224)]

`MigrateCart` Метод использует существующие cartId для поиска в корзину для покупок пользователя. Затем код проходит по всем элементам корзины покупок и заменяет `CartId` свойства (как указано `CartItem` схемы) с именем пользователя, вошедшего в систему.

### <a name="updating-the-database-connection"></a>Обновление подключения к базе данных

Если вы подписаны на этом руководстве с помощью **готовых** Wingtip Toys пример приложения, необходимо повторно создать базу данных членства по умолчанию. Изменив строку подключения по умолчанию, в базу данных членства будут создаваться при следующем запуске приложения.

1. Откройте *Web.config* файл в корневой папке проекта.
2. Обновите строку подключения по умолчанию, таким образом, чтобы он выглядит следующим образом:   

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample11.xml)]

<a id="PayPalWebForms"></a>
## <a name="integrating-paypal"></a>Интеграция PayPal

PayPal является веб-платформы выставления счетов, который принимает платежей по Интернет-магазины. Далее в этом руководстве описываются интегрировать в приложение Express оформлением в PayPal. Извлечение Express позволяет пользователям использовать PayPal для оплаты для элементов, добавленных в корзину.

### <a name="create-paypal-test-accounts"></a>Создайте учетные записи тестовых PayPal

Чтобы использовать PayPal, в среде тестирования, необходимо создать и проверить тестовую учетную запись разработчика. Будет использовать тестовую учетную запись разработчика для создания покупатель тестовую учетную запись и тестовую учетную запись продавца. Тестовые учетные данные учетной записи разработчика также позволит пример приложения Wingtip Toys получить доступ к тестовой среде PayPal.

1. В браузере перейдите к разработчику PayPal тестирование сайта:   
    [https://developer.paypal.com](https://developer.paypal.com/)
2. Если у вас нет учетной записи разработчика PayPal, создайте новую учетную запись, нажав кнопку **регистрации**и регистрации действия. При наличии существующей учетной записи разработчика PayPal, вход, щелкнув **вход**. Необходимо будет вашей учетной записи разработчика PayPal, чтобы протестировать пример приложения Wingtip Toys далее в этом руководстве.
3. Если вы только что зарегистрировались для учетной записи разработчика PayPal, может потребоваться проверить вашу учетную запись разработчика PayPal с PayPal. Учетной записи можно проверить, выполнив действия, которые PayPal отправлены в учетную запись электронной почты. После проверки учетной записи разработчика PayPal войдите повторно тестирование сайта разработчика PayPal.
4. Вы вошли в систему на сайте разработчика PayPal, с учетной записью разработчика PayPal, что вам нужно создать тестовую учетную запись покупателя PayPal, если этого не сделать уже после одного. Чтобы создать тестовую учетную запись покупателя, на узел PayPal, нажмите кнопку **приложений** вкладке и нажмите кнопку **учетные записи песочницы**.   
 **Тестовых учетных записей "песочницы"** страница показана.   

    > [!NOTE] 
    > 
    > Сайт разработчика PayPal уже предоставляет продавца тестовую учетную запись.

    ![Оформление заказа и Оплата по PayPal - тестовых учетных записей "песочницы"](checkout-and-payment-with-paypal/_static/image15.png)
5. На странице "песочницы" учетные записи, нажмите кнопку **создать учетную запись**.
6. На **создать тестовую учетную запись** странице выбрать покупатель тестовое сообщение электронной почты учетной записи и пароль по своему усмотрению.   

    > [!NOTE] 
    > 
    > Необходимо будет buyer адреса электронной почты и пароль, чтобы протестировать пример приложения Wingtip Toys в конце этого руководства.

    ![Оформление заказа и Оплата по PayPal - тестовых учетных записей "песочницы"](checkout-and-payment-with-paypal/_static/image16.png)
7. Создайте тестовую учетную запись покупателя, нажав кнопку **создать учетную запись** кнопки.  
 **"Песочницы" тестовых учетных записей** откроется страница. 

    ![Оформление заказа и Оплата по PayPal - счета в PayPal](checkout-and-payment-with-paypal/_static/image17.png)
8. На **тестовых учетных записей "песочницы"** щелкните **руководителя** учетную запись электронной почты.  
    **Профиль** и **уведомления** вариантов.
9. Выберите **профиль** , а затем нажмите кнопку **учетные данные API** для просмотра API учетные данные для учетной записи продавца теста.
10. Скопируйте учетные данные API ТЕСТОВ в Блокнот.

Необходимо будет отображается классический API тестирования учетные данные (имя пользователя, пароль и подпись) вызовов API из примера приложения Wingtip Toys PayPal, в среде тестирования. На следующем шаге вы добавите учетные данные.

### <a name="add-paypal-class-and-api-credentials"></a>Добавьте класс PayPal и учетные данные API

Поместите большая часть кода PayPal в один класс. Этот класс содержит методы, используемые для взаимодействия с использованием системы PayPal. Кроме того вы добавите PayPal учетные данные для этого класса.

1. В примере приложения Wingtip Toys в Visual Studio, щелкните правой кнопкой мыши **логики** папку, а затем выберите **добавить**  - &gt; **новый элемент**.   
   Откроется диалоговое окно **Добавление нового элемента**.
2. В разделе **Visual C#** из **установленные** панели слева, выберите **кода**.
3. В средней области выберите **класс**. Назовите этот новый класс **PayPalFunctions.cs**.
4. Нажмите кнопку **Добавить**.  
   Новый файл класса отображается в редакторе.
5. Замените код по умолчанию следующим кодом:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample12.cs)]
6. Добавьте API продавца учетные данные (имя пользователя, пароль и подпись), которые отображаются ранее в этом учебнике, что может принимать вызовы функций в среду тестирования PayPal.  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample13.cs)]

> [!NOTE] 
> 
> В этом примере приложения просто добавляется учетные данные в файл C# (.cs). Тем не менее в решении реализованного следует организовать зашифрованное учетные данные в файле конфигурации.

Класс NVPAPICaller содержит большую часть функциональности PayPal. Код в класс предоставляет методы, необходимые для проверки на покупку из среды тестирования PayPal. Следующие функции PayPal используются для совершения покупок:

- `SetExpressCheckout` функция
- `GetExpressCheckoutDetails` функция
- `DoExpressCheckoutPayment` функция

`ShortcutExpressCheckout` Метод осуществляет сбор теста и сведения о покупке из корзины и вызывает `SetExpressCheckout` функция PayPal. `GetCheckoutDetails` Метод подтверждает сведения о покупке и вызывает метод `GetExpressCheckoutDetails` функция PayPal перед совершения покупки теста. `DoCheckoutPayment` Метод завершает покупку тестов из тестовой среды, вызывая метод `DoExpressCheckoutPayment` функция PayPal. Оставшийся код поддерживает методы PayPal и процесса, например кодирование строк, декодирование строки, обработка массивов и определение учетных данных.

> [!NOTE] 
> 
> PayPal позволяет включать сведения о покупке необязательно, на основе [спецификации API в PayPal](https://cms.paypal.com/us/cgi-bin/?cmd=_render-content&amp;content_ID=developer/e_howto_api_nvp_r_SetExpressCheckout). Добавив код в примере приложения Wingtip Toys, можно включить сведения о локализации, описания продукции, tax, номеру службы поддержки клиентов, а также множество других полей необязательно.

Обратите внимание, что возврат "и" Отмена URL-адреса, которые указаны в **ShortcutExpressCheckout** метод использовать номер порта.

[!code-html[Main](checkout-and-payment-with-paypal/samples/sample14.html)]

При Visual Web Developer запускает веб-проекта с помощью протокола SSL, обычно порту 44300 во используется для веб-сервера. Как показано выше, номер порта — 44300 во. При запуске приложения, вы увидите другой номер порта. Потребностей номера порта для правильной настройки в коде, где можно успешно запустить пример приложения Wingtip Toys по завершении работы с этим руководством. В следующем разделе этого руководства показано, как получить номер порта локального узла и обновите класс PayPal.

### <a name="update-the-localhost-port-number-in-the-paypal-class"></a>Обновите номер порта LocalHost в классе PayPal

Пример приложения Wingtip Toys осуществляет закупку такой продукции, перейдя на сайт PayPal для тестирования и возвращение к локальному экземпляру примера приложения Wingtip Toys. Чтобы вернуть правильный URL-адрес PayPal, необходимо указать номер порта, локально работающих пример приложения в коде PayPal, упомянутых выше.

1. Щелкните правой кнопкой мыши имя проекта (**WingtipToys**) в **обозревателе решений** и выберите **свойства**.
2. В левом столбце выберите **Web** вкладки.
3. Получить номер порта из **URL-адрес проекта** поле.
4. При необходимости обновите `returnURL` и `cancelURL` в классе PayPal (`NVPAPICaller`) в *PayPalFunctions.cs* файл, используемый номер порта веб-приложения:   

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample15.html?highlight=1-2)]

Теперь код, который вы добавили будет соответствовать ожидаемой порт для локального веб-приложения. PayPal сможет вернуть правильный URL-адрес на локальном компьютере.

### <a name="add-the-paypal-checkout-button"></a>Извлечение PayPal кнопка "Добавить"

Теперь, когда основные функции PayPal были добавлены в пример приложения, можно добавить разметку и код, необходимый для вызова этих функций. Во-первых необходимо добавить кнопку извлечения, пользователь увидит на странице корзины для покупок.

1. Откройте *ShoppingCart.aspx* файла.
2. Прокрутите до нижней части файла и найдите `<!--Checkout Placeholder -->` комментарий.
3. Замените комментарий с `ImageButton` управления позволит разметки заменяется следующим образом:  

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample16.aspx)]
4. В *ShoppingCart.aspx.cs* файл, после того, как `UpdateBtn_Click` добавьте обработчик событий в конце файла, `CheckOutBtn_Click` обработчик событий:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample17.cs)]
5. Кроме того, в *ShoppingCart.aspx.cs* добавьте ссылку на `CheckoutBtn`, таким образом, чтобы кнопки «изображение» указывается следующим образом:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample18.cs?highlight=18)]
6. Сохраните изменения как *ShoppingCart.aspx* файл и *ShoppingCart.aspx.cs* файла.
7. В меню выберите **Отладка**-&gt;**построения WingtipToys**.  
   Проект будет перестроен с только что добавленного **ImageButton** элемента управления.

### <a name="send-purchase-details-to-paypal"></a>Отправить сведения о покупке PayPal

Когда пользователь щелкает **извлечения** кнопку на странице корзины для покупок (*ShoppingCart.aspx*), они начнут процесса покупки. Следующий код вызывает функцию первый PayPal, необходимые для приобретения продуктов.

1. Из *извлечения* папку, откройте файл с выделенным кодом с именем *CheckoutStart.aspx.cs*.   
   Не забудьте открыть файл с выделенным кодом.
2. Замените существующий код следующим кодом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample19.cs)]

Когда пользователь приложения щелкает **извлечения** кнопку на странице корзины для покупок, браузер, произойдет переход к *CheckoutStart.aspx* страницы. Когда *CheckoutStart.aspx* странице загрузок, `ShortcutExpressCheckout` вызывается метод. На этом этапе пользователь передается PayPal тестирования веб-сайта. На сайте PayPal, пользователь вводит свои учетные данные PayPal, просматривает сведения о покупке, принимает PayPal соглашение и возвращает в пример приложения Wingtip Toys где `ShortcutExpressCheckout` завершения метода. Когда `ShortcutExpressCheckout` метод завершения, он будет перенаправлять пользователя для *CheckoutReview.aspx* страницы, указанной в `ShortcutExpressCheckout` метод. Благодаря этому пользователь мог просматривать сведения о заказе из примера приложения Wingtip Toys.

### <a name="review-order-details"></a>Просмотрите сведения о заказе

После возврата из PayPal, *CheckoutReview.aspx* страница примера приложения Wingtip Toys отображает подробности заказа. Эта страница позволяет просмотреть сведения о заказе, прежде чем приобрести продукты. *CheckoutReview.aspx* страницы должна быть создана следующим образом:

1. В *извлечения* папку, откройте страницу с именем *CheckoutReview.aspx*.
2. Замените существующую разметку следующей:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample20.aspx)]
3. Откройте страницу кода с именем *CheckoutReview.aspx.cs* и замените существующий код следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample21.cs)]

**DetailsView** управления используется для отображения сведений о заказе, которые были возвращены из PayPal. Кроме того, приведенный выше код сохраняет сведения о заказе в базу данных Wingtip Toys, как `OrderDetail` объект. Когда пользователь нажимает на **заказ полностью** кнопки, к которому они перенаправляются *CheckoutComplete.aspx* страницы.

> [!NOTE] 
> 
> **Совет**
> 
> В разметке *CheckoutReview.aspx* странице, обратите внимание, что `<ItemStyle>` тег используется для изменения стиля элементов внутри **DetailsView** элемента управления в нижней части страницы. Просмотрев страницу в **конструкторе** (, выбрав **разработки** в левом нижнем углу Visual Studio), выбрав **DetailsView** управления, а затем выбрав  **Смарт-теге** (значок со стрелкой в верхней правой части элемента управления), можно будет увидеть **задачи DetailsView**.
> 
> ![Оформление заказа и Оплата по PayPal - изменение полей](checkout-and-payment-with-paypal/_static/image18.png)
> 
> Выбрав **изменить поля**, **поля** появится диалоговое окно. В этом диалоговом окне можно легко управлять визуальные свойства, такие как **ItemStyle**, из **DetailsView** элемента управления.
> 
> ![Оформление заказа и Оплата по PayPal - поля диалогового окна](checkout-and-payment-with-paypal/_static/image19.png)

### <a name="complete-purchase"></a>Завершить покупку

*CheckoutComplete.aspx* страницы делает покупки из PayPal. Как упоминалось выше, пользователь должен щелкнуть **заказ полностью** кнопку, прежде чем приложение будет переходить к *CheckoutComplete.aspx* страницы.

1. В *извлечения* папку, откройте страницу с именем *CheckoutComplete.aspx*.
2. Замените существующую разметку следующей:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample22.aspx)]
3. Откройте страницу кода с именем *CheckoutComplete.aspx.cs* и замените существующий код следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample23.cs)]

Когда *CheckoutComplete.aspx* загружается страница, `DoCheckoutPayment` вызывается метод. Как упоминалось ранее, `DoCheckoutPayment` покупку из среды тестирования PayPal завершения метода. После завершения покупки заказа, PayPal *CheckoutComplete.aspx* странице отображаются транзакции по оплате `ID` покупателю.

### <a name="handle-cancel-purchase"></a>Дескриптор отменить покупку

Если пользователь решает отменить покупку, им будет предложено *CheckoutCancel.aspx* страницы, где они будут видеть, что их порядок была отменена.

1. Откройте страницу с именем *CheckoutCancel.aspx* в *извлечения* папки.
2. Замените существующую разметку следующей:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample24.aspx)]

### <a name="handle-purchase-errors"></a>Обработка ошибок покупки

Ошибки во время покупки будут обрабатываться *CheckoutError.aspx* страницы. Кодом программной части *CheckoutStart.aspx* странице *CheckoutReview.aspx* странице и *CheckoutComplete.aspx* страницы каждого перенаправит  *CheckoutError.aspx* странице при возникновении ошибки.

1. Откройте страницу с именем *CheckoutError.aspx* в *извлечения* папки.
2. Замените существующую разметку следующей:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample25.aspx)]

*CheckoutError.aspx* откроется страница с сообщением об ошибке при возникновении ошибки во время процесса извлечения.

## <a name="running-the-application"></a>Запуск приложения

Запустите приложение, чтобы узнать, как приобрести продукты. Обратите внимание на то, что вы будете запускать в PayPal среды тестирования. Не фактические суммы расходов, участвующие обмене.

1. Убедитесь, что все файлы сохраняются в Visual Studio.
2. Откройте веб-браузер и перейдите к [ https://developer.paypal.com ](https://developer.paypal.com/).
3. Имя входа с учетной записью разработчика PayPal, созданный ранее в этом учебнике.  
   Для "песочницы" разработчика PayPal, необходимо входить в систему во [ https://developer.paypal.com ](https://developer.paypal.com/) для тестирования express извлечения. Это относится только к "песочницы" PayPal, тестирования, которое не должно PayPal в реальной среде.
4. В Visual Studio нажмите клавишу **F5** запустить пример приложения Wingtip Toys.  
   После перестроения базы данных, браузер и отобразится *Default.aspx* страницы.
5. Добавьте три продукта в корзину покупок, Выбор категории продукта, например «Автомобили» и выбрав **добавить в корзину** рядом с каждого продукта.  
   Корзина для покупок будет отображать выбранного продукта.
6. Нажмите кнопку **PayPal** кнопку для извлечения. 

    ![Оформление заказа и Оплата по PayPal - корзины для покупок](checkout-and-payment-with-paypal/_static/image20.png)

   Идет извлечение требует наличия учетной записи пользователя для примера приложения Wingtip Toys.
7. Нажмите кнопку **Google** ссылки в правой части страницы для входа в систему с помощью существующей учетной записи электронной почты gmail.com.  
   Если у вас нет учетной записи gmail.com, можно создать один для тестирования в [www.gmail.com](https://www.gmail.com/). Также можно использовать стандартный локальную учетную запись, нажав кнопку «Зарегистрировать». 

    ![Оформление заказа и Оплата по PayPal - вход](checkout-and-payment-with-paypal/_static/image21.png)
8. Войдите, используя учетную запись gmail и пароль. 

    ![Оформление заказа и Оплата по PayPal - Gmail входа](checkout-and-payment-with-paypal/_static/image22.png)
9. Нажмите кнопку **вход** кнопку, чтобы зарегистрировать учетную запись gmail на имя пользователя пример приложения Wingtip Toys. 

    ![Оформление заказа и Оплата по PayPal - Регистрация учетной записи](checkout-and-payment-with-paypal/_static/image23.png)
10. На сайте тестирования PayPal, добавьте вашей **buyer** адрес и пароль, созданный ранее в этом учебнике электронной почты, а затем нажмите кнопку **вход** кнопки. 

    ![Оформление заказа и Оплата по PayPal - PayPal входа](checkout-and-payment-with-paypal/_static/image24.png)
11. Согласиться с политикой PayPal и нажмите кнопку **принимаю и продолжить** кнопки.  
    Обратите внимание, что данная страница применяется только отображается при первом использовании этой учетной записи PayPal. Снова Обратите внимание, что это тестовую учетную запись, обмен которыми осуществляется не реальные возможности прибыли. 

    ![Оформление заказа и Оплата по PayPal - политики PayPal](checkout-and-payment-with-paypal/_static/image25.png)
12. Просмотрите сведения о заказе на PayPal тестирование среды страница «Просмотр» и нажмите кнопку **Продолжить**. 

    ![Оформление заказа и Оплата по PayPal - проверка сведений](checkout-and-payment-with-paypal/_static/image26.png)
13. На *CheckoutReview.aspx* странице проверьте сумма заказа и просмотреть созданный адрес. Щелкните **заказ полностью** кнопки. 

    ![Оплата по PayPal - проверки заказа и извлечение](checkout-and-payment-with-paypal/_static/image27.png)
14. **CheckoutComplete.aspx** откроется страница с идентификатором транзакции оплаты. 

    ![Оформление заказа и Оплата по PayPal - завершения извлечения](checkout-and-payment-with-paypal/_static/image28.png)

<a id="ReviewDBWebForms"></a>
## <a name="reviewing-the-database"></a>Просмотр базы данных

Просмотрев обновленные данные в базе данных приложения Wingtip Toys после запуска приложения, вы увидите, что приложение успешно записано покупки продуктов.

Вы можете проверить данные, содержащиеся в *Wingtiptoys.mdf* файл базы данных с помощью **обозреватель баз данных** окна (**обозревателя серверов** окно в Visual Studio) так же, как ранее в этой серии руководств.

1. Закройте окно браузера, если он все еще открыт.
2. В Visual Studio выберите **Показать все файлы** значок в верхней части **обозревателе решений** чтобы можно было развернуть **приложения\_данных** папки.
3. Разверните **приложения\_данных** папки.  
 Необходимо выбрать **Показать все файлы** значок папки.
4. Щелкните правой кнопкой мыши *Wingtiptoys.mdf* файлу базы данных и выберите **откройте**.  
    **Обозреватель серверов** отображается.
5. Разверните **таблиц** папки.
6. Щелкните правой кнопкой мыши **заказы**таблицы и выберите **Показать таблицу данных**.  
 **Заказы** отображается таблица.
7. Просмотрите **PaymentTransactionID** столбца, чтобы подтвердить успешных транзакций. 

    ![Оформление заказа и Оплата по PayPal - Обзор базы данных](checkout-and-payment-with-paypal/_static/image29.png)
8. Закрыть **заказы** окно таблицы.
9. В обозревателе сервера щелкните правой кнопкой мыши **OrderDetails** таблицы и выберите **Показать таблицу данных**.
10. Просмотрите `OrderId` и `Username` значения в **OrderDetails** таблицы. Обратите внимание, что эти значения соответствуют `OrderId` и `Username` значений, включенных в **заказы** таблицы.
11. Закрыть **OrderDetails** окно таблицы.
12. Щелкните правой кнопкой мыши файл базы данных Wingtip Toys (*Wingtiptoys.mdf*) и выберите **закрыть соединение**.
13. Если вы не видите **обозревателе решений** окно, нажмите кнопку **обозревателе решений** в нижней части **обозревателя серверов** окно, чтобы отобразить **обозревателе решений**  еще раз.

## <a name="summary"></a>Сводка

В этом руководстве вы добавили, порядок и порядок сведений схемы для отслеживания покупки продуктов. Также Вы интегрировали функции PayPal в пример приложения Wingtip Toys.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Общие сведения о конфигурации ASP.NET](https://msdn.microsoft.com/library/ms178683(v=vs.100).aspx)  
[Развертывание безопасного веб-форм приложение ASP.NET с членством, OAuth и базой данных SQL в службе приложений Azure](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-deploy-aspnet-webforms-app-membership-oauth-sql-database/)  
[Microsoft Azure — бесплатная пробная версия](https://azure.microsoft.com/pricing/free-trial/)

## <a name="disclaimer"></a>Отказ от ответственности

Этот учебник содержит пример кода. Такой пример кода предоставляется «как есть» без каких-либо гарантий. Соответственно Microsoft не гарантирует точность, целостность или качество кода примера. Вы соглашаетесь с помощью образца кода на свой страх и риск. Ни при каких условиях Майкрософт несут вам никоим образом для всех примеров кода, содержимого, включая, но не ограничиваясь, ошибки или пропуски в всех примеров кода, содержимое, или любой убытки или любые убытки, уплаченных использование всех примеров кода. Настоящим уведомление и тем самым соглашаетесь возместить, сохраните и исков Майкрософт по с и с любые потери, утверждений потери, травм или повреждений любого вида включая, без ограничений, occasioned по или поступающие из материалов, в которой можно размещать передачи, использовать или зависят от того, включая, помимо прочего, мнения, представленные этой последовательности.

> [!div class="step-by-step"]
> [Назад](shopping-cart.md)
> [Вперед](membership-and-administration.md)
