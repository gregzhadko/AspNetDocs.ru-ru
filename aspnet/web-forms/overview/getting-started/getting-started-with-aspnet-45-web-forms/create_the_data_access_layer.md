---
uid: web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/create_the_data_access_layer
title: Создание уровня доступа к данным | Документация Майкрософт
author: Erikre
description: В этой серии руководств вы узнаете об основах создания приложения ASP.NET Web Forms с помощью ASP.NET 4,5 и Microsoft Visual Studio Express 2013...
ms.author: riande
ms.date: 09/08/2014
ms.assetid: 0bbf7a6e-d7eb-4091-91e4-fff892777f32
msc.legacyurl: /web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/create_the_data_access_layer
msc.type: authoredcontent
ms.openlocfilehash: 0fcf050474a57be9ed53ec0783a6d6b7dde2bf4c
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74575752"
---
# <a name="create-the-data-access-layer"></a>Создание уровня доступа к данным

по [Эрик Реитан](https://github.com/Erikre)

[Скачайте образец проекта Wingtip Toys (C#)](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) или [Загрузите электронную книгу (PDF)](https://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20ASP.NET%204.5%20Web%20Forms%20and%20Visual%20Studio%202013.pdf)

> В этой серии руководств вы узнаете об основах создания приложения ASP.NET Web Forms с помощью ASP.NET 4,5 и Microsoft Visual Studio Express 2013 для Web. Для этой серии руководств доступен [проект Visual Studio 2013 с C# исходным кодом](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) .

В этом учебнике описывается создание, доступ и проверка данных из базы данных с помощью веб-форм ASP.NET и Entity Framework Code First. Это руководство построено на предыдущем учебном курсе «создание проекта» и входит в серию руководств по магазину Wingtip Toy Store. По завершении работы с этим руководством вы будете создавать группу классов доступа к данным, которые находятся в папке *Models* проекта.

## <a name="what-youll-learn"></a>Что вы узнаете:

- Создание моделей данных.
- Инициализация и заполнение базы данных.
- Обновление и настройка приложения для поддержки базы данных.

### <a name="these-are-the-features-introduced-in-the-tutorial"></a>Ниже приведены функции, представленные в этом учебнике.

- Entity Framework Code First
- LocalDB
- Заметки к данным

## <a name="creating-the-data-models"></a>Создание моделей данных

[Entity Framework](https://msdn.microsoft.com/data/aa937723) — это платформа объектно-реляционного СОПОСТАВЛЕНИЯ (ORM). Он позволяет работать с реляционными данными как с объектами, устраняя большую часть кода доступа к данным, который обычно требуется написать. С помощью Entity Framework можно выдавать запросы с помощью [LINQ](https://msdn.microsoft.com/library/bb397926.aspx), а затем получать и манипулировать данными в виде строго типизированных объектов. LINQ предоставляет шаблоны для запросов и обновления данных. Использование Entity Framework позволяет сосредоточиться на создании оставшейся части приложения, а не на основных понятиях доступа к данным. Далее в этой серии руководств мы покажем, как использовать данные для заполнения переходов и запросов продуктов.

Entity Framework поддерживает парадигму разработки, именуемую *Code First*. Code First позволяет определять модели данных с помощью классов. Класс — это конструкция, позволяющая создавать собственные пользовательские типы, объединяя переменные других типов, методов и событий. Можно сопоставлять классы с существующей базой данных или использовать их для создания базы данных. В этом руководстве вы создадите модели данных, создав классы модели данных. Затем вы разрешите Entity Framework создать базу данных на лету на основе этих новых классов.

Начнем с создания классов сущностей, определяющих модели данных для приложения веб-форм. Затем будет создан класс контекста, управляющий классами сущностей и предоставляющий доступ к базе данных. Также будет создан класс инициализатора, который будет использоваться для заполнения базы данных.

### <a name="entity-framework-and-references"></a>Entity Framework и ссылки

По умолчанию Entity Framework включается при создании нового **веб-приложения ASP.NET** с помощью шаблона **веб-форм** . Entity Framework можно установить, удалить и обновить как пакет NuGet.

Этот пакет NuGet включает в проект следующие сборки **среды выполнения** :

- EntityFramework. dll — весь распространенный код среды выполнения, используемый Entity Framework
- EntityFramework. SqlServer. dll — поставщик Microsoft SQL Server для Entity Framework

### <a name="entity-classes"></a>Классы сущностей

Классы, создаваемые для определения схемы данных, называются классами сущностей. Если вы не знакомы с проектированием базы данных, подумайте о классах сущностей в качестве определений таблиц базы данных. Каждое свойство в классе указывает столбец в таблице базы данных. Эти классы предоставляют упрощенный объектно-реляционный интерфейс между объектно-ориентированным кодом и реляционной табличной структурой базы данных.

В этом руководстве мы начнем с добавления простых классов сущностей, представляющих схемы для продуктов и категорий. Класс Products будет содержать определения для каждого продукта. Имя каждого из членов класса Product будет `ProductID`, `ProductName`, `Description`, `ImagePath`, `UnitPrice`, `CategoryID`и `Category`. Класс category будет содержать определения для каждой категории, к которой может принадлежать продукт, например автомобиля, в форме самолета или плоскости. Имя каждого из членов класса category будет `CategoryID`, `CategoryName`, `Description`и `Products`. Каждый продукт будет принадлежать к одной из категорий. Эти классы сущностей будут добавлены в папку существующих *моделей* проекта.

1. В **Обозреватель решений**щелкните правой кнопкой мыши папку *Models* и выберите **добавить** -&gt; **новый элемент**. 

    ![Создание уровня доступа к данным — меню "создать элемент"](create_the_data_access_layer/_static/image1.png)

   Откроется диалоговое окно **Добавление нового элемента**.
2. В **разделе C# визуальный** элемент на панели **установленные** слева выберите **код**. 

    ![Создание уровня доступа к данным — меню "создать элемент"](create_the_data_access_layer/_static/image2.png)
3. Выберите **класс** из средней области и назовите этот новый класс *Product.CS*.
4. Нажмите кнопку **Добавить**.  
   В редакторе отобразится новый файл класса.
5. Замените код по умолчанию следующим кодом:   

    [!code-csharp[Main](create_the_data_access_layer/samples/sample1.cs)]
6. Создайте другой класс, повторив шаги 1 – 4, но назовите новый класс *Category.CS* и замените код по умолчанию следующим кодом:  

    [!code-csharp[Main](create_the_data_access_layer/samples/sample2.cs)]

Как упоминалось выше, класс `Category` представляет тип продукта, предназначенного для продажи приложением (например, <a id="a"></a>&quot;автомобили&quot;, &quot;Боатс&quot;, &quot;Роккетс&quot;и т. д.), а класс `Product` представляет отдельные продукты (Toys) в базе данных. Каждый экземпляр объекта `Product` будет соответствовать строке в таблице реляционной базы данных, а каждое свойство класса Product будет сопоставляться со столбцом в таблице реляционной базы данных. Далее в этом учебнике вы просматриваете данные о продуктах, содержащиеся в базе данных.

### <a name="data-annotations"></a>Заметки к данным

Вы могли заметить, что некоторые члены классов имеют атрибуты, указывающие сведения об элементе, например `[ScaffoldColumn(false)]`. Это *заметки к данным*. Атрибуты аннотации данных могут описывать, как проверить вводимые пользователем данные для этого элемента, задать для него форматирование и указать, как он моделируется при создании базы данных.

### <a name="context-class"></a>Класс Context

Чтобы приступить к использованию классов для доступа к данным, необходимо определить класс контекста. Как упоминалось ранее, класс контекста управляет классами сущностей (например, классом `Product` и классом `Category`) и предоставляет доступ к базе данных.

Эта процедура добавляет новый C# класс контекста в папку *Models* .

1. Щелкните правой кнопкой мыши папку *Models* и выберите **Добавить** -&gt; **новый элемент**.   
   Откроется диалоговое окно **Добавление нового элемента**.
2. Выберите **класс** в средней области, назовите его *ProductContext.CS* и нажмите кнопку **добавить**.
3. Замените код по умолчанию, содержащийся в классе, следующим кодом:   

    [!code-csharp[Main](create_the_data_access_layer/samples/sample3.cs)]

Этот код добавляет пространство имен `System.Data.Entity`, чтобы иметь доступ ко всем основным функциональным возможностям Entity Framework, включая возможность запросов, вставки, обновления и удаления данных путем работы со строго типизированными объектами.

Класс `ProductContext` представляет контекст базы данных продукта Entity Framework, который обрабатывает выборку, хранение и обновление экземпляров класса `Product` в базе данных. Класс `ProductContext` является производным от базового класса `DbContext`, предоставляемого Entity Framework.

### <a name="initializer-class"></a>Класс инициализатора

Для инициализации базы данных при первом использовании контекста необходимо выполнить определенную пользовательскую логику. Это позволит добавить начальные данные в базу данных, чтобы можно было сразу же отображать продукты и категории.

Эта процедура добавляет новый C# класс инициализатора в папку *Models* .

1. Создайте еще одну `Class` в папке *Models* и назовите ее *ProductDatabaseInitializer.CS*.
2. Замените код по умолчанию, содержащийся в классе, следующим кодом:   

    [!code-csharp[Main](create_the_data_access_layer/samples/sample4.cs)]

Как видно из приведенного выше кода, при создании и инициализации базы данных свойство `Seed` переопределяется и задается. Если задано свойство `Seed`, для заполнения базы данных используются значения из категорий и продуктов. При попытке обновить данные начального значения путем изменения приведенного выше кода после создания базы данных никакие обновления не будут отображаться при запуске веб-приложения. Причина в том, что приведенный выше код использует реализацию класса `DropCreateDatabaseIfModelChanges`, чтобы распознать, изменилась ли модель (схема) перед сбросом начальных данных. Если `Category` и `Product` классы сущностей не были изменены, то база данных не будет повторно инициализирована с начальными данными.

> [!NOTE] 
> 
> Если требуется, чтобы база данных была создана заново при каждом запуске приложения, можно использовать класс `DropCreateDatabaseAlways` вместо класса `DropCreateDatabaseIfModelChanges`. Однако в этой серии руководств используется класс `DropCreateDatabaseIfModelChanges`.

На этом этапе в этом учебнике у вас будет папка *Models* с четырьмя новыми классами и одним классом по умолчанию:

![Создание уровня доступа к данным — папка "модели"](create_the_data_access_layer/_static/image3.png)

### <a name="configuring-the-application-to-use-the-data-model"></a>Настройка приложения для использования модели данных

Теперь, когда вы создали классы, представляющие данные, необходимо настроить приложение для использования классов. В файле *Global. asax* добавляется код, который инициализирует модель. В файле *Web. config* добавьте сведения, указывающие приложению, какая база данных будет использоваться для хранения данных, представленных новыми классами данных. Файл *Global. asax* можно использовать для управления событиями или методами приложения. Файл *Web. config* позволяет управлять конфигурацией веб-приложения ASP.NET.

#### <a name="updating-the-globalasax-file"></a>Обновление файла Global. asax

Чтобы инициализировать модели данных при запуске приложения, необходимо обновить обработчик `Application_Start` в файле *Global.asax.CS* .

> [!NOTE] 
> 
> В обозреватель решений можно выбрать либо файл *Global. asax* , либо файл *Global.asax.CS* , чтобы изменить файл *Global.asax.CS* .

1. Добавьте следующий код, выделенный желтым цветом, в метод `Application_Start` в файле *Global.asax.CS* .   

    [!code-csharp[Main](create_the_data_access_layer/samples/sample5.cs?highlight=9-10,22-23)]

> [!NOTE] 
> 
> Браузер должен поддерживать HTML5 для просмотра кода, выделенного желтым цветом, при просмотре этой серии руководств в браузере.

Как показано в приведенном выше коде, при запуске приложения в приложении указывается инициализатор, который будет выполняться во время первого обращения к данным. Для доступа к объекту `Database` и объекту `ProductDatabaseInitializer` требуются два дополнительных пространства имен.

 Изменение файла Web. config 

Несмотря на то, что Entity Framework Code First создаст базу данных в расположении по умолчанию, когда база данных заполняется начальными данными, добавление в приложение собственных сведений о подключении позволяет управлять расположением базы данных. Это подключение к базе данных указывается с помощью строки подключения в файле *Web. config* приложения в корне проекта. Добавив новую строку подключения, можно указать расположение базы данных (*wingtiptoys. mdf*), которая должна быть создана в каталоге данных приложения (*Данные приложения\_* ), а не его расположение по умолчанию. Внесение этого изменения позволит найти и проверить файл базы данных далее в этом руководстве.

1. В **Обозреватель решений**найдите и откройте файл *Web. config* .
2. Добавьте строку подключения, выделенную желтым цветом, в раздел `<connectionStrings>` файла *Web. config* следующим образом:  

    [!code-xml[Main](create_the_data_access_layer/samples/sample6.xml?highlight=4-7)]

При первом запуске приложения будет построена база данных в расположении, указанном в строке подключения. Но перед запуском приложения создадим его первым.

## <a name="building-the-application"></a>Сборка приложения

Чтобы убедиться, что все классы и изменения в веб-приложении работают, следует создать приложение.

1. В меню **Отладка** выберите команду **построить WingtipToys**.  
 Появится окно вывод, и если все прошло успешно, появится сообщение об *успешной* **отводе** .  

    ![Создание уровня доступа к данным — окна вывода](create_the_data_access_layer/_static/image4.png)

При возникновении ошибки повторно проверьте указанные выше шаги. Информация в окне **вывод** указывает на то, какой файл имеет ошибку, и в каком файле требуется изменение. Эта информация позволит вам определить, какую часть описанных действий необходимо проверить и исправить в проекте.

## <a name="summary"></a>Сводка

В этом руководстве по ряду вы создали модель данных, а также добавили код, который будет использоваться для инициализации и заполнения базы данных. Вы также настроили приложение для использования моделей данных при запуске приложения.

В следующем руководстве вы обновите пользовательский интерфейс, добавите навигацию и получите данные из базы данных. Это приведет к тому, что база данных будет автоматически создана на основе классов сущностей, созданных в этом руководстве.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Обзор Entity Framework](https://msdn.microsoft.com/library/bb399567.aspx)   
[Руководство для начинающих по Entity Framework ADO.NET](https://msdn.microsoft.com/data/ee712907)   
[Разработка Code First с помощью Entity Framework](http://www.msteched.com/2010/Europe/DEV212) (видео)   
[Code First связей API Fluent](https://msdn.microsoft.com/data/hh134698)   
[Code First заметок к данным](https://msdn.microsoft.com/data/gg193958)  
[Улучшения производительности для Entity Framework](https://blogs.msdn.com/b/efdesign/archive/2010/06/21/productivity-improvements-for-the-entity-framework.aspx?wa=wsignin1.0)

> [!div class="step-by-step"]
> [Назад](create-the-project.md)
> [Вперед](ui_and_navigation.md)
