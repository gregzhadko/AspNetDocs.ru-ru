---
uid: web-forms/overview/moving-to-aspnet-20/data-source-controls
title: Элементы управления исходом данных (ru) Документы Майкрософт
author: rick-anderson
description: Контроль DataGrid в ASP.NET 1.x ознаменовал значительное улучшение доступа к данным в веб-приложениях. Тем не менее, это не было столь же удобным для пользователя, как это, возможно, было....
ms.author: riande
ms.date: 02/20/2005
ms.assetid: 78fd0e92-f9c6-4e96-a5e9-0375b307a828
msc.legacyurl: /web-forms/overview/moving-to-aspnet-20/data-source-controls
msc.type: authoredcontent
ms.openlocfilehash: 2b4302b509af57dc5d9db9de9ee824df767d0737
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540224"
---
# <a name="data-source-controls"></a>Элементы управления источником данных

[корпорацией Майкрософт](https://github.com/microsoft)

> Контроль DataGrid в ASP.NET 1.x ознаменовал значительное улучшение доступа к данным в веб-приложениях. Тем не менее, это не было так удобно, как это могло бы быть. Для получения полезной функциональности по-прежнему требуется значительное количество кода. Такова модель во всех усилиях по доступу к данным в 1.x.

Контроль DataGrid в ASP.NET 1.x ознаменовал значительное улучшение доступа к данным в веб-приложениях. Тем не менее, это не было так удобно, как это могло бы быть. Для получения полезной функциональности по-прежнему требуется значительное количество кода. Такова модель во всех усилиях по доступу к данным в 1.x.

ASP.NET 2.0 решает эту проблему, частично с помощью элементов управления исходом данных. Элементы управления источниками данных в ASP.NET 2.0 предоставляют разработчикам декларативную модель для извлечения данных, отображения данных и редактирования данных. Цель управления источниками данных заключается в обеспечении последовательного представления данных в элементы управления, связанные с данными, независимо от источника этих данных. В основе управления источником данных в ASP.NET 2.0 лежит абстрактный класс DataSourceControl. Класс DataSourceControl обеспечивает базовую реализацию интерфейса IDataSource и интерфейса IListSource, последний из которых позволяет назначить элемент управления исходом данных в качестве DataSource управления данными (через новое свойство DataSourceId, обсуждаемое позже) и предоставить данные в нем как список. Каждый список данных из управления источниками данных разоблачается как объект DataSourceView. Доступ к экземплярам DataSourceView обеспечивается интерфейсом IDataSource. Например, метод GetViewNames возвращает ICollection, который позволяет перечислять DataSourceViews, связанные с определенным элементом управления источниками данных, а метод GetView позволяет получить доступ к определенному экземпляру DataSourceView по имени.

Элементы управления источниками данных не имеют пользовательского интерфейса. Они реализованы в качестве управления сервером, чтобы они могли поддерживать декларативный синтаксис и чтобы они имели доступ к состоянию страницы при желании. Элементы управления источниками данных не наносят клиенту никакой HTML-наценки.

> [!NOTE]
> Как вы увидите позже, есть также преимущества кэширования, полученные с помощью элементов управления исходом данных.

## <a name="storing-connection-strings"></a>Хранение строк соединения

Прежде чем мы получим в поиске того, как настроить элементы управления исходом данных, мы должны охватывать новые возможности в ASP.NET 2.0 относительно строк соединения. ASP.NET 2.0 вводит новый раздел в файле конфигурации, который позволяет легко хранить строки соединения, которые могут быть считываемы миноносно во время выполнения. Раздел &lt;connectionStrings&gt; упрощает хранение строк соединения.

Фрагмент ниже добавляет новую строку соединения.

[!code-xml[Main](data-source-controls/samples/sample1.xml)]

> [!NOTE]
> Как и &lt;в разделе&gt; appSettings, &lt;&gt; раздел connectionStrings &lt;отображается&gt; за пределами раздела system.web в файле конфигурации.

Для использования этой строки соединения можно использовать следующий синтаксис при настройке атрибута Управления сервером ConnectionString.

[!code-aspx[Main](data-source-controls/samples/sample2.aspx)]

Раздел &lt;connectionStrings&gt; также может быть зашифрован, чтобы конфиденциальная информация не подвергалась воздействию. Эта способность будет описана в более позднем модуле.

## <a name="caching-data-sources"></a>Кэширование источников данных

Каждый DataSourceControl предоставляет четыре свойства для настройки кэширования; EnableCaching, CacheDuration, CacheExationPolicy и CacheKeyDependency.

## <a name="enablecaching"></a>EnableCaching

EnableCaching — это свойство Boolean, определяющее, включен ли кэширование для управления источником данных.

## <a name="cacheduration-property"></a>Свойство CacheDuration

Свойство CacheDuration устанавливает количество секунд, которые остается действительным. Установка этого свойства до **0** приводит к тому, что кэш остается в силе до явного признания недействительным.

## <a name="cacheexpirationpolicy-property"></a>Свойство CacheExpirationPolicy

Свойство CacheExpirationPolicy может быть установлено либо **в Абсолют,** либо **в раздвижном.** Установка его на Абсолют означает, что максимальное время, которое будет кэшировано данных, — это количество секунд, указанное свойством CacheDuration. Установив его на Sliding, время истечения времени сбросируется при выполнении каждой операции.

## <a name="cachekeydependency-property"></a>Свойство CacheKeyDependency

Если значение строки указывается для свойства CacheKeyDependency, ASP.NET на основе этой строки создаст новую зависимость кэша. Это позволяет явно аннулировать кэш, просто изменяя или удаляя CacheKeyDependency.

**Важно:** Если олицетворение включено и доступ к источнику данных и/или содержанию данных основан на идентификации клиента, рекомендуется отключить кэширование, установив EnableCaching на False. Если кэширование включено в этом сценарии и пользователь, не являвшийся пользователем, который первоначально запрашивал запрос данных, авторизация источника данных не выполняется. Данные будут просто подаваться из кэша.

## <a name="the-sqldatasource-control"></a>Контроль SqlDataSource

Контроль SqlDataSource позволяет разработчику получить доступ к данным, хранящимся в любой реляционной базе данных, которая поддерживает ADO.NET. Он может использовать провайдера System.Data.SqlClient для доступа к базе данных сервера S'L, провайдеру System.Data.OleDb, провайдеру System.Data.Odbc или поставщику Услуг System.Data.OracleClient для доступа к Oracle. Таким образом, SqlDataSource, безусловно, используется не только для доступа к данным в базе данных сервера S'L.

Для того, чтобы использовать SlDataSource, вы просто предоставляете значение для свойства ConnectionString и указать команду или сохраненную процедуру S'L. Управление SqlDataSource заботится о работе с базовой архитектурой ADO.NET. Он открывает соединение, запрашивает источник данных или выполняет сохраненную процедуру, возвращает данные, а затем закрывает соединение для вас.

> [!NOTE]
> Поскольку класс DataSourceControl автоматически закрывает соединение для вас, это должно уменьшить количество вызовов клиентов, генерируемых утечкой соединений базы данных.

Фрагмент кода ниже связывает элемент управления DropDownList с управлением SqlDataSource, используя строку соединения, которая хранится в файле конфигурации, как показано выше.

[!code-aspx[Main](data-source-controls/samples/sample3.aspx)]

Как показано выше, свойство DataSourceMode SqlDataSource определяет режим для источника данных. В приведенном выше примере DataSourceMode настроен на DataReader. В этом случае SqlDataSource вернет объект IDataReader с помощью курсора только для чтения. Указанный тип возвращенного объекта контролируется используемым поставщиком. В этом случае я использую провайдера System.Data.SqlClient, &lt;указанного&gt; в разделе connectionStrings файла web.config. Таким образом, объект, который возвращается, будет типа SqlDataReader. Указывая значение DataSourceMode DataSet, данные могут храниться в DataSet на сервере. Этот режим позволяет добавлять такие функции, как сортировка, paging и т.д. Если бы я был привязкой данных SqlDataSource к управлению GridView, я бы выбрал режим DataSet. Однако в случае DropDownList режим DataReader является правильным выбором.

> [!NOTE]
> При кэшации SqlDataSource или AccessDataSource свойство DataSourceMode должно быть установлено в DataSet. Исключение произойдет, если вы включите кэширование с помощью DataSourceMode DataReader.

## <a name="sqldatasource-properties"></a>Свойства SqlDataSource

Ниже приведены некоторые из свойств управления SqlDataSource.

### <a name="cancelselectonnullparameter"></a>ОтменаСелеконно-парапарампарат

Значение Boolean, описывающее, отменяется ли выбранная команда, если один из параметров является нулевым. По умолчанию имеет значение TRUE.

### <a name="conflictdetection"></a>КонфликтОбнаружение

В ситуации, когда несколько пользователей могут обновлять источник данных одновременно, свойство ConflictDetection определяет поведение элемента управления SqlDataSource. Это свойство оценивает сярприза к одному из значений перечисления ConflictOptions. Эти значения **CompareAllValues** и **OverwriteChanges.** Если установить OverwriteChanges, последний человек, записавшего данные в источник данных, перезаписывает все предыдущие изменения. Однако, если свойство ConflictDetection настроено на CompareAllValues, параметры создаются для столбцов, возвращенных SelectCommand, и параметры также создаются для удержания исходных значений в каждой из этих столбцов, что позволяет SqlDataSource определить, изменились ли значения с момента выполнения SelectCommand.

### <a name="deletecommand"></a>УдалениеКомандования

Устанавливает или получает строку S'L, используемую при удалении строк из базы данных. Это может быть либо запрос S'L, либо имя сохраненной процедуры.

### <a name="deletecommandtype"></a>DeleteCommandType

Устанавливает или получает тип команды удаления, либо запрос S'L (Текст) или сохраненную процедуру (StoredProcedure).

### <a name="deleteparameters"></a>Удаление Параметры

Возвращает параметры, используемые DeleteCommand объекта SqlDataSourceView, связанного с управлением SqlDataSource.

### <a name="oldvaluesparameterformatstring"></a>OldValuesParameterS

Это свойство используется для определения формата исходных параметров значения в случаях, когда свойство ConflictDetection настроено на CompareAllValues. По умолчанию это {0} означает, что параметры исходного значения будут иметь то же имя, что и исходный параметр. Другими словами, если имя поля employeeID, исходный параметр значения будет @EmployeeID.

### <a name="selectcommand"></a>SelectCommand

Устанавливает или получает строку S'L, которая используется для извлечения данных из базы данных. Это может быть либо запрос S'L, либо имя сохраненной процедуры.

### <a name="selectcommandtype"></a>SelectCommandType

Устанавливает или получает тип выбранной команды, либо запрос S'L (Текст) или сохраненную процедуру (StoredProcedure).

### <a name="selectparameters"></a>Selectparameters

Возвращает параметры, используемые SelectCommand объекта SqlDataSourceView, связанного с управлением SqlDataSource.

### <a name="sortparametername"></a>СортироватьПараспара

Получает или устанавливает имя параметра сохраненной процедуры, который используется при сортировке данных, извлеченных из-за элемента управления источником данных. Действителен только тогда, когда SelectCommandType установлен на StoredProcedure.

### <a name="sqlcachedependency"></a>SqlCacheЗависимость

Полуколонная разграниченная строка с указанием баз данных и таблиц, используемых в зависимости к кэша сервера S'L. (Зависимости кэша S'L будут обсуждаться в более позднем модуле.)

### <a name="updatecommand"></a>ОбновлениеКоманда

Устанавливает или получает строку S'L, которая используется при обновлении данных в базе данных. Это может быть либо запрос S'L, либо имя сохраненной процедуры.

### <a name="updatecommandtype"></a>ОбновлениеCommandType

Устанавливает или получает тип команды обновления, либо запрос S'L (Текст) или сохраненную процедуру (StoredProcedure).

### <a name="updateparameters"></a>Параметры обновления

Возвращает параметры, используемые UpdateCommand объекта SqlDataSourceView, связанного с управлением SqlDataSource.

## <a name="the-accessdatasource-control"></a>Контроль доступаКдатаИсточник

Контроль AccessDataSource происходит от класса SqlDataSource и используется для передачи данных в базу данных Microsoft Access. Свойство ConnectionString для управления AccessDataSource является свойством только для чтения. Вместо использования свойства ConnectionString свойство DataFile используется для указать на базу данных доступа, как показано ниже.

[!code-aspx[Main](data-source-controls/samples/sample4.aspx)]

AccessDataSource всегда будет устанавливать ProviderName базы SqlDataSource на System.Data.OleDb и подключается к базе данных с помощью поставщика Microsoft.Jet.OLEDB.4.0 OLE DB. Вы не можете использовать элемент управления AccessDataSource для подключения к защищенной паролем базе данных Access. Если вам нужно подключиться к защищенной паролем базе данных, вы должны использовать элемент управления SqlDataSource.

> [!NOTE]
> Базы данных доступа, хранящиеся\_на веб-узле, должны быть помещены в каталог данных приложений. ASP.NET не разрешает просматривать файлы в этом каталоге. При использовании баз данных Access необходимо предоставить\_учетную запись процесса Вкаталоге данных App Data.

## <a name="the-xmldatasource-control"></a>Контроль XmlDataSource

XmlDataSource используется для передачи данных данных XML к управлению, связанным с данными. Вы можете привязаться к файлу XML с помощью свойства DataFile или привязать сярприза к строке XML с помощью свойства Data. XmlDataSource предоставляет атрибуты XML в качестве связующих полей. В тех случаях, когда необходимо привязаться к значениям, которые не представлены в качестве атрибутов, необходимо использовать преобразование XSL. Вы также можете использовать выражения XPath для фильтрации данных XML.

Рассмотрим следующий файл XML:

[!code-xml[Main](data-source-controls/samples/sample5.xml)]

Обратите внимание, что XmlDataSource использует свойство XPath *людей/персоны* для фильтрации только на узлах &lt;Person.&gt; Затем DropDownList связывается с атрибутом LastName с помощью свойства DataTextField.

В то время как элемент управления XmlDataSource в основном используется для передачи данных только для чтения данных XML, можно отредактировать файл данных XML. Обратите внимание, что в таких случаях автоматическая вставка, обновление и удаление информации в файле XML происходит не автоматически, как это происходит с другими элементами управления источниками данных. Вместо этого вам придется написать код, чтобы вручную отсеить данные, используя следующие методы управления XmlDataSource.

### <a name="getxmldocument"></a>GetXmlДокумент

Извлекает объект XmlDocument, содержащий код XML, полученный XmlDataSource.

### <a name="save"></a>Сохранять

Сохраняет в памяти XmlDocument обратно в источник данных.

Важно понимать, что метод Сохранения будет работать только при соблюдении следующих двух условий:

1. XmlDataSource использует свойство DataFile для привязки к файлу XML вместо свойства Data для привязки к данным XML в памяти.
2. Преобразование не указывается через свойство Transform или TransformFile.

Обратите внимание также, что метод Сохранения может дать неожиданные результаты при одновременном вызове несколькими пользователями.

## <a name="the-objectdatasource-control"></a>Элемент управления ObjectDataSource

Элементы управления источниками данных, которые мы покрывали до этого момента, являются отличным выбором для двухуровневых приложений, где элемент управления источником данных непосредственно передается в хранилище данных. Однако многие реальные приложения являются многоуровневыми приложениями, где элемент управления источниками данных может потребоваться для связи с бизнес-объектом, который, в свою очередь, общается со слоем данных. В таких ситуациях ObjectDataSource заполняет счет красиво. ObjectDataSource работает в сочетании с исходным объектом. Элемент управления ObjectDataSource создаст экземпляр исходного объекта, вызовет указанный метод и утилизирует экземпляр объекта в рамках одного запроса, если у объекта вместо статических методов (общие в Visual Basic). Таким образом, ваш объект должен быть апосильным. То есть ваш объект должен приобретать и выпускать все необходимые ресурсы в течение всего срока действия одного запроса. Вы можете контролировать, как создается исходный объект, обрабатывая событие ObjectCreating управления ObjectDataSource. Можно создать экземпляр исходного объекта, а затем установить свойство ObjectInstance класса ObjectDataSourceEventArgs в этом экземпляре. Элемент управления ObjectDataSource будет использовать экземпляр, созданный в событии ObjectCreating, вместо того, чтобы создавать экземпляр самостоятельно.

Если исходный объект для управления ObjectDataSource предоставляет общедоступные статические методы (общие в Visual Basic), которые можно вызвать для извлечения и изменения данных, элемент управления ObjectDataSource вызовет эти методы напрямую. Если элемент управления ObjectDataSource должен создать экземпляр исходного объекта для выполнения вызовов метода, объект должен включать общедоступный конструктор, который не принимает никаких параметров. Управление ObjectDataSource вызовет этот конструктор при построении нового экземпляра исходного объекта.

Если исходный объект не содержит общедоступного конструктора без параметров, можно создать экземпляр исходного объекта, который будет использоваться управлением ObjectDataSource в событии ObjectCreating.

## <a name="specifying-object-methods"></a>Определение методов объекта

Объект исходного кода для управления ObjectDataSource может содержать любое количество методов, которые используются для выбора, вставки, обновления или удаления данных. Эти методы называются элементом управления ObjectDataSource на основе названия метода, идентифицированного с помощью либо Свойства, Вставки, UpdateMethod, или DeleteMethod свойства управления ObjectDataSource. Объект источника может также включать дополнительный метод SelectCount, который идентифицируется управлением ObjectDataSource с помощью свойства SelectCountMethod, который возвращает количество общего числа объектов в источнике данных. Элемент управления ObjectDataSource вызовет метод SelectCount после вызова метода Select для получения общего числа записей в источнике данных для использования при прогульчивой информации.

## <a name="lab-using-data-source-controls"></a>Лаборатория с использованием элементов управления исходом данных

## <a name="exercise-1---displaying-data-with-the-sqldatasource-control"></a>Упражнение 1 - Отображение данных с помощью управления SqlDataSource

Следующее упражнение использует элемент управления SqlDataSource для подключения к базе данных Northwind. Предполагается, что у вас есть доступ к базе данных Northwind в экземпляре S'L Server 2000.

1. Создание нового веб-сайта ASP.NET.
2. Добавьте новый файл web.config.

    1. Нажмите на проект в Solution Explorer и нажмите Добавить новый элемент.
    2. Выберите веб-файл конфигурации из списка шаблонов и нажмите Добавить.
3. Отсваивай &lt;раздел connectionStrings&gt; следующим образом: 

    [!code-aspx[Main](data-source-controls/samples/sample6.aspx)]
4. Переключитесь на представление кода и добавьте атрибут &lt;ConnectionString и атрибут&gt; SelectCommand в элемент управления asp:SqlDataSource следующим образом: 

    [!code-aspx[Main](data-source-controls/samples/sample7.aspx)]
5. Из представления Design добавьте новый элемент управления GridView.
6. Из выпадении источника данных в меню задач GridView выберите SqlDataSource1.
7. Нажмите на кнопку Default.aspx и выберите View in Browser из меню. Нажмите Да, когда предложено сохранить.
8. GridView отображает данные из таблицы Продуктов.

## <a name="exercise-2---editing-data-with-the-sqldatasource-control"></a>Упражнение 2 - Редактирование данных с помощью управления SqlDataSource

Следующее упражнение демонстрирует, как связывать данные управления DropDownList с помощью декларативного синтаксиса и позволяет отсеивать данные, представленные в управлении DropDownList.

1. В представлении design удалите элемент управления GridView из default.aspx. 

    **Важно**: Оставьте элемент управления SqlDataSource на странице.
2. Добавьте элемент управления DropDownList в Default.aspx.
3. Переключитесь на представление Исходного кода.
4. Добавьте атрибут DataSourceId, DataTextField и DataValueField в элемент управления &lt;asp:DropDownList&gt; следующим образом: 

    [!code-aspx[Main](data-source-controls/samples/sample8.aspx)]
5. Сохранить Default.aspx и просмотреть его в браузере. Обратите внимание, что DropDownList содержит все продукты из базы данных Northwind.
6. Закройте браузер.
7. В исходном представлении Default.aspx добавьте новый элемент управления TextBox под управлением DropDownList. Измените свойство идентификатора TextBox на txtProductName.
8. Под управлением TextBox добавьте новый элемент управления кнопкой. Измените свойство ID кнопки на btnUpdate и свойство текста для **обновления названия продукта.**
9. В исходном представлении Default.aspx добавьте свойство UpdateCommand и два новых Параметра обновления в тег SqlDataSource следующим образом: 

    [!code-aspx[Main](data-source-controls/samples/sample9.aspx)]

    > [!NOTE]
    > Обратите внимание, что в этом коде добавлены два параметра обновления (ProductName и ProductID). Эти параметры отображаются в текстовом свойстве txtProductName TextBox и свойстве SelectedValue ddlProducts DropDownList.
10. Переключитесь на представление Design и дважды нажмите на элемент управления кнопкой, чтобы добавить обработчик событий.
11. Добавьте следующий код в\_код btnUpdate Click: 

    [!code-csharp[Main](data-source-controls/samples/sample10.cs)]
12. Нажмите на кнопку Default.aspx и выберите его в браузере. Нажмите "Да", когда побудили сохранить все изменения.
13. ASP.NET 2.0 частичные классы позволяют компиляцию во время выполнения. Нет необходимости создавать приложение, чтобы изменения кода вступили в силу.
14. Выберите продукт из DropDownList.
15. Введите новое имя выбранного продукта в TextBox, а затем нажмите кнопку «Обновление».
16. Имя продукта обновляется в базе данных.

## <a name="exercise-3-using-the-objectdatasource-control"></a>Упражнение 3 С помощью управления ObjectDataSource

Это упражнение продемонстрирует, как использовать элемент управления ObjectDataSource и исходный объект для взаимодействия с базой данных Northwind.

1. Нажмите на проект в Solution Explorer и нажмите на Добавить новый элемент.
2. Выберите веб-форму в списке шаблонов. Измените имя на object.aspx и нажмите Добавить.
3. Нажмите на проект в Solution Explorer и нажмите на Добавить новый элемент.
4. Выберите класс в списке шаблонов. Измените название класса на NorthwindData.cs и нажмите Добавить.
5. Нажмите "Да", когда предлагается добавить класс в папку App\_Code.
6. Добавьте следующий код в файл NorthwindData.cs: 

    [!code-csharp[Main](data-source-controls/samples/sample11.cs)]
7. Добавьте следующий код в представление «Источник» object.aspx: 

    [!code-aspx[Main](data-source-controls/samples/sample12.aspx)]
8. Сохранить все файлы и просматривать object.aspx.
9. Взаимодействуйте с интерфейсом, просматривая детали, редактируя сотрудников, добавляя сотрудников и удаляя сотрудников.
