---
uid: web-forms/overview/moving-to-aspnet-20/configuration-and-instrumentation
title: Настройка и инструментирование | Документация Майкрософт
author: microsoft
description: Существуют значительные изменения в конфигурации и инструментировании в ASP.NET 2,0. Новый API настройки ASP.NET позволяет вносить изменения в конфигурацию...
ms.author: riande
ms.date: 02/20/2005
ms.assetid: 21ebbaee-7ed8-45ae-b6c1-c27c88342e48
msc.legacyurl: /web-forms/overview/moving-to-aspnet-20/configuration-and-instrumentation
msc.type: authoredcontent
ms.openlocfilehash: cd5bedce5459e8cf8e72df8de69ebd82f2d97789
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78507882"
---
# <a name="configuration-and-instrumentation"></a>Конфигурация и инструментирование

по [Майкрософт](https://github.com/microsoft)

> Существуют значительные изменения в конфигурации и инструментировании в ASP.NET 2,0. Новый API настройки ASP.NET позволяет программно вносить изменения в конфигурацию. Кроме того, существует множество новых параметров конфигурации, позволяющих использовать новые конфигурации и инструментирование.

Существуют значительные изменения в конфигурации и инструментировании в ASP.NET 2,0. Новый API настройки ASP.NET позволяет программно вносить изменения в конфигурацию. Кроме того, существует множество новых параметров конфигурации, позволяющих использовать новые конфигурации и инструментирование.

В этом модуле мы обсудим ASP.NET API настройки, так как он связан с чтением и записью в файлы конфигурации ASP.NET, а также охватывает инструментирование ASP.NET. Мы также рассмотрим новые функции, доступные в ASP.NETной трассировке.

## <a name="aspnet-configuration-api"></a>API настройки ASP.NET

API настройки ASP.NET позволяет разрабатывать, развертывать и администрировать данные конфигурации приложения с помощью единого интерфейса программирования. API настройки можно использовать для разработки и изменения полных конфигураций ASP.NET программным способом без непосредственного редактирования XML-кода в файлах конфигурации. Кроме того, можно использовать API настройки в разрабатываемых консольных приложениях и скриптах, в веб-средствах управления и в оснастках консоли управления (MMC).

Следующие два средства управления конфигурацией используют API настройки и включены в .NET Framework версии 2,0:

- Оснастка ASP.NET консоли управления (MMC), которая использует API конфигурации для упрощения административных задач, предоставляя интегрированное представление данных локальной конфигурации на всех уровнях иерархии конфигурации.
- Средство администрирования веб-сайтов, которое позволяет управлять параметрами конфигурации для локальных и удаленных приложений, включая размещенные.

API настройки ASP.NET состоит из набора объектов управления ASP.NET, которые можно использовать для программной настройки веб-сайтов и приложений. Управляющие объекты реализуются как библиотека классов .NET Framework. Модель программирования API конфигурации помогает обеспечить согласованность и надежность кода путем применения типов данных во время компиляции. Чтобы упростить управление конфигурациями приложений, API конфигурации позволяет просматривать данные, Объединенные из всех точек в иерархии конфигурации, в виде одной коллекции, а не просматривать данные в виде отдельных коллекций из разных файлы конфигурации. Кроме того, API конфигурации позволяет управлять всей конфигурацией приложений без непосредственного редактирования XML-кода в файлах конфигурации. Наконец, API упрощает задачи настройки, поддерживая средства администрирования, такие как средство администрирования веб-сайта. API конфигурации упрощает развертывание, поддерживая создание файлов конфигурации на компьютере и выполнение сценариев конфигурации на нескольких компьютерах.

> [!NOTE]
> API конфигурации не поддерживает создание приложений IIS.

## <a name="working-with-local-and-remote-configuration-settings"></a>Работа с локальными и удаленными параметрами конфигурации

Объект конфигурации представляет объединенное представление параметров конфигурации, которые применяются к определенной физической сущности, такой как компьютер, или к логической сущности, например к приложению или веб-сайту. Указанная логическая сущность может существовать на локальном компьютере или на удаленном сервере. Если для указанной сущности не существует файла конфигурации, объект конфигурации представляет параметры конфигурации по умолчанию, определенные в файле Machine. config.

Объект конфигурации можно получить с помощью одного из открытых методов настройки из следующих классов:

1. Класс ConfigurationManager, если сущность является клиентским приложением.
2. Класс WebConfigurationManager, если сущность является веб-приложением.

Эти методы возвращают объект конфигурации, который, в свою очередь, предоставляет необходимые методы и свойства для управления базовыми файлами конфигурации. Вы можете получить доступ к этим файлам для чтения или записи.

### <a name="reading"></a>Чтение

Для чтения сведений о конфигурации используется метод Жетсектионграуп или. Пользователь или процесс, выполняющий чтение, должен иметь разрешения на чтение всех файлов конфигурации в иерархии.

> [!NOTE]
> Если используется статический метод части, принимающий параметр path, параметр path должен ссылаться на приложение, в котором выполняется код. В противном случае параметр игнорируется, и возвращаются сведения о конфигурации для текущего приложения.

### <a name="writing"></a>Запись

Для записи сведений о конфигурации используется один из методов Save. Пользователь или процесс, выполняющий запись, должен иметь разрешения на запись в файл конфигурации и каталог на текущем уровне иерархии конфигурации, а также разрешения на чтение всех файлов конфигурации в иерархии.

Чтобы создать файл конфигурации, представляющий унаследованные параметры конфигурации для указанной сущности, используйте один из следующих методов сохранения конфигурации:

1. Метод Save для создания нового файла конфигурации.
2. Метод SaveAs для создания нового файла конфигурации в другом расположении.

## <a name="configuration-classes-and-namespaces"></a>Классы и пространства имен конфигурации

Многие классы и методы конфигурации похожи друг на друга. В следующей таблице описаны наиболее часто используемые классы и пространства имен конфигурации.

| **Класс конфигурации или пространство имен** | **Описание** |
| --- | --- |
| Пространство имен [System. Configuration](https://msdn.microsoft.com/library/system.configuration.aspx) | Содержит основные классы конфигурации для всех .NET Framework приложений. Классы обработчиков разделов используются для получения данных конфигурации для раздела из методов, таких как Жетсектионграуп и. Эти два метода не являются статическими. |
| Класс System. Configuration. Configuration | Представляет набор данных конфигурации для компьютера, приложения, веб-каталога или другого ресурса. Этот класс содержит полезные методы, такие как "Жетсектионграуп" и "," для обновления параметров конфигурации и получения ссылок на разделы и группы разделов. Этот класс используется в качестве типа возвращаемого значения для методов, которые получают данные конфигурации времени разработки, например методы классов WebConfigurationManager и ConfigurationManager. |
| Пространство имен System. Web. Configuration | Содержит классы обработчиков разделов для разделов конфигурации ASP.NET, определенных в [параметрах конфигурации ASP.NET](https://msdn.microsoft.com/library/b5ysx397.aspx). Классы обработчиков разделов используются для получения данных конфигурации для раздела из методов, таких как Жетсектионграуп и. |
| Класс System. Web. Configuration. WebConfigurationManager | Предоставляет полезные методы для получения ссылок на параметры конфигурации времени выполнения и времени разработки. Эти методы используют класс System. Configuration. Configuration как тип возвращаемого значения. Можно использовать статический метод «часть» этого класса или нестатический метод части класса System. Configuration. ConfigurationManager. Для конфигураций веб-приложений рекомендуется использовать класс System. Web. Configuration. WebConfigurationManager вместо класса System. Configuration. ConfigurationManager. |
| Пространство имен [System. Configuration. Provider](https://msdn.microsoft.com/library/system.configuration.provider.aspx) | Предоставляет способ настройки и расширения поставщика конфигурации. Это базовый класс для всех классов поставщиков в системе конфигурации. |
| Пространство имен [System. Web. Management](https://msdn.microsoft.com/library/system.web.management.aspx) | Содержит классы и интерфейсы для управления и мониторинга работоспособности веб-приложений. Строго говоря, это пространство имен не считается частью API конфигурации. Например, события трассировки и обработки событий выполняются классами в этом пространстве имен. |
| Пространство имен [System. Management. Instrumentation](https://msdn.microsoft.com/library/system.management.instrumentation.aspx) | Предоставляет классы, необходимые для инструментирования приложений с целью предоставления сведений об управлении и событий с помощью инструментарий управления Windows (WMI) (WMI) потенциальным потребителям. Мониторинг работоспособности ASP.NET использует инструментарий WMI для доставки событий. Строго говоря, это пространство имен не считается частью API конфигурации. |

## <a name="reading-from-aspnet-configuration-files"></a>Чтение из файлов конфигурации ASP.NET

Класс WebConfigurationManager является основным классом для чтения из файлов конфигурации ASP.NET. Для чтения файлов конфигурации ASP.NET есть три шага:

1. Получите объект конфигурации с помощью метода Опенвебконфигуратион.
2. Получите ссылку на нужный раздел в файле конфигурации.
3. Прочитайте нужную информацию из файла конфигурации.

Объект конфигурации представляет не конкретный файл конфигурации. Вместо этого он представляет объединенное представление конфигурации компьютера, приложения или веб-сайта. В следующем примере кода создается объект конфигурации, представляющий конфигурацию веб-приложения с именем *ProductInfo*.

[!code-csharp[Main](configuration-and-instrumentation/samples/sample1.cs)]

> [!NOTE]
> Обратите внимание, что если путь/Продуктинфо не существует, приведенный выше код вернет конфигурацию по умолчанию, как указано в файле Machine. config.

После создания объекта конфигурации можно использовать метод GetObject или Жетсектионграуп для детализации параметров конфигурации. В следующем примере возвращается ссылка на параметры олицетворения для указанного выше приложения ProductInfo:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample2.cs)]

## <a name="writing-to-aspnet-configuration-files"></a>Запись в файлы конфигурации ASP.NET

Как и при чтении файлов конфигурации, класс WebConfigurationManager является ядром для записи в файлы конфигурации Asp.NET. Существует также три шага для записи в файлы конфигурации ASP.NET.

1. Получите объект конфигурации с помощью метода Опенвебконфигуратион.
2. Получите ссылку на нужный раздел в файле конфигурации.
3. Запишите нужную информацию из файла конфигурации с помощью метода Save или SaveAs.

Следующий код изменяет атрибут **Debug** элемента&gt; компиляции &lt;в значение false:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample3.cs)]

При выполнении этого кода атрибуту **Debug** элемента&gt; компиляции &lt;будет присвоено значение false для файла Web. config приложения *webApp* .

## <a name="systemwebmanagement-namespace"></a>Пространство имен System. Web. Management

Пространство имен System. Web. Management предоставляет классы и интерфейсы для управления работоспособностью приложений ASP.NET и наблюдения за ними.

Ведение журнала выполняется путем определения правила, которое связывает события с поставщиком. Правило определяет тип событий, отправляемых поставщику. Для ведения журнала доступны следующие базовые события:

| **WebBaseEvent** | Базовый класс событий для всех событий. Содержит обязательные свойства для всех событий, таких как код события, подробный код события, Дата и время возникновения события, порядковый номер, сообщение о событии и сведения о событии. |
| --- | --- |
| **вебманажементевент** | Базовый класс событий для событий управления, таких как время существования приложения, запросы, ошибки и события аудита. |
| **вебхеартбеатевент** | Событие, создаваемое приложением через регулярные интервалы времени для сбора полезных сведений о состоянии среды выполнения. |
| **вебаудитевент** | Базовый класс для событий аудита безопасности, которые используются для обозначения таких условий, как сбой авторизации, сбой расшифровки и *т. д.* |
| **вебрекуестевент** | Базовый класс для всех событий информационных запросов. |
| **веббасирроревент** | Базовый класс для всех событий, указывающих на состояние ошибки. |

Доступные типы поставщиков позволяют отправлять выходные данные событий в Просмотр событий, SQL Server, инструментарий управления Windows (WMI) (WMI) и электронной почте. Предварительно настроенные поставщики и сопоставления событий уменьшают объем работы, необходимый для получения журнала событий.

ASP.NET 2,0 использует встроенную службу регистратора событий для регистрации событий на основе запуска и остановки доменов приложений, а также для регистрации любых необработанных исключений. Это поможет охватить некоторые основные сценарии. Например, предположим, что приложение создает исключение, но пользователь не сохраняет ошибку, и вы не можете воспроизвести ее. С помощью правила журнала событий по умолчанию вы сможете собирать сведения об исключениях и стеке, чтобы лучше понять, какой тип ошибок произошла. Другой пример применяется, если приложение теряет состояние сеанса. В этом случае можно просмотреть журнал событий, чтобы определить, перезапускается ли домен приложения, и почему домен приложения остановлен на первом месте.

Кроме того, система мониторинга работоспособности является расширяемой. Например, можно определить пользовательские веб-события, запустить их в приложении, а затем определить правило для отправки сведений о событии поставщику, например электронной почте. Это позволяет легко связать инструментирование с поставщиками мониторинга работоспособности. В качестве другого примера можно запустить событие каждый раз при обработке заказа и настроить правило, которое отправляет каждое событие в SQL Server базу данных. Можно также запустить событие, когда пользователю не удастся войти в строку несколько раз и настроить событие для использования поставщиков на основе электронной почты.

Конфигурация поставщиков и событий по умолчанию хранится в глобальном файле Web. config. В глобальном файле Web. config хранятся все веб-параметры, которые хранились в файле Machine. config в ASP.NET 1x. Глобальный файл Web. config находится в следующем каталоге:

`%windir%\Microsoft.Net\Framework\v2.0.*\config\Web.config`

Раздел &lt;healthMonitoring&gt; в глобальном файле Web. config предоставляет параметры конфигурации по умолчанию. Можно переопределить эти настройки или настроить собственные параметры, реализовав&gt; раздел &lt;healthMonitoring в файле Web. config для приложения.

Раздел &lt;healthMonitoring&gt; в глобальном файле Web. config содержит следующие элементы:

| **providers** | Содержит поставщики, настроенные для Просмотр событий, WMI и SQL Server. |
| --- | --- |
| **eventMappings** | Содержит сопоставления для различных классов класса Base. Этот список можно расширить при создании собственного класса событий. Создание собственного класса событий обеспечивает более детализированную детализацию для поставщиков, которым вы отправляете информацию. Например, можно настроить отправку необработанных исключений в SQL Server при отправке пользовательских событий в электронную почту. |
| **правил** | Связывает параметр eventMappings с поставщиком. |
| **буферизации** | Используется с поставщиками услуг SQL Server и электронной почты для определения частоты записи событий в поставщик. |

Ниже приведен пример кода из глобального файла Web. config.

[!code-xml[Main](configuration-and-instrumentation/samples/sample4.xml)]

## <a name="how-to-store-events-to-event-viewer"></a>Как сохранять события для Просмотр событий

Как упоминалось ранее, поставщик регистрации событий в Просмотр событий настраивается в глобальном файле Web. config. По умолчанию регистрируются все события, основанные на **веббасирроревент** и **вебфаилуреаудитевент** . Можно добавить дополнительные правила для записи дополнительных сведений в журнал событий. Например, если вы хотите регистрировать все события (*т. е.* каждое событие, основанное на **WebBaseEvent**), можно добавить следующее правило в файл Web. config:

[!code-xml[Main](configuration-and-instrumentation/samples/sample5.xml)]

Это правило связывает сопоставлению событий **все события** с поставщиком журнала событий. Как таблица eventmapping, так и поставщик включены в глобальный файл Web. config.

## <a name="how-to-store-events-to-sql-server"></a>Как сохранять события для SQL Server

Этот метод использует базу данных **aspnetdb** , созданную средством ASPNET\_регскл. exe. Поставщик по умолчанию использует строку подключения LocalSqlServer, которая использует файловую базу данных в папке приложения\_данных или локальный экземпляр SQLExpress SQL Server. Строка подключения LocalSqlServer и дескриптора SqlProvider настраиваются в глобальном файле Web. config.

Строка подключения LocalSqlServer в глобальном файле Web. config выглядит следующим образом:

[!code-xml[Main](configuration-and-instrumentation/samples/sample6.xml)]

Если вы хотите использовать другой экземпляр SQL Server, необходимо использовать средство ASPNET\_регскл. exe, которое можно найти в%windir%\Microsoft.Net\Framework\v2.0. Папка\*. Используйте средство ASPNET\_регскл. exe для создания пользовательской базы данных **aspnetdb** на экземпляре SQL Server, затем добавьте строку подключения в файл конфигурации приложений, а затем добавьте поставщик с помощью новой строки подключения. После создания базы данных **aspnetdb** необходимо задать правило, связывающее таблица eventmapping с дескриптора SqlProvider.

Независимо от того, используется ли дескриптора SqlProvider по умолчанию или настроен собственный поставщик, необходимо добавить правило, связывающее поставщик с картой событий. Следующее правило связывает нового поставщика, созданного выше, с картой событий **все события** . Это правило регистрирует все события на основе **WebBaseEvent** и отправляет их в мисклвебевентпровидер, который будет использовать строку подключения мяспнетдб. Следующий код добавляет правило для связывания поставщика с картой событий:

[!code-xml[Main](configuration-and-instrumentation/samples/sample7.xml)]

Если вы хотите отправить только ошибки в SQL Server, можно добавить следующее правило:

[!code-xml[Main](configuration-and-instrumentation/samples/sample8.xml)]

## <a name="how-to-forward-events-to-wmi"></a>Пересылка событий в WMI

Можно также перенаправить события в WMI. Поставщик WMI настраивается для вас в глобальном файле Web. config по умолчанию.

В следующем примере кода добавляется правило для пересылки событий в WMI:

[!code-xml[Main](configuration-and-instrumentation/samples/sample9.xml)]

Необходимо добавить правило для связывания таблица eventmapping с поставщиком, а также приложение прослушивателя WMI для прослушивания событий. В следующем примере кода добавляется правило для связывания поставщика WMI со схемой событий **все события** :

[!code-xml[Main](configuration-and-instrumentation/samples/sample10.xml)]

## <a name="how-to-forward-events-to-email"></a>Пересылка событий по электронной почте

Можно также пересылать события по электронной почте. Будьте внимательны с тем, какие правила событий сопоставлены с поставщиком электронной почты, так как вы можете случайно отправить себе много информации, которая лучше подходит для SQL Server или журнала событий. Существует два поставщика электронной почты. Симплемаилвебевентпровидер и Темплатедмаилвебевентпровидер. Каждый из них имеет одинаковые атрибуты конфигурации, за исключением атрибутов "Template" и "Детаиледтемплатиррорс", оба из которых доступны только в Темплатедмаилвебевентпровидер.

> [!NOTE]
> Ни один из этих поставщиков электронной почты не настроен. Их необходимо добавить в файл Web. config.

Основное различие между этими двумя поставщиками электронной почты заключается в том, что Симплемаилвебевентпровидер отправляет сообщения электронной почты в универсальном шаблоне, который не может быть изменен. Пример файла Web. config добавляет этот поставщик электронной почты в список настроенных поставщиков с помощью следующего правила:

[!code-xml[Main](configuration-and-instrumentation/samples/sample11.xml)]

Для привязки поставщика электронной почты к сопоставлению событий **все события** также добавляется следующее правило:

[!code-xml[Main](configuration-and-instrumentation/samples/sample12.xml)]

## <a name="aspnet-20-tracing"></a>Трассировка ASP.NET 2,0

Существует три основных улучшения трассировки в ASP.NET 2,0.

1. Встроенные функции трассировки
2. Программный доступ к сообщениям трассировки
3. Улучшенная трассировка на уровне приложения

## <a name="integrated-tracing-functionality"></a>Встроенные функции трассировки

Теперь можно маршрутизировать сообщения, созданные классом System. Diagnostics. Trace, для ASP.NET выходных данных трассировки и направить сообщения, созданные трассировкой ASP.NET, в System. Diagnostics. Trace. Вы также можете перенаправить события инструментирования ASP.NET в System. Diagnostics. Trace. Эта функция предоставляется новым атрибутом **вритетодиагностикстраце** элемента&gt; трассировки &lt;. Если это логическое значение равно true, сообщения трассировки ASP.NET перенаправляются в систему. инфраструктура трассировки диагностики для использования любыми прослушивателями, зарегистрированными для вывода сообщений трассировки.

## <a name="programmatic-access-to-trace-messages"></a>Программный доступ к сообщениям трассировки

ASP.NET 2,0 обеспечивает программный доступ ко всем сообщениям трассировки с помощью класса **трацеконтекстрекорд** и коллекции **трацерекордс** . Наиболее эффективный способ доступа к сообщениям трассировки заключается в регистрации делегата **трацеконтекстевенсандлер** (также нового в ASP.NET 2,0) для управления новым событием **трацефинишед** . Затем можно прокручивать сообщения трассировки по своему усмотрению.

Это показано в следующем образце кода:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample13.cs)]

В приведенном выше примере я прокручивать коллекцию Трацерекордс, а затем запишу каждое сообщение в поток ответа.

## <a name="improved-application-level-tracing"></a>Улучшенная трассировка на уровне приложения

Трассировка на уровне приложения улучшена с помощью введения нового атрибута **мострецент** элемента&gt; трассировки &lt;. Этот атрибут указывает, будут ли отображаться последние выходные данные трассировки на уровне приложения, а более старые данных трассировки, превышающие ограничения, указанные Рекуестлимит, отбрасываются. Если значение равно false, данные трассировки отображаются для запросов до тех пор, пока не будет достигнут атрибут Рекуестлимит.

## <a name="aspnet-command-line-tools"></a>Средства командной строки ASP.NET

Существует несколько средств командной строки, помогающих в настройке ASP.NET. Разработчики ASP.NET должны быть знакомы с инструментом ASPNET\_regiis. exe. ASP.NET 2,0 предоставляет три других средства командной строки для помощи в настройке.

Доступны следующие программы командной строки:

| **Инструмент** | **Использование** |
| --- | --- |
| **ASPNET\_regiis. exe** | Позволяет регистрировать ASP.NET с IIS. Существует две версии этих средств, поставляемые с ASP.NET 2,0, один для 32-разрядных систем (в папке Framework) и один для 64-разрядных систем (в папке Framework64). 64-разрядная версия не будет установлена в 32-разрядной ОС. |
| **ASPNET\_регскл. exe** | Средство ASP.NET SQL Server Registration Tool используется для создания Microsoft SQL Server базы данных для использования поставщиками SQL Server в ASP.NET или для добавления или удаления параметров из существующей базы данных. Файл ASPNET\_регскл. exe находится в папке [диск:] \Виндовс\микрософт.нет\фрамеворк\версионнумбер на веб-сервере. |
| **ASPNET\_регбровсерс. exe** | Средство регистрации браузера ASP.NET анализирует и компилирует все системные определения браузера в сборку и устанавливает сборку в глобальный кэш сборок. Средство использует файлы определения браузера (. Файлы браузера) из подкаталога .NET Framework Browsers. Это средство можно найти в каталоге%Системрут%\микрософт.нет\фрамеворк\версион\. |
| **ASPNET\_Compiler. exe** | Средство компиляции ASP.NET позволяет компилировать веб-приложение ASP.NET либо на месте, либо для развертывания в целевом расположении, например на рабочем сервере. Компиляция на месте обеспечивает производительность приложения, так как конечные пользователи не сталкиваются с задержкой при первом запросе приложения во время компиляции приложения. |

Поскольку средство ASPNET\_regiis. exe не является новым в ASP.NET 2,0, мы не будем его обсуждать.

## <a name="aspnet-sql-server-registration-tool---aspnet_regsqlexe"></a>Средство регистрации SQL Server ASP.NET — ASPNET\_регскл. exe

Можно задать несколько типов параметров с помощью средства регистрации ASP.NET SQL Server. Можно указать подключение SQL, указать, какие службы приложений ASP.NET используют SQL Server для управления данными, указать, какая база данных или какая таблица используется для зависимости кэша SQL, а также добавить или удалить поддержку использования SQL Server для хранения процедур и состояния сеанса.

Некоторые службы приложений ASP.NET используют поставщик для управления хранением и извлечением данных из источника данных. Каждый поставщик зависит от источника данных. ASP.NET включает поставщик SQL Server для следующих функций ASP.NET:

- Членство (класс [SqlMembershipProvider](https://msdn.microsoft.com/library/system.web.security.sqlmembershipprovider.aspx) ).
- Управление ролями (класс [склролепровидер](https://msdn.microsoft.com/library/system.web.security.sqlroleprovider.aspx) ).
- Profile (класс [склпрофилепровидер](https://msdn.microsoft.com/library/system.web.profile.sqlprofileprovider.aspx) ).
- Персонализация веб-части (класс [склперсонализатионпровидер](https://msdn.microsoft.com/library/system.web.ui.webcontrols.webparts.sqlpersonalizationprovider.aspx) ).
- Веб-события (класс [SqlWebEventProvider](https://msdn.microsoft.com/library/system.web.management.sqlwebeventprovider.aspx) ).

При установке ASP.NET файл Machine. config для сервера включает элементы конфигурации, указывающие поставщики SQL Server для каждой из функций ASP.NET, зависящих от поставщика. По умолчанию эти поставщики настроены для подключения к локальному пользовательскому экземпляру SQL Server Express 2005. При изменении строки подключения, используемой поставщиками по умолчанию, перед использованием функций ASP.NET, настроенных в конфигурации компьютера, необходимо установить базу данных SQL Server и элементы базы данных для выбранного компонента с помощью ASPNET\_регскл. exe. Если база данных, указанная с помощью средства регистрации SQL, еще не существует (значение aspnetdb будет базой данных по умолчанию, если оно не указано в командной строке), то текущий пользователь должен иметь права на создание баз данных в SQL Server, а также на создание схемы e лементс в базе данных.

### <a name="sql-cache-dependency"></a>Зависимость кэша SQL

Расширенная возможность кэширования выходных данных ASP.NET — зависимость кэша SQL. Зависимость кэша SQL поддерживает два разных режима работы: одна использует ASP.NET реализацию опроса таблиц и второй режим, использующий функции уведомления о запросах SQL Server 2005. Средство регистрации SQL можно использовать для настройки режима опроса таблиц.

### <a name="session-state"></a>Состояние сеанса

По умолчанию значения и сведения о состоянии сеанса хранятся в памяти в процессе ASP.NET. Кроме того, данные сеанса можно хранить в базе данных SQL Server, где они могут совместно использоваться несколькими веб-серверами. Если база данных, указанная для состояния сеанса с помощью средства регистрации SQL, еще не существует, то текущий пользователь должен иметь права на создание баз данных в SQL Server, а также на создание элементов схемы в базе данных. Если база данных существует, то текущий пользователь должен иметь права на создание элементов схемы в существующей базе данных.

Чтобы установить базу данных состояния сеанса на SQL Server, запустите средство ASPNET\_регскл. exe и укажите следующие сведения с помощью команды:

- Имя экземпляра SQL Server с помощью параметра **-S** .
- Учетные данные для входа в учетную запись, имеющую разрешение на создание базы данных на компьютере с SQL Server. Используйте параметр **-E** , чтобы использовать пользователя, выполнившего вход в систему, или используйте параметр **-U** , чтобы указать идентификатор пользователя вместе с параметром **-P** , чтобы указать пароль.
- Параметр командной строки **-ссадд** для добавления базы данных состояния сеанса.

По умолчанию нельзя использовать средство ASPNET\_регскл. exe для установки базы данных состояния сеанса на компьютере, на котором выполняется SQL Server 2005, экспресс-выпуск.

### <a name="the-aspnet-browser-registration-tool---aspnet_regbrowsersexe"></a>Средство регистрации браузера ASP.NET — ASPNET\_регбровсерс. exe

В ASP.NET версии 1,1 файл Machine. config содержал раздел с именем &lt;browserCaps&gt;. В этом разделе содержится ряд XML-записей, в которых определены конфигурации для различных браузеров на основе регулярного выражения. Для ASP.NET версии 2,0 — новый. Файл браузера определяет параметры конкретного браузера с помощью записей XML. Чтобы добавить сведения в новый браузер, добавьте новый объект. Файл браузера в папку, расположенную по адресу%Системрут%\микрософт.нет\фрамеворк\версион\конфиг\бровсерс в системе.

Так как приложение не считывает файл конфигурации каждый раз, когда ему требуются сведения об обозревателе, можно создать новый. Файл браузера и запустите ASPNET\_регбровсерс. exe, чтобы добавить необходимые изменения в сборку. Это позволяет серверу немедленно получить доступ к новым данным браузера, чтобы не закрывать все приложения для получения информации. Приложение может обращаться к возможностям браузера через свойство Browser текущего HttpRequest.

При запуске ASPNET\_регбровсер. exe доступны следующие параметры:

| **Параметр** | **Описание** |
| --- | --- |
| **-?** | Отображает текст справки ASPNET\_регббровсерс. exe в окне команд. |
| **-i** | Создает сборку возможностей обозревателя времени выполнения и устанавливает ее в глобальный кэш сборок. |
| **-u** | Удаляет сборку возможностей обозревателя времени выполнения из глобального кэша сборок. |

## <a name="the-aspnet-compilation-tool---aspnet_compilerexe"></a>Средство компиляции ASP.NET — ASPNET\_Compiler. exe

Средство компиляции ASP.NET можно использовать двумя общими способами: для компиляции на месте и компиляции для развертывания, где указан целевой выходной каталог.

### <a name="compiling-an-application-in-place"></a>[Компиляция приложения на месте](https://msdn.microsoft.com/library/ms229863.aspx)

Средство компиляции ASP.NET может компилировать приложение на месте, то есть имитирует поведение при выполнении нескольких запросов к приложению, что вызывает регулярную компиляцию. Пользователи предварительно скомпилированного сайта не будут испытывать задержки, вызванные компиляцией страницы при первом запросе.

При предварительной компиляции сайта на месте применяются следующие элементы.

- На сайте сохранены файлы и структура каталогов.
- Для всех языков программирования, используемых сайтом на сервере, необходимы компиляторы.
- Если какой-либо из файлов не проходит компиляцию, весь сайт завершается с ошибкой компиляции.

Можно также перекомпилировать приложение на месте после добавления в него новых исходных файлов. Средство компилирует только новые или измененные файлы, если не включен параметр **-c** .

> [!NOTE]
> Компиляция приложения, содержащего вложенное приложение, не приводит к компиляции вложенного приложения. Вложенное приложение должно быть скомпилировано отдельно.

### <a name="compiling-an-application-for-deployment"></a>[Компиляция приложения для развертывания](https://msdn.microsoft.com/library/ms229863.aspx)

Компиляция приложения для развертывания (компиляции в целевое расположение) осуществляется путем указания параметра targetDir. TargetDir может быть конечным расположением для веб-приложения, иначе скомпилированное приложение можно будет развернуть. При использовании параметра **-u** приложение компилируется таким образом, что можно вносить изменения в определенные файлы в скомпилированном приложении без его перекомпиляции. ASPNET\_компилятор. exe делает различие между статическими и динамическими типами файлов и обрабатывает их по-разному при создании итогового приложения.

- Статические типы файлов — это те, которые не имеют связанного компилятора или поставщика сборки, например файлы с именами, имеющие расширения, такие как. CSS,. gif,. htm,. HTML,. jpg,. js и т. д. Эти файлы просто копируются в целевое расположение с сохранением их относительного расположения в структуре каталогов.
- Динамические типы файлов — это те, которые имеют связанный компилятор или поставщик сборки, включая файлы с расширениями имен файлов ASP.NET, такие как asax, ASCX, ASHX, ASPX, Browser, Master и т. д. Средство компиляции ASP.NET создает сборки из этих файлов. Если параметр **-u** не указан, средство также создает файлы с расширением имени файла. Компиляция, которая сопоставляет исходные файлы с исходными файлами с их сборкой. Чтобы обеспечить сохранение структуры каталогов источника приложения, средство создает файлы заполнителей в соответствующих расположениях в целевом приложении.

Необходимо использовать параметр **-u** , чтобы указать, что содержимое скомпилированного приложения можно изменить. В противном случае последующие изменения игнорируются или вызывают ошибки времени выполнения.

В следующей таблице описано, как средство компиляции ASP.NET обрабатывает различные типы файлов при включении параметра **-u** .

| **Тип файла** | **Действие компилятора** |
| --- | --- |
| .ascx, .aspx, .master | Эти файлы разбиваются на разметку и исходный код, который включает как файлы кода программной части, так и любой код, заключенный в &lt;Script runat = "Server"&gt; элементов. Исходный код компилируется в сборки, имена которых являются производными от алгоритма хэширования, а сборки помещаются в каталог bin. Любой встроенный код, т. е. код, заключенный между **%ом&lt;** и **%&gt;** квадратных скобках, включен в разметку и не компилируется. Создаются новые файлы с тем же именем, что и у исходных файлов, которые будут содержать разметку и помещены в соответствующие выходные каталоги. |
| . ashx,. asmx | Эти файлы не компилируются и перемещаются в выходные каталоги, как есть и не компилируются. Если вы хотите скомпилировать код обработчика, поместите код в файлы исходного кода в каталоге приложения\_Code. |
| . cs,. vb,. ЖСЛ,. cpp (не включает файлы кода программной части для перечисленных выше типов файлов) | Эти файлы компилируются и включаются в виде ресурса в сборки, ссылающиеся на них. Исходные файлы не копируются в выходной каталог. Если на файл кода нет ссылки, он не компилируется. |
| Пользовательские типы файлов | Эти файлы не компилируются. Эти файлы копируются в соответствующие выходные каталоги. |
| Файлы исходного кода в приложении\_подкаталоге кода | Эти файлы компилируются в сборки и помещаются в каталог bin. |
| файлы. resx и. Resource в приложении\_подкаталоге Глобалресаурцес | Эти файлы компилируются в сборки и помещаются в каталог bin. Подкаталог App\_Глобалресаурцес не создается в основном выходном каталоге, а файлы. resx и. Resources, расположенные в исходном каталоге, не копируются в выходные каталоги. |
| файлы. resx и. Resource в приложении\_подкаталоге LocalResources | Эти файлы не компилируются и копируются в соответствующие выходные каталоги. |
| файлы Skin в подкаталоге приложения\_Themes | Файлы. Skin и статические файлы темы не компилируются и копируются в соответствующие выходные каталоги. |
| . browser — типы статических файлов сборки, уже имеющиеся в каталоге bin | Эти файлы копируются как есть в выходные каталоги. |

В следующей таблице описано, как средство компиляции ASP.NET обрабатывает различные типы файлов, если параметр **-u** не указан.

| **Тип файла** | **Действие компилятора** |
| --- | --- |
| .aspx, .asmx, .ashx, .master | Эти файлы разбиваются на разметку и исходный код, который включает как файлы кода программной части, так и любой код, заключенный в &lt;Script runat = "Server"&gt; элементов. Исходный код компилируется в сборки, имена которых являются производными от алгоритма хэширования. Итоговые сборки помещаются в каталог bin. Любой встроенный код, т. е. код, заключенный между **%ом&lt;** и **%&gt;** квадратных скобках, включен в разметку и не компилируется. Компилятор создает новые файлы для размещения разметки с тем же именем, что и у исходных файлов. Полученные файлы помещаются в каталог bin. Компилятор также создает файлы с тем же именем, что и исходные файлы, но с расширением. Компиляция, содержащая сведения о сопоставлении. Тот. СКОМПИЛИРОВАНные файлы помещаются в выходные каталоги, соответствующие исходному расположению исходных файлов. |
| .ascx | Эти файлы разбиваются на разметку и исходный код. Исходный код компилируется в сборки и помещается в каталог bin с именами, которые являются производными от алгоритма хэширования. Файлы разметки не создаются. |
| . cs,. vb,. ЖСЛ,. cpp (не включает файлы кода программной части для перечисленных выше типов файлов) | Исходный код, на который ссылаются сборки, созданные из файлов. ascx,. ashx или. aspx, компилируется в сборки и помещается в каталог bin. Исходные файлы не копируются. |
| Пользовательские типы файлов | Эти файлы компилируются как динамические файлы. В зависимости от типа файла, на котором они основаны, компилятор может разместить файлы сопоставления в выходных каталогах. |
| Файлы в приложении\_подкаталоге кода | Файлы исходного кода в этом подкаталоге компилируются в сборки и помещаются в каталог bin. |
| Файлы в подкаталоге Глобалресаурцес приложения\_ | Эти файлы компилируются в сборки и помещаются в каталог bin. В основном каталоге выходных данных не создается вложенный каталог Глобалресаурцес приложений\_. Если файл конфигурации указывает appliesTo = "ALL", файлы. resx и. Resources копируются в выходные каталоги. Они не копируются, если на них ссылается [буилдпровидер](https://msdn.microsoft.com/library/system.web.configuration.buildprovider.aspx). |
| файлы. resx и. Resource в приложении\_подкаталоге LocalResources | Эти файлы компилируются в сборки с уникальными именами и помещаются в каталог bin. В выходные каталоги не копируются файлы RESX или resource. |
| файлы Skin в подкаталоге приложения\_Themes | Темы компилируются в сборки и помещаются в каталог bin. Файлы заглушек создаются для файлов. Skin и помещаются в соответствующий выходной каталог. Статические файлы (например,. CSS) копируются в выходные каталоги. |
| . browser — типы статических файлов сборки, уже имеющиеся в каталоге bin | Эти файлы копируются как есть в выходной каталог. |

### <a name="fixed-assembly-names"></a>[Фиксированные имена сборок](https://msdn.microsoft.com/library/ms229863.aspx##)

В некоторых сценариях, например при развертывании веб-приложения с помощью MSI установщик Windows, требуется использовать совместимые имена файлов и содержимое, а также единообразные структуры каталогов для обнаружения сборок или параметров конфигурации для обновлений. В таких случаях можно использовать параметр **-fixednames** , чтобы указать, что средство компиляции ASP.NET должно компилировать сборку для каждого исходного файла, а не использовать, где несколько страниц компилируются в сборки. Это может привести к большому числу сборок, поэтому, если вы беспокоитесь о масштабируемости, следует использовать этот параметр с осторожностью.

### <a name="strong-name-compilation"></a>[Компиляция со строгим именем](https://msdn.microsoft.com/library/ms229863.aspx##)

Предоставляются параметры **-APTCA**, **-delaysign**, **-keycontainer** и **-keyfile** , позволяющие использовать ASPNET\_компилятора. exe для создания сборок со строгими именами без использования [средства строгих имен (Sn. exe)](https://msdn.microsoft.com/library/k5b5tt23.aspx) отдельно. Эти параметры соответствуют, соответственно, с **AllowPartiallyTrustedCallersAttribute**, **AssemblyDelaySignAttribute**, **AssemblyKeyNameAttribute**и **AssemblyKeyFileAttribute**.

Обсуждение этих атрибутов находится вне области этого курса.

## <a name="labs"></a>Тестовые службы

Каждая из следующих лабораторных занятий основана на предыдущих лабораториях. Их нужно будет сделать по порядку.

## <a name="lab-1-using-the-configuration-api"></a>Лаборатория 1. Использование API конфигурации

1. Создайте новый веб-сайт с именем *mod9lab*.
2. Добавьте новый файл веб-конфигурации на сайт.
3. Добавьте следующий фрагмент в файл Web. config:

[!code-xml[Main](configuration-and-instrumentation/samples/sample14.xml)]

Это обеспечит наличие разрешений на сохранение изменений в файле Web. config.

1. Добавьте новый элемент управления Label в Default. aspx и измените идентификатор на **лблдебугстатус**.
2. Добавьте новый элемент управления "Кнопка" в Default. aspx.
3. Измените идентификатор элемента управления кнопки на **бтнтоггледебуг** и текст для **переключения состояния отладки**.
4. Откройте представление кода для файла кода программной части Default. aspx и добавьте инструкцию **using** для **System. Web. Configuration** следующим образом:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample15.cs)]

1. Добавьте две частные переменные в класс и метод Page\_init, как показано ниже:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample16.cs)]

1. Добавьте следующий код для страницы загрузки\_:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample17.cs)]

1. Сохраните и просмотрите Default. aspx. Обратите внимание, что элемент управления Метка отображает текущее состояние отладки.
2. Дважды щелкните элемент управления Button в конструкторе и добавьте следующий код в событие Click для элемента управления Button:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample18.cs)]

1. Сохраните и просмотрите Default. aspx и нажмите кнопку.
2. Откройте файл Web. config после каждого нажатия кнопки и просмотрите атрибут **Debug** в разделе &lt;компиляции&gt;.

## <a name="lab-2-logging-application-restarts"></a>Лаборатория 2. Регистрация перезапусков приложения

В этом лабораторном занятии будет создан код, позволяющий переключать ведение журнала завершения работы приложений, запусков и перекомпиляций в Просмотр событий.

1. Добавьте DropDownList к Default. aspx и измените идентификатор на Ддллогаппевентс.
2. Установите свойство **AutoPostBack** для DropDownList в **значение true**.
3. Добавьте три элемента в коллекцию Items для DropDownList. Сделайте **текст** для первого элемента, *выберите значение* и значение-1. Сделайте **текст** и **значение** второго элемента равным **true** , а также **текст** и **значение** третьего элемента **false**.
4. Добавьте новую метку к Default. aspx. Измените идентификатор на **лбллогаппевентс**.
5. Откройте представление кода программной части для Default. aspx и добавьте новое объявление для переменной типа Хеалсмониторингсектион, как показано ниже:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample19.cs)]

1. Добавьте следующий код в существующий код на странице\_init:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample20.cs)]

1. Дважды щелкните DropDownList и добавьте следующий код в событие:

[!code-csharp[Main](configuration-and-instrumentation/samples/sample21.cs)]

1. Обзор Default. aspx.
2. Задайте для раскрывающегося списка **значение false**.
3. Очистите журнал приложений в Просмотр событий.
4. Нажмите кнопку, чтобы изменить атрибут отладки для приложения.
5. Обновите журнал приложений на Просмотр событий. 

    1. Были ли зарегистрированы события?
    2. Почему или почему?
6. Задайте для раскрывающегося списка **значение true.**
7. Нажмите кнопку, чтобы переключить атрибут Debug для приложения.
8. Обновите имя входа приложения Просмотр событий. 

    1. Были ли зарегистрированы события?
    2. Какова причина завершения работы приложения?
9. Поэкспериментируйте с включением и отключением ведения журнала и просмотрите изменения, внесенные в файл Web. config.

## <a name="more-information"></a>Дополнительные сведения:

Модель поставщика ASP.NET 2.0 позволяет создавать собственные поставщики для не только инструментария приложений, но и для многих других целей, таких как членство, профили и т. д. Подробные сведения о написании настраиваемого поставщика для записи событий приложения в текстовый файл см. по [этой ссылке](https://msdn.microsoft.com/library/default.asp?url=/library/dnaspp/html/ASPNETProvMod_Prt6.asp).
