---
uid: web-forms/overview/older-versions-security/admin/recovering-and-changing-passwords-cs
title: Восстановление и Смена паролей (C#) | Документация Майкрософт
author: rick-anderson
description: ASP.NET включает в себя два веб-элементы управления для соблюдения восстановление и Смена паролей. Элемент управления PasswordRecovery позволяет пользователю восстановить его потеряны pa...
ms.author: riande
ms.date: 04/01/2008
ms.assetid: 19c4d042-4e34-4b44-9f1d-6bf2253ba366
msc.legacyurl: /web-forms/overview/older-versions-security/admin/recovering-and-changing-passwords-cs
msc.type: authoredcontent
ms.openlocfilehash: e3e097663568b21ee3f84c7006a0bd89718ac6c2
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59380285"
---
# <a name="recovering-and-changing-passwords-c"></a>Восстановление и смена паролей (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.13.zip) или [скачать PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial13_ChangingPasswords_cs.pdf)

> ASP.NET включает в себя два веб-элементы управления для соблюдения восстановление и Смена паролей. Элемент управления PasswordRecovery позволяет пользователю восстановить его утраченный пароль. Элемент управления ChangePassword позволяет пользователю изменить свой пароль. Как и другие связанные с входом веб-элементов управления мы видели на протяжении всего этого цикла руководств PasswordRecovery и ChangePassword элементами с помощью структуры членства в фоновом для сброса или изменения паролей пользователей.


## <a name="introduction"></a>Вступление

Между веб-сайтов для моей bank, коммунальное, телефонная компания, учетные записи электронной почты и персонализированных веб-порталы, подобно большинству людей, у меня множество разных паролей. Учетным данным так много наизусть наши дни не пользователи часто забывают свой пароль. Чтобы это учесть, веб-сайтов, которые содержат учетные записи пользователей должны быть возможность для пользователя, чтобы восстановить свой пароль. Обычно этот процесс включает создание новый случайный пароль и отправка по электронной почте на адрес электронной почты пользователя в файле. После получения нового пароля большинство пользователей вернитесь на сайт и изменять свои пароли с случайным образом созданным запоминающийся оставить в списке.

ASP.NET включает в себя два веб-элементы управления для соблюдения восстановление и Смена паролей. Элемент управления PasswordRecovery позволяет пользователю восстановить его утраченный пароль. Элемент управления ChangePassword позволяет пользователю изменить свой пароль. Как и другие связанные с входом веб-элементов управления мы видели на протяжении всего этого цикла руководств PasswordRecovery и ChangePassword элементами с помощью структуры членства в фоновом для сброса или изменения паролей пользователей.

В этом руководстве мы рассмотрим использование этих двух элементов управления. Также будет показано, как программно изменять и сбрасывать пароль с помощью `MembershipUser` класса `ChangePassword` и `ResetPassword` методы.

## <a name="step-1-helping-users-recover-lost-passwords"></a>Шаг 1. Помощь пользователям восстановить потери паролей

Все веб-сайты, которые поддерживают учетные записи пользователей должны предоставлять пользователям какого-либо механизма, при восстановлении забытых паролей. Хорошей новостью является реализация такой функциональности в ASP.NET очень просто благодаря PasswordRecovery веб-элементе управления. Элемент управления PasswordRecovery предоставляет интерфейс, который запрашивает у пользователя имя пользователя и при необходимости, ответ на заданный вопрос безопасности. Она затем отправляется сообщение электронной почты пользователя свой пароль.

> [!NOTE]
> Так как сообщения электронной почты передаются по сети в виде обычного текста есть вероятность угрозы безопасности с отправкой пароля пользователя по электронной почте.


Элемент управления PasswordRecovery состоит из трех представлений.

- **Имя пользователя** -запрашивает посетителем свое имя пользователя. Это начальное представление.
- **Вопрос**-отображает вопрос пользователя имя пользователя и безопасности в виде текста, вместе с текстовым полем пользователю ввести ответ на свой вопрос безопасности.
- **Успех**-отображает сообщение, сообщая пользователю, что пароль был по электронной почте.

Отображаются представления и действия, выполняемые элементом управления PasswordRecovery зависят следующие параметры конфигурации членства:

- `RequiresQuestionAndAnswer`
- `EnablePasswordRetrieval`
- `EnablePasswordReset`

Структуру членства `RequiresQuestionAndAnswer` параметр указывает, является ли пользователи должны указать секретный вопрос и ответ, при регистрации для учетной записи. Как уже говорилось в <a id="_msoanchor_1"> </a> [ *Создание учетных записей пользователей* ](../membership/creating-user-accounts-cs.md) учебника, если `RequiresQuestionAndAnswer` равно True (по умолчанию), то CreateUserWizard интерфейс включает текстовое поле элементы управления для нового пользователя контрольный вопрос и ответ; Если `RequiresQuestionAndAnswer` имеет значение False, собираются такие сведения. Аналогично Если `RequiresQuestionAndAnswer` имеет значение True, то элемент управления отображает PasswordRecovery, вопрос просматривать после того как пользователь перейдет на свое имя пользователя; восстановление пароля только в том случае, если пользователь введет правильный контрольному ответу. Если `RequiresQuestionAndAnswer` имеет значение False, однако управления PasswordRecovery перемещает прямо из представления имени пользователя в представлении "успешно".

После предоставления его имя пользователя - или его имя пользователя и безопасности ответ, если `RequiresQuestionAndAnswer` имеет значение True - PasswordRecovery отправляется сообщение электронной почты пользователя свой пароль. Если `EnablePasswordRetrieval` параметр имеет значение True, а затем почте их текущий пароль пользователя. Если он имеет значение False и `EnablePasswordReset` имеет значение True, то управления PasswordRecovery создает новый случайный пароль для пользователя и отправляет этот новый пароль, чтобы их по электронной почте. Если оба `EnablePasswordRetrieval` и `EnablePasswordReset` имеют значение False, элемент управления PasswordRecovery вызывает исключение.

> [!NOTE]
> Помните, что `SqlMembershipProvider` хранит пароли пользователей в одном из трех форматов: Clear, Hashed (по умолчанию) или шифрование. Используемый механизм хранения зависит от параметров конфигурации членства; демонстрационное приложение использует формат хэшированный пароль. При использовании формата хэшированный пароль `EnablePasswordRetrieval` параметр должен быть установлен в значение False, так как система не может определить фактический пароль пользователя из хэшированный версией, хранящейся в базе данных.


Рис. 1 показано, как интерфейс и поведение PasswordRecovery зависит от конфигурации членства.


[![RequiresQuestionAndAnswer, EnablePasswordRetrieval и EnablePasswordReset влияют на внешний вид и поведение элемента управления PasswordRecovery](recovering-and-changing-passwords-cs/_static/image2.png)](recovering-and-changing-passwords-cs/_static/image1.png)

**Рис. 1**: `RequiresQuestionAndAnswer`, `EnablePasswordRetrieval`, И `EnablePasswordReset` влияют на внешний вид и поведение элемента управления PasswordRecovery ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image3.png))


> [!NOTE]
> В <a id="_msoanchor_2"> </a> [ *Создание схемы членства в SQL Server* ](../membership/creating-the-membership-schema-in-sql-server-cs.md) руководстве мы настроили поставщик членства, задав `RequiresQuestionAndAnswer` значение true, `EnablePasswordRetrieval` для Значение равно false, и `EnablePasswordReset` значение true.


### <a name="using-the-passwordrecovery-control"></a>С помощью элемента управления PasswordRecovery

Давайте взглянем на использование PasswordRecovery элемента управления в страницу ASP.NET. Откройте `RecoverPassword.aspx` и перетащите и удалить элемент управления PasswordRecovery из инструментария в конструктор; задать его `ID` для `RecoverPwd`. Как элементы управления Login и CreateUserWizard Web PasswordRecovery элемента управления представления отображают богатый интерфейс составные, включающий метки, текстовые поля, кнопки и элементов управления проверки. Можно настроить внешний вид представления через свойства стиля элемента управления или путем преобразования представления в шаблоны. Оставить этот в качестве упражнения для интересующихся.

При посещении этой страницы она введите ее имя пользователя и нажмите кнопку "Отправить". Так как мы задали `RequiresQuestionAndAnswer` управления будет присвоено значение True, если в параметрах конфигурации наших членства, PasswordRecovery, то отображения представления вопроса. После того как пользователь вводит свой правильный ответ на контрольный вопрос и щелкает «Отправить», управления PasswordRecovery обновить пароль тот, созданный случайным образом и адрес электронной почты этот пароль на адрес электронной почты для файла. Все это было возможно без нам придется писать ни одной строки кода!

Перед тестированием этой странице, имеется последний кусочек конфигурации для обслуживания: мы должны указать параметры доставки электронной почты в `Web.config`. Управления PasswordRecovery использует эти параметры для отправки электронной почты.

Конфигурация доставки почты указывается с помощью [ `<system.net>` элемент](https://msdn.microsoft.com/library/6484zdc1.aspx) [ `<mailSettings>` элемент](https://msdn.microsoft.com/library/w355a94k.aspx). Используйте [ `<smtp>` элемент](https://msdn.microsoft.com/library/ms164240.aspx) для указания метода доставки и адрес отправителя по умолчанию. Следующая разметка настраивает параметры электронной почты для использования сети SMTP сервера с именем `smtp.example.com` через порт 25, а также с помощью учетных данных имени пользователя/пароля имя пользователя и пароль.

> [!NOTE]
> `<system.net>` является дочерним элементом корневого `<configuration>` элемента и общего родителя с `<system.web>`. Таким образом, не следует помещать `<system.net>` сервисном `<system.web>` элемента; вместо этого поместите его на том же уровне.


[!code-xml[Main](recovering-and-changing-passwords-cs/samples/sample1.xml)]

Помимо использования SMTP-сервер в сети, можно дополнительно указать каталог раскладки, где следует вносимых отправку сообщений электронной почты.

Когда вы настроили параметры SMTP, перейдите на `RecoverPassword.aspx` страницы в обозревателе. Сначала попробуйте ввести имя пользователя, который не существует в хранилище пользователя. Как показано на рис. 2, элемент управления PasswordRecovery отображает сообщение о том, что сведения о пользователе оказываются недоступны. Текст сообщения можно настроить с помощью элемента управления [ `UserNameFailureText` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.usernamefailuretext.aspx).


[![Сообщение об ошибке отображается в том случае, если введено неправильное имя пользователя](recovering-and-changing-passwords-cs/_static/image5.png)](recovering-and-changing-passwords-cs/_static/image4.png)

**Рис. 2**: Сообщение об ошибке отображается в том случае, если введено неправильное имя пользователя ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image6.png))


Теперь введите имя пользователя. Используйте имя пользователя учетной записи в системе с адресом электронной почты, что вы можете получить доступ к и ответить на безопасности, которых вы знаете. После ввода имени пользователя и нажав кнопку Submit, элемент управления PasswordRecovery отображает его представления вопроса. Как с помощью представления имени пользователя, при вводе некорректное ответить на элемент управления отображает PasswordRecovery, сообщение об ошибке (см. рис. 3). Используйте [ `QuestionFailureText` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.questionfailuretext.aspx) осуществить это сообщение об ошибке.


[![Сообщение об ошибке отображается в том случае, если пользователь введет недопустимый ответ на контрольный вопрос](recovering-and-changing-passwords-cs/_static/image8.png)](recovering-and-changing-passwords-cs/_static/image7.png)

**Рис. 3**: Сообщение об ошибке отображается в том случае, если пользователь введет недопустимый ответ на контрольный вопрос ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image9.png))


Наконец введите правильный контрольному ответу и нажмите кнопку Отправить. На самом деле управления PasswordRecovery создает случайный пароль, ей назначается учетной записи пользователя, отправляет сообщение электронной почты, информирующее пользователя новым паролем (см. рис. 4), а затем отображает представлении "успешно".


[![Пользователю отправляется сообщение электронной почты с His новый пароль](recovering-and-changing-passwords-cs/_static/image11.png)](recovering-and-changing-passwords-cs/_static/image10.png)

**Рис. 4**: Пользователю отправляется сообщение электронной почты с His новый пароль ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image12.png))


### <a name="customizing-the-email"></a>Настройка электронной почты

Посылается элементом управления PasswordRecovery сообщение электронной почты по умолчанию является довольно тусклым (см. рис. 4). Сообщение отправляется из учетной записи, указанной в `<smtp>` элемента `from` атрибут с темой пароль и тело обычного текста:

Вернитесь на сайт и войдите, используя следующие сведения.

Имя пользователя: *имя пользователя*

Пароль: *пароль*

Это сообщение можно настроить программным способом через обработчик событий для элемента управления PasswordRecovery [ `SendingMail` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.sendingmail.aspx), или декларативно с помощью [ `MailDefinition` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.passwordrecovery.maildefinition.aspx). Рассмотрим оба варианта.

`SendingMail` Событие непосредственно перед передачей сообщения электронной почты отправляется и является нашей последний шанс программными методами настроить форматирование сообщения электронной почты. При возникновении этого события, обработчик событий передается объект типа [ `MailMessageEventArgs` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.mailmessageeventargs.aspx), чей `Message` свойство содержит ссылку на адрес электронной почты, которые будут отправлены.

Создайте обработчик событий для `SendingMail` событий и добавьте следующий код, который программно добавляет `webmaster@example.com` в список "Копия".

[!code-csharp[Main](recovering-and-changing-passwords-cs/samples/sample2.cs)]

Сообщение электронной почты можно также настроить с помощью декларативным образом. PasswordRecovery `MailDefinition` свойство является объектом типа [ `MailDefinition` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.aspx). `MailDefinition` Класс предлагает целый ряд свойств, связанных с электронной почты, включая `From`, `CC`, `Priority`, `Subject`, `IsBodyHtml`, `BodyFileName`и другие. Во-первых, задайте [ `Subject` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.subject.aspx) более подробным, чем от применяемой по умолчанию (пароль), например сброса пароля...

Чтобы настроить текст сообщения электронной почты, что необходимо создать файл шаблона отдельном сообщении электронной почты, содержащий содержимое тела. Начнем с создания новой папки в веб-сайт с именем `EmailTemplates`. Добавьте новый текстовый файл в эту папку с именем `PasswordRecovery.txt` и добавьте следующее содержимое:

[!code-aspx[Main](recovering-and-changing-passwords-cs/samples/sample3.aspx)]

Обратите внимание на использование заполнители `<%UserName%>` и `<%Password%>`. Элемент управления PasswordRecovery автоматически заменяет эти два заполнителя имени пользователя и восстановленный пароль перед отправкой сообщения электронной почты.

Наконец, укажите `MailDefinition` [ `BodyFileName` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.bodyfilename.aspx) в почтовом шаблоне, который мы только что создали (`~/EmailTemplates/PasswordRecovery.txt`).

После внесения этих изменений вернуться к этому `RecoverPassword.aspx` и введите имя пользователя и безопасности ответа. Вы получите следует сообщение электронной почты, который выглядит, как показано на рис. 5. Обратите внимание, что `webmaster@example.com` был бы "Копия" и что обновились тему и текст.


[![Темы, текста и список "Копия" были обновлены](recovering-and-changing-passwords-cs/_static/image14.png)](recovering-and-changing-passwords-cs/_static/image13.png)

**Рис. 5**: Темы, текста и копия списка были обновлены ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image15.png))


Для отправки электронной почты в формате HTML установите [ `IsBodyHtml` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.isbodyhtml.aspx) True (по умолчанию — False), а обновление шаблона сообщения электронной почты для включения HTML.

`MailDefinition` Свойство не является уникальным в класс PasswordRecovery. Как мы увидим в шаге 2, элемент управления ChangePassword также предлагает `MailDefinition` свойство. Кроме того, элемент управления CreateUserWizard включает такое свойство, можно настроить для автоматической отправки сообщения приветственное сообщение электронной почты новым пользователям.

> [!NOTE]
> В настоящее время нет ссылок на левой панели навигации, для достижения `RecoverPassword.aspx` страницы. Только пользователь будут заинтересованы в просмотре страницы в том случае, если она не удалось успешно войти в систему на сайте. Таким образом, обновление `Login.aspx` добавьте ссылку на страницу `RecoverPassword.aspx` страницы.


### <a name="programmatically-resetting-a-users-password"></a>Программно сброс пароля пользователя

При сбросе пароля пользователя PasswordRecovery контролирующие вызовы, `MembershipUser` объекта [ `ResetPassword` метод](https://msdn.microsoft.com/library/system.web.security.membershipuser.resetpassword.aspx). Этот метод имеет две перегрузки:

- **[`ResetPassword`](https://msdn.microsoft.com/library/d94bdzz2.aspx)** — Выполняет сброс пароля пользователя. Используйте этот перегруженный метод, если `RequiresQuestionAndAnswer` имеет значение False.
- **[`ResetPassword(securityAnswer)`](https://msdn.microsoft.com/library/d90zte4w.aspx)** -Сбрасывает только если пароль пользователя, предоставленный *securityAnswer* указано правильно. Используйте этот перегруженный метод, если `RequiresQuestionAndAnswer` имеет значение True.

Обе перегрузки возвращают новый созданный случайным образом пароль.

Как с помощью других методов в структуру членства, `ResetPassword` делегатами метода систему настроенного поставщика. `SqlMembershipProvider` Вызывает `aspnet_Membership_ResetPassword` хранимую процедуру, передав имя пользователя, новый пароль и ответ заданным паролем, среди прочего. Хранимая процедура гарантирует, что соответствует ответ пароля, а затем обновляет пароль пользователя.

Пара замечаний по низкоуровневой реализации:

- Заблокированной пользователь не может сбросить свой пароль. Тем не менее может пользователь с правами «не утверждено». Мы обсудим заблокированные и утверждены состояния более подробно в <a id="_msoanchor_3"> </a> [ *Unlocking и утверждение пользователя* ](unlocking-and-approving-user-accounts-cs.md) руководстве учетных записей.
- Если неверный ответ на проверочный вопрос, увеличивается количество попыток ответов неудачных пароль пользователя. Если указанное число попытки ввода неправильного ответа в течение указанного интервала времени, пользователь заблокирован.

### <a name="a-word-on-how-the-random-passwords-are-generated"></a>Создаются слово в том, как случайные пароли

Случайно сгенерированное пароли, показанный в сообщениях электронной почты, на рис. 4 и 5, создаваемые в класс членства [ `GeneratePassword` метод](https://msdn.microsoft.com/library/system.web.security.membership.generatepassword.aspx). Этот метод принимает два входных параметров, целое число - *длина* и *numberOfNonAlphanumericCharacters* — и возвращает строку, по крайней мере *длина* символов долго с по бы *numberOfNonAlphanumericCharacters* число не буквенно-цифровых символов. Когда этот метод вызывается из в классы членства или связанные с входом веб-элементы управления, значения этих двух параметров определяются конфигурации членства `MinRequiredPasswordLength` и `MinRequiredNonalphanumericCharacters` свойства, которые мы присваиваем 7 и 1, соответственно.

`GeneratePassword` Метод использует криптостойкой генератора случайных чисел для убедитесь, что в выбраны какие случайные символы без смещения. Кроме того `GeneratePassword` является `public`, это означает, что можно использовать его напрямую из приложения ASP.NET, если вы хотите создать случайных строк или пароли.

> [!NOTE]
> `SqlMembershipProvider` Класс всегда создает случайный пароль менее 14 символов, поэтому, если `MinRequiredPasswordLength` меньше 14, а затем его значение обрабатывается.


## <a name="step-2-changing-passwords"></a>Шаг 2. Изменение паролей

Случайно сгенерированное пароли трудны для запоминания. Рассмотрим пароль, показанный на рис. 4: `WWGUZv(f2yM:Bd`. Попробуйте ввести фиксации, в памяти. Нечего и говорить после отправки пользователь случайно созданным паролем такого рода, она захотите изменить пароль на более запоминающееся.

Используйте элемент управления ChangePassword для создания интерфейса пользователь может изменить свой пароль. Во многом как управления PasswordRecovery, элемент управления ChangePassword состоит из двух частей: Изменение пароля и успех. Изменение пароля представление запрашивает у пользователя старый и новый пароли. После предоставления старый пароль и новый пароль, отвечающий минимальную длину, требования не буквенно-цифровых символов, элемент управления ChangePassword обновляет пароль пользователя и отображаются в представлении "успешно".

> [!NOTE]
> Элемент управления ChangePassword изменяет пароль пользователя, вызвав `MembershipUser` объекта [ `ChangePassword` метод](https://msdn.microsoft.com/library/system.web.security.membershipuser.changepassword.aspx). Метод ChangePassword имеет два `string` входных параметров - *oldPassword* и *newPassword*- и обновляет учетную запись пользователя с *newPassword*, при условии, что предоставленный *oldPassword* указано правильно.


Откройте `ChangePassword.aspx` странице и добавьте элемент управления ChangePassword к странице, назвав его `ChangePwd`. На этом этапе в режим конструктора должно отображаться по изменению пароля представления (см. рис. 6). Как с элементом управления PasswordRecovery, можно переключаться между представлениями через смарт-тега элемента управления. Кроме того эти представления внешний вид настраиваются через свойства различные стиля или путем их преобразования в шаблон.


[![Добавьте на страницу элемент управления ChangePassword](recovering-and-changing-passwords-cs/_static/image17.png)](recovering-and-changing-passwords-cs/_static/image16.png)

**Рис. 6**: Добавьте на страницу элемент управления ChangePassword ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image18.png))


Элемент управления ChangePassword можно обновить пароль пользователя, выполнившего вход *или* пароль другой, указанного пользователя. Как показано на рис. 6, изменение пароля представление по умолчанию отображает только три элемента управления TextBox: один для старого пароля и два — для нового пароля. Этот интерфейс по умолчанию используется для обновления пароля текущего пользователя.

Чтобы использовать элемент управления ChangePassword обновить пароль другого пользователя, задайте элемента управления [ `DisplayUserName` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.changepassword.displayusername.aspx) значение true. Это добавляет четвертое текстовое поле на страницу, выполнении запроса на имя пользователя, пароль которого для изменения.

Параметр `DisplayUserName` к полезным, если вы хотите разрешить out вошедшего пользователя сменить пароль не требуется входить значение True. Лично я думаю, что нет ничего страшного, запросив пользователя с именем входа, прежде чем разрешить ей изменить свой пароль. Таким образом, оставьте `DisplayUserName` значение False (по умолчанию). В принятии такого решения, тем не менее, мы по существу с запретом на использование анонимных пользователей из обратились к этой странице. Обновить правила авторизации URL-адрес веб-узла таким образом, чтобы запретить анонимные пользователи из см. в статье `ChangePassword.aspx`. Если вам нужно обновить свою память на синтаксис правила авторизации URL-адрес, обращаться к <a id="_msoanchor_4"> </a> [ *авторизации на основе пользователя* ](../membership/user-based-authorization-cs.md) руководства.

> [!NOTE]
> Может показаться, `DisplayUserName` может быть удобно, что позволяет администраторам изменять пароли других пользователей. Тем не менее, даже если `DisplayUserName` имеет значение True, должны известные и вводиться старый пароль. Будут рассмотрены методы предоставления администраторам изменять пароли пользователей на шаге 3.


Посетите `ChangePassword.aspx` странице через браузер и измените пароль. Обратите внимание, что отображается сообщение об ошибке, если ввести новый пароль, который не соответствует требованиям не буквенно-цифровых символов, указанным в конфигурации членства и длина пароля (см. рис. 7).


[![Добавьте на страницу элемент управления ChangePassword](recovering-and-changing-passwords-cs/_static/image20.png)](recovering-and-changing-passwords-cs/_static/image19.png)

**Рис. 7**: Добавьте на страницу элемент управления ChangePassword ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image21.png))


После ввода правильный пароль старого и нового пароля, вошедших в систему на пользователя пароль изменен, и отображается в представлении "успешно".

### <a name="sending-a-confirmation-email"></a>Отправка электронной почты с подтверждением

По умолчанию элемент управления ChangePassword не отправляет сообщение электронной почты для пользователя, пароль которого было изменено. Если вы хотите отправить сообщение электронной почты, просто настроить элемент управления `MailDefinition` свойство. Давайте настроим элемент управления ChangePassword таким образом, пользователю отправляется сообщение электронной почты формат HTML, содержащий новый пароль.

Начните с создания нового файла в `EmailTemplates` папку с именем `ChangePassword.htm`. Добавьте следующую разметку:

[!code-html[Main](recovering-and-changing-passwords-cs/samples/sample4.html)]

Переключите элемент управления ChangePassword `MailDefinition` свойства `BodyFileName`, `IsBodyHtml`, и `Subject` свойства ~ / EmailTemplates/ChangePassword.htm "," True "и" пароль был изменен!, соответственно.

После внесения этих изменений, повторном посещении страницы и изменить пароль снова. На этот раз элемент управления ChangePassword отправляет свои собственные, формате HTML по электронной почте на адрес электронной почты пользователя в файле (см. рис. 8).


[![По электронной почте сообщение о том, что их пароль пользователя был изменен](recovering-and-changing-passwords-cs/_static/image23.png)](recovering-and-changing-passwords-cs/_static/image22.png)

**Рис. 8**: По электронной почте сообщение о том, что их пароль пользователя был изменен ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image24.png))


## <a name="step-3-allowing-administrators-to-change-users-passwords"></a>Шаг 3. Что позволяет администраторам изменять пароли пользователей

Характерной в приложениях, поддерживающих учетных записей пользователей является возможность менять пароли других пользователей пользователь с правами администратора. Иногда эта функциональность не требуется, поскольку в системе нет возможности пользователям изменять свои пароли. В этом случае администратор может назначить их новый пароль будет единственным способом для пользователя, чтобы восстановить забытый пароль. С элементами управления PasswordRecovery и ChangePassword тем не менее, пользователи с правами администратора должны не заняты сами с изменение паролей пользователей, как пользователи способны делать это самостоятельно.

Но что делать, если ваш клиент настаивает, что пользователи с правами администратора должен иметь возможность изменять пароли других пользователей? К сожалению добавлению этой функции может быть немного усилий. Чтобы изменить пароль пользователя, старый и новый пароль должен быть введен для `MembershipUser` объекта `ChangePassword` метод, но администратор не должны знать пароль, чтобы изменить его.

В этом случае является сначала сбросить пароль пользователя, а затем изменить его на новый пароль, с помощью следующего кода:

[!code-aspx[Main](recovering-and-changing-passwords-cs/samples/sample5.aspx)]

Этот код запускается посредством получения информации о *имя пользователя*, который является пользователя, пароль которого администратор желает изменить. Далее, `ResetPassword` вызывается метод, который присваивает и новый случайный пароль пользователя. Этот пароль, созданный случайным образом возвращается с помощью метода, которая хранится в переменной `resetPwd`. Теперь, когда мы знаем, пароль пользователя, мы можем изменить через вызов `ChangePassword`.

Проблема в том, что этот код работает, только если конфигурация системы членства настроена таким образом, чтобы `RequiresQuestionAndAnswer` имеет значение False. Если `RequiresQuestionAndAnswer` имеет значение True, так как это с нашего приложения, а затем `ResetPassword` метод необходимо передать ответ на контрольный вопрос, в противном случае будет выдано исключение.

Если структуры членства настроен для использования контрольных вопросов и ответов, а еще клиент настаивает администраторы могли менять пароли пользователей, у вас есть три варианта:

- Throw рук в воздухе и сообщите вашего клиента, что это только одну вещь, которую невозможно выполнить.
- Задайте `RequiresQuestionAndAnswer` значение False. Это приводит к менее безопасного приложения. Представьте себе, что 2008г получило доступ к электронной почты другого пользователя. Возможно скомпрометированный пользователь покинул обеденного своим столом и не блокировки рабочей станции или, возможно они доступ к электронной почте из терминала открытый и не выйти из системы. В любом случае можно посетить 2008г `RecoverPassword.aspx` и введите имя пользователя. Система будет отправить по электронной почте восстановленный пароль без запроса ответ на контрольный вопрос.
- Обход уровень абстракции, созданные структуры членства и работы непосредственно с базой данных SQL Server. Эта схема членства включает хранимую процедуру с именем `aspnet_Membership_SetPassword` , задает пароль пользователя и не требует ответ на контрольный вопрос или старый пароль для выполнения своей задачи.

Ни один из этих параметров не её особенно привлекательной, но, как иногда переходит жизнь разработчика.

Я пошли дальше и реализации третий подход, написание кода, который обходит `Membership` и `MembershipUser` классы и работает непосредственно с `SecurityTutorials` базы данных.

> [!NOTE]
> Работая непосредственно с базой данных, является shattered инкапсуляция, предоставляемый платформой членства. Это решение объединяет нам `SqlMembershipProvider`, что делает наш код менее portable. Кроме того этот код не может работать правильно в будущих версиях ASP.NET, при изменении схемы членства. Этот подход является обходной путь и, как и большинство обходные пути, не является примером рекомендации.


Код имеет некоторые непривлекательной бита и довольно длинный. Таким образом я не хочу загромождать этого руководства с подробное описание его. Если вы заинтересованы в получении дополнительной, загрузить код для этого руководства и посещение `~/Administration/ManageUsers.aspx` страницы. Эта страница, созданный в учебном курсе <a id="_msoanchor_5"> </a> [предыдущем учебном курсе](building-an-interface-to-select-one-user-account-from-many-cs.md), список всех пользователей. Обновлен GridView, чтобы включить ссылку на `UserInformation.aspx` страницы, передав имя выбранного пользователя через строку запроса. `UserInformation.aspx` Странице отображаются сведения о выбранных пользователем и текстовые поля для изменения пароля (см. рис. 9).

После ввода нового пароля, подтверждение его второго текстового поля и щелкнув кнопкой "Обновить пользователя", обратная и `aspnet_Membership_SetPassword` хранимой процедуры, выполняя обновление пароля. Я советую тем читателям, интересует эта функция более тесно знакомятся с кодом, и повторите расширение функциональных возможностей для включения отправки электронного сообщения для пользователя, чей пароль был изменен.


[![Администратор может изменить пароль пользователя](recovering-and-changing-passwords-cs/_static/image26.png)](recovering-and-changing-passwords-cs/_static/image25.png)

**Рис. 9**: Администратор может изменить пароль пользователя ([Просмотр полноразмерного изображения](recovering-and-changing-passwords-cs/_static/image27.png))


> [!NOTE]
> `UserInformation.aspx` Странице в настоящее время работает только если структуру членства настроен для хранения паролей в формате Clear или Hashed. У него нет кода для шифрования новый пароль, несмотря на то, что вам будет предложено добавить эту функцию. Я рекомендую, добавив нужный код, рекомендуется использовать как декомпилятор [Reflector](http://www.aisto.com/roeder/dotnet/) для изучения исходного кода для методов в .NET Framework; начинать с проверки `SqlMembershipProvider` класса `ChangePassword` метод. Это методики, которую я можно писать код для создания хэша пароля.


## <a name="summary"></a>Сводка

ASP.NET предоставляет два элемента управления, помогающие пользователям управлять свой пароль. Элемент управления PasswordRecovery полезно для тех, кто забывшим свои пароли. В зависимости от конфигурации структуру членства пользователя либо по электронной почте свой текущий пароль или новый созданный случайным образом пароль. Элемент управления ChangePassword позволяет пользователю изменить свой пароль.

Как и элементы управления Login и CreateUserWizard PasswordRecovery и ChangePassword визуализируют мощный пользовательский интерфейс не нужно писать ни строчки декларативная разметка или строку кода. Если пользовательский интерфейс по умолчанию не соответствует вашим потребностям, можно настроить его через различные свойства стиля. Кроме того интерфейсы управления может быть преобразован в шаблоны для еще большей степени контроля. За кулисами этих элементов управления используется API членства, вызов `MembershipUser` объекта `ResetPassword` и `ChangePassword` методы.

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Элемент управления ChangePassword краткие руководства](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/changepassword.aspx)
- [Примеры использования элемента управления PasswordRecovery](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/passwordrecovery.aspx)
- [Отправка сообщения электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)
- [`System.Net.Mail` Часто задаваемые вопросы](http://www.systemnetmail.com/)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Лиз Шалок в этом руководстве включают Майкл Emmings и Банерджи Suchi. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](building-an-interface-to-select-one-user-account-from-many-cs.md)
> [Вперед](unlocking-and-approving-user-accounts-cs.md)
