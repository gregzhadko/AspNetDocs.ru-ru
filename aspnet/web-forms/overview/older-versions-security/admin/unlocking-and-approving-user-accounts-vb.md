---
uid: web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-vb
title: Разблокировка и утверждение учетных записей пользователей (VB) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве показано, как создать веб-страницу для администраторов, чтобы управлять заблокированными и утвержденными состояниями пользователей. Мы также посмотрим, как утвердить новых пользователей...
ms.author: riande
ms.date: 04/01/2008
ms.assetid: 041854a5-ea8c-4de0-82f1-121ba6cb2893
msc.legacyurl: /web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-vb
msc.type: authoredcontent
ms.openlocfilehash: 4a7474676b8f502c583e226678de2b275e0ea3c7
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78517734"
---
# <a name="unlocking-and-approving-user-accounts-vb"></a>Снятие блокировки и утверждение учетных записей пользователей (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/VB.14.zip) или [скачать PDF](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_vb.pdf)

> В этом руководстве показано, как создать веб-страницу для администраторов, чтобы управлять заблокированными и утвержденными состояниями пользователей. Мы также посмотрим, как утверждать новых пользователей только после проверки адреса электронной почты.

## <a name="introduction"></a>Введение

Вместе с именем пользователя, паролем и электронной почтой каждая учетная запись пользователя имеет два поля состояния, определяющие, может ли пользователь войти на сайт: заблокировано и утверждено. Пользователь автоматически блокируется, если он предоставляет недействительные учетные данные указанное число раз в течение заданного числа минут (параметры по умолчанию заблокируют пользователя после 5 недопустимых попыток входа в систему в течение 10 минут). Утвержденное состояние полезно в сценариях, где некоторые действия должны пройти до того, как новый пользователь сможет войти на сайт. Например, пользователю может потребоваться сначала проверить свой адрес электронной почты или утвердить его администратором, прежде чем сможет войти в систему.

Так как заблокированный или Неутвержденный пользователь не может войти в систему, естественно узнать, как можно сбросить эти состояния. ASP.NET не включает встроенные функции и веб-элементы управления для управления заблокированными и утвержденными состояниями, частично, поскольку эти решения должны обрабатываться отдельно для каждого узла. Некоторые сайты могут автоматически утверждать все новые учетные записи пользователей (поведение по умолчанию). У других есть права администратора, утверждающие новые учетные записи или не утверждающие пользователей, пока они не будут посещать ссылку, отправленную на адрес электронной почты, указанный при регистрации. Аналогичным образом некоторые сайты могут блокировать пользователей, пока администратор не сбрасывает состояние, а другие сайты отправляют сообщение электронной почты заблокированному пользователю по URL-адресу для разблокировки учетной записи.

В этом руководстве показано, как создать веб-страницу для администраторов, чтобы управлять заблокированными и утвержденными состояниями пользователей. Мы также посмотрим, как утверждать новых пользователей только после проверки адреса электронной почты.

## <a name="step-1-managing-users-locked-out-and-approved-statuses"></a>Шаг 1. Управление заблокированными и утвержденными состояниями пользователей

<a id="Tutorial12"> </a>В [*создании интерфейса для выбора одной учетной записи пользователя из многих*](building-an-interface-to-select-one-user-account-from-many-vb.md) учебных заработок была создана страница, в которой каждая учетная запись пользователя была выведена в отфильтрованном виде, фильтрованном элементе управления GridView. В сетке перечислены имя и адрес электронной почты каждого пользователя, утвержденные и заблокированные состояния, будь то в сети и какие комментарии пользователю. Чтобы управлять утвержденными и заблокированными состояниями пользователей, можно сделать эту сетку редактируемой. Чтобы изменить состояние утвержденного пользователя, администратор сначала найдет учетную запись пользователя, а затем отредактирует соответствующую строку GridView, установив или сняв флажок утверждено. Кроме того, можно управлять состоянием утвержденных и заблокированных состояний с помощью отдельной страницы ASP.NET.

В этом руководстве мы будем использовать две страницы ASP.NET: `ManageUsers.aspx` и `UserInformation.aspx`. Идея в том, что `ManageUsers.aspx` выводит список учетных записей пользователей в системе, а `UserInformation.aspx` позволяет администратору управлять утвержденными и заблокированными состояниями для конкретного пользователя. Наш первый заказ заключается в том, чтобы дополнить GridView в `ManageUsers.aspx`, чтобы включить HyperLinkField, который визуализируется как столбец ссылок. Мы хотим, чтобы каждая ссылка указывала на `UserInformation.aspx?user=UserName`, где *username* — имя пользователя, которого нужно изменить.

> [!NOTE]
> Если вы загрузили код для <a id="Tutorial13"> </a>учебника по [*восстановлению и смене паролей*](recovering-and-changing-passwords-vb.md) , возможно, вы заметили, что `ManageUsers.aspx` страница уже содержит набор ссылок "Управление", а страница `UserInformation.aspx` предоставляет интерфейс для изменения пароля выбранного пользователя. Я решил не выполнять репликацию этих функций в коде, связанном с этим руководством, поскольку он работал путем обхода API членства и работы непосредственно с SQL Server базой данных для изменения пароля пользователя. Это руководство начинается с самого начала со страницы `UserInformation.aspx`.

### <a name="adding-manage-links-to-theuseraccountsgridview"></a>Добавление ссылок "Управление" в`UserAccounts`GridView

Откройте страницу `ManageUsers.aspx` и добавьте HyperLinkField в `UserAccounts` GridView. Задайте для свойства `Text` HyperLinkField значение "Manage", а свойства `DataNavigateUrlFields` и `DataNavigateUrlFormatString` — `UserName` и "Усеринформатион. aspx? User ={0}" соответственно. Эти параметры настраивают HyperLinkField таким образом, что все гиперссылки отображают текст "Manage", но каждая ссылка передается в строку запроса с соответствующим значением *username* .

После добавления HyperLinkField в GridView просмотрите страницу `ManageUsers.aspx` в браузере. Как показано на рис. 1, каждая строка GridView теперь включает ссылку "Управление". Ссылка "Управление" для Брюс указывает на `UserInformation.aspx?user=Bruce`, а ссылка "Управление" для Дейв указывает на `UserInformation.aspx?user=Dave`.

[![HyperLinkField добавляет элемент](unlocking-and-approving-user-accounts-vb/_static/image2.png)](unlocking-and-approving-user-accounts-vb/_static/image1.png)

**Рис. 1**. HyperLinkField добавляет ссылку "Управление" для каждой учетной записи пользователя ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-vb/_static/image3.png))

Мы создадим пользовательский интерфейс и код для страницы `UserInformation.aspx`, но сначала давайте поговорим о том, как программным образом изменить заблокированные и утвержденные состояния пользователя. [Класс`MembershipUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) имеет свойства [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) и [`IsApproved`](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx). Свойство `IsLockedOut` доступно только для чтения. Механизм программной блокировки пользователя не предусмотрен. чтобы разблокировать пользователя, используйте [метод`UnlockUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)класса `MembershipUser`. Свойство `IsApproved` доступно для чтения и записи. Чтобы сохранить изменения, внесенные в это свойство, необходимо вызвать [метод`UpdateUser`](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx)класса `Membership`, передав измененный объект `MembershipUser`.

Поскольку свойство `IsApproved` доступно для чтения и записи, элемент управления CheckBox, вероятно, является лучшим элементом пользовательского интерфейса для настройки этого свойства. Однако флажок не будет работать для свойства `IsLockedOut`, поскольку администратор не может заблокировать пользователя, он может разблокировать пользователя. Подходящим пользовательским интерфейсом для свойства `IsLockedOut` является кнопка, которая при щелчке разблокирует учетную запись пользователя. Эта кнопка должна быть включена, только если пользователь заблокирован.

### <a name="creating-theuserinformationaspxpage"></a>Создание страницы`UserInformation.aspx`

Теперь мы готовы реализовать пользовательский интерфейс в `UserInformation.aspx`. Откройте эту страницу и добавьте следующие веб-элементы управления:

- Элемент управления HyperLink, который при щелчке возвращает администратора на страницу `ManageUsers.aspx`.
- Веб-элемент управления Label для отображения имени выбранного пользователя. Задайте для этой метки `ID` значение `UserNameLabel` и удалите его свойство Text.
- Элемент управления CheckBox с именем `IsApproved`. Задайте для свойства `AutoPostBack` значение `True`.
- Элемент управления Label для отображения даты последнего блокировки пользователя. Назовите эту метку `LastLockedOutDateLabel` и очистите ее свойство `Text`.
- Кнопка для разблокировки пользователя. Присвойте этой кнопке имя `UnlockUserButton` и задайте для свойства `Text` значение "разблокировать пользователя".
- Элемент управления "метка" для отображения сообщений о состоянии, например "состояние утверждения пользователя Обновлено". Назовите этот элемент управления `StatusMessage`, очистите его свойство `Text` и задайте для его свойства `CssClass` значение `Important`. (Класс `Important` CSS определен в `Styles.css` файле стилей. он отображает соответствующий текст в большом красном шрифте.)

После добавления этих элементов управления представление конструирования в Visual Studio должны выглядеть примерно так, как на снимке экрана на рис. 2.

[![создания пользовательского интерфейса для Усеринформатион. aspx](unlocking-and-approving-user-accounts-vb/_static/image5.png)](unlocking-and-approving-user-accounts-vb/_static/image4.png)

**Рис. 2**. Создание пользовательского интерфейса для `UserInformation.aspx` ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-vb/_static/image6.png))

После завершения пользовательского интерфейса Наша следующая задача — установить флажок `IsApproved` и другие элементы управления на основе сведений о выбранном пользователе. Создайте обработчик событий для события `Load` страницы и добавьте следующий код:

[!code-vb[Main](unlocking-and-approving-user-accounts-vb/samples/sample1.vb)]

Приведенный выше код начинается с того, что он является первым посещением страницы, а не последующей обратной передачи. Затем он считывает имя пользователя, переданное с помощью поля QueryString `user`, и получает сведения об этой учетной записи пользователя с помощью метода `Membership.GetUser(username)`. Если в строке запроса не было указано имя пользователя или указанный пользователь не найден, администратор отправляет его обратно на страницу `ManageUsers.aspx`.

Значение `UserName` объекта `MembershipUser` отображается в `UserNameLabel`, а флажок `IsApproved` проверяется на основе значения свойства `IsApproved`.

[Свойство`LastLockoutDate`](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) объекта `MembershipUser` возвращает значение `DateTime`, указывающее время последней блокировки пользователя. Если пользователь никогда не был заблокирован, возвращаемое значение зависит от поставщика членства. При создании новой учетной записи `SqlMembershipProvider` задает `1754-01-01 12:00:00 AM`поле `LastLockoutDate` таблицы `aspnet_Membership`. Приведенный выше код отображает пустую строку в `LastLockoutDateLabel`, если свойство `LastLockoutDate` происходит раньше года 2000; в противном случае часть даты свойства `LastLockoutDate` отображается в метке. Свойству `Enabled` `UnlockUserButton`присваивается состояние блокировки пользователя, означающее, что эта кнопка будет включена только в том случае, если пользователь заблокирован.

Протестируйте страницу `UserInformation.aspx` в браузере. Конечно, необходимо начать с `ManageUsers.aspx` и выбрать учетную запись пользователя для управления. При поступлении на `UserInformation.aspx`Обратите внимание, что флажок `IsApproved` проверяется только в том случае, если пользователь утвержден. Если пользователь когда-либо был заблокирован, отображается последняя блокировка даты блокировки. Кнопка разблокировать пользователя доступна, только если пользователь в данный момент заблокирован. Установка или снятие флажка `IsApproved` или нажатие кнопки "разблокировать пользователя" вызывает обратную передачу, но не вносятся изменения в учетную запись пользователя, так как мы еще создали обработчики событий для этих событий.

Вернитесь в Visual Studio и создайте обработчики событий для `CheckedChanged` события флажка `IsApproved` и события `Click` кнопки `UnlockUser`. В обработчике событий `CheckedChanged` установите свойство `IsApproved` пользователя в свойство `Checked` флажка, а затем сохраните изменения с помощью вызова `Membership.UpdateUser`. В обработчике событий `Click` просто вызовите метод `UnlockUser` объекта `MembershipUser`. В обоих обработчиках событий отобразите подходящее сообщение в метке `StatusMessage`.

[!code-vb[Main](unlocking-and-approving-user-accounts-vb/samples/sample2.vb)]

### <a name="testing-theuserinformationaspxpage"></a>Тестирование страницы`UserInformation.aspx`

Заполнив эти обработчики событий, перейдите на страницу и не утвердите пользователя. Как показано на рис. 3, на странице должно отобразиться краткое сообщение о том, что свойство `IsApproved` пользователя успешно изменено.

[![Крис не утвержден](unlocking-and-approving-user-accounts-vb/_static/image8.png)](unlocking-and-approving-user-accounts-vb/_static/image7.png)

**Рис. 3**. Петр был неодобрен ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-vb/_static/image9.png))

Затем выполните выход и попробуйте войти в систему от имени пользователя, учетная запись которого была только что утверждена. Поскольку пользователь не утвержден, он не может войти в систему. По умолчанию элемент управления Login отображает то же сообщение, если пользователь не может войти в систему, независимо от причины. Но в <a id="Tutorial6"> </a>учебнике [*Проверка учетных данных пользователя в хранилище пользователей членства*](../membership/validating-user-credentials-against-the-membership-user-store-vb.md) мы рассматривали усовершенствование элемента управления Login для вывода более подходящего сообщения. Как показано на рис. 4, Крис показывает сообщение о том, что ему не удается выполнить вход, поскольку его учетная запись еще не утверждена.

[![Крис не удается войти, так как его учетная запись не утверждена](unlocking-and-approving-user-accounts-vb/_static/image11.png)](unlocking-and-approving-user-accounts-vb/_static/image10.png)

**Рис. 4**. Крис не может войти в систему, так как его учетная запись не утверждена ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-vb/_static/image12.png))

Чтобы протестировать функцию блокировки, попробуйте войти как утвержденного пользователя, но используйте неверный пароль. Повторите эту процедуру необходимое количество раз, пока учетная запись пользователя не будет заблокирована. Элемент управления Login также был обновлен для отображения пользовательского сообщения при попытке входа из заблокированной учетной записи. Вы уверены, что учетная запись заблокирована после того, как на странице входа появится следующее сообщение: "Ваша учетная запись заблокирована из-за слишком большого числа недопустимых попыток входа. Обратитесь к администратору, чтобы ваша учетная запись была разблокирована. "

Вернитесь на страницу `ManageUsers.aspx` и щелкните ссылку Управление для заблокированного пользователя. Как показано на рис. 5, вы увидите значение в `LastLockedOutDateLabel` необходимо включить кнопку разблокировать пользователя. Нажмите кнопку разблокировать пользователя, чтобы разблокировать учетную запись пользователя. После того как пользователь разблокируется, он сможет снова войти в систему.

[![Дейв заблокирована системой](unlocking-and-approving-user-accounts-vb/_static/image14.png)](unlocking-and-approving-user-accounts-vb/_static/image13.png)

**Рис. 5**. Дейв заблокирована системой ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-vb/_static/image15.png))

## <a name="step-2-specifying-new-users-approved-status"></a>Шаг 2. Указание утвержденного состояния новых пользователей

Утвержденное состояние полезно в тех случаях, когда требуется выполнить какие-либо действия, прежде чем новый пользователь сможет войти в систему и получить доступ к пользовательским функциям сайта. Например, вы можете запустить частный веб-сайт, где все страницы, кроме страниц входа и регистрации, доступны только пользователям, прошедшим проверку подлинности. Но что произойдет, если Стрэнджер достигает веб-сайта, находит страницу регистрации и создает учетную запись? Чтобы предотвратить это, можно переместить страницу регистрации в папку `Administration` и требовать от администратора вручную создавать каждую учетную запись. Кроме того, можно разрешить всем пользователям зарегистрироваться, но запретить доступ к сайту, пока администратор не утвердит учетную запись пользователя.

По умолчанию элемент управления CreateUserWizard утверждает новые учетные записи. Это поведение можно настроить с помощью [свойства`DisableCreatedUser`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx)элемента управления. Присвойте этому свойству значение `True`, чтобы не утверждать новые учетные записи пользователей.

> [!NOTE]
> По умолчанию элемент управления CreateUserWizard автоматически регистрируется в новой учетной записи пользователя. Это поведение определяется [свойством`LoginCreatedUser`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx)элемента управления. Так как неутвержденные пользователи не могут войти на сайт, то при `DisableCreatedUser` `True` новая учетная запись пользователя не будет зарегистрирована на сайте, независимо от значения свойства `LoginCreatedUser`.

Если вы создаете новые учетные записи пользователей программным способом с помощью метода `Membership.CreateUser`, для создания неутвержденной учетной записи пользователя используйте одну из перегрузок, принимающих значение свойства `IsApproved` нового пользователя в качестве входного параметра.

## <a name="step-3-approving-users-by-verifying-their-email-address"></a>Шаг 3. Утверждение пользователей путем проверки адреса электронной почты

Многие веб-сайты, поддерживающие учетные записи пользователей, не утверждают новых пользователей, пока они не проверяют адрес электронной почты, указанный при регистрации. Этот процесс проверки обычно используется для противодействия программы-роботы, спама и других не'ер-Do-Wells, так как ему требуется уникальный, проверенный адрес электронной почты и добавлен дополнительный шаг в процесс регистрации. При использовании этой модели при регистрации нового пользователя ему отправляется сообщение электронной почты, содержащее ссылку на страницу проверки. Перейдя по ссылке, пользователь получит сообщение электронной почты и, следовательно, что указанный адрес электронной почты является действительным. Страница верификации отвечает за утверждение пользователя. Это может произойти автоматически, тем самым утверждая любого пользователя, который достиг этой страницы, или только после того, как пользователь предоставит некоторую дополнительную информацию, например [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).

Для размещения этого рабочего процесса необходимо сначала обновить страницу создания учетной записи, чтобы новые пользователи не утверждались. Откройте страницу `EnhancedCreateUserWizard.aspx` в папке `Membership` и задайте для свойства `DisableCreatedUser` элемента управления CreateUserWizard значение `True`.

Далее необходимо настроить элемент управления CreateUserWizard для отправки сообщения электронной почты новому пользователю с инструкциями по проверке учетной записи. В частности, мы будем включать ссылку в сообщение электронной почты на страницу `Verification.aspx` (которая еще не создана), передавая `UserId` нового пользователя через строку запроса. Страница `Verification.aspx` будет искать указанного пользователя и пометить их как утвержденные.

### <a name="sending-a-verification-email-to-new-users"></a>Отправка проверочного электронного сообщения новым пользователям

Чтобы отправить сообщение электронной почты из элемента управления CreateUserWizard, настройте его свойство `MailDefinition` соответствующим образом. Как обсуждалось в <a id="Tutorial13"> </a> [предыдущем руководстве](recovering-and-changing-passwords-vb.md), элементы управления ChangePassword и пассвордрековери включают [свойство`MailDefinition`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) , которое работает так же, как и элемент управления CreateUserWizard.

> [!NOTE]
> Чтобы использовать свойство `MailDefinition`, необходимо указать параметры доставки почты в `Web.config`. Дополнительные сведения см. в разделе [Отправка электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).

Начните с создания нового шаблона сообщения электронной почты с именем `CreateUserWizard.txt` в папке `EmailTemplates`. Используйте для шаблона следующий текст:

[!code-aspx[Main](unlocking-and-approving-user-accounts-vb/samples/sample3.aspx)]

Задайте для свойства `BodyFileName` `MailDefinition`значение "~/Емаилтемплатес/креатеусервизард.ткст", а для свойства `Subject` — "Добро пожаловать на мой веб-сайт! Активируйте учетную запись ".

Обратите внимание, что шаблон `CreateUserWizard.txt` электронной почты содержит заполнитель `<%VerificationUrl%>`. Здесь будет размещен URL-адрес страницы `Verification.aspx`. CreateUserWizard автоматически заменяет заполнители `<%UserName%>` и `<%Password%>` именем пользователя и паролем новой учетной записи, но нет встроенного `<%VerificationUrl%>` заполнителя. Необходимо вручную заменить его соответствующим URL-адресом проверки.

Для этого создайте обработчик событий для [события`SendingMail`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) CreateUserWizard и добавьте следующий код:

[!code-vb[Main](unlocking-and-approving-user-accounts-vb/samples/sample4.vb)]

Событие `SendingMail` срабатывает после события `CreatedUser`, что означает, что в момент выполнения приведенного выше обработчика событий Новая учетная запись пользователя уже создана. Можно получить доступ к значению `UserId` нового пользователя, вызвав метод `Membership.GetUser`, передав `UserName`, введенный в элемент управления CreateUserWizard. Далее будет сформирован URL-адрес проверки. Инструкция `Request.Url.GetLeftPart(UriPartial.Authority)` возвращает `http://yourserver.com` часть URL-адреса. `Request.ApplicationPath` Возвращает путь, по которому приложение является корневым. После этого URL-адрес проверки определяется как `Verification.aspx?ID=userId`. Затем эти две строки объединяются для формирования полного URL-адреса. Наконец, текст сообщения электронной почты (`e.Message.Body`) содержит все вхождения `<%VerificationUrl%>` заменяются полным URL-адресом.

В итоге новые пользователи не утверждаются, то есть они не могут войти на сайт. Кроме того, они автоматически отправляют сообщение электронной почты со ссылкой на URL-адрес проверки (см. рис. 6).

[![новый пользователь получит сообщение электронной почты со ссылкой на URL-адрес проверки.](unlocking-and-approving-user-accounts-vb/_static/image17.png)](unlocking-and-approving-user-accounts-vb/_static/image16.png)

**Рис. 6**. новый пользователь получит сообщение электронной почты со ссылкой на URL-адрес проверки ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-vb/_static/image18.png)).

> [!NOTE]
> На шаге CreateUserWizard по умолчанию элемента управления CreateUserWizard отображается сообщение о том, что пользователь создал свою учетную запись и выводит кнопку продолжить. При выборе этого значения пользователь получает URL-адрес, указанный в свойстве `ContinueDestinationPageUrl` элемента управления. CreateUserWizard в `EnhancedCreateUserWizard.aspx` настроен на отправку новых пользователей в `~/Membership/AdditionalUserInfo.aspx`, предлагающий пользователю указать свое место проживания, URL-адрес домашней страницы и подпись. Поскольку эти сведения могут быть добавлены только пользователями, вошедшими в систему, имеет смысл обновить это свойство для отправки пользователей обратно на домашнюю страницу сайта (`~/Default.aspx`). Более того, страница `EnhancedCreateUserWizard.aspx` или шаг CreateUserWizard должны быть дополнены для информирования пользователя о том, что они отправляли проверочное сообщение, а их учетная запись не будет активирована, пока не следуйте инструкциям в этом сообщении. Я оставлю эти изменения в качестве упражнения для читателя.

### <a name="creating-the-verification-page"></a>Создание страницы проверки

Наша последняя задача — создать страницу `Verification.aspx`. Добавьте эту страницу в корневую папку, связав ее с главной страницей `Site.master`. Так как мы сделали большую часть предыдущих страниц содержимого, добавленных на сайт, удалите элемент управления содержимым, который ссылается на `LoginContent` ContentPlaceHolder, чтобы страница содержимого использовала содержимое по умолчанию главной страницы.

Добавьте веб-элемент управления Label на страницу `Verification.aspx`, задайте для его `ID` значение `StatusMessage` и удалите его свойство Text. Затем создайте обработчик событий `Page_Load` и добавьте следующий код:

[!code-vb[Main](unlocking-and-approving-user-accounts-vb/samples/sample5.vb)]

Основная часть приведенного выше кода проверяет, существует ли идентификатор пользователя, предоставляемый через QueryString, что он является допустимым `Guid` значением и ссылается на существующую учетную запись пользователя. Если все эти проверки пройдены, учетная запись пользователя утверждается; в противном случае отображается подходящее сообщение о состоянии.

На рис. 7 показана страница `Verification.aspx` при посещении через браузер.

[![учетная запись нового пользователя теперь утверждена](unlocking-and-approving-user-accounts-vb/_static/image20.png)](unlocking-and-approving-user-accounts-vb/_static/image19.png)

**Рис. 7**. Теперь учетная запись нового пользователя утверждена ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-vb/_static/image21.png))

## <a name="summary"></a>Сводка

Все учетные записи пользователей членства имеют два состояния, которые определяют, может ли пользователь войти на сайт: `IsLockedOut` и `IsApproved`. Оба эти свойства должны быть `True` для входа пользователя.

Состояние блокировки пользователя используется в качестве меры безопасности, чтобы снизить вероятность нарушения работы хакера на сайте с помощью методов подбора. В частности, пользователь блокируется при наличии определенного числа недопустимых попыток входа в систему в течение определенного периода времени. Эти границы можно настроить с помощью параметров поставщика членства в `Web.config`.

Утвержденное состояние обычно используется как средство, чтобы запретить новым пользователям входить в систему до тех пор, пока не будет выполнено какое-либо действие. Возможно, сайт требует, чтобы новые учетные записи были сначала утверждены администратором, или, как мы видели на шаге 3, проверив свой адрес электронной почты.

Поздравляем с программированием!

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — *[Sams обучать себя ASP.NET 2,0 за 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* . Скотт можно получить по адресу [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) или через свой блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность...

Эта серия руководств была рассмотрена многими полезными рецензентами. Хотите ознакомиться с моими будущими статьями MSDN? Если да, расположите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](recovering-and-changing-passwords-vb.md)
