---
uid: web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
title: Снятие блокировки и утверждение учетных записей пользователей (C#) | Документация Майкрософт
author: rick-anderson
description: Этом руководстве показано, как создавать веб-страницы управления для администраторов заблокирована и утверждены состояния пользователей. Мы также показано, как утвердить новый o пользователей...
ms.author: riande
ms.date: 04/01/2008
ms.assetid: 5346aab1-9974-489f-a065-ae3883b8a350
msc.legacyurl: /web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
msc.type: authoredcontent
ms.openlocfilehash: d4e8591f3090de8f931ffd8eb1dd0a1138674842
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59410049"
---
# <a name="unlocking-and-approving-user-accounts-c"></a><span data-ttu-id="455c3-104">Снятие блокировки и утверждение учетных записей пользователей (C#)</span><span class="sxs-lookup"><span data-stu-id="455c3-104">Unlocking and Approving User Accounts (C#)</span></span>

<span data-ttu-id="455c3-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="455c3-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="455c3-106">[Скачать код](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) или [скачать PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="455c3-106">[Download Code](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) or [Download PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span></span>

> <span data-ttu-id="455c3-107">Этом руководстве показано, как создавать веб-страницы управления для администраторов заблокирована и утверждены состояния пользователей.</span><span class="sxs-lookup"><span data-stu-id="455c3-107">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="455c3-108">Кроме того, мы увидим утверждение новых пользователей, только после проверки адреса электронной почты.</span><span class="sxs-lookup"><span data-stu-id="455c3-108">We will also see how to approve new users only after they have verified their email address.</span></span>


## <a name="introduction"></a><span data-ttu-id="455c3-109">Вступление</span><span class="sxs-lookup"><span data-stu-id="455c3-109">Introduction</span></span>

<span data-ttu-id="455c3-110">Наряду с пользователя, пароль и адрес электронной почты, каждая учетная запись пользователя имеет два поля состояния, которые определяют, может ли пользователь войти на сайт: заблокирована и утверждены.</span><span class="sxs-lookup"><span data-stu-id="455c3-110">Along with a username, password, and email, each user account has two status fields that dictate whether the user can log into the site: locked out and approved.</span></span> <span data-ttu-id="455c3-111">Пользователь блокируется автоматически, если они предоставляют недопустимых учетных данных указанное число раз в течение указанного числа минут (по умолчанию блокировать пользователя после 5 попыток недопустимое имя для входа в течение 10 минут).</span><span class="sxs-lookup"><span data-stu-id="455c3-111">A user is automatically locked out if they provide invalid credentials a specified number of times within a specified number of minutes (the default settings lock a user out after 5 invalid login attempts within 10 minutes).</span></span> <span data-ttu-id="455c3-112">Состояние утверждения полезен в сценариях, где должен пройти какое-либо действие, прежде чем пользователь сможет войти сайт.</span><span class="sxs-lookup"><span data-stu-id="455c3-112">The approved status is useful in scenarios where some action must transpire before a new user is able to log on to the site.</span></span> <span data-ttu-id="455c3-113">Например пользователь может потребоваться сначала проверьте свой адрес электронной почты или быть утвержден администратором, прежде чем он сможет входа.</span><span class="sxs-lookup"><span data-stu-id="455c3-113">For example, a user might need to first verify their email address or be approved by an administrator before being able to login.</span></span>

<span data-ttu-id="455c3-114">Так как заблокированный out или не утвержденные невозможно выполнить вход пользователя, он является единственным естественного гадать, как можно восстановить эти состояния.</span><span class="sxs-lookup"><span data-stu-id="455c3-114">Because a locked out or unapproved user cannot login, it's only natural to wonder how these statuses can be reset.</span></span> <span data-ttu-id="455c3-115">ASP.NET не содержит никакой встроенной функциональности, или веб-элементы управления для управления пользователей заблокирована и частично утверждено состояния, так как эти решения необходимо обрабатывать на основе узла.</span><span class="sxs-lookup"><span data-stu-id="455c3-115">ASP.NET does not include any built-in functionality or Web controls for managing users' locked out and approved statuses, in part because these decisions need to be handled on a site-by-site basis.</span></span> <span data-ttu-id="455c3-116">Некоторые узлы могут автоматически утвердить все новые учетные записи пользователей (поведение по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="455c3-116">Some sites might automatically approve all new user accounts (the default behavior).</span></span> <span data-ttu-id="455c3-117">Другие попросите администратора утвердить новые учетные записи или не утверждение пользователей, пока они посетите ссылки, отправленной по адресу электронной почты, указанному во время регистрации.</span><span class="sxs-lookup"><span data-stu-id="455c3-117">Others have an administrator approve new accounts or do not approve users until they visit a link sent to the email address provided when they signed up.</span></span> <span data-ttu-id="455c3-118">Аналогично некоторые узлы могут блокировать пользователей, пока администратор сбрасывает их состояние, то время как другие сайты отправлять сообщение электронной почты пользователю заблокированной URL-адрес, они могут посещать, чтобы разблокировать свою учетную запись.</span><span class="sxs-lookup"><span data-stu-id="455c3-118">Likewise, some sites may lock out users until an administrator resets their status, while other sites send an email to the locked out user with a URL they can visit to unlock their account.</span></span>

<span data-ttu-id="455c3-119">Этом руководстве показано, как создавать веб-страницы управления для администраторов заблокирована и утверждены состояния пользователей.</span><span class="sxs-lookup"><span data-stu-id="455c3-119">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="455c3-120">Кроме того, мы увидим утверждение новых пользователей, только после проверки адреса электронной почты.</span><span class="sxs-lookup"><span data-stu-id="455c3-120">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="step-1-managing-users-locked-out-and-approved-statuses"></a><span data-ttu-id="455c3-121">Шаг 1. Управление пользователями заблокирована и утверждены состояния</span><span class="sxs-lookup"><span data-stu-id="455c3-121">Step 1: Managing Users' Locked Out and Approved Statuses</span></span>

<span data-ttu-id="455c3-122">В <a id="Tutorial12"> </a> [ *Создание интерфейса для выбора одной учетной записи с помощью многих* ](building-an-interface-to-select-one-user-account-from-many-cs.md) руководстве, мы составили страницу, перечислявшую каждой учетной записи пользователя в разбитого на страницы, отфильтрованные GridView.</span><span class="sxs-lookup"><span data-stu-id="455c3-122">In the <a id="Tutorial12"></a>[*Building an Interface to Select One User Account from Many*](building-an-interface-to-select-one-user-account-from-many-cs.md) tutorial we constructed a page that listed each user account in a paged, filtered GridView.</span></span> <span data-ttu-id="455c3-123">В сетке приведен список имя каждого пользователя и адрес электронной почты, их состояние разрешенных и заблокированных out, находятся ли они в интерактивном режиме и комментарии о пользователе.</span><span class="sxs-lookup"><span data-stu-id="455c3-123">The grid lists each user's name and email, their approved and locked out statuses, whether they're currently online, and any comments about the user.</span></span> <span data-ttu-id="455c3-124">Для управления пользователями утверждения и заблокирована состояний, можно сделать эту сетку редактирования.</span><span class="sxs-lookup"><span data-stu-id="455c3-124">To manage users' approved and locked out statuses, we could make this grid editable.</span></span> <span data-ttu-id="455c3-125">Чтобы изменить состояние утверждения для пользователя, администратор будет сначала найдите учетную запись пользователя и затем измените соответствующую строку GridView, устанавливая или снимая флажок утвержденных.</span><span class="sxs-lookup"><span data-stu-id="455c3-125">To change a user's approved status, the administrator would first locate the user account and then edit the corresponding GridView row, checking or unchecking the approved checkbox.</span></span> <span data-ttu-id="455c3-126">Кроме того мы может управлять утвержденные, так и заблокированной состояния через отдельную страницу ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="455c3-126">Alternatively, we could manage the approved and locked out statuses through a separate ASP.NET page.</span></span>

<span data-ttu-id="455c3-127">В этом руководстве давайте используются две страницы ASP.NET: `ManageUsers.aspx` и `UserInformation.aspx`.</span><span class="sxs-lookup"><span data-stu-id="455c3-127">For this tutorial let's use two ASP.NET pages: `ManageUsers.aspx` and `UserInformation.aspx`.</span></span> <span data-ttu-id="455c3-128">В данном случае, `ManageUsers.aspx` перечислены учетные записи пользователей в системе, хотя `UserInformation.aspx` администратор может управлять утвержденные, так и заблокированной состояния для определенного пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-128">The idea here is that `ManageUsers.aspx` lists the user accounts in the system, while `UserInformation.aspx` enables the administrator to manage the approved and locked out statuses for a specific user.</span></span> <span data-ttu-id="455c3-129">Наши первым делом является дополнение элементов GridView в `ManageUsers.aspx` для включения поля HyperLinkField, который отображается в виде столбца ссылок.</span><span class="sxs-lookup"><span data-stu-id="455c3-129">Our first order of business is to augment the GridView in `ManageUsers.aspx` to include a HyperLinkField, which renders as a column of links.</span></span> <span data-ttu-id="455c3-130">Мы хотим каждой ссылки, чтобы они указывали `UserInformation.aspx?user=UserName`, где *UserName* — это имя пользователя для редактирования.</span><span class="sxs-lookup"><span data-stu-id="455c3-130">We want each link to point to `UserInformation.aspx?user=UserName`, where *UserName* is the name of the user to edit.</span></span>

> [!NOTE]
> <span data-ttu-id="455c3-131">Если вы загрузили код <a id="Tutorial13"> </a> [ *восстановление и изменение паролей* ](recovering-and-changing-passwords-cs.md) учебник, вы могли заметить, `ManageUsers.aspx` страница уже содержит набор " Управление» ссылки и `UserInformation.aspx` страница предоставляет интерфейс для изменения пароля выбранного пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-131">If you downloaded the code for the <a id="Tutorial13"></a>[*Recovering and Changing Passwords*](recovering-and-changing-passwords-cs.md) tutorial you may have noticed that the `ManageUsers.aspx` page already contains a set of "Manage" links and the `UserInformation.aspx` page provides an interface for changing the selected user's password.</span></span> <span data-ttu-id="455c3-132">Я решил не реплицировать эту функциональность в коде, связанные с этим руководством, так как это работало, обход API членства и операционной напрямую с базой данных SQL Server для изменения пароля пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-132">I decided not to replicate that functionality in the code associated with this tutorial because it worked by circumventing the Membership API and operating directly with the SQL Server database to change a user's password.</span></span> <span data-ttu-id="455c3-133">Это руководство начинается с нуля, используя `UserInformation.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="455c3-133">This tutorial starts from scratch with the `UserInformation.aspx` page.</span></span>


### <a name="adding-manage-links-to-theuseraccountsgridview"></a><span data-ttu-id="455c3-134">Добавление «Manage» ссылки на`UserAccounts`GridView</span><span class="sxs-lookup"><span data-stu-id="455c3-134">Adding "Manage" Links to the`UserAccounts`GridView</span></span>

<span data-ttu-id="455c3-135">Откройте `ManageUsers.aspx` странице и Добавление поля HyperLinkField к `UserAccounts` GridView.</span><span class="sxs-lookup"><span data-stu-id="455c3-135">Open the `ManageUsers.aspx` page and add a HyperLinkField to the `UserAccounts` GridView.</span></span> <span data-ttu-id="455c3-136">Установка для свойства `Text` свойства «Управление» и его `DataNavigateUrlFields` и `DataNavigateUrlFormatString` свойства `UserName` и «UserInformation.aspx?user={0}«, соответственно.</span><span class="sxs-lookup"><span data-stu-id="455c3-136">Set the HyperLinkField's `Text` property to "Manage" and its `DataNavigateUrlFields` and `DataNavigateUrlFormatString` properties to `UserName` and "UserInformation.aspx?user={0}", respectively.</span></span> <span data-ttu-id="455c3-137">Эти параметры позволяют настроить поле HyperLinkField таким образом, что все гиперссылки отображения текста «Manage», но каждая ссылка передается в соответствующий *UserName* значение в строку запроса.</span><span class="sxs-lookup"><span data-stu-id="455c3-137">These settings configure the HyperLinkField such that all of the hyperlinks display the text "Manage", but each link passes in the appropriate *UserName* value into the querystring.</span></span>

<span data-ttu-id="455c3-138">После добавления HyperLinkField к элементу GridView, Отвлекитесь и просмотрите `ManageUsers.aspx` страницы в обозревателе.</span><span class="sxs-lookup"><span data-stu-id="455c3-138">After adding the HyperLinkField to the GridView, take a moment to view the `ManageUsers.aspx` page through a browser.</span></span> <span data-ttu-id="455c3-139">Как показано на рис. 1, каждая строка GridView теперь включает ссылку «Управление».</span><span class="sxs-lookup"><span data-stu-id="455c3-139">As Figure 1 shows, each GridView row now includes a "Manage" link.</span></span> <span data-ttu-id="455c3-140">Указывает ссылку «Управление» для Брюс `UserInformation.aspx?user=Bruce`, тогда как ссылка «Управление» для Дейв указывает `UserInformation.aspx?user=Dave`.</span><span class="sxs-lookup"><span data-stu-id="455c3-140">The "Manage" link for Bruce points to `UserInformation.aspx?user=Bruce`, whereas the "Manage" link for Dave points to `UserInformation.aspx?user=Dave`.</span></span>


<span data-ttu-id="455c3-141">[![Добавляет поле HyperLinkField](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="455c3-141">[![The HyperLinkField Adds a](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span></span>

<span data-ttu-id="455c3-142">**Рис. 1**: Поле HyperLinkField добавляет ссылку «Управление» для каждой учетной записи пользователя ([Просмотр полноразмерного изображения](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="455c3-142">**Figure 1**: The HyperLinkField Adds a "Manage" Link for Each User Account  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span></span>


<span data-ttu-id="455c3-143">Мы создадим пользовательского интерфейса и кода для `UserInformation.aspx` странице в данный момент, но сначала давайте разговоров о как программными средствами изменить пользователя заблокирована и утверждены состояния.</span><span class="sxs-lookup"><span data-stu-id="455c3-143">We will create the user interface and code for the `UserInformation.aspx` page in a moment, but first let's talk about how to programmatically change a user's locked out and approved statuses.</span></span> <span data-ttu-id="455c3-144">[ `MembershipUser` Класс](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) имеет [ `IsLockedOut` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) и [ `IsApproved` свойства](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span><span class="sxs-lookup"><span data-stu-id="455c3-144">The [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) has [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) and [`IsApproved` properties](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span></span> <span data-ttu-id="455c3-145">`IsLockedOut` Свойство доступно только для чтения.</span><span class="sxs-lookup"><span data-stu-id="455c3-145">The `IsLockedOut` property is read-only.</span></span> <span data-ttu-id="455c3-146">Отсутствует механизм для программно блокировки записи пользователя; Чтобы разблокировать пользователя, используйте `MembershipUser` класса [ `UnlockUser` метод](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="455c3-146">There is no mechanism to programmatically lock out a user; to unlock a user, use the `MembershipUser` class's [`UnlockUser` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span> <span data-ttu-id="455c3-147">`IsApproved` Свойство для чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="455c3-147">The `IsApproved` property is readable and writeable.</span></span> <span data-ttu-id="455c3-148">Чтобы сохранить любые изменения этого свойства, необходимо вызвать `Membership` класса [ `UpdateUser` метод](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx), передав в измененной `MembershipUser` объекта.</span><span class="sxs-lookup"><span data-stu-id="455c3-148">To save any changes to this property, we need to call the `Membership` class's [`UpdateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx), passing in the modified `MembershipUser` object.</span></span>

<span data-ttu-id="455c3-149">Так как `IsApproved` свойство для чтения и записи, элемент управления CheckBox, вероятно, является лучшим элемент пользовательского интерфейса для настройки этого свойства.</span><span class="sxs-lookup"><span data-stu-id="455c3-149">Because the `IsApproved` property is readable and writeable, a CheckBox control is probably the best user interface element for configuring this property.</span></span> <span data-ttu-id="455c3-150">Тем не менее, флажок не будет работать для `IsLockedOut` свойство так, как администратор не может заблокировать пользователя, она может разблокировать только пользователь.</span><span class="sxs-lookup"><span data-stu-id="455c3-150">However, a CheckBox will not work for the `IsLockedOut` property because an administrator cannot lock out a user, she may only unlock a user.</span></span> <span data-ttu-id="455c3-151">Это подходящий пользовательский интерфейс для `IsLockedOut` свойство — это кнопка, щелчок снимает блокировку учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-151">A suitable user interface for the `IsLockedOut` property is a Button that, when clicked, unlocks the user account.</span></span> <span data-ttu-id="455c3-152">Эту кнопку следует включать только в том случае, если пользователь будет заблокирован.</span><span class="sxs-lookup"><span data-stu-id="455c3-152">This Button should only be enabled if the user is locked out.</span></span>

### <a name="creating-theuserinformationaspxpage"></a><span data-ttu-id="455c3-153">Создание`UserInformation.aspx`страницы</span><span class="sxs-lookup"><span data-stu-id="455c3-153">Creating the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="455c3-154">Теперь мы готовы реализовать пользовательский интерфейс в `UserInformation.aspx`.</span><span class="sxs-lookup"><span data-stu-id="455c3-154">We are now ready to implement the user interface in `UserInformation.aspx`.</span></span> <span data-ttu-id="455c3-155">Открыть эту страницу и добавьте следующие веб-элементов управления:</span><span class="sxs-lookup"><span data-stu-id="455c3-155">Open this page and add the following Web controls:</span></span>

- <span data-ttu-id="455c3-156">Элемент управления гиперссылки, при нажатии возвращает администратору `ManageUsers.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="455c3-156">A HyperLink control that, when clicked, returns the administrator to the `ManageUsers.aspx` page.</span></span>
- <span data-ttu-id="455c3-157">Метка веб-элемент управления для отображения имени выбранного пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-157">A Label Web control for displaying the selected user's name.</span></span> <span data-ttu-id="455c3-158">Задайте эту метку `ID` для `UserNameLabel` и очистите его `Text` свойство.</span><span class="sxs-lookup"><span data-stu-id="455c3-158">Set this Label's `ID` to `UserNameLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="455c3-159">Элемент управления CheckBox с именем `IsApproved`.</span><span class="sxs-lookup"><span data-stu-id="455c3-159">A CheckBox control named `IsApproved`.</span></span> <span data-ttu-id="455c3-160">Задайте его `AutoPostBack` свойства `true`.</span><span class="sxs-lookup"><span data-stu-id="455c3-160">Set its `AutoPostBack` property to `true`.</span></span>
- <span data-ttu-id="455c3-161">Элемент управления "Метка" для отображения пользователя последнего элемента заблокирована даты.</span><span class="sxs-lookup"><span data-stu-id="455c3-161">A Label control for displaying the user's last locked out date.</span></span> <span data-ttu-id="455c3-162">Назовите эту метку `LastLockedOutDateLabel` и очистите его `Text` свойство.</span><span class="sxs-lookup"><span data-stu-id="455c3-162">Name this Label `LastLockedOutDateLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="455c3-163">Кнопка для разблокировки пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-163">A Button for unlocking the user.</span></span> <span data-ttu-id="455c3-164">Имя этой кнопки `UnlockUserButton` и задайте его `Text` свойство «Разблокировать User».</span><span class="sxs-lookup"><span data-stu-id="455c3-164">Name this Button `UnlockUserButton` and set its `Text` property to "Unlock User".</span></span>
- <span data-ttu-id="455c3-165">Элемент управления Label, для отображения сообщений о состоянии, такие как «состояние утверждения пользователя был обновлен.»</span><span class="sxs-lookup"><span data-stu-id="455c3-165">A Label control for displaying status messages, such as, "The user's approved status has been updated."</span></span> <span data-ttu-id="455c3-166">Имя этого элемента управления `StatusMessage`снимите out его `Text` и установите его `CssClass` свойства `Important`.</span><span class="sxs-lookup"><span data-stu-id="455c3-166">Name this control `StatusMessage`, clear out its `Text` property, and set its `CssClass` property to `Important`.</span></span> <span data-ttu-id="455c3-167">( `Important` Класс CSS, определенные в `Styles.css` файла таблицы стилей; отображается соответствующий текст в большой красный шрифт.)</span><span class="sxs-lookup"><span data-stu-id="455c3-167">(The `Important` CSS class is defined in the `Styles.css` stylesheet file; it displays the corresponding text in a large, red font.)</span></span>

<span data-ttu-id="455c3-168">После добавления этих элементов управления, режиме конструктора в Visual Studio должен выглядеть на рисунке, на рис. 2.</span><span class="sxs-lookup"><span data-stu-id="455c3-168">After adding these controls, the Design view in Visual Studio should look similar to the screen shot in Figure 2.</span></span>


<span data-ttu-id="455c3-169">[![Создание пользовательского интерфейса для UserInformation.aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="455c3-169">[![Create the User Interface for UserInformation.aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span></span>

<span data-ttu-id="455c3-170">**Рис. 2**: Создание пользовательского интерфейса для `UserInformation.aspx` ([Просмотр полноразмерного изображения](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="455c3-170">**Figure 2**: Create the User Interface for `UserInformation.aspx` ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span></span>


<span data-ttu-id="455c3-171">Полный пользовательский интерфейс, DAL следующей задачей является установка `IsApproved` флажок и другие элементы управления на основе выбранного пользователя сведений.</span><span class="sxs-lookup"><span data-stu-id="455c3-171">With the user interface complete, our next task is to set the `IsApproved` CheckBox and other controls based on the selected user's information.</span></span> <span data-ttu-id="455c3-172">Создайте обработчик событий для страницы `Load` событий и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="455c3-172">Create an event handler for the page's `Load` event and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample1.cs)]

<span data-ttu-id="455c3-173">Приведенный выше код начинается с обеспечения, что это первом посещении страницы и не последующих обратную передачу.</span><span class="sxs-lookup"><span data-stu-id="455c3-173">The above code starts by ensuring that this is the first visit to the page and not a subsequent postback.</span></span> <span data-ttu-id="455c3-174">Затем считывает имя пользователя, переданное через `user` поля строки запроса и извлекает сведения об этой учетной записи пользователя с помощью `Membership.GetUser(username)` метод.</span><span class="sxs-lookup"><span data-stu-id="455c3-174">It then reads the username passed through the `user` querystring field and retrieves information about that user account via the `Membership.GetUser(username)` method.</span></span> <span data-ttu-id="455c3-175">Если нет имени пользователя предоставлен через строку запроса, или если не удалось найти указанного пользователя, администратору будет отправлено обратно `ManageUsers.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="455c3-175">If no username was supplied through the querystring, or if the specified user could not be found, the administrator is sent back to the `ManageUsers.aspx` page.</span></span>

<span data-ttu-id="455c3-176">`MembershipUser` Объекта `UserName` значение отображается в `UserNameLabel` и `IsApproved` флажок на основе `IsApproved` значение свойства.</span><span class="sxs-lookup"><span data-stu-id="455c3-176">The `MembershipUser` object's `UserName` value is then displayed in the `UserNameLabel` and the `IsApproved` CheckBox is checked based on the `IsApproved` property value.</span></span>

<span data-ttu-id="455c3-177">`MembershipUser` Объекта [ `LastLockoutDate` свойство](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) возвращает `DateTime` значение, указывающее, когда последний пользователь заблокирован. Если пользователь никогда не был заблокирован, возвращаемое значение зависит от поставщика членства.</span><span class="sxs-lookup"><span data-stu-id="455c3-177">The `MembershipUser` object's [`LastLockoutDate` property](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) returns a `DateTime` value indicating when the user was last locked out. If the user has never been locked out, the value returned depends on the Membership provider.</span></span> <span data-ttu-id="455c3-178">При создании новой учетной записи, `SqlMembershipProvider` задает `aspnet_Membership` таблицы `LastLockoutDate` поле `1754-01-01 12:00:00 AM`.</span><span class="sxs-lookup"><span data-stu-id="455c3-178">When a new account is created, the `SqlMembershipProvider` sets the `aspnet_Membership` table's `LastLockoutDate` field to `1754-01-01 12:00:00 AM`.</span></span> <span data-ttu-id="455c3-179">Приведенный выше код отображает пустую строку в `LastLockoutDateLabel` Если `LastLockoutDate` свойство предшествует год 2000, в противном случае — части даты `LastLockoutDate` свойство отображается в метке.</span><span class="sxs-lookup"><span data-stu-id="455c3-179">The above code displays an empty string in the `LastLockoutDateLabel` if the `LastLockoutDate` property occurs before year 2000; otherwise, the date portion of the `LastLockoutDate` property is displayed in the Label.</span></span> <span data-ttu-id="455c3-180">`UnlockUserButton'` s `Enabled` свойству пользователя заблокирована состояние, это означает, что эта кнопка будет включаться только если пользователь будет заблокирован.</span><span class="sxs-lookup"><span data-stu-id="455c3-180">The `UnlockUserButton'` s `Enabled` property is set to the user's locked out status, meaning that this Button will only be enabled if the user is locked out.</span></span>

<span data-ttu-id="455c3-181">Отвлекитесь и протестировать `UserInformation.aspx` страницы в обозревателе.</span><span class="sxs-lookup"><span data-stu-id="455c3-181">Take a moment to test the `UserInformation.aspx` page through a browser.</span></span> <span data-ttu-id="455c3-182">Само собой, необходимо начать с `ManageUsers.aspx` и выберите учетную запись пользователя для управления.</span><span class="sxs-lookup"><span data-stu-id="455c3-182">You will, of course, need to start at `ManageUsers.aspx` and select a user account to manage.</span></span> <span data-ttu-id="455c3-183">От поступающих `UserInformation.aspx`, обратите внимание, что `IsApproved` флажок проверяется только в том случае, если пользователь будет утвержден.</span><span class="sxs-lookup"><span data-stu-id="455c3-183">Upon arriving at `UserInformation.aspx`, note that the `IsApproved` CheckBox is only checked if the user is approved.</span></span> <span data-ttu-id="455c3-184">Если пользователь никогда не был заблокирован, отображается последней блокировки записи даты.</span><span class="sxs-lookup"><span data-stu-id="455c3-184">If the user has ever been locked out, their last locked out date is displayed.</span></span> <span data-ttu-id="455c3-185">Кнопка Разблокировать пользователя становится доступен только в том случае, если пользователь в данный момент заблокирована. Устанавливая или снимая `IsApproved` флажок или нажмите кнопку Разблокировать пользователя вызывает обратную передачу, но не было изменений учетной записи пользователя, так как еще не создавать обработчики событий для этих событий.</span><span class="sxs-lookup"><span data-stu-id="455c3-185">The Unlock User button is enabled only if the user is currently locked out. Checking or unchecking the `IsApproved` CheckBox or clicking the Unlock User button causes a postback, but no modifications are made to the user account because we've yet to create event handlers for these events.</span></span>

<span data-ttu-id="455c3-186">Вернитесь в Visual Studio и создавать обработчики событий для `IsApproved` элемента CheckBox `CheckedChanged` событий и `UnlockUser` кнопки `Click` событий.</span><span class="sxs-lookup"><span data-stu-id="455c3-186">Return to Visual Studio and create event handlers for the `IsApproved` CheckBox's `CheckedChanged` event and the `UnlockUser` Button's `Click` event.</span></span> <span data-ttu-id="455c3-187">В `CheckedChanged` обработчик событий, задайте пользователя `IsApproved` свойства `Checked` свойство элемента управления CheckBox, а затем сохранить изменения через вызов `Membership.UpdateUser`.</span><span class="sxs-lookup"><span data-stu-id="455c3-187">In the `CheckedChanged` event handler, set the user's `IsApproved` property to the `Checked` property of the CheckBox and then save the changes via a call to `Membership.UpdateUser`.</span></span> <span data-ttu-id="455c3-188">В `Click` обработчик событий, простым вызовом `MembershipUser` объекта `UnlockUser` метод.</span><span class="sxs-lookup"><span data-stu-id="455c3-188">In the `Click` event handler, simply call the `MembershipUser` object's `UnlockUser` method.</span></span> <span data-ttu-id="455c3-189">В обоих обработчиков событий, отобразить соответствующее сообщение в `StatusMessage` метки.</span><span class="sxs-lookup"><span data-stu-id="455c3-189">In both event handlers, display a suitable message in the `StatusMessage` Label.</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample2.cs)]

### <a name="testing-theuserinformationaspxpage"></a><span data-ttu-id="455c3-190">Тестирование`UserInformation.aspx`страницы</span><span class="sxs-lookup"><span data-stu-id="455c3-190">Testing the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="455c3-191">В этих обработчиках событий в месте, вернемся к странице и «не утверждено» пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-191">With these event handlers in place, revisit the page and unapproved a user.</span></span> <span data-ttu-id="455c3-192">Как показано на рис. 3, вы должны увидеть краткое сообщение на странице, означает, что пользователя `IsApproved` свойство изменена успешно.</span><span class="sxs-lookup"><span data-stu-id="455c3-192">As Figure 3 shows, you should see a brief message on the page indicating that the user's `IsApproved` property was successfully modified.</span></span>


<span data-ttu-id="455c3-193">[![Крис был не утверждено](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="455c3-193">[![Chris has been Unapproved](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span></span>

<span data-ttu-id="455c3-194">**Рис. 3**: Крис был не утверждено ([Просмотр полноразмерного изображения](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="455c3-194">**Figure 3**: Chris has been Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span></span>


<span data-ttu-id="455c3-195">Далее выхода из системы и попробуйте войти в систему как пользователь, учетная запись которого было просто «не утверждено».</span><span class="sxs-lookup"><span data-stu-id="455c3-195">Next, logout and try to login as the user whose account was just unapproved.</span></span> <span data-ttu-id="455c3-196">Так как пользователь не утвержден, они не может выполнить вход.</span><span class="sxs-lookup"><span data-stu-id="455c3-196">Because the user is not approved, they cannot login.</span></span> <span data-ttu-id="455c3-197">По умолчанию элемент управления Login отображает то же сообщение, если пользователь не может выполнить вход, независимо от причины.</span><span class="sxs-lookup"><span data-stu-id="455c3-197">By default, the Login control displays the same message if the user cannot login, regardless of the reason.</span></span> <span data-ttu-id="455c3-198">Однако в <a id="Tutorial6"> </a> [ *проверка пользователя учетные данные от членства пользователя Store* ](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) учебном курсе было рассмаотрено улучшения элемента управления Login для отображения более подходящим сообщения.</span><span class="sxs-lookup"><span data-stu-id="455c3-198">But in the <a id="Tutorial6"></a>[*Validating User Credentials Against the Membership User Store*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) tutorial we looked at enhancing the Login control to display a more appropriate message.</span></span> <span data-ttu-id="455c3-199">Как показано на рис. 4, Крис отображается сообщение о том, что он не может выполнить вход, так как его учетная запись еще не утверждено.</span><span class="sxs-lookup"><span data-stu-id="455c3-199">As Figure 4 shows, Chris is shown a message explaining that he cannot login because his account is not yet approved.</span></span>


<span data-ttu-id="455c3-200">[![Крис невозможно из-за His является учетная запись входа не утверждено](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="455c3-200">[![Chris Cannot Login Because His Account is Unapproved](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span></span>

<span data-ttu-id="455c3-201">**Рис. 4**: Крис невозможно из-за His является учетная запись входа не утверждено ([Просмотр полноразмерного изображения](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="455c3-201">**Figure 4**: Chris Cannot Login Because His Account is Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span></span>


<span data-ttu-id="455c3-202">Для тестирования функциональности заблокированной пытаются войти в систему как пользователь с правами утвержденных, но использовать неправильный пароль.</span><span class="sxs-lookup"><span data-stu-id="455c3-202">To test the locked out functionality, attempt to login as an approved user, but use an incorrect password.</span></span> <span data-ttu-id="455c3-203">Повторите эту процедуру необходимое количество раз, пока учетная запись пользователя заблокирована. Элемент управления Login также был изменен для отображения пользовательского сообщения, если попытка входа с помощью заблокированной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="455c3-203">Repeat this process the necessary number of times until the user's account has been locked out. The Login control was also updated to show a custom message if attempting to login from a locked out account.</span></span> <span data-ttu-id="455c3-204">Вы знаете, что учетная запись была заблокирована как только вы начнете видеть следующее сообщение на страницу входа: «Ваша учетная запись была заблокирована из-за слишком много попыток входа.</span><span class="sxs-lookup"><span data-stu-id="455c3-204">You know that an account has been locked out once you start seeing the following message at the login page: "Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="455c3-205">Обратитесь к администратору, чтобы учетная запись разблокирована.»</span><span class="sxs-lookup"><span data-stu-id="455c3-205">Please contact the administrator to have your account unlocked."</span></span>

<span data-ttu-id="455c3-206">Вернитесь к `ManageUsers.aspx` странице и щелкните ссылку "Управление" для заблокированной пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-206">Return to the `ManageUsers.aspx` page and click the Manage link for the locked out user.</span></span> <span data-ttu-id="455c3-207">Как показано на рис. 5, вы должны увидеть значение в `LastLockedOutDateLabel` кнопки разблокировать пользователя должен быть включен.</span><span class="sxs-lookup"><span data-stu-id="455c3-207">As Figure 5 shows, you should see a value in the `LastLockedOutDateLabel` the Unlock User button should be enabled.</span></span> <span data-ttu-id="455c3-208">Нажмите кнопку Разблокировать пользователя, чтобы разблокировать учетную запись пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-208">Click the Unlock User button to unlock the user account.</span></span> <span data-ttu-id="455c3-209">После разблокирования пользователя, они смогут войти в систему.</span><span class="sxs-lookup"><span data-stu-id="455c3-209">Once you have unlocked the user, they will be able to login again.</span></span>


<span data-ttu-id="455c3-210">[![Дейв блокирована система](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="455c3-210">[![Dave Has Been Locked Out of the System](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span></span>

<span data-ttu-id="455c3-211">**Рис. 5**: Дейв имеет были заблокированы из системы ([Просмотр полноразмерного изображения](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="455c3-211">**Figure 5**: Dave Has Been Locked Out of the System  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span></span>


## <a name="step-2-specifying-new-users-approved-status"></a><span data-ttu-id="455c3-212">Шаг 2. Указание новых пользователей состояние "Утверждено"</span><span class="sxs-lookup"><span data-stu-id="455c3-212">Step 2: Specifying New Users' Approved Status</span></span>

<span data-ttu-id="455c3-213">Состояние утверждения полезно в сценариях, где нужно некоторые действия должны быть выполнены до новый пользователь не сможет войти в систему и доступа к функциям конкретного пользователя узла.</span><span class="sxs-lookup"><span data-stu-id="455c3-213">The approved status is useful in scenarios where you want some action to be performed before a new user is able to login and access the user-specific features of the site.</span></span> <span data-ttu-id="455c3-214">Например может выполняться закрытый веб-сайта, где все страницы, за исключением страниц входа и регистрации, доступны только пользователям, прошедшим проверку.</span><span class="sxs-lookup"><span data-stu-id="455c3-214">For example, you may be running a private website where all pages, except for the login and signup pages, are accessible only to authenticated users.</span></span> <span data-ttu-id="455c3-215">Но что произойдет, если веб-сайта, достигает незнакомого обнаруживает на страницу регистрации и создает учетную запись?</span><span class="sxs-lookup"><span data-stu-id="455c3-215">But what happens if a stranger reaches your website, finds the signup page, and creates an account?</span></span> <span data-ttu-id="455c3-216">Чтобы предотвратить возникновение этой ситуации вы можете перейти на страницу регистрации для `Administration` папки и вручную создать каждой учетной записи администратора.</span><span class="sxs-lookup"><span data-stu-id="455c3-216">To prevent this from happening you could move the signup page to an `Administration` folder, and require that an administrator manually create each account.</span></span> <span data-ttu-id="455c3-217">Кроме того вы сможет любой желающий для регистрации, но запретить доступ к сайтам, до администратора учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-217">Alternatively, you could allow anyone to signup, but prohibit site access until an administrator approves the user account.</span></span>

<span data-ttu-id="455c3-218">По умолчанию элемент управления CreateUserWizard утверждает новые учетные записи.</span><span class="sxs-lookup"><span data-stu-id="455c3-218">By default, the CreateUserWizard control approves new accounts.</span></span> <span data-ttu-id="455c3-219">Можно настроить это поведение с помощью элемента управления [ `DisableCreatedUser` свойство](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx).</span><span class="sxs-lookup"><span data-stu-id="455c3-219">You can configure this behavior using the control's [`DisableCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx).</span></span> <span data-ttu-id="455c3-220">Присвойте этому свойству значение `true` не утверждение новых учетных записей пользователей.</span><span class="sxs-lookup"><span data-stu-id="455c3-220">Set this property to `true` to not approve new user accounts.</span></span>

> [!NOTE]
> <span data-ttu-id="455c3-221">По умолчанию элемент управления CreateUserWizard автоматический вход в систему новой учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-221">By default the CreateUserWizard control automatically logs on the new user account.</span></span> <span data-ttu-id="455c3-222">Это поведение зависит от элемента управления [ `LoginCreatedUser` свойство](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).</span><span class="sxs-lookup"><span data-stu-id="455c3-222">This behavior is dictated by the control's [`LoginCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).</span></span> <span data-ttu-id="455c3-223">Так как «не утверждено» пользователи не могут входить на сайт, когда `DisableCreatedUser` является `true` новой учетной записи пользователя не выполнил вход в узел, независимо от значения `LoginCreatedUser` свойство.</span><span class="sxs-lookup"><span data-stu-id="455c3-223">Because unapproved users cannot login to the site, when `DisableCreatedUser` is `true` the new user account is not logged into the site, regardless of the value of the `LoginCreatedUser` property.</span></span>


<span data-ttu-id="455c3-224">Программным образом при создании новых учетных записей пользователей с помощью `Membership.CreateUser` метода, чтобы создать учетную запись пользователя «не утверждено» используйте одну из перегрузок, принимающих новый пользователь `IsApproved` значением свойства в качестве входного параметра.</span><span class="sxs-lookup"><span data-stu-id="455c3-224">If you are programmatically creating new user accounts via the `Membership.CreateUser` method, to create an unapproved user account use one of the overloads that accept the new user's `IsApproved` property value as an input parameter.</span></span>

## <a name="step-3-approving-users-by-verifying-their-email-address"></a><span data-ttu-id="455c3-225">Шаг 3. Утверждения пользователей путем проверки адреса электронной почты</span><span class="sxs-lookup"><span data-stu-id="455c3-225">Step 3: Approving Users By Verifying their Email Address</span></span>

<span data-ttu-id="455c3-226">Многие веб-сайты, которые поддерживают учетные записи пользователей не утверждает новых пользователей, пока они подтвердить адрес электронной почты, которые они использовали при регистрации.</span><span class="sxs-lookup"><span data-stu-id="455c3-226">Many websites that support user accounts do not approve new users until they verify the email address they supplied when registering.</span></span> <span data-ttu-id="455c3-227">Процесс проверки обычно используется для атак программ-роботов, отправители нежелательной почты и других несознательные, так как он требуется адрес электронной почты уникальным, проверенных и добавляет дополнительный этап в процессе регистрации.</span><span class="sxs-lookup"><span data-stu-id="455c3-227">This verification process is commonly used to thwart bots, spammers, and other ne'er-do-wells as it requires a unique, verified email address and adds an extra step in the signup process.</span></span> <span data-ttu-id="455c3-228">В этой модели при регистрации нового пользователя они отправляются сообщения электронной почты со ссылкой на страницу проверки.</span><span class="sxs-lookup"><span data-stu-id="455c3-228">With this model, when a new user signs up they are sent an email message that includes a link to a verification page.</span></span> <span data-ttu-id="455c3-229">Открыв ссылку пользователь оказалось, что они получил сообщение электронной почты и, таким образом, что адрес электронной почты, предоставляемые является допустимым.</span><span class="sxs-lookup"><span data-stu-id="455c3-229">By visiting the link the user has proven that they received the email and, therefore, that the email address provided is valid.</span></span> <span data-ttu-id="455c3-230">На страницу проверки отвечает за утверждение пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-230">The verification page is responsible for approving the user.</span></span> <span data-ttu-id="455c3-231">Это может произойти автоматически, тем самым утверждение любой пользователь, который достигает этой странице, или только после пользователь предоставляет некоторые дополнительные сведения, такие как [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span><span class="sxs-lookup"><span data-stu-id="455c3-231">This may happen automatically, thereby approving any user who reaches this page, or only after the user provides some additional information, such as a [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span></span>

<span data-ttu-id="455c3-232">Чтобы адаптировать этот рабочий процесс, необходимо сначала обновить страницу создания учетной записи, таким образом, чтобы новые пользователи не одобрены.</span><span class="sxs-lookup"><span data-stu-id="455c3-232">To accommodate this workflow, we need to first update the account creation page so that new users are unapproved.</span></span> <span data-ttu-id="455c3-233">Откройте `EnhancedCreateUserWizard.aspx` странице в `Membership` папку и набора элемент управления CreateUserWizard `DisableCreatedUser` свойства `true`.</span><span class="sxs-lookup"><span data-stu-id="455c3-233">Open the `EnhancedCreateUserWizard.aspx` page in the `Membership` folder and set the CreateUserWizard control's `DisableCreatedUser` property to `true`.</span></span>

<span data-ttu-id="455c3-234">Далее нам нужно настроить элемент управления CreateUserWizard отправить сообщение электронной почты для нового пользователя с инструкциями по проверке учетной записи.</span><span class="sxs-lookup"><span data-stu-id="455c3-234">Next, we need to configure the CreateUserWizard control to send an email to the new user with instructions on how to verify their account.</span></span> <span data-ttu-id="455c3-235">В частности, будет включать ссылку в сообщении, чтобы `Verification.aspx` страницы (который еще не создать), передав новый пользователь `UserId` через строку запроса.</span><span class="sxs-lookup"><span data-stu-id="455c3-235">In particular, we will include a link in the email to the `Verification.aspx` page (which we've yet to create), passing in the new user's `UserId` through the querystring.</span></span> <span data-ttu-id="455c3-236">`Verification.aspx` Страница будет найти указанного пользователя и отметьте их утверждения.</span><span class="sxs-lookup"><span data-stu-id="455c3-236">The `Verification.aspx` page will lookup the specified user and mark them approved.</span></span>

### <a name="sending-a-verification-email-to-new-users"></a><span data-ttu-id="455c3-237">Отправка проверочное сообщение электронной почты для новых пользователей</span><span class="sxs-lookup"><span data-stu-id="455c3-237">Sending a Verification Email to New Users</span></span>

<span data-ttu-id="455c3-238">Чтобы отправить сообщение электронной почты из элемента управления CreateUserWizard, настройте его `MailDefinition` свойство соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="455c3-238">To send an email from the CreateUserWizard control, configure its `MailDefinition` property appropriately.</span></span> <span data-ttu-id="455c3-239">Как уже говорилось в <a id="Tutorial13"> </a> [предыдущем учебном курсе](recovering-and-changing-passwords-cs.md), элементы управления ChangePassword и PasswordRecovery включают [ `MailDefinition` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) , работает так же, как CreateUserWizard элемента управления.</span><span class="sxs-lookup"><span data-stu-id="455c3-239">As discussed in the <a id="Tutorial13"></a>[previous tutorial](recovering-and-changing-passwords-cs.md), the ChangePassword and PasswordRecovery controls include a [`MailDefinition` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) that works in the same manner as the CreateUserWizard control's.</span></span>

> [!NOTE]
> <span data-ttu-id="455c3-240">Чтобы использовать `MailDefinition` свойства, необходимо указать доставки почты параметры в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="455c3-240">To use the `MailDefinition` property you need to specify mail delivery options in `Web.config`.</span></span> <span data-ttu-id="455c3-241">Дополнительные сведения см. [отправки электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span><span class="sxs-lookup"><span data-stu-id="455c3-241">For more information, refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span></span>


<span data-ttu-id="455c3-242">Начните с создания нового шаблона сообщения электронной почты с именем `CreateUserWizard.txt` в `EmailTemplates` папку.</span><span class="sxs-lookup"><span data-stu-id="455c3-242">Start by creating a new email template named `CreateUserWizard.txt` in the `EmailTemplates` folder.</span></span> <span data-ttu-id="455c3-243">Для шаблона, используйте следующий текст:</span><span class="sxs-lookup"><span data-stu-id="455c3-243">Use the following text for the template:</span></span>

[!code-aspx[Main](unlocking-and-approving-user-accounts-cs/samples/sample3.aspx)]

<span data-ttu-id="455c3-244">Задайте `MailDefinition'` s `BodyFileName` свойства «~ / EmailTemplates/CreateUserWizard.txt» и его `Subject` свойства «вас приветствует веб-узла!</span><span class="sxs-lookup"><span data-stu-id="455c3-244">Set the `MailDefinition'` s `BodyFileName` property to "~/EmailTemplates/CreateUserWizard.txt" and its `Subject` property to "Welcome to My Website!</span></span> <span data-ttu-id="455c3-245">При активации учетной записи.»</span><span class="sxs-lookup"><span data-stu-id="455c3-245">Please activate your account."</span></span>

<span data-ttu-id="455c3-246">Обратите внимание, что `CreateUserWizard.txt` включает в себя шаблон сообщения электронной почты `<%VerificationUrl%>` заполнителя.</span><span class="sxs-lookup"><span data-stu-id="455c3-246">Note that the `CreateUserWizard.txt` email template includes a `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="455c3-247">Именно для этого URL-адрес `Verification.aspx` страницы будут помещены.</span><span class="sxs-lookup"><span data-stu-id="455c3-247">This is where the URL for the `Verification.aspx` page will be placed.</span></span> <span data-ttu-id="455c3-248">CreateUserWizard автоматически заменяет `<%UserName%>` и `<%Password%>` заполнители с новой учетной записи пользователя и пароля, но отсутствует встроенный `<%VerificationUrl%>` заполнителя.</span><span class="sxs-lookup"><span data-stu-id="455c3-248">The CreateUserWizard automatically replaces the `<%UserName%>` and `<%Password%>` placeholders with the new account's username and password, but there is no built-in `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="455c3-249">Необходимо вручную заменить его URL-адрес соответствующего проверки.</span><span class="sxs-lookup"><span data-stu-id="455c3-249">We need to manually replace it with the appropriate verification URL.</span></span>

<span data-ttu-id="455c3-250">Для этого необходимо создать обработчик событий для CreateUserWizard [ `SendingMail` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="455c3-250">To accomplish this, create an event handler for the CreateUserWizard's [`SendingMail` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample4.cs)]

<span data-ttu-id="455c3-251">`SendingMail` Событие срабатывает после `CreatedUser` события, это означает, что к моменту выше обработчик событий выполняет нового пользователя учетная запись уже создана.</span><span class="sxs-lookup"><span data-stu-id="455c3-251">The `SendingMail` event fires after the `CreatedUser` event, meaning that by the time the above event handler executes the new user account has already been created.</span></span> <span data-ttu-id="455c3-252">Можно обратиться к имени нового пользователя `UserId` значение путем вызова метода `Membership.GetUser` метод, передавая `UserName` введенные в элементе управления CreateUserWizard.</span><span class="sxs-lookup"><span data-stu-id="455c3-252">We can access the new user's `UserId` value by calling the `Membership.GetUser` method, passing in the `UserName` entered into the CreateUserWizard control.</span></span> <span data-ttu-id="455c3-253">Затем формируется URL-адрес проверки.</span><span class="sxs-lookup"><span data-stu-id="455c3-253">Next, the verification URL is formed.</span></span> <span data-ttu-id="455c3-254">Инструкция `Request.Url.GetLeftPart(UriPartial.Authority)` возвращает `http://yourserver.com` часть URL-адрес; `Request.ApplicationPath` возвращает путь, где к корневому каталогу приложения.</span><span class="sxs-lookup"><span data-stu-id="455c3-254">The statement `Request.Url.GetLeftPart(UriPartial.Authority)` returns the `http://yourserver.com` portion of the URL; `Request.ApplicationPath` returns path where the application is rooted.</span></span> <span data-ttu-id="455c3-255">Проверка URL-адрес затем определяется как `Verification.aspx?ID=userId`.</span><span class="sxs-lookup"><span data-stu-id="455c3-255">The verification URL is then defined as `Verification.aspx?ID=userId`.</span></span> <span data-ttu-id="455c3-256">Две эти строки затем объединяются для формирования полного URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="455c3-256">These two strings are then concatenated to form the complete URL.</span></span> <span data-ttu-id="455c3-257">Наконец, тело сообщения электронной почты (`e.Message.Body`) имеет все вхождения `<%VerificationUrl%>` заменены полный URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="455c3-257">Finally, the email message body (`e.Message.Body`) has all occurrences of `<%VerificationUrl%>` replaced with the full URL.</span></span>

<span data-ttu-id="455c3-258">В итоге получается, что новые пользователи не одобрены, это означает, что они не могут войти на сайт.</span><span class="sxs-lookup"><span data-stu-id="455c3-258">The net effect is that new users are unapproved, meaning that they cannot log into the site.</span></span> <span data-ttu-id="455c3-259">Кроме того, они автоматически отправляются сообщения электронной почты со ссылкой на URL-адрес проверки (см. рис. 6).</span><span class="sxs-lookup"><span data-stu-id="455c3-259">Furthermore, they are automatically sent an email with a link to the verification URL (see Figure 6).</span></span>


<span data-ttu-id="455c3-260">[![Новый пользователь получает сообщение электронной почты со ссылкой на URL-адрес проверки](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="455c3-260">[![The New User Receives an Email with a Link to the Verification URL](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span></span>

<span data-ttu-id="455c3-261">**Рис. 6**: Новый пользователь получает сообщение электронной почты со ссылкой на URL-адрес проверки ([Просмотр полноразмерного изображения](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="455c3-261">**Figure 6**: The New User Receives an Email with a Link to the Verification URL  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span></span>


> [!NOTE]
> <span data-ttu-id="455c3-262">Элемент управления CreateUserWizard по умолчанию CreateUserWizard шаг выводит сообщение, информирующее пользователя своей учетной записью, будет создана и отображает кнопки "Продолжить".</span><span class="sxs-lookup"><span data-stu-id="455c3-262">The CreateUserWizard control's default CreateUserWizard step displays a message informing the user their account has been created and displays a Continue button.</span></span> <span data-ttu-id="455c3-263">При нажатии этой кнопки перенаправит пользователя на указанный URL-адрес элемента управления `ContinueDestinationPageUrl` свойство.</span><span class="sxs-lookup"><span data-stu-id="455c3-263">Clicking this takes the user to the URL specified by the control's `ContinueDestinationPageUrl` property.</span></span> <span data-ttu-id="455c3-264">CreateUserWizard в `EnhancedCreateUserWizard.aspx` будет настроен для отправки новых пользователей к `~/Membership/AdditionalUserInfo.aspx`, который запрашивает у пользователя их проживания, URL-адрес домашней страницы и подпись.</span><span class="sxs-lookup"><span data-stu-id="455c3-264">The CreateUserWizard in `EnhancedCreateUserWizard.aspx` is configured to send new users to the `~/Membership/AdditionalUserInfo.aspx`, which prompts the user for their hometown, homepage URL, and signature.</span></span> <span data-ttu-id="455c3-265">Так как эти сведения могут добавляться только по системе работают пользователи, имеет смысл обновить это свойство для обратной отправки пользователям домашнюю страницу сайта (`~/Default.aspx`).</span><span class="sxs-lookup"><span data-stu-id="455c3-265">Because this information can only be added by logged on users, it makes sense to update this property to send users back to the site's homepage (`~/Default.aspx`).</span></span> <span data-ttu-id="455c3-266">Кроме того `EnhancedCreateUserWizard.aspx` страницу или на шаге CreateUserWizard следует дополнять информировать пользователей о том, что они были отправлены проверочное сообщение электронной почты и учетной записи не активируются до их следуйте инструкциям в этом сообщении электронной почты.</span><span class="sxs-lookup"><span data-stu-id="455c3-266">Moreover, the `EnhancedCreateUserWizard.aspx` page or the CreateUserWizard step should be augmented to inform the user that they have been sent a verification email and their account won't be activated until they follow the instructions in this email.</span></span> <span data-ttu-id="455c3-267">Я оставьте эти изменения в качестве упражнения для чтения.</span><span class="sxs-lookup"><span data-stu-id="455c3-267">I leave these modifications as an exercise for the reader.</span></span>


### <a name="creating-the-verification-page"></a><span data-ttu-id="455c3-268">Создание страницы проверки</span><span class="sxs-lookup"><span data-stu-id="455c3-268">Creating the Verification Page</span></span>

<span data-ttu-id="455c3-269">Наша последняя задача — создать `Verification.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="455c3-269">Our final task is to create the `Verification.aspx` page.</span></span> <span data-ttu-id="455c3-270">Добавьте эту страницу в корневую папку, сопоставляя его с `Site.master` главной страницы.</span><span class="sxs-lookup"><span data-stu-id="455c3-270">Add this page to the root folder, associating it with the `Site.master` master page.</span></span> <span data-ttu-id="455c3-271">Как мы делали с большинством из предыдущих страниц содержимого, добавляются к сайту, удалите элемент управления содержимым, который ссылается на `LoginContent` ContentPlaceHolder таким образом, страницы содержимого использовал главной страницы по умолчанию содержимого.</span><span class="sxs-lookup"><span data-stu-id="455c3-271">As we've done with most of the previous content pages added to the site, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the content page uses the master page's default content.</span></span>

<span data-ttu-id="455c3-272">Добавьте элемент управления Label Web для `Verification.aspx` задайте его `ID` для `StatusMessage` и очистите его свойства text.</span><span class="sxs-lookup"><span data-stu-id="455c3-272">Add a Label Web control to the `Verification.aspx` page, set its `ID` to `StatusMessage` and clear out its text property.</span></span> <span data-ttu-id="455c3-273">Создайте `Page_Load` обработчик событий и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="455c3-273">Next, create the `Page_Load` event handler and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample5.cs)]

<span data-ttu-id="455c3-274">Основная часть приведенный выше код проверяет, что `UserId` предоставленного через строку запроса существует, что это допустимый `Guid` значение, и что он ссылается на существующую учетную запись пользователя.</span><span class="sxs-lookup"><span data-stu-id="455c3-274">The bulk of the above code verifies that the `UserId` supplied through the querystring exists, that it is a valid `Guid` value, and that it references an existing user account.</span></span> <span data-ttu-id="455c3-275">Если все эти проверки, утверждения учетной записи пользователя; в противном случае отображается сообщение о состоянии подходящий.</span><span class="sxs-lookup"><span data-stu-id="455c3-275">If all of these checks pass, the user account is approved; otherwise, a suitable status message is displayed.</span></span>

<span data-ttu-id="455c3-276">Рис. 7 показан `Verification.aspx` странице при посещении через браузер.</span><span class="sxs-lookup"><span data-stu-id="455c3-276">Figure 7 shows the `Verification.aspx` page when visited through a browser.</span></span>


<span data-ttu-id="455c3-277">[![Учетная запись нового пользователя — теперь утверждено](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="455c3-277">[![The New User's Account is Now Approved](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span></span>

<span data-ttu-id="455c3-278">**Рис. 7**: Учетная запись нового пользователя — теперь утверждения ([Просмотр полноразмерного изображения](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="455c3-278">**Figure 7**: The New User's Account is Now Approved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span></span>


## <a name="summary"></a><span data-ttu-id="455c3-279">Сводка</span><span class="sxs-lookup"><span data-stu-id="455c3-279">Summary</span></span>

<span data-ttu-id="455c3-280">Все учетные записи пользователей членства имеют два состояния, которые определяют, может ли пользователь войти на сайт: `IsLockedOut` и `IsApproved`.</span><span class="sxs-lookup"><span data-stu-id="455c3-280">All Membership user accounts have two statuses that determine whether the user can log into the site: `IsLockedOut` and `IsApproved`.</span></span> <span data-ttu-id="455c3-281">Оба эти свойства должны быть `true` для пользователя с именем входа.</span><span class="sxs-lookup"><span data-stu-id="455c3-281">Both of these properties must be `true` for the user to login.</span></span>

<span data-ttu-id="455c3-282">Пользователь заблокирован состояния используется в качестве меры безопасности для уменьшения вероятности разбиение на сайт через методы подбора злоумышленник.</span><span class="sxs-lookup"><span data-stu-id="455c3-282">The user's locked out status is used as a security measure to reduce the likelihood of a hacker breaking into a site through brute force methods.</span></span> <span data-ttu-id="455c3-283">В частности, пользователь будет заблокирован при наличии определенного числа попыток недопустимое имя для входа в пределах определенного периода времени.</span><span class="sxs-lookup"><span data-stu-id="455c3-283">Specifically, a user is locked out if there are a certain number of invalid login attempts within a certain window of time.</span></span> <span data-ttu-id="455c3-284">Эти границы, можно настроить параметры поставщика членства в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="455c3-284">These bounds are configurable through the Membership provider settings in `Web.config`.</span></span>

<span data-ttu-id="455c3-285">Утвержденного статуса обычно используется как средство, чтобы запретить новым пользователям войти в систему, пока не задан какое-либо действие.</span><span class="sxs-lookup"><span data-stu-id="455c3-285">The approved status is commonly used as a means to prohibit new users from logging in until some action has transpired.</span></span> <span data-ttu-id="455c3-286">Возможно веб-узел требует, что новые учетные записи обязательности утверждения администратором или, как мы видели в шаге 3, путем проверки адреса электронной почты.</span><span class="sxs-lookup"><span data-stu-id="455c3-286">Perhaps the site requires that new accounts first be approved by the administrator or, as we saw in Step 3, by verifying their email address.</span></span>

<span data-ttu-id="455c3-287">Счастливого вам программирования!</span><span class="sxs-lookup"><span data-stu-id="455c3-287">Happy Programming!</span></span>

### <a name="about-the-author"></a><span data-ttu-id="455c3-288">Об авторе</span><span class="sxs-lookup"><span data-stu-id="455c3-288">About the Author</span></span>

<span data-ttu-id="455c3-289">Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года.</span><span class="sxs-lookup"><span data-stu-id="455c3-289">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="455c3-290">Скотт — независимый консультант, преподаватель и автор.</span><span class="sxs-lookup"><span data-stu-id="455c3-290">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="455c3-291">Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span><span class="sxs-lookup"><span data-stu-id="455c3-291">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="455c3-292">Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).</span><span class="sxs-lookup"><span data-stu-id="455c3-292">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="455c3-293">Особая благодарность</span><span class="sxs-lookup"><span data-stu-id="455c3-293">Special Thanks To…</span></span>

<span data-ttu-id="455c3-294">В этой серии руководств пособий рецензировалась многими компетентными редакторами.</span><span class="sxs-lookup"><span data-stu-id="455c3-294">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="455c3-295">Хотите поработать с моих последующих статей для MSDN?</span><span class="sxs-lookup"><span data-stu-id="455c3-295">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="455c3-296">Если Да, напишите мне [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="455c3-296">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="455c3-297">[Назад](recovering-and-changing-passwords-cs.md)
> [Вперед](building-an-interface-to-select-one-user-account-from-many-vb.md)</span><span class="sxs-lookup"><span data-stu-id="455c3-297">[Previous](recovering-and-changing-passwords-cs.md)
[Next](building-an-interface-to-select-one-user-account-from-many-vb.md)</span></span>
