---
uid: web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
title: Разблокировка и утверждение учетных записей пользователей (C#) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве показано, как создать веб-страницу для администраторов, чтобы управлять заблокированными и утвержденными состояниями пользователей. Мы также посмотрим, как утвердить новых пользователей...
ms.author: riande
ms.date: 04/01/2008
ms.assetid: 5346aab1-9974-489f-a065-ae3883b8a350
msc.legacyurl: /web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
msc.type: authoredcontent
ms.openlocfilehash: c19f7dfac0ddd12c2b4f3388a71a8ca0f71cbb18
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78438888"
---
# <a name="unlocking-and-approving-user-accounts-c"></a><span data-ttu-id="dca78-104">Снятие блокировки и утверждение учетных записей пользователей (C#)</span><span class="sxs-lookup"><span data-stu-id="dca78-104">Unlocking and Approving User Accounts (C#)</span></span>

<span data-ttu-id="dca78-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="dca78-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="dca78-106">[Скачать код](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) или [скачать PDF](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="dca78-106">[Download Code](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) or [Download PDF](https://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span></span>

> <span data-ttu-id="dca78-107">В этом руководстве показано, как создать веб-страницу для администраторов, чтобы управлять заблокированными и утвержденными состояниями пользователей.</span><span class="sxs-lookup"><span data-stu-id="dca78-107">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="dca78-108">Мы также посмотрим, как утверждать новых пользователей только после проверки адреса электронной почты.</span><span class="sxs-lookup"><span data-stu-id="dca78-108">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="introduction"></a><span data-ttu-id="dca78-109">Введение</span><span class="sxs-lookup"><span data-stu-id="dca78-109">Introduction</span></span>

<span data-ttu-id="dca78-110">Вместе с именем пользователя, паролем и электронной почтой каждая учетная запись пользователя имеет два поля состояния, определяющие, может ли пользователь войти на сайт: заблокировано и утверждено.</span><span class="sxs-lookup"><span data-stu-id="dca78-110">Along with a username, password, and email, each user account has two status fields that dictate whether the user can log into the site: locked out and approved.</span></span> <span data-ttu-id="dca78-111">Пользователь автоматически блокируется, если он предоставляет недействительные учетные данные указанное число раз в течение заданного числа минут (параметры по умолчанию заблокируют пользователя после 5 недопустимых попыток входа в систему в течение 10 минут).</span><span class="sxs-lookup"><span data-stu-id="dca78-111">A user is automatically locked out if they provide invalid credentials a specified number of times within a specified number of minutes (the default settings lock a user out after 5 invalid login attempts within 10 minutes).</span></span> <span data-ttu-id="dca78-112">Утвержденное состояние полезно в сценариях, где некоторые действия должны пройти до того, как новый пользователь сможет войти на сайт.</span><span class="sxs-lookup"><span data-stu-id="dca78-112">The approved status is useful in scenarios where some action must transpire before a new user is able to log on to the site.</span></span> <span data-ttu-id="dca78-113">Например, пользователю может потребоваться сначала проверить свой адрес электронной почты или утвердить его администратором, прежде чем сможет войти в систему.</span><span class="sxs-lookup"><span data-stu-id="dca78-113">For example, a user might need to first verify their email address or be approved by an administrator before being able to login.</span></span>

<span data-ttu-id="dca78-114">Так как заблокированный или Неутвержденный пользователь не может войти в систему, естественно узнать, как можно сбросить эти состояния.</span><span class="sxs-lookup"><span data-stu-id="dca78-114">Because a locked out or unapproved user cannot login, it's only natural to wonder how these statuses can be reset.</span></span> <span data-ttu-id="dca78-115">ASP.NET не включает встроенные функции и веб-элементы управления для управления заблокированными и утвержденными состояниями, частично, поскольку эти решения должны обрабатываться отдельно для каждого узла.</span><span class="sxs-lookup"><span data-stu-id="dca78-115">ASP.NET does not include any built-in functionality or Web controls for managing users' locked out and approved statuses, in part because these decisions need to be handled on a site-by-site basis.</span></span> <span data-ttu-id="dca78-116">Некоторые сайты могут автоматически утверждать все новые учетные записи пользователей (поведение по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="dca78-116">Some sites might automatically approve all new user accounts (the default behavior).</span></span> <span data-ttu-id="dca78-117">У других есть права администратора, утверждающие новые учетные записи или не утверждающие пользователей, пока они не будут посещать ссылку, отправленную на адрес электронной почты, указанный при регистрации.</span><span class="sxs-lookup"><span data-stu-id="dca78-117">Others have an administrator approve new accounts or do not approve users until they visit a link sent to the email address provided when they signed up.</span></span> <span data-ttu-id="dca78-118">Аналогичным образом некоторые сайты могут блокировать пользователей, пока администратор не сбрасывает состояние, а другие сайты отправляют сообщение электронной почты заблокированному пользователю по URL-адресу для разблокировки учетной записи.</span><span class="sxs-lookup"><span data-stu-id="dca78-118">Likewise, some sites may lock out users until an administrator resets their status, while other sites send an email to the locked out user with a URL they can visit to unlock their account.</span></span>

<span data-ttu-id="dca78-119">В этом руководстве показано, как создать веб-страницу для администраторов, чтобы управлять заблокированными и утвержденными состояниями пользователей.</span><span class="sxs-lookup"><span data-stu-id="dca78-119">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="dca78-120">Мы также посмотрим, как утверждать новых пользователей только после проверки адреса электронной почты.</span><span class="sxs-lookup"><span data-stu-id="dca78-120">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="step-1-managing-users-locked-out-and-approved-statuses"></a><span data-ttu-id="dca78-121">Шаг 1. Управление заблокированными и утвержденными состояниями пользователей</span><span class="sxs-lookup"><span data-stu-id="dca78-121">Step 1: Managing Users' Locked Out and Approved Statuses</span></span>

<span data-ttu-id="dca78-122"><a id="Tutorial12"> </a>В [*создании интерфейса для выбора одной учетной записи пользователя из многих*](building-an-interface-to-select-one-user-account-from-many-cs.md) учебных заработок была создана страница, в которой каждая учетная запись пользователя была выведена в отфильтрованном виде, фильтрованном элементе управления GridView.</span><span class="sxs-lookup"><span data-stu-id="dca78-122">In the <a id="Tutorial12"></a>[*Building an Interface to Select One User Account from Many*](building-an-interface-to-select-one-user-account-from-many-cs.md) tutorial we constructed a page that listed each user account in a paged, filtered GridView.</span></span> <span data-ttu-id="dca78-123">В сетке перечислены имя и адрес электронной почты каждого пользователя, утвержденные и заблокированные состояния, будь то в сети и какие комментарии пользователю.</span><span class="sxs-lookup"><span data-stu-id="dca78-123">The grid lists each user's name and email, their approved and locked out statuses, whether they're currently online, and any comments about the user.</span></span> <span data-ttu-id="dca78-124">Чтобы управлять утвержденными и заблокированными состояниями пользователей, можно сделать эту сетку редактируемой.</span><span class="sxs-lookup"><span data-stu-id="dca78-124">To manage users' approved and locked out statuses, we could make this grid editable.</span></span> <span data-ttu-id="dca78-125">Чтобы изменить состояние утвержденного пользователя, администратор сначала найдет учетную запись пользователя, а затем отредактирует соответствующую строку GridView, установив или сняв флажок утверждено.</span><span class="sxs-lookup"><span data-stu-id="dca78-125">To change a user's approved status, the administrator would first locate the user account and then edit the corresponding GridView row, checking or unchecking the approved checkbox.</span></span> <span data-ttu-id="dca78-126">Кроме того, можно управлять состоянием утвержденных и заблокированных состояний с помощью отдельной страницы ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="dca78-126">Alternatively, we could manage the approved and locked out statuses through a separate ASP.NET page.</span></span>

<span data-ttu-id="dca78-127">В этом руководстве мы будем использовать две страницы ASP.NET: `ManageUsers.aspx` и `UserInformation.aspx`.</span><span class="sxs-lookup"><span data-stu-id="dca78-127">For this tutorial let's use two ASP.NET pages: `ManageUsers.aspx` and `UserInformation.aspx`.</span></span> <span data-ttu-id="dca78-128">Идея в том, что `ManageUsers.aspx` выводит список учетных записей пользователей в системе, а `UserInformation.aspx` позволяет администратору управлять утвержденными и заблокированными состояниями для конкретного пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-128">The idea here is that `ManageUsers.aspx` lists the user accounts in the system, while `UserInformation.aspx` enables the administrator to manage the approved and locked out statuses for a specific user.</span></span> <span data-ttu-id="dca78-129">Наш первый заказ заключается в том, чтобы дополнить GridView в `ManageUsers.aspx`, чтобы включить HyperLinkField, который визуализируется как столбец ссылок.</span><span class="sxs-lookup"><span data-stu-id="dca78-129">Our first order of business is to augment the GridView in `ManageUsers.aspx` to include a HyperLinkField, which renders as a column of links.</span></span> <span data-ttu-id="dca78-130">Мы хотим, чтобы каждая ссылка указывала на `UserInformation.aspx?user=UserName`, где *username* — имя пользователя, которого нужно изменить.</span><span class="sxs-lookup"><span data-stu-id="dca78-130">We want each link to point to `UserInformation.aspx?user=UserName`, where *UserName* is the name of the user to edit.</span></span>

> [!NOTE]
> <span data-ttu-id="dca78-131">Если вы загрузили код для <a id="Tutorial13"> </a>учебника по [*восстановлению и смене паролей*](recovering-and-changing-passwords-cs.md) , возможно, вы заметили, что `ManageUsers.aspx` страница уже содержит набор ссылок "Управление", а страница `UserInformation.aspx` предоставляет интерфейс для изменения пароля выбранного пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-131">If you downloaded the code for the <a id="Tutorial13"></a>[*Recovering and Changing Passwords*](recovering-and-changing-passwords-cs.md) tutorial you may have noticed that the `ManageUsers.aspx` page already contains a set of "Manage" links and the `UserInformation.aspx` page provides an interface for changing the selected user's password.</span></span> <span data-ttu-id="dca78-132">Я решил не выполнять репликацию этих функций в коде, связанном с этим руководством, поскольку он работал путем обхода API членства и работы непосредственно с SQL Server базой данных для изменения пароля пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-132">I decided not to replicate that functionality in the code associated with this tutorial because it worked by circumventing the Membership API and operating directly with the SQL Server database to change a user's password.</span></span> <span data-ttu-id="dca78-133">Это руководство начинается с самого начала со страницы `UserInformation.aspx`.</span><span class="sxs-lookup"><span data-stu-id="dca78-133">This tutorial starts from scratch with the `UserInformation.aspx` page.</span></span>

### <a name="adding-manage-links-to-theuseraccountsgridview"></a><span data-ttu-id="dca78-134">Добавление ссылок "Управление" в`UserAccounts`GridView</span><span class="sxs-lookup"><span data-stu-id="dca78-134">Adding "Manage" Links to the`UserAccounts`GridView</span></span>

<span data-ttu-id="dca78-135">Откройте страницу `ManageUsers.aspx` и добавьте HyperLinkField в `UserAccounts` GridView.</span><span class="sxs-lookup"><span data-stu-id="dca78-135">Open the `ManageUsers.aspx` page and add a HyperLinkField to the `UserAccounts` GridView.</span></span> <span data-ttu-id="dca78-136">Задайте для свойства `Text` HyperLinkField значение "Manage", а свойства `DataNavigateUrlFields` и `DataNavigateUrlFormatString` — `UserName` и "Усеринформатион. aspx? User ={0}" соответственно.</span><span class="sxs-lookup"><span data-stu-id="dca78-136">Set the HyperLinkField's `Text` property to "Manage" and its `DataNavigateUrlFields` and `DataNavigateUrlFormatString` properties to `UserName` and "UserInformation.aspx?user={0}", respectively.</span></span> <span data-ttu-id="dca78-137">Эти параметры настраивают HyperLinkField таким образом, что все гиперссылки отображают текст "Manage", но каждая ссылка передается в строку запроса с соответствующим значением *username* .</span><span class="sxs-lookup"><span data-stu-id="dca78-137">These settings configure the HyperLinkField such that all of the hyperlinks display the text "Manage", but each link passes in the appropriate *UserName* value into the querystring.</span></span>

<span data-ttu-id="dca78-138">После добавления HyperLinkField в GridView просмотрите страницу `ManageUsers.aspx` в браузере.</span><span class="sxs-lookup"><span data-stu-id="dca78-138">After adding the HyperLinkField to the GridView, take a moment to view the `ManageUsers.aspx` page through a browser.</span></span> <span data-ttu-id="dca78-139">Как показано на рис. 1, каждая строка GridView теперь включает ссылку "Управление".</span><span class="sxs-lookup"><span data-stu-id="dca78-139">As Figure 1 shows, each GridView row now includes a "Manage" link.</span></span> <span data-ttu-id="dca78-140">Ссылка "Управление" для Брюс указывает на `UserInformation.aspx?user=Bruce`, а ссылка "Управление" для Дейв указывает на `UserInformation.aspx?user=Dave`.</span><span class="sxs-lookup"><span data-stu-id="dca78-140">The "Manage" link for Bruce points to `UserInformation.aspx?user=Bruce`, whereas the "Manage" link for Dave points to `UserInformation.aspx?user=Dave`.</span></span>

<span data-ttu-id="dca78-141">[![HyperLinkField добавляет элемент](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="dca78-141">[![The HyperLinkField Adds a](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span></span>

<span data-ttu-id="dca78-142">**Рис. 1**. HyperLinkField добавляет ссылку "Управление" для каждой учетной записи пользователя ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="dca78-142">**Figure 1**: The HyperLinkField Adds a "Manage" Link for Each User Account  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span></span>

<span data-ttu-id="dca78-143">Мы создадим пользовательский интерфейс и код для страницы `UserInformation.aspx`, но сначала давайте поговорим о том, как программным образом изменить заблокированные и утвержденные состояния пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-143">We will create the user interface and code for the `UserInformation.aspx` page in a moment, but first let's talk about how to programmatically change a user's locked out and approved statuses.</span></span> <span data-ttu-id="dca78-144">[Класс`MembershipUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) имеет свойства [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) и [`IsApproved`](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span><span class="sxs-lookup"><span data-stu-id="dca78-144">The [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) has [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) and [`IsApproved` properties](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span></span> <span data-ttu-id="dca78-145">Свойство `IsLockedOut` доступно только для чтения.</span><span class="sxs-lookup"><span data-stu-id="dca78-145">The `IsLockedOut` property is read-only.</span></span> <span data-ttu-id="dca78-146">Механизм программной блокировки пользователя не предусмотрен. чтобы разблокировать пользователя, используйте [метод`UnlockUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)класса `MembershipUser`.</span><span class="sxs-lookup"><span data-stu-id="dca78-146">There is no mechanism to programmatically lock out a user; to unlock a user, use the `MembershipUser` class's [`UnlockUser` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span> <span data-ttu-id="dca78-147">Свойство `IsApproved` доступно для чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="dca78-147">The `IsApproved` property is readable and writeable.</span></span> <span data-ttu-id="dca78-148">Чтобы сохранить изменения, внесенные в это свойство, необходимо вызвать [метод`UpdateUser`](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx)класса `Membership`, передав измененный объект `MembershipUser`.</span><span class="sxs-lookup"><span data-stu-id="dca78-148">To save any changes to this property, we need to call the `Membership` class's [`UpdateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx), passing in the modified `MembershipUser` object.</span></span>

<span data-ttu-id="dca78-149">Поскольку свойство `IsApproved` доступно для чтения и записи, элемент управления CheckBox, вероятно, является лучшим элементом пользовательского интерфейса для настройки этого свойства.</span><span class="sxs-lookup"><span data-stu-id="dca78-149">Because the `IsApproved` property is readable and writeable, a CheckBox control is probably the best user interface element for configuring this property.</span></span> <span data-ttu-id="dca78-150">Однако флажок не будет работать для свойства `IsLockedOut`, поскольку администратор не может заблокировать пользователя, он может разблокировать пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-150">However, a CheckBox will not work for the `IsLockedOut` property because an administrator cannot lock out a user, she may only unlock a user.</span></span> <span data-ttu-id="dca78-151">Подходящим пользовательским интерфейсом для свойства `IsLockedOut` является кнопка, которая при щелчке разблокирует учетную запись пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-151">A suitable user interface for the `IsLockedOut` property is a Button that, when clicked, unlocks the user account.</span></span> <span data-ttu-id="dca78-152">Эта кнопка должна быть включена, только если пользователь заблокирован.</span><span class="sxs-lookup"><span data-stu-id="dca78-152">This Button should only be enabled if the user is locked out.</span></span>

### <a name="creating-theuserinformationaspxpage"></a><span data-ttu-id="dca78-153">Создание страницы`UserInformation.aspx`</span><span class="sxs-lookup"><span data-stu-id="dca78-153">Creating the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="dca78-154">Теперь мы готовы реализовать пользовательский интерфейс в `UserInformation.aspx`.</span><span class="sxs-lookup"><span data-stu-id="dca78-154">We are now ready to implement the user interface in `UserInformation.aspx`.</span></span> <span data-ttu-id="dca78-155">Откройте эту страницу и добавьте следующие веб-элементы управления:</span><span class="sxs-lookup"><span data-stu-id="dca78-155">Open this page and add the following Web controls:</span></span>

- <span data-ttu-id="dca78-156">Элемент управления HyperLink, который при щелчке возвращает администратора на страницу `ManageUsers.aspx`.</span><span class="sxs-lookup"><span data-stu-id="dca78-156">A HyperLink control that, when clicked, returns the administrator to the `ManageUsers.aspx` page.</span></span>
- <span data-ttu-id="dca78-157">Веб-элемент управления Label для отображения имени выбранного пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-157">A Label Web control for displaying the selected user's name.</span></span> <span data-ttu-id="dca78-158">Задайте для этой метки `ID` значение `UserNameLabel` и удалите его свойство `Text`.</span><span class="sxs-lookup"><span data-stu-id="dca78-158">Set this Label's `ID` to `UserNameLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="dca78-159">Элемент управления CheckBox с именем `IsApproved`.</span><span class="sxs-lookup"><span data-stu-id="dca78-159">A CheckBox control named `IsApproved`.</span></span> <span data-ttu-id="dca78-160">Задайте для свойства `AutoPostBack` значение `true`.</span><span class="sxs-lookup"><span data-stu-id="dca78-160">Set its `AutoPostBack` property to `true`.</span></span>
- <span data-ttu-id="dca78-161">Элемент управления Label для отображения даты последнего блокировки пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-161">A Label control for displaying the user's last locked out date.</span></span> <span data-ttu-id="dca78-162">Назовите эту метку `LastLockedOutDateLabel` и очистите ее свойство `Text`.</span><span class="sxs-lookup"><span data-stu-id="dca78-162">Name this Label `LastLockedOutDateLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="dca78-163">Кнопка для разблокировки пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-163">A Button for unlocking the user.</span></span> <span data-ttu-id="dca78-164">Присвойте этой кнопке имя `UnlockUserButton` и задайте для свойства `Text` значение "разблокировать пользователя".</span><span class="sxs-lookup"><span data-stu-id="dca78-164">Name this Button `UnlockUserButton` and set its `Text` property to "Unlock User".</span></span>
- <span data-ttu-id="dca78-165">Элемент управления "метка" для отображения сообщений о состоянии, например "состояние утверждения пользователя Обновлено".</span><span class="sxs-lookup"><span data-stu-id="dca78-165">A Label control for displaying status messages, such as, "The user's approved status has been updated."</span></span> <span data-ttu-id="dca78-166">Назовите этот элемент управления `StatusMessage`, очистите его свойство `Text` и задайте для его свойства `CssClass` значение `Important`.</span><span class="sxs-lookup"><span data-stu-id="dca78-166">Name this control `StatusMessage`, clear out its `Text` property, and set its `CssClass` property to `Important`.</span></span> <span data-ttu-id="dca78-167">(Класс `Important` CSS определен в `Styles.css` файле стилей. он отображает соответствующий текст в большом красном шрифте.)</span><span class="sxs-lookup"><span data-stu-id="dca78-167">(The `Important` CSS class is defined in the `Styles.css` stylesheet file; it displays the corresponding text in a large, red font.)</span></span>

<span data-ttu-id="dca78-168">После добавления этих элементов управления представление конструирования в Visual Studio должны выглядеть примерно так, как на снимке экрана на рис. 2.</span><span class="sxs-lookup"><span data-stu-id="dca78-168">After adding these controls, the Design view in Visual Studio should look similar to the screen shot in Figure 2.</span></span>

<span data-ttu-id="dca78-169">[![создания пользовательского интерфейса для Усеринформатион. aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="dca78-169">[![Create the User Interface for UserInformation.aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span></span>

<span data-ttu-id="dca78-170">**Рис. 2**. Создание пользовательского интерфейса для `UserInformation.aspx` ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="dca78-170">**Figure 2**: Create the User Interface for `UserInformation.aspx` ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span></span>

<span data-ttu-id="dca78-171">После завершения пользовательского интерфейса Наша следующая задача — установить флажок `IsApproved` и другие элементы управления на основе сведений о выбранном пользователе.</span><span class="sxs-lookup"><span data-stu-id="dca78-171">With the user interface complete, our next task is to set the `IsApproved` CheckBox and other controls based on the selected user's information.</span></span> <span data-ttu-id="dca78-172">Создайте обработчик событий для события `Load` страницы и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="dca78-172">Create an event handler for the page's `Load` event and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample1.cs)]

<span data-ttu-id="dca78-173">Приведенный выше код начинается с того, что он является первым посещением страницы, а не последующей обратной передачи.</span><span class="sxs-lookup"><span data-stu-id="dca78-173">The above code starts by ensuring that this is the first visit to the page and not a subsequent postback.</span></span> <span data-ttu-id="dca78-174">Затем он считывает имя пользователя, переданное с помощью поля QueryString `user`, и получает сведения об этой учетной записи пользователя с помощью метода `Membership.GetUser(username)`.</span><span class="sxs-lookup"><span data-stu-id="dca78-174">It then reads the username passed through the `user` querystring field and retrieves information about that user account via the `Membership.GetUser(username)` method.</span></span> <span data-ttu-id="dca78-175">Если в строке запроса не было указано имя пользователя или указанный пользователь не найден, администратор отправляет его обратно на страницу `ManageUsers.aspx`.</span><span class="sxs-lookup"><span data-stu-id="dca78-175">If no username was supplied through the querystring, or if the specified user could not be found, the administrator is sent back to the `ManageUsers.aspx` page.</span></span>

<span data-ttu-id="dca78-176">Значение `UserName` объекта `MembershipUser` отображается в `UserNameLabel`, а флажок `IsApproved` проверяется на основе значения свойства `IsApproved`.</span><span class="sxs-lookup"><span data-stu-id="dca78-176">The `MembershipUser` object's `UserName` value is then displayed in the `UserNameLabel` and the `IsApproved` CheckBox is checked based on the `IsApproved` property value.</span></span>

<span data-ttu-id="dca78-177">[Свойство`LastLockoutDate`](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) объекта `MembershipUser` возвращает значение `DateTime`, указывающее время последней блокировки пользователя. Если пользователь никогда не был заблокирован, возвращаемое значение зависит от поставщика членства.</span><span class="sxs-lookup"><span data-stu-id="dca78-177">The `MembershipUser` object's [`LastLockoutDate` property](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) returns a `DateTime` value indicating when the user was last locked out. If the user has never been locked out, the value returned depends on the Membership provider.</span></span> <span data-ttu-id="dca78-178">При создании новой учетной записи `SqlMembershipProvider` задает `1754-01-01 12:00:00 AM`поле `LastLockoutDate` таблицы `aspnet_Membership`.</span><span class="sxs-lookup"><span data-stu-id="dca78-178">When a new account is created, the `SqlMembershipProvider` sets the `aspnet_Membership` table's `LastLockoutDate` field to `1754-01-01 12:00:00 AM`.</span></span> <span data-ttu-id="dca78-179">Приведенный выше код отображает пустую строку в `LastLockoutDateLabel`, если свойство `LastLockoutDate` происходит раньше года 2000; в противном случае часть даты свойства `LastLockoutDate` отображается в метке.</span><span class="sxs-lookup"><span data-stu-id="dca78-179">The above code displays an empty string in the `LastLockoutDateLabel` if the `LastLockoutDate` property occurs before year 2000; otherwise, the date portion of the `LastLockoutDate` property is displayed in the Label.</span></span> <span data-ttu-id="dca78-180">Для свойства `UnlockUserButton'` s `Enabled` задано состояние заблокировано пользователем. Это означает, что эта кнопка будет включена только в том случае, если пользователь заблокирован.</span><span class="sxs-lookup"><span data-stu-id="dca78-180">The `UnlockUserButton'` s `Enabled` property is set to the user's locked out status, meaning that this Button will only be enabled if the user is locked out.</span></span>

<span data-ttu-id="dca78-181">Протестируйте страницу `UserInformation.aspx` в браузере.</span><span class="sxs-lookup"><span data-stu-id="dca78-181">Take a moment to test the `UserInformation.aspx` page through a browser.</span></span> <span data-ttu-id="dca78-182">Конечно, необходимо начать с `ManageUsers.aspx` и выбрать учетную запись пользователя для управления.</span><span class="sxs-lookup"><span data-stu-id="dca78-182">You will, of course, need to start at `ManageUsers.aspx` and select a user account to manage.</span></span> <span data-ttu-id="dca78-183">При поступлении на `UserInformation.aspx`Обратите внимание, что флажок `IsApproved` проверяется только в том случае, если пользователь утвержден.</span><span class="sxs-lookup"><span data-stu-id="dca78-183">Upon arriving at `UserInformation.aspx`, note that the `IsApproved` CheckBox is only checked if the user is approved.</span></span> <span data-ttu-id="dca78-184">Если пользователь когда-либо был заблокирован, отображается последняя блокировка даты блокировки.</span><span class="sxs-lookup"><span data-stu-id="dca78-184">If the user has ever been locked out, their last locked out date is displayed.</span></span> <span data-ttu-id="dca78-185">Кнопка разблокировать пользователя доступна, только если пользователь в данный момент заблокирован. Установка или снятие флажка `IsApproved` или нажатие кнопки "разблокировать пользователя" вызывает обратную передачу, но не вносятся изменения в учетную запись пользователя, так как мы еще создали обработчики событий для этих событий.</span><span class="sxs-lookup"><span data-stu-id="dca78-185">The Unlock User button is enabled only if the user is currently locked out. Checking or unchecking the `IsApproved` CheckBox or clicking the Unlock User button causes a postback, but no modifications are made to the user account because we've yet to create event handlers for these events.</span></span>

<span data-ttu-id="dca78-186">Вернитесь в Visual Studio и создайте обработчики событий для `CheckedChanged` события флажка `IsApproved` и события `Click` кнопки `UnlockUser`.</span><span class="sxs-lookup"><span data-stu-id="dca78-186">Return to Visual Studio and create event handlers for the `IsApproved` CheckBox's `CheckedChanged` event and the `UnlockUser` Button's `Click` event.</span></span> <span data-ttu-id="dca78-187">В обработчике событий `CheckedChanged` установите свойство `IsApproved` пользователя в свойство `Checked` флажка, а затем сохраните изменения с помощью вызова `Membership.UpdateUser`.</span><span class="sxs-lookup"><span data-stu-id="dca78-187">In the `CheckedChanged` event handler, set the user's `IsApproved` property to the `Checked` property of the CheckBox and then save the changes via a call to `Membership.UpdateUser`.</span></span> <span data-ttu-id="dca78-188">В обработчике событий `Click` просто вызовите метод `UnlockUser` объекта `MembershipUser`.</span><span class="sxs-lookup"><span data-stu-id="dca78-188">In the `Click` event handler, simply call the `MembershipUser` object's `UnlockUser` method.</span></span> <span data-ttu-id="dca78-189">В обоих обработчиках событий отобразите подходящее сообщение в метке `StatusMessage`.</span><span class="sxs-lookup"><span data-stu-id="dca78-189">In both event handlers, display a suitable message in the `StatusMessage` Label.</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample2.cs)]

### <a name="testing-theuserinformationaspxpage"></a><span data-ttu-id="dca78-190">Тестирование страницы`UserInformation.aspx`</span><span class="sxs-lookup"><span data-stu-id="dca78-190">Testing the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="dca78-191">Заполнив эти обработчики событий, перейдите на страницу и не утвердите пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-191">With these event handlers in place, revisit the page and unapproved a user.</span></span> <span data-ttu-id="dca78-192">Как показано на рис. 3, на странице должно отобразиться краткое сообщение о том, что свойство `IsApproved` пользователя успешно изменено.</span><span class="sxs-lookup"><span data-stu-id="dca78-192">As Figure 3 shows, you should see a brief message on the page indicating that the user's `IsApproved` property was successfully modified.</span></span>

<span data-ttu-id="dca78-193">[![Крис не утвержден](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="dca78-193">[![Chris has been Unapproved](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span></span>

<span data-ttu-id="dca78-194">**Рис. 3**. Петр был неодобрен ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="dca78-194">**Figure 3**: Chris has been Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span></span>

<span data-ttu-id="dca78-195">Затем выполните выход и попробуйте войти в систему от имени пользователя, учетная запись которого была только что утверждена.</span><span class="sxs-lookup"><span data-stu-id="dca78-195">Next, logout and try to login as the user whose account was just unapproved.</span></span> <span data-ttu-id="dca78-196">Поскольку пользователь не утвержден, он не может войти в систему.</span><span class="sxs-lookup"><span data-stu-id="dca78-196">Because the user is not approved, they cannot login.</span></span> <span data-ttu-id="dca78-197">По умолчанию элемент управления Login отображает то же сообщение, если пользователь не может войти в систему, независимо от причины.</span><span class="sxs-lookup"><span data-stu-id="dca78-197">By default, the Login control displays the same message if the user cannot login, regardless of the reason.</span></span> <span data-ttu-id="dca78-198">Но в <a id="Tutorial6"> </a>учебнике [*Проверка учетных данных пользователя в хранилище пользователей членства*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) мы рассматривали усовершенствование элемента управления Login для вывода более подходящего сообщения.</span><span class="sxs-lookup"><span data-stu-id="dca78-198">But in the <a id="Tutorial6"></a>[*Validating User Credentials Against the Membership User Store*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) tutorial we looked at enhancing the Login control to display a more appropriate message.</span></span> <span data-ttu-id="dca78-199">Как показано на рис. 4, Крис показывает сообщение о том, что ему не удается выполнить вход, поскольку его учетная запись еще не утверждена.</span><span class="sxs-lookup"><span data-stu-id="dca78-199">As Figure 4 shows, Chris is shown a message explaining that he cannot login because his account is not yet approved.</span></span>

<span data-ttu-id="dca78-200">[![Крис не удается войти, так как его учетная запись не утверждена](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="dca78-200">[![Chris Cannot Login Because His Account is Unapproved](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span></span>

<span data-ttu-id="dca78-201">**Рис. 4**. Крис не может войти в систему, так как его учетная запись не утверждена ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="dca78-201">**Figure 4**: Chris Cannot Login Because His Account is Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span></span>

<span data-ttu-id="dca78-202">Чтобы протестировать функцию блокировки, попробуйте войти как утвержденного пользователя, но используйте неверный пароль.</span><span class="sxs-lookup"><span data-stu-id="dca78-202">To test the locked out functionality, attempt to login as an approved user, but use an incorrect password.</span></span> <span data-ttu-id="dca78-203">Повторите эту процедуру необходимое количество раз, пока учетная запись пользователя не будет заблокирована. Элемент управления Login также был обновлен для отображения пользовательского сообщения при попытке входа из заблокированной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="dca78-203">Repeat this process the necessary number of times until the user's account has been locked out. The Login control was also updated to show a custom message if attempting to login from a locked out account.</span></span> <span data-ttu-id="dca78-204">Вы уверены, что учетная запись заблокирована после того, как на странице входа появится следующее сообщение: "Ваша учетная запись заблокирована из-за слишком большого числа недопустимых попыток входа.</span><span class="sxs-lookup"><span data-stu-id="dca78-204">You know that an account has been locked out once you start seeing the following message at the login page: "Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="dca78-205">Обратитесь к администратору, чтобы ваша учетная запись была разблокирована. "</span><span class="sxs-lookup"><span data-stu-id="dca78-205">Please contact the administrator to have your account unlocked."</span></span>

<span data-ttu-id="dca78-206">Вернитесь на страницу `ManageUsers.aspx` и щелкните ссылку Управление для заблокированного пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-206">Return to the `ManageUsers.aspx` page and click the Manage link for the locked out user.</span></span> <span data-ttu-id="dca78-207">Как показано на рис. 5, вы увидите значение в `LastLockedOutDateLabel` необходимо включить кнопку разблокировать пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-207">As Figure 5 shows, you should see a value in the `LastLockedOutDateLabel` the Unlock User button should be enabled.</span></span> <span data-ttu-id="dca78-208">Нажмите кнопку разблокировать пользователя, чтобы разблокировать учетную запись пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-208">Click the Unlock User button to unlock the user account.</span></span> <span data-ttu-id="dca78-209">После того как пользователь разблокируется, он сможет снова войти в систему.</span><span class="sxs-lookup"><span data-stu-id="dca78-209">Once you have unlocked the user, they will be able to login again.</span></span>

<span data-ttu-id="dca78-210">[![Дейв заблокирована системой](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="dca78-210">[![Dave Has Been Locked Out of the System](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span></span>

<span data-ttu-id="dca78-211">**Рис. 5**. Дейв заблокирована системой ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="dca78-211">**Figure 5**: Dave Has Been Locked Out of the System  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span></span>

## <a name="step-2-specifying-new-users-approved-status"></a><span data-ttu-id="dca78-212">Шаг 2. Указание утвержденного состояния новых пользователей</span><span class="sxs-lookup"><span data-stu-id="dca78-212">Step 2: Specifying New Users' Approved Status</span></span>

<span data-ttu-id="dca78-213">Утвержденное состояние полезно в тех случаях, когда требуется выполнить какие-либо действия, прежде чем новый пользователь сможет войти в систему и получить доступ к пользовательским функциям сайта.</span><span class="sxs-lookup"><span data-stu-id="dca78-213">The approved status is useful in scenarios where you want some action to be performed before a new user is able to login and access the user-specific features of the site.</span></span> <span data-ttu-id="dca78-214">Например, вы можете запустить частный веб-сайт, где все страницы, кроме страниц входа и регистрации, доступны только пользователям, прошедшим проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="dca78-214">For example, you may be running a private website where all pages, except for the login and signup pages, are accessible only to authenticated users.</span></span> <span data-ttu-id="dca78-215">Но что произойдет, если Стрэнджер достигает веб-сайта, находит страницу регистрации и создает учетную запись?</span><span class="sxs-lookup"><span data-stu-id="dca78-215">But what happens if a stranger reaches your website, finds the signup page, and creates an account?</span></span> <span data-ttu-id="dca78-216">Чтобы предотвратить это, можно переместить страницу регистрации в папку `Administration` и требовать от администратора вручную создавать каждую учетную запись.</span><span class="sxs-lookup"><span data-stu-id="dca78-216">To prevent this from happening you could move the signup page to an `Administration` folder, and require that an administrator manually create each account.</span></span> <span data-ttu-id="dca78-217">Кроме того, можно разрешить всем пользователям зарегистрироваться, но запретить доступ к сайту, пока администратор не утвердит учетную запись пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-217">Alternatively, you could allow anyone to signup, but prohibit site access until an administrator approves the user account.</span></span>

<span data-ttu-id="dca78-218">По умолчанию элемент управления CreateUserWizard утверждает новые учетные записи.</span><span class="sxs-lookup"><span data-stu-id="dca78-218">By default, the CreateUserWizard control approves new accounts.</span></span> <span data-ttu-id="dca78-219">Это поведение можно настроить с помощью [свойства`DisableCreatedUser`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx)элемента управления.</span><span class="sxs-lookup"><span data-stu-id="dca78-219">You can configure this behavior using the control's [`DisableCreatedUser` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx).</span></span> <span data-ttu-id="dca78-220">Присвойте этому свойству значение `true`, чтобы не утверждать новые учетные записи пользователей.</span><span class="sxs-lookup"><span data-stu-id="dca78-220">Set this property to `true` to not approve new user accounts.</span></span>

> [!NOTE]
> <span data-ttu-id="dca78-221">По умолчанию элемент управления CreateUserWizard автоматически регистрируется в новой учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-221">By default the CreateUserWizard control automatically logs on the new user account.</span></span> <span data-ttu-id="dca78-222">Это поведение определяется [свойством`LoginCreatedUser`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx)элемента управления.</span><span class="sxs-lookup"><span data-stu-id="dca78-222">This behavior is dictated by the control's [`LoginCreatedUser` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).</span></span> <span data-ttu-id="dca78-223">Так как неутвержденные пользователи не могут войти на сайт, то при `DisableCreatedUser` `true` новая учетная запись пользователя не будет зарегистрирована на сайте, независимо от значения свойства `LoginCreatedUser`.</span><span class="sxs-lookup"><span data-stu-id="dca78-223">Because unapproved users cannot login to the site, when `DisableCreatedUser` is `true` the new user account is not logged into the site, regardless of the value of the `LoginCreatedUser` property.</span></span>

<span data-ttu-id="dca78-224">Если вы создаете новые учетные записи пользователей программным способом с помощью метода `Membership.CreateUser`, для создания неутвержденной учетной записи пользователя используйте одну из перегрузок, принимающих значение свойства `IsApproved` нового пользователя в качестве входного параметра.</span><span class="sxs-lookup"><span data-stu-id="dca78-224">If you are programmatically creating new user accounts via the `Membership.CreateUser` method, to create an unapproved user account use one of the overloads that accept the new user's `IsApproved` property value as an input parameter.</span></span>

## <a name="step-3-approving-users-by-verifying-their-email-address"></a><span data-ttu-id="dca78-225">Шаг 3. Утверждение пользователей путем проверки адреса электронной почты</span><span class="sxs-lookup"><span data-stu-id="dca78-225">Step 3: Approving Users By Verifying their Email Address</span></span>

<span data-ttu-id="dca78-226">Многие веб-сайты, поддерживающие учетные записи пользователей, не утверждают новых пользователей, пока они не проверяют адрес электронной почты, указанный при регистрации.</span><span class="sxs-lookup"><span data-stu-id="dca78-226">Many websites that support user accounts do not approve new users until they verify the email address they supplied when registering.</span></span> <span data-ttu-id="dca78-227">Этот процесс проверки обычно используется для противодействия программы-роботы, спама и других не'ер-Do-Wells, так как ему требуется уникальный, проверенный адрес электронной почты и добавлен дополнительный шаг в процесс регистрации.</span><span class="sxs-lookup"><span data-stu-id="dca78-227">This verification process is commonly used to thwart bots, spammers, and other ne'er-do-wells as it requires a unique, verified email address and adds an extra step in the signup process.</span></span> <span data-ttu-id="dca78-228">При использовании этой модели при регистрации нового пользователя ему отправляется сообщение электронной почты, содержащее ссылку на страницу проверки.</span><span class="sxs-lookup"><span data-stu-id="dca78-228">With this model, when a new user signs up they are sent an email message that includes a link to a verification page.</span></span> <span data-ttu-id="dca78-229">Перейдя по ссылке, пользователь получит сообщение электронной почты и, следовательно, что указанный адрес электронной почты является действительным.</span><span class="sxs-lookup"><span data-stu-id="dca78-229">By visiting the link the user has proven that they received the email and, therefore, that the email address provided is valid.</span></span> <span data-ttu-id="dca78-230">Страница верификации отвечает за утверждение пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-230">The verification page is responsible for approving the user.</span></span> <span data-ttu-id="dca78-231">Это может произойти автоматически, тем самым утверждая любого пользователя, который достиг этой страницы, или только после того, как пользователь предоставит некоторую дополнительную информацию, например [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span><span class="sxs-lookup"><span data-stu-id="dca78-231">This may happen automatically, thereby approving any user who reaches this page, or only after the user provides some additional information, such as a [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span></span>

<span data-ttu-id="dca78-232">Для размещения этого рабочего процесса необходимо сначала обновить страницу создания учетной записи, чтобы новые пользователи не утверждались.</span><span class="sxs-lookup"><span data-stu-id="dca78-232">To accommodate this workflow, we need to first update the account creation page so that new users are unapproved.</span></span> <span data-ttu-id="dca78-233">Откройте страницу `EnhancedCreateUserWizard.aspx` в папке `Membership` и задайте для свойства `DisableCreatedUser` элемента управления CreateUserWizard значение `true`.</span><span class="sxs-lookup"><span data-stu-id="dca78-233">Open the `EnhancedCreateUserWizard.aspx` page in the `Membership` folder and set the CreateUserWizard control's `DisableCreatedUser` property to `true`.</span></span>

<span data-ttu-id="dca78-234">Далее необходимо настроить элемент управления CreateUserWizard для отправки сообщения электронной почты новому пользователю с инструкциями по проверке учетной записи.</span><span class="sxs-lookup"><span data-stu-id="dca78-234">Next, we need to configure the CreateUserWizard control to send an email to the new user with instructions on how to verify their account.</span></span> <span data-ttu-id="dca78-235">В частности, мы будем включать ссылку в сообщение электронной почты на страницу `Verification.aspx` (которая еще не создана), передавая `UserId` нового пользователя через строку запроса.</span><span class="sxs-lookup"><span data-stu-id="dca78-235">In particular, we will include a link in the email to the `Verification.aspx` page (which we've yet to create), passing in the new user's `UserId` through the querystring.</span></span> <span data-ttu-id="dca78-236">Страница `Verification.aspx` будет искать указанного пользователя и пометить их как утвержденные.</span><span class="sxs-lookup"><span data-stu-id="dca78-236">The `Verification.aspx` page will lookup the specified user and mark them approved.</span></span>

### <a name="sending-a-verification-email-to-new-users"></a><span data-ttu-id="dca78-237">Отправка проверочного электронного сообщения новым пользователям</span><span class="sxs-lookup"><span data-stu-id="dca78-237">Sending a Verification Email to New Users</span></span>

<span data-ttu-id="dca78-238">Чтобы отправить сообщение электронной почты из элемента управления CreateUserWizard, настройте его свойство `MailDefinition` соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="dca78-238">To send an email from the CreateUserWizard control, configure its `MailDefinition` property appropriately.</span></span> <span data-ttu-id="dca78-239">Как обсуждалось в <a id="Tutorial13"> </a> [предыдущем руководстве](recovering-and-changing-passwords-cs.md), элементы управления ChangePassword и пассвордрековери включают [свойство`MailDefinition`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) , которое работает так же, как и элемент управления CreateUserWizard.</span><span class="sxs-lookup"><span data-stu-id="dca78-239">As discussed in the <a id="Tutorial13"></a>[previous tutorial](recovering-and-changing-passwords-cs.md), the ChangePassword and PasswordRecovery controls include a [`MailDefinition` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) that works in the same manner as the CreateUserWizard control's.</span></span>

> [!NOTE]
> <span data-ttu-id="dca78-240">Чтобы использовать свойство `MailDefinition`, необходимо указать параметры доставки почты в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="dca78-240">To use the `MailDefinition` property you need to specify mail delivery options in `Web.config`.</span></span> <span data-ttu-id="dca78-241">Дополнительные сведения см. в разделе [Отправка электронной почты в ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span><span class="sxs-lookup"><span data-stu-id="dca78-241">For more information, refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span></span>

<span data-ttu-id="dca78-242">Начните с создания нового шаблона сообщения электронной почты с именем `CreateUserWizard.txt` в папке `EmailTemplates`.</span><span class="sxs-lookup"><span data-stu-id="dca78-242">Start by creating a new email template named `CreateUserWizard.txt` in the `EmailTemplates` folder.</span></span> <span data-ttu-id="dca78-243">Используйте для шаблона следующий текст:</span><span class="sxs-lookup"><span data-stu-id="dca78-243">Use the following text for the template:</span></span>

[!code-aspx[Main](unlocking-and-approving-user-accounts-cs/samples/sample3.aspx)]

<span data-ttu-id="dca78-244">Задайте для свойства `MailDefinition'` s `BodyFileName` значение "~/Емаилтемплатес/креатеусервизард.ткст", а для свойства `Subject` — "Добро пожаловать на мой веб-сайт!</span><span class="sxs-lookup"><span data-stu-id="dca78-244">Set the `MailDefinition'` s `BodyFileName` property to "~/EmailTemplates/CreateUserWizard.txt" and its `Subject` property to "Welcome to My Website!</span></span> <span data-ttu-id="dca78-245">Активируйте учетную запись ".</span><span class="sxs-lookup"><span data-stu-id="dca78-245">Please activate your account."</span></span>

<span data-ttu-id="dca78-246">Обратите внимание, что шаблон `CreateUserWizard.txt` электронной почты содержит заполнитель `<%VerificationUrl%>`.</span><span class="sxs-lookup"><span data-stu-id="dca78-246">Note that the `CreateUserWizard.txt` email template includes a `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="dca78-247">Здесь будет размещен URL-адрес страницы `Verification.aspx`.</span><span class="sxs-lookup"><span data-stu-id="dca78-247">This is where the URL for the `Verification.aspx` page will be placed.</span></span> <span data-ttu-id="dca78-248">CreateUserWizard автоматически заменяет заполнители `<%UserName%>` и `<%Password%>` именем пользователя и паролем новой учетной записи, но нет встроенного `<%VerificationUrl%>` заполнителя.</span><span class="sxs-lookup"><span data-stu-id="dca78-248">The CreateUserWizard automatically replaces the `<%UserName%>` and `<%Password%>` placeholders with the new account's username and password, but there is no built-in `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="dca78-249">Необходимо вручную заменить его соответствующим URL-адресом проверки.</span><span class="sxs-lookup"><span data-stu-id="dca78-249">We need to manually replace it with the appropriate verification URL.</span></span>

<span data-ttu-id="dca78-250">Для этого создайте обработчик событий для [события`SendingMail`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) CreateUserWizard и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="dca78-250">To accomplish this, create an event handler for the CreateUserWizard's [`SendingMail` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample4.cs)]

<span data-ttu-id="dca78-251">Событие `SendingMail` срабатывает после события `CreatedUser`, что означает, что в момент выполнения приведенного выше обработчика событий Новая учетная запись пользователя уже создана.</span><span class="sxs-lookup"><span data-stu-id="dca78-251">The `SendingMail` event fires after the `CreatedUser` event, meaning that by the time the above event handler executes the new user account has already been created.</span></span> <span data-ttu-id="dca78-252">Можно получить доступ к значению `UserId` нового пользователя, вызвав метод `Membership.GetUser`, передав `UserName`, введенный в элемент управления CreateUserWizard.</span><span class="sxs-lookup"><span data-stu-id="dca78-252">We can access the new user's `UserId` value by calling the `Membership.GetUser` method, passing in the `UserName` entered into the CreateUserWizard control.</span></span> <span data-ttu-id="dca78-253">Далее будет сформирован URL-адрес проверки.</span><span class="sxs-lookup"><span data-stu-id="dca78-253">Next, the verification URL is formed.</span></span> <span data-ttu-id="dca78-254">Инструкция `Request.Url.GetLeftPart(UriPartial.Authority)` возвращает `http://yourserver.com` часть URL-адреса. `Request.ApplicationPath` Возвращает путь, по которому приложение является корневым.</span><span class="sxs-lookup"><span data-stu-id="dca78-254">The statement `Request.Url.GetLeftPart(UriPartial.Authority)` returns the `http://yourserver.com` portion of the URL; `Request.ApplicationPath` returns path where the application is rooted.</span></span> <span data-ttu-id="dca78-255">После этого URL-адрес проверки определяется как `Verification.aspx?ID=userId`.</span><span class="sxs-lookup"><span data-stu-id="dca78-255">The verification URL is then defined as `Verification.aspx?ID=userId`.</span></span> <span data-ttu-id="dca78-256">Затем эти две строки объединяются для формирования полного URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="dca78-256">These two strings are then concatenated to form the complete URL.</span></span> <span data-ttu-id="dca78-257">Наконец, текст сообщения электронной почты (`e.Message.Body`) содержит все вхождения `<%VerificationUrl%>` заменяются полным URL-адресом.</span><span class="sxs-lookup"><span data-stu-id="dca78-257">Finally, the email message body (`e.Message.Body`) has all occurrences of `<%VerificationUrl%>` replaced with the full URL.</span></span>

<span data-ttu-id="dca78-258">В итоге новые пользователи не утверждаются, то есть они не могут войти на сайт.</span><span class="sxs-lookup"><span data-stu-id="dca78-258">The net effect is that new users are unapproved, meaning that they cannot log into the site.</span></span> <span data-ttu-id="dca78-259">Кроме того, они автоматически отправляют сообщение электронной почты со ссылкой на URL-адрес проверки (см. рис. 6).</span><span class="sxs-lookup"><span data-stu-id="dca78-259">Furthermore, they are automatically sent an email with a link to the verification URL (see Figure 6).</span></span>

<span data-ttu-id="dca78-260">[![новый пользователь получит сообщение электронной почты со ссылкой на URL-адрес проверки.](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="dca78-260">[![The New User Receives an Email with a Link to the Verification URL](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span></span>

<span data-ttu-id="dca78-261">**Рис. 6**. новый пользователь получит сообщение электронной почты со ссылкой на URL-адрес проверки ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-cs/_static/image18.png)).</span><span class="sxs-lookup"><span data-stu-id="dca78-261">**Figure 6**: The New User Receives an Email with a Link to the Verification URL  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span></span>

> [!NOTE]
> <span data-ttu-id="dca78-262">На шаге CreateUserWizard по умолчанию элемента управления CreateUserWizard отображается сообщение о том, что пользователь создал свою учетную запись и выводит кнопку продолжить.</span><span class="sxs-lookup"><span data-stu-id="dca78-262">The CreateUserWizard control's default CreateUserWizard step displays a message informing the user their account has been created and displays a Continue button.</span></span> <span data-ttu-id="dca78-263">При выборе этого значения пользователь получает URL-адрес, указанный в свойстве `ContinueDestinationPageUrl` элемента управления.</span><span class="sxs-lookup"><span data-stu-id="dca78-263">Clicking this takes the user to the URL specified by the control's `ContinueDestinationPageUrl` property.</span></span> <span data-ttu-id="dca78-264">CreateUserWizard в `EnhancedCreateUserWizard.aspx` настроен на отправку новых пользователей в `~/Membership/AdditionalUserInfo.aspx`, предлагающий пользователю указать свое место проживания, URL-адрес домашней страницы и подпись.</span><span class="sxs-lookup"><span data-stu-id="dca78-264">The CreateUserWizard in `EnhancedCreateUserWizard.aspx` is configured to send new users to the `~/Membership/AdditionalUserInfo.aspx`, which prompts the user for their hometown, homepage URL, and signature.</span></span> <span data-ttu-id="dca78-265">Поскольку эти сведения могут быть добавлены только пользователями, вошедшими в систему, имеет смысл обновить это свойство для отправки пользователей обратно на домашнюю страницу сайта (`~/Default.aspx`).</span><span class="sxs-lookup"><span data-stu-id="dca78-265">Because this information can only be added by logged on users, it makes sense to update this property to send users back to the site's homepage (`~/Default.aspx`).</span></span> <span data-ttu-id="dca78-266">Более того, страница `EnhancedCreateUserWizard.aspx` или шаг CreateUserWizard должны быть дополнены для информирования пользователя о том, что они отправляли проверочное сообщение, а их учетная запись не будет активирована, пока не следуйте инструкциям в этом сообщении.</span><span class="sxs-lookup"><span data-stu-id="dca78-266">Moreover, the `EnhancedCreateUserWizard.aspx` page or the CreateUserWizard step should be augmented to inform the user that they have been sent a verification email and their account won't be activated until they follow the instructions in this email.</span></span> <span data-ttu-id="dca78-267">Я оставлю эти изменения в качестве упражнения для читателя.</span><span class="sxs-lookup"><span data-stu-id="dca78-267">I leave these modifications as an exercise for the reader.</span></span>

### <a name="creating-the-verification-page"></a><span data-ttu-id="dca78-268">Создание страницы проверки</span><span class="sxs-lookup"><span data-stu-id="dca78-268">Creating the Verification Page</span></span>

<span data-ttu-id="dca78-269">Наша последняя задача — создать страницу `Verification.aspx`.</span><span class="sxs-lookup"><span data-stu-id="dca78-269">Our final task is to create the `Verification.aspx` page.</span></span> <span data-ttu-id="dca78-270">Добавьте эту страницу в корневую папку, связав ее с главной страницей `Site.master`.</span><span class="sxs-lookup"><span data-stu-id="dca78-270">Add this page to the root folder, associating it with the `Site.master` master page.</span></span> <span data-ttu-id="dca78-271">Так как мы сделали большую часть предыдущих страниц содержимого, добавленных на сайт, удалите элемент управления содержимым, который ссылается на `LoginContent` ContentPlaceHolder, чтобы страница содержимого использовала содержимое по умолчанию главной страницы.</span><span class="sxs-lookup"><span data-stu-id="dca78-271">As we've done with most of the previous content pages added to the site, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the content page uses the master page's default content.</span></span>

<span data-ttu-id="dca78-272">Добавьте веб-элемент управления Label на страницу `Verification.aspx`, задайте для его `ID` значение `StatusMessage` и удалите его свойство Text.</span><span class="sxs-lookup"><span data-stu-id="dca78-272">Add a Label Web control to the `Verification.aspx` page, set its `ID` to `StatusMessage` and clear out its text property.</span></span> <span data-ttu-id="dca78-273">Затем создайте обработчик событий `Page_Load` и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="dca78-273">Next, create the `Page_Load` event handler and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample5.cs)]

<span data-ttu-id="dca78-274">Основная часть приведенного выше кода проверяет, существует ли `UserId`, предоставляемая через QueryString, что это допустимое `Guid` значение и что оно ссылается на существующую учетную запись пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-274">The bulk of the above code verifies that the `UserId` supplied through the querystring exists, that it is a valid `Guid` value, and that it references an existing user account.</span></span> <span data-ttu-id="dca78-275">Если все эти проверки пройдены, учетная запись пользователя утверждается; в противном случае отображается подходящее сообщение о состоянии.</span><span class="sxs-lookup"><span data-stu-id="dca78-275">If all of these checks pass, the user account is approved; otherwise, a suitable status message is displayed.</span></span>

<span data-ttu-id="dca78-276">На рис. 7 показана страница `Verification.aspx` при посещении через браузер.</span><span class="sxs-lookup"><span data-stu-id="dca78-276">Figure 7 shows the `Verification.aspx` page when visited through a browser.</span></span>

<span data-ttu-id="dca78-277">[![учетная запись нового пользователя теперь утверждена](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="dca78-277">[![The New User's Account is Now Approved](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span></span>

<span data-ttu-id="dca78-278">**Рис. 7**. Теперь учетная запись нового пользователя утверждена ([щелкните, чтобы просмотреть изображение с полным размером](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="dca78-278">**Figure 7**: The New User's Account is Now Approved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span></span>

## <a name="summary"></a><span data-ttu-id="dca78-279">Сводка</span><span class="sxs-lookup"><span data-stu-id="dca78-279">Summary</span></span>

<span data-ttu-id="dca78-280">Все учетные записи пользователей членства имеют два состояния, которые определяют, может ли пользователь войти на сайт: `IsLockedOut` и `IsApproved`.</span><span class="sxs-lookup"><span data-stu-id="dca78-280">All Membership user accounts have two statuses that determine whether the user can log into the site: `IsLockedOut` and `IsApproved`.</span></span> <span data-ttu-id="dca78-281">Оба эти свойства должны быть `true` для входа пользователя.</span><span class="sxs-lookup"><span data-stu-id="dca78-281">Both of these properties must be `true` for the user to login.</span></span>

<span data-ttu-id="dca78-282">Состояние блокировки пользователя используется в качестве меры безопасности, чтобы снизить вероятность нарушения работы хакера на сайте с помощью методов подбора.</span><span class="sxs-lookup"><span data-stu-id="dca78-282">The user's locked out status is used as a security measure to reduce the likelihood of a hacker breaking into a site through brute force methods.</span></span> <span data-ttu-id="dca78-283">В частности, пользователь блокируется при наличии определенного числа недопустимых попыток входа в систему в течение определенного периода времени.</span><span class="sxs-lookup"><span data-stu-id="dca78-283">Specifically, a user is locked out if there are a certain number of invalid login attempts within a certain window of time.</span></span> <span data-ttu-id="dca78-284">Эти границы можно настроить с помощью параметров поставщика членства в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="dca78-284">These bounds are configurable through the Membership provider settings in `Web.config`.</span></span>

<span data-ttu-id="dca78-285">Утвержденное состояние обычно используется как средство, чтобы запретить новым пользователям входить в систему до тех пор, пока не будет выполнено какое-либо действие.</span><span class="sxs-lookup"><span data-stu-id="dca78-285">The approved status is commonly used as a means to prohibit new users from logging in until some action has transpired.</span></span> <span data-ttu-id="dca78-286">Возможно, сайт требует, чтобы новые учетные записи были сначала утверждены администратором, или, как мы видели на шаге 3, проверив свой адрес электронной почты.</span><span class="sxs-lookup"><span data-stu-id="dca78-286">Perhaps the site requires that new accounts first be approved by the administrator or, as we saw in Step 3, by verifying their email address.</span></span>

<span data-ttu-id="dca78-287">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="dca78-287">Happy Programming!</span></span>

### <a name="about-the-author"></a><span data-ttu-id="dca78-288">Об авторе</span><span class="sxs-lookup"><span data-stu-id="dca78-288">About the Author</span></span>

<span data-ttu-id="dca78-289">Скотт Митчелл, автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями Майкрософт с 1998.</span><span class="sxs-lookup"><span data-stu-id="dca78-289">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="dca78-290">Скотт работает как независимый консультант, преподаватель и модуль записи.</span><span class="sxs-lookup"><span data-stu-id="dca78-290">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="dca78-291">Его последняя книга — *[Sams обучать себя ASP.NET 2,0 за 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* .</span><span class="sxs-lookup"><span data-stu-id="dca78-291">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="dca78-292">Скотт можно получить по адресу [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) или через свой блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/).</span><span class="sxs-lookup"><span data-stu-id="dca78-292">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="dca78-293">Особая благодарность...</span><span class="sxs-lookup"><span data-stu-id="dca78-293">Special Thanks To…</span></span>

<span data-ttu-id="dca78-294">Эта серия руководств была рассмотрена многими полезными рецензентами.</span><span class="sxs-lookup"><span data-stu-id="dca78-294">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="dca78-295">Хотите ознакомиться с моими будущими статьями MSDN?</span><span class="sxs-lookup"><span data-stu-id="dca78-295">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="dca78-296">Если да, расположите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="dca78-296">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="dca78-297">[Назад](recovering-and-changing-passwords-cs.md)
> [Вперед](building-an-interface-to-select-one-user-account-from-many-vb.md)</span><span class="sxs-lookup"><span data-stu-id="dca78-297">[Previous](recovering-and-changing-passwords-cs.md)
[Next](building-an-interface-to-select-one-user-account-from-many-vb.md)</span></span>
