---
uid: web-forms/overview/older-versions-security/introduction/forms-authentication-configuration-and-advanced-topics-vb
title: Настройка проверки подлинности с помощью форм и дополнительные разделы (VB) | Документация Майкрософт
author: rick-anderson
description: В этом учебнике мы рассмотрим различные параметры проверки подлинности на основе форм и посмотрим, как их изменять с помощью элемента Forms. Это влечет за собой подробные сведения...
ms.author: riande
ms.date: 01/14/2008
ms.assetid: 829d2f56-5c48-445b-b826-3418a450c788
msc.legacyurl: /web-forms/overview/older-versions-security/introduction/forms-authentication-configuration-and-advanced-topics-vb
msc.type: authoredcontent
ms.openlocfilehash: 4d77816a489a4fa16cd70ec4214cd2f8ee563029
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74632012"
---
# <a name="forms-authentication-configuration-and-advanced-topics-vb"></a>Настройка проверки подлинности на основе форм и дополнительные разделы (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/ASPNET_Security_Tutorial_03_VB.zip) или [скачать PDF](https://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/aspnet_tutorial03_AuthAdvanced_vb.pdf)

> В этом учебнике мы рассмотрим различные параметры проверки подлинности на основе форм и посмотрим, как их изменять с помощью элемента Forms. Это влечет за собой подробный обзор настройки значения времени ожидания билета проверки подлинности на основе форм, использование страницы входа с настраиваемым URL-адресом (например, SignIn. aspx вместо login. aspx) и билетами проверки подлинности форм без файлов cookie.

## <a name="introduction"></a>Введение

В [предыдущем учебном курсе](an-overview-of-forms-authentication-vb.md) были рассмотрены шаги, необходимые для реализации проверки подлинности с помощью форм в приложении ASP.NET, от указания параметров конфигурации в файле Web. config до создания страницы входа для отображения другого содержимого для проверки подлинности и анонимных пользователей. Помните, что мы настроили веб-сайт для использования проверки подлинности с помощью форм, установив атрибут mode элемента&gt; проверки подлинности &lt;в Forms. Элемент&gt; проверки подлинности &lt;может содержать дочерний элемент &lt;Forms&gt;, через который можно указать набор параметров проверки подлинности с помощью форм.

В этом учебнике мы рассмотрим различные параметры проверки подлинности на основе форм и изучим их изменение с помощью элемента &lt;Forms&gt;. Это влечет за собой подробный обзор настройки значения времени ожидания билета проверки подлинности на основе форм, использование страницы входа с настраиваемым URL-адресом (например, SignIn. aspx вместо login. aspx) и билетами проверки подлинности форм без файлов cookie. Мы также рассмотрим описывающего билета проверки подлинности с помощью форм и посмотрим, что меры предосторожности ASP.NET гарантируют, что данные билета защищены от проверки и изменения. Наконец, мы рассмотрим, как хранить дополнительные данные пользователя в билете проверки подлинности на основе форм и как моделировать эти данные с помощью пользовательского объекта Principal.

## <a name="step-1-examining-the-ltformsgt-configuration-settings"></a>Шаг 1. Проверка &lt;Forms&gt; параметров конфигурации

Система проверки подлинности форм в ASP.NET предлагает ряд параметров конфигурации, которые можно настроить отдельно для каждого приложения. Сюда входят такие параметры, как: время существования билета проверки подлинности форм; какой тип защиты применяется к билету; при условии, что используются билеты проверки подлинности без поддержки файлов cookie; путь к странице входа; и другие сведения. Чтобы изменить значения по умолчанию, добавьте [элемент&lt;forms&gt;](https://msdn.microsoft.com/library/1d3t3c61.aspx) в качестве дочернего элемента [&lt;&gt; проверки подлинности](https://msdn.microsoft.com/library/532aee0e.aspx), указав значения этих свойств, которые нужно настроить в качестве атрибутов XML следующим образом:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample1.xml)]

В таблице 1 приведены сводные сведения о свойствах, которые можно настроить с помощью элемента &lt;Forms&gt;. Так как файл Web. config является XML-файлом, в именах атрибутов в левом столбце учитывается регистр.

| <strong>Attribute (XElement Dynamic Property)</strong> (Attribute (динамическое свойство XElement)) |                                                                                                                                                                                                                                     <strong>Описание</strong>                                                                                                                                                                                                                                      |
|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|         сеансов         |                                                                                                                Этот атрибут указывает, при каких условиях билет проверки подлинности хранится в файле cookie и не внедряется в URL-адрес. Допустимые значения: Усекукиес; Усеури; Автообнаружение и Уседевицепрофиле (значение по умолчанию). Шаг 2 подробно рассматривает этот параметр.                                                                                                                |
|         дефаултурл         |                                                                                                                                                         Указывает URL-адрес, на который пользователи перенаправляются после входа со страницы входа, если в строке запроса не указано значение RedirectUrl. Значение по умолчанию — Default. aspx.                                                                                                                                                         |
|           домен           | При использовании билетов проверки подлинности на основе файлов cookie этот параметр указывает значение домена cookie s. Значение по умолчанию — пустая строка, которая заставляет браузер использовать домен, из которого он был выдан (например, www.yourdomain.com). В этом случае файл cookie <strong>не</strong> будет отправляться при выполнении запросов к поддоменам, таким как admin.yourdomain.com. Если вы хотите, чтобы файл cookie передавался во все поддомены, необходимо настроить атрибут домена, указав для него значение yourdomain.com. |
|  енаблекроссаппредиректс   |                                                                                                                                                                   Логическое значение, указывающее, запоминаются ли пользователи, прошедшие проверку подлинности, при перенаправлении на URL-адреса других веб-приложений на том же сервере. Значение по умолчанию: false.                                                                                                                                                                   |
|          логинурл          |                                                                                                                                                                                                                      URL-адрес страницы входа. Значение по умолчанию — Login. aspx.                                                                                                                                                                                                                      |
|            name            |                                                                                                                                                                                                   При использовании билетов проверки подлинности на основе файлов cookie имя файла cookie. Значение по умолчанию —. АСПКСАУС.                                                                                                                                                                                                   |
|            path            |                                                                             При использовании билетов проверки подлинности на основе файлов cookie этот параметр указывает атрибут пути к файлу cookie. Атрибут Path позволяет разработчику ограничить область файла cookie определенной иерархией каталогов. Значение по умолчанию —/, которое информирует браузер о необходимости отправить файл cookie билета проверки подлинности в любой запрос, сделанный в домене.                                                                              |
|         защита         |                                                                                                                                            Указывает, какие методы используются для защиты билета проверки подлинности с помощью форм. Допустимые значения: ALL (по умолчанию); Ключ None и проверки. Эти параметры подробно описаны на шаге 3.                                                                                                                                            |
|         requireSSL         |                                                                                                                                                                                Логическое значение, указывающее, требуется ли SSL-соединение для передачи файла cookie проверки подлинности. Значение по умолчанию — false.                                                                                                                                                                                |
|     slidingExpiration      |                                                                                                 Логическое значение, указывающее, будет ли время ожидания для файла cookie проверки подлинности сбрасываться каждый раз, когда пользователь посещает сайт в течение одного сеанса. Значение по умолчанию — true. Политика времени ожидания билета проверки подлинности обсуждается более подробно в разделе Указание значения времени ожидания билета s.                                                                                                 |
|          timeout           |                                                                                                                               Указывает время в минутах, по истечении которого срок действия файла cookie билета проверки подлинности истекает. Значение по умолчанию — 30. Политика времени ожидания билета проверки подлинности обсуждается более подробно в разделе Указание значения времени ожидания билета s.                                                                                                                               |

**Таблица 1**. сводка по &lt;forms&gt; атрибутов элемента

В ASP.NET 2,0 и более поздних версиях значения проверки подлинности форм по умолчанию жестко запрограммированы в классе Формсаусентикатионконфигуратион в .NET Framework. Любые изменения должны быть применены к отдельным приложениям в файле Web. config. Это отличается от ASP.NET 1. x, где значения проверки подлинности форм по умолчанию хранились в файле Machine. config (и поэтому могут быть изменены с помощью редактирования Machine. config). Хотя в разделе ASP.NET 1. x стоит упомянуть, что ряд параметров системы проверки подлинности с помощью форм имеет разные значения по умолчанию в ASP.NET 2,0 и более поздних, чем в ASP.NET 1. x. При переносе приложения из среды ASP.NET 1. x важно помнить об этих различиях. Список различий см. [в &lt;forms&gt; элемент технической документации](https://msdn.microsoft.com/library/1d3t3c61.aspx) .

> [!NOTE]
> Несколько параметров проверки подлинности с помощью форм, таких как время ожидания, домен и путь, указывают сведения о результирующем файле cookie билета проверки подлинности форм. Дополнительные сведения о файлах cookie, их работе и их различных свойствах см. в [руководстве по файлам cookie](http://www.quirksmode.org/js/cookies.html).

### <a name="specifying-the-tickets-timeout-value"></a>Указание значения времени ожидания билета

Билет проверки подлинности форм — это маркер, представляющий удостоверение. При использовании билетов проверки подлинности на основе файлов cookie этот маркер хранится в виде файла cookie и отправляется на веб-сервер при каждом запросе. Владение маркером, по сути, *объявляет, я*уже вошел в систему и используется, чтобы удостоверение пользователя можно было запомнить при посещении страницы.

Билет проверки подлинности на формах содержит не только удостоверение пользователя, но и сведения, помогающие обеспечить целостность и безопасность маркера. В конце концов, мы не хотим, чтобы злостный пользователь мог создать контрафактный маркер или изменить незаконный токен.

Одним из таких сведений, включенных в билет, является *срок действия*, то есть дата и время, когда билет больше не действителен. Каждый раз, когда FormsAuthenticationModule проверяет билет проверки подлинности, он гарантирует, что срок действия билета еще не прошел. Если он есть, он не учитывает билет и определяет пользователя как анонимный. Эта мера защиты помогает защититься от атак с использованием воспроизведения. Без истечения срока действия, если злоумышленнику удалось получить доступ к допустимому билету проверки подлинности пользователя, возможно, путем получения физического доступа к своему компьютеру и его корневого каталога с помощью файлов cookie, они могли бы отправить запрос на сервер с помощью этого украденного билета проверки подлинности и получить запись. Хотя срок действия не мешает этому сценарию, он ограничивает окно, в течение которого такая атака может быть выполнена.

> [!NOTE]
> Шаг 3. сведения о дополнительных методах, используемых системой проверки подлинности форм для защиты билета проверки подлинности.

При создании билета аутентификации система проверки подлинности форм определяет срок ее действия, выдавая параметр времени ожидания. Как указано в табл. 1, значение времени ожидания по умолчанию равно 30 минутам. Это означает, что при создании билета проверки подлинности на форме в будущем задается Дата и время в 30 минут.

Срок действия определяет абсолютное время в будущем при истечении срока действия билета проверки подлинности форм. Но обычно разработчики хотят реализовать скользящий срок действия, который сбрасывается при каждом посещении сайта пользователем. Это поведение определяется параметрами slidingExpiration. Если задано значение true (по умолчанию), при каждой проверке подлинности пользователя FormsAuthenticationModule обновляет срок действия билета. Если задано значение false, срок действия для каждого запроса не обновляется, что приводит к тому, что срок действия билета истекает в течение заданного времени ожидания (в минутах) после создания билета.

> [!NOTE]
> Срок действия, сохраненный в билете проверки подлинности, является абсолютным значением даты и времени, например 2 августа 2008 11:34 AM. Более того, Дата и время зависят от местного времени веб-сервера. Это решение может иметь несколько интересных побочных эффектов, связанных с переходом на летнее время (DST), когда часы в США перемещаются на один час (предполагая, что веб-сервер размещается в языковом стандарте, где наблюдается летнее время). Рассмотрим, что произойдет для веб-сайта ASP.NET с истекшим сроком действия 30 минут в ближайшее время начала летнего времени (2:00 AM). Представьте, что посетитель входит на сайт с 11 марта 2008 по 1:55 AM. Это приведет к формированию билета проверки подлинности форм, срок действия которого истекает 11 марта 2008 в 2:25 AM (30 минут в будущем). Однако один раз в 2:00, часы переходят в 3:00 AM из-за летнего времени. Когда пользователь загружает новую страницу за шесть минут после входа (в 3:01 AM), FormsAuthenticationModule записывает, что срок действия билета истек, и перенаправляет пользователя на страницу входа. Дополнительные сведения об этом и других странностиах времени ожидания билета проверки подлинности, а также обходные пути см. в статье копия Стефан Шаков ( *Security Professional ASP.NET 2,0, членство и управление ролями* (ISBN: 978-0-7645-9698-8).

На рис. 1 показан рабочий процесс, когда slidingExpiration имеет значение false, а для параметра timeout — значение 30. Обратите внимание, что билет проверки подлинности, созданный при входе, содержит дату окончания срока действия, и это значение не обновляется при последующих запросах. Если FormsAuthenticationModule обнаружит, что срок действия билета истек, он отклоняет его и обрабатывает запрос как анонимный.

[![графическое представление срока действия билета проверки подлинности форм, если slidingExpiration имеет значение false](forms-authentication-configuration-and-advanced-topics-vb/_static/image2.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image1.png)

**Рис. 01**. графическое представление срока действия билета проверки подлинности на основе форм, если slidingExpiration имеет значение false ([щелкните, чтобы просмотреть изображение с полным размером](forms-authentication-configuration-and-advanced-topics-vb/_static/image3.png))

На рис. 2 показан рабочий процесс, когда для slidingExpiration установлено значение true, а для параметра timeout — значение 30. При получении запроса, прошедшего проверку подлинности (с неистекшим билетом) срок его действия истекает до времени ожидания в будущем.

[![графическое представление билета проверки подлинности форм, когда slidingExpiration имеет значение true](forms-authentication-configuration-and-advanced-topics-vb/_static/image5.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image4.png)

**Рис. 02**. графическое представление билета проверки подлинности форм, когда slidingExpiration имеет значение true ([щелкните, чтобы просмотреть изображение с полным размером](forms-authentication-configuration-and-advanced-topics-vb/_static/image6.png))

При использовании билетов проверки подлинности на основе файлов cookie (по умолчанию) это обсуждение станет немного запутанным, так как для файлов cookie также могут быть заданы собственные сроки действия. Срок действия файла cookie (или его отсутствие) указывает браузеру на необходимость уничтожения файла cookie. Если у файла cookie отсутствует срок действия, он уничтожается при завершении работы браузера. Однако если срок действия истекает, файл cookie сохраняется на компьютере пользователя до тех пор, пока не будет пройдена Дата и время, указанные в параметре срока действия. Когда файл cookie уничтожается браузером, он больше не отправляется на веб-сервер. Таким образом, уничтожение файла cookie аналогично выходу пользователя из сайта.

> [!NOTE]
> Конечно, пользователь может заранее удалить все файлы cookie, хранящиеся на их компьютере. В Internet Explorer 7 перейдите в меню Сервис, параметры и нажмите кнопку Удалить в разделе журнал браузера. После этого нажмите кнопку Удалить файлы cookie.

Система проверки подлинности форм создает файлы cookie на основе сеанса или на основе срока действия в зависимости от значения, переданного в параметр *персисткукие* . Помните, что методы Жетаускукие, Сетаускукие и RedirectFromLoginPage класса FormsAuthentication принимают два входных параметра: *username* и *персисткукие*. Страница входа, созданная в предыдущем учебнике, включала флажок "Запомнить мои данные", который определяет, был ли создан сохраняемый файл cookie. Срок действия постоянных файлов cookie истекает; непостоянные файлы cookie — это сеансы на основе сеансов.

Уже обсуждаемые концепции timeout и slidingExpiration применяются и к файлам cookie, основанным на сеансах, и по истечении срока действия. Существует только одно небольшое различие в выполнении: при использовании файлов cookie с истекшим сроком действия с Слидингтимеаут, для которых задано значение true, срок действия файла cookie обновляется только в случае истечения половины указанного времени.

Давайте изменим политики времени ожидания билета проверки подлинности для веб-сайта, чтобы время ожидания билетов истекло через один час (60 минут) с использованием скользящего срока действия. Чтобы это изменение вступили в действие, обновите файл Web. config, добавив элемент &lt;Forms&gt; в элемент &lt;&gt; проверки подлинности со следующей разметкой:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample2.xml)]

### <a name="using-an-login-page-url-other-than-loginaspx"></a>Использование URL-адреса страницы входа, отличной от Login. aspx

Так как FormsAuthenticationModule автоматически перенаправляет неавторизованных пользователей на страницу входа, ему необходимо указать URL-адрес страницы входа. Этот URL-адрес задается атрибутом Логинурл в элементе &lt;Forms&gt; и по умолчанию используется имя входа. aspx. Если выполняется перенос по существующему веб-сайту, возможно, у вас уже есть страница входа с другим URL-адресом, которая уже была помечена и проиндексирована поисковых машин. Вместо переименования существующей страницы входа в систему Login. aspx и разрыва ссылок и закладок пользователей можно изменить атрибут Логинурл, чтобы он указывал на страницу входа.

Например, если страница входа называется Signing. aspx и находится в каталоге Users, можно указать параметру конфигурации Логинурл значение ~/Усерс/сигнин.аспкс следующим образом:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample3.xml)]

Так как у текущего приложения уже есть страница входа с именем Login. aspx, нет необходимости указывать пользовательское значение в элементе &lt;Forms&gt;.

## <a name="step-2-using-cookieless-forms-authentication-tickets"></a>Шаг 2. Использование билетов проверки подлинности с помощью форм без файлов cookie

По умолчанию система проверки подлинности форм определяет, следует ли сохранять билеты проверки подлинности в коллекции cookies или внедрять их в URL-адрес на основе агента пользователя, который посещает сайт. Все распространенные браузеры настольных систем, такие как Internet Explorer, Firefox, Opera и Safari, поддерживают файлы cookie, но не все мобильные устройства.

Политика файлов cookie, используемая системой проверки подлинности форм, зависит от параметра без файлов cookie в элементе &lt;Forms&gt;, которому можно назначить одно из четырех значений:

- Усекукиес — указывает, что всегда будут использоваться билеты проверки подлинности на основе файлов cookie.
- Усеури — указывает, что билеты проверки подлинности на основе файлов cookie никогда не используются.
- Автообнаружение. Если профиль устройства не поддерживает файлы cookie, билеты проверки подлинности на основе файлов cookie не используются. Если профиль устройства поддерживает файлы cookie, для определения того, включены ли файлы cookie, используется механизм проверки.
- Уседевицепрофиле — значение по умолчанию; использует билеты проверки подлинности на основе файлов cookie, только если профиль устройства поддерживает файлы cookie. Механизм зондирования не используется.

Параметры автоопределения и Уседевицепрофиле используют *профиль устройства* , чтобы определить, следует ли использовать билеты проверки подлинности без поддержки файлов cookie или файлов cookie. ASP.NET поддерживает базу данных различных устройств и их возможности, например, поддерживают ли они файлы cookie, какую версию JavaScript поддерживает и т. д. Каждый раз, когда устройство запрашивает веб-страницу с веб-сервера, он отправляет через HTTP *-заголовок агента пользователя* , который определяет тип устройства. ASP.NET автоматически сопоставляет указанную строку агента пользователя с соответствующим профилем, указанным в его базе данных.

> [!NOTE]
> Эта база данных возможностей устройства хранится в виде нескольких XML-файлов, которые соответствуют [схеме файла определения браузера](https://msdn.microsoft.com/library/ms228122.aspx). Файлы профиля устройства по умолчанию находятся в папке%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG\Browsers. Вы также можете добавить пользовательские файлы в папку приложений\_Browsers приложения. Дополнительные сведения см. [в разделе руководство. обнаружение типов браузеров в веб-страницы ASP.NET](https://msdn.microsoft.com/library/3yekbd5b.aspx).

Поскольку значение по умолчанию — Уседевицепрофиле, билеты проверки подлинности форм без файлов cookie будут использоваться при посещении сайта устройством, профиль которого сообщает, что он не поддерживает файлы cookie.

### <a name="encoding-the-authentication-ticket-in-the-url"></a>Кодирование билета проверки подлинности в URL-адресе

Файлы cookie являются естественным носителем для включения информации из браузера в каждый запрос к определенному веб-сайту, поэтому по умолчанию параметры проверки подлинности на основе форм используют файлы cookie, если на посещение устройства они поддерживаются. Если файлы cookie не поддерживаются, необходимо использовать альтернативные средства для передачи билета проверки подлинности от клиента на сервер. Распространенный обходной путь, используемый в средах без файлов cookie, заключается в кодировании данных cookie в URL-адресе.

Чтобы увидеть, как подобная информация может быть внедрена в URL-адрес, рекомендуется принудительно использовать билеты проверки подлинности без поддержки файлов cookie. Это можно сделать, задав для параметра конфигурации без файлов cookie значение Усеури:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample4.xml)]

После внесения этого изменения посетите сайт в браузере. При посещении в качестве анонимного пользователя URL-адреса будут выглядеть точно так же, как и раньше. Например, при посещении страницы Default. aspx в адресной строке моего браузера отображается следующий URL-адрес:

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/default.aspx`

Однако при входе в систему билет проверки подлинности форм внедряется в URL-адрес. Например, после посещения страницы входа и входа в систему как SAM я вернулся на страницу Default. aspx, но URL-адрес этого времени:

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/(F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2))/default.aspx`

Билет проверки подлинности форм был внедрен в URL-адрес. Строка (F (jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-Фималксжфов\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2) представляет сведения о билете проверки подлинности в шестнадцатеричной кодировке и — это те же данные, которые обычно хранятся в файле cookie.

Чтобы билеты проверки подлинности без файлов cookie работали, система должна кодировать все URL-адреса на странице, чтобы включить данные билета проверки подлинности, в противном случае билет проверки подлинности будет потерян, когда пользователь щелкнет ссылку. К счастью, эта логика внедрения выполняется автоматически. Чтобы продемонстрировать эту функцию, откройте страницу Default. aspx и добавьте элемент управления HyperLink, задав его свойства Text и NavigateUrl для Test Link и Сомепаже. aspx соответственно. Не имеет значения, что в нашем проекте нет страницы с именем Сомепаже. aspx.

Сохраните изменения в файле Default. aspx, а затем откройте его в браузере. Войдите на сайт, чтобы билет проверки подлинности форм был внедрен в URL-адрес. Затем из default. aspx щелкните ссылку проверить ссылку. В чем дело? Если страница с именем Сомепаже. aspx не существует, то произошла ошибка 404, но это не так важно. Вместо этого Обратите внимание на адресную строку в браузере. Обратите внимание, что он содержит билет проверки подлинности форм в URL-адресе.

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/(F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2))/SomePage.aspx`

URL-адрес Сомепаже. aspx в ссылке был автоматически преобразован в URL-адрес, включающий билет проверки подлинности. нам не пришлось писать строчку кода! Билет проверки подлинности формы будет автоматически внедрен в URL-адрес для любых гиперссылок, которые не начинаются с http://или/. Не имеет значения, отображается ли гиперссылка при вызове метода Response. Redirect, в элементе управления HyperLink или в элементе HTML привязки (т. е. &lt;a href = "..."&gt;...&lt;/a&gt;). При условии, что URL-адрес не http://www.someserver.com/SomePage.aspx или/Сомепаже.аспкс, билет проверки подлинности форм будет внедрен для нас.

> [!NOTE]
> Билеты проверки подлинности в формах без файлов cookie соответствуют тем же политикам времени ожидания, что и билеты проверки подлинности на основе файлов cookie. Однако билеты проверки подлинности без файлов cookie более подвержены атакам с целью воспроизведения, так как билет проверки подлинности внедряется непосредственно в URL-адрес. Представьте себе пользователя, который посещает веб-сайт, войдет в систему и вставит URL-адрес в электронное письмо коллеге. Если коллега щелкнет эту ссылку до истечения срока действия, он будет зарегистрирован в качестве пользователя, отправившего сообщение.

## <a name="step-3-securing-the-authentication-ticket"></a>Шаг 3. обеспечение безопасности билета проверки подлинности

Билет проверки подлинности на основе форм передается по каналу в файле cookie или внедряется непосредственно в URL-адрес. Кроме сведений об удостоверениях, билет проверки подлинности также может содержать данные пользователя (как будет показано на шаге 4). Следовательно, важно, чтобы данные билета были зашифрованы от любопытныхных глаз и (еще важнее), что система проверки подлинности форм может гарантировать, что билет не был изменен.

Чтобы обеспечить конфиденциальность данных билета, система проверки подлинности форм может зашифровать данные билета. Сбой шифрования данных билета отправляет потенциально конфиденциальную информацию по каналу в виде обычного текста.

Чтобы гарантировать подлинность билета, система проверки подлинности форм должна *проверить* билет. Проверка является гарантией того, что конкретный фрагмент данных не был изменен, и выполняется с помощью *[кода проверки подлинности сообщения (Mac)](http://en.wikipedia.org/wiki/Message_authentication_code)* . В двух словах, MAC — это небольшая часть информации, определяющая данные, которые необходимо проверить (в данном случае это билет). Если данные, представленные MAC, изменяются, то MAC и данные не будут совпадать. Более того, злоумышленнику будет трудно изменить данные и создать собственный MAC-адрес для соответствия измененным данным.

При создании (или изменении) билета система проверки подлинности форм создает MAC и прикрепляет его к данным билета. При получении последующего запроса система проверки подлинности форм сравнивает данные MAC и билета для проверки подлинности данных билета. На рис. 3 показан этот рабочий процесс в графическом виде.

[![подлинности билета обеспечивается через MAC](forms-authentication-configuration-and-advanced-topics-vb/_static/image8.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image7.png)

**Рис. 03**. Проверка подлинности билета обеспечивается через Mac ([щелкните, чтобы просмотреть образ полного размера](forms-authentication-configuration-and-advanced-topics-vb/_static/image9.png))

Меры безопасности, применяемые к билету проверки подлинности, зависят от настройки защиты в элементе &lt;Forms&gt;. Параметр защиты может быть назначен одному из следующих трех значений:

- Все — билет зашифрован и имеет цифровую подпись (по умолчанию).
- Применяется шифрование только для шифрования — MAC не создается.
- None — билет не зашифрован или имеет цифровую подпись.
- Проверка — создается MAC-адрес, но данные билета передаются по сети в виде обычного текста.

Корпорация Майкрософт настоятельно рекомендует использовать параметр ALL.

### <a name="setting-the-validation-and-decryption-keys"></a>Настройка ключей проверки и расшифровки

Алгоритмы шифрования и хэширования, используемые системой проверки подлинности форм для шифрования и проверки билета проверки подлинности, можно настраивать с помощью [элемента&lt;machineKey&gt;](https://msdn.microsoft.com/library/w8h3skw9.aspx) в файле Web. config. В таблице 2 приведены атрибуты элемента &lt;machineKey&gt; и их возможные значения.

| **Attribute (XElement Dynamic Property)** (Attribute (динамическое свойство XElement)) | **Описание** |
| --- | --- |
| расшифровка | Указывает алгоритм, используемый для шифрования. Этот атрибут может иметь одно из следующих четырех значений:-Auto — значение по умолчанию; Определяет алгоритм на основе длины атрибута Декриптионкэй. -AES — использует алгоритм [AES (AES)](http://en.wikipedia.org/wiki/Advanced_Encryption_Standard) . -DES — использует [стандарт шифрования данных (DES)](http://en.wikipedia.org/wiki/Data_Encryption_Standard) . Этот алгоритм считается ненадежным для вычислений и не должен использоваться. -3DES — использует алгоритм [Triple DES](http://en.wikipedia.org/wiki/Triple_DES) , который работает в три раза, применяя алгоритм DES. |
| декриптионкэй | Секретный ключ, используемый алгоритмом шифрования. Это значение должно быть шестнадцатеричной строкой соответствующей длины (в зависимости от значения в расшифровании), автогенерации или любого значения с добавлением, IsolateApps. Добавление IsolateApps указывает ASP.NET использовать уникальное значение для каждого приложения. Значение по умолчанию — Автоформирование, IsolateApps. |
| проверка | Указывает алгоритм, используемый для проверки. Этот атрибут может иметь одно из следующих четырех значений:-AES-использует алгоритм AES (AES). -MD5 — использует алгоритм [Message-Digest 5 (MD5)](http://en.wikipedia.org/wiki/MD5) . -SHA1 — использует алгоритм [SHA1](http://en.wikipedia.org/wiki/Sha1) (по умолчанию). -3DES — использует алгоритм Triple DES. |
| валидатионкэй | Секретный ключ, используемый алгоритмом проверки. Это значение должно быть шестнадцатеричной строкой соответствующей длины (в зависимости от значения в проверке), автоматическим созданием или любым из значений, добавленных с помощью, IsolateApps. Добавление IsolateApps указывает ASP.NET использовать уникальное значение для каждого приложения. Значение по умолчанию — Автоформирование, IsolateApps. |

**Таблица 2**. атрибуты элемента &lt;machineKey&gt;

Подробное обсуждение этих вариантов шифрования и проверки, а также достоинств и недостатков различных алгоритмов выходит за рамки этого руководства. Подробные сведения об этих проблемах, в том числе рекомендации по использованию алгоритмов шифрования и проверки, используемых ключей, а также рекомендации по созданию этих ключей, см. в статье *профессиональная ASP.NET 2,0 Security, Membership и Role Management*.

По умолчанию ключи, используемые для шифрования и проверки, создаются автоматически для каждого приложения, и эти ключи хранятся в локальном центре безопасности (LSA). Вкратце, параметры по умолчанию гарантируют уникальность ключей на веб-сервере, а также на уровне приложений. Следовательно, это поведение по умолчанию не будет работать в двух следующих сценариях:

- **Веб** -фермы — в сценарии [веб-фермы](http://en.wikipedia.org/wiki/Web_farm) одно веб-приложение размещается на нескольких веб-серверах в целях масштабируемости и избыточности. Каждый входящий запрос отправляется на сервер в ферме, то есть в течение времени существования сеанса пользователя разные серверы могут обрабатывать различные запросы. Следовательно, каждый сервер должен использовать одинаковые ключи шифрования и проверки, чтобы билет проверки подлинности форм, созданный, зашифрованный и проверенный на одном сервере, можно было расшифровать и проверить на другом сервере в ферме.
- **Совместное использование билета между приложениями** . на одном веб-сервере может размещаться несколько ASP.NET приложений. Если вам необходимо, чтобы эти приложения совместно используют один билет проверки подлинности с помощью форм, обязательно сопоставьте ключи шифрования и проверки.

При работе с параметром веб-фермы или совместном использовании билетов проверки подлинности в приложениях на одном сервере необходимо настроить элемент &lt;machineKey&gt; в затронутых приложениях таким образом, чтобы значения Декриптионкэй и Валидатионкэй совпадали.

Хотя ни один из описанных выше сценариев не применяется к нашему примеру приложения, мы можем указать явные значения Декриптионкэй и Валидатионкэй и определить используемые алгоритмы. Добавьте параметр &lt;machineKey&gt; в файл Web. config:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample5.xml)]

Дополнительные сведения см. в [инструкции по настройке machineKey в ASP.NET 2,0](https://msdn.microsoft.com/library/ms998288.aspx).

> [!NOTE]
> Значения Декриптионкэй и Валидатионкэй были взяты из [веб-страницы с превосходными паролями](https://www.grc.com/passwords.htm) [Стива Гибсона](http://www.grc.com/stevegibson.htm), которая создает 64 случайных шестнадцатеричных символов на каждом посещении страницы. Чтобы уменьшить вероятность того, что эти ключи переносятся в рабочие приложения, рекомендуется заменить приведенные выше ключи на страницы, созданные случайным образом, на странице «идеальные пароли».

## <a name="step-4-storing-additional-user-data-in-the-ticket"></a>Шаг 4. сохранение дополнительных данных пользователя в билете

Во многих веб-приложениях отображается информация о странице и ее отображение для текущего пользователя. Например, на веб-странице может отображаться имя пользователя и Дата последнего входа в верхний угол каждой страницы. Билет проверки подлинности на основе форм хранит имя пользователя, выполнившего вход в систему, но если требуются другие сведения, страница должна попасть в хранилище пользователя — обычно это база данных для поиска информации, не хранящейся в билете проверки подлинности.

С небольшой частью кода мы можем хранить дополнительную информацию о пользователях в билете проверки подлинности с помощью форм. Такие данные могут быть выражены с помощью [свойства UserData](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.userdata.aspx) [класса формсаусентикатионтиккет](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.aspx). Это полезное место для размещения небольших объемов сведений о пользователе, который часто требуется. Значение, указанное в свойстве UserData, включается как часть файла cookie билета проверки подлинности, а, как и другие поля билетов, шифруется и проверяется на основе конфигурации системы проверки подлинности форм. По умолчанию UserData является пустой строкой.

Чтобы сохранить данные пользователя в билете проверки подлинности, необходимо написать небольшой код на странице входа, который извлекает сведения о пользователе и сохраняет их в билете. Так как UserData является свойством типа String, хранящиеся в нем данные должны быть правильно сериализованы как строка. Например, представьте, что наш магазин пользователей включал дату рождения каждого пользователя и имя своего работодателя, и мы хотели сохранить эти два значения свойств в билете проверки подлинности. Можно сериализовать эти значения в строку путем сцепления даты рождения пользователя с каналом (|), за которым следует имя работодателя. Для пользователя, выпущенного 15 августа 1974, который работает для компании Northwind Traders, мы присваиваем свойству UserData строку: 1974-08-15 | Борей.

Когда нам нужно получить доступ к данным, хранящимся в билете, мы можем сделать это, заменив Формсаусентикатионтиккет текущего запроса и выполнив десериализацию свойства UserData. В примере даты рождения и имени работодателя мы разделит строку UserData на две подстроки на основе разделителя (|).

[![дополнительные сведения о пользователе можно хранить в билете проверки подлинности.](forms-authentication-configuration-and-advanced-topics-vb/_static/image11.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image10.png)

**Рис. 04**. Дополнительные сведения о пользователе можно хранить в билете проверки подлинности ([щелкните, чтобы просмотреть изображение с полным размером](forms-authentication-configuration-and-advanced-topics-vb/_static/image12.png))

### <a name="writing-information-to-userdata"></a>Запись сведений в UserData

К сожалению, Добавление сведений о пользователе в билет проверки подлинности на основе форм не так просто, как может показаться. Свойство UserData класса Формсаусентикатионтиккет доступно только для чтения и может быть задано только с помощью конструктора класса Формсаусентикатионтиккет. При указании свойства UserData в конструкторе также необходимо предоставить другие значения билета: имя пользователя, Дата выпуска, срок действия и т. д. Когда мы создали страницу входа в предыдущем руководстве, все было обработано для нас классом FormsAuthentication. При добавлении UserData в Формсаусентикатионтиккет необходимо написать код для репликации большей части функций, уже предоставляемых классом FormsAuthentication.

Давайте рассмотрим необходимый код для работы с UserData, обновив страницу Login. aspx, чтобы записать дополнительные сведения о пользователе в билет проверки подлинности. Представьте, что магазин пользователей содержит информацию о компании, в которой работает пользователь, и ее название, и что мы хотим записать эти сведения в билет проверки подлинности. Обновите обработчик событий Логинбуттон Click на странице login. aspx, чтобы код выглядел следующим образом:

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample6.vb)]

Давайте проверим этот код по одной строке за раз. Метод начинается с определения четырех массивов строк: Users, Passwords, companyName и Титлеаткомпани. Эти массивы содержат имена пользователей, пароли, названия компаний и заголовки для учетных записей пользователей в системе, в которых есть три: Скотт, Цзисунь и SAM. В реальных приложениях эти значения будут запрашиваться из хранилища пользователя, а не жестко запрограммированы в исходном коде страницы.

В предыдущем учебнике, если предоставленные учетные данные были допустимыми, мы просто назвали FormsAuthentication. RedirectFromLoginPage (UserName. Text, RememberMe. Checked), которые выполнили следующие действия:

1. Создан билет проверки подлинности форм
2. Записал билет в соответствующее хранилище. Для билетов проверки подлинности на основе файлов cookie используется коллекция файлов cookie браузера. для билетов проверки подлинности без файлов cookie данные билета сериализуются в URL-адрес.
3. Перенаправляет пользователя на соответствующую страницу

Эти шаги реплицируются в приведенном выше коде. Во-первых, строка, которая в конечном итоге будет храниться в свойстве UserData, сохранится путем объединения названия и названия компании, разделяющих эти значения символом вертикальной черты (|).

Dim Усердатастринг As String = String. Concat (companyName (i), "|", Титлеаткомпани (i))

Затем вызывается метод FormsAuthentication. Жетаускукие, который создает билет проверки подлинности, шифрует и проверяет его в соответствии с параметрами конфигурации и помещает его в объект HttpCookie.

Dim Аускукие AS HttpCookie = FormsAuthentication. Жетаускукие (имя_пользователя. Text, RememberMe. Checked)

Чтобы работать с Формаусентикатионтиккет, внедренными в файл cookie, необходимо вызвать [метод дешифровки](https://msdn.microsoft.com/library/system.web.security.formsauthentication.decrypt.aspx)класса формаусентикатион, передав значение cookie.

Dim Ticket AS Формсаусентикатионтиккет = FormsAuthentication. дешифровки (Аускукие. Value)

Затем мы создадим *Новый* экземпляр формсаусентикатионтиккет на основе существующих значений формсаусентикатионтиккет. Однако этот новый билет включает сведения, относящиеся к пользователю (Усердатастринг).

Dim Невтиккет AS Формсаусентикатионтиккет = New Формсаусентикатионтиккет (билет. Версия, билет. Имя, билет. Иссуедате, билет. Срок действия, билет. Persistent, Усердатастринг)

Затем мы шифруют (и проверяйте) новый экземпляр Формсаусентикатионтиккет, вызывая [метод Encrypt](https://msdn.microsoft.com/library/system.web.security.formsauthentication.encrypt.aspx), и помещаю эти зашифрованные (и проверенные) данные обратно в аускукие.

Аускукие. Value = FormsAuthentication. Encrypt (Невтиккет)

Наконец, Аускукие добавляется в коллекцию Response. cookies и вызывается метод Жетредиректурл для определения соответствующей страницы для отправки пользователя.

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample7.vb)]

Весь этот код необходим, так как свойство UserData доступно только для чтения, а класс FormsAuthentication не предоставляет методов для указания сведений о UserData в своих методах Жетаускукие, Сетаускукие или RedirectFromLoginPage.

> [!NOTE]
> Только что проверенный код хранит сведения о пользователе в билете проверки подлинности на основе файлов cookie. Классы, отвечающие за сериализацию билета проверки подлинности форм на URL-адрес, являются внутренними для .NET Framework. Короткая история, не позволяет хранить данные пользователя в билете проверки подлинности форм без файлов cookie.

### <a name="accessing-the-userdata-information"></a>Доступ к сведениям о UserData

На этом этапе имя и название организации каждого пользователя хранятся в свойстве "UserData" билета проверки подлинности форм при входе. Эти сведения можно получить из билета проверки подлинности на любой странице, не требуя обращения к хранилищу пользователей. Чтобы продемонстрировать, как эти сведения можно получить из свойства UserData, давайте изменим Default. aspx так, чтобы приветственное сообщение состоять не только из имени пользователя, но и от компании, в которой он работает, и их названия.

В настоящее время Default. aspx содержит панель Аусентикатедмессажепанел с элементом управления Label с именем Велкомебаккмессаже. Эта панель отображается только для пользователей, прошедших проверку подлинности. Обновите код на странице Default. aspx,\_загрузить обработчик событий, чтобы он выглядел следующим образом:

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample8.vb)]

Если параметр Request. IsTrue имеет значение true, то для свойства Text в Велкомебаккмессаже сначала задается значение "Добро пожаловать, *имя пользователя*". Затем свойство User. Identity приводится к объекту FormsIdentity, чтобы можно было получить доступ к базовому Формсаусентикатионтиккет. Получив Формсаусентикатионтиккет, вы десериализуете свойство UserData в название и название компании. Это достигается путем разбиения строки на символ вертикальной черты. Название и название компании отображаются в метке Велкомебаккмессаже.

На рис. 5 показан снимок экрана, отображаемый в действии. При входе в систему как Скотт отображается приветственное сообщение, включающее в себя компанию и заголовок Скотта.

[![отображается название компании пользователя, выполнившего вход в систему, и заголовок](forms-authentication-configuration-and-advanced-topics-vb/_static/image14.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image13.png)

**Рис. 05**. Отображение названия компании и заголовка текущего пользователя ([щелкните, чтобы просмотреть изображение с полным размером](forms-authentication-configuration-and-advanced-topics-vb/_static/image15.png))

> [!NOTE]
> Свойство UserData билета проверки подлинности служит кэшем хранилища пользователей. Как и любой кэш, он должен быть обновлен при изменении базовых данных. Например, если имеется веб-страница, из которой пользователи могут обновлять свой профиль, поля, кэшированные в свойстве UserData, необходимо обновить, чтобы отразить изменения, внесенные пользователем.

## <a name="step-5-using-a-custom-principal"></a>Шаг 5. Использование настраиваемого участника

Для каждого входящего запроса FormsAuthenticationModule пытается проверить подлинность пользователя. Если имеется неистекший билет проверки подлинности, FormsAuthenticationModule присваивает свойству HttpContext. User новый объект GenericPrincipal. Этот объект GenericPrincipal имеет идентификатор типа FormsIdentity, который включает ссылку на билет проверки подлинности с помощью форм. Класс GenericPrincipal содержит минимальную функциональность по определению, необходимую классу, реализующему IPrincipal. он просто имеет свойство Identity и метод IsInRole.

Объект Principal имеет две обязанности: для указания ролей, к которым принадлежит пользователь, и для предоставления сведений об удостоверениях. Это осуществляется с помощью метода IsInRole (*roleName*) интерфейса IPrincipal и свойства Identity соответственно. Класс GenericPrincipal позволяет указать строковый массив имен ролей с помощью конструктора. его метод IsInRole (*roleName*) просто проверяет, существует ли переданный объект *roleName* в массиве строк. Когда FormsAuthenticationModule создает GenericPrincipal, он передает в конструктор GenericPrincipal пустой строковый массив. Следовательно, любой вызов IsInRole всегда возвратит значение false.

Класс GenericPrincipal соответствует потребностям большинства сценариев проверки подлинности на основе форм, в которых роли не используются. В тех случаях, когда обработка ролей по умолчанию недостаточна или необходимо связать пользовательский объект IIdentity с пользователем, можно создать пользовательский объект IPrincipal во время рабочего процесса проверки подлинности и назначить его свойству HttpContext. User.

> [!NOTE]
> Как мы будем видеть в следующих учебных курсах, когда ASP. Инфраструктура ролей NET включена. она создает пользовательский объект Principal типа [ролепринЦипал](https://msdn.microsoft.com/library/system.web.security.roleprincipal.aspx) и перезаписывает объект GenericPrincipal, созданный с помощью проверки подлинности Forms. Это делается для того, чтобы настроить метод IsInRole субъекта для взаимодействия с API инфраструктуры ролей.

Так как мы не работаем с ролями, единственная причина, по которой нам нужно создать настраиваемый участник на этом присоединении к, — связать пользовательский объект IIdentity с участником. На шаге 4 мы рассматривали сохранение дополнительных сведений о пользователе в свойстве UserData билета проверки подлинности, в частности название компании пользователя и его название. Однако сведения о UserData доступны только через билет проверки подлинности и затем только в виде сериализованной строки. Это означает, что в любой момент, когда нужно просмотреть сведения о пользователе, хранящиеся в билете, необходимо проанализировать свойство UserData.

Мы можем улучшить взаимодействие с разработчиками, создав класс, который реализует IIdentity и включает свойства CompanyName и Title. Таким образом, разработчик может получить доступ к имени компании и заголовку текущего пользователя непосредственно через свойства CompanyName и Title без необходимости знать, как анализировать свойство UserData.

### <a name="creating-the-custom-identity-and-principal-classes"></a>Создание пользовательских удостоверений и классов-участников

В этом руководстве мы создадим пользовательские объекты Principal и Identity в папке приложения\_Code. Для начала добавьте в проект папку с кодом\_приложения. Щелкните правой кнопкой мыши имя проекта в обозреватель решений, выберите пункт Добавить папку ASP.NET и выберите приложение код\_. Папка кода приложения\_является специальной папкой ASP.NET, содержащей файлы классов, относящиеся к веб-сайту.

> [!NOTE]
> Папку кода приложения\_следует использовать только при управлении проектом с помощью модели проекта веб-сайта. Если вы используете [модель проекта веб-приложения](https://msdn.microsoft.com/asp.net/Aa336618.aspx), создайте стандартную папку и добавьте в нее классы. Например, можно добавить новую папку с именем classes и поместить в нее код.

Затем добавьте два новых файла класса в папку приложения\_с именем Кустомидентити. vb и одним именем CustomPrincipal. vb.

[![добавить классы Кустомидентити и CustomPrincipal в проект](forms-authentication-configuration-and-advanced-topics-vb/_static/image17.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image16.png)

**Рис. 6**. Добавление классов Кустомидентити и CustomPrincipal в проект ([щелкните, чтобы просмотреть изображение с полным размером](forms-authentication-configuration-and-advanced-topics-vb/_static/image18.png))

Класс Кустомидентити отвечает за реализацию интерфейса IIdentity, который определяет свойства AuthenticationType, Authenticator и Name. Помимо этих обязательных свойств мы заинтересованы предоставлять билет проверки подлинности на основе форм, а также свойства для имени и названия компании пользователя. Введите следующий код в класс Кустомидентити.

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample9.vb)]

Обратите внимание, что класс содержит переменную-член Формсаусентикатионтиккет (\_билет) и что эти сведения должны быть указаны с помощью конструктора. Эти данные билета используются при возврате имени удостоверения; Свойство UserData анализируется для получения значений для свойств CompanyName и Title.

Затем создайте класс CustomPrincipal. Так как мы не будем заниматься ролями на этом присоединении к, конструктор класса CustomPrincipal принимает только объект Кустомидентити; его метод IsInRole всегда возвращает значение false.

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample10.vb)]

### <a name="assigning-a-customprincipal-object-to-the-incoming-requests-security-context"></a>Назначение объекта CustomPrincipal контексту безопасности входящего запроса

Теперь у нас есть класс, который расширяет спецификацию IIdentity по умолчанию для включения свойств CompanyName и Title, а также пользовательского класса Principal, который использует настраиваемое удостоверение. Мы готовы к пошаговому выполнению конвейера ASP.NET и назначению нашего пользовательского объекта Principal контексту безопасности входящего запроса.

Конвейер ASP.NET принимает входящий запрос и обрабатывает его с помощью ряда шагов. На каждом шаге создается определенное событие, которое позволяет разработчикам коснуться конвейера ASP.NET и изменить запрос в определенных точках жизненного цикла. FormsAuthenticationModule, например, ожидает от ASP.NET вызова [события AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), после чего он проверяет входящий запрос на наличие билета проверки подлинности. Если найден билет проверки подлинности, создается объект GenericPrincipal, который назначается свойству HttpContext. User.

После события AuthenticateRequest конвейер ASP.NET вызывает [событие PostAuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.postauthenticaterequest.aspx), где мы можем заменить объект GenericPrincipal, созданный FormsAuthenticationModule, экземпляром нашего объекта CustomPrincipal. На рис. 7 показан этот рабочий процесс.

[![GenericPrincipal заменяется CustomPrincipal в событии Постаусентикатионрекуест](forms-authentication-configuration-and-advanced-topics-vb/_static/image20.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image19.png)

**Рис. 07**. GenericPrincipal заменяется CustomPrincipal в событии Постаусентикатионрекуест ([щелкните, чтобы просмотреть изображение с полным размером](forms-authentication-configuration-and-advanced-topics-vb/_static/image21.png))

Чтобы выполнить код в ответ на событие конвейера ASP.NET, можно либо создать соответствующий обработчик событий в Global. asax, либо создать собственный модуль HTTP. В этом руководстве мы создадим обработчик событий в Global. asax. Начните с добавления Global. asax на веб-сайт. Щелкните правой кнопкой мыши имя проекта в обозреватель решений и добавьте элемент типа глобальный класс приложения с именем Global. asax.

[![добавить файл Global. asax на веб-сайт](forms-authentication-configuration-and-advanced-topics-vb/_static/image23.png)](forms-authentication-configuration-and-advanced-topics-vb/_static/image22.png)

**Рис. 08**. Добавление файла Global. asax на веб-сайт ([щелкните, чтобы просмотреть изображение с полным размером](forms-authentication-configuration-and-advanced-topics-vb/_static/image24.png))

Шаблон Global. asax по умолчанию включает обработчики событий для ряда событий конвейера ASP.NET, включая событие Start, End и [Error](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx), среди прочих. Вы можете удалить эти обработчики событий, так как они не нужны для этого приложения. Событие, которое мы заинтересованы, — это PostAuthenticateRequest. Обновите файл Global. asax, чтобы его разметка наглядела следующим образом:

[!code-aspx[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample11.aspx)]

Приложение\_метод Онпостаусентикатерекуест выполняется каждый раз, когда среда выполнения ASP.NET вызывает событие PostAuthenticateRequest, которое происходит один раз для каждого входящего запроса страницы. Обработчик событий начинает с проверки проверки подлинности пользователя и прошел проверку подлинности с помощью форм. Если да, то создается новый объект Кустомидентити и ему передается билет проверки подлинности текущего запроса в конструкторе. После этого создается объект CustomPrincipal и ему передается только что созданный объект Кустомидентити в своем конструкторе. Наконец, контекст безопасности текущего запроса назначается только что созданному объекту CustomPrincipal.

Обратите внимание, что последний шаг — связывание объекта CustomPrincipal с контекстом безопасности запроса — назначает участнику два свойства: HttpContext. User и Thread. CurrentPrincipal. Эти два назначения необходимы из-за способа обработки контекстов безопасности в ASP.NET. .NET Framework связывает контекст безопасности с каждым выполняющимся потоком; Эти сведения доступны в виде объекта IPrincipal с помощью [свойства CurrentPrincipal](https://msdn.microsoft.com/library/system.threading.thread.currentcontext.aspx) [объекта потока](https://msdn.microsoft.com/library/system.threading.thread.aspx). В этом состоит, что ASP.NET имеет собственную информацию о контексте безопасности (HttpContext. User).

В некоторых сценариях свойство Thread. CurrentPrincipal проверяется при определении контекста безопасности. в других сценариях используется HttpContext. User. Например, в .NET есть функции безопасности, позволяющие разработчикам декларативно определить, какие пользователи или роли могут создавать экземпляры класса или вызывать определенные методы (см. Дополнительные сведения о [добавлении правил авторизации к бизнес-слоям и уровням данных с помощью принЦипалпермиссионаттрибутес](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)). Под ним эти декларативные методы определяют контекст безопасности с помощью свойства Thread. CurrentPrincipal.

В других сценариях используется свойство HttpContext. User. Например, в предыдущем учебном курсе мы использовали это свойство для вывода имени пользователя, выполнившего вход в систему. Очевидно, что необходимо, чтобы сведения о контексте безопасности в свойствах Thread. CurrentPrincipal и HttpContext. User совпадали.

Среда выполнения ASP.NET автоматически синхронизирует эти значения свойств для нас. Однако эта синхронизация выполняется после события AuthenticateRequest, но *до* события PostAuthenticateRequest. Следовательно, при добавлении пользовательского субъекта в событие PostAuthenticateRequest необходимо быть уверенным в том, чтобы вручную назначить метод Thread. CurrentPrincipal или else. CurrentPrincipal и HttpContext. User не синхронизирован. Более подробное обсуждение этой проблемы см. в разделе [context. User и. Thread. CurrentPrincipal](http://leastprivilege.com/2005/11/23/context-user-vs-thread-currentprincipal/) .

### <a name="accessing-the-companyname-and-title-properties"></a>Доступ к свойствам CompanyName и Title

Каждый раз, когда запрос прибывает и отправляется в подсистему ASP.NET, будет срабатывать обработчик событий Application\_Онпостаусентикатерекуест в Global. asax. Если запрос успешно прошел проверку подлинности с помощью FormsAuthenticationModule, обработчик событий создаст новый объект CustomPrincipal с объектом Кустомидентити на основе билета проверки подлинности с помощью форм. Благодаря этой логике доступ к сведениям о названии и названии компании пользователя, вошедшего в систему, чрезвычайно прост.

Вернитесь на страницу\_загрузки обработчика событий в файле Default. aspx, где на шаге 4 мы написали код для получения билета проверки подлинности формы и анализа свойства UserData для отображения имени и названия компании пользователя. Если объекты CustomPrincipal и Кустомидентити уже используются, то нет необходимости анализировать значения из свойства UserData билета. Вместо этого просто получите ссылку на объект Кустомидентити и используйте его свойства CompanyName и Title:

[!code-vb[Main](forms-authentication-configuration-and-advanced-topics-vb/samples/sample12.vb)]

## <a name="summary"></a>Сводка

В этом учебнике мы рассмотрели, как настроить параметры системы проверки подлинности форм с помощью Web. config. Мы рассматривали обработку истечения срока действия билета проверки подлинности и использование мер шифрования и проверки для защиты билета от проверки и изменения. Наконец, мы обсуждали использование свойства UserData билета проверки подлинности для хранения дополнительных сведений о пользователях в самом билете и использования настраиваемых объектов Principal и Identity для предоставления этой информации более понятным разработчикам.

В этом руководстве мы завершаем изучение проверки подлинности с помощью форм в ASP.NET. В следующем руководстве начинается наша структура членства.

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Проверка подлинности которая разбила Forms](http://aspnet.4guysfromrolla.com/articles/072005-1.aspx)
- [Описание: проверка подлинности с помощью форм в ASP.NET 2,0](https://msdn.microsoft.com/library/aa480476.aspx)
- [Как защитить проверку подлинности с помощью форм в ASP.NET 2,0](https://msdn.microsoft.com/library/ms998310.aspx)
- [Профессиональная ASP.NET 2,0 безопасность, членство и управление ролями](http://www.wrox.com/WileyCDA/WroxTitle/productCd-0764596985.html) (ISBN: 978-0-7645-9698-8)
- [Защита элементов управления входом](https://msdn.microsoft.com/library/ms178346.aspx)
- [Элемент&gt; проверки подлинности &lt;](https://msdn.microsoft.com/library/532aee0e.aspx)
- [Элемент&gt; &lt;Forms для проверки подлинности &lt;&gt;](https://msdn.microsoft.com/library/1d3t3c61.aspx)
- [Элемент &lt;machineKey&gt;](https://msdn.microsoft.com/library/w8h3skw9.aspx)
- [Общие сведения о билете проверки подлинности форм и файле cookie](https://support.microsoft.com/kb/910443)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a>Видеообучение по темам, содержащимся в этом руководстве

- [Изменение свойств проверки подлинности на формах](../../../videos/authentication/how-to-change-the-forms-authentication-properties.md)
- [Настройка и использование проверки подлинности без файлов cookie в приложении ASP.NET](../../../videos/authentication/how-to-setup-and-use-cookie-less-authentication-in-an-aspnet-application.md)
- [Перемещение входа с проверкой подлинности на основе форм в ASP](../../../videos/authentication/asp-forms-login-relocation.md)
- [Конфигурация пользовательского ключа для входа](../../../videos/authentication/forms-login-custom-key-configuration.md)
- [Добавление пользовательских данных в метод проверки подлинности](../../../videos/authentication/add-custom-data-to-the-authentication-method.md)
- [Использование пользовательских объектов Principal](../../../videos/authentication/use-custom-principal-objects.md)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — *[Sams обучать себя ASP.NET 2,0 за 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* . Скотт можно получить по адресу [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) или через свой блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Специалист по интересу для этого руководства был Аликжа Мазиарз. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com).

> [!div class="step-by-step"]
> [Назад](an-overview-of-forms-authentication-vb.md)
