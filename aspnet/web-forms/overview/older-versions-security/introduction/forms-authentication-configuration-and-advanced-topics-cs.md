---
uid: web-forms/overview/older-versions-security/introduction/forms-authentication-configuration-and-advanced-topics-cs
title: Настройка проверки подлинности форм и дополнительные разделы (C#) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве мы Изучите различные параметры проверки подлинности форм и об их изменении посредством элемента forms см. в разделе. Это будет включают подробных сведений...
ms.author: riande
ms.date: 01/14/2008
ms.assetid: b9c29865-a34e-48bb-92c0-c443a72cb860
msc.legacyurl: /web-forms/overview/older-versions-security/introduction/forms-authentication-configuration-and-advanced-topics-cs
msc.type: authoredcontent
ms.openlocfilehash: 9665dafb23b885fdf9e4ea5f1a515a0c6dcc9a9a
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59410634"
---
# <a name="forms-authentication-configuration-and-advanced-topics-c"></a>Настройка проверки подлинности на основе форм и дополнительные разделы (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/ASPNET_Security_Tutorial_03_CS.zip) или [скачать PDF](http://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/aspnet_tutorial03_AuthAdvanced_cs.pdf)

> В этом руководстве мы Изучите различные параметры проверки подлинности форм и об их изменении посредством элемента forms см. в разделе. Это будет включают подробно рассматривались Настройка значение времени ожидания билета проверки подлинности форм, страницы входа при помощи пользовательский URL-адрес (например, SignIn.aspx вместо Login.aspx), а билеты аутентификации форм без поддержки файлов cookie.


## <a name="introduction"></a>Вступление

В [предыдущем учебном курсе](an-overview-of-forms-authentication-cs.md) мы рассмотрели действия, необходимые для реализации проверки подлинности форм в приложении ASP.NET из Указание настроек конфигурации в файле Web.config для создания различных входа страницы для отображения содержимое для прошедшего проверку подлинности и анонимных пользователей. Помните, что мы настроили веб-сайта для проверки подлинности в формах, задав атрибуту режима &lt;проверки подлинности&gt; элемент формы. &lt;Проверки подлинности&gt; элемента может включать &lt;forms&gt; дочерний элемент, через который может быть указан набор параметров проверки подлинности форм.

В этом руководстве мы Изучите различные параметры проверки подлинности форм и узнаем, как изменить их с помощью &lt;forms&gt; элемент. Это будет включают подробно рассматривались Настройка значение времени ожидания билета проверки подлинности форм, страницы входа при помощи пользовательский URL-адрес (например, SignIn.aspx вместо Login.aspx), а билеты аутентификации форм без поддержки файлов cookie. Мы также более подробного изучения состава билета проверки подлинности и см. в разделе меры предосторожности, необходимом ASP.NET, чтобы обеспечить безопасность от проверки и подмены данных билета. Наконец мы рассмотрим способы хранения дополнительных сведений о пользователях в билет проверки подлинности форм и смоделировать эти данные через пользовательский объект-участник.

## <a name="step-1-examining-the-ltformsgt-configuration-settings"></a>Шаг 1. Изучение &lt;forms&gt; параметры конфигурации

Система проверки подлинности форм в ASP.NET имеется ряд параметров конфигурации, которые могут быть настроены на основе приложений по. Сюда входят параметры, такие как: время существования форм проверки подлинности билета; какого рода защиты применяется для билета; в разделе о проверке подлинности без файлов cookie условия используются запросы; путь к странице входа; и другие сведения. Чтобы изменить значения по умолчанию, добавьте [ &lt;forms&gt; элемент](https://msdn.microsoft.com/library/1d3t3c61.aspx) как дочерний [ &lt;проверки подлинности&gt; элемент](https://msdn.microsoft.com/library/532aee0e.aspx), указав их свойство значения, которые вы хотите настроить как атрибуты XML следующим образом:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample1.xml)]

В таблице 1 перечислены свойства, которые можно настроить с помощью &lt;forms&gt; элемент. Поскольку XML-файл Web.config, имена атрибутов в левом столбце учитывается регистр.


| <strong>Атрибут</strong> |                                                                                                                                                                                                                                     <strong>Описание</strong>                                                                                                                                                                                                                                      |
|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|         без поддержки файлов cookie         |                                                                                                                Этот атрибут указывает, при каких условиях билет проверки подлинности хранится в файле cookie, и они внедрены в URL-адрес. Разрешенными значениями являются: UseCookies; UseUri; Автообнаружение; и UseDeviceProfile (по умолчанию). Шаг 2 проверяет этот параметр более подробно.                                                                                                                |
|         defaultUrl         |                                                                                                                                                         Указывает URL-адрес, который пользователи будут перенаправлены после входа со страницы входа, если значение отсутствует URL-адрес перенаправления, указанный в строке запроса. Значение по умолчанию — default.aspx.                                                                                                                                                         |
|           домен           | Если вы используете билеты проверки подлинности на основе файлов cookie, этот параметр указывает значение домена файла cookie. Значение по умолчанию — пустая строка, которой, браузер будет использовать домен, из которого он выдан (например, www.yourdomain.com). В этом случае файл cookie будет <strong>не</strong> отправляться при отправке запросов в поддоменов, таких как admin.yourdomain.com. Если требуется, чтобы файл cookie передается все поддомены, вам необходимо изменить атрибут домена, задав для него yourdomain.com. |
|  enableCrossAppRedirects   |                                                                                                                                                                   Логическое значение, указывающее, является ли прошедших проверку подлинности пользователей, запоминаются при перенаправлении URL-адреса в других веб-приложений на одном сервере. Значение по умолчанию – false.                                                                                                                                                                   |
|          loginUrl          |                                                                                                                                                                                                                      URL-адрес страницы входа. Значение по умолчанию — login.aspx.                                                                                                                                                                                                                      |
|            имя            |                                                                                                                                                                                                   При использовании билеты проверки подлинности на основе файлов cookie, имя файла cookie. По умолчанию используется. ASPXAUTH.                                                                                                                                                                                                   |
|            path            |                                                                             Если вы используете билеты проверки подлинности на основе файлов cookie, этот параметр указывает атрибут пути файла cookie. Атрибут path позволяет разработчику для ограничения области действия файла cookie в иерархию определенного каталога. Значение по умолчанию — /, который сообщает браузеру отправлять файл cookie для билета проверки подлинности на любой запрос, выполненных в домене.                                                                              |
|         защита         |                                                                                                                                            Указывает, какие методы используются для защиты билета проверки подлинности. Разрешенными значениями являются: Все (по умолчанию); Шифрование; None; и проверки. Эти параметры подробно описаны на шаге 3.                                                                                                                                            |
|         requireSSL         |                                                                                                                                                                                Логическое значение, указывающее, требуется ли SSL-подключения для передачи cookie проверки подлинности. Значением по умолчанию является false.                                                                                                                                                                                |
|     slidingExpiration      |                                                                                                 Логическое значение, указывающее ли файл cookie проверки подлинности время ожидания сбрасывается при каждом посещении сайта во время одного сеанса. Значение по умолчанию — true. Политики времени ожидания билета проверки подлинности рассматривается более подробно в задание раздела значение времени ожидания билета.                                                                                                 |
|          timeout           |                                                                                                                               Время в минутах, после которого истекает срок файла cookie для билета проверки подлинности. Значение по умолчанию — 30. Политики времени ожидания билета проверки подлинности рассматривается более подробно в задание раздела значение времени ожидания билета.                                                                                                                               |

**Таблица 1**: Сводка &lt;forms&gt; атрибутов этого элемента

В ASP.NET 2.0 и более поздних версий, по умолчанию значения для проверки подлинности форм жестко запрограммированы в классе FormsAuthenticationConfiguration в .NET Framework. Любые изменения должны применяться для отдельных приложений по в файле Web.config. Это отличается от ASP.NET 1.x, где значения по умолчанию для проверки подлинности форм были сохранены в файле machine.config (и может быть изменено, таким образом, внеся изменения в файле machine.config). Время на тему ASP.NET 1.x, стоит отметить, что ряд параметров системы проверки подлинности форм имеют разные значения по умолчанию в ASP.NET 2.0 и за его пределами чем в ASP.NET 1.x. Если вы переносите приложение из среды ASP.NET 1.x, важно учитывать эти различия. Обратитесь к [ &lt;forms&gt; технической документации элемент](https://msdn.microsoft.com/library/1d3t3c61.aspx) список различий.

> [!NOTE]
> Несколько параметров проверки подлинности форм, таких как время ожидания, домен и путь, укажите подробные сведения о полученный файл cookie билета проверки подлинности форм. Дополнительные сведения в файлы cookie, как они работают и их различных свойств [учебнике файлы cookie](http://www.quirksmode.org/js/cookies.html).


### <a name="specifying-the-tickets-timeout-value"></a>Указав значение времени ожидания билета

Билета проверки подлинности — это маркер, который представляет удостоверение. Билеты на основе файлов cookie проверки подлинности этот маркер в виде файла cookie и отправки веб-сервер при каждом запросе. Владение маркер, по сути, объявляет, я *username*, я уже выполнен вход и используется, чтобы удостоверение пользователя может сохраняться в посещений страницы.

Билета проверки подлинности не только удостоверение пользователя, но также сведения о том, что для обеспечения целостности и безопасности маркера. В конце концов мы не хотим 2008г может создать маркер контрафактное или изменить маркер legit underhanded каким-либо образом.

Один такой бит данных, включаемых в билете равен *истечения срока действия*, который является дата и время, он больше не действителен. Каждый раз, когда FormsAuthenticationModule проверяет билет проверки подлинности, он гарантирует, что срок действия билета еще не передан. Если Да, он игнорирует билета и определяет пользователя как анонимного. Эта мера безопасности защищает от атак с повторением. Без срока действия, если злоумышленник смог получить ее практическая билет проверки подлинности пользователя — возможно, получит физический доступ к своему компьютеру и получение административного доступа через файлы cookie — они могут отправить запрос на сервер с Этот билет проверки подлинности украденных и Получите запись. Хотя срок действия не предотвратить возникновение такой ситуации, оно ограничивает окна во время которого может быть успешным, такая атака.

> [!NOTE]
> Шаг 3 сведения о дополнительных технологий, используемых системой проверки подлинности форм для защиты билет проверки подлинности.


При создании билета проверки подлинности, система проверки подлинности форм определяет срок его действия по журналу параметр времени ожидания. Как указано в таблице 1, время ожидания, установка значений по умолчанию 30 минут, это означает, что при создании билета проверки подлинности истечения его срока действия имеет значение даты и времени в будущем 30 минут.

Срок действия определяет абсолютного времени в будущем когда истекает срок действия билета проверки подлинности. Но обычно разработчики хотят реализовать скользящего срока действия, который сбрасывается каждый раз при последующих посещениях пользователем сайта. Это поведение определяется параметрами slidingExpiration. Если задано значение true (по умолчанию), каждый раз, когда FormsAuthenticationModule проверяет подлинность пользователя, он обновляет истечения срока действия билета. Если задано значение false, срок действия не обновляется при каждом запросе, вызывая таким образом срок действия минут после наступления существовавших при билет ровно столько времени ожидания билета создан.

> [!NOTE]
> Срок действия, хранящихся в билет проверки подлинности является абсолютное значение даты и времени, например 2 августа 2008 11:34 по. Кроме того Дата и время указываются относительно местное время веб сервера. Такое Проектное решение может иметь некоторые интересные побочные эффекты вокруг летнее время (DST), то есть часы в Соединенных Штатах приступили один час (при условии, что веб-сервере размещается в регионе, где наблюдается летнее время). Например, рассмотрим ситуацию для веб-сайта ASP.NET со сроком действия 30-минутный период времени, который начинается переход на летнее время (то есть в 2:00). Представьте, что посетитель, который вошел на сайт 11 марта 2008 года в 1:55:00. Это вызовет билета проверки подлинности, срок действия истекает, в 11 марта 2008 г., в 02:25:00 (30 минут в будущем). Однако после 2 часа НОЧИ, выпустите, часы перейдет к 3 часа НОЧИ из-за перехода на летнее время. При загрузке новой страницы шесть минут после входа в систему (в 03:01:00), FormsAuthenticationModule отмечает, что билет истек и перенаправляет пользователя на страницу входа. Более подробное обсуждение этого и других странности времени ожидания билета проверки подлинности, а также обходные пути, получают копию (Stefan Schackow) *Professional ASP.NET 2.0 безопасности, членства и управления ролями* (ISBN: 978-0-7645-9698-8).


Рис. 1 показан рабочий процесс, когда slidingExpiration устанавливается в значение false, и время ожидания устанавливается равной 30. Обратите внимание, что билет проверки подлинности, созданный при входе в систему содержит дату истечения срока действия, и это значение не обновляется при последующих запросах. Если FormsAuthenticationModule обнаруживает, что срок действия билета истек, его отвергает его и обрабатывает запрос как анонимный.


[![A Графическое представление slidingExpiration истечения срока действия при билет проверки подлинности форм имеет значение false](forms-authentication-configuration-and-advanced-topics-cs/_static/image2.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image1.png)

**Рис 01**: Графическое представление slidingExpiration истечения срока действия при билет проверки подлинности форм имеет значение false ([Просмотр полноразмерного изображения](forms-authentication-configuration-and-advanced-topics-cs/_static/image3.png))


Рис. 2 показан рабочий процесс при slidingExpiration устанавливается в true, а также время ожидания устанавливается равной 30. При получении запроса с проверкой подлинности (с неистекшим сроком билет) его срок действия обновляется время ожидания количество минут, в будущем.


[![A Графическое представление билет проверки подлинности форм при slidingExpiration имеет значение true](forms-authentication-configuration-and-advanced-topics-cs/_static/image5.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image4.png)

**Рис. 02**: Графическое представление билет проверки подлинности форм при slidingExpiration имеет значение true ([Просмотр полноразмерного изображения](forms-authentication-configuration-and-advanced-topics-cs/_static/image6.png))


При использовании билеты проверки подлинности на основе файлов cookie (по умолчанию), это обсуждение становится немного сложнее, так как файлы cookie также может иметь свои собственные кэше указан. Срок действия файла cookie (или ее отсутствие) указывает, что браузер при куки-файл необходимо уничтожить. Если файл cookie не имеет срока действия, уничтожается при закрытии браузера. Если срок действия, однако куки-файл хранится на компьютере пользователя до даты и прошло времени, указанного в срок действия. При удалении файла cookie в браузере не отправляется на веб-сервер. Таким образом уничтожение файл cookie является аналогом пользователю выход из сайта.

> [!NOTE]
> Конечно пользователь может заранее удалить все файлы cookie, хранящиеся на компьютере. В Internet Explorer 7 будет перейти к Сервис, параметры и нажмите кнопку "Удалить" в разделе Обзор журнала. После этого нажмите кнопку Удалить файлы cookie.


Система проверки подлинности forms создает файлы cookie сеанса или истечения срока действия в зависимости от значения, передаваемые в *persistCookie* параметра. Вспомним, что класс FormsAuthentication GetAuthCookie SetAuthCookie и RedirectFromLoginPage методы выполняются в два входных параметра: *username* и *persistCookie*. На страницу входа, созданной в предыдущем учебном курсе включен флажок Запомнить меня, что определить, был ли создан постоянный файл cookie. Постоянные файлы cookie создаются на основе срока действия; временные файлы cookie представляют собой на основе сеансов.

Время ожидания и slidingExpiration обсуждавшиеся уже применить и для обоих куки-файлов на основе сеансов и истечения срока действия. Только один дополнительный отличается от выполнения: при использовании файлов cookie на основе срока действия с slidingTimeout задано значение true, срок действия файла cookie обновляется только при более половины указанного времени истечения.

Давайте обновим политик времени ожидания билета проверки подлинности наш веб-сайт, который билетов времени ожидания после одного часа (60 минут), с помощью скользящего срока действия. Для этого, обновите файл Web.config, добавив &lt;форм&gt; элемент &lt;проверки подлинности&gt; элемент, используя следующую разметку:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample2.xml)]

### <a name="using-an-login-page-url-other-than-loginaspx"></a>С помощью URL-адрес страницы входа Кроме Login.aspx

Поскольку FormsAuthenticationModule автоматически перенаправляет неавторизованных пользователей на страницу входа, его необходимо знать URL-адрес страницы входа. Этот URL-адрес указан в атрибуте loginUrl &lt;forms&gt; элемент и значение по умолчанию — login.aspx. При переносе на существующем веб-сайте уже имеется страница входа в систему с другой URL-адрес, который уже закладки или индексироваться поисковыми. Вместо переименовании имеющейся страницы входа на страницу login.aspx и критические ссылки и закладки пользователей, вместо этого можно изменить атрибут loginUrl, чтобы она указывала на страницу входа.

Например, если страница входа называется SignIn.aspx и находится в каталоге пользователей, может указывать параметр конфигурации в loginUrl ~/Users/SignIn.aspx следующим образом:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample3.xml)]

Поскольку наш текущее приложение уже имеет страницу входа с именем Login.aspx, нет необходимости указать пользовательское значение в &lt;forms&gt; элемент.

## <a name="step-2-using-cookieless-forms-authentication-tickets"></a>Шаг 2. Использование без поддержки файлов cookie Forms билеты проверки подлинности

По умолчанию система проверки подлинности forms определяет, следует ли сохранить его билеты проверки подлинности в коллекции файлов cookie или внедрять их в зависимости от агента пользователя, посещения веб-узла URL-адрес. Все основные обозреватели рабочего стола, такие как Internet Explorer, Firefox, Opera и Safari, файлы cookie поддержки, но не всеми устройствами.

Политике файлов cookie, используемые системой проверки подлинности форм зависит от без поддержки файлов cookie в &lt;forms&gt; элемент, который можно задать один из четырех значений:

- UseCookies - указывает, что всегда будет использоваться билеты проверки подлинности на основе файлов cookie.
- UseUri - указывает, что билеты проверки подлинности на основе файлов cookie никогда не будет использоваться.
- Автообнаружение — Если профиль устройства поддерживает файлы cookie, билеты проверки подлинности на основе файлов cookie не используются; Если профиль устройства поддерживает файлы cookie, чтобы определить, включены ли файлы cookie используется механизмом проверки.
- UseDeviceProfile - по умолчанию. использует билеты проверки подлинности на основе файлов cookie, только в том случае, если профиль устройства поддерживает файлы cookie. Используется не механизмом проверки.

Зависит от настройки автообнаружение и UseDeviceProfile *профиля устройства* в позволяет установить, следует ли использовать билеты проверки подлинности на основе файлов cookie или без поддержки файлов cookie. ASP.NET поддерживает базу данных из различных устройств и их возможности, такие как ли они поддерживают файлы cookie, какая версия JavaScript, они поддерживают и т. д. Каждый раз, устройство запрашивает веб-страницы на веб-сервере, он отправляет вдоль *агента пользователя* заголовок HTTP, который определяет тип устройства. ASP.NET автоматически сопоставляет строки предоставленного user-agent с соответствующий профиль, который указан в своей базе данных.

> [!NOTE]
> Эта база данных, набор возможностей устройства хранится в ряд XML-файлы, которые соответствуют [схема файла определения браузера](https://msdn.microsoft.com/library/ms228122.aspx). Файлы профилей устройств по умолчанию находятся в % WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG\Browsers. Можно также добавить пользовательские файлы приложения приложение\_папку браузеров. Дополнительные сведения см. в разделе [How To: Определение типов обозревателей веб-страниц ASP.NET](https://msdn.microsoft.com/library/3yekbd5b.aspx).


Так как параметр по умолчанию является UseDeviceProfile, билеты аутентификации форм без поддержки файлов cookie будет использоваться при посещении сайта со стороны устройства, профиль сообщает, что он не поддерживает файлы cookie.

### <a name="encoding-the-authentication-ticket-in-the-url"></a>Кодирование билет проверки подлинности в URL-адрес

Файлы cookie представляют собой естественным средний для включения информации из браузера в каждый запрос для определенного веб-сайта, поэтому параметры проверки подлинности форм по умолчанию используют файлы cookie, если выполняется посещение устройство поддерживает их. Если файлы cookie не поддерживаются, необходимо использовать альтернативный способ для передачи билета проверки подлинности от клиента к серверу. Распространенный обходной путь используется в средах без поддержки файлов cookie является кодирование данных файлов cookie в URL-адрес.

Оптимальный способ увидеть, как такая информация может быть внедрен в URL-адрес является принудительно сайт для использования билеты проверки подлинности без файлов cookie. Это можно сделать, задав параметр конфигурации без поддержки файлов cookie для UseUri:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample4.xml)]

После внесения этого изменения на узле через браузер. При посещении как анонимный пользователь, URL-адреса будет выглядеть точно как раньше. Например при посещении страницы Default.aspx моего браузера адресной строке указывается следующий URL-адрес:

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/default.aspx`

Тем не менее после входа в билет проверки подлинности форм, внедряются в URL-адрес. Например после посещения страницы входа и входа в систему как Sam, я являюсь возвращается на страницу Default.aspx, но URL-адрес — это время:

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/(F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2))/default.aspx`

Билет проверки подлинности форм внедрен в URL-адрес. Строка (F (jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv rfezq0gKadKX0YPZCkA2) представляет сведения о билете проверки подлинности шестнадцатеричной кодировке, и имеет те же данные, которые обычно хранятся в файле cookie.

В порядке для билетов без поддержки файлов cookie проверки подлинности для работы системы необходимо закодировать все URL-адреса на странице для включения данные билета проверки подлинности, в противном случае билет проверки подлинности будут потеряны, когда пользователь щелкает ссылку. К счастью эта внедрения логика выполняется автоматически. Чтобы продемонстрировать эту функцию, откройте страницу Default.aspx и добавьте элемент управления HyperLink, задавая свойства текста и NavigateUrl проверить ссылку и SomePage.aspx, соответственно. Не важно, что на деле нет страницы в нашем проекте с именем SomePage.aspx.

Сохраните изменения в Default.aspx и затем посетите нас через браузер. Войдите на сайт, чтобы билета проверки подлинности внедрен в URL-адрес. Затем в Default.aspx, щелкните ссылку, проверить ссылку. Что произошло? Если страница, с именем SomePage.aspx, не существует, затем произошла ошибка 404, но это не то и важно здесь. Вместо этого сосредоточьтесь на адреса в браузере. Обратите внимание на то, что он включает билета проверки подлинности в URL-адрес!

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/(F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2))/SomePage.aspx`

SomePage.aspx URL-адрес в ссылке был автоматически преобразуются в URL-адрес, который включен билет проверки подлинности — избавиться от необходимости писать ни строчки кода! Билет проверки подлинности формы будет автоматически внедрен в URL-адрес для гиперссылок, которые не начинаются с `http://` или `/`. Не важно, если ссылка на отображается в вызове Response.Redirect, в элементе управления HyperLink или в элемент привязки HTML (т. е. `<a href="...">...</a>`). До тех пор, пока URL-адрес не примерно `http://www.someserver.com/SomePage.aspx` или `/SomePage.aspx`, билета проверки подлинности будут внедрены для нас.

> [!NOTE]
> Билеты проверки подлинности форм без поддержки cookie соблюдать те же политики времени ожидания как билеты проверки подлинности на основе файлов cookie. Тем не менее билеты проверки подлинности без файлов cookie являются более подвержены атаки, так как билет проверки подлинности встроена непосредственно в URL-адрес. Представьте себе пользователя, кто посещает веб-сайт, входит в систему и затем автоматически вставляет URL-адрес по электронной почте коллеге. Если коллеги щелкает по этой ссылке, прежде чем будет достигнут срок действия, он регистрируется качестве пользователя, отправившего сообщение электронной почты!


## <a name="step-3-securing-the-authentication-ticket"></a>Шаг 3. Обеспечение безопасности билет проверки подлинности

Билет проверки подлинности форм, передаваемых по сети либо в файле cookie или внедренные непосредственно в URL-адрес. В дополнение к сведения об удостоверениях билет проверки подлинности могут также содержать данные пользователя (как мы увидим в шаге 4). Следовательно, очень важно, что билет данные шифруются от любопытных глаз и (даже более важно), система проверки подлинности форм может гарантировать, что билет не было подделано.

Для обеспечения конфиденциальности данных билетов, система проверки подлинности форм можно зашифровать данные билетов. Не удалось зашифровать данные билетов отправляет потенциально конфиденциальной информации по сети в виде обычного текста.

Чтобы гарантировать билет подлинности, необходимо системой проверки подлинности форм *проверки* билета. Проверка — это то, что определенные данные не был изменен и можно выполнить посредством  *[код проверки подлинности (MAC) сообщения](http://en.wikipedia.org/wiki/Message_authentication_code)*. По сути компьютер MAC по-это небольшая часть сведения, которые определяют данные, необходимые для проверки (в данном случае-ticket). Если изменить данные, представленные MAC, MAC и данных не будет соответствовать. Кроме того сложно точки зрения вычислений для злоумышленников, как изменить данные и создать свой собственный MAC в соответствии с измененными данными.

При создании (или изменение) билет, система проверки подлинности forms создает MAC и присоединяет его к запрос в службу данных. По прибытии последующий запрос системой проверки подлинности форм сравнивает данные MAC и билет для проверки подлинности данные билетов. Рис. 3 показан этот рабочий процесс графически.


[![Tу него билет подлинности обеспечивается через MAC](forms-authentication-configuration-and-advanced-topics-cs/_static/image8.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image7.png)

**Рис 03**: Билет подлинности обеспечивается через MAC ([Просмотр полноразмерного изображения](forms-authentication-configuration-and-advanced-topics-cs/_static/image9.png))


Какие меры безопасности применяются к билет проверки подлинности зависит от настройки защиты в &lt;forms&gt; элемент. Защита может быть назначен один из следующих трех значений:

- ALL --ticket зашифрован и цифровую подпись (по умолчанию).
- Применяется шифрование — шифрование только - MAC не создается.
- Нет --ticket не шифруются и не цифровую подпись.
- Проверка - MAC создается, но запрос в службу данные отправляются по сети в виде обычного текста.

Майкрософт настоятельно рекомендует использовать все параметры.

### <a name="setting-the-validation-and-decryption-keys"></a>Настройка проверки и расшифровки ключей

Шифрование и хеширование алгоритмы, используемые системой проверки подлинности форм для шифрования и проверки билет проверки подлинности настраиваются через [ &lt;machineKey&gt; элемент](https://msdn.microsoft.com/library/w8h3skw9.aspx) в файле Web.config. В таблице 2 описываются &lt;machineKey&gt; атрибутов этого элемента и их возможные значения.

| **Атрибут** | **Описание** |
| --- | --- |
| расшифровка | Указывает алгоритм, используемый для шифрования. Этот атрибут может иметь одно из следующих четырех значений: - Auto - по умолчанию. определяет алгоритм, в зависимости от длины decryptionKey атрибута. -Использует AES - [Advanced Encryption Standard (AES)](http://en.wikipedia.org/wiki/Advanced_Encryption_Standard) алгоритм. -Использует DES - [данных шифрования стандарт DES](http://en.wikipedia.org/wiki/Data_Encryption_Standard) этот алгоритм считается большим слабого и не должны использоваться. Использует - 3DES - [Triple DES](http://en.wikipedia.org/wiki/Triple_DES) алгоритм, который работает путем применения алгоритма DES три раза. |
| decryptionKey | Секретный ключ, используемый алгоритмом шифрования. Это значение должны быть шестнадцатеричной строки, соответствующей длины (на основе значения в расшифровки), автоматически заполнять или одно из значений, дополненный, IsolateApps. Добавление IsolateApps указывает, что ASP.NET использовать уникальное значение для каждого приложения. Значение по умолчанию — AutoGenerate, IsolateApps. |
| проверка | Указывает алгоритм, используемый для проверки. Этот атрибут может иметь одно из следующих четырех значений: - AES - алгоритм Advanced Encryption Standard (AES). -Использует MD5 - [Message-Digest 5 (MD5)](http://en.wikipedia.org/wiki/MD5) алгоритм. -Использует SHA1 - [SHA1](http://en.wikipedia.org/wiki/Sha1) алгоритма (по умолчанию). -3DES - используется алгоритм Triple DES. |
| validationKey | Секретный ключ, используемый алгоритм проверки. Это значение должны быть шестнадцатеричной строки, соответствующей длины (на основе значения проверки), автоматически заполнять или одно из значений, дополненный, IsolateApps. Добавление IsolateApps указывает, что ASP.NET использовать уникальное значение для каждого приложения. Значение по умолчанию — AutoGenerate, IsolateApps. |

**Таблица 2**: &lt;MachineKey&gt; атрибуты элемента

Подробное описание того, эти параметры шифрования и проверки, а также преимущества и недостатки различных алгоритмов, выходит за рамки данного руководства. Для подробно рассмотрим эти проблемы, включая рекомендации по какие алгоритмы шифрования и проверки, чтобы использовать, какие длины ключей, чтобы использовать и как лучше создавать эти ключи, обратитесь к *Professional ASP.NET 2.0 безопасности, членства и управления ролями* .

По умолчанию ключи, используемые для шифрования и проверки создаются автоматически для каждого приложения, и эти ключи хранятся в локальной системы безопасности (LSA). Иными словами параметры по умолчанию гарантирует уникальных ключей в веб-сервера с веб-сервера и приложения по приложениям. Следовательно это поведение по умолчанию не будет работать в двух следующих случаях:

- **Веб-ферм** — в [веб-ферме](http://en.wikipedia.org/wiki/Web_farm) сценарий, единое веб-приложение размещается на нескольких веб-серверов для обеспечения масштабируемости и избыточности. Каждый входящий запрос отправляется на сервер в ферме, это означает, что в течение времени существования сеанса пользователя, разных серверах может использоваться для обработки его различных запросов. Следовательно каждый сервер должен использовать те же ключи шифрования и проверки, для создания билета проверки подлинности, зашифрованные и проверенные на одном сервере можно расшифровать и проверить на другом сервере в ферме.
- **CROSS, совместное использование приложений билет** -один веб-сервер может размещать несколько приложений ASP.NET. Если вам требуется для таких приложений для совместного использования одного билета проверки подлинности, крайне важно, что совпадающие их ключей шифрования и проверки.

При работе на веб-ферме, параметр или билеты проверки подлинности совместно использовать приложения на одном сервере, необходимо настроить &lt;machineKey&gt; элемент в проблемных приложений, чтобы их decryptionKey и совпадающие значения validationKey.

Хотя ни один из указанных выше сценариев применяется к наш пример приложения, мы по-прежнему можно указать явные decryptionKey и validationKey значения и определить алгоритмы, используемые. Добавить &lt;machineKey&gt; параметр в файл Web.config:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample5.xml)]

Дополнительные сведения см. [How To: Настройка в ASP.NET 2.0 MachineKey](https://msdn.microsoft.com/library/ms998288.aspx).

> [!NOTE]
> Значения decryptionKey и validationKey были взяты из [Стив Гибсон](http://www.grc.com/stevegibson.htm) [идеального пароли веб-странице](https://www.grc.com/passwords.htm), служащего 64 случайные шестнадцатеричные символы на каждом посещении страницы. Чтобы уменьшить вероятность того, что эти ключи, сходным образом в приложении, рекомендуется заменить выше ключи случайным из них на странице идеальной пароли.


## <a name="step-4-storing-additional-user-data-in-the-ticket"></a>Шаг 4. Сохранение дополнительных сведений о пользователях в билете

Многие веб-приложения отображения сведений о или base отображением страницы для текущего пользователя. В частности веб-страницы могут содержать имя пользователя, а также дату она последнего входа в систему в верхней части каждой страницы. Билет проверки подлинности forms сохраняет имя пользователя вошедшего пользователя, но при необходимости другие сведения страницы необходимо перейти в хранилище пользователя — как правило, база данных — для поиска информации, не хранятся в билет проверки подлинности.

Используя небольшой фрагмент кода можно хранить Дополнительные сведения о пользователе в билете проверки подлинности форм. Такие данные можно выразить через [класс FormsAuthenticationTicket](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.aspx) [UserData свойство](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.userdata.aspx). Это полезно место для размещения небольшие объемы информации о пользователе, который часто необходим. Значение, указанное в UserData свойство рассматривается как часть файла cookie для билета проверки подлинности и, как и в других полях билет, шифруется и проверен на основе системы проверки подлинности форм конфигурации. По умолчанию UserData является пустой строкой.

Чтобы сохранить данные пользователя в билет проверки подлинности, нам нужно написать немного кода на странице входа, которая извлекает сведения о пользователе и сохраняет их в билете. Поскольку UserData свойство строкового типа, данные, хранящиеся в ней должен быть правильно сериализован как строка. Например представьте, что наши хранилище пользователя включаются Дата рождения каждого пользователя и имя работодателем, а мы хотели хранить значения этих двух свойств в билет проверки подлинности. Нам удалось сериализовать эти значения в строку путем сцепления пользователя даты рождения в строки с помощью вертикальной черты (|), за которым следует имя работодателя. Для пользователя на свет на 15 августа 1974, подходящий для Northwind Traders мы бы назначить свойство UserData строки: 1974-08-15 | Northwind Traders.

Каждый раз, когда нам требуется получить доступ к данным в билете, это можно сделать путем получения FormsAuthenticationTicket текущего запроса и десериализации свойство UserData. В случае дата рождения и работодателя пример имени мы бы разбить строку UserData на двух подстрок в зависимости от разделителя (|).


[![AДополнительные сведения пользователя можно хранить в билет проверки подлинности](forms-authentication-configuration-and-advanced-topics-cs/_static/image11.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image10.png)

**Рис. 04**: Дополнительные пользователя сведения могут храниться в билет проверки подлинности ([Просмотр полноразмерного изображения](forms-authentication-configuration-and-advanced-topics-cs/_static/image12.png))


### <a name="writing-information-to-userdata"></a>Записи сведений в UserData

К сожалению добавив сведения о пользователе для билета проверки подлинности не так просто, как можно предположить. Свойство UserData FormsAuthenticationTicket класса доступен только для чтения и можно указать только с помощью конструктора класса FormsAuthenticationTicket. При указании UserData свойства в конструкторе, необходимо также предоставить билет на другие значения: имя пользователя, Дата выпуска, срок действия и т. д. Когда мы создавали на страницу входа в предыдущем учебном курсе, это все отвечал за нас классом FormsAuthentication. При добавлении UserData FormsAuthenticationTicket, нам потребуется написать код для большей части функций, уже предоставляются классом FormsAuthentication репликации.

Давайте рассмотрим необходимый код для работы с UserData, обновив страницу Login.aspx для записи дополнительных сведений о пользователе билет проверки подлинности. Представьте, что наши хранилище пользователя содержит сведения о пользователь работает в компании и названий, и что необходимо для сохранения этих данных в билете проверки подлинности. Обновите на страницу Login.aspx LoginButton обработчик щелчков, чтобы код выглядит следующим образом:

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample6.cs)]

Давайте выполним этот код по одной строке за раз. Этот метод начинает с определения четыре массивы строк: пользователей, пароли, companyName и titleAtCompany. Такие массивы хранения имен пользователей, пароли, названия компаний и заголовки для учетных записей пользователей в системе, из которых есть три: Скотт, Цзисунь и Сэм. В реальном приложении эти значения будут запрашиваться из хранилища пользователя, не жестко задано в исходный код страницы.

В предыдущем учебном курсе если предоставленные учетные данные были допустимыми просто называется метод FormsAuthentication.RedirectFromLoginPage (UserName.Text, RememberMe.Checked), что выполнены следующие действия:

1. Создать билет проверки подлинности форм
2. Написал билет в соответствующее хранилище. Для билетов проверки подлинности на основе файлов cookie используется коллекции файлов cookie в браузере; для билетов проверки подлинности без файлов cookie данные билетов сериализуется в URL-адрес
3. Перенаправление пользователя на соответствующую страницу

В приведенном выше коде реплицируются следующие действия. Во-первых со временем мы сохраним в свойстве UserData строка формируется путем сочетания названия компании и title, разделив их знаком вертикальной черты (|) два значения.

string userDataString = string.Concat(companyName[i], "|", titleAtCompany[i]);

FormsAuthentication.GetAuthCookie, вызывается метод, который создает билет проверки подлинности, шифрует и выполняет его проверку в соответствии с параметрами конфигурации затем помещает его в объект HttpCookie.

HttpCookie authCookie = FormsAuthentication.GetAuthCookie(UserName.Text, RememberMe.Checked);

Чтобы работать с FormAuthenticationTicket, внедренных в файл cookie, необходимо вызвать класс FormAuthentication [расшифровать метод](https://msdn.microsoft.com/library/system.web.security.formsauthentication.decrypt.aspx), передавая значение файла cookie.

FormsAuthenticationTicket ticket = FormsAuthentication.Decrypt(authCookie.Value);

Затем мы создаем *новый* FormsAuthenticationTicket экземпляра на основе существующих FormsAuthenticationTicket значений. Тем не менее этот новый билет содержит сведения о пользователе (userDataString).

FormsAuthenticationTicket newTicket = new FormsAuthenticationTicket(ticket.Version, ticket.Name, ticket.IssueDate, ticket.Expiration, ticket.IsPersistent, userDataString);

Затем зашифровать (и проверить) новый экземпляр FormsAuthenticationTicket, вызвав [методу шифрования](https://msdn.microsoft.com/library/system.web.security.formsauthentication.encrypt.aspx)и вернуть эти данные, зашифрованные (и проверенные) в authCookie.

authCookie.Value = FormsAuthentication.Encrypt(newTicket);

Наконец authCookie добавляется в коллекцию Response.Cookies и вызывается метод GetRedirectUrl, чтобы определить, будет перенаправлен на соответствующую страницу.

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample7.cs)]

Весь этот код требуется, поскольку UserData свойство только для чтения и FormsAuthentication класс не предоставляет никаких методов для указания сведений о UserData в его GetAuthCookie, SetAuthCookie или RedirectFromLoginPage методы.

> [!NOTE]
> Код, который мы только что рассмотрели хранит сведения о пользователе в билет проверки подлинности на основе файлов cookie. Классы, отвечающие за сериализации билета проверки подлинности для URL-адреса являются внутренними для платформы .NET Framework. Короче говоря, не удается сохранить данные пользователя в билете проверки подлинности форм без поддержки cookie.


### <a name="accessing-the-userdata-information"></a>Доступ к сведениям UserData

На этом этапе название компании и название каждого пользователя хранится в свойстве UserData билет проверки подлинности форм при входе в. Эта информация может осуществляться из билет проверки подлинности на любой странице, не требуя поездку в хранилище пользователя. Чтобы проиллюстрировать, как эти сведения можно получить из свойства UserData, давайте обновим Default.aspx, чтобы его приветственное сообщение включает в себя не только имя пользователя, но также компании, в которой они работают и названий.

В настоящее время Default.aspx содержит элемент управления Label с именем WelcomeBackMessage AuthenticatedMessagePanel панели. В этой области отображается только пользователям, прошедшим проверку. Обновите код в страницу Default.aspx\_загрузить обработчик событий, чтобы он выглядел следующим образом:

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample8.cs)]

Если Request.IsAuthenticated имеет значение true, то свойство Text WelcomeBackMessage сначала присваивается Добро пожаловать *username*. Затем свойство User.Identity приводится к объекту FormsIdentity таким образом, можно обратиться к базовой FormsAuthenticationTicket. Получив FormsAuthenticationTicket, мы десериализовать свойство UserData в название компании и title. Это достигается путем разбиения строки на вертикальной черты. В метке WelcomeBackMessage затем отображаются имя компании и заголовок.

Рис. 5 показан снимок экрана этого отображения в действии. Выполняется вход в систему Скотт отображает приветственное сообщение назад, включающий Скотта компании и title.


[![Tон в настоящее время пользователю, выполнившему вход в компании и заголовок отображаются](forms-authentication-configuration-and-advanced-topics-cs/_static/image14.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image13.png)

**05 рис**: В настоящее время пользователю, выполнившему вход в компании и заголовок отображаются ([Просмотр полноразмерного изображения](forms-authentication-configuration-and-advanced-topics-cs/_static/image15.png))


> [!NOTE]
> Свойство UserData билет проверки подлинности служит в качестве кэша для хранилища пользователя. Как и любой кэш его необходимо обновить при изменении базовых данных. Например если веб-страницы, из которого пользователи могут обновлять свой профиль, поля, кэшируются в свойстве UserData должны обновляться для отражения изменений, внесенных пользователем.


## <a name="step-5-using-a-custom-principal"></a>Шаг 5. С помощью нестандартный участник

Каждый входящий запрос FormsAuthenticationModule пытается проверить подлинность пользователя. При наличии билет проверки подлинности с неистекшим сроком FormsAuthenticationModule назначает свойство HttpContext.User объекта GenericPrincipal. Этот объект GenericPrincipal имеет удостоверение типа FormsIdentity, включающий ссылку на билета проверки подлинности. Класс GenericPrincipal содержит исходного Минимальная функциональность, необходимую каким-либо классом, который реализует IPrincipal - содержит только свойство Identity и метод IsInRole.

Объект-участник имеет два вида ответственности: чтобы указать, какие роли он принадлежит, так и для предоставления сведений об удостоверениях. Это достигается через интерфейс IPrincipal IsInRole (*roleName*) метод и свойство Identity, соответственно. Класс GenericPrincipal позволяет массив строк имен ролей нельзя указать с помощью конструктора его IsInRole (*roleName*) метод просто проверяет, если переданный в *roleName* существует в массиве строк. Когда FormsAuthenticationModule создает GenericPrincipal, передается в массив пустых строк GenericPrincipal конструктор. Следовательно любой вызов IsInRole будет всегда возвращать значение false.

Класс GenericPrincipal подходит для большинства сценариев проверки подлинности на основе форм, где не используются роли. Для таких случаев, где недостаточно обработку роли по умолчанию или если вам нужно связать с пользователем, пользовательского объекта IIdentity, создания пользовательского объекта IPrincipal во время рабочего процесса проверки подлинности и назначьте его свойству HttpContext.User.

> [!NOTE]
> Как мы увидим в последующих руководствах при ASP. NET framework роли включена создается объект пользовательского основного типа [RolePrincipal](https://msdn.microsoft.com/library/system.web.security.roleprincipal.aspx) и перезаписывает объекта GenericPrincipal создан проверки подлинности форм. Это делается для настройки метода IsInRole участника для взаимодействия с API платформы ролей.


Так как мы имеют может не заботиться о себе с ролями еще, единственная причина того, мы бы создания собственного участника безопасности на этом этапе будет связать пользовательский объект IIdentity субъекту. На шаге 4 мы рассмотрели хранения дополнительных сведений о пользователе в свойстве UserData билет проверки подлинности, в частности, название компании пользователя и их заголовок. Тем не менее данные UserData еще только недоступным для билета проверки подлинности и затем только для того, как сериализованной строки, это означает, что каждый раз, когда мы хотим просмотреть сведения о пользователе, хранящихся в билете нам нужно интерпретировать свойство UserData.

Усовершенствовать процесс разработки, создав класс, реализующий IIdentity и содержит свойства CompanyName и Title. Таким образом, разработчик может получить доступ к название компании текущего пользователя и название напрямую через свойства CompanyName и Title, без необходимости знать, как интерпретировать свойство UserData.

### <a name="creating-the-custom-identity-and-principal-classes"></a>Создание пользовательских удостоверений и классы участников

В этом учебнике давайте создадим настраиваемые объекты principal и identity в приложении\_папке кода. Начните с добавления приложения\_кода папки в проект — щелкните правой кнопкой мыши имя проекта в обозревателе решений, выберите параметр Добавить папку ASP.NET и выберите приложение\_кода. Приложение\_папке кода это особая папка ASP.NET, содержащий файлов классов, определенных на веб-сайт.

> [!NOTE]
> Приложение\_папке кода следует использовать только при управлении проектами с помощью модели проекта веб-сайта. Если вы используете [модели проекта веб-приложения](https://msdn.microsoft.com/asp.net/Aa336618.aspx), создание стандартной папки и классы, добавить. Например можно добавить новую папку с именем классы и добавления кода существует.


Добавьте два новых файла класса в приложение\_папка с кодом, один именованный CustomIdentity.cs и один с именем CustomPrincipal.cs.


[![Aдд CustomIdentity и CustomPrincipal классов в проект](forms-authentication-configuration-and-advanced-topics-cs/_static/image17.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image16.png)

**Рис 06**: Добавьте в проект CustomIdentity и классы CustomPrincipal ([Просмотр полноразмерного изображения](forms-authentication-configuration-and-advanced-topics-cs/_static/image18.png))


Класс CustomIdentity отвечает за реализацию интерфейс IIdentity, который определяет AuthenticationType, IsAuthenticated и имя свойства. Помимо этих обязательных свойств нас интересует предоставление доступа к базовой билета проверки подлинности, а также свойства для пользователя имя компании и title. Введите следующий код в класс CustomIdentity.

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample9.cs)]

Обратите внимание, что класс включает переменную-член FormsAuthenticationTicket (\_билета) и что этот запрос в службу сведения должны предоставляться через конструктор. Этот запрос в службу данных используется в. Возвращение имени удостоверения; его свойство UserData анализируется для возвращения значений свойства CompanyName и Title.

Создайте класс CustomPrincipal. Поскольку нас интересует не ролей на этом этапе, CustomPrincipal в конструктор класса принимает только объект CustomIdentity; его метод IsInRole всегда возвращает значение false.

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample10.cs)]

### <a name="assigning-a-customprincipal-object-to-the-incoming-requests-security-context"></a>Присвоение объекта CustomPrincipal контекст безопасности входящего запроса

Теперь у нас есть класс, расширяющий спецификация IIdentity по умолчанию, чтобы включить свойства CompanyName и Title, а также пользовательский класс участников, который использует пользовательское удостоверение. Мы готовы к шагу к конвейеру ASP.NET и назначьте наших пользовательского объекта-участника контекст безопасности входящего запроса.

Конвейер ASP.NET принимает входящий запрос и обрабатывает его через несколько этапов. На каждом этапе возникает определенное событие, что позволяет разработчикам коснитесь к конвейеру ASP.NET и измените запрос на различных этапах жизненного цикла. FormsAuthenticationModule, например, ожидает ASP.NET для вызова [событие AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), после чего он проверяет входящий запрос билета проверки подлинности. При обнаружении билет проверки подлинности объекта GenericPrincipal создается и назначается свойству HttpContext.User.

После события AuthenticateRequest, вызывает конвейер ASP.NET [PostAuthenticateRequest событий](https://msdn.microsoft.com/library/system.web.httpapplication.postauthenticaterequest.aspx), который является, где мы заменим объекта GenericPrincipal, созданные с помощью экземпляра FormsAuthenticationModule наших Объект CustomPrincipal. Рис. 7 показан этот рабочий процесс.


[![Tон GenericPrincipal заменяется CustomPrincipal в событии PostAuthenticationRequest](forms-authentication-configuration-and-advanced-topics-cs/_static/image20.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image19.png)

**07 рис**: GenericPrincipal заменяется CustomPrincipal в событии PostAuthenticationRequest ([Просмотр полноразмерного изображения](forms-authentication-configuration-and-advanced-topics-cs/_static/image21.png))


Чтобы выполнить код в ответ на событие конвейера ASP.NET, мы можно создать соответствующий обработчик событий в файле Global.asax или создать собственный HTTP-модуль. В этом руководстве давайте создадим обработчик событий в файле Global.asax. Начните с добавления Global.asax на веб-сайт. Щелкните правой кнопкой мыши имя проекта в обозревателе решений и добавьте элемент типа с именем Global.asax глобальный класс приложения.


[![Aдд файл Global.asax, чтобы ваш веб-сайт](forms-authentication-configuration-and-advanced-topics-cs/_static/image23.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image22.png)

**Рис 08**: Добавьте файл Global.asax, чтобы ваш веб-сайт ([Просмотр полноразмерного изображения](forms-authentication-configuration-and-advanced-topics-cs/_static/image24.png))


Шаблон по умолчанию Global.asax содержит обработчики событий для числа событий конвейера ASP.NET, включая начала, окончания и [событие ошибки](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx), среди прочего. Вы можете удалить эти обработчики событий, как их не требуется для этого приложения. Событие, которые нас интересуют — PostAuthenticateRequest. Добавьте в файл Global.asax, разметку выглядит примерно следующим:

[!code-aspx[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample11.aspx)]

Приложение\_метод OnPostAuthenticateRequest выполняется каждый раз, среда выполнения ASP.NET вызывает событие PostAuthenticateRequest, которое происходит один раз для каждого входящего запроса страницы. Обработчик событий начинает с проверки, если пользователь прошел проверку подлинности и была выполнена проверка подлинности с помощью проверки подлинности форм. Если таким образом, объект CustomIdentity создается и передается текущий запрос билета проверки подлинности в своем конструкторе. После этого объект CustomPrincipal создается и передается только что созданного объекта CustomIdentity в своем конструкторе. Наконец в недавно созданном объекте CustomPrincipal назначается контекст безопасности текущего запроса.

Обратите внимание, что последний шаг — связывание объекте CustomPrincipal с контекстом безопасности запроса - участника назначается два свойства: HttpContext.User и Thread.CurrentPrincipal. Эти два назначения необходимы из-за способа обработки контекстов безопасности в ASP.NET. .NET Framework связывает контекста безопасности с каждого выполняемого потока; Эта информация доступна в виде объекта IPrincipal через [объект Thread](https://msdn.microsoft.com/library/system.threading.thread.aspx) [CurrentPrincipal свойство](https://msdn.microsoft.com/library/system.threading.thread.currentcontext.aspx). Запутанное то, что ASP.NET имеет свои собственные сведения о контексте безопасности (HttpContext.User).

В некоторых случаях проверяется свойство Thread.CurrentPrincipal, при определении контекста безопасности; в других сценариях используется HttpContext.User. Например, есть несколько функций в .NET, которые позволяют разработчикам декларативно указать, какие пользователи или роли можно создать экземпляр класса или вызова определенных методов (см. в разделе [добавления правила авторизации для бизнеса и данных с помощью слоев PrincipalPermissionAttributes](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)). Принципы работы эти декларативные способы определения контекста безопасности через свойство Thread.CurrentPrincipal.

В других сценариях используется свойство HttpContext.User. Например в предыдущем учебном курсе мы использовали это свойство для отображения имени текущего вошедшего пользователя. Очевидно затем, крайне важно сопоставлять что сведения о контексте безопасности, в свойствах Thread.CurrentPrincipal и HttpContext.User.

Среда выполнения ASP.NET автоматически синхронизирует значения этих свойств для нас. Тем не менее, процесс синхронизации происходит после события AuthenticateRequest, но *перед* PostAuthenticateRequest события. Следовательно при добавлении собственного участника безопасности в событии PostAuthenticateRequest нам нужно быть уверенным, чтобы вручную назначить Thread.CurrentPrincipal иначе Thread.CurrentPrincipal и HttpContext.User будут синхронизированы. См. в разделе [Context.User vs. Thread.CurrentPrincipal](http://leastprivilege.com/2005/11/23/context-user-vs-thread-currentprincipal/) более подробный рассказ об этой проблеме.

### <a name="accessing-the-companyname-and-title-properties"></a>Доступ к CompanyName и свойства заголовка

Каждый раз, когда запрос прибывает и отправляется в модуль ASP.NET, приложение\_будет срабатывать OnPostAuthenticateRequest обработчик событий в файле Global.asax. Если запрос была успешно проверена FormsAuthenticationModule, обработчик событий будет создать объект CustomPrincipal с объектом CustomIdentity основании билета проверки подлинности. С подобной логикой на месте доступ к сведениям о название компании текущего пользователя и название невероятно простым.

Вернуться на страницу\_обработчик события загрузки на странице Default.aspx, где на шаге 4 мы написали код для получения билета проверки подлинности форм и анализа UserData свойства, чтобы отобразить название компании и название пользователя. С объектами CustomPrincipal и CustomIdentity теперь используется нет необходимости выполнить синтаксический анализ значения из свойства UserData билета. Вместо этого просто получить ссылку на объект CustomIdentity и используйте его свойства CompanyName и заголовка:

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample12.cs)]

## <a name="summary"></a>Сводка

В этом учебнике мы рассмотрели, как настроить параметры системы проверки подлинности форм с помощью Web.config. Мы рассмотрели способ обработки истечения срока действия билета проверки подлинности и использовании меры безопасности шифрование и проверка предотвратить билет проверки и изменения. Наконец мы рассмотрели, используя свойство UserData билет проверки подлинности для хранения дополнительных сведений о пользователе в билете сам и как использовать пользовательские объекты principal и identity предоставлять эту информацию в виде более удобный для разработчика.

Данный учебный курс завершает Рассмотрение форм проверки подлинности в ASP.NET. Следующее руководство начинается наша стратегия в платформу членства.

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Разбор проверки подлинности форм](http://aspnet.4guysfromrolla.com/articles/072005-1.aspx)
- [Объяснение: Проверка подлинности форм в ASP.NET 2.0](https://msdn.microsoft.com/library/aa480476.aspx)
- [Как выполнить: Защита проверки подлинности форм в ASP.NET 2.0](https://msdn.microsoft.com/library/ms998310.aspx)
- [Professional ASP.NET 2.0 безопасности, членства и управления ролями](http://www.wrox.com/WileyCDA/WroxTitle/productCd-0764596985.html) (ISBN: 978-0-7645-9698-8)
- [Защита элементов управления входа](https://msdn.microsoft.com/library/ms178346.aspx)
- [&lt;Проверки подлинности&gt; элемент](https://msdn.microsoft.com/library/532aee0e.aspx)
- [&lt;Forms&gt; элемент для &lt;проверки подлинности&gt;](https://msdn.microsoft.com/library/1d3t3c61.aspx)
- [&lt;MachineKey&gt; элемент](https://msdn.microsoft.com/library/w8h3skw9.aspx)
- [Основные сведения о билетах проверки подлинности форм и Cookie](https://support.microsoft.com/kb/910443)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a>Учебные видеоматериалы по таким темам, содержащихся в этом руководстве

- [Как изменить свойства проверки подлинности форм](../../../videos/authentication/how-to-change-the-forms-authentication-properties.md)
- [Способ установки и использования проверки подлинности без файлов Cookie в приложении ASP.NET](../../../videos/authentication/how-to-setup-and-use-cookie-less-authentication-in-an-aspnet-application.md)
- [Перемещение входа с проверкой подлинности на основе форм в ASP](../../../videos/authentication/asp-forms-login-relocation.md)
- [Конфигурация пользовательского ключа для входа](../../../videos/authentication/forms-login-custom-key-configuration.md)
- [Добавление пользовательских данных в метод проверки подлинности](../../../videos/authentication/add-custom-data-to-the-authentication-method.md)
- [Использование пользовательских объектов Principal](../../../videos/authentication/use-custom-principal-objects.md)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Основной рецензент этого учебного был Alicja Maziarz. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4guysfromrolla.com).

> [!div class="step-by-step"]
> [Назад](an-overview-of-forms-authentication-cs.md)
> [Вперед](security-basics-and-asp-net-support-vb.md)
