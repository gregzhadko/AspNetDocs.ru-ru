---
uid: web-forms/overview/older-versions-security/introduction/an-overview-of-forms-authentication-vb
title: Обзор проверки подлинности Forms (Visual Basic) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве мы приводит к отключению от простое обсуждений для реализации; в частности мы рассмотрим реализацию проверки подлинности форм. W приложения web...
ms.author: riande
ms.date: 01/14/2008
ms.assetid: 83267f7d-64d9-41ee-82cf-da91b1bf534d
msc.legacyurl: /web-forms/overview/older-versions-security/introduction/an-overview-of-forms-authentication-vb
msc.type: authoredcontent
ms.openlocfilehash: ca290c6b7b6b4f8da92b9658519d716651d46341
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57047331"
---
<a name="an-overview-of-forms-authentication-vb"></a>Обзор проверки подлинности форм (VB)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/ASPNET_Security_Tutorial_02_VB.zip) или [скачать PDF](http://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/aspnet_tutorial02_FormsAuth_vb.pdf)

> В этом руководстве мы приводит к отключению от простое обсуждений для реализации; в частности мы рассмотрим реализацию проверки подлинности форм. Веб-приложение, мы начнем, создав в этом руководстве будут продолжать создаваться на основе в последующих руководствах описывается, как мы переходим от простых форм проверки подлинности к членства и ролей.
> 
> См. Видеоролик, Дополнительные сведения по этой теме: [Обычная проверка подлинности форм в ASP.NET](# "using-basic-forms-authentication-in-aspnet").


## <a name="introduction"></a>Вступление

В [предыдущем учебном курсе](security-basics-and-asp-net-support-vb.md) мы рассмотрели различные проверки подлинности, авторизации и пользователя учетной записи параметры, предоставляемые ASP.NET. В этом руководстве мы приводит к отключению от простое обсуждений для реализации; в частности мы рассмотрим реализацию проверки подлинности форм. Веб-приложение, мы начнем, создав в этом руководстве будут продолжать создаваться на основе в последующих руководствах описывается, как мы переходим от простых форм проверки подлинности к членства и ролей.

Это руководство начинается с подробное описание рабочего процесса проверки подлинности форм, это тема, которую мы рассмотрели при изучении предыдущего руководства. После этого мы создадим веб-сайта ASP.NET через который продемонстрировать основные понятия проверки подлинности форм. Далее мы настроить сайт для проверки подлинности в формах, создание простой страницы входа и узнать, как определить, в коде, ли пользователь проверку подлинности, и если да, имя пользователя, они вошли в систему.

Понимание того, форм, рабочего процесса проверки подлинности, включив в веб-приложения и создания страниц входа и выхода из системы являются все жизненно важных этапов построения приложения ASP.NET, который поддерживает учетные записи пользователей и проверяет подлинность пользователей через веб-страницы. Из-за этого — и так как эти руководства созданы друг с другом - я рекомендую для работы с этим руководством в полном объеме, прежде чем переходить к следующему даже если вы уже имели возможности настройки проверки подлинности форм в прошлых проектов.

## <a name="understanding-the-forms-authentication-workflow"></a>Основные сведения о рабочем процессе проверки подлинности форм

Когда среда выполнения ASP.NET обрабатывает запрос для ресурса ASP.NET, например страницы ASP.NET или веб-службы ASP.NET, запрос Возводит число событий во время его жизненного цикла. Существуют события, возникающие в конце очень начинающим и самого запроса, те, которые вызывается, когда запрос прошел проверку подлинности и авторизацию, событие, вызываемое в случае необработанных исключений и т. д. Чтобы увидеть полный список событий, просмотрите [события объекта HttpApplication](https://msdn.microsoft.com/library/system.web.httpapplication_events.aspx).

*HTTP-модули* — управляемые классы, код которого выполняется в ответ на определенное событие в жизненном цикле запроса. В ASP.NET имеется ряд модулей HTTP, выполнения важных задач за кулисами. Ниже приведены два встроенных модулей HTTP, которые особенно важны для нас.

- **[FormsAuthenticationModule](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)**  -проверяет подлинность пользователя, проверяя билета проверки подлинности, который обычно содержится в коллекции файлов cookie пользователя. Если присутствует не билета проверки подлинности, пользователь является анонимным.
- **[UrlAuthorizationModule](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx)**  -определяет, разрешено ли текущий пользователь для доступа к запрошенному URL-АДРЕСУ. Этот модуль определяет полномочия по журналу правил авторизации, указанных в файлах конфигурации приложения. ASP.NET также включает [FileAuthorizationModule](https://msdn.microsoft.com/library/system.web.security.fileauthorizationmodule.aspx) , определяющий центр по журналу запрошенного файлы списки управления доступом.

FormsAuthenticationModule пытается проверить подлинность пользователя, прежде чем UrlAuthorizationModule (и FileAuthorizationModule) выполнения. Если имя пользователя, отправившего запрос не авторизован для доступа к запрошенному ресурсу, модуль авторизации завершает запрос и возвращает [HTTP 401 несанкционированный](http://www.checkupdown.com/status/E401.html) состояния. В сценарии проверки подлинности Windows состояние HTTP 401 возвращается в браузер. Этот код состояния браузер приглашение ввести свои учетные данные с помощью модального диалогового окна. С помощью форм, тем не менее, состояние HTTP 401 несанкционированный никогда не отправляется в браузер поскольку FormsAuthenticationModule обнаруживает это состояние и изменяет его, чтобы перенаправить пользователя на страницу входа, вместо этого (через [HTTP 302 перенаправления](http://www.checkupdown.com/status/E302.html) состояния).

Ответственность на страницу входа — определить, если учетные данные пользователя действительны, и если да, для создания билета проверки подлинности и перенаправить пользователя на страницу они требовалось посетить. Билет проверки подлинности включается в последующих запросах к страницам на веб-сайт, использующий FormsAuthenticationModule для идентификации пользователя.


[![Рабочий процесс проверки подлинности форм](an-overview-of-forms-authentication-vb/_static/image2.png)](an-overview-of-forms-authentication-vb/_static/image1.png)

**Рис 01**: Рабочий процесс проверки подлинности форм ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image3.png))


### <a name="remembering-the-authentication-ticket-across-page-visits"></a>Запоминание билет проверки подлинности между посещений страницы

После входа в систему, билета проверки подлинности должны отправляться веб-сервере при каждом запросе, так что пользователь остается вошедшего в систему, при просмотре сайта. Обычно это выполняется путем размещения билет проверки подлинности в коллекции файлов cookie пользователя. [Файлы cookie](http://en.wikipedia.org/wiki/HTTP_cookie) маленькие текстовые файлы, которые находятся на компьютере пользователя и передаются в заголовках HTTP для каждого запроса на веб-сайт, который создал файл cookie. Таким образом после создания и сохранены в файлах cookie браузера билет проверки подлинности форм, каждый последующий посещение веб-сайта этого сайта отправляет билет проверки подлинности вместе с запросом, тем самым идентификатором пользователя.

> [!NOTE]
> Демонстрационное веб-приложение, используемые в каждом руководстве, доступен для загрузки. Это загружаемое приложение создано с помощью Visual Web Developer 2008, предназначенных для .NET Framework версии 3.5. Так как приложение предназначено для .NET 3.5, его файл Web.config содержит элементы конфигурации дополнительные, зависящие от 3.5. Короче говоря, если вы еще установка .NET 3.5 на компьютере, затем загружаемые веб-приложение не будет работать без предварительного удаления 3.5-разметку из файла Web.config.


Одним из аспектов файлы cookie является истек их срок действия, который является дата и время, по которому браузер удаляет файл cookie. По истечении срока действия файла cookie проверки подлинности форм, пользователь может больше не прошел проверку подлинности и поэтому стать анонимный. Когда пользователь посещает из общедоступного терминала, скорее всего, они хотят их билет проверки подлинности, срок действия при закрытии браузера. При посещении из дома, однако этого же пользователя может потребоваться возможность запоминать перезапуска браузера, чтобы они не имеют билет проверки подлинности для повторной регистрации в каждом посещении сайта. Часто это решение принимается пользователем в форме флажок Запомнить меня на страницу входа. На шаге 3 мы рассмотрим, как реализовать флажок Запомнить меня на странице входа. Следующие руководства рассматриваются параметры времени ожидания билета проверки подлинности, подробно.

> [!NOTE]
> Вполне возможно, что агент пользователя, который используется для входа на веб-сайта может не поддерживать файлы cookie. В этом случае ASP.NET можно использовать билеты аутентификации форм без поддержки файлов cookie. В этом режиме билет проверки подлинности кодируется в URL-адрес. Мы рассмотрим при использовании билеты без поддержки файлов cookie проверки подлинности и как они создаются и управляются в следующем учебном курсе.


### <a name="the-scope-of-forms-authentication"></a>Область проверки подлинности форм

FormsAuthenticationModule управляемый код, а часть среды выполнения ASP.NET. До выхода версии 7 компании Microsoft [Internet Information Services (IIS)](https://www.iis.net/) веб-сервере произошла distinct барьера между конвейер HTTP в IIS и среда выполнения ASP.NET конвейера. Короче говоря, в IIS 6 и более ранних версиях FormsAuthenticationModule выполняется, только если запрос делегируется среды выполнения ASP.NET с IIS. По умолчанию IIS обрабатывает статического содержимого, сам - например страниц HTML и CSS и файлы изображений — и передает запросы в среду выполнения ASP.NET при запросе страницы с расширением .aspx, .asmx или .ashx.

IIS 7, однако позволяет для интеграции IIS и ASP.NET конвейеров. Некоторые параметры конфигурации можно настроить IIS 7 для вызова FormsAuthenticationModule для *все* запросов. Кроме того со службами IIS 7 можно определить правила авторизации URL-адрес для файлов любого типа. Дополнительные сведения см. в разделе [изменения между IIS6 и системы безопасности в IIS7](https://www.iis.net/learn/get-started/whats-new-in-iis-7/changes-in-security-between-iis-60-and-iis-7-and-above), [ваш веб-платформы безопасности](https://www.iis.net/learn/get-started/whats-new-in-iis-7/iis7-and-above-security-improvements), и [Авторизация URL-адреса IIS7 понимание](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization).

Короче говоря, в версиях, предшествующих IIS 7, можно использовать только проверку подлинности форм для защиты ресурсов, обработано средой выполнения ASP.NET. Аналогичным образом правила авторизации URL-адреса применяются только к ресурсам, которые обрабатываются средой выполнения ASP.NET. Но со службами IIS 7 можно интегрировать FormsAuthenticationModule и UrlAuthorizationModule в конвейер HTTP в IIS, тем самым расширяя эта функция ко всем запросам.

## <a name="step-1-creating-an-aspnet-website-for-this-tutorial-series"></a>Шаг 1. Создание веб-сайта ASP.NET для этой серии руководств

Для достижения максимально широкой аудиторией, мы будем строить с помощью серии веб-сайта ASP.NET будет создана с корпорации Microsoft бесплатную версию Visual Studio 2008, [Visual Web Developer 2008](https://www.microsoft.com/express/vwd/). Мы будем реализовывать в хранилище пользователя SqlMembershipProvider [Microsoft SQL Server 2005 Express Edition](https://msdn.microsoft.com/sql/Aa336346.aspx) базы данных. Если вы используете Visual Studio 2005 или другого выпуска Visual Studio 2008 или SQL Server, не беспокойтесь — действия будут практически идентичны и будет подчеркиваться любой нетривиальный различия.

Перед тем как можно настроить проверку подлинности форм, необходимо сначала на веб-сайте ASP.NET. Начните с создания нового файла на основе системы веб-узла ASP.NET. Для этого необходимо запустить Visual Web Developer и перейдите к меню "файл" и выберите новый веб-сайт, отображает диалоговое окно нового веб-сайта. Выберите шаблон веб-сайт ASP.NET, задайте раскрывающемся списке расположение в файловой системе, выберите папку для размещения веб-сайта и выбранный язык Visual Basic. Это создаст новый веб-сайт со страницей Default.aspx ASP.NET, приложение\_папки данных и файл Web.config.

> [!NOTE]
> Visual Studio поддерживает два режима управления проектом. Проекты веб-сайтов и проектов веб-приложений. Проекты веб-сайта не хватает файл проекта, тогда как Web Application Projects имитируют архитектура проекта в Visual Studio .NET 2002/2003 — они включают файл проекта и компиляции исходного кода проекта в единую сборку, которая размещается в папке/Bin. Проекты Visual Studio 2005 изначально только поддерживаемые веб-сайта, несмотря на то, что было возвращено модели проекта веб-приложения с пакетом обновления 1; Visual Studio 2008 включает в себя оба проекта модели. Visual Web Developer 2005 и 2008 выпусков, однако поддерживают только проектов веб-сайтов. Я буду использовать модели проекта веб-сайта. Если при использовании выпуска отличных от Express и хотите использовать [модели проекта веб-приложения](https://msdn.microsoft.com/library/aa730880(vs.80).aspx) вместо этого вы можете сделать это, но имейте в виду, что могут существовать некоторые несоответствия между отображаемые на экране и действия, которые необходимо выполнить сравнение снимки экрана и следуйте инструкциям в этих учебниках.


[![Создать новый файл на основе системы веб-сайт](an-overview-of-forms-authentication-vb/_static/image5.png)](an-overview-of-forms-authentication-vb/_static/image4.png)

**Рис. 02**: Создание веб-сайта New File System-Based ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image6.png))


### <a name="adding-a-master-page"></a>Добавление главной страницы

Затем добавьте Создание главной страницы на сайт в корневом каталоге с именем Site.master. [Главные страницы](https://msdn.microsoft.com/library/wtxbf3hh.aspx) позволяют разработчику страницы задать шаблон сайта, который можно использовать на страницах ASP.NET. Основным преимуществом главных страниц является то, что общий внешний вид веб-узла можно определить в одном месте, тем самым облегчая процесс для обновления или настроить макет веб-узла.


[![Добавить эталонную страницу с именем Site.master на веб-сайт](an-overview-of-forms-authentication-vb/_static/image8.png)](an-overview-of-forms-authentication-vb/_static/image7.png)

**Рис 03**: Добавление Site.master Master с именем страницы на веб-сайт ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image9.png))


Определение макета страницы для всего здесь на главной странице. Можно использовать представление проектирования и добавьте любые макета или веб-элементы управления, или можно вручную добавить разметку вручную в представлении источника. Я структурировал моей главной страницы макета для имитации макет, используемый в моей *[работа с данными в ASP.NET 2.0](../../data-access/index.md)* серии руководств (см. рис. 4). На главной странице используется [каскадных таблиц стилей](http://www.w3schools.com/css/default.asp) для определения положения и стили CSS параметры, определенные в файле Style.css (включенного в этом руководстве загрузки). Хотя из приведенной ниже разметки этого невозможно определить, правила CSS определены таким образом, чтобы навигации &lt;div&gt;элемента (абсолютное) положение, что отображается слева и имеет фиксированную ширину 200 пикселей.

[!code-aspx[Main](an-overview-of-forms-authentication-vb/samples/sample1.aspx)]

На главной странице определяются как статические, так и регионов, которые могут изменяться страницами ASP.NET, испольузющими эту главную станицу. Изменяемые области обозначаются элементом управления ContentPlaceHolder, который можно увидеть в содержимом &lt;div&gt;. Нас на главной странице имеет единый ContentPlaceHolder (MainContent), но главной страницы может быть и несколько.

С помощью введете указанную выше разметку переключение в режим конструктора показан макет главной страницы. Любая страница ASP.NET, использующая эту главную страницу будет иметь этот единообразного расположения, с возможностью указать разметку для области MainContent.


[![Главной страницы, при просмотре в режиме конструктора](an-overview-of-forms-authentication-vb/_static/image11.png)](an-overview-of-forms-authentication-vb/_static/image10.png)

**Рис. 04**: главной страницы, при просмотре через режим конструктора ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image12.png))


### <a name="creating-content-pages"></a>Создание страниц содержимого

На этом этапе у нас есть страницу Default.aspx в наш веб-сайт, но он не использует главную страницу, которую мы только что создали. Хотя и существует возможность управлять декларативная разметка веб-страницы, использующие эталонную страницу, если страница не содержит любое содержимое еще проще просто удалить страницу и повторно добавьте его в проект, указав главную страницу для использования. Таким образом начните, удалив файл Default.aspx из проекта.

Затем щелкните правой кнопкой мыши имя проекта в обозревателе решений и выберите Добавление нового веб-формы с именем Default.aspx. На этот раз, установите флажок Выбрать главную страницу и выберите из списка страницей Site.master.


[![Добавьте новую страницу Default.aspx, решили Выбор главной страницы](an-overview-of-forms-authentication-vb/_static/image14.png)](an-overview-of-forms-authentication-vb/_static/image13.png)

**05 рис**: Добавить новый Default.aspx страницы решили Выбор главной страницы ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image15.png))


[![Использовать Site.master главной страницы](an-overview-of-forms-authentication-vb/_static/image17.png)](an-overview-of-forms-authentication-vb/_static/image16.png)

**Рис 06**: Использовать Site.master главной страницы ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image18.png))


> [!NOTE]
> При использовании модели проекта веб-приложения в диалоговом окне Добавить новый элемент не включает флажок Выбрать главную страницу. Вместо этого необходимо добавить элемент типа форма веб-содержимого. После выбора параметра форма веб-содержимого и нажатия кнопки Добавить, Visual Studio отобразит же Select шаблона диалоговое окно, показанное на рис. 6.


Декларативная разметка новая страница Default.aspx просто содержит @Page директива, указав путь к главной странице файл и элемент управления содержимым для элемента ContentPlaceHolder на главной странице MainContent.

[!code-aspx[Main](an-overview-of-forms-authentication-vb/samples/sample2.aspx)]

Пока оставьте пустым Default.aspx. Мы вернемся к нему позже в этом руководстве для добавления содержимого.

> [!NOTE]
> Нас на главной странице содержит раздел для меню или другой интерфейс навигации. В следующем учебном курсе мы создадим такой интерфейс.


## <a name="step-2-enabling-forms-authentication"></a>Шаг 2. Включение проверки подлинности форм

ASP.NET веб-сайт создан DAL следующей задачей является возможность проверки подлинности форм. Настройка проверки подлинности приложения указывается с помощью [ &lt;проверки подлинности&gt; элемент](https://msdn.microsoft.com/library/532aee0e.aspx) в файле Web.config. &lt;Проверки подлинности&gt; элемент содержит один атрибут с именем mode, указывающее модель проверки подлинности, используемые приложением. Этот атрибут может иметь одно из следующих четырех значений:

- **Windows** — как описано в предыдущем учебном курсе, когда приложение использует проверку подлинности Windows отвечает веб сервера для проверки подлинности посетитель, и обычно это делается через Basic, Digest или встроенная Windows Проверка подлинности.
- **Forms**-пользователи проходят проверку подлинности через форму на веб-странице.
- **Passport**-пользователи проходят проверку подлинности с помощью Microsoft Passport Network.
- **Нет**-модель проверки подлинности не используется; все посетители являются анонимными.

По умолчанию приложения ASP.NET использовать проверку подлинности Windows. Чтобы изменить тип проверки подлинности для проверки подлинности форм, затем нам нужно изменить &lt;проверки подлинности&gt; атрибут режима элемента формы.

Если проект еще не содержит файл Web.config, добавьте один теперь, щелкнув правой кнопкой мыши имя проекта в обозревателе решений, выбрав Add New Item и затем добавление файла конфигурации веб-узла.


[![Если проект еще не содержит файл Web.config, добавьте его сейчас](an-overview-of-forms-authentication-vb/_static/image20.png)](an-overview-of-forms-authentication-vb/_static/image19.png)

**07 рис**: Если ваш проект Does не еще включают Web.config, добавьте его теперь ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image21.png))


Затем найдите &lt;проверки подлинности&gt; элемента и обновление его для использования проверки подлинности форм. После этого изменения файла Web.config разметка должна выглядеть следующим:

[!code-xml[Main](an-overview-of-forms-authentication-vb/samples/sample3.xml)]

> [!NOTE]
> Поскольку XML-файл Web.config, регистр важен. Убедитесь, что устанавливают атрибут режима в формы, с заглавной буквы F. Если вы используете другой регистр символов, такие как формы, вы получите ошибку конфигурации при посещении узла через браузер.


&lt;Проверки подлинности&gt; элемента может включать &lt;forms&gt; дочерний элемент, содержащий параметры проверки подлинности форм. Пока Давайте просто использовать параметры по умолчанию для проверки подлинности форм. Мы изучим &lt;forms&gt; дочерний элемент более подробно в следующем учебном курсе.

## <a name="step-3-building-the-login-page"></a>Шаг 3. Создание страницы входа

Для поддержки проверки подлинности форм наш веб-сайт должен страницу входа. Как уже говорилось в основные сведения о разделе рабочий процесс проверки подлинности Forms FormsAuthenticationModule автоматически перенаправит пользователя на страницу входа при попытке получить доступ к странице, которым они не имеют прав для просмотра. Кроме того, существуют также элементы управления ASP.NET Web, отображается ссылка на страницу входа для анонимных пользователей. Это вызывает вопрос, что такое URL-адрес страницы входа?

По умолчанию системой проверки подлинности форм ожидает, что страница входа на с именем Login.aspx и помещается в корневом каталоге веб-приложения. Если вы хотите использовать URL-адрес входа на разные страницы, это можно сделать, указав его в файле Web.config. Мы увидим, как это сделать в следующем руководстве.

На страницу входа имеет три функциональные обязанности.

1. Предоставьте интерфейс, позволяющий посетителя вводить свои учетные данные.
2. Определите, если отправленные учетные данные недопустимы.
3. Вход пользователя путем создания билета проверки подлинности форм.

### <a name="creating-the-login-pages-user-interface"></a>Создание пользовательского интерфейса на страницу входа

Давайте начнем с первой задачи. Добавьте новую страницу ASP.NET в корневой каталог веб-узла, с именем Login.aspx и свяжите его с главной страницей Site.master.


[![Добавьте новую страницу ASP.NET с именем Login.aspx](an-overview-of-forms-authentication-vb/_static/image23.png)](an-overview-of-forms-authentication-vb/_static/image22.png)

**Рис 08**: Добавление нового ASP.NET страницы с именем Login.aspx ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image24.png))


Интерфейс страницы входа обычно состоит из два текстовых поля — одно для имени пользователя, по одному для их пароль — и кнопку, чтобы отправить форму. Веб-узлы зачастую Запомнить мои установить флажок для включения, если этот флажок установлен, сохраняет полученный билет проверки подлинности между перезагрузками браузера.

Добавьте два текстовых поля на страницу Login.aspx и задавать их свойства ID, имя пользователя и пароль, соответственно. Также можно задайте свойство TextMode пароля пользователя пароль. Добавьте элемент управления CheckBox, устанавливая его свойство ID RememberMe и его свойства Text запомнить Me. После этого добавьте кнопку с именем LoginButton, свойства которого текст устанавливается с именем входа. И наконец, добавьте элемент управления Label Web и установите его свойство ID InvalidCredentialsMessage, его свойства Text свое имя пользователя или пароль является недопустимым. Повторите попытку позже., его свойства ForeColor на красный, а свойство Visible в значение False.

На этом этапе экран должен выглядеть как снимке на рис. 9 экрана и декларативный синтаксис страницы должна выглядеть следующим:

[!code-aspx[Main](an-overview-of-forms-authentication-vb/samples/sample4.aspx)]


[![На страницу входа содержит два текстовых поля, CheckBox, кнопки и метки](an-overview-of-forms-authentication-vb/_static/image26.png)](an-overview-of-forms-authentication-vb/_static/image25.png)

**Рис 09**: Имя входа страницы содержит два текстовых поля, флажок, кнопку и метку ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image27.png))


Наконец, создайте обработчик событий для нажатия LoginButton событий. В конструкторе дважды щелкните элемент управления Button, чтобы создать этот обработчик событий.

### <a name="determining-if-the-supplied-credentials-are-valid"></a>Определение, если предоставленные учетные данные допустимы

Теперь нам нужно реализовать задача 2 в Click кнопки обработчик событий — определить, допустимы ли указанные учетные данные. Для этого необходимо настроить хранилище пользователя, который содержит все учетные данные пользователей, чтобы мы могли определить, если предоставленные учетные данные соответствуют все известные учетные данные.

До версии ASP.NET 2.0 разработчикам было ответственный за внедрение оба собственные хранилища пользователя и написания кода, чтобы проверить предоставленные учетные данные в хранилище. Большинство разработчиков реализовали бы хранилище пользователя в базе данных, создание таблицы с именами пользователей с столбцы, такие как имя пользователя, пароль, адрес электронной почты, LastLoginDate и т. д. Тогда, эта таблица будет содержать одну запись для каждой учетной записи пользователя. Проверка того, предоставленные учетные данные пользователя будет включать в себя запрос в базу данных для сопоставления имени пользователя и гарантируя, что введенный пароль предоставивших пароль в базе данных.

В ASP.NET 2.0 разработчикам следует использовать один из поставщиков участия для управления в хранилище пользователя. В этой серии руководств мы используем SqlMembershipProvider, который использует базу данных SQL Server для хранилища пользователя. При использовании SqlMembershipProvider, нам нужно реализовать схему конкретной базы данных, включает таблицы, представления и хранимые процедуры, ожидаемый поставщиком. Мы рассмотрим, как реализация этой схемы в *[Создание схемы членства в SQL Server](../membership/creating-the-membership-schema-in-sql-server-vb.md)* руководства. С поставщиком членства в месте, проверка учетных данных пользователя осуществляется простым вызовом [класс членства](https://msdn.microsoft.com/library/system.web.security.membership.aspx) [ValidateUser (*username*, *пароль*) метод](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx), который возвращает логическое значение, указывающее, является ли допустимость *имя пользователя* и *пароль* сочетания. Зная, как мы еще не реализован SqlMembershipProvider хранилище пользователя, мы класс членства ValidateUser метод нельзя использовать в настоящее время.

А не тратить время на создание собственных пользовательских пользователей таблицы базы данных (что бывает устаревшим после мы реализовали SqlMembershipProvider), давайте вместо жестко действительные учетные данные в имени входа странице сам. LoginButton выберите обработчик событий, добавьте следующий код:

[!code-vb[Main](an-overview-of-forms-authentication-vb/samples/sample5.vb)]

Как вы видите, существуют три действительные учетные записи пользователей — Скотт, Цзисунь и Сэм — и все три класса имеют один и тот же пароль (пароль). Код проходит через массивы пользователей и паролей, ищет совпадение допустимое имя пользователя и пароль. Если имя пользователя и пароль являются допустимыми, необходимо войти в систему пользователя и затем перенаправлять их на соответствующую страницу. Если учетные данные недействительны, после чего мы отображаем InvalidCredentialsMessage метки.

Если пользователь введет действительные учетные данные, я упомянул, что затем они перенаправляются на соответствующую страницу. Что такое соответствующей странице, хотя? Помните, что при посещении пользователем страницы, которые не авторизованы для просмотра, FormsAuthenticationModule автоматически перенаправит его на страницу входа. Таким образом, он включает запрошенного URL-адреса в строке запроса через параметр ReturnUrl. То есть если пользователь пытался посетите ProtectedPage.aspx, и им не было разрешено для этого, FormsAuthenticationModule перенаправит их:

Login.aspx?ReturnUrl=ProtectedPage.aspx

После успешного входа в систему пользователь должен перенаправляться к ProtectedPage.aspx. Кроме того пользователи могут найти на страницу входа в свои собственные желанию. В этом случае после входа пользователя они должны отправляться на страницу Default.aspx в корневую папку.

### <a name="logging-in-the-user"></a>Вход пользователя

Предположим, что предоставленные учетные данные являются допустимыми, необходимо создать билет проверки подлинности форм, тем самым входа пользователя на сайт. [Класс FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthentication.aspx) в [пространства имен System.Web.Security](https://msdn.microsoft.com/library/system.web.security.aspx) предоставляет различные методы для ведения журнала в и ведения журнала, пользователей с помощью форм системой проверки подлинности. Хотя существует несколько методов в классе FormsAuthentication, которые нас интересуют на этом этапе встречаются:

- [GetAuthCookie (*username*, *persistCookie*)](https://msdn.microsoft.com/library/system.web.security.formsauthentication.getauthcookie.aspx) -создает билет проверки подлинности форм для предоставленного имени *username*. Затем этот метод создает и возвращает объект HttpCookie, который содержит содержимое билет проверки подлинности. Если *persistCookie* имеет значение True, создается постоянный файл cookie.
- [SetAuthCookie (*username*, *persistCookie*)](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) -вызывает GetAuthCookie (*username*, *persistCookie*) метод для создания файла cookie проверки подлинности форм. Затем этот метод добавляет файл cookie, возвращенный GetAuthCookie к коллекции (при условии, что форм на основе файлов cookie проверки подлинности, используемые; в противном случае, этот метод вызывает внутренний класс, обрабатывающий логику без поддержки файлов cookie билета).
- [RedirectFromLoginPage (*username*, *persistCookie*)](https://msdn.microsoft.com/library/system.web.security.formsauthentication.redirectfromloginpage.aspx) -этот метод вызывает SetAuthCookie (*username*, *persistCookie*) и затем перенаправляет пользователя на соответствующую страницу.

GetAuthCookie удобно в тех случаях, когда необходимо изменить билет проверки подлинности перед записи файла cookie в коллекции файлов cookie. SetAuthCookie полезно в том случае, если создание билета проверки подлинности форм и добавить его в коллекцию файлов cookie, но не хотите перенаправить пользователя на соответствующую страницу. Возможно, вам необходимо сохранить их на странице входа или отправлять их на альтернативные страницу.

Поскольку нам требуется вход пользователя и перенаправит их на соответствующую страницу, давайте используем RedirectFromLoginPage. Обновить LoginButton нажмите кнопку обработчика событий, заменив два закомментированных строк TODO следующую строку кода:

FormsAuthentication.RedirectFromLoginPage(UserName.Text, RememberMe.Checked)

При создании билета проверки подлинности форм, мы используем свойство Text текстового поля имени пользователя для билета проверки подлинности *username* параметра и проверенное состояние объекта флажок RememberMe  *persistCookie* параметра.

Чтобы протестировать страницы входа, посетите его в браузере. Начните с ввода недействительные учетные данные, такие как Nope именем пользователя и паролем Неизвестная ошибка. После нажатия кнопки кнопки входа произойдет обратная передача, и будет отображаться метка InvalidCredentialsMessage.


[![Метка InvalidCredentialsMessage — отображаются при вводе неверных учетных данных](an-overview-of-forms-authentication-vb/_static/image29.png)](an-overview-of-forms-authentication-vb/_static/image28.png)

**Рис. 10**: Метка InvalidCredentialsMessage — отображаются при вводе неверных учетных данных ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image30.png))


Затем введите действительные учетные данные и нажмите кнопку "Вход". Это время, при обратной передаче билета проверки подлинности создается и вы будете автоматически перенаправлены обратно на Default.aspx. На этом этапе вы вошли на веб-сайт, несмотря на то, что нет никаких визуальных подсказок, чтобы указать, что вы вошли. На шаге 4, будет показано, как программно определять, может ли пользователь регистрируется в или не, а также способ идентификации пользователя, посещающего страницу.

Шаг 5 рассматриваются методы для ведения журнала пользователя из веб-сайта.

### <a name="securing-the-login-page"></a>Обеспечение безопасности на страницу входа

Когда пользователь вводит свои учетные данные и отправляет форму страницы входа, учетные данные, — включая свой пароль - передаются через Интернет на веб-сервер в *обычный текст*. Это означает, что любой злоумышленник, проанализировать сетевой трафик можно увидеть имя пользователя и пароль. Чтобы избежать этого, очень важно для шифрования сетевого трафика с помощью [Secure слои сокетов (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer). Это позволит гарантировать, что учетные данные (а также всей страницы HTML-разметка) будут зашифрованы с момента они покидают браузера, пока они не будут получены веб-сервером.

Если веб-сайт не содержит конфиденциальную информацию, будет достаточно для использования SSL на странице входа, а также на других страницах пароля бы в противном случае отправки по сети в виде обычного текста. Не нужно беспокоиться о защите билета проверки подлинности форм, так как, по умолчанию, он как шифрования и цифровой подписью (чтобы предотвратить незаконное изменение). Более подробное обсуждение безопасности билет проверки подлинности forms представлены в следующем учебном курсе.

> [!NOTE]
> Многие финансовые и медицинские веб-сайты настроены для использования SSL на *все* страницы, доступной для прошедших проверку пользователей. При создании такого веб-сайта, система проверки подлинности форм можно настроить таким образом, чтобы только билета проверки подлинности передается через безопасное подключение. Мы рассмотрим различные параметры конфигурации для форм проверки подлинности в следующем учебном курсе,  *[конфигурацию проверки подлинности форм и дополнительные разделы](../membership/creating-the-membership-schema-in-sql-server-vb.md)*.


## <a name="step-4-detecting-authenticated-visitors-and-determining-their-identity"></a>Шаг 4. Обнаружение прошедшего проверку подлинности посетителей и определения их удостоверений

На этом этапе мы включена проверка подлинности форм и создать страницу элементарные входа, но у нас есть еще для проверки того, как мы можно определить, является ли пользователь проверку подлинности или анонимные. В некоторых сценариях нужно отображать сведения в зависимости от ли проверку подлинности или анонимный пользователь использует страницы или другие данные. Кроме того мы часто нужно знать удостоверение пользователя, прошедшего проверку подлинности.

Давайте расширить существующую страницу Default.aspx, чтобы продемонстрировать данные методы. На странице Default.aspx добавьте двумя Панельными элементами управления, один именованный AuthenticatedMessagePanel и другой именованный AnonymousMessagePanel. Добавьте элемент управления Label с именем WelcomeBackMessage на первой панели. На второй панели добавьте элемент управления HyperLink, установите его свойство Text на вход в систему и свойства NavigateUrl на ~ / Login.aspx. На этом этапе декларативная разметка для Default.aspx должен выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-forms-authentication-vb/samples/sample6.aspx)]

Как вы уже, вероятно, догадались, здесь суть для отображения только AuthenticatedMessagePanel для прошедшего проверку подлинности посетителей и просто AnonymousMessagePanel для анонимных пользователей. Для этого нам нужно установить эти панели видимых свойств в зависимости от того, вошел ли пользователь или нет.

[Request.IsAuthenticated свойство](https://msdn.microsoft.com/library/system.web.httprequest.isauthenticated.aspx) возвращает логическое значение, указывающее, прошел ли запрос проверку подлинности. Введите следующий код в страницу\_загрузить код обработчика событий:

[!code-vb[Main](an-overview-of-forms-authentication-vb/samples/sample7.vb)]

Этот код в месте посетите Default.aspx через браузер. Если у вас еще выполнить вход, вы увидите ссылку на страницу входа (см. рис. 11). Щелкните эту ссылку и войдите на сайт. Как мы видели в шаге 3, после ввода учетных данных вы вернетесь к странице Default.aspx, но на этот раз страница показывает Добро пожаловать! сообщения (см. рис. 12).


[![При посещении анонимно, ссылка журнала в отображении](an-overview-of-forms-authentication-vb/_static/image32.png)](an-overview-of-forms-authentication-vb/_static/image31.png)

**Рис. 11**: Отображается при просмотре анонимно, ссылка в журнал ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image33.png))


[![Прошедшие проверку подлинности пользователи отображаются Добро пожаловать! Сообщение](an-overview-of-forms-authentication-vb/_static/image35.png)](an-overview-of-forms-authentication-vb/_static/image34.png)

**Рис. 12**: Прошедшие проверку подлинности пользователи отображаются Добро пожаловать! Сообщение ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image36.png))


Мы можем определить удостоверение текущего пользователя через [объекта HttpContext](https://msdn.microsoft.com/library/system.web.httpcontext.aspx) [свойство пользователя](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx). Объект HttpContext представляет сведения о текущем запросе и является центром для таких распространенных объектов ASP.NET, как ответ, запроса и сеанса, среди прочего. Свойства пользователя представляет контекст безопасности текущего HTTP-запроса и реализует [интерфейс IPrincipal](https://msdn.microsoft.com/library/system.security.principal.iprincipal.aspx).

Свойства пользователя задается FormsAuthenticationModule. В частности когда FormsAuthenticationModule находит билета проверки подлинности во входящем запросе, он создает новый объект GenericPrincipal и присваивает его свойству пользователя.

Объекты-участники (такие как GenericPrincipal) предоставляют сведения о личности пользователя и роли, к которым они относятся. Интерфейс IPrincipal определяет два члена:

- [IsInRole (*roleName*)](https://msdn.microsoft.com/library/system.security.principal.iprincipal.isinrole.aspx) -метод, возвращающий логическое значение, указывающее, принадлежит ли участник в указанную роль.
- [Удостоверение](https://msdn.microsoft.com/library/system.security.principal.iprincipal.identity.aspx) -свойство, которое возвращает объект, реализующий [интерфейс IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx). Интерфейс IIdentity определяет три свойства: [AuthenticationType](https://msdn.microsoft.com/library/system.security.principal.iidentity.authenticationtype.aspx), [IsAuthenticated](https://msdn.microsoft.com/library/system.security.principal.iidentity.isauthenticated.aspx), и [имя](https://msdn.microsoft.com/library/system.security.principal.iidentity.name.aspx).

Можно определить имя текущего посетителя, используя следующий код:

Dim currentUsersName As String = User.Identity.Name

Когда с помощью форм проверки подлинности, [FormsIdentity объект](https://msdn.microsoft.com/library/system.web.security.formsidentity.aspx) создается для GenericPrincipal свойство Identity. Класс FormsIdentity всегда возвращает Forms строку для свойства AuthenticationType и True для его свойства IsAuthenticated. Свойство Name возвращает имя пользователя, указанный при создании билета проверки подлинности форм. В дополнение к эти три свойства FormsIdentity включает доступ к базовой билет проверки подлинности с помощью его [билета свойство](https://msdn.microsoft.com/library/system.web.security.formsidentity.ticket.aspx). Билет свойство возвращает объект типа [FormsAuthenticationTicket](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.aspx), который имеет свойства, такие как срок действия, IsPersistent, IssueDate, имя и т. д.

Важно убрать здесь является то, что *username* параметр, указанный в FormsAuthentication.GetAuthCookie (*username*, *persistCookie*), FormsAuthentication.SetAuthCookie (*username*, *persistCookie*) и метод FormsAuthentication.RedirectFromLoginPage (*username*, *persistCookie*) методы — это же значение, возвращаемое User.Identity.Name. Кроме того билет проверки подлинности, созданные при использовании этих методов доступна, приведение User.Identity объекту FormsIdentity и затем при обращении к свойству билета:

Dim ident As FormsIdentity = CType(User.Identity, FormsIdentity)

Dim authTicket As FormsAuthenticationTicket = ident.Ticket

Давайте предоставим более персонализированные сообщения в файле Default.aspx. Обновление страницы\_загрузки обработчика событий, таким образом, чтобы метки WelcomeBackMessage свойство Text присваивается строка приветствия, *username*!

WelcomeBackMessage.Text = "Welcome back, " &amp; User.Identity.Name &amp; "!"

Рис. 13 показан результат этого изменения (при входе в систему как пользователь Скотт).


[![Приветственное сообщение включает в себя пользователя в имени пользователя](an-overview-of-forms-authentication-vb/_static/image38.png)](an-overview-of-forms-authentication-vb/_static/image37.png)

**Рис. 13**: Приветственное сообщение включает в себя в настоящее время регистрируются в имя пользователя ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image39.png))


### <a name="using-the-loginview-and-loginname-controls"></a>Используя LoginView и элементы управления LoginName

Отображение различное содержимое для прошедшего проверку подлинности и анонимных пользователей часто используется; Поэтому отображает имя текущего пользователя. По этой причине в ASP.NET имеются два веб-элементы управления, которые обеспечивают ту же функциональность, показанный на рис. 13, но не требуется писать ни одной строки кода.

[Элемента управления LoginView](https://msdn.microsoft.com/library/system.web.ui.webcontrols.loginview.aspx) является на основе шаблона веб-элемент управления, облегчающий отображают различные данные для прошедшего проверку подлинности и анонимных пользователей. LoginView используются два стандартных шаблона:

- AnonymousTemplate - любую разметку, добавляемый в этот шаблон отображается только для анонимных пользователей.
- LoggedInTemplate - разметки этот шаблон отображается только пользователям, прошедшим проверку.

Давайте добавим элемент управления LoginView главную страницу наш сайт, Site.master. Вместо добавления только элемента управления LoginView, давайте добавим обоих нового элемента ContentPlaceHolder элемента управления, а затем указать элемент управления LoginView в рамках этого нового элемента ContentPlaceHolder. Скоро станет очевидным обоснование для этого решения.

> [!NOTE]
> Помимо AnonymousTemplate и LoggedInTemplate элемент управления LoginView могут включать шаблоны конкретной роли. Шаблоны для конкретных ролей Показать разметку только для пользователей, принадлежащих к определенной роли. В следующем учебном курсе мы рассмотрим возможности элемента управления LoginView на основе ролей.


Начните с добавления элемента ContentPlaceHolder, с именем LoginContent в файл главной страницы в области навигации &lt;div&gt; элемент. Можно просто перетащить элемент управления ContentPlaceHolder из области элементов в представлении источника, поместив разметка прямо над разделом TODO: Меню будет здесь текст.

[!code-aspx[Main](an-overview-of-forms-authentication-vb/samples/sample8.aspx)]

Добавьте элемент управления LoginView в LoginContent ContentPlaceHolder. Содержимое, помещаются в элементы управления ContentPlaceHolder на главной странице, считаются *по умолчанию содержимое* для элемента ContentPlaceHolder. То есть страницы ASP.NET, использующая эту главную страницу можно указать свой собственный контент для каждого элемента ContentPlaceHolder или использовать содержимое главной страницы по умолчанию.

LoginView и другие элементы управления входа расположены на вкладке панели элементов имени входа.


[![На панели инструментов элемента управления LoginView](an-overview-of-forms-authentication-vb/_static/image41.png)](an-overview-of-forms-authentication-vb/_static/image40.png)

**Рис. 14**: На панели инструментов элемента управления LoginView ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image42.png))


Добавьте два &lt;br /&gt; элементов сразу после элемента управления LoginView, но по-прежнему внутри элемента ContentPlaceHolder. На этом этапе навигации &lt;div&gt; элемента должна выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-forms-authentication-vb/samples/sample9.aspx)]

Можно определить шаблоны LoginView из конструктора или декларативной разметке. В конструкторе Visual Studio разверните LoginView смарт-тег, который перечисляет настроенные шаблоны, в раскрывающемся списке. Введите текст Hello, незнакомого в AnonymousTemplate; затем добавьте элемент управления гиперссылки и задайте свойства, текст и NavigateUrl на вход в систему и ~ / Login.aspx, соответственно.

После настройки AnonymousTemplate, переключитесь на LoggedInTemplate и ввода текста, «Добро пожаловать,». Затем перетащите элемент управления LoginName из области элементов в LoggedInTemplate, поместив его непосредственно после «Добро пожаловать,» текст. [Управления LoginName](https://msdn.microsoft.com/library/system.web.ui.webcontrols.loginname.aspx), как предполагает название, имя пользователя, выполнившего вход. На внутреннем уровне управления LoginName просто выводит свойство User.Identity.Name

После внесения этих изменений в шаблоны LoginView, разметка должна выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-forms-authentication-vb/samples/sample10.aspx)]

В результате этого добавления к главной странице Site.master каждая страница в наш веб-сайт будет отображаться различные сообщения в зависимости от того, является ли пользователь проверку подлинности. Рис. 15 приведен на странице Default.aspx, при посещении через браузер пользователя Цзисунь. Добро пожаловать, Цзисунь, сообщение будет повторяться два раза: один раз в разделе на главной странице навигации в левой части (с помощью элемента управления LoginView, мы только что добавили) и один раз в файле Default.aspx содержимого области (с помощью панели элементов управления и программная логика).


[![Отображает элемент управления LoginView приветствия снова Цзисунь.](an-overview-of-forms-authentication-vb/_static/image44.png)](an-overview-of-forms-authentication-vb/_static/image43.png)

**Рис. 15**: Отображает элемент управления LoginView приветствия снова Цзисунь. ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image45.png))


Так как мы добавили LoginView на главную страницу, она может отображаться на каждой странице на нашем сайте. Тем не менее могут существовать веб-страниц где мы не хотим показывать это сообщение. Одну страницу является страница входа, так как ссылка на страницу входа кажется неуместными существует. Так как мы разместили элемент управления LoginView в ContentPlaceHolder на главной странице, мы Эта разметка по умолчанию можно переопределить на нашей странице содержимого. Откройте страницу Login.aspx и перейдите в конструктор. Так как мы не определен явно элемент управления содержимым в Login.aspx LoginContent ContentPlaceHolder на главной странице, на странице входа будет отображаться разметки главной страницы по умолчанию для этого элемента ContentPlaceHolder. Это можно увидеть через конструктор - LoginContent ContentPlaceHolder показана разметка по умолчанию (элемент управления LoginView).


[![Страница входа отображается по умолчанию содержимое для элемента ContentPlaceHolder на главной странице LoginContent](an-overview-of-forms-authentication-vb/_static/image47.png)](an-overview-of-forms-authentication-vb/_static/image46.png)

**Рис. 16**: На страницу входа отображается по умолчанию содержимое для элемента ContentPlaceHolder на главной странице LoginContent ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image48.png))


Чтобы переопределить стандартную разметку для LoginContent ContentPlaceHolder, просто щелкните правой кнопкой мыши в области конструктора и выберите параметр создания пользовательского содержимого в контекстном меню. (Если использовать Visual Studio 2008 ContentPlaceHolder включают в себя область смарт-тега, при выборе предлагает тот же параметр.) Это добавляет нового содержимого элемента управления в разметке страницы и тем самым позволяет определить пользовательское содержимое для этой страницы. Можно добавить пользовательское сообщение, например, выполните вход, но давайте просто оставьте это поле пустым.

> [!NOTE]
> В Visual Studio 2005 при создании пользовательского содержимого создается пустой содержимого элемента управления на странице ASP.NET. В Visual Studio 2008 Однако создание пользовательского содержимого копирует содержимое главной страницы по умолчанию в только что созданный элемент управления содержимым. Если вы используете Visual Studio 2008, затем, после создания нового содержимого элемента управления убедитесь, что для очистки содержимого, копируемые из главной страницы.


Рис. 17 показано на страницу Login.aspx при посещении страниц в браузере после внесения этого изменения. Обратите внимание, что не Hello, stranger или Добро пожаловать *username* сообщения в области навигации слева &lt;div&gt; как при посещении Default.aspx.


[![На страницу входа скрывает разметки элемента LoginContent ContentPlaceHolder по умолчанию](an-overview-of-forms-authentication-vb/_static/image50.png)](an-overview-of-forms-authentication-vb/_static/image49.png)

**Рис. 17**: На страницу входа скрывает разметки LoginContent ContentPlaceHolder по умолчанию ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image51.png))


## <a name="step-5-logging-out"></a>Шаг 5. При выходе

На шаге 3 мы рассмотрели создание страницу входа для входа пользователя в систему на сайте, но мы еще должен проверить, как выполнить выход пользователя. Помимо методов для входа пользователя в FormsAuthentication класс также предоставляет [SignOut метод](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx). Метод SignOut просто уничтожает билета проверки подлинности, тем самым ведение журнала пользователя из узла.

Предлагают журнал out ссылка — это стандартная функция ASP.NET включает в себя элемент управления, специально разработанные для выхода пользователя. [Управления LoginStatus](https://msdn.microsoft.com/library/system.web.ui.webcontrols.loginstatus.aspx) отображает LinkButton входа или выхода LinkButton, в зависимости от состояния проверки подлинности пользователя. Имя входа LinkButton подготавливается к просмотру для анонимных пользователей, то время как LinkButton выхода отображается пользователям, прошедшим проверку. Текст для имени входа и выхода из системы элементов управления LinkButton могут быть настроены с помощью параметра LoginStatus LoginText и LogoutText свойства.

Щелчок LinkButton входа вызывает обратную передачу, из которого выпускается перенаправление на страницу входа. Щелчок LinkButton выхода заставляет элемент управления LoginStatus для вызова метода FormsAuthentication.SignOff и затем перенаправляет пользователя на страницу. Страница, вошедших в систему сеанс пользователя перенаправляется зависит от свойства LogoutAction, которое может быть назначено одному из трех следующих значений:

- Обновление — по умолчанию. перенаправляет пользователя на страницу, на который они просто посещаете. Если страница, которую они просто посещения не позволяет анонимным пользователям, затем FormsAuthenticationModule будет автоматически перенаправлять пользователя на страницу входа.

Возможно, чтобы узнать, почему здесь выполняется перенаправление. Если пользователь хочет остаются на той же странице, почему необходимости явного перенаправления? Причина в том, так как при щелчке элемента управления LinkButton выхода из системы, пользователь по-прежнему имеет билета проверки подлинности в своей коллекции файлов cookie. Поэтому обратного запроса является запрос с проверкой подлинности. Элемент управления LoginStatus вызывает метод SignOut, однако это происходит после FormsAuthenticationModule проверки подлинности пользователя. Таким образом явного перенаправления браузер для повторного запроса страницы. Когда браузер повторно запрашивает страницу билета проверки подлинности была удалена, и поэтому входящего запроса является анонимным.

- Перенаправление - пользователь перенаправляется на URL-адрес, указанный в свойстве LogoutPageUrl LoginStatus.
- RedirectToLoginPage - пользователь перенаправляется на страницу входа.

Добавим элемент управления LoginStatus на главную страницу и настроить его для использования перенаправления параметр будет перенаправлен на страницу, на которой отображается сообщение, подтверждающее, что они вышли из системы. Начните с создания страницу в корневом каталоге с именем Logout.aspx. Не забудьте связать эту страницу со страницей Site.master. Затем введите сообщение в разметке страницы, объясняющее пользователю, который они отключены.

Затем вернуться на главную страницу Site.master и добавьте элемент управления LoginStatus под LoginView в LoginContent ContentPlaceHolder. Значение свойства элемента управления LoginStatus LogoutAction перенаправление и его свойство LogoutPageUrl ~/Logout.aspx.

[!code-aspx[Main](an-overview-of-forms-authentication-vb/samples/sample11.aspx)]

Поскольку за пределами элемента управления LoginView LoginStatus, он будет отображаться для пользователей, прошедших проверку подлинности и анонимный, но это нормально, так как LoginStatus будет правильно отображать имя входа или выхода LinkButton. С появлением элемента управления LoginStatus гиперссылки в журнал в AnonymousTemplate является излишним, поэтому удалите его.

Рис. 18 показана Default.aspx, когда Цзисунь посещает. Обратите внимание, что в левом столбце отображается сообщение, Добро пожаловать, Цзисунь и ссылка для выхода. Щелкните Выход LinkButton вызывает обратную передачу, Цзисунь выходит из системы и затем перенаправляет ей Logout.aspx. Как показано на рис. 19, к моменту Цзисунь достигает Logout.aspx она уже выхода и таким образом является анонимным. Следовательно в левом столбце показаны текст приветствия, странное и ссылку на страницу входа.


[![Добро пожаловать, Цзисунь, а также LinkButton выхода показывает Default.aspx](an-overview-of-forms-authentication-vb/_static/image53.png)](an-overview-of-forms-authentication-vb/_static/image52.png)

**Рис. 18**: Default.aspx показывает Добро пожаловать, Цзисунь вместе с LinkButton выхода ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image54.png))


[![Logout.aspx показан экран приветствия, незнакомого, а также LinkButton входа](an-overview-of-forms-authentication-vb/_static/image56.png)](an-overview-of-forms-authentication-vb/_static/image55.png)

**Рис. 19**: Logout.aspx показан экран приветствия, незнакомого, а также LinkButton входа ([Просмотр полноразмерного изображения](an-overview-of-forms-authentication-vb/_static/image57.png))


> [!NOTE]
> Я советую вам для настройки страницы Logout.aspx для скрытия элемента ContentPlaceHolder на главной странице LoginContent (как это делалось для Login.aspx на шаге 4). Потому, что отображаемый элементом управления LoginStatus LinkButton входа (один под Hello, незнакомого) направляет пользователя на страницу входа, передавая параметр строки запроса ReturnUrl текущий URL-адрес. Иными словами Если пользователь, выполнивший вход out щелкает этот LoginStatus входа LinkButton, а затем регистрирует, они будут перенаправляться к Logout.aspx, который легко может запутать пользователя.


## <a name="summary"></a>Сводка

В этом руководстве мы к работе с проверкой рабочего процесса проверки подлинности форм, а затем выключили для реализации проверки подлинности форм в приложении ASP.NET. Проверка подлинности форм работает на платформе FormsAuthenticationModule, который имеет два вида ответственности: идентификации пользователей, исходя их билета проверки подлинности и Перенаправление неавторизованных пользователей на страницу входа.

Класс FormsAuthentication платформы .NET Framework включает методы для создания, проверки и удаления билеты аутентификации форм. Свойство Request.IsAuthenticated и объект пользователя предоставляют дополнительные программную поддержку для определения, является ли запрос проходит проверку подлинности и сведения об удостоверении пользователя. Кроме того, существуют также элементы управления LoginView, LoginStatus и LoginName Web, которые предоставляют разработчикам возможность быстрого написания кода способ для выполнения многих обычных задач, относящихся ко входу. Мы рассмотрим эти и другие связанные с входом веб-элементы управления более подробно в последующих учебных курсах.

Этот учебник предоставляются проводится поверхностное обзор проверки подлинности форм. Мы не изучить различные параметры, рассмотрим, как без поддержки файлов cookie рабочих билетов проверки подлинности форм или изучите, как ASP.NET позволяет защитить содержимое билета проверки подлинности. Будут рассмотрены эти и другие в темы [следующему руководству](forms-authentication-configuration-and-advanced-topics-vb.md).

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Изменения между IIS6 и системы безопасности в IIS7](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/Changes-between-IIS6-and-IIS7-Security)
- [Элементы управления входом ASP.NET](https://msdn.microsoft.com/library/d51ttbhx.aspx)
- [Professional ASP.NET 2.0 безопасности, членства и управления ролями](http://www.wrox.com/WileyCDA/WroxTitle/productCd-0764596985.html) (ISBN: 978-0-7645-9698-8)
- [&lt;Проверки подлинности&gt; элемент](https://msdn.microsoft.com/library/532aee0e.aspx)
- [&lt;Forms&gt; элемент для &lt;проверки подлинности&gt;](https://msdn.microsoft.com/library/1d3t3c61.aspx)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a>Учебные видеоматериалы по таким темам, содержащихся в этом руководстве

- [Использование базовой проверки подлинности на основе форм в ASP.NET](../../../videos/authentication/using-basic-forms-authentication-in-aspnet.md)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Лиз Шалок в этом руководстве включают Alicja Maziarz (John suru) и Терезой Мерфи. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com).

> [!div class="step-by-step"]
> [Назад](security-basics-and-asp-net-support-vb.md)
> [Вперед](forms-authentication-configuration-and-advanced-topics-vb.md)
