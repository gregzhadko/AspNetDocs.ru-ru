---
uid: web-forms/overview/older-versions-security/roles/assigning-roles-to-users-vb
title: Назначение ролей пользователям (VB) | Документация Майкрософт
author: rick-anderson
description: В этом учебнике мы создадим две ASP.NET страницы для помощи в управлении тем, к каким ролям относятся пользователи. На первой странице будут включены средства для просмотра...
ms.author: riande
ms.date: 03/24/2008
ms.assetid: fd208ee9-69cc-4467-9783-b4e039bdd1d3
msc.legacyurl: /web-forms/overview/older-versions-security/roles/assigning-roles-to-users-vb
msc.type: authoredcontent
ms.openlocfilehash: b53df4494eb0faef7c5e4547c2bf95e5fb071298
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78507282"
---
# <a name="assigning-roles-to-users-vb"></a>Назначение ролей пользователям (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/VB.10.zip) или [скачать PDF](https://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/aspnet_tutorial10_AssigningRoles_vb.pdf)

> В этом учебнике мы создадим две ASP.NET страницы для помощи в управлении тем, к каким ролям относятся пользователи. На первой странице будут включены средства для просмотра пользователей, принадлежащих к определенной роли, роли, к которым принадлежит конкретный пользователь, и возможность назначать или удалять конкретного пользователя из определенной роли. На второй странице мы дополним элемент управления CreateUserWizard таким образом, чтобы он включал в себя шаг для указания ролей, к которым принадлежит только что созданный пользователь. Это полезно в сценариях, где администратор может создавать учетные записи пользователей.

## <a name="introduction"></a>Введение

В <a id="_msoanchor_1"> </a> [предыдущем учебнике](creating-and-managing-roles-vb.md) рассматривалась платформа ролей и `SqlRoleProvider`; Мы увидели, как использовать класс `Roles` для создания, извлечения и удаления ролей. Помимо создания и удаления ролей, необходимо иметь возможность назначать или удалять пользователей из роли. К сожалению, ASP.NET не поставляется с веб-элементами управления для управления тем, к каким ролям относятся пользователи. Вместо этого для управления этими ассоциациями необходимо создать собственные страницы ASP.NET. Хорошая новость заключается в том, что добавление и удаление пользователей в роли довольно просто. Класс `Roles` содержит несколько методов для добавления одного или нескольких пользователей к одной или нескольким ролям.

В этом учебнике мы создадим две ASP.NET страницы для помощи в управлении тем, к каким ролям относятся пользователи. На первой странице будут включены средства для просмотра пользователей, принадлежащих к определенной роли, роли, к которым принадлежит конкретный пользователь, и возможность назначать или удалять конкретного пользователя из определенной роли. На второй странице мы дополним элемент управления CreateUserWizard таким образом, чтобы он включал в себя шаг для указания ролей, к которым принадлежит только что созданный пользователь. Это полезно в сценариях, где администратор может создавать учетные записи пользователей.

Приступим.

## <a name="listing-what-users-belong-to-what-roles"></a>Вывод списка пользователей, которым принадлежит роль

Первый порядок бизнес-процессов для этого руководства — создание веб-страницы, с которой пользователи могут назначаться ролям. Прежде чем мы соберемся с тем, как назначать роли пользователям, давайте сначала рассмотрим, как определить, к каким ролям относятся пользователи. Существует два способа отобразить эту информацию: "по роли" или "по пользователю". Можно позволить посетителю выбрать роль, а затем показать ее всех пользователей, принадлежащих роли ("по роли"), или предложить посетителю выбрать пользователя и показать ему роли, назначенные этому пользователю (отображение "по пользователю").

Представление "по роли" полезно в тех случаях, когда посетитель хочет узнать набор пользователей, принадлежащих к определенной роли. представление "по пользователю" идеально подходит, когда посетителю нужно узнать, какие роли определенного пользователя. Пусть наша страница включает интерфейсы "по ролям" и "по пользователям".

Начнем с создания интерфейса "по пользователю". Этот интерфейс будет состоять из раскрывающегося списка и списка флажков. Раскрывающийся список будет заполнен набором пользователей в системе; флажки будут перечислять роли. При выборе пользователя в раскрывающемся списке будут проверены роли, к которым принадлежит пользователь. Пользователь, посещающий страницу, может установить или снять флажки, чтобы добавить или удалить выбранного пользователя из соответствующих ролей.

> [!NOTE]
> Использование раскрывающегося списка для перечисления учетных записей пользователей не является идеальным выбором для веб-сайтов, где могут быть сотни учетных записей пользователей. Раскрывающийся список предназначен для того, чтобы позволить пользователю выбрать один элемент из относительно короткого списка параметров. Это быстро становится неудобной, так как количество элементов в списке растет. Если вы создаете веб-сайт, который будет потенциально большим числом учетных записей пользователей, можно рассмотреть возможность использования альтернативного пользовательского интерфейса, такого как страничный GridView или интерфейс с фильтрацией, который предлагает посетителю выбрать письмо и только потом показывает пользователей, имена которых начинаются с выбранной буквы.

## <a name="step-1-building-the-by-user-user-interface"></a>Шаг 1. Создание пользовательского интерфейса "по пользователю"

Откройте страницу `UsersAndRoles.aspx`. В верхней части страницы добавьте элемент управления Label с именем `ActionStatus` и удалите его свойство `Text`. Мы будем использовать эту метку для предоставления отзывов о выполняемых действиях, отображая такие сообщения, как "пользователь Тито был добавлен в роль" Администраторы ", или" пользователь Цзисунь был удален из роли "руководители". Чтобы эти сообщения были выделены, присвойте свойству `CssClass` метки значение "важно".

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample1.aspx)]

Затем добавьте следующее определение класса CSS в таблицу стилей `Styles.css`:

[!code-css[Main](assigning-roles-to-users-vb/samples/sample2.css)]

Это определение CSS указывает браузеру отображать метку с помощью большого красного шрифта. На рис. 1 показан этот результат в конструкторе Visual Studio.

[![свойство CssClass метки получает большой красный шрифт](assigning-roles-to-users-vb/_static/image2.png)](assigning-roles-to-users-vb/_static/image1.png)

**Рис. 1**. свойство `CssClass` метки приводит к большому красному шрифту ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image3.png)).

Затем добавьте элемент DropDownList на страницу, задайте для его свойства `ID` значение `UserList`и задайте для свойства `AutoPostBack` значение true. Мы будем использовать этот элемент DropDownList для вывода списка всех пользователей в системе. Это DropDownList будет привязан к коллекции объектов MembershipUser. Так как элементу DropDownList нужно отобразить свойство UserName объекта MembershipUser (и использовать его в качестве значения элементов списка), задайте для свойств `DataTextField` и `DataValueField` DropDownList значение UserName.

Под элементом DropDownList добавьте элемент Repeater с именем `UsersRoleList`. Этот Repeater будет перечислять все роли в системе в виде ряда флажков. Определите `ItemTemplate` Repeater, используя следующую декларативную разметку:

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample3.aspx)]

Разметка `ItemTemplate` включает один веб-элемент управления CheckBox с именем `RoleCheckBox`. `AutoPostBack` свойству CheckBox присвоено значение true, а свойство `Text` привязано к `Container.DataItem`. Причина, по которой синтаксис DataBinding является просто `Container.DataItem`, заключается в том, что платформа ролей возвращает список имен ролей в виде массива строк, и это строковый массив, который мы будем привязать к элементу Repeater. Подробное описание того, почему этот синтаксис используется для вывода содержимого массива, привязанного к веб-элементу управления данными, выходит за рамки данного руководства. Дополнительные сведения об этом важностях см. в статье [Привязка скалярного массива к веб-элементу управления данными](http://aspnet.4guysfromrolla.com/articles/082504-1.aspx).

На этом этапе декларативная разметка интерфейса "по пользователю" должна выглядеть следующим образом:

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample4.aspx)]

Теперь мы готовы написать код для привязки набора учетных записей пользователей к DropDownList и набору ролей для элемента Repeater. В классе кода программной части страницы добавьте метод с именем `BindUsersToUserList` и другой с именем `BindRolesList`, используя следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample5.vb)]

Метод `BindUsersToUserList` извлекает все учетные записи пользователей в системе с помощью [метода`Membership.GetAllUsers`](https://msdn.microsoft.com/library/dy8swhya.aspx). Он возвращает [объект`MembershipUserCollection`](https://msdn.microsoft.com/library/system.web.security.membershipusercollection.aspx), который представляет собой коллекцию [экземпляров`MembershipUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx). Затем эта коллекция привязывается к элементу DropDownList `UserList`. Экземпляры `MembershipUser`, описывающего коллекцию, содержат различные свойства, такие как `UserName`, `Email`, `CreationDate`и `IsOnline`. Чтобы элементу DropDownList отображалось значение свойства `UserName`, убедитесь `UserList`, что свойства `DataTextField` и `DataValueField` элемента DropDownList установлены в значение UserName.

> [!NOTE]
> Метод `Membership.GetAllUsers` имеет две перегрузки: один, который не принимает входные параметры и возвращает всех пользователей, а второй принимает целочисленные значения для индекса страницы и размера страницы и возвращает только указанное подмножество пользователей. Если в элементе пользовательского интерфейса, доступном для просмотра, отображаются большие объемы учетных записей пользователей, вторая перегрузка может быть использована для более эффективной страницы пользователей, поскольку она возвращает только точное подмножество учетных записей пользователей, а не все из них.

Метод `BindRolesToList` начинается с вызова [метода`GetAllRoles`](https://msdn.microsoft.com/library/system.web.security.roles.getallroles.aspx)класса `Roles`, который возвращает массив строк, содержащий роли в системе. Затем этот строковый массив привязывается к элементу Repeater.

Наконец, необходимо вызвать эти два метода при первой загрузке страницы. Добавьте следующий код в обработчик событий `Page_Load` .

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample6.vb)]

Выполнив этот код, уделите время посетить страницу в браузере. экран должен выглядеть примерно так, как показано на рис. 2. Все учетные записи пользователей заполняются в раскрывающемся списке, и под ним каждая роль отображается как флажок. Так как мы устанавливаем свойства `AutoPostBack` DropDownList и CheckBoxs равными true, изменение выбранного пользователя или проверка или депроверка роли приводит к выполнению обратной передачи. Однако никакие действия не выполняются, так как мы еще не написали код для решения этих действий. Эти задачи будут рассмотрены в следующих двух разделах.

[![странице отображаются пользователи и роли.](assigning-roles-to-users-vb/_static/image5.png)](assigning-roles-to-users-vb/_static/image4.png)

**Рис. 2**. на странице отображаются пользователи и роли ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image6.png))

### <a name="checking-the-roles-the-selected-user-belongs-to"></a>Проверка ролей, к которым принадлежит выбранный пользователь

При первой загрузке страницы или когда посетитель выбирает нового пользователя из раскрывающегося списка, необходимо обновить флажки `UsersRoleList`, чтобы флажок запускался только в том случае, если выбранный пользователь принадлежит к этой роли. Для этого создайте метод с именем `CheckRolesForSelectedUser` со следующим кодом:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample7.vb)]

Приведенный выше код начинается с определения того, кто является выбранным пользователем. Затем он использует [метод`GetRolesForUser(userName)`](https://msdn.microsoft.com/library/system.web.security.roles.getrolesforuser.aspx) класса Roles для возврата набора ролей указанного пользователя в виде массива строк. Далее производится перечисление элементов Repeater и установлен флажок `RoleCheckBox` каждого элемента в программной ссылке. Флажок проверяется только в том случае, если роль, к которой он соответствует, содержится в `selectedUsersRoles` массиве строк.

> [!NOTE]
> Синтаксис `Linq.Enumerable.Contains(Of String)(...)` не будет компилироваться, если используется ASP.NET версии 2,0. Метод `Contains(Of String)` является частью [библиотеки LINQ](http://en.wikipedia.org/wiki/Language_Integrated_Query), которая является новой для ASP.NET 3,5. Если вы все еще используете ASP.NET версии 2,0, используйте вместо этого [метод`Array.IndexOf(Of String)`](https://msdn.microsoft.com/library/eha9t187.aspx) .

Метод `CheckRolesForSelectedUser` должен вызываться в двух случаях: при первой загрузке страницы и изменении выбранного индекса DropDownList `UserList`. Поэтому Вызывайте этот метод из обработчика событий `Page_Load` (после вызовов `BindUsersToUserList` и `BindRolesToList`). Кроме того, создайте обработчик событий для события `SelectedIndexChanged` DropDownList и вызовите этот метод из него.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample8.vb)]

С помощью этого кода можно протестировать страницу в браузере. Тем не менее, поскольку на `UsersAndRoles.aspx`ной странице в настоящее время нет возможности назначать пользователям роли, пользователи не имеют ролей. Мы создадим интерфейс для назначения пользователям ролей в течение некоторого времени, так что вы можете взять слово, чтобы этот код работал, и проверить, что он делает это позже, или можно вручную добавить пользователей к ролям, вставив записи в таблицу `aspnet_UsersInRoles`, чтобы протестировать эту функцию прямо сейчас.

### <a name="assigning-and-removing-users-from-roles"></a>Назначение и удаление пользователей из ролей

Когда посетитель проверяет или снимает флажок в `UsersRoleList` Repeater, необходимо добавить или удалить выбранного пользователя из соответствующей роли. Свойство `AutoPostBack` CheckBox в настоящее время имеет значение true, что приводит к тому, что флажок в элементе Repeater будет установлен или снят. Вкратце, нам нужно создать обработчик событий для `CheckChanged` события CheckBox. Поскольку флажок находится в элементе управления Repeater, необходимо вручную добавить коммуникации обработчика событий. Начните с добавления обработчика событий в класс кода программной части в качестве метода `Protected`, например так:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample9.vb)]

В данный момент мы вернемся к написанию кода для этого обработчика событий. Но сначала выполним обработку событий. Из флажка в `ItemTemplate`е Repeater добавьте `OnCheckedChanged="RoleCheckBox_CheckChanged"`. Этот синтаксис связывает обработчик событий `RoleCheckBox_CheckChanged` с событием `CheckedChanged` `RoleCheckBox`.

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample10.aspx)]

Наша последняя задача — завершить обработчик событий `RoleCheckBox_CheckChanged`. Нам нужно начать с ссылки на элемент управления CheckBox, который вызвал событие, поскольку этот экземпляр CheckBox указывает, какая роль была проверена или снята с помощью свойств `Text` и `Checked`. Используя эти сведения вместе с именем пользователя выбранного пользователя, мы добавляем или удаляю пользователя из роли с помощью метода [`AddUserToRole`](https://msdn.microsoft.com/library/system.web.security.roles.addusertorole.aspx) или [`RemoveUserFromRole`](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromrole.aspx)класса `Roles`.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample11.vb)]

Приведенный выше код начинается с программной ссылки на флажок, вызвавший событие, которое доступно через входной параметр `sender`. Если флажок установлен, выбранный пользователь добавляется к указанной роли, в противном случае он удаляется из роли. В любом случае в метке `ActionStatus` отображается сообщение с описанием только что выполненного действия.

Уделите время на тестирование этой страницы в браузере. Выберите пользователь Тито, а затем добавьте Тито в роли Администраторы и Супервизоры.

[![Тито добавлена в роли администраторов и руководителей.](assigning-roles-to-users-vb/_static/image8.png)](assigning-roles-to-users-vb/_static/image7.png)

**Рис. 3**. Тито добавлены в роли администраторов и руководителей ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image9.png))

Затем в раскрывающемся списке Выберите User Брюс (пользователь). Обратная передача и флажки Repeater обновляются с помощью `CheckRolesForSelectedUser`. Так как Брюс еще не принадлежит ни одной роли, два флажка не устанавливаются. Затем добавьте Брюс в роль супервизоров.

[![Брюс добавлена в роль "руководители"](assigning-roles-to-users-vb/_static/image11.png)](assigning-roles-to-users-vb/_static/image10.png)

**Рис. 4**. Брюс был добавлен в роль "руководители" ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image12.png))

Для дальнейшей проверки функциональности метода `CheckRolesForSelectedUser` выберите пользователя, отличного от Тито или Брюс. Обратите внимание, что флажки автоматически снимаются, отметив, что они не принадлежат ни к одной роли. Вернитесь к Тито. Должны быть установлены флажки администраторы и Супервизоры.

## <a name="step-2-building-the-by-roles-user-interface"></a>Шаг 2. Создание пользовательского интерфейса "по ролям"

На этом этапе мы завершили работу с интерфейсом "по пользователям" и готовы начать работу с интерфейсом "по ролям". Интерфейс "по ролям" предлагает пользователю выбрать роль из раскрывающегося списка, а затем отображает набор пользователей, принадлежащих к этой роли в элементе управления GridView.

Добавьте еще один элемент управления DropDownList в `UsersAndRoles.aspx page`. Поместите его под элементом управления Repeater, назовите его `RoleList`и присвойте свойству `AutoPostBack` значение true. Ниже добавьте GridView и присвойте ему имя `RolesUserList`. В этом элементе GridView будут перечислены пользователи, принадлежащие к выбранной роли. Задайте для свойства `AutoGenerateColumns` GridView значение false, добавьте TemplateField в коллекцию `Columns` сетки и присвойте свойству `HeaderText` значение "Users". Определите `ItemTemplate` TemplateField, чтобы на нем отображалось значение выражения привязки данных `Container.DataItem` в свойстве `Text` метки с именем `UserNameLabel`.

После добавления и настройки GridView декларативная разметка интерфейса "по роли" должна выглядеть следующим образом:

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample12.aspx)]

Необходимо заполнить `RoleList` DropDownList набором ролей в системе. Для этого обновите метод `BindRolesToList`, чтобы привязать массив строк, возвращаемый методом `Roles.GetAllRoles`, к `RolesList` DropDownList (а также к `UsersRoleList` Repeater).

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample13.vb)]

Последние две строки в методе `BindRolesToList` были добавлены для привязки набора ролей к элементу управления DropDownList `RoleList`. На рис. 5 показан конечный результат при просмотре в браузере — раскрывающийся список, заполненный ролями системы.

[![роли отображаются в DropDownList RoleList](assigning-roles-to-users-vb/_static/image14.png)](assigning-roles-to-users-vb/_static/image13.png)

**Рис. 5**. роли отображаются в `RoleList` DropDownList ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image15.png))

### <a name="displaying-the-users-that-belong-to-the-selected-role"></a>Отображение пользователей, принадлежащих выбранной роли

При первой загрузке страницы или при выборе новой роли из `RoleList` DropDownList необходимо отобразить список пользователей, принадлежащих к этой роли в GridView. Создайте метод с именем `DisplayUsersBelongingToRole`, используя следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample14.vb)]

Этот метод начинается с получения выбранной роли из `RoleList` DropDownList. Затем он использует [метод`Roles.GetUsersInRole(roleName)`](https://msdn.microsoft.com/library/system.web.security.roles.getusersinrole.aspx) для получения строкового массива имен пользователей, принадлежащих к этой роли. Затем этот массив привязывается к `RolesUserList` GridView.

Этот метод должен вызываться в двух случаях: при начальной загрузке страницы и при изменении выбранной роли в `RoleList` DropDownList. Поэтому обновите обработчик событий `Page_Load` таким образом, чтобы этот метод вызывался после вызова метода `CheckRolesForSelectedUser`. Затем создайте обработчик событий для события `SelectedIndexChanged` `RoleList`и вызовите этот метод из него.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample15.vb)]

После этого кода в `RolesUserList` GridView должны отображаться пользователи, принадлежащие выбранной роли. Как показано на рис. 6, роль супервизоров состоит из двух членов: Брюс и Тито.

[![элементе GridView список пользователей, принадлежащих выбранной роли](assigning-roles-to-users-vb/_static/image17.png)](assigning-roles-to-users-vb/_static/image16.png)

**Рис. 6**. список пользователей, принадлежащих выбранной роли ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image18.png))

### <a name="removing-users-from-the-selected-role"></a>Удаление пользователей из выбранной роли

Добавим `RolesUserList` GridView, чтобы он включал столбец с кнопками "Удалить". Нажатие кнопки "Удалить" для конкретного пользователя удалит их из этой роли.

Начните с добавления поля кнопки Удалить в GridView. Сделайте это поле наиболее заполненным и измените его свойство `DeleteText` на "Delete" (по умолчанию) на "Remove" (удалить).

[![добавить](assigning-roles-to-users-vb/_static/image20.png)](assigning-roles-to-users-vb/_static/image19.png)

**Рис. 7**. Добавление кнопки "Удалить" в GridView ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image21.png))

При нажатии кнопки "Удалить" происходит обратная передача, и возникает событие `RowDeleting` GridView. Необходимо создать обработчик событий для этого события и написать код, который удаляет пользователя из выбранной роли. Создайте обработчик событий, а затем добавьте следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample16.vb)]

Код начинается с определения имени выбранной роли. Затем он программно ссылается на элемент управления `UserNameLabel` из строки, для которой была нажата кнопка "Удалить", чтобы определить имя пользователя, которого нужно удалить. Затем пользователь удаляется из роли с помощью вызова метода `Roles.RemoveUserFromRole`. После этого `RolesUserList` GridView обновляется и выводится сообщение с помощью элемента управления Метка `ActionStatus`.

> [!NOTE]
> Перед удалением пользователя из роли для кнопки "Удалить" не требуется никаких подтверждений от пользователя. Я предлагаю добавить некоторый уровень подтверждения пользователя. Одним из самых простых способов подтверждения действия является применение диалогового окна подтверждения на стороне клиента. Дополнительные сведения об этом способе см. в разделе [Добавление подтверждения на стороне клиента при удалении](https://asp.net/learn/data-access/tutorial-42-vb.aspx).

На рис. 8 показана страница после удаления пользователя Тито из группы «руководители».

[![увы, Тито больше не является супервизором](assigning-roles-to-users-vb/_static/image23.png)](assigning-roles-to-users-vb/_static/image22.png)

**Рис. 8**. Увы, Тито больше не является супервизором ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image24.png))

### <a name="adding-new-users-to-the-selected-role"></a>Добавление новых пользователей к выбранной роли

Вместе с удалением пользователей из выбранной роли посетитель этой страницы также должен иметь возможность добавить пользователя к выбранной роли. Лучший интерфейс для добавления пользователя в выбранную роль зависит от количества учетных записей пользователей, которые вы ожидаете использовать. Если ваш веб-сайт будет размещать всего несколько десятков учетных записей пользователей, можно использовать DropDownList. Если могут быть тысячи учетных записей пользователей, необходимо включить пользовательский интерфейс, позволяющий посетителям пролистывать учетные записи, выполнять поиск конкретной учетной записи или фильтровать учетные записи пользователей каким-либо другим способом.

Для этой страницы мы будем использовать очень простой интерфейс, который работает независимо от количества учетных записей пользователей в системе. А именно, мы будем использовать текстовое поле, предлагающее посетителю ввести имя пользователя, которого пользователь хочет добавить в выбранную роль. Если пользователь с таким именем не существует или пользователь уже является членом роли, в `ActionStatus` метка будет отображаться сообщение. Но если пользователь существует и не является членом роли, мы добавим его к роли и обновляем сетку.

Добавьте текстовое поле и кнопку под элементом GridView. Задайте для текстового поля `ID` значение `UserNameToAddToRole` и задайте для свойств `ID` и `Text` кнопки значение `AddUserToRoleButton` и "добавить пользователя в роль" соответственно.

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample17.aspx)]

Затем создайте обработчик событий `Click` для `AddUserToRoleButton` и добавьте следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample18.vb)]

Большая часть кода в обработчике событий `Click` выполняет различные проверки. Это гарантирует, что посетитель указал имя пользователя в текстовом поле `UserNameToAddToRole`, что пользователь уже существует в системе и не принадлежит выбранной роли. Если какая-либо из этих проверок завершается сбоем, в `ActionStatus` отображается соответствующее сообщение, а обработчик событий завершает работу. Если все проверки пройдены, пользователь добавляется к роли с помощью метода `Roles.AddUserToRole`. После этого удаляется свойство `Text` текстового поля, GridView обновляется, а `ActionStatus` метка отображает сообщение о том, что указанный пользователь успешно добавлен в выбранную роль.

> [!NOTE]
> Чтобы убедиться, что указанный пользователь еще не принадлежит выбранной роли, мы используем [метод`Roles.IsUserInRole(userName, roleName)`](https://msdn.microsoft.com/library/system.web.security.roles.isuserinrole.aspx), который возвращает логическое значение, указывающее, является ли *имя пользователя* членом *roleName*. Мы будем использовать этот метод еще раз в <a id="_msoanchor_2"> </a> [следующем руководстве](role-based-authorization-vb.md) , когда мы рассмотрим авторизацию на основе ролей.

Откройте страницу в браузере и выберите роль супервизоров в `RoleList` DropDownList. Попробуйте ввести недопустимое имя пользователя. должно отобразиться сообщение о том, что пользователь не существует в системе.

[![нельзя добавить несуществующего пользователя к роли](assigning-roles-to-users-vb/_static/image26.png)](assigning-roles-to-users-vb/_static/image25.png)

**Рис. 9**. невозможно добавить несуществующего пользователя к роли ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image27.png))

Теперь попробуйте добавить допустимого пользователя. Снова добавьте Тито в роль супервизоров.

[![Тито еще раз является супервизором!](assigning-roles-to-users-vb/_static/image29.png)](assigning-roles-to-users-vb/_static/image28.png)

**Рис. 10**. Тито снова является супервизором!  ([Щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image30.png))

## <a name="step-3-cross-updating-the-by-user-and-by-role-interfaces"></a>Шаг 3. Перекрестное обновление интерфейсов "по пользователям" и "по ролям"

Страница `UsersAndRoles.aspx` предлагает два отдельных интерфейса для управления пользователями и ролями. В настоящее время эти два интерфейса работают независимо друг от друга, поэтому изменение, внесенное в одном интерфейсе, не будет немедленно отражено в другом. Например, представьте, что посетитель страницы выбирает роль супервизоров из `RoleList` DropDownList, где в качестве членов перечисляются Брюс и Тито. Затем посетитель выбирает `UserList` Тито в элементе DropDownList, который проверяет флажки "Администраторы" и "Супервизоры" в `UsersRoleList` Repeater. Если затем посетитель отменяет роль супервизора от повторителя, Тито удаляется из роли супервизоров, но это изменение не отражается в интерфейсе Role. GridView по-прежнему будет показывать Тито как член роли "руководители".

Чтобы исправить это, необходимо обновить GridView при проверке или снятии роли с `UsersRoleList` Repeater. Аналогичным образом, необходимо обновлять Repeater каждый раз, когда пользователь удаляется или добавляется к роли из интерфейса "по роли".

Элемент Repeater в интерфейсе "по пользователю" обновляется путем вызова метода `CheckRolesForSelectedUser`. Интерфейс "по роли" можно изменить в обработчике событий `RowDeleting` `RolesUserList` GridView и обработчике событий `Click` кнопки `AddUserToRoleButton`. Поэтому необходимо вызвать метод `CheckRolesForSelectedUser` из каждого из этих методов.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample19.vb)]

Аналогично, элемент управления GridView в интерфейсе "по роли" обновляется путем вызова метода `DisplayUsersBelongingToRole`, а интерфейс "по пользователю" изменяется с помощью обработчика событий `RoleCheckBox_CheckChanged`. Поэтому нам нужно вызвать метод `DisplayUsersBelongingToRole` из этого обработчика событий.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample20.vb)]

В результате этих незначительных изменений кода интерфейсы "по пользователям" и "по ролям" теперь правильно перекрестно обновляются. Чтобы проверить это, перейдите на страницу браузера и выберите Тито и Супервизоры в `UserList` и `RoleList` элементов управления DropDownList соответственно. Обратите внимание, что при снятии флажка роли Супервизоры для Тито из Repeater в интерфейсе "по пользователям" Тито автоматически удаляется из GridView в интерфейсе "по ролям". При добавлении Тито к роли супервизоров из интерфейса "по роли" автоматически проверяется флажок "руководители" в интерфейсе "по пользователям".

## <a name="step-4-customizing-the-createuserwizard-to-include-a-specify-roles-step"></a>Шаг 4. Настройка CreateUserWizard для включения шага "указание ролей"

<a id="_msoanchor_3"> </a>В учебнике [*Создание учетных записей пользователей*](../membership/creating-user-accounts-vb.md) мы увидели, как использовать веб-элемент управления CreateUserWizard, чтобы предоставить интерфейс для создания новой учетной записи пользователя. Элемент управления CreateUserWizard можно использовать одним из двух способов:

- Как средство для создания собственной учетной записи пользователя на сайте и
- Как средство создания новых учетных записей для администраторов

В первом варианте использования посетитель переходит на сайт и заполняет CreateUserWizard, вводя сведения для регистрации на сайте. Во втором случае администратор создает новую учетную запись для другого пользователя.

При создании учетной записи администратором другого пользователя может быть полезно разрешить администратору указывать роли, к которым принадлежит новая учетная запись пользователя. <a id="_msoanchor_4"> </a>В учебнике [о *хранении* *дополнительных сведений о пользователях* ](../membership/storing-additional-user-information-vb.md) мы увидели, как настроить CreateUserWizard, добавив дополнительные `WizardSteps`. Давайте посмотрим, как добавить дополнительный шаг к CreateUserWizard, чтобы указать роли нового пользователя.

Откройте страницу `CreateUserWizardWithRoles.aspx` и добавьте элемент управления CreateUserWizard с именем `RegisterUserWithRoles`. Задайте для свойства `ContinueDestinationPageUrl` элемента управления значение "~/Дефаулт.аспкс". Так как идея заключается в том, что администратор будет использовать этот элемент управления CreateUserWizard для создания новых учетных записей пользователей, присвойте свойству `LoginCreatedUser` элемента управления значение false. Это `LoginCreatedUser` свойство указывает, будет ли посетитель автоматически входить в систему в качестве только что созданного пользователя, и по умолчанию имеет значение true. Мы задали значение false, так как при создании новой учетной записи администратор хочет войти в систему как есть.

Затем выберите "Добавить/удалить `WizardSteps`...". из смарт-тега CreateUserWizard и добавьте новый `WizardStep`, задав для его `ID` значение `SpecifyRolesStep`. Переместите `SpecifyRolesStep WizardStep`, чтобы он наступил после шага "зарегистрироваться для новой учетной записи", но перед шагом "завершить". Задайте для свойства `Title` `WizardStep`значение "указать роли", свойство `StepType` для `Step`, а для свойства `AllowReturn` — значение false.

[![добавить](assigning-roles-to-users-vb/_static/image32.png)](assigning-roles-to-users-vb/_static/image31.png)

**Рис. 11**. Добавление `WizardStep` "указание ролей" в CreateUserWizard ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image33.png))

После изменения декларативная разметка CreateUserWizard должна выглядеть следующим образом:

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample21.aspx)]

В `WizardStep`"указание ролей" добавьте CheckBoxList с именем `RoleList.` эта CheckBoxList будет содержать список доступных ролей, что позволит пользователю посетить страницу, чтобы проверить, к каким ролям принадлежит только что созданный пользователь.

Мы оставили две задачи написания кода: сначала необходимо заполнить `RoleList` CheckBoxList с помощью ролей в системе; Во вторых, необходимо добавить созданного пользователя к выбранным ролям, когда пользователь перейдет с шага "указание ролей" на шаг "завершено". Мы можем выполнить первую задачу в обработчике событий `Page_Load`. Следующий код программным образом ссылается на флажок `RoleList` при первом посещении страницы и привязывает к нему роли в системе.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample22.vb)]

Приведенный выше код должен показаться знакомым. <a id="_msoanchor_5"> </a>В учебнике [о *хранении* *дополнительных сведений о пользователях* ](../membership/storing-additional-user-information-vb.md) мы использовали две инструкции `FindControl` для ссылки на веб-элемент управления из настраиваемой `WizardStep`. И код, связывающий роли с CheckBoxList, был взят ранее в этом руководстве.

Чтобы выполнить вторую задачу программирования, необходимо знать, когда был выполнен шаг "указание ролей". Вспомним, что CreateUserWizard имеет событие `ActiveStepChanged`, которое срабатывает при каждом переходе посетителя с одного шага на другой. Здесь можно определить, достиг ли пользователь шага «Complete»; в этом случае необходимо добавить пользователя к выбранным ролям.

Создайте обработчик событий для `ActiveStepChanged` события и добавьте следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample23.vb)]

Если пользователь только что достиг шага "завершено", обработчик событий перечисляет элементы `RoleList` CheckBoxList, и только что созданный пользователь назначается выбранным ролям.

Посетите эту страницу в браузере. Первым шагом в CreateUserWizard является стандартная операция регистрации для новой учетной записи, которая запрашивает имя пользователя, пароль, адрес электронной почты и другие сведения о новом пользователе. Введите сведения для создания нового пользователя с именем Ванда.

[![создать нового пользователя с именем Ванда](assigning-roles-to-users-vb/_static/image35.png)](assigning-roles-to-users-vb/_static/image34.png)

**Рис. 12**. Создание нового пользователя с именем Ванда ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image36.png))

Нажмите кнопку "создать пользователя". CreateUserWizard внутренне вызывает метод `Membership.CreateUser`, создает новую учетную запись пользователя, а затем выполняет переход к следующему шагу: "указание ролей". Здесь перечислены системные роли. Установите флажок Супервизоры и нажмите кнопку Далее.

[![сделать Ванда членом роли "руководители"](assigning-roles-to-users-vb/_static/image38.png)](assigning-roles-to-users-vb/_static/image37.png)

**Рис. 13**. сделать Ванда членом роли "руководители" ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image39.png))

Нажатие кнопки "Далее" вызывает обратную передачу и обновляет `ActiveStep` на шаге "завершено". В обработчике событий `ActiveStepChanged` недавно созданная учетная запись пользователя назначается роли "руководители". Чтобы проверить это, вернитесь на страницу `UsersAndRoles.aspx` и выберите супервизоров из `RoleList` DropDownList. Как показано на рис. 14, Супервизоры теперь состоят из трех пользователей: Брюс, Тито и Ванда.

[![Брюс, Тито и Ванда являются администраторами](assigning-roles-to-users-vb/_static/image41.png)](assigning-roles-to-users-vb/_static/image40.png)

**Рис. 14**. Брюс, Тито и Ванда — все Супервизоры ([щелкните, чтобы просмотреть изображение с полным размером](assigning-roles-to-users-vb/_static/image42.png))

## <a name="summary"></a>Сводка

Платформа ролей предоставляет методы для получения сведений о ролях конкретного пользователя и методах для определения того, какие пользователи относятся к указанной роли. Кроме того, существует ряд методов добавления и удаления одного или нескольких пользователей в одной или нескольких ролях. В этом учебнике мы посвящены только двум следующим методам: `AddUserToRole` и `RemoveUserFromRole`. Существуют дополнительные варианты, предназначенные для добавления нескольких пользователей в одну роль и для назначения нескольких ролей одному пользователю.

Кроме того, в этом учебнике рассматривается расширение элемента управления CreateUserWizard для включения `WizardStep` для указания вновь создаваемых ролей пользователя. Такой шаг может помочь администратору упростить процесс создания учетных записей пользователей для новых пользователей.

На этом этапе мы рассмотрели создание и удаление ролей, а так же Добавление и удаление пользователей из ролей. Но мы еще не рассмотрим применение авторизации на основе ролей. <a id="_msoanchor_6"> </a>В [следующем учебном курсе](role-based-authorization-vb.md) мы рассмотрим определение правил авторизации URL-адресов для отдельных ролей, а также как ограничить функциональность на уровне страницы на основе ролей пользователя, вошедшего в систему.

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Обзор средства администрирования веб-сайта ASP.NET](https://msdn.microsoft.com/library/ms228053.aspx)
- [Изучение ASP. Членство в сети, роли и профиль](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Развертывание собственного средства администрирования веб-сайта](http://aspnet.4guysfromrolla.com/articles/052307-1.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — *[Sams обучать себя ASP.NET 2,0 за 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* . Скотт можно получить по адресу [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) или через свой блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность...

Эта серия руководств была рассмотрена многими полезными рецензентами. Специалист по интересу для этого руководства был Терезой Мерфи. Хотите ознакомиться с моими будущими статьями MSDN? Если да, расположите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](creating-and-managing-roles-vb.md)
> [Вперед](role-based-authorization-vb.md)
