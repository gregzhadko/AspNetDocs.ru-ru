---
uid: web-forms/overview/older-versions-security/roles/assigning-roles-to-users-cs
title: Назначение ролей пользователям (C#) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве мы построим две страницы ASP.NET для помощи в управлении, какие пользователи принадлежат к роли. Первая страница будет включать средства, чтобы увидеть, что...
ms.author: riande
ms.date: 03/24/2008
ms.assetid: d522639a-5aca-421e-9a76-d73f95607f57
msc.legacyurl: /web-forms/overview/older-versions-security/roles/assigning-roles-to-users-cs
msc.type: authoredcontent
ms.openlocfilehash: 482460248fb070b273c1ff97515152cacf66dbce
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65108688"
---
# <a name="assigning-roles-to-users-c"></a>Назначение ролей пользователям (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/CS.10.zip) или [скачать PDF](http://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/aspnet_tutorial10_AssigningRoles_cs.pdf)

> В этом руководстве мы построим две страницы ASP.NET для помощи в управлении, какие пользователи принадлежат к роли. Первая страница будет включать средства, чтобы увидеть, какие пользователи принадлежат к определенной роли, конкретный пользователь принадлежит роли, а также возможность назначить или удалить пользователя из определенной роли. На второй странице мы расширим элемент управления CreateUserWizard, теперь она содержит шаг, чтобы указывать только что созданный пользователь принадлежит к роли. Это полезно в сценариях, где администратор может создать новую учетную запись.

## <a name="introduction"></a>Вступление

<a id="_msoanchor_1"> </a> [Предыдущем учебном курсе](creating-and-managing-roles-cs.md) исследуется framework ролей и `SqlRoleProvider`; мы узнали, как использовать `Roles` класса для создания, извлечения и удалять роли. Помимо создания и удаления ролей, необходимо иметь возможность назначить или удалить пользователей из роли. К сожалению ASP.NET поставляется с любой веб-элементы управления для управления, какие пользователи принадлежат к роли. Вместо этого необходимо создать собственные страницы ASP.NET для управления этих связей. Хорошо то, что добавление и удаление ролей пользователям достаточно прост. `Roles` Класс содержит ряд методов для добавления одного или нескольких пользователей в одну или несколько ролей.

В этом руководстве мы построим две страницы ASP.NET для помощи в управлении, какие пользователи принадлежат к роли. Первая страница будет включать средства, чтобы увидеть, какие пользователи принадлежат к определенной роли, конкретный пользователь принадлежит роли, а также возможность назначить или удалить пользователя из определенной роли. На второй странице мы расширим элемент управления CreateUserWizard, теперь она содержит шаг, чтобы указывать только что созданный пользователь принадлежит к роли. Это полезно в сценариях, где администратор может создать новую учетную запись.

Давайте начнем!

## <a name="listing-what-users-belong-to-what-roles"></a>Листинг какие пользователи принадлежат какие роли

Первым делом в этом руководстве является создание веб-страницы, из которого пользователи могут быть назначены роли. Прежде чем заняться как назначать пользователей ролям, давайте сначала сосредоточиться на том, как определить, какие пользователи принадлежат к роли. Существует два способа для отображения этой информации: «роль» или «user». Мы делает возможным посетитель выберите роль, а затем отобразить их всех пользователей, которые принадлежат роли («по ролям» отображение), или мы может выдать запрос посетитель выберите пользователя, а затем отобразить их роли, назначенные этому пользователю («пользователем» отображение).

Представление «по ролям» полезны в случаях, когда посетитель хочет знать набор пользователей, принадлежащих к определенной роли; представление «пользователем» идеально в тех случаях, когда посетитель необходима информация о роли конкретного пользователя. Давайте обновим страницу включают «роли» и «пользователем» интерфейсы.

Мы начнем с создания интерфейса, «пользователем». Этот интерфейс будет состоять из раскрывающегося списка и список флажков. Выберите в раскрывающемся списке будет заполняться набор пользователей в системе; флажки перечисляет роли. Выбрав пользователя из раскрывающегося списка будет проверять эти роли, к которой принадлежит пользователь. Лицо, посетив страницу можно, а затем установите или снимите флажки, чтобы добавить или удалить выбранного пользователя из соответствующих ролей.

> [!NOTE]
> С помощью раскрывающегося списка в список учетных записей пользователей не является идеальным выбором для веб-сайтов там, где могут существовать сотни учетных записей пользователей. Стрелку раскрывающегося списка позволяет пользователю выбрать один элемент из относительно короткий список параметров. Он быстро становится громоздким, по мере роста число элементов списка. Если вы создаете веб-сайта, будет иметь потенциально большое количество учетных записей пользователей, можно рассмотреть возможность использования альтернативный пользовательский интерфейс, например возможностью разбивки на страницы элемента управления GridView или фильтруемые интерфейс, который перечисляет запросы на ввод посетителя, чтобы выбрать букву и затем только Показывает этих пользователей, ее имя пользователя начинается с выбранной буквы.

## <a name="step-1-building-the-by-user-user-interface"></a>Шаг 1. Создание пользовательского интерфейса «Пользователем»

Откройте `UsersAndRoles.aspx` страницы. В верхней части страницы, добавьте элемент управления Label Web `ActionStatus` и очистите его `Text` свойство. Мы будем использовать эту метку отзыв о действиях, выполняемых, отображение сообщения, например, «Tito пользователь был добавлен к роли "Администраторы"» или «Цзисунь пользователь был удален из роли руководителями.» Чтобы сделать эти сообщения фоне, задайте метки `CssClass` свойства «Важно!».

[!code-aspx[Main](assigning-roles-to-users-cs/samples/sample1.aspx)]

Добавьте следующее определение класса CSS к `Styles.css` таблицы стилей:

[!code-css[Main](assigning-roles-to-users-cs/samples/sample2.css)]

Это определение CSS указывает, что в браузере открывается с помощью большой красный шрифт метки. Рис. 1 показан этот эффект в конструкторе Visual Studio.

[![Свойство метки CssClass приводит к большой красный шрифт](assigning-roles-to-users-cs/_static/image2.png)](assigning-roles-to-users-cs/_static/image1.png)

**Рис. 1**: Метки `CssClass` свойства приводят крупный шрифт Red ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image3.png))

Добавление элемента управления DropDownList на страницу, затем установите его `ID` свойства `UserList`и задайте его `AutoPostBack` присваивается значение True. Мы будем использовать этот DropDownList для получения списка всех пользователей в системе. Этот DropDownList будет привязан к коллекции объектов MembershipUser. Поскольку мы хотим DropDownList для отображения Свойство UserName объекта MembershipUser (и использовать его в качестве значения элементов списка), значение DropDownList `DataTextField` и `DataValueField` свойства «Username».

Под DropDownList, добавьте элемент управления Repeater с именем `UsersRoleList`. Этот элемент управления Repeater будут отображаться все роли в системе как ряд флажки. Определение элемента Repeater `ItemTemplate` с помощью следующей декларативной разметке:

[!code-aspx[Main](assigning-roles-to-users-cs/samples/sample3.aspx)]

`ItemTemplate` Разметка включает один флажок веб-элемент управления с именем `RoleCheckBox`. Флажок `AutoPostBack` свойство имеет значение True и `Text` свойство привязано к `Container.DataItem`. Причина синтаксис привязки данных — это просто `Container.DataItem` — так как платформа роли возвращает список имен ролей, как массив строк, а этот массив строк, который будет осуществляться привязка к элементу управления Repeater. Полное описание причины такой синтаксис используется для отображения содержимого массива, который привязан к веб-элемент данных выходит за рамки данного руководства. Дополнительные сведения по данному вопросу см. [привязка к веб-элемент данных массива скаляр](http://aspnet.4guysfromrolla.com/articles/082504-1.aspx).

На этом этапе декларативная разметка вашей «пользователем» интерфейса выглядит следующим образом:

[!code-aspx[Main](assigning-roles-to-users-cs/samples/sample4.aspx)]

Теперь мы готовы написать код, чтобы связать набор учетных записей пользователей в DropDownList и набор ролей, к элементу управления Repeater. В классе фонового кода страницы добавьте метод с именем `BindUsersToUserList` , а другой с именем `BindRolesList`, используя следующий код:

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample5.cs)]

`BindUsersToUserList` Метод извлекает все учетные записи пользователей в системе через [ `Membership.GetAllUsers` метод](https://msdn.microsoft.com/library/dy8swhya.aspx). Эта команда возвращает [ `MembershipUserCollection` объект](https://msdn.microsoft.com/library/system.web.security.membershipusercollection.aspx), который является коллекцией [ `MembershipUser` экземпляры](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx). Эта коллекция затем привязывается к `UserList` DropDownList. `MembershipUser` Экземпляров, состав, коллекция содержит различные свойства, такие как `UserName`, `Email`, `CreationDate`, и `IsOnline`. Чтобы настроить DropDownList для отображения значения `UserName` свойство, убедитесь, что `UserList` DropDownList `DataTextField` и `DataValueField` заданы свойства «Username».

> [!NOTE]
> `Membership.GetAllUsers` Метод имеет две перегрузки: один, который не принимает никаких входных параметров и возвращает всех пользователей, а другое принимает целочисленные значения для индекса страницы и размера страницы и возвращает только определенное подмножество пользователей. При наличии большого количества учетных записей пользователей, отображаемых в элементе возможностью разбивки на страницы пользовательского интерфейса, вторая перегрузка может использоваться для более эффективно разбивка на страницы пользователей, так как он возвращает только точные подмножества учетных записей пользователей, а не все из них.

`BindRolesToList` Запускает метод с помощью вызова `Roles` класса [ `GetAllRoles` метод](https://msdn.microsoft.com/library/system.web.security.roles.getallroles.aspx), который возвращает массив строк, содержащий роли в системе. Этот массив строк, затем привязывается к элементу управления Repeater.

Наконец необходимо вызвать эти два метода, при первой загрузке страницы. Добавьте следующий код в обработчик событий `Page_Load` .

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample6.cs)]

Этот код в месте Отвлекитесь и посетите страницу через браузер; экран должен выглядеть как показано на рис. 2. Учетные записи пользователей будут заполнены все в раскрывающемся списке и нижнего уровня, каждая роль отображается как флажок. Так как мы задали `AutoPostBack` свойства элемента управления DropDownList и флажки значение True, Изменение выбранного пользователя или устанавливая или снимая роли вызывает обратную передачу. Никакие действия не выполняются, тем не менее, поскольку у нас есть еще писать код для обработки этих действий. Это будет рассмотрено этих задач в следующих двух разделах.

[![На странице отображается пользователей и ролей](assigning-roles-to-users-cs/_static/image5.png)](assigning-roles-to-users-cs/_static/image4.png)

**Рис. 2**: На странице отображаются пользователи и роли ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image6.png))

### <a name="checking-the-roles-the-selected-user-belongs-to"></a>Проверка роли выбранного пользователя принадлежит

При первой загрузке страницы или всякий раз, когда пользователь выбирает нового пользователя в раскрывающемся списке, необходимо обновить `UsersRoleList`флажки, чтобы флажок данной роли установлен только в том случае, если выбранный пользователь принадлежит к этой роли. Для этого необходимо создать метод с именем `CheckRolesForSelectedUser` следующим кодом:

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample7.cs)]

Приведенный выше код начинается с определения выбранного пользователя. Затем он использует класс ролей [ `GetRolesForUser(userName)` метод](https://msdn.microsoft.com/library/system.web.security.roles.getrolesforuser.aspx) для возврата набора ролей как массив строк указанного пользователя. Далее перечисляются элементы элементу управления Repeater и каждый элемент `RoleCheckBox` флажок упоминается программным способом. Этот флажок установлен, только в том случае, если содержится в роли, он соответствует `selectedUsersRoles` массив строк.

> [!NOTE]
> `selectedUserRoles.Contains<string>(...)` Синтаксис не будет компилироваться при использовании ASP.NET версии 2.0. `Contains<string>` Метод является частью [LINQ библиотеки](http://en.wikipedia.org/wiki/Language_Integrated_Query), которое является новым для ASP.NET 3.5. Если вы все еще используете ASP.NET версии 2.0, используйте [ `Array.IndexOf<string>` метод](https://msdn.microsoft.com/library/eha9t187.aspx) вместо этого.

`CheckRolesForSelectedUser` Метод должен вызываться в двух случаях: при первой загрузке страницы, а также при каждом `UserList` изменении выбранного индекса DropDownList. Таким образом, вызывать этот метод из `Page_Load` обработчик событий (после вызовов `BindUsersToUserList` и `BindRolesToList`). Кроме того, создайте обработчик событий для элемента управления DropDownList `SelectedIndexChanged` событие и вызвать этот метод из него.

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample8.cs)]

Этот код в месте можно проверить страницы в браузере. Однако, поскольку `UsersAndRoles.aspx` страницы в настоящее время отсутствует возможность назначать пользователям роли, пользователи не имеют роли. Мы создадим интерфейс для назначения пользователям ролей позже, чтобы вы могли воспользоваться программа word, этот код работает и убедитесь, что она делает это позже, или можно вручную добавить пользователей в роли путем вставки записей в `aspnet_UsersInRoles` таблицы, чтобы протестировать этот functi Теперь onality.

### <a name="assigning-and-removing-users-from-roles"></a>Назначение и удаление пользователей из ролей

Когда посетитель или снятии флажка в `UsersRoleList` Repeater, нам нужно добавить или удалить выбранного пользователя из соответствующей роли. Флажок `AutoPostBack` в настоящее время задано значение True, то вызывает обратную передачу в любое время в виде флажка в элементу управления Repeater устанавливается или снимается. Иными словами, необходимо создать обработчик событий к флажку `CheckChanged` событий. Так как он находится в элементе управления Repeater, необходимо вручную добавить магистрали обработчика событий. Начните с добавления обработчика событий в класс фонового кода как `protected` метода, следующим образом:

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample9.cs)]

Мы вернемся к написать код для этого обработчика событий чуть позже. Но сначала давайте заполним магистрали обработки событий. Установки флажка в элементе Repeater `ItemTemplate`, добавьте `OnCheckedChanged="RoleCheckBox_CheckChanged"`. Связывает этот синтаксис `RoleCheckBox_CheckChanged` в обработчике событий `RoleCheckBox`в `CheckedChanged` событий.

[!code-aspx[Main](assigning-roles-to-users-cs/samples/sample10.aspx)]

Наша последняя задача — для завершения `RoleCheckBox_CheckChanged` обработчик событий. Необходимо запустить, ссылаясь на элемент управления CheckBox, который вызвал событие, так как этот экземпляр флажок указывает, какую роль была проверенный или непроверенный через его `Text` и `Checked` свойства. Используя эти сведения вместе с именем пользователя для выбранного пользователя, мы добавить или удалить пользователя из роли с помощью `Roles` класса [ `AddUserToRole` ](https://msdn.microsoft.com/library/system.web.security.roles.addusertorole.aspx) или [ `RemoveUserFromRole` метод](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromrole.aspx).

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample11.cs)]

Приведенный выше код начинается с программного обращения флажок, который вызвал событие, которое доступно через `sender` входного параметра. Если этот флажок установлен, выбранного пользователя добавляется в указанную роль, в противном случае они удаляются из роли. В любом случае `ActionStatus` метка отображает сообщение, суммирование только что выполненное действие.

Отвлекитесь и проверьте страницу в обозревателе. Выберите пользователя Tito, а затем добавьте Tito ролям администраторами и руководителями.

[![Был добавлен Tito администраторами и руководителями ролей](assigning-roles-to-users-cs/_static/image8.png)](assigning-roles-to-users-cs/_static/image7.png)

**Рис. 3**: Был добавлен Tito администраторами и руководителями роли ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image9.png))

Затем выберите пользователя Брюс из раскрывающегося списка. Обратная передача и элементу управления Repeater флажки обновляются с помощью команды `CheckRolesForSelectedUser`. Поскольку Брюс принадлежит каких-либо ролей, флажки сняты. Затем добавьте Брюс руководителями роли.

[![Брюс была добавлена к роли руководителями](assigning-roles-to-users-cs/_static/image11.png)](assigning-roles-to-users-cs/_static/image10.png)

**Рис. 4**: Брюс была добавлена к роли руководители ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image12.png))

Для дальнейшей проверки функциональности `CheckRolesForSelectedUser` метод, выберите пользователя, отличного от Tito или Брюс. Обратите внимание на то, как автоматически сняты флажки, обозначающая, что они не принадлежат ни одной роли. Вернитесь к Tito. Следует проверить флажков "Администраторы" или "руководители.

## <a name="step-2-building-the-by-roles-user-interface"></a>Шаг 2. Создание пользовательского интерфейса «,» роли

На этом этапе мы завершили интерфейс «пользователями» и приступить к реализации интерфейса «ролями». Интерфейс «,» роли пользователю будет предложено выбрать роль из раскрывающегося списка, а затем отображает набор пользователей, которые принадлежат к этой роли в элементе управления GridView.

Добавление другого элемента управления DropDownList для `UsersAndRoles.aspx` страницы. Поместите этот расположенного под элементом управления Repeater, назовите его `RoleList`и задайте его `AutoPostBack` присваивается значение True. Нижнего уровня, добавьте элемент управления GridView и назовите его `RolesUserList`. Этот GridView будет содержать список пользователей, которые входят в выбранную роль. Присвоить свойству `AutoGenerateColumns` свойство имеет значение false, добавьте поле TemplateField в сетку `Columns` коллекции и задайте его `HeaderText` свойства «Пользователи». Определите TemplateField `ItemTemplate` таким образом, чтобы он отображает значение выражения привязки данных `Container.DataItem` в `Text` свойства элемента управления Label с именем `UserNameLabel`.

После добавления и настройки GridView, декларативная разметка вашей «по ролям» интерфейса должен выглядеть следующим образом:

[!code-aspx[Main](assigning-roles-to-users-cs/samples/sample12.aspx)]

Нам нужно заполнить `RoleList` DropDownList с набором ролей в системе. Чтобы добиться этого, обновите `BindRolesToList` метода и это привязывает массив строк, возвращаемый `Roles.GetAllRoles` метод `RolesList` DropDownList (а также `UsersRoleList` Repeater).

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample13.cs)]

Две последние строки в `BindRolesToList` метод были добавлены в набор ролей, чтобы привязать `RoleList` элемента управления DropDownList. Рис. 5 показан готовый результат при просмотре через обозреватель — стрелку раскрывающегося списка, заполненный системные роли.

[![Роли отображаются в раскрывающемся списке RoleList](assigning-roles-to-users-cs/_static/image14.png)](assigning-roles-to-users-cs/_static/image13.png)

**Рис. 5**: Роли отображаются в `RoleList` DropDownList ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image15.png))

### <a name="displaying-the-users-that-belong-to-the-selected-role"></a>Отображение пользователей, которые принадлежат выбранной роли

При первой загрузке страницы или при выборе новой роли из `RoleList` DropDownList, нам нужно отобразить список пользователей, принадлежащих этой роли в GridView. Создайте метод с именем `DisplayUsersBelongingToRole` следующим образом:

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample14.cs)]

Этот метод начинает с получения выбранной роли из `RoleList` DropDownList. Затем он использует [ `Roles.GetUsersInRole(roleName)` метод](https://msdn.microsoft.com/library/system.web.security.roles.getusersinrole.aspx) для получения строкового массива имена пользователей, которые принадлежат к этой роли. Этот массив затем привязывается к `RolesUserList` GridView.

Этот метод должен вызываться в двух случаях: при начальной загрузке страницы и при выбранной ролью в `RoleList` изменения элемента управления DropDownList. Таким образом, обновление `Page_Load` обработчик событий, чтобы этот метод вызывается после вызова `CheckRolesForSelectedUser`. Создайте обработчик событий для `RoleList`в `SelectedIndexChanged` событий и вызовите этот метод после этого слишком.

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample15.cs)]

Этот код в месте `RolesUserList` GridView следует отобразить этих пользователей, которые принадлежат выбранной роли. Как показано на рис. 6, руководителями роль состоит из двух элементов: Брюс и Tito.

[![GridView перечисляет тех пользователей, которые принадлежат выбранной роли](assigning-roles-to-users-cs/_static/image17.png)](assigning-roles-to-users-cs/_static/image16.png)

**Рис. 6**: GridView перечислены те пользователи, принадлежат к роли выбран ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image18.png))

### <a name="removing-users-from-the-selected-role"></a>Идет удаление пользователей из выбранной роли

Давайте дополнить `RolesUserList` GridView, теперь она содержит столбец «удалить» кнопок. Нажав кнопку «Удалить» для конкретного пользователя будут удалены из этой роли.

Начните с добавления поля кнопки Delete к GridView. Сделать это поле отображаются в виде наиболее архивированного слева и измените его `DeleteText` значение «Удалить» из «Delete» (по умолчанию).

[![Добавить](assigning-roles-to-users-cs/_static/image20.png)](assigning-roles-to-users-cs/_static/image19.png)

**Рис. 7**: Добавьте к элементу GridView кнопка «Удалить» ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image21.png))

При нажатии кнопки «Удалить» обратная и GridView `RowDeleting` события. Нам нужно создать обработчик событий для этого события и написать код, который удаляет пользователя из выбранной роли. Создайте обработчик событий и затем добавьте следующий код:

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample16.cs)]

Код начинается с определения имени выбранной роли. Затем программным способом ссылки `UserNameLabel` управления была нажата, кнопка «Удалить», чтобы определить имя пользователя, чтобы удалить строки. Пользователь был удален из роли через вызов `Roles.RemoveUserFromRole` метод. `RolesUserList` Обновляется GridView и выводится сообщение с помощью `ActionStatus` метки элемента управления.

> [!NOTE]
> Кнопка «Удалить» не требует каких-либо подтверждения от пользователя, прежде чем удалять пользователя из роли. Я приглашаю вас добавить некоторый уровень подтверждение пользователя. Одна из самых простых способов, чтобы подтвердить действие — через диалоговое окно подтверждения на стороне клиента. Дополнительные сведения об этом приеме см. в разделе [Добавление клиентского подтверждения при Идет удаление](https://asp.net/learn/data-access/tutorial-42-cs.aspx).

Рис. 8 показана страница после удаления пользователя Tito в группе руководителей.

[![Увы Tito больше не начальнику](assigning-roles-to-users-cs/_static/image23.png)](assigning-roles-to-users-cs/_static/image22.png)

**Рис. 8**: Увы, Tito больше не начальнику ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image24.png))

### <a name="adding-new-users-to-the-selected-role"></a>Добавление новых пользователей в выбранной роли

А также удаление пользователей из выбранной роли, посетителя на эту страницу также сможете Добавление пользователя в выбранной роли. Лучший интерфейс для добавления в выбранную роль пользователя зависит от числа учетных записей пользователей, которые предполагается наличие. Если веб-сайт размещается несколько десятков учетных записей или менее, можно использовать здесь элемента управления DropDownList. Если возможно, тысячи учетных записей пользователей, нужно включить пользовательский интерфейс, который позволяет посетителя для постраничного просмотра учетных записей, поиск определенной учетной записи, или фильтрации учетных записей пользователей в каким-либо другим образом.

Для этой страницы используем очень простой интерфейс, работает независимо от числа учетных записей пользователей в системе. А именно мы будем использовать текстовое поле запроса посетителя, чтобы ввести имя пользователя, который она хочет добавить к выбранной роли. Если пользователь с таким именем не существует, или если пользователь уже является членом роли, мы отобразим сообщение в `ActionStatus` метки. Но если он существует и не является членом роли, мы обновить сетку и добавить их к роли.

Добавьте текстовое поле и кнопку под GridView. Значение текстового поля `ID` для `UserNameToAddToRole` и задайте кнопки `ID` и `Text` свойства `AddUserToRoleButton` и «Добавление пользователя в роль», соответственно.

[!code-aspx[Main](assigning-roles-to-users-cs/samples/sample17.aspx)]

Создайте `Click` обработчик событий для `AddUserToRoleButton` и добавьте следующий код:

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample18.cs)]

Большая часть кода в `Click` обработчик событий выполняет различные проверки. Это гарантирует, что посетитель указано имя пользователя в `UserNameToAddToRole` текстовое поле, что пользователь существует в системе, и что уже не входящие в выбранной роли. Если любой из этих проверок завершается ошибкой, соответствующее сообщение отображается в `ActionStatus` и выходе из обработчика событий. Если все проверки успешно, пользователь добавляется в роль с помощью `Roles.AddUserToRole` метод. После этого текстового поля в `Text` свойства очищаются, обновляется GridView и `ActionStatus` метка появится сообщение о том, что указанный пользователь был успешно добавлен в выбранную роль.

> [!NOTE]
> Чтобы убедиться, что указанный пользователь уже входит в выбранную роль, мы используем [ `Roles.IsUserInRole(userName, roleName)` метод](https://msdn.microsoft.com/library/system.web.security.roles.isuserinrole.aspx), который возвращает логическое значение, указывающее, является ли *имя пользователя* является членом *roleName*. Мы будем использовать этот метод еще раз, в <a id="_msoanchor_2"> </a> [следующему руководству](role-based-authorization-cs.md) Если взглянуть на авторизации на основе ролей.

Посетите страницу в обозревателе и выберите роль руководителями из `RoleList` DropDownList. Попробуйте ввести неправильное имя пользователя — вы должны увидеть сообщение о том, что пользователь не существует в системе.

[![Невозможно добавить несуществующий пользователь к роли](assigning-roles-to-users-cs/_static/image26.png)](assigning-roles-to-users-cs/_static/image25.png)

**Рис. 9**: Невозможно добавить пользователя несуществующий роли ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image27.png))

Теперь попробуйте добавить допустимого пользователя. Теперь добавим повторно Tito руководителями роли.

[![Tito еще раз является руководителем!](assigning-roles-to-users-cs/_static/image29.png)](assigning-roles-to-users-cs/_static/image28.png)

**Рис. 10**: Tito еще раз является руководителем!  ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image30.png))

## <a name="step-3-cross-updating-the-by-user-and-by-role-interfaces"></a>Шаг 3. Обновление нескольких «User» и «роли» интерфейсы

`UsersAndRoles.aspx` Страница предлагает два отдельных интерфейсов для управления пользователями и ролями. В настоящее время эти два интерфейса действовать независимо друг от друга, так что вполне возможно, что изменения, внесенные в одном интерфейсе будет не будут отражены немедленно в другой. Например, представьте выбирается посетителя на страницу роли руководителями из `RoleList` DropDownList, в которой перечислены Брюс и Tito в качестве своих членов. Затем пользователь выбирает Tito из `UserList` DropDownList, который проверяет флажки «Администраторы» и «руководители в `UsersRoleList` Repeater. Если посетитель затем снимает роли начальника из элемента управления Repeater, Tito удаляется из роли руководителями, но это изменение не отражается в интерфейсе «по ролям». GridView по-прежнему будет отображаться Tito как член роли руководителями.

Чтобы исправить это нам нужно обновить GridView, каждый раз, когда роль устанавливается или снимается из `UsersRoleList` Repeater. Аналогичным образом нам нужно обновить Repeater всякий раз, когда пользователь удален или добавлен к роли с помощью интерфейса «, роль».

Элемент управления Repeater в интерфейсе «пользователем» обновляется путем вызова `CheckRolesForSelectedUser` метод. Интерфейс «по ролям» можно изменить в `RolesUserList` GridView `RowDeleting` обработчик событий и `AddUserToRoleButton` кнопки `Click` обработчик событий. Таким образом, необходимо вызвать `CheckRolesForSelectedUser` метода из каждого из этих методов.

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample19.cs)]

Аналогичным образом, путем вызова обновляется GridView в интерфейсе «по ролям» `DisplayUsersBelongingToRole` метода и интерфейс «пользователем» изменяется посредством `RoleCheckBox_CheckChanged` обработчик событий. Таким образом, необходимо вызвать `DisplayUsersBelongingToRole` метод из этого обработчика событий.

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample20.cs)]

Благодаря этим изменениям небольшие «user» и «роли» интерфейсы теперь правильно кросс update. Чтобы проверить это, посетите страницу в обозревателе и выберите Tito и руководителей из `UserList` и `RoleList` элементов управления DropDownList, соответственно. Обратите внимание на то, что как роль руководителями снимите для Tito из элемента управления Repeater в интерфейсе «пользователем», Tito автоматически удаляется из GridView в интерфейсе «по ролям». Повторное добавление Tito обратно к своим руководителям роли из интерфейса «по ролям» автоматически проверяет руководителями флажок в интерфейсе «пользователем».

## <a name="step-4-customizing-the-createuserwizard-to-include-a-specify-roles-step"></a>Шаг 4. Настройка CreateUserWizard, чтобы включить шаг «Укажите роли»

В <a id="_msoanchor_3"> </a> [ *Создание учетных записей пользователей* ](../membership/creating-user-accounts-cs.md) руководства мы узнали, как использовать элемент управления CreateUserWizard обеспечивает интерфейс для создания учетной записи пользователя. Элемент управления CreateUserWizard может использоваться в одном из двух способов:

- Как средство для посетителей создать собственную учетную запись пользователя на сайте и
- Как средство для администраторов создать новые учетные записи

В первом варианте использования посетитель входит на сайт и вводит CreateUserWizard, вводит свои данные для регистрации на сайте. Во втором случае администратор создает новую учетную запись для другого лица.

При создании учетной записи администратором некоторые другие лица, может быть полезно позволить администратору указывать учетную запись пользователя принадлежит к роли. В <a id="_msoanchor_4"> </a> [ *хранение* *Дополнительные сведения о пользователе* ](../membership/storing-additional-user-information-cs.md) мы узнали, как настроить CreateUserWizard, добавляя дополнительные руководства `WizardSteps`. Давайте взглянем на том, как добавить дополнительный шаг в CreateUserWizard, чтобы указать роли нового пользователя.

Откройте `CreateUserWizardWithRoles.aspx` странице и добавьте элемент управления CreateUserWizard `RegisterUserWithRoles`. Задайте в качестве `ContinueDestinationPageUrl` свойства «~ / Default.aspx». Поскольку смысл в том, что администратор будет использовать этот элемент управления CreateUserWizard для создания новых учетных записей пользователей, задайте в качестве `LoginCreatedUser` значение False. Это `LoginCreatedUser` свойство указывает ли пользователь автоматически входит в систему как пользователь только что созданного и по умолчанию используется значение True. Ей присваивается значение False, когда администратор создает новую учетную запись, мы хотим сохранить его в систему как сам.

Затем выберите «Добавить или удалить `WizardSteps`...» смарт-теге CreateUserWizard и добавьте новый `WizardStep`, устанавливая его `ID` для `SpecifyRolesStep`. Переместить `SpecifyRolesStep WizardStep` таким образом, речь идет после шага «Входа для создания новой учетной записи», но до шага «Complete». Задайте `WizardStep` `Title` свойства «Укажите роли», его `StepType` свойства `Step`и его `AllowReturn` значение False.

[![Добавить](assigning-roles-to-users-cs/_static/image32.png)](assigning-roles-to-users-cs/_static/image31.png)

**Рис. 11**: Добавьте «Укажите роли» `WizardStep` для CreateUserWizard ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image33.png))

После этого изменения вашей CreateUserWizard декларативная разметка должна выглядеть следующим образом:

[!code-aspx[Main](assigning-roles-to-users-cs/samples/sample21.aspx)]

В «Укажите роли» `WizardStep`, добавьте CheckBoxList с именем `RoleList`. Этот CheckBoxList перечислит доступные роли, включение person, посетив страницу проверить только что созданный пользователь принадлежит к роли.

Мы остается две задачи кодирования: мы должны заполнить `RoleList` CheckBoxList с ролями в системе; во-вторых, необходимо добавить созданным пользователем для выбранных ролей, когда пользователь перемещает на шаге «Укажите роли» шаг «Завершить». Первая задача в можно достичь `Page_Load` обработчик событий. В следующем примере кода программным образом ссылки `RoleList` флажок на первом просмотре страницы и привязывает роли в системе, к нему.

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample22.cs)]

Приведенный выше код должен выглядеть знакомы. В <a id="_msoanchor_5"> </a> [ *хранение* *Дополнительные сведения о пользователе* ](../membership/storing-additional-user-information-cs.md) руководстве мы использовали две `FindControl` инструкций для ссылки на веб-элемент управления из в пределах пользовательского `WizardStep`. И код, который выполняет привязку роли к CheckBoxList был взят из этого руководства.

Для выполнения второй задачи программирования, нам необходимо знать, если были завершены на шаге «Укажите роли». Вспомним, что имеет CreateUserWizard `ActiveStepChanged` ObjectDataSource, который запускается каждый раз, когда посетитель переходит от одного шага к другому. Здесь мы можем определить, если пользователь достиг шаг «Завершить»; Если Да, нам нужно добавить пользователя в выбранных ролей.

Создайте обработчик событий для `ActiveStepChanged` событий и добавьте следующий код:

[!code-csharp[Main](assigning-roles-to-users-cs/samples/sample23.cs)]

Если пользователь просто достиг на шаге «Завершено», обработчик событий перечисляет элементы `RoleList` CheckBoxList и только что созданного пользователя присваивается выбранных ролей.

Посетите эту страницу через обозреватель. Первым шагом в CreateUserWizard — это стандартный шаг «Входа для создания новой учетной записи», который запрашивает имя пользователя нового пользователя, пароль, электронной почты и другую ключевую информацию. Введите сведения, чтобы создать нового пользователя с именем Ванда.

[![Создайте нового пользователя с именем Ванда](assigning-roles-to-users-cs/_static/image35.png)](assigning-roles-to-users-cs/_static/image34.png)

**Рис. 12**: Создание нового пользователя с именем Ванда ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image36.png))

Нажмите кнопку «Create User». CreateUserWizard внутренне вызывает `Membership.CreateUser` метод, создание новой учетной записи пользователя, а затем переходит к следующему шагу, «укажите роли.» Ниже перечислены системные роли. Установите флажок "руководители" и нажмите кнопку Далее.

[![Сделать членом роли руководителями Ванда](assigning-roles-to-users-cs/_static/image38.png)](assigning-roles-to-users-cs/_static/image37.png)

**Рис. 13**: Сделать членом роли руководителями Ванда ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image39.png))

Нажав кнопку Далее вызывает обратную передачу и обновления `ActiveStep` шаг «Завершить». В `ActiveStepChanged` обработчик событий, недавно созданные учетной записи назначена роль руководителями. Чтобы проверить это, нужно вернуть `UsersAndRoles.aspx` и укажите руководителями из `RoleList` DropDownList. Как показано на рис. 14, Супервизоров теперь состоят из трех пользователей: Брюс Tito и Ванда.

[![Брюс Tito и Ванда являются все руководители](assigning-roles-to-users-cs/_static/image41.png)](assigning-roles-to-users-cs/_static/image40.png)

**Рис. 14**: Брюс Tito и Ванда являются все руководители ([Просмотр полноразмерного изображения](assigning-roles-to-users-cs/_static/image42.png))

## <a name="summary"></a>Сводка

Платформа framework ролей предоставляет методы для получения сведений о ролях и методы для определения, какие пользователи являются членами указанной роли конкретного пользователя. Кроме того существует ряд методов для добавления и удаления одного или нескольких пользователей для одной или нескольких ролей. В этом руководстве были рассмотрены только два из этих методов: `AddUserToRole` и `RemoveUserFromRole`. Существуют дополнительные варианты, добавление нескольких пользователей одной роли и назначить несколько ролей для одного пользователя.

Этот учебник также включены внимание на расширение для включения элемента управления CreateUserWizard `WizardStep` для указания роли вновь созданный пользователь. Такого шага может помочь ускорить процесс создания учетных записей пользователей для новых пользователей администратора.

На этом этапе мы видели, как создавать и удалять роли и как добавлять и удалять пользователей из ролей. Но у нас есть еще рассмотрим применение авторизации на основе ролей. В <a id="_msoanchor_6"> </a> [этом руководстве](role-based-authorization-cs.md) мы рассмотрим определение правила авторизации URL-адрес на основе ролей, роли, также как ограничивать его функциональные возможности уровня страницы на основе ролей выполнившего вход пользователя.

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Обзор средства администрирования веб-сайта ASP.NET](https://msdn.microsoft.com/library/ms228053.aspx)
- [Проверка ASP. NET членства, ролей и профиля](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Развертывание собственного средства администрирования веб-сайта](http://aspnet.4guysfromrolla.com/articles/052307-1.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Основной рецензент этого учебного был Мерфи Терезой. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](creating-and-managing-roles-cs.md)
> [Вперед](role-based-authorization-cs.md)
