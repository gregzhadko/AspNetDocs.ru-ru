---
uid: web-forms/overview/older-versions-security/roles/creating-and-managing-roles-cs
title: Создание ролей и управление имиC#() | Документация Майкрософт
author: rick-anderson
description: В этом руководстве рассматриваются шаги, необходимые для настройки платформы ролей. После этого мы будем создавать веб-страницы для создания и удаления ролей.
ms.author: riande
ms.date: 03/24/2008
ms.assetid: 113f10b3-a19a-471b-8ff6-db3c79ce8a91
msc.legacyurl: /web-forms/overview/older-versions-security/roles/creating-and-managing-roles-cs
msc.type: authoredcontent
ms.openlocfilehash: a7883d0b05f2fa5a3fdac887f8c8b39d70418fb3
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74595818"
---
# <a name="creating-and-managing-roles-c"></a>Создание ролей и управление ими (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/CS.09.zip) или [скачать PDF](https://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/aspnet_tutorial09_CreatingRoles_cs.pdf)

> В этом руководстве рассматриваются шаги, необходимые для настройки платформы ролей. После этого мы будем создавать веб-страницы для создания и удаления ролей.

## <a name="introduction"></a>Введение

<a id="_msoanchor_1"> </a>В учебнике по [*авторизации на основе пользователей*](../membership/user-based-authorization-cs.md) мы рассматривали использование авторизации URL-адресов для ограничения определенных пользователей от набора страниц и изучения декларативных и программных методов настройки функций страницы ASP.NET на основе посещаемого пользователя. Тем не менее, предоставление разрешения на доступ к странице или функциональность на уровне пользователя может стать кошмаром обслуживания в сценариях с множеством учетных записей пользователей или при частом изменении привилегий пользователей. Каждый раз, когда пользователь получает или теряет авторизацию для выполнения определенной задачи, администратору необходимо обновить соответствующие правила авторизации URL-адреса, декларативную разметку и код.

Обычно это помогает классифицировать пользователей на группы или *роли* , а затем применять разрешения для конкретных ролей. Например, большинство веб-приложений имеют определенный набор страниц или задач, которые зарезервированы только для пользователей с правами администратора. Используя методики, описанные в руководстве по *авторизации на основе пользователей* , мы добавим соответствующие правила авторизации URL-адресов, декларативную разметку и код, чтобы разрешить указанным учетным записям пользователей выполнять административные задачи. Но если был добавлен новый администратор или у существующего администратора требуется, чтобы его права на администрирование были отозваны, нам пришлось бы вернуть и обновить файлы конфигурации и веб-страницы. Однако с помощью ролей можно создать роль Администраторы и назначить этих доверенных пользователей роли администраторов. Далее мы добавим соответствующие правила авторизации URL-адреса, декларативную разметку и код, чтобы позволить роли администраторов выполнять различные задачи администрирования. При такой инфраструктуре Добавление новых администраторов на сайт или удаление существующих пользователей сводится к включению или удалению пользователя из роли "Администраторы". Настройка, декларативная разметка или изменение кода не требуются.

ASP.NET предлагает платформу ролей для определения ролей и связывания их с учетными записями пользователей. Платформа ролей позволяет создавать и удалять роли, добавлять пользователей или удалять пользователей из роли, определять набор пользователей, принадлежащих к определенной роли, и сообщать, относится ли пользователь к определенной роли. После настройки платформы ролей можно ограничить доступ к страницам на уровне ролей с помощью правил авторизации URL-адресов, а также показать или скрыть дополнительные сведения или функциональные возможности на странице на основе ролей текущего пользователя, вошедшего в систему.

В этом руководстве рассматриваются шаги, необходимые для настройки платформы ролей. После этого мы будем создавать веб-страницы для создания и удаления ролей. <a id="_msoanchor_2"> </a>В учебнике [*назначение ролей для пользователей*](assigning-roles-to-users-cs.md) мы рассмотрим, как добавлять и удалять пользователей из ролей. А в учебнике по <a id="_msoanchor_3"> </a> [*авторизации на основе ролей*](role-based-authorization-cs.md) мы поможем увидеть, как ограничить доступ к страницам на основе ролей, а также как настроить функциональность страницы в зависимости от роли пользователя. Приступим к работе!

## <a name="step-1-adding-new-aspnet-pages"></a>Шаг 1. Добавление новых страниц ASP.NET

В этом руководстве и следующих двух мы будем изучать различные функции и возможности, связанные с ролями. Для реализации разделов, которые были проверены в рамках этих руководств, потребуется серия ASP.NET страниц. Давайте создадим эти страницы и обновляем карту узла.

Начните с создания новой папки в проекте с именем `Roles`. Затем добавьте четыре новые страницы ASP.NET в папку `Roles`, связав каждую страницу с главной страницей `Site.master`. Назовите страницы:

- `ManageRoles.aspx`
- `UsersAndRoles.aspx`
- `CreateUserWizardWithRoles.aspx`
- `RoleBasedAuthorization.aspx`

На этом этапе обозреватель решений проекта должны выглядеть примерно так, как показано на снимке экрана, показанном на рис. 1.

[в папку Roles Добавлено ![четыре новые страницы](creating-and-managing-roles-cs/_static/image2.png)](creating-and-managing-roles-cs/_static/image1.png)

**Рис. 1**. в папку `Roles` добавлены четыре новые страницы ([щелкните, чтобы просмотреть изображение с полным размером](creating-and-managing-roles-cs/_static/image3.png))

На этом этапе на каждой странице должно быть два элемента управления содержимым — по одному для каждой элементов управления ContentPlaceHolder главной страницы: `MainContent` и `LoginContent`.

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample1.aspx)]

Помните, что разметка `LoginContent` ContentPlaceHolder по умолчанию отображает ссылку на вход или выход из системы сайта в зависимости от того, прошел ли пользователь проверку подлинности. Однако присутствие `Content2`ного элемента управления содержимым на странице ASP.NET переопределяет разметку по умолчанию главной страницы. Как обсуждалось в <a id="_msoanchor_4"> </a> [*обзоре учебника по проверке подлинности*](../introduction/an-overview-of-forms-authentication-cs.md) с помощью форм, Переопределение разметки по умолчанию полезно на страницах, где не требуется отображать параметры, связанные с именем входа, в левом столбце.

Однако для этих четырех страниц необходимо отобразить разметку главной страницы по умолчанию для `LoginContent` ContentPlaceHolder. Поэтому удалите декларативную разметку для элемента управления содержимым `Content2`. После этого каждая из разметки каждой из четырех страниц должна содержать только один элемент управления содержимым.

Наконец, обновите карту узла (`Web.sitemap`), чтобы включить эти новые веб-страницы. Добавьте следующий XML-код после `<siteMapNode>`, добавленного в учебники по членству.

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample2.xml)]

Обновив карту узла, перейдите на сайт через браузер. Как показано на рис. 2, Навигация в левой части теперь включает элементы для учебника по ролям.

[в папку Roles Добавлено ![четыре новые страницы](creating-and-managing-roles-cs/_static/image5.png)](creating-and-managing-roles-cs/_static/image4.png)

**Рис. 2**. в папку `Roles` добавлены четыре новые страницы ([щелкните, чтобы просмотреть изображение с полным размером](creating-and-managing-roles-cs/_static/image6.png))

## <a name="step-2-specifying-and-configuring-the-roles-framework-provider"></a>Шаг 2. Указание и настройка поставщика инфраструктуры ролей

Как и в случае с инфраструктурой членства, инфраструктура ролей строится на основе модели поставщика. Как <a id="_msoanchor_5"> </a>описано в учебнике [*основы безопасности и поддержка ASP.NET*](../introduction/security-basics-and-asp-net-support-cs.md) , .NET Framework поставляется с тремя встроенными поставщиками ролей: [`AuthorizationStoreRoleProvider`](https://msdn.microsoft.com/library/system.web.security.authorizationstoreroleprovider.aspx), [`WindowsTokenRoleProvider`](https://msdn.microsoft.com/library/system.web.security.windowstokenroleprovider.aspx)и [`SqlRoleProvider`](https://msdn.microsoft.com/library/system.web.security.sqlroleprovider.aspx). В этой серии руководств основное внимание уделяется `SqlRoleProvider`, в которой в качестве хранилища ролей используется база данных Microsoft SQL Server.

В ней рассматриваются платформа ролей и `SqlRoleProvider` работают точно так же, как и инфраструктура членства и `SqlMembershipProvider`. .NET Framework содержит класс `Roles`, который служит в качестве API для платформы ролей. Класс `Roles` содержит статические методы, такие как `CreateRole`, `DeleteRole`, `GetAllRoles`, `AddUserToRole`, `IsUserInRole`и т. д. При вызове одного из этих методов класс `Roles` делегирует вызов настроенному поставщику. `SqlRoleProvider` работает с таблицами, зависящими от роли (`aspnet_Roles` и `aspnet_UsersInRoles`) в ответе.

Чтобы использовать поставщик `SqlRoleProvider` в нашем приложении, необходимо указать базу данных, которая будет использоваться в качестве хранилища. `SqlRoleProvider` требуется, чтобы в указанном хранилище ролей имелись определенные таблицы, представления и хранимые процедуры базы данных. Эти необходимые объекты базы данных можно добавить с помощью [средства`aspnet_regsql.exe`](https://msdn.microsoft.com/library/ms229862.aspx). На этом этапе у нас уже есть база данных с схемой, необходимой для `SqlRoleProvider`. <a id="_msoanchor_6"> </a>В SQL Server руководстве по [*созданию схемы членства*](../membership/creating-the-membership-schema-in-sql-server-cs.md) мы создали базу данных с именем `SecurityTutorials.mdf` и использовали `aspnet_regsql.exe`, чтобы добавить службы приложений, которые включали объекты базы данных, необходимые для `SqlRoleProvider`. Поэтому нам нужно сообщить платформе Roles, что необходимо включить поддержку ролей и использовать `SqlRoleProvider` с базой данных `SecurityTutorials.mdf` в качестве хранилища ролей.

Платформа ролей настраивается с помощью элемента &lt;`roleManager`&gt; в файле `Web.config` приложения. По умолчанию поддержка ролей отключена. Чтобы включить его, необходимо присвоить атрибуту `enabled` элемента [&gt;&lt;`roleManager`](https://msdn.microsoft.com/library/ms164660.aspx) значение `true` следующим образом:

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample3.xml)]

По умолчанию у всех веб-приложений есть поставщик ролей с именем `AspNetSqlRoleProvider` типа `SqlRoleProvider`. Этот поставщик по умолчанию регистрируется в `machine.config` (находится в `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG`):

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample4.xml)]

Атрибут `connectionStringName` поставщика указывает используемое хранилище ролей. Поставщик `AspNetSqlRoleProvider` присваивает этому атрибуту значение `LocalSqlServer`, которое также определено в `machine.config` и указывает по умолчанию на базу данных SQL Server 2005, экспресс-выпуск в папке `App_Data` с именем `aspnet.mdf`.

Следовательно, если мы просто включили платформу Roles без указания каких бы то ни было сведений о поставщике в файле `Web.config` приложения, приложение использует зарегистрированный поставщик ролей по умолчанию, `AspNetSqlRoleProvider`. Если `~/App_Data/aspnet.mdf` базы данных не существует, среда выполнения ASP.NET автоматически создаст ее и добавит схему служб приложений. Однако мы не хотим использовать базу данных `aspnet.mdf`. Вместо этого мы хотим использовать базу данных `SecurityTutorials.mdf`, которая уже создана и добавила схему служб приложений в. Это изменение можно выполнить одним из двух способов:

- <strong>Укажите значение</strong> <strong>`LocalSqlServer`</strong> <strong>имя строки подключения в</strong> <strong>`Web.config`</strong> <strong>.</strong> Перезаписав значение имени строки подключения `LocalSqlServer` в `Web.config`, можно использовать поставщик зарегистрированных ролей по умолчанию (`AspNetSqlRoleProvider`) и правильно работать с базой данных `SecurityTutorials.mdf`. Дополнительные сведения об этом методе см. в записи блога [Скотта Гатри (](https://weblogs.asp.net/scottgu/), [которая настраивает ASP.NET 2,0 Службы приложений для использования SQL Server 2000 или SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx).
- <strong>Добавьте новый зарегистрированный поставщик типа</strong> <strong>`SqlRoleProvider`</strong> <strong>и настройте его</strong> параметры<strong>`connectionStringName`</strong>, <strong>чтобы она указывала</strong> на <strong>базу данных</strong> <strong>`SecurityTutorials.mdf`</strong>. Это подход, который я рекомендовал и использовал в <a id="_msoanchor_7"> </a> [*создании схемы членства в SQL Server*](../membership/creating-the-membership-schema-in-sql-server-cs.md) руководстве, и этот подход также будет использоваться в этом учебнике.

Добавьте следующую разметку конфигурации ролей в файл `Web.config`. Эта разметка регистрирует новый поставщик с именем `SecurityTutorialsSqlRoleProvider`.

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample5.xml)]

Приведенная выше разметка определяет `SecurityTutorialsSqlRoleProvider` как поставщик по умолчанию (через атрибут `defaultProvider` в элементе `<roleManager>`). Он также задает для параметра `applicationName` `SecurityTutorialsSqlRoleProvider`значение `SecurityTutorials`, которое соответствует параметру `applicationName`, используемому поставщиком членства (`SecurityTutorialsSqlMembershipProvider`). Хотя это не показано здесь, [элемент`<add>`](https://msdn.microsoft.com/library/ms164662.aspx) для `SqlRoleProvider` может также содержать атрибут `commandTimeout` для указания времени ожидания базы данных в секундах. Значение по умолчанию — 30.

С этой разметкой конфигурации мы готовы приступить к использованию функций ролей в нашем приложении.

> [!NOTE]
> Приведенная выше разметка конфигурации демонстрирует использование `enabled` и `defaultProvider` атрибутов элемента &lt;`roleManager`&gt;. Существует ряд других атрибутов, влияющих на то, как инфраструктура ролей связывает сведения о ролях на уровне пользователя. Эти параметры будут рассмотрены в учебнике по <a id="_msoanchor_8"> </a> [*авторизации на основе ролей*](role-based-authorization-cs.md) .

## <a name="step-3-examining-the-roles-api"></a>Шаг 3. изучение API ролей

Функциональность инфраструктуры ролей предоставляется через [класс`Roles`](https://msdn.microsoft.com/library/system.web.security.roles.aspx), который содержит статические методы тринадцать для выполнения операций на основе ролей. Когда мы рассмотрим создание и удаление ролей в шагах 4 и 6, мы будем использовать методы [`CreateRole`](https://msdn.microsoft.com/library/system.web.security.roles.createrole.aspx) и [`DeleteRole`](https://msdn.microsoft.com/library/system.web.security.roles.deleterole.aspx) , которые добавляют или удаляют роль из системы.

Чтобы получить список всех ролей в системе, используйте [метод`GetAllRoles`](https://msdn.microsoft.com/library/system.web.security.roles.getallroles.aspx) (см. шаг 5). [Метод`RoleExists`](https://msdn.microsoft.com/library/system.web.security.roles.roleexists.aspx) возвращает логическое значение, указывающее, существует ли указанная роль.

В следующем учебном курсе мы рассмотрим, как связать пользователей с ролями. Методы [`AddUserToRole`](https://msdn.microsoft.com/library/system.web.security.roles.addusertorole.aspx), [`AddUserToRoles`](https://msdn.microsoft.com/library/system.web.security.roles.addusertoroles.aspx), [`AddUsersToRole`](https://msdn.microsoft.com/library/system.web.security.roles.adduserstorole.aspx)и [`AddUsersToRoles`](https://msdn.microsoft.com/library/system.web.security.roles.adduserstoroles.aspx) класса `Roles` добавляют одного или нескольких пользователей к одной или нескольким ролям. Чтобы удалить пользователей из ролей, используйте методы [`RemoveUserFromRole`](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromrole.aspx), [`RemoveUserFromRoles`](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromroles.aspx), [`RemoveUsersFromRole`](https://msdn.microsoft.com/library/system.web.security.roles.removeusersfromrole.aspx)или [`RemoveUsersFromRoles`](https://msdn.microsoft.com/library/system.web.security.roles.removeusersfromroles.aspx) .

В учебнике по <a id="_msoanchor_9"> </a> [*авторизации на основе ролей*](role-based-authorization-cs.md) мы рассмотрим способы программного отображения или скрытия функциональных возможностей в зависимости от текущей роли пользователя, вошедшего в систему. Для этого можно использовать методы [`FindUsersInRole`](https://msdn.microsoft.com/library/system.web.security.roles.findusersinrole.aspx), [`GetRolesForUser`](https://msdn.microsoft.com/library/system.web.security.roles.getrolesforuser.aspx), [`GetUsersInRole`](https://msdn.microsoft.com/library/system.web.security.roles.getusersinrole.aspx)или [`IsUserInRole`](https://msdn.microsoft.com/library/system.web.security.roles.isuserinrole.aspx) класса `Role`.

> [!NOTE]
> Помните, что при каждом вызове одного из этих методов класс `Roles` делегирует вызов настроенному поставщику. В нашем случае это означает, что вызов отправляется в `SqlRoleProvider`. Затем `SqlRoleProvider` выполняет соответствующую операцию с базой данных на основе вызванного метода. Например, код `Roles.CreateRole("Administrators")` приводит `SqlRoleProvider` к выполнению хранимой процедуры `aspnet_Roles_CreateRole`, которая вставляет новую запись в таблицу `aspnet_Roles` с именем Administrators.

В оставшейся части этого руководства рассматривается использование методов `CreateRole`, `GetAllRoles`и `DeleteRole` класса `Roles` для управления ролями в системе.

## <a name="step-4-creating-new-roles"></a>Шаг 4. Создание новых ролей

Роли предлагают возможность произвольного группирования пользователей, и чаще всего эта группировка используется для более удобного применения правил авторизации. Но для использования ролей в качестве механизма авторизации сначала необходимо определить, какие роли существуют в приложении. К сожалению, ASP.NET не включает элемент управления Креатеролевизард. Чтобы добавить новые роли, необходимо создать подходящий интерфейс пользователя и самостоятельно вызвать API ролей. Хорошая новость в том, что это очень просто сделать.

> [!NOTE]
> Хотя отсутствует веб-элемент управления Креатеролевизард, существует [средство администрирования веб-узла ASP.NET](https://msdn.microsoft.com/library/ms228053.aspx), которое является локальным приложением ASP.NET, предназначенным для облегчения просмотра и управления конфигурацией веб-приложения. Однако я не являюсь большим вентилятором средства администрирования веб-узла ASP.NET по двум причинам. Во-первых, это немного ошибками, и взаимодействие с пользователем значительно потребует. Во-вторых, средство администрирования Web site ASP.NET предназначено для работы только локально. Это означает, что вам придется создавать собственные веб-страницы управления ролями, если необходимо удаленно управлять ролями на активном сайте. По этим двум причинам это руководство и следующее основное внимание уделяется созданию необходимых средств управления ролями на веб-странице, а не полагаться на средство администрирования веб-узла ASP.NET.

Откройте страницу `ManageRoles.aspx` в папке `Roles` и добавьте на страницу текстовое поле и элемент управления "Кнопка". Задайте для свойства `ID` элемента управления TextBox значение `RoleName` и свойства `ID` и `Text` кнопки, чтобы `CreateRoleButton` и создать роль соответственно. На этом этапе декларативная разметка страницы должна выглядеть следующим образом:

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample6.aspx)]

Затем дважды щелкните элемент управления "`CreateRoleButton`" в конструкторе, чтобы создать `Click` обработчик событий, а затем добавьте следующий код:

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample7.cs)]

Приведенный выше код начинается с присвоения имени сокращенной роли, указанной в текстовом поле `RoleName`, переменной `newRoleName`. Затем вызывается метод `RoleExists` класса `Roles`, чтобы определить, существует ли в системе роль, `newRoleName`. Если роль не существует, она создается с помощью вызова метода `CreateRole`. Если методу `CreateRole` передается имя роли, которое уже существует в системе, возникает исключение `ProviderException`. Именно поэтому код сначала проверяет, не существует ли роль в системе перед вызовом `CreateRole`. Обработчик событий `Click` завершается путем очистки свойства `Text` текстового поля `RoleName`.

> [!NOTE]
> Возможно, вас интересует, что произойдет, если пользователь не введет какое бы то ни было значение в текстовое поле `RoleName`. Если значение, передаваемое в метод `CreateRole`, `null` или является пустой строкой, возникает исключение. Аналогично, если имя роли содержит запятую, возникает исключение. Следовательно, страница должна содержать элементы управления проверки, чтобы убедиться, что пользователь вводит роль и не содержит запятые. Я оставлю в качестве упражнения для читателя.

Давайте создадим роль с именем Администраторы. Перейдите на страницу `ManageRoles.aspx` в браузере, введите Администраторы в текстовое поле (см. рис. 3), а затем нажмите кнопку Создать роль.

[![создать роль администраторов](creating-and-managing-roles-cs/_static/image8.png)](creating-and-managing-roles-cs/_static/image7.png)

**Рис. 3**. Создание роли администраторов ([щелкните, чтобы просмотреть изображение с полным размером](creating-and-managing-roles-cs/_static/image9.png))

Что произойдет? Происходит обратная передача, но отсутствует визуальная подсказка о том, что роль на самом деле была добавлена в систему. Мы будем обновлять эту страницу на шаге 5, чтобы включить визуальную обратную связь. Однако теперь можно убедиться, что роль создана, перейдя к базе данных `SecurityTutorials.mdf` и отобразив данные из `aspnet_Roles` таблицы. Как показано на рис. 4, `aspnet_Roles`ная таблица содержит запись для только что добавленных ролей администраторов.

[![aspnet_Roles таблица содержит строку для администраторов](creating-and-managing-roles-cs/_static/image11.png)](creating-and-managing-roles-cs/_static/image10.png)

**Рис. 4**. `aspnet_Roles`ная таблица содержит строку для администраторов ([щелкните, чтобы просмотреть изображение с полным размером](creating-and-managing-roles-cs/_static/image12.png))

## <a name="step-5-displaying-the-roles-in-the-system"></a>Шаг 5. отображение ролей в системе

Добавим `ManageRoles.aspx` страницу, чтобы включить список текущих ролей в системе. Для этого добавьте на страницу элемент управления GridView и задайте для его свойства `ID` значение `RoleList`. Затем добавьте метод в класс кода программной части страницы с именем `DisplayRolesInGrid`, используя следующий код:

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample8.cs)]

Метод `GetAllRoles` класса `Roles` возвращает все роли в системе в виде массива строк. Затем этот строковый массив привязывается к GridView. Чтобы привязать список ролей к GridView при первой загрузке страницы, необходимо вызвать метод `DisplayRolesInGrid` из обработчика событий `Page_Load` страницы. Следующий код вызывает этот метод при первом посещении страницы, но не при последующих обратных передачах.

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample9.cs)]

Используя этот код, перейдите на страницу в браузере. Как показано на рис. 5, вы увидите сетку с одним столбцом с меткой элемент. Сетка включает строку для роли администраторов, добавленную на шаге 4.

[![GridView отображает роли в одном столбце](creating-and-managing-roles-cs/_static/image14.png)](creating-and-managing-roles-cs/_static/image13.png)

**Рис. 5**. отображение ролей в элементе управления GridView в одном столбце ([щелкните, чтобы просмотреть изображение с полным размером](creating-and-managing-roles-cs/_static/image15.png))

Элемент GridView отображает отдельный столбец с меткой Item, так как свойство `AutoGenerateColumns` GridView имеет значение true (значение по умолчанию), которое заставляет GridView автоматически создавать столбец для каждого свойства в его `DataSource`. Массив содержит одно свойство, представляющее элементы массива, следовательно, один столбец в GridView.

При отображении данных с помощью GridView я предпочитаю явно определять мои столбцы, а не создавать их неявно с помощью GridView. Путем явного определения столбцов гораздо проще форматировать данные, переупорядочивать столбцы и выполнять другие стандартные задачи. Таким образом, давайте изменим декларативную разметку GridView так, чтобы ее столбцы были явно определены.

Начните с установки свойства `AutoGenerateColumns` GridView в значение false. Затем добавьте TemplateField в сетку, задайте для свойства `HeaderText` значение Roles и настройте его `ItemTemplate` таким образом, чтобы он отображал содержимое массива. Для этого добавьте в `ItemTemplate` веб-элемент управления Label с именем `RoleNameLabel` и привяжите его свойство `Text` к `Container.DataItem`.

Эти свойства и содержимое `ItemTemplate`можно задать декларативно или с помощью диалогового окна поля GridView и интерфейса редактирования шаблонов. Чтобы открыть диалоговое окно "поля", щелкните ссылку изменить столбцы в смарт-теге GridView. Затем снимите флажок автоматически создавать поля, чтобы присвоить свойству `AutoGenerateColumns` значение false, и добавьте TemplateField в GridView, установив для свойства `HeaderText` значение Role. Чтобы определить содержимое `ItemTemplate`, выберите параметр изменить шаблоны в смарт-теге GridView. Перетащите элемент управления Label на `ItemTemplate`, задайте для его свойства `ID` значение `RoleNameLabel`и настройте его параметры привязки, чтобы его свойство `Text` было привязано к `Container.DataItem`.

Независимо от того, какой подход вы используете, полученная декларативная разметка GridView должна выглядеть примерно так, как показано ниже.

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample10.aspx)]

> [!NOTE]
> Содержимое массива отображается с помощью синтаксиса DataBinding `<%# Container.DataItem %>`. Подробное описание того, почему этот синтаксис используется при отображении содержимого массива, привязанного к GridView, выходит за рамки данного руководства. Дополнительные сведения об этом важностях см. в статье [Привязка скалярного массива к веб-элементу управления данными](http://aspnet.4guysfromrolla.com/articles/082504-1.aspx).

В настоящее время `RoleList` GridView привязывается только к списку ролей при первом посещении страницы. Необходимо обновить сетку при добавлении новой роли. Для этого обновите обработчик событий `Click` кнопки `CreateRoleButton`, чтобы он вызывал метод `DisplayRolesInGrid` при создании новой роли.

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample11.cs)]

Теперь, когда пользователь добавляет новую роль, `RoleList` GridView показывает только что добавленную роль при обратной передаче, предоставляя визуальную реакцию на то, что роль была успешно создана. Чтобы проиллюстрировать это, перейдите на страницу `ManageRoles.aspx` в браузере и добавьте роль с именем Супервизоры. При нажатии кнопки Создать роль произойдет обратная передача, и в сетке будут добавлены администраторы, а также новая роль, Супервизоры.

[![добавлена роль "руководители"](creating-and-managing-roles-cs/_static/image17.png)](creating-and-managing-roles-cs/_static/image16.png)

**Рис. 6**. Добавлена роль "Супервизоры" ([щелкните, чтобы просмотреть изображение с полным размером](creating-and-managing-roles-cs/_static/image18.png))

## <a name="step-6-deleting-roles"></a>Шаг 6. Удаление ролей

На этом этапе пользователь может создать новую роль и просмотреть все существующие роли на странице `ManageRoles.aspx`. Давайте разрешите пользователям также удалять роли. Метод `Roles.DeleteRole` имеет две перегрузки:

- [`DeleteRole(roleName)`](https://msdn.microsoft.com/library/ek4sywc0.aspx) — Удаляет роль *roleName*. Если роль содержит один или несколько членов, возникает исключение.
- [`DeleteRole(roleName, throwOnPopulatedRole)`](https://msdn.microsoft.com/library/38h6wf59.aspx) — Удаляет роль *roleName*. Если *сровонпопулатероле* имеет `true`, то создается исключение, если роль содержит один или несколько членов. Если *сровонпопулатероле* имеет значение `false`, то роль удаляется независимо от того, содержит ли она какие-либо члены. На внутреннем уровне метод `DeleteRole(roleName)` вызывает `DeleteRole(roleName, true)`.

Метод `DeleteRole` также вызывает исключение, если параметр *roleName* имеет значение `null` или является пустой строкой или если *roleName* содержит запятую. Если параметр *roleName* не существует в системе, `DeleteRole` завершается со сбоем автоматически, без вызова исключения.

Добавим GridView в `ManageRoles.aspx`, чтобы добавить кнопку Удалить, которая при нажатии удаляет выбранную роль. Начните с добавления кнопки Удалить в GridView, перейдя в диалоговое окно поля и добавив кнопку Удалить, которая находится в разделе параметр CommandField. Сделайте нажатой кнопку Удалить в крайнем левом столбце и задайте для его свойства `DeleteText` значение удалить роль.

[![добавить кнопку "Удалить" в RoleList GridView](creating-and-managing-roles-cs/_static/image20.png)](creating-and-managing-roles-cs/_static/image19.png)

**Рис. 7**. Добавление кнопки "Удалить" в `RoleList` GridView ([щелкните, чтобы просмотреть изображение с полным размером](creating-and-managing-roles-cs/_static/image21.png))

После добавления кнопки "Удалить" декларативная разметка GridView должна выглядеть следующим образом:

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample12.aspx)]

Затем создайте обработчик событий для события `RowDeleting` GridView. Это событие возникает при обратной передаче при нажатии кнопки удаления роли. Добавьте в обработчик событий приведенный ниже код.

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample13.cs)]

Код начинается с программной ссылки на `RoleNameLabel` веб-элемент управления в строке, для которой была нажата кнопка Удалить роль. Затем вызывается метод `Roles.DeleteRole`, передающий `Text` `RoleNameLabel` и `false`, тем самым удаляя роль независимо от наличия пользователей, связанных с этой ролью. Наконец, `RoleList` GridView обновляется таким образом, что только что удаленная роль больше не отображается в сетке.

> [!NOTE]
> Для кнопки удалить роль не требуется никаких подтверждений от пользователя перед удалением роли. Одним из самых простых способов подтверждения действия является применение диалогового окна подтверждения на стороне клиента. Дополнительные сведения об этом способе см. в разделе [Добавление подтверждения на стороне клиента при удалении](https://asp.net/learn/data-access/tutorial-42-cs.aspx).

## <a name="summary"></a>Сводка

Многие веб-приложения имеют определенные правила авторизации или функции на уровне страницы, которые доступны только определенным классам пользователей. Например, может существовать набор веб-страниц, доступ к которым имеют только администраторы. Вместо того, чтобы определять эти правила авторизации на уровне пользователя, очень полезно определить правила на основе роли. То есть, вместо явного разрешения пользователям Скотт и Цзисунь на доступ к административным веб-страницам, более сопровождаемый подход заключается в предоставлении членам роли «Администраторы» доступа к этим страницам, а также для обозначения Скотт и Цзисунь в качестве пользователей, принадлежащих к Роль администраторов.

Инфраструктура ролей упрощает создание ролей и управление ими. В этом учебнике мы рассмотрели, как настроить платформу ролей для использования `SqlRoleProvider`, в которой в качестве хранилища ролей используется база данных Microsoft SQL Server. Мы также создали веб-страницу, в которой перечислены существующие роли в системе, и она позволяет создавать новые роли и удалять существующие. В следующих учебных курсах будет показано, как назначать пользователям роли и как применять авторизацию на основе ролей.

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Изучение членства, ролей и профиля ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Как использовать диспетчер ролей в ASP.NET 2,0](https://msdn.microsoft.com/library/ms998314.aspx)
- [Поставщики ролей](https://msdn.microsoft.com/library/aa478950.aspx)
- [Развертывание собственного средства администрирования веб-сайта](http://aspnet.4guysfromrolla.com/articles/052307-1.aspx)
- [Техническая документация по элементу `<roleManager>`](https://msdn.microsoft.com/library/ms164660.aspx)
- [Использование API членства и диспетчера ролей](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/membership.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — *[Sams обучать себя ASP.NET 2,0 за 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* . Скотт можно получить по адресу [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) или через свой блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого руководства включают Аликжа Мазиарз, Сучи Банержи и Терезой Мерфи. Хотите ознакомиться с моими будущими статьями MSDN? Если да, расположите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Вперед](assigning-roles-to-users-cs.md)
