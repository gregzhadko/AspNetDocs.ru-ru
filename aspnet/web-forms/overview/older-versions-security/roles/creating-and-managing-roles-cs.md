---
uid: web-forms/overview/older-versions-security/roles/creating-and-managing-roles-cs
title: Создание и управление ролями (C#) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве рассматриваются действия, необходимые для настройки роли платформы. После этого мы построим веб-страницы для создания и удаления ролей.
ms.author: riande
ms.date: 03/24/2008
ms.assetid: 113f10b3-a19a-471b-8ff6-db3c79ce8a91
msc.legacyurl: /web-forms/overview/older-versions-security/roles/creating-and-managing-roles-cs
msc.type: authoredcontent
ms.openlocfilehash: 3ee858cba449b0a8c8e693970a10ce0182e8c3da
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59412402"
---
# <a name="creating-and-managing-roles-c"></a>Создание ролей и управление ими (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/CS.09.zip) или [скачать PDF](http://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/aspnet_tutorial09_CreatingRoles_cs.pdf)

> В этом руководстве рассматриваются действия, необходимые для настройки роли платформы. После этого мы построим веб-страницы для создания и удаления ролей.


## <a name="introduction"></a>Вступление

В <a id="_msoanchor_1"> </a> [ *авторизации на основе пользователя* ](../membership/user-based-authorization-cs.md) учебнике мы рассмотрели использование авторизации URL-адреса для ограничения определенных пользователей из набора страниц и изучили декларативный и программные методы для настройки функций страницей ASP.NET, в зависимости от посетителя. Предоставление разрешения для доступа к странице или функций на основе пользователя по, однако может превратиться в кошмар в сценариях при наличии нескольких учетных записей пользователя или если часто менять права пользователей. Любое время, пользователь получает или теряет авторизации для выполнения определенной задачи, администратору необходимо обновить соответствующие правила авторизации URL-адрес, декларативная разметка и код.

Обычно полезно для классификации пользователей по группам или *ролей* и затем применить разрешения на основе ролей по ролям. Например, большинство веб-приложения имеют определенный набор страниц или задачи, которые зарезервированы только для пользователей с правами администратора. С помощью приемов узнали из *авторизации на основе пользователя* руководстве, мы бы добавили соответствующие правила авторизации URL-адрес, декларативная разметка и код, чтобы разрешить указанные учетные записи пользователей для выполнения административных задач. Но если был добавлен новый администратор или администратор существующего необходимым для разработки своего права администрирования отозван, придется вернуться и обновить файлы конфигурации и веб-страниц. С ролями тем не менее, мы могли бы создать роль, называются администраторами и назначить эти доверенных пользователей к роли "Администраторы". Затем мы добавьте соответствующие правила авторизации URL-адрес, декларативная разметка и код, чтобы разрешить роли "Администраторы" для выполнения различных административных задач. С этой инфраструктуры на месте Добавление новых администраторов на сайт или удаления существующих осуществляется простым добавления или удаления пользователя из роли "Администраторы". Нет конфигураций, декларативная разметка или изменения кода не требуется.

ASP.NET предоставляет инфраструктуру ролей для определения ролей и связав их с учетными записями пользователей. С помощью платформы роли можно создавать и удалять роли, добавлять или удалять пользователей из роли, определите набор пользователей, которые принадлежат определенной роли и определить, принадлежит ли пользователь к определенной роли. После настройки ролей framework мы можно ограничить доступ к страницам, на основе ролей по ролям через правила авторизации URL-адрес и Показать или скрыть дополнительные сведения или функциональность страницы на основе ролей для текущего пользователя.

В этом руководстве рассматриваются действия, необходимые для настройки роли платформы. После этого мы построим веб-страницы для создания и удаления ролей. В <a id="_msoanchor_2"> </a> [ *назначение ролей пользователям* ](assigning-roles-to-users-cs.md) руководства будут рассмотрены способы добавления и удаления пользователей из ролей. И в <a id="_msoanchor_3"> </a> [ *авторизации на основе ролей* ](role-based-authorization-cs.md) руководстве будет показано, как ограничить доступ к страницам, на основе роли по ролям, а также как настраивать функциональные возможности страницы в зависимости в роли выполняется посещение пользователя. Давайте начнем!

## <a name="step-1-adding-new-aspnet-pages"></a>Шаг 1. Добавление новых страниц ASP.NET

В этом руководстве и следующих двух мы остановимся подробнее различных функций для работы с ролями и возможности. Нам понадобится несколько страниц ASP.NET для реализации в разделах, проверены в данных учебных курсах. Давайте создавать эти страницы и обновите карту узла.

Начнем с создания новой папки в проект с именем `Roles`. Добавьте четыре новых страниц ASP.NET к `Roles` папке связывания каждой страницы с `Site.master` главной страницы. Имя страницы:

- `ManageRoles.aspx`
- `UsersAndRoles.aspx`
- `CreateUserWizardWithRoles.aspx`
- `RoleBasedAuthorization.aspx`

На этом этапе проекта обозреватель решений должен выглядеть снимок экрана, показанный на рис. 1.


[![Были добавлены четыре новые страницы в папку «роли»](creating-and-managing-roles-cs/_static/image2.png)](creating-and-managing-roles-cs/_static/image1.png)

**Рис. 1**: Четыре новых страниц были добавлены `Roles` папку ([Просмотр полноразмерного изображения](creating-and-managing-roles-cs/_static/image3.png))


Каждая страница на этом этапе у двух элементов управления содержимым, одной для каждого из элементов управления ContentPlaceHolder на главной странице: `MainContent` и `LoginContent`.

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample1.aspx)]

Помните, что `LoginContent` разметки по умолчанию элемента ContentPlaceHolder отображает ссылку на входе или выходе из системы сайта, в зависимости от того, является ли пользователь проверку подлинности. Наличие `Content2` содержимого элемента управления в страницу ASP.NET, тем не менее, переопределяет разметки по умолчанию на главной странице. Как уже говорилось в <a id="_msoanchor_4"> </a> [ *Обзор аутентификации форм* ](../introduction/an-overview-of-forms-authentication-cs.md) руководстве переопределение разметки по умолчанию удобно на страницах, где мы не хотите отображать связанные с входом параметры в левом столбце.

Для этих четырех страниц, тем не менее, мы хотим Показать разметки главной страницы по умолчанию для `LoginContent` ContentPlaceHolder. Таким образом, удалить декларативная разметка для `Content2` содержимого элемента управления. После этого каждый из разметки четыре страницы должен содержать только один элемент управления содержимым.

Наконец, давайте изменим карты узла (`Web.sitemap`) для включения этих новых веб-страниц. Добавьте следующий код XML после `<siteMapNode>` мы добавили учебников членства.

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample2.xml)]

С помощью карты узла обновлен посетите сайт через браузер. Как показано на рис. 2, навигации в левой части теперь включает элементы для роли учебники.


[![Были добавлены четыре новые страницы в папку «роли»](creating-and-managing-roles-cs/_static/image5.png)](creating-and-managing-roles-cs/_static/image4.png)

**Рис. 2**: Четыре новых страниц были добавлены `Roles` папку ([Просмотр полноразмерного изображения](creating-and-managing-roles-cs/_static/image6.png))


## <a name="step-2-specifying-and-configuring-the-roles-framework-provider"></a>Шаг 2. Указание и настройке поставщика ролей Framework

Как структуру членства ролей framework строится поверх модели поставщиков. Как уже говорилось в <a id="_msoanchor_5"> </a> [ *основы управления и поддержки ASP.NET* ](../introduction/security-basics-and-asp-net-support-cs.md) учебник, .NET Framework имеется три встроенных поставщиков ролей: [ `AuthorizationStoreRoleProvider` ](https://msdn.microsoft.com/library/system.web.security.authorizationstoreroleprovider.aspx) , [ `WindowsTokenRoleProvider` ](https://msdn.microsoft.com/library/system.web.security.windowstokenroleprovider.aspx), и [ `SqlRoleProvider` ](https://msdn.microsoft.com/library/system.web.security.sqlroleprovider.aspx). В этой серии руководств посвящена `SqlRoleProvider`, который использует базу данных Microsoft SQL Server в качестве хранилища ролей.

Принципы работы framework ролей и `SqlRoleProvider` работают так же, как структуры членства и `SqlMembershipProvider`. .NET Framework содержит `Roles` класс, который служит в качестве API, чтобы платформа ролей. `Roles` Класс содержит статические методы, такие как `CreateRole`, `DeleteRole`, `GetAllRoles`, `AddUserToRole`, `IsUserInRole`, и т. д. При вызове одного из этих методов `Roles` класс делегирует вызов настроенного поставщика. `SqlRoleProvider` Работает с таблицами конкретной роли (`aspnet_Roles` и `aspnet_UsersInRoles`) в ответ.

Чтобы использовать `SqlRoleProvider` поставщика в этом примере нам нужно указать, что базы данных для использования в качестве хранилища. `SqlRoleProvider` Ожидает, что хранилище указанной роли для определенных таблиц базы данных, представления и хранимые процедуры. Эти объекты необходимые базы данных могут добавляться с помощью [ `aspnet_regsql.exe` средство](https://msdn.microsoft.com/library/ms229862.aspx). На этом этапе у нас уже есть базу данных с помощью схемы, необходимые для `SqlRoleProvider`. Вернитесь в <a id="_msoanchor_6"> </a> [ *Создание схемы членства в SQL Server* ](../membership/creating-the-membership-schema-in-sql-server-cs.md) руководстве мы создали базу данных с именем `SecurityTutorials.mdf` и использовать `aspnet_regsql.exe` Чтобы добавить это приложение службы, которые включены объекты базы данных, необходимые для `SqlRoleProvider`. Поэтому необходимо сообщить платформе роли для поддержки роли и использовать `SqlRoleProvider` с `SecurityTutorials.mdf` базу данных в качестве хранилища ролей.

Платформа ролей настраивается с помощью &lt; `roleManager` &gt; элемент в приложении `Web.config` файл. По умолчанию поддержка ролей отключена. Чтобы включить ее, необходимо задать [ &lt; `roleManager` &gt; ](https://msdn.microsoft.com/library/ms164660.aspx) элемента `enabled` атрибут `true` следующим образом:

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample3.xml)]

По умолчанию все веб-приложения имеется поставщик ролей с именем `AspNetSqlRoleProvider` типа `SqlRoleProvider`. Этот поставщик по умолчанию регистрируется в `machine.config` (расположенный `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG`):

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample4.xml)]

Поставщика `connectionStringName` атрибут задает хранилище роли, который используется. `AspNetSqlRoleProvider` Этот атрибут задает поставщик `LocalSqlServer`, который определен в `machine.config` и точки, по умолчанию для базы данных SQL Server 2005 Express Edition в `App_Data` папку с именем `aspnet.mdf`.

Следовательно Если мы просто включите framework ролей, не указывая сведения о поставщиках в нашем приложении `Web.config` файл, приложение использует поставщик роли по умолчанию зарегистрированные `AspNetSqlRoleProvider`. Если `~/App_Data/aspnet.mdf` базы данных не существует, среда выполнения ASP.NET будет автоматически создать его и добавить схему служб приложения. Тем не менее, мы не хотим использовать `aspnet.mdf` базы данных; вместо этого мы хотим использовать `SecurityTutorials.mdf` базы данных, мы уже создали и добавили схему служб в приложение. Это изменение можно выполнить одним из двух способов:

- <strong>Укажите значение для</strong><strong>`LocalSqlServer`</strong><strong>имя строки подключения в</strong><strong>`Web.config`</strong><strong>.</strong> Путем перезаписи `LocalSqlServer` значение имя строки подключения в `Web.config`, можно использовать поставщик ролей по умолчанию зарегистрированные (`AspNetSqlRoleProvider`), который будет правильно работать с `SecurityTutorials.mdf` базы данных. Дополнительные сведения об этом приеме см. в разделе [Скотт Гатри](https://weblogs.asp.net/scottgu/)в записи блога, [Настройка ASP.NET 2.0 службы приложений для использования SQL Server 2000 или SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx).
- <strong>Добавить новый зарегистрированный поставщик типа</strong><strong>`SqlRoleProvider`</strong><strong>и настроить его</strong><strong>`connectionStringName`</strong><strong>параметр для указания</strong> <strong>`SecurityTutorials.mdf`</strong> <strong>базы данных.</strong> Именно этот подход я рекомендуется и используется в <a id="_msoanchor_7"> </a> [ *Создание схемы членства в SQL Server* ](../membership/creating-the-membership-schema-in-sql-server-cs.md) учебник и он является подходом, я буду использовать в этом руководстве также.

Добавьте следующую разметку конфигурации ролей для `Web.config` файла. Эта разметка регистрирует новый поставщик с именем `SecurityTutorialsSqlRoleProvider`.

[!code-xml[Main](creating-and-managing-roles-cs/samples/sample5.xml)]

Приведенная выше разметка определяет `SecurityTutorialsSqlRoleProvider` как поставщик по умолчанию (с помощью `defaultProvider` атрибут в `<roleManager>` элемент). Он также задает `SecurityTutorialsSqlRoleProvider` `applicationName` присвоить `SecurityTutorials`, как `applicationName` параметром, используемым поставщиком членства (`SecurityTutorialsSqlMembershipProvider`). Пока не отображается, [ `<add>` элемент](https://msdn.microsoft.com/library/ms164662.aspx) для `SqlRoleProvider` может также содержать `commandTimeout` атрибут, чтобы указать длительность времени ожидания базы данных, в секундах. Значение по умолчанию — 30.

С этой разметкой конфигурации на месте мы готовы начать работу с функциональным возможностям роли в рамках нашего приложения.

> [!NOTE]
> Приведенная выше разметка конфигурации иллюстрирует использование &lt; `roleManager` &gt; элемента `enabled` и `defaultProvider` атрибуты. Существует ряд других атрибутов, которые влияют на то, как платформа ролей связывает сведения о роли на основе пользователя по. Мы рассмотрим эти параметры в <a id="_msoanchor_8"> </a> [ *авторизации на основе ролей* ](role-based-authorization-cs.md) руководства.


## <a name="step-3-examining-the-roles-api"></a>Шаг 3. Изучение API ролей

Платформа роли функции реализуются через [ `Roles` класс](https://msdn.microsoft.com/library/system.web.security.roles.aspx), который содержит тринадцать статические методы для выполнения операций на основе ролей. Когда мы рассмотрим создание и удаление ролей в шагах 4 и 6 мы будем использовать [ `CreateRole` ](https://msdn.microsoft.com/library/system.web.security.roles.createrole.aspx) и [ `DeleteRole` ](https://msdn.microsoft.com/library/system.web.security.roles.deleterole.aspx) методы, которые можно добавить или удалить роль из системы.

Чтобы получить список всех ролей в системе, используйте [ `GetAllRoles` метод](https://msdn.microsoft.com/library/system.web.security.roles.getallroles.aspx) (см. шаг 5). [ `RoleExists` Метод](https://msdn.microsoft.com/library/system.web.security.roles.roleexists.aspx) возвращает логическое значение, указывающее, существует ли указанной роли.

В следующем учебном курсе мы рассмотрим, как связать пользователей с ролями. `Roles` Класса [ `AddUserToRole` ](https://msdn.microsoft.com/library/system.web.security.roles.addusertorole.aspx), [ `AddUserToRoles` ](https://msdn.microsoft.com/library/system.web.security.roles.addusertoroles.aspx), [ `AddUsersToRole` ](https://msdn.microsoft.com/library/system.web.security.roles.adduserstorole.aspx), и [ `AddUsersToRoles` ](https://msdn.microsoft.com/library/system.web.security.roles.adduserstoroles.aspx) методы добавления одного или нескольких пользователей для одной или нескольких ролей. Чтобы удалить пользователей из ролей, используйте [ `RemoveUserFromRole` ](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromrole.aspx), [ `RemoveUserFromRoles` ](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromroles.aspx), [ `RemoveUsersFromRole` ](https://msdn.microsoft.com/library/system.web.security.roles.removeusersfromrole.aspx), или [ `RemoveUsersFromRoles` ](https://msdn.microsoft.com/library/system.web.security.roles.removeusersfromroles.aspx) методы.

В <a id="_msoanchor_9"> </a> [ *авторизации на основе ролей* ](role-based-authorization-cs.md) руководстве мы рассмотрим способы программным способом отображать или скрывать функций в зависимости от роли пользователя, выполнившего вход. Для этого мы используем `Role` класса [ `FindUsersInRole` ](https://msdn.microsoft.com/library/system.web.security.roles.findusersinrole.aspx), [ `GetRolesForUser` ](https://msdn.microsoft.com/library/system.web.security.roles.getrolesforuser.aspx), [ `GetUsersInRole` ](https://msdn.microsoft.com/library/system.web.security.roles.getusersinrole.aspx), или [ `IsUserInRole` ](https://msdn.microsoft.com/library/system.web.security.roles.isuserinrole.aspx) методы.

> [!NOTE]
> Имейте в виду, что любое время, один из этих методов вызывается, `Roles` класс делегирует вызов настроенного поставщика. В нашем случае это означает, что вызов отправляется `SqlRoleProvider`. `SqlRoleProvider` Затем выполняет операцию соответствующую базу данных, в зависимости от вызываемого метода. Например, код `Roles.CreateRole("Administrators")` приводит `SqlRoleProvider` выполнение `aspnet_Roles_CreateRole` хранимые процедуры, которая вставляет новую запись в `aspnet_Roles` таблицу с именем администраторов.


Рассматривает оставшейся части этого руководства с помощью `Roles` класса `CreateRole`, `GetAllRoles`, и `DeleteRole` методы для управления ролями в системе.

## <a name="step-4-creating-new-roles"></a>Шаг 4. Создание новых ролей

Роли обеспечивают способ произвольно группы пользователей и наиболее часто используется такой способ группировки для более удобным способом для применения правил авторизации. Но для использования ролей как механизм авторизации, сначала необходимо определить, какие роли существуют в приложении. К сожалению ASP.NET не включает элемент управления CreateRoleWizard. Чтобы добавить новые роли, нам нужно создать подходящий пользовательский интерфейс и вызвать интерфейс API ролей сами. Хорошей новостью является то, что это очень легко осуществить.

> [!NOTE]
> Несмотря на то есть, не CreateRoleWizard веб-элемента управления есть [ASP.NET Web Site Administration Tool](https://msdn.microsoft.com/library/ms228053.aspx), который является локальным приложением ASP.NET, предназначенных для облегчения просмотра и управления конфигурацией веб-приложения. Тем не менее я не большой любитель средство администрирования веб-сайта ASP.NET по двум причинам. Во-первых это немного ошибками и взаимодействие с пользователем оставляет желать много лучшего. Во-вторых средство администрирования веб-сайта ASP.NET позволяет работать только локально, это означает, что необходимо будет создать собственную роль управления веб-страниц, если вам нужно удаленно управлять ролями на действующем сайте. Эти две причины этого учебника, а также следующие основное внимание уделяется построение необходимая роль средств управления на веб-странице, а не полагается на средство администрирования веб-узла ASP.NET.


Откройте `ManageRoles.aspx` странице в `Roles` папку и добавьте текстовое поле и кнопку веб-элемент управления на страницу. Значение элемента управления TextBox `ID` свойства `RoleName` и кнопки `ID` и `Text` свойства `CreateRoleButton` и Create Role, соответственно. На этом этапе декларативная разметка страницы должна выглядеть следующего вида:

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample6.aspx)]

Далее дважды щелкните `CreateRoleButton` управления в конструктор для создания "Кнопка" `Click` обработчик событий и затем добавьте следующий код:

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample7.cs)]

Приведенный выше код запускается, назначив имя обрезанной роли, введенное в `RoleName` TextBox для `newRoleName` переменной. Далее, `Roles` класса `RoleExists` метод вызывается для определения роли `newRoleName` уже существует в системе. Если роль не существует, он создается путем вызова `CreateRole` метод. Если `CreateRole` методу передается имя роли, который уже существует в системе, `ProviderException` возникает исключение. Именно поэтому код сначала проверяет, чтобы убедиться, что роль уже существует в системе перед вызовом `CreateRole`. `Click` Завершении работы обработчика событий при очистке `RoleName` текстового поля `Text` свойство.

> [!NOTE]
> Может возникнуть вопрос, что произойдет, если пользователь не введет любое значение в `RoleName` текстового поля. Если значение, передаваемое в `CreateRole` метод `null` или является пустой строкой, исключение вызывается. Аналогично Если имя роли содержит запятую возникает исключение. Как следствие страница должна содержать элементы управления проверки, чтобы убедиться, что пользователь вводит роль и что он не содержит запятые. Я оставьте в качестве упражнения для чтения.


Давайте создадим роль с именем администраторов. Посетите `ManageRoles.aspx` странице через браузер, в текстовом поле введите администраторов (см. рис. 3), а затем нажмите кнопку Create Role.


[![Создание роли "Администраторы"](creating-and-managing-roles-cs/_static/image8.png)](creating-and-managing-roles-cs/_static/image7.png)

**Рис. 3**: Создание роли "Администраторы" ([Просмотр полноразмерного изображения](creating-and-managing-roles-cs/_static/image9.png))


Что происходит? Происходит обратная передача, но есть не визуальную подсказку, которая фактически была роль добавлены к системе. Мы будем обновлять эту страницу, на шаге 5, чтобы включить визуальную обратную связь. Сейчас, тем не менее, можно проверить создания роли, перейдя к `SecurityTutorials.mdf` базы данных и отображения данных из `aspnet_Roles` таблицы. Как показано на рис. 4, `aspnet_Roles` таблица содержит записи для только что добавленные ролей администраторов.


[![Aspnet_Roles таблица имеет одну строку для администраторов](creating-and-managing-roles-cs/_static/image11.png)](creating-and-managing-roles-cs/_static/image10.png)

**Рис. 4**: `aspnet_Roles` Таблица содержит строку для администраторов ([Просмотр полноразмерного изображения](creating-and-managing-roles-cs/_static/image12.png))


## <a name="step-5-displaying-the-roles-in-the-system"></a>Шаг 5. Отображение ролей в системе

Давайте дополнить `ManageRoles.aspx` страницу, чтобы включить список текущих ролей в системе. Для этого добавьте элемент управления GridView на страницу и задайте его `ID` свойства `RoleList`. Добавьте метод в класс фонового кода страницы с именем `DisplayRolesInGrid` следующим образом:

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample8.cs)]

`Roles` Класса `GetAllRoles` метод возвращает все роли в системе как массив строк. Этот массив строк, затем привязывается к GridView. Чтобы привязать к GridView список ролей, при первой загрузке страницы, нам нужно вызвать `DisplayRolesInGrid` метода на странице `Page_Load` обработчик событий. Следующий код вызывает этот метод при первом посещении страницы, но не при последующих обратных передачах.

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample9.cs)]

Этот код в месте посетите страницу через обозреватель. Как показано на рис. 5, вы должны увидеть таблицу с одним столбцом с меткой элемента. Сетка включает строку для роли "Администраторы", реализованной в шаге 4.


[![Элемент GridView отображает по роли в одном столбце](creating-and-managing-roles-cs/_static/image14.png)](creating-and-managing-roles-cs/_static/image13.png)

**Рис. 5**: Элемент GridView отображает по роли в одном столбце ([Просмотр полноразмерного изображения](creating-and-managing-roles-cs/_static/image15.png))


Элемент GridView отображает по одиночному столбец с меткой элемента, так как GridView `AutoGenerateColumns` свойство имеет значение True (по умолчанию), что приводит к GridView, чтобы автоматически создать столбец для каждого свойства в его `DataSource`. Массив имеет одно свойство, представляющее элементов в массиве, поэтому один столбец в GridView.

При отображении данных с помощью элемента управления GridView, я предпочитаю явным образом определить мой столбцы, а не их неявно созданные GridView. Явно определив столбцы, гораздо проще для форматирования данных, изменять порядок столбцов и выполнять другие стандартные задачи. Таким образом давайте обновим декларативная разметка GridView, таким образом, чтобы ее столбцы определяются явно.

Начать с настройки GridView `AutoGenerateColumns` значение False. Затем добавьте поле TemplateField в сетку, установите его `HeaderText` свойство роли и настроить его `ItemTemplate` таким образом, чтобы он отображает содержимое массива. Для этого добавьте элемент управления Label Web `RoleNameLabel` для `ItemTemplate` и привязать его `Text` свойства `Container.DataItem`.

Эти свойства и `ItemTemplate`его содержимое можно задать декларативно или через поля GridView-диалоговое окно и редактирование шаблонов интерфейса. Чтобы открыть диалоговое окно поля, щелкните ссылку Изменить столбцы в смарт-теге элемента GridView. Затем снимите флажок автоматического создания полей для задания `AutoGenerateColumns` свойство имеет значение false и Добавление поля TemplateField GridView, установив его `HeaderText` свойства роли. Для определения `ItemTemplate`его содержимое, выберите параметр Правка шаблонов смарт-теге элемента GridView. Перетащите элемент управления Label Web `ItemTemplate`, задайте его `ID` свойства `RoleNameLabel`и настроить соответствующие параметры привязки данных, чтобы его `Text` свойство привязано к `Container.DataItem`.

Какой бы подход используется GridView итоговый должна выглядеть следующим образом когда закончите.

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample10.aspx)]

> [!NOTE]
> Содержимое массива, отображаются с использованием синтаксиса привязки данных `<%# Container.DataItem %>`. Полное описание почему такой синтаксис используется, когда отображение содержимое массива, привязанный к GridView выходит за рамки данного руководства. Дополнительные сведения по данному вопросу см. [привязка к веб-элемент данных массива скаляр](http://aspnet.4guysfromrolla.com/articles/082504-1.aspx).


В настоящее время `RoleList` GridView привязана только к список ролей при первом посещении страницы. Нам нужно обновить сетку при каждом добавлении новой роли. Чтобы добиться этого, обновите `CreateRoleButton` кнопки `Click` обработчик событий, поэтому он вызывает `DisplayRolesInGrid` метод, если создается новый объект role.

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample11.cs)]

Теперь в том случае, когда пользователь добавляет новую роль `RoleList` GridView показана роль только что добавленные при обратной передаче, предоставляя визуальную обратную связь, что роль была успешно создана. Чтобы проиллюстрировать это, посетите `ManageRoles.aspx` странице через браузер и добавьте роль с именем руководителями. После нажатия кнопки «Создать роль», произойдет обратная передача и сетки будет обновлено для включения администраторов, а также новую роль, а Супервизоров.


[![Роль руководителями имеет были добавлены](creating-and-managing-roles-cs/_static/image17.png)](creating-and-managing-roles-cs/_static/image16.png)

**Рис. 6**: Роль руководителями имеет были добавлены ([Просмотр полноразмерного изображения](creating-and-managing-roles-cs/_static/image18.png))


## <a name="step-6-deleting-roles"></a>Шаг 6. Удаление ролей

На этом этапе пользователь может создать новую роль и просматривать все имеющиеся роли из `ManageRoles.aspx` страницы. Давайте позволяет также удалять роли. `Roles.DeleteRole` Метод имеет две перегрузки:

- [`DeleteRole(roleName)`](https://msdn.microsoft.com/library/ek4sywc0.aspx) — Удаляет роль *roleName*. Исключение возникает в том случае, если роль содержит один или несколько членов.
- [`DeleteRole(roleName, throwOnPopulatedRole)`](https://msdn.microsoft.com/library/38h6wf59.aspx) — Удаляет роль *roleName*. Если *throwOnPopulateRole* является `true`, а затем исключение, если роль содержит один или несколько членов. Если *throwOnPopulateRole* — `false`, то роль, удаляется ли она содержит элементы, или нет. На внутреннем уровне `DeleteRole(roleName)` вызовы методов `DeleteRole(roleName, true)`.

`DeleteRole` Метода также будет выдано исключение, если *roleName* — `null` или является пустой строкой или если *roleName* содержит запятую. Если *roleName* не существует в системе, `DeleteRole` завершается сбоем без уведомления, не вызывая исключение.

Давайте дополнить GridView в `ManageRoles.aspx` для включения удаления кнопка, при нажатии удаляет выбранную роль. Начните с добавления кнопки удаления к элементу GridView в поля-диалоговое окно и добавить кнопку Delete, который находится под параметром CommandField. Сделать удаления столбца к дальней кнопку и задайте его `DeleteText` свойство, чтобы удалить роль.


[![Добавьте кнопку «Удалить» к элементу RoleList GridView](creating-and-managing-roles-cs/_static/image20.png)](creating-and-managing-roles-cs/_static/image19.png)

**Рис. 7**: Добавление кнопки Delete для `RoleList` GridView ([Просмотр полноразмерного изображения](creating-and-managing-roles-cs/_static/image21.png))


После добавления «удалить», декларативная разметка элемента GridView должен выглядеть следующим образом:

[!code-aspx[Main](creating-and-managing-roles-cs/samples/sample12.aspx)]

Создайте обработчик событий для элемента GridView `RowDeleting` событий. Это событие, возникающее при обратной передаче, при нажатии кнопки удаления роли. Добавьте в обработчик событий приведенный ниже код.

[!code-csharp[Main](creating-and-managing-roles-cs/samples/sample13.cs)]

Код начинается с программного обращения `RoleNameLabel` веб-элемента управления в строке, удалите роль была нажата. `Roles.DeleteRole` Затем вызывается метод, передавая `Text` из `RoleNameLabel` и `false`, тем самым удаление роли независимо от того, следует ли есть пользователи, связанные с ролью. Наконец `RoleList` обновляется GridView, таким образом, чтобы просто удалить роль больше не отображается в сетке.

> [!NOTE]
> «Удалить роль» не требует каких-либо подтверждения от пользователя перед удалением роли. Одна из самых простых способов, чтобы подтвердить действие — через диалоговое окно подтверждения на стороне клиента. Дополнительные сведения об этом приеме см. в разделе [Добавление клиентского подтверждения при Идет удаление](https://asp.net/learn/data-access/tutorial-42-cs.aspx).


## <a name="summary"></a>Сводка

Многие веб-приложения имеют определенные правила авторизации или страницам функциональность, доступная только для определенных классов пользователей. Например может быть набор веб-страниц, только для администраторов. Вместо определения этих правил авторизации на основе пользователя по, зачастую это более полезно для определения правил на основе роли. Вместо того, чтобы явным образом, позволяя пользователям Скотт и Цзисунь, для доступа к веб-страниц администрирования, более простым в обслуживании подход является разрешить членами роли "Администраторы" для доступа к этим страницам, а затем для обозначения Скотт и Цзисунь как пользователей, принадлежащих к Роли "Администраторы".

Платформа роли упрощает создание ролей и управление ими. В этом учебнике мы рассмотрели способы настройки ролей средой используется `SqlRoleProvider`, который использует базу данных Microsoft SQL Server в качестве хранилища ролей. Мы также создали веб-странице перечислены роли, существующие в системе и позволяет использовать новые роли должен быть создан и существующие, чтобы удалить. В последующих руководствах вы узнаете, как назначать пользователей ролям и как применять проверку подлинности на основе ролей.

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Изучение ASP.NET 2.0 членства, ролей и профиля](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Практическое руководство. Использование диспетчера ролей в ASP.NET 2.0](https://msdn.microsoft.com/library/ms998314.aspx)
- [Поставщики ролей](https://msdn.microsoft.com/library/aa478950.aspx)
- [Развертывание собственного средства администрирования веб-сайта](http://aspnet.4guysfromrolla.com/articles/052307-1.aspx)
- [Техническая документация по `<roleManager>` элемент](https://msdn.microsoft.com/library/ms164660.aspx)
- [С помощью членства и интерфейсов API диспетчера ролей](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/membership.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Лиз Шалок в этом руководстве включают Alicja Maziarz Банерджи Suchi и Терезой Мерфи. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Вперед](assigning-roles-to-users-cs.md)
