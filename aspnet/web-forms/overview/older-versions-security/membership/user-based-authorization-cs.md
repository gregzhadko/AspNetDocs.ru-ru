---
uid: web-forms/overview/older-versions-security/membership/user-based-authorization-cs
title: Авторизации на основе пользователей (C#) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве мы рассмотрим ограничение доступа к страницам и ограничивая функциональные возможности уровня страницы с помощью разных методов.
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 3c815a9e-2296-4b9b-b945-776d54989daa
msc.legacyurl: /web-forms/overview/older-versions-security/membership/user-based-authorization-cs
msc.type: authoredcontent
ms.openlocfilehash: 3078c186431d7662d54bc7e05dde60124de1956d
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65131870"
---
# <a name="user-based-authorization-c"></a><span data-ttu-id="fca8a-103">Авторизация на основе пользователей (C#)</span><span class="sxs-lookup"><span data-stu-id="fca8a-103">User-Based Authorization (C#)</span></span>

<span data-ttu-id="fca8a-104">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="fca8a-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="fca8a-105">[Скачать код](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_07_CS.zip) или [скачать PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial07_UserAuth_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="fca8a-105">[Download Code](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_07_CS.zip) or [Download PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial07_UserAuth_cs.pdf)</span></span>

> <span data-ttu-id="fca8a-106">В этом руководстве мы рассмотрим ограничение доступа к страницам и ограничивая функциональные возможности уровня страницы с помощью разных методов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-106">In this tutorial we will look at limiting access to pages and restricting page-level functionality through a variety of techniques.</span></span>

## <a name="introduction"></a><span data-ttu-id="fca8a-107">Вступление</span><span class="sxs-lookup"><span data-stu-id="fca8a-107">Introduction</span></span>

<span data-ttu-id="fca8a-108">Большинство веб-приложений, которые содержат учетные записи пользователей сделать это в части для ограничения определенных посетителям доступ к некоторым страницам на сайте.</span><span class="sxs-lookup"><span data-stu-id="fca8a-108">Most web applications that offer user accounts do so in part to restrict certain visitors from accessing certain pages within the site.</span></span> <span data-ttu-id="fca8a-109">В наиболее online messageboard сайтов например, все пользователи — анонимные и проверкой подлинности — доступны для просмотра записей messageboard, но только авторизованные пользователи могут посетить веб-страницы для создания новой записи.</span><span class="sxs-lookup"><span data-stu-id="fca8a-109">In most online messageboard sites, for example, all users - anonymous and authenticated - are able to view the messageboard's posts, but only authenticated users can visit the web page to create a new post.</span></span> <span data-ttu-id="fca8a-110">Также может возникнуть административным страницам, которые доступны только для определенного пользователя (или определенного набора пользователей).</span><span class="sxs-lookup"><span data-stu-id="fca8a-110">And there may be administrative pages that are only accessible to a particular user (or a particular set of users).</span></span> <span data-ttu-id="fca8a-111">Кроме того функциональные возможности уровня страницы могут различаться на основе пользователя по.</span><span class="sxs-lookup"><span data-stu-id="fca8a-111">Moreover, page-level functionality can differ on a user-by-user basis.</span></span> <span data-ttu-id="fca8a-112">При просмотре списка записей, прошедших проверку подлинности пользователей отображаются интерфейс для оценки каждой отправки, в то время как этот интерфейс доступен не для анонимных пользователей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-112">When viewing a list of posts, authenticated users are shown an interface for rating each post, whereas this interface is not available to anonymous visitors.</span></span>

<span data-ttu-id="fca8a-113">ASP.NET позволяет легко определить правила авторизации на основе пользователя.</span><span class="sxs-lookup"><span data-stu-id="fca8a-113">ASP.NET makes it easy to define user-based authorization rules.</span></span> <span data-ttu-id="fca8a-114">Совсем немного разметки в `Web.config`, определенные веб-страницы или весь каталог может быть зафиксирован, чтобы они доступны только определенному подмножеству пользователей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-114">With just a bit of markup in `Web.config`, specific web pages or entire directories can be locked down so that they are only accessible to a specified subset of users.</span></span> <span data-ttu-id="fca8a-115">Функциональные возможности уровня страницы можно включить или отключить зависимости от пользователя, выполнившего вход через программной и декларативной средства.</span><span class="sxs-lookup"><span data-stu-id="fca8a-115">Page-level functionality can be turned on or off based on the currently logged in user through programmatic and declarative means.</span></span>

<span data-ttu-id="fca8a-116">В этом руководстве мы рассмотрим ограничение доступа к страницам и ограничивая функциональные возможности уровня страницы с помощью разных методов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-116">In this tutorial we will look at limiting access to pages and restricting page-level functionality through a variety of techniques.</span></span> <span data-ttu-id="fca8a-117">Давайте начнем!</span><span class="sxs-lookup"><span data-stu-id="fca8a-117">Let's get started!</span></span>

## <a name="a-look-at-the-url-authorization-workflow"></a><span data-ttu-id="fca8a-118">Рассмотрим рабочий процесс авторизации URL-адрес</span><span class="sxs-lookup"><span data-stu-id="fca8a-118">A Look at the URL Authorization Workflow</span></span>

<span data-ttu-id="fca8a-119">Как уже говорилось в [ *Обзор аутентификации форм* ](../introduction/an-overview-of-forms-authentication-cs.md) руководстве описано, когда среда выполнения ASP.NET обрабатывает запрос для запроса ресурса ASP.NET вызывает ряд событий во время его жизненного цикла.</span><span class="sxs-lookup"><span data-stu-id="fca8a-119">As discussed in the [*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, when the ASP.NET runtime processes a request for an ASP.NET resource the request raises a number of events during its lifecycle.</span></span> <span data-ttu-id="fca8a-120">*HTTP-модули* — управляемые классы, код которого выполняется в ответ на определенное событие в жизненном цикле запроса.</span><span class="sxs-lookup"><span data-stu-id="fca8a-120">*HTTP Modules* are managed classes whose code is executed in response to a particular event in the request lifecycle.</span></span> <span data-ttu-id="fca8a-121">В ASP.NET имеется ряд модулей HTTP, выполнения важных задач за кулисами.</span><span class="sxs-lookup"><span data-stu-id="fca8a-121">ASP.NET ships with a number of HTTP Modules that perform essential tasks behind the scenes.</span></span>

<span data-ttu-id="fca8a-122">Является одним из таких модулей HTTP [ `FormsAuthenticationModule` ](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx).</span><span class="sxs-lookup"><span data-stu-id="fca8a-122">One such HTTP Module is [`FormsAuthenticationModule`](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx).</span></span> <span data-ttu-id="fca8a-123">Как уже говорилось в предыдущих учебных курсах, основная функция `FormsAuthenticationModule` определяет удостоверение текущего запроса.</span><span class="sxs-lookup"><span data-stu-id="fca8a-123">As discussed in previous tutorials, the primary function of the `FormsAuthenticationModule` is to determine the identity of the current request.</span></span> <span data-ttu-id="fca8a-124">Это достигается путем проверки билета проверки подлинности, который либо находится в файле cookie, либо внедрен в URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="fca8a-124">This is accomplished by inspecting the forms authentication ticket, which is either located in a cookie or embedded within the URL.</span></span> <span data-ttu-id="fca8a-125">Этот код выполняется во время [ `AuthenticateRequest` событий](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx).</span><span class="sxs-lookup"><span data-stu-id="fca8a-125">This identification takes place during the [`AuthenticateRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx).</span></span>

<span data-ttu-id="fca8a-126">Еще один модуль HTTP для важных [ `UrlAuthorizationModule` ](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx), который вызывается в ответ на [ `AuthorizeRequest` событий](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx) (что происходит после `AuthenticateRequest` событий).</span><span class="sxs-lookup"><span data-stu-id="fca8a-126">Another important HTTP Module is the [`UrlAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx), which is raised in response to the [`AuthorizeRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx) (which happens after the `AuthenticateRequest` event).</span></span> <span data-ttu-id="fca8a-127">`UrlAuthorizationModule` Проверяет разметку настройки в `Web.config` для определения, имеет ли удостоверение текущего центра, чтобы перейти на указанную страницу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-127">The `UrlAuthorizationModule` examines configuration markup in `Web.config` to determine whether the current identity has authority to visit the specified page.</span></span> <span data-ttu-id="fca8a-128">Этот процесс называется *Авторизация URL-адреса*.</span><span class="sxs-lookup"><span data-stu-id="fca8a-128">This process is referred to as *URL authorization*.</span></span>

<span data-ttu-id="fca8a-129">Будет рассмотрен синтаксис для правила авторизации URL-адреса на шаге 1, но сначала давайте рассмотрим `UrlAuthorizationModule` в зависимости от того, авторизован ли запрос или нет.</span><span class="sxs-lookup"><span data-stu-id="fca8a-129">We'll examine the syntax for the URL authorization rules in Step 1, but first let's look at what the `UrlAuthorizationModule` does depending on whether the request is authorized or not.</span></span> <span data-ttu-id="fca8a-130">Если `UrlAuthorizationModule` определяет, что запрос авторизуется, то он не выполняет никаких действий и запроса продолжается в течение его жизненного цикла.</span><span class="sxs-lookup"><span data-stu-id="fca8a-130">If the `UrlAuthorizationModule` determines that the request is authorized, then it does nothing, and the request continues through its lifecycle.</span></span> <span data-ttu-id="fca8a-131">Тем не менее если запрос является *не* авторизован, то `UrlAuthorizationModule` прерывает жизненный цикл и указывает, что `Response` возвращаемого объекта [HTTP 401 несанкционированный](http://www.checkupdown.com/status/E401.html) состояния.</span><span class="sxs-lookup"><span data-stu-id="fca8a-131">However, if the request is *not* authorized, then the `UrlAuthorizationModule` aborts the lifecycle and instructs the `Response` object to return an [HTTP 401 Unauthorized](http://www.checkupdown.com/status/E401.html) status.</span></span> <span data-ttu-id="fca8a-132">При использовании проверки подлинности форм это состояние HTTP 401 никогда не возвращается клиенту, поскольку если `FormsAuthenticationModule` обнаруживает HTTP 401, находится в состоянии изменяет его, чтобы [перенаправления HTTP 302](http://www.checkupdown.com/status/E302.html) на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-132">When using forms authentication this HTTP 401 status is never returned to the client because if the `FormsAuthenticationModule` detects an HTTP 401 status is modifies it to an [HTTP 302 Redirect](http://www.checkupdown.com/status/E302.html) to the login page.</span></span>

<span data-ttu-id="fca8a-133">Рис. 1 показан рабочий процесс конвейера ASP.NET, `FormsAuthenticationModule`и `UrlAuthorizationModule` прибытии неавторизованный запрос.</span><span class="sxs-lookup"><span data-stu-id="fca8a-133">Figure 1 illustrates the workflow of the ASP.NET pipeline, the `FormsAuthenticationModule`, and the `UrlAuthorizationModule` when an unauthorized request arrives.</span></span> <span data-ttu-id="fca8a-134">В частности, на рис. 1 показан запрос для анонимных посетителем `ProtectedPage.aspx`, который является страницей, которое запрещает доступ анонимным пользователям.</span><span class="sxs-lookup"><span data-stu-id="fca8a-134">In particular, Figure 1 shows a request by an anonymous visitor for `ProtectedPage.aspx`, which is a page that denies access to anonymous users.</span></span> <span data-ttu-id="fca8a-135">Так как пользователь является анонимным, `UrlAuthorizationModule` прерывает запрос и возвращает состояние HTTP 401 несанкционированный.</span><span class="sxs-lookup"><span data-stu-id="fca8a-135">Since the visitor is anonymous, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="fca8a-136">`FormsAuthenticationModule` Затем преобразует состояния 401 на 302 — перенаправление на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-136">The `FormsAuthenticationModule` then converts the 401 status into a 302 Redirect to login page.</span></span> <span data-ttu-id="fca8a-137">После проверки подлинности пользователя через страницу входа, он перенаправляется `ProtectedPage.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-137">After the user is authenticated via the login page, he is redirected to `ProtectedPage.aspx`.</span></span> <span data-ttu-id="fca8a-138">Это время `FormsAuthenticationModule` идентифицирует пользователя, в зависимости от его билет проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="fca8a-138">This time the `FormsAuthenticationModule` identifies the user based on his authentication ticket.</span></span> <span data-ttu-id="fca8a-139">Теперь, когда пользователь проходит проверку подлинности, `UrlAuthorizationModule` разрешает доступ к странице.</span><span class="sxs-lookup"><span data-stu-id="fca8a-139">Now that the visitor is authenticated, the `UrlAuthorizationModule` permits access to the page.</span></span>

<span data-ttu-id="fca8a-140">[![Проверка подлинности форм и рабочий процесс авторизации URL-адрес](user-based-authorization-cs/_static/image2.png)](user-based-authorization-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-140">[![The Forms Authentication and URL Authorization Workflow](user-based-authorization-cs/_static/image2.png)](user-based-authorization-cs/_static/image1.png)</span></span>

<span data-ttu-id="fca8a-141">**Рис. 1**: Проверка подлинности форм и рабочий процесс авторизации URL-адрес ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-141">**Figure 1**: The Forms Authentication and URL Authorization Workflow  ([Click to view full-size image](user-based-authorization-cs/_static/image3.png))</span></span>

<span data-ttu-id="fca8a-142">Рис. 1 изображена взаимодействие, которое возникает при попытке посетитель анонимный доступ к ресурсу, который недоступен для анонимных пользователей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-142">Figure 1 depicts the interaction that occurs when an anonymous visitor attempts to access a resource that is not available to anonymous users.</span></span> <span data-ttu-id="fca8a-143">В таком случае анонимный пользователь перенаправляется на страницу входа с помощью страницы, на которую она пытается посетить указанный в строке запроса.</span><span class="sxs-lookup"><span data-stu-id="fca8a-143">In such a case, the anonymous visitor is redirected to the login page with the page she attempted to visit specified in the querystring.</span></span> <span data-ttu-id="fca8a-144">Как только пользователь успешно вошел в систему, она автоматически перейдете обратно на ресурс, который она изначально попытке просмотра.</span><span class="sxs-lookup"><span data-stu-id="fca8a-144">Once the user has successfully logged on, she will be automatically redirected back to the resource she was initially attempting to view.</span></span>

<span data-ttu-id="fca8a-145">Неавторизованный запрос, сделанные анонимного пользователя, этот рабочий процесс выполняется просто и легко для посетителя понять, что произошло и почему.</span><span class="sxs-lookup"><span data-stu-id="fca8a-145">When the unauthorized request is made by an anonymous user, this workflow is straightforward and is easy for the visitor to understand what has happened and why.</span></span> <span data-ttu-id="fca8a-146">Но имейте в виду, что `FormsAuthenticationModule` перенаправит *любой* несанкционированный пользователя на страницу входа, даже если запрос выполняется пользователем, прошедшим проверку.</span><span class="sxs-lookup"><span data-stu-id="fca8a-146">But keep in mind that the `FormsAuthenticationModule` will redirect *any* unauthorized user to the login page, even if the request is made by an authenticated user.</span></span> <span data-ttu-id="fca8a-147">Это может привести к путанице при использовании, если прошедший проверку пользователь пытается посетить страницу, для которого она не имеет полномочия.</span><span class="sxs-lookup"><span data-stu-id="fca8a-147">This can result in a confusing user experience if an authenticated user attempts to visit a page for which she lacks authority.</span></span>

<span data-ttu-id="fca8a-148">Представьте, что наш веб-сайт было его правила авторизации URL-адрес, настроенные таким образом, чтобы страницы ASP.NET `OnlyTito.aspx` было accessibly только Tito.</span><span class="sxs-lookup"><span data-stu-id="fca8a-148">Imagine that our website had its URL authorization rules configured such that the ASP.NET page `OnlyTito.aspx` was accessibly only to Tito.</span></span> <span data-ttu-id="fca8a-149">Теперь представим, что Сэм посещает сайт, входе в систему, а затем пытается посетить `OnlyTito.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-149">Now, imagine that Sam visits the site, logs on, and then attempts to visit `OnlyTito.aspx`.</span></span> <span data-ttu-id="fca8a-150">`UrlAuthorizationModule` Halt жизненного цикла запроса и будут возвращены статус HTTP 401 несанкционированный которого `FormsAuthenticationModule` обнаружит и затем перенаправить Sam на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-150">The `UrlAuthorizationModule` will halt the request lifecycle and return an HTTP 401 Unauthorized status, which the `FormsAuthenticationModule` will detect and then redirect Sam to the login page.</span></span> <span data-ttu-id="fca8a-151">Так как уже зарегистрировал Sam, однако она может возникнуть вопрос, почему она был отправлен обратно на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-151">Since Sam has already logged in, though, she may wonder why she has been sent back to the login page.</span></span> <span data-ttu-id="fca8a-152">Она может причин, что ее учетные данные для входа были потеряны каким-либо образом или что она введены недопустимые учетные данные.</span><span class="sxs-lookup"><span data-stu-id="fca8a-152">She might reason that her login credentials were lost somehow, or that she entered invalid credentials.</span></span> <span data-ttu-id="fca8a-153">Если Sam повторно вводит свои учетные данные со страницы входа она будет войти в систему (повторно) и перенаправляется `OnlyTito.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-153">If Sam reenters her credentials from the login page she will be logged on (again) and redirected to `OnlyTito.aspx`.</span></span> <span data-ttu-id="fca8a-154">`UrlAuthorizationModule` Обнаруживает, что Sam не может посетить эту страницу, и она будет возвращаться на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-154">The `UrlAuthorizationModule` will detect that Sam cannot visit this page and she will be returned to the login page.</span></span>

<span data-ttu-id="fca8a-155">Рис. 2 показан этот рабочий процесс в заблуждение.</span><span class="sxs-lookup"><span data-stu-id="fca8a-155">Figure 2 depicts this confusing workflow.</span></span>

<span data-ttu-id="fca8a-156">[![Рабочий процесс по умолчанию может привести к путанице цикла](user-based-authorization-cs/_static/image5.png)](user-based-authorization-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-156">[![The Default Workflow Can Lead to a Confusing Cycle](user-based-authorization-cs/_static/image5.png)](user-based-authorization-cs/_static/image4.png)</span></span>

<span data-ttu-id="fca8a-157">**Рис. 2**: По умолчанию рабочий процесс может привести к цикл толку ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-157">**Figure 2**: The Default Workflow Can Lead to a Confusing Cycle  ([Click to view full-size image](user-based-authorization-cs/_static/image6.png))</span></span>

<span data-ttu-id="fca8a-158">Рабочий процесс показан на рис. 2 можно быстро befuddle даже большинство компьютера грамотный посетителя.</span><span class="sxs-lookup"><span data-stu-id="fca8a-158">The workflow illustrated in Figure 2 can quickly befuddle even the most computer savvy visitor.</span></span> <span data-ttu-id="fca8a-159">Мы рассмотрим способы предотвращения этого толку цикла на шаге 2.</span><span class="sxs-lookup"><span data-stu-id="fca8a-159">We will look at ways to prevent this confusing cycle in Step 2.</span></span>

> [!NOTE]
> <span data-ttu-id="fca8a-160">ASP.NET использует два механизма для определения ли текущий пользователь может получить доступ к определенной веб-страницы: Авторизация URL-адреса и авторизация файлов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-160">ASP.NET uses two mechanisms to determine whether the current user can access a particular web page: URL authorization and file authorization.</span></span> <span data-ttu-id="fca8a-161">Авторизация файлов реализуется [ `FileAuthorizationModule` ](https://msdn.microsoft.com/library/system.web.security.fileauthorizationmodule.aspx), определяющий центр по журналу запрошенного файлы списки управления доступом.</span><span class="sxs-lookup"><span data-stu-id="fca8a-161">File authorization is implemented by the [`FileAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.fileauthorizationmodule.aspx), which determines authority by consulting the requested file(s) ACLs.</span></span> <span data-ttu-id="fca8a-162">Авторизация файлов чаще всего используется с проверкой подлинности Windows, так как списки управления доступом, разрешения, которые применяются к учетным записям Windows.</span><span class="sxs-lookup"><span data-stu-id="fca8a-162">File authorization is most commonly used with Windows authentication because ACLs are permissions that apply to Windows accounts.</span></span> <span data-ttu-id="fca8a-163">При использовании проверки подлинности форм, системного уровня операционной системы и файл все запросы выполняются с той же учетной записи Windows, независимо от того, пользователь, посещения веб-узла.</span><span class="sxs-lookup"><span data-stu-id="fca8a-163">When using forms authentication, all operating system- and file system-level requests are executed by the same Windows account, regardless of the user visiting the site.</span></span> <span data-ttu-id="fca8a-164">Так как в этой серии руководств акцент сделан на проверку подлинности форм, мы не рассмотрим файл авторизации.</span><span class="sxs-lookup"><span data-stu-id="fca8a-164">Since this tutorial series focuses on forms authentication, we will not be discussing file authorization.</span></span>

### <a name="the-scope-of-url-authorization"></a><span data-ttu-id="fca8a-165">Область авторизации URL-адрес</span><span class="sxs-lookup"><span data-stu-id="fca8a-165">The Scope of URL Authorization</span></span>

<span data-ttu-id="fca8a-166">`UrlAuthorizationModule` — Управляемый код, который является частью среды выполнения ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="fca8a-166">The `UrlAuthorizationModule` is managed code that is part of the ASP.NET runtime.</span></span> <span data-ttu-id="fca8a-167">До выхода версии 7 компании Microsoft [Internet Information Services (IIS)](https://www.iis.net/) веб-сервере произошла distinct барьера между конвейер HTTP в IIS и среда выполнения ASP.NET конвейера.</span><span class="sxs-lookup"><span data-stu-id="fca8a-167">Prior to version 7 of Microsoft's [Internet Information Services (IIS)](https://www.iis.net/) web server, there was a distinct barrier between IIS's HTTP pipeline and the ASP.NET runtime's pipeline.</span></span> <span data-ttu-id="fca8a-168">Иными словами, в IIS 6 и более ранних версиях ASP. NET `UrlAuthorizationModule` выполняется, только если запрос делегируется среды выполнения ASP.NET с IIS.</span><span class="sxs-lookup"><span data-stu-id="fca8a-168">In short, in IIS 6 and earlier, ASP.NET's `UrlAuthorizationModule` only executes when a request is delegated from IIS to the ASP.NET runtime.</span></span> <span data-ttu-id="fca8a-169">По умолчанию IIS обрабатывает статического содержимого, — например страниц HTML и CSS, JavaScript и файлы изображений — и только передает запросы в среду выполнения ASP.NET, когда страница с расширением `.aspx`, `.asmx`, или `.ashx` запрашивается.</span><span class="sxs-lookup"><span data-stu-id="fca8a-169">By default, IIS processes static content itself - like HTML pages and CSS, JavaScript, and image files - and only hands off requests to the ASP.NET runtime when a page with an extension of `.aspx`, `.asmx`, or `.ashx` is requested.</span></span>

<span data-ttu-id="fca8a-170">IIS 7, однако позволяет для интеграции IIS и ASP.NET конвейеров.</span><span class="sxs-lookup"><span data-stu-id="fca8a-170">IIS 7, however, allows for integrated IIS and ASP.NET pipelines.</span></span> <span data-ttu-id="fca8a-171">Некоторые параметры конфигурации можно настроить IIS 7 для вызова `UrlAuthorizationModule` для *все* запросов, это означает, что можно определить правила авторизации URL-адрес для файлов любого типа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-171">With a few configuration settings you can setup IIS 7 to invoke the `UrlAuthorizationModule` for *all* requests, meaning that URL authorization rules can be defined for files of any type.</span></span> <span data-ttu-id="fca8a-172">Кроме того IIS 7 включает в себя механизмом авторизации URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="fca8a-172">Additionally, IIS 7 includes its own URL authorization engine.</span></span> <span data-ttu-id="fca8a-173">Дополнительные сведения об интеграции ASP.NET и IIS 7 собственные функции авторизации URL-адрес, см. в разделе [Авторизация URL-адреса IIS7 понимание](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization).</span><span class="sxs-lookup"><span data-stu-id="fca8a-173">For more information on ASP.NET integration and IIS 7's native URL authorization functionality, see [Understanding IIS7 URL Authorization](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization).</span></span> <span data-ttu-id="fca8a-174">Для более подробно рассмотрим интеграции ASP.NET и IIS 7 взять копию книги Shahram Khosravi *Professional IIS 7 и ASP.NET интегрированной Programming* (ISBN: 978-0470152539).</span><span class="sxs-lookup"><span data-stu-id="fca8a-174">For a more in-depth look at ASP.NET and IIS 7 integration, pick up a copy of Shahram Khosravi's book, *Professional IIS 7 and ASP.NET Integrated Programming* (ISBN: 978-0470152539).</span></span>

<span data-ttu-id="fca8a-175">По сути в версиях, предшествующих IIS 7, правила авторизации URL-адреса применяются только к ресурсам, которые обрабатываются средой выполнения ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="fca8a-175">In a nutshell, in versions prior to IIS 7, URL authorization rules are only applied to resources handled by the ASP.NET runtime.</span></span> <span data-ttu-id="fca8a-176">Но со службами IIS 7 можно использовать на собственный URL-адрес авторизации службы IIS или интегрировать ASP. NET `UrlAuthorizationModule` в конвейер HTTP в IIS, тем самым расширяя эта функция ко всем запросам.</span><span class="sxs-lookup"><span data-stu-id="fca8a-176">But with IIS 7 it is possible to use IIS's native URL authorization feature or to integrate ASP.NET's `UrlAuthorizationModule` into IIS's HTTP pipeline, thereby extending this functionality to all requests.</span></span>

> [!NOTE]
> <span data-ttu-id="fca8a-177">Есть некоторые небольшие, но важных различия в том, как ASP. NET `UrlAuthorizationModule` и IIS 7 URL-адрес авторизации обрабатывать правила авторизации.</span><span class="sxs-lookup"><span data-stu-id="fca8a-177">There are some subtle yet important differences in how ASP.NET's `UrlAuthorizationModule` and IIS 7's URL authorization feature process the authorization rules.</span></span> <span data-ttu-id="fca8a-178">Этот учебник не проверяет функциональность авторизации URL-адреса IIS 7 или различия в анализе правила авторизации, по сравнению с `UrlAuthorizationModule`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-178">This tutorial does not examine IIS 7's URL authorization functionality or the differences in how it parses authorization rules compared to the `UrlAuthorizationModule`.</span></span> <span data-ttu-id="fca8a-179">Дополнительные сведения об этих темах см. в документации IIS 7 на MSDN или в [www.iis.net](https://www.iis.net/).</span><span class="sxs-lookup"><span data-stu-id="fca8a-179">For more information on these topics, refer to the IIS 7 documentation on MSDN or at [www.iis.net](https://www.iis.net/).</span></span>

## <a name="step-1-defining-url-authorization-rules-inwebconfig"></a><span data-ttu-id="fca8a-180">Шаг 1. Определение правил авторизации URL-адрес в`Web.config`</span><span class="sxs-lookup"><span data-stu-id="fca8a-180">Step 1: Defining URL Authorization Rules in`Web.config`</span></span>

<span data-ttu-id="fca8a-181">`UrlAuthorizationModule` Определяет, следует ли предоставить или запретить доступ к ресурсу для конкретное удостоверение на основе правил авторизации URL-адреса, определенные в конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="fca8a-181">The `UrlAuthorizationModule` determines whether to grant or deny access to a requested resource for a particular identity based on the URL authorization rules defined in the application's configuration.</span></span> <span data-ttu-id="fca8a-182">Правила авторизации выраженная в [ `<authorization>` элемент](https://msdn.microsoft.com/library/8d82143t.aspx) в виде `<allow>` и `<deny>` дочерних элементов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-182">The authorization rules are spelled out in the [`<authorization>` element](https://msdn.microsoft.com/library/8d82143t.aspx) in the form of `<allow>` and `<deny>` child elements.</span></span> <span data-ttu-id="fca8a-183">Каждый `<allow>` и `<deny>` можно указать дочерний элемент:</span><span class="sxs-lookup"><span data-stu-id="fca8a-183">Each `<allow>` and `<deny>` child element can specify:</span></span>

- <span data-ttu-id="fca8a-184">Конкретного пользователя</span><span class="sxs-lookup"><span data-stu-id="fca8a-184">A particular user</span></span>
- <span data-ttu-id="fca8a-185">Разделенный запятыми список пользователей</span><span class="sxs-lookup"><span data-stu-id="fca8a-185">A comma-delimited list of users</span></span>
- <span data-ttu-id="fca8a-186">Все анонимные пользователи, обозначенное с помощью знак вопроса (?)</span><span class="sxs-lookup"><span data-stu-id="fca8a-186">All anonymous users, denoted by a question mark (?)</span></span>
- <span data-ttu-id="fca8a-187">Все пользователи, обозначенное с помощью звездочки (\*)</span><span class="sxs-lookup"><span data-stu-id="fca8a-187">All users, denoted by an asterisk (\*)</span></span>

<span data-ttu-id="fca8a-188">Следующую разметку показаны способы использования правил авторизации URL-адрес, чтобы разрешить пользователям Tito и Скотт и запретить все остальные.</span><span class="sxs-lookup"><span data-stu-id="fca8a-188">The following markup illustrates how to use the URL authorization rules to allow users Tito and Scott and deny all others:</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample1.xml)]

<span data-ttu-id="fca8a-189">`<allow>` Элемент определяет, какие пользователи могут - Tito и Скотт - хотя `<deny>` указывает элемент, который *все* пользователям запрещен.</span><span class="sxs-lookup"><span data-stu-id="fca8a-189">The `<allow>` element defines what users are permitted - Tito and Scott - while the `<deny>` element instructs that *all* users are denied.</span></span>

> [!NOTE]
> <span data-ttu-id="fca8a-190">`<allow>` И `<deny>` элементы также можно указать правила авторизации для ролей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-190">The `<allow>` and `<deny>` elements can also specify authorization rules for roles.</span></span> <span data-ttu-id="fca8a-191">Мы рассмотрим авторизации на основе ролей в следующем учебном курсе.</span><span class="sxs-lookup"><span data-stu-id="fca8a-191">We will examine role-based authorization in a future tutorial.</span></span>

<span data-ttu-id="fca8a-192">Следующий параметр предоставляет доступ для всех, кроме Sam (включая анонимным посетителям):</span><span class="sxs-lookup"><span data-stu-id="fca8a-192">The following setting grants access to anyone other than Sam (including anonymous visitors):</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample2.xml)]

<span data-ttu-id="fca8a-193">Чтобы разрешить только пользователям, прошедшим проверку подлинности, используйте следующую конфигурацию, которое запрещает доступ для всех анонимных пользователей:</span><span class="sxs-lookup"><span data-stu-id="fca8a-193">To allow only authenticated users, use the following configuration, which denies access to all anonymous users:</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample3.xml)]

<span data-ttu-id="fca8a-194">Правила авторизации определяются в `<system.web>` элемент в `Web.config` и применяются ко всем ресурсам ASP.NET в веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="fca8a-194">The authorization rules are defined within the `<system.web>` element in `Web.config` and apply to all of the ASP.NET resources in the web application.</span></span> <span data-ttu-id="fca8a-195">Очень часто приложение имеет различные правила авторизации в разных разделах.</span><span class="sxs-lookup"><span data-stu-id="fca8a-195">Oftentimes, an application has different authorization rules for different sections.</span></span> <span data-ttu-id="fca8a-196">Например на сайте электронной коммерции, все посетители могут высматривать продукты, см. в разделе обзоров продуктов, поиск в каталоге и так далее.</span><span class="sxs-lookup"><span data-stu-id="fca8a-196">For example, at an eCommerce site, all visitors may peruse the products, see product reviews, search the catalog, and so on.</span></span> <span data-ttu-id="fca8a-197">Тем не менее только пользователи, прошедшие проверку подлинности может достигать извлечение или оно страниц для управления истории доставки единицы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-197">However, only authenticated users may reach the checkout or the pages to manage one's shipping history.</span></span> <span data-ttu-id="fca8a-198">Кроме того может быть частями узла, доступными только выберите пользователей, например Администраторы веб-сайтов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-198">Moreover, there may be portions of the site that are only accessible by select users, such as site administrators.</span></span>

<span data-ttu-id="fca8a-199">ASP.NET позволяет легко определить различные правила авторизации для разных файлов и папок на сайте.</span><span class="sxs-lookup"><span data-stu-id="fca8a-199">ASP.NET makes it easy to define different authorization rules for different files and folders in the site.</span></span> <span data-ttu-id="fca8a-200">Правила авторизации, указанный в корневой папке `Web.config` файла применяются ко всем ресурсам ASP.NET на сайте.</span><span class="sxs-lookup"><span data-stu-id="fca8a-200">The authorization rules specified in the root folder's `Web.config` file apply to all ASP.NET resources in the site.</span></span> <span data-ttu-id="fca8a-201">Тем не менее, эти параметры авторизации по умолчанию могут переопределяться для конкретной папки, добавив `Web.config` с `<authorization>` раздел.</span><span class="sxs-lookup"><span data-stu-id="fca8a-201">However, these default authorization settings can be overridden for a particular folder by adding a `Web.config` with an `<authorization>` section.</span></span>

<span data-ttu-id="fca8a-202">Давайте обновим наш веб-сайт, чтобы только прошедшие проверку подлинности пользователи смогут посещать страницы ASP.NET в `Membership` папку.</span><span class="sxs-lookup"><span data-stu-id="fca8a-202">Let's update our website so that only authenticated users can visit the ASP.NET pages in the `Membership` folder.</span></span> <span data-ttu-id="fca8a-203">Для этого нам нужно добавить `Web.config` файл `Membership` папки и задать его параметры авторизации, чтобы запретить анонимным пользователям.</span><span class="sxs-lookup"><span data-stu-id="fca8a-203">To accomplish this we need to add a `Web.config` file to the `Membership` folder and set its authorization settings to deny anonymous users.</span></span> <span data-ttu-id="fca8a-204">Щелкните правой кнопкой мыши `Membership` папку в обозревателе решений, выберите меню «Добавление нового элемента» в контекстном меню и добавьте новый файл веб-конфигурации с именем `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-204">Right-click the `Membership` folder in the Solution Explorer, choose the Add New Item menu from the context menu, and add a new Web Configuration File named `Web.config`.</span></span>

<span data-ttu-id="fca8a-205">[![Добавьте файл Web.config в папку членства](user-based-authorization-cs/_static/image8.png)](user-based-authorization-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-205">[![Add a Web.config File to the Membership Folder](user-based-authorization-cs/_static/image8.png)](user-based-authorization-cs/_static/image7.png)</span></span>

<span data-ttu-id="fca8a-206">**Рис. 3**: Добавить `Web.config` файл `Membership` папку ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-206">**Figure 3**: Add a `Web.config` File to the `Membership` Folder  ([Click to view full-size image](user-based-authorization-cs/_static/image9.png))</span></span>

<span data-ttu-id="fca8a-207">На этом этапе проект должен содержать два `Web.config` файлов: один в корневом каталоге, а другой в `Membership` папку.</span><span class="sxs-lookup"><span data-stu-id="fca8a-207">At this point your project should contain two `Web.config` files: one in the root directory and one in the `Membership` folder.</span></span>

<span data-ttu-id="fca8a-208">[![Приложение теперь должно содержать два файла Web.config](user-based-authorization-cs/_static/image11.png)](user-based-authorization-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-208">[![Your Application Should Now Contain Two Web.config Files](user-based-authorization-cs/_static/image11.png)](user-based-authorization-cs/_static/image10.png)</span></span>

<span data-ttu-id="fca8a-209">**Рис. 4**: Ваши приложения должны теперь содержат два `Web.config` файлов ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-209">**Figure 4**: Your Application Should Now Contain Two `Web.config` Files  ([Click to view full-size image](user-based-authorization-cs/_static/image12.png))</span></span>

<span data-ttu-id="fca8a-210">Обновите файл конфигурации в `Membership` папку, так что он запрещает доступ анонимным пользователям.</span><span class="sxs-lookup"><span data-stu-id="fca8a-210">Update the configuration file in the `Membership` folder so that it prohibits access to anonymous users.</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample4.xml)]

<span data-ttu-id="fca8a-211">Вот и все!</span><span class="sxs-lookup"><span data-stu-id="fca8a-211">That's all there is to it!</span></span>

<span data-ttu-id="fca8a-212">Чтобы протестировать это изменение, посетите домашнюю страницу в браузере и убедитесь, что вы вошли. Так как приложение ASP.NET по умолчанию — разрешить все посетители, а так как мы не вносить изменения авторизации в корневом каталоге `Web.config` файла, мы открываться файлы в корневом каталоге как посетитель анонимный.</span><span class="sxs-lookup"><span data-stu-id="fca8a-212">To test out this change, visit the homepage in a browser and make sure you are logged out. Since the default behavior of an ASP.NET application is to allow all visitors, and since we didn't make any authorization modifications to the root directory's `Web.config` file, we are able to visit the files in the root directory as an anonymous visitor.</span></span>

<span data-ttu-id="fca8a-213">Щелкните ссылку создания учетных записей пользователей, в левом столбце.</span><span class="sxs-lookup"><span data-stu-id="fca8a-213">Click on the Creating User Accounts link found in the left column.</span></span> <span data-ttu-id="fca8a-214">Это требуется для `~/Membership/CreatingUserAccounts.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-214">This will take you to the `~/Membership/CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="fca8a-215">Так как `Web.config` файл `Membership` папка определяет правила авторизации, чтобы запретить анонимный доступ, `UrlAuthorizationModule` прерывает запрос и возвращает состояние HTTP 401 несанкционированный.</span><span class="sxs-lookup"><span data-stu-id="fca8a-215">Since the `Web.config` file in the `Membership` folder defines authorization rules to prohibit anonymous access, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="fca8a-216">`FormsAuthenticationModule` Изменяет это 302 состояния перенаправления, отправив нам на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-216">The `FormsAuthenticationModule` modifies this to a 302 Redirect status, sending us to the login page.</span></span> <span data-ttu-id="fca8a-217">Обратите внимание на то, что страницы мы предпринималась попытка получить доступ к (`CreatingUserAccounts.aspx`) передается на страницу входа с помощью `ReturnUrl` параметр строки запроса.</span><span class="sxs-lookup"><span data-stu-id="fca8a-217">Note that the page we were attempting to access (`CreatingUserAccounts.aspx`) is passed to the login page via the `ReturnUrl` querystring parameter.</span></span>

<span data-ttu-id="fca8a-218">[![Так как URL-адрес авторизации правила запрещают анонимный доступ мы перенаправляются на страницу входа](user-based-authorization-cs/_static/image14.png)](user-based-authorization-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-218">[![Since the URL Authorization Rules Prohibit Anonymous Access, We are Redirected to the Login Page](user-based-authorization-cs/_static/image14.png)](user-based-authorization-cs/_static/image13.png)</span></span>

<span data-ttu-id="fca8a-219">**Рис. 5**: Так как URL-адрес авторизации правила запрещают анонимный доступ, мы перенаправляются на страницу входа ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-219">**Figure 5**: Since the URL Authorization Rules Prohibit Anonymous Access, We are Redirected to the Login Page  ([Click to view full-size image](user-based-authorization-cs/_static/image15.png))</span></span>

<span data-ttu-id="fca8a-220">После завершения входа в систему, то будут перенаправлены в `CreatingUserAccounts.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-220">Upon successfully logging in, we are redirected to the `CreatingUserAccounts.aspx` page.</span></span> <span data-ttu-id="fca8a-221">Это время `UrlAuthorizationModule` разрешает доступ к странице, так как мы больше не являются анонимными.</span><span class="sxs-lookup"><span data-stu-id="fca8a-221">This time the `UrlAuthorizationModule` permits access to the page because we are no longer anonymous.</span></span>

### <a name="applying-url-authorization-rules-to-a-specific-location"></a><span data-ttu-id="fca8a-222">Применение правил авторизации URL-адрес в определенном местоположении</span><span class="sxs-lookup"><span data-stu-id="fca8a-222">Applying URL Authorization Rules to a Specific Location</span></span>

<span data-ttu-id="fca8a-223">Параметры авторизации, определенные в `<system.web>` раздел `Web.config` применяются ко всем ресурсам в этом каталоге и его подкаталогах ASP.NET (до переопределений на другое `Web.config` файла).</span><span class="sxs-lookup"><span data-stu-id="fca8a-223">The authorization settings defined in the `<system.web>` section of `Web.config` apply to all of the ASP.NET resources in that directory and its subdirectories (until otherwise overridden by another `Web.config` file).</span></span> <span data-ttu-id="fca8a-224">В некоторых случаях, мы может понадобиться все ресурсы ASP.NET в указанном каталоге для конкретной конфигурации авторизации за исключением одного или двух определенных страниц.</span><span class="sxs-lookup"><span data-stu-id="fca8a-224">In some cases, though, we may want all ASP.NET resources in a given directory to have a particular authorization configuration except for one or two specific pages.</span></span> <span data-ttu-id="fca8a-225">Это можно сделать, добавив `<location>` элемент `Web.config`, его на файл, с которых правила авторизации, отличаются и определения его правила авторизации, уникальный в этой последовательности.</span><span class="sxs-lookup"><span data-stu-id="fca8a-225">This can be achieved by adding a `<location>` element in `Web.config`, pointing it to the file whose authorization rules differ, and defining its unique authorization rules therein.</span></span>

<span data-ttu-id="fca8a-226">Чтобы проиллюстрировать использование `<location>` элемент, чтобы переопределить параметры конфигурации для определенного ресурса, давайте настроим параметры авторизации, чтобы только Tito можно посетить `CreatingUserAccounts.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-226">To illustrate using the `<location>` element to override the configuration settings for a specific resource, let's customize the authorization settings so that only Tito can visit `CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="fca8a-227">Для этого добавьте `<location>` элемент `Membership` папки `Web.config` файла и обновить свою разметку, чтобы он выглядел следующим образом:</span><span class="sxs-lookup"><span data-stu-id="fca8a-227">To accomplish this, add a `<location>` element to the `Membership` folder's `Web.config` file and update its markup so that it looks like the following:</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample5.xml)]

<span data-ttu-id="fca8a-228">`<authorization>` Элемент в `<system.web>` определяет правила авторизации URL-адрес по умолчанию для ресурсов ASP.NET в `Membership` папках и подпапках.</span><span class="sxs-lookup"><span data-stu-id="fca8a-228">The `<authorization>` element in `<system.web>` defines the default URL authorization rules for ASP.NET resources in the `Membership` folder and its subfolders.</span></span> <span data-ttu-id="fca8a-229">`<location>` Элемент позволяет переопределить эти правила для конкретного ресурса.</span><span class="sxs-lookup"><span data-stu-id="fca8a-229">The `<location>` element allows us to override these rules for a particular resource.</span></span> <span data-ttu-id="fca8a-230">В разметке выше `<location>` ссылок на элементы `CreatingUserAccounts.aspx` странице и указывает его авторизации правила, например, разрешить Tito, но запретить его всем остальным.</span><span class="sxs-lookup"><span data-stu-id="fca8a-230">In the above markup the `<location>` element references the `CreatingUserAccounts.aspx` page and specifies its authorization rules such as to allow Tito, but deny everyone else.</span></span>

<span data-ttu-id="fca8a-231">Чтобы протестировать это изменение авторизации, сначала посетить веб-сайт как анонимный пользователь.</span><span class="sxs-lookup"><span data-stu-id="fca8a-231">To test out this authorization change, start by visiting the website as an anonymous user.</span></span> <span data-ttu-id="fca8a-232">Если вы попытаетесь перейти к любой странице `Membership` папки, такие как `UserBasedAuthorization.aspx`, `UrlAuthorizationModule` должны отклоняться и вы будете перенаправлены на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-232">If you attempt to visit any page in the `Membership` folder, such as `UserBasedAuthorization.aspx`, the `UrlAuthorizationModule` will deny the request and you will be redirected to the login page.</span></span> <span data-ttu-id="fca8a-233">После входа в систему как, скажем, Скотт, вы можете посетить любой страницы `Membership` папку *за исключением* для `CreatingUserAccounts.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-233">After logging in as, say, Scott, you can visit any page in the `Membership` folder *except* for `CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="fca8a-234">При попытке посетить `CreatingUserAccounts.aspx` войти в систему как любой пользователь, но Tito приведет к попытке несанкционированного доступа, перенаправление на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-234">Attempting to visit `CreatingUserAccounts.aspx` logged on as anyone but Tito will result in an unauthorized access attempt, redirecting you back to the login page.</span></span>

> [!NOTE]
> <span data-ttu-id="fca8a-235">`<location>` Элемент должен находиться за пределами конфигурации `<system.web>` элемент.</span><span class="sxs-lookup"><span data-stu-id="fca8a-235">The `<location>` element must appear outside of the configuration's `<system.web>` element.</span></span> <span data-ttu-id="fca8a-236">Необходимо использовать отдельный `<location>` элемент для каждого ресурса, параметры авторизации которого требуется переопределить.</span><span class="sxs-lookup"><span data-stu-id="fca8a-236">You need to use a separate `<location>` element for each resource whose authorization settings you want to override.</span></span>

### <a name="a-look-at-how-theurlauthorizationmoduleuses-the-authorization-rules-to-grant-or-deny-access"></a><span data-ttu-id="fca8a-237">Рассмотрим как`UrlAuthorizationModule`использует правила авторизации, чтобы предоставить или запретить доступ</span><span class="sxs-lookup"><span data-stu-id="fca8a-237">A Look at How the`UrlAuthorizationModule`Uses the Authorization Rules to Grant or Deny Access</span></span>

<span data-ttu-id="fca8a-238">`UrlAuthorizationModule` Определяет, является ли авторизовать конкретное удостоверение для определенного URL-адреса путем анализа авторизации URL-адрес правила по одному, начиная с первого и продолжает по направлению.</span><span class="sxs-lookup"><span data-stu-id="fca8a-238">The `UrlAuthorizationModule` determines whether to authorize a particular identity for a particular URL by analyzing the URL authorization rules one at a time, starting from the first one and working its way down.</span></span> <span data-ttu-id="fca8a-239">Как только соответствие найдено, пользователь будет разрешен или запрещен доступ, в зависимости от того, если соответствие найдено в `<allow>` или `<deny>` элемент.</span><span class="sxs-lookup"><span data-stu-id="fca8a-239">As soon as a match is found, the user is granted or denied access, depending on if the match was found in an `<allow>` or `<deny>` element.</span></span> <span data-ttu-id="fca8a-240"><strong>Если совпадений не найдено, пользователю предоставляется доступ.</strong></span><span class="sxs-lookup"><span data-stu-id="fca8a-240"><strong>If no match is found, the user is granted access.</strong></span></span> <span data-ttu-id="fca8a-241">Следовательно, если вы хотите ограничить доступ, важно использовать `<deny>` элемент как последний элемент в конфигурации авторизации URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="fca8a-241">Consequently, if you want to restrict access, it is imperative that you use a `<deny>` element as the last element in the URL authorization configuration.</span></span> <span data-ttu-id="fca8a-242"><strong>Если опустить</strong><strong>`<deny>`</strong><strong>элемент, всем пользователям будет предоставлен доступ.</strong></span><span class="sxs-lookup"><span data-stu-id="fca8a-242"><strong>If you omit a</strong><strong>`<deny>`</strong><strong>element, all users will be granted access.</strong></span></span>

<span data-ttu-id="fca8a-243">Чтобы лучше понять процесс, при котором `UrlAuthorizationModule` для определения центра, рассмотрим пример правила авторизации URL-адрес, мы рассмотрели ранее на этом шаге.</span><span class="sxs-lookup"><span data-stu-id="fca8a-243">To better understand the process used by the `UrlAuthorizationModule` to determine authority, consider the example URL authorization rules we looked at earlier in this step.</span></span> <span data-ttu-id="fca8a-244">Первое правило заключается в `<allow>` элемент, который разрешает доступ к Tito и Скотт.</span><span class="sxs-lookup"><span data-stu-id="fca8a-244">The first rule is an `<allow>` element that allows access to Tito and Scott.</span></span> <span data-ttu-id="fca8a-245">Второй правила имеет `<deny>` элемент, который запрещает доступ всем пользователям.</span><span class="sxs-lookup"><span data-stu-id="fca8a-245">The second rules is a `<deny>` element that denies access to everyone.</span></span> <span data-ttu-id="fca8a-246">Если анонимный пользователь посещает, `UrlAuthorizationModule` начинается с запросом, является анонимным Скотт или Tito?</span><span class="sxs-lookup"><span data-stu-id="fca8a-246">If an anonymous user visits, the `UrlAuthorizationModule` starts by asking, Is anonymous either Scott or Tito?</span></span> <span data-ttu-id="fca8a-247">Ответ, очевидно, что — нет, поэтому он переходит к второе правило.</span><span class="sxs-lookup"><span data-stu-id="fca8a-247">The answer, obviously, is No, so it proceeds to the second rule.</span></span> <span data-ttu-id="fca8a-248">Является анонимным, вошедших в набор всех пользователей?</span><span class="sxs-lookup"><span data-stu-id="fca8a-248">Is anonymous in the set of everybody?</span></span> <span data-ttu-id="fca8a-249">Так как ответ вот Да, `<deny>` правило помещается в силе и пользователь перенаправляется на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-249">Since the answer here is Yes, the `<deny>` rule is put in effect and the visitor is redirected to the login page.</span></span> <span data-ttu-id="fca8a-250">Аналогичным образом, если Цзисунь посещает, `UrlAuthorizationModule` начинается с запросом, является Цзисунь Скотт или Tito?</span><span class="sxs-lookup"><span data-stu-id="fca8a-250">Similarly, if Jisun is visiting, the `UrlAuthorizationModule` starts by asking, Is Jisun either Scott or Tito?</span></span> <span data-ttu-id="fca8a-251">Так как она не, `UrlAuthorizationModule` переходит на второй вопрос — Цзисунь вошедших в набор всех пользователей?</span><span class="sxs-lookup"><span data-stu-id="fca8a-251">Since she is not, the `UrlAuthorizationModule` proceeds to the second question, Is Jisun in the set of everybody?</span></span> <span data-ttu-id="fca8a-252">Она является, поэтому ему, кроме того, запрещается доступ.</span><span class="sxs-lookup"><span data-stu-id="fca8a-252">She is, so she, too, is denied access.</span></span> <span data-ttu-id="fca8a-253">Наконец, если посещает Tito, первый вопрос, исходящих от `UrlAuthorizationModule` будет получен утвердительный ответ, поэтому Tito предоставляется доступ.</span><span class="sxs-lookup"><span data-stu-id="fca8a-253">Finally, if Tito visits, the first question posed by the `UrlAuthorizationModule` is an affirmative answer, so Tito is granted access.</span></span>

<span data-ttu-id="fca8a-254">Так как `UrlAuthorizationModule` процессы, правила авторизации сверху вниз, остановка в любые совпадения, важно иметь более конкретные правила располагаются перед менее конкретными.</span><span class="sxs-lookup"><span data-stu-id="fca8a-254">Since the `UrlAuthorizationModule` processes the authorization rules from the top down, stopping at any match, it is important to have the more specific rules come before the less specific ones.</span></span> <span data-ttu-id="fca8a-255">Т. е для определения правил авторизации, запрещать Цзисунь и анонимных пользователей, но все остальные пользователи прошедшего проверку подлинности, будет начинаться с - один Цзисунь повлиять на работу — самое подходящее правило и перейдите к менее конкретные правила — те, что все остальные Прошедшие проверку, но Запрет всех анонимных пользователей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-255">That is, to define authorization rules that forbid Jisun and anonymous users, but allow all other authenticated users, you would start with the most specific rule - the one impacting Jisun - and then proceed to the less specific rules - those allowing all other authenticated users, but denying all anonymous users.</span></span> <span data-ttu-id="fca8a-256">Следующие правила авторизации URL-адрес реализует эту политику, сначала отказа Цзисунь и затем отзывать их по любому анонимному пользователю.</span><span class="sxs-lookup"><span data-stu-id="fca8a-256">The following URL authorization rules implements this policy by first denying Jisun, and then denying any anonymous user.</span></span> <span data-ttu-id="fca8a-257">Все прошедшие проверку подлинности пользователя, отличного от Цзисунь будет предоставлен доступ так как ни одно из этих `<deny>` будет соответствовать инструкций.</span><span class="sxs-lookup"><span data-stu-id="fca8a-257">Any authenticated user other than Jisun will be granted access because neither of these `<deny>` statements will match.</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample6.xml)]

## <a name="step-2-fixing-the-workflow-for-unauthorized-authenticated-users"></a><span data-ttu-id="fca8a-258">Шаг 2. Исправление рабочего процесса для несанкционированного, прошедшего проверку подлинности пользователей</span><span class="sxs-lookup"><span data-stu-id="fca8a-258">Step 2: Fixing the Workflow for Unauthorized, Authenticated Users</span></span>

<span data-ttu-id="fca8a-259">Как уже говорилось ранее в этом учебнике в ищите в разделе рабочий процесс авторизации URL-адрес, в любое время процесс неавторизованный запрос, `UrlAuthorizationModule` прерывает запрос и возвращает состояние HTTP 401 несанкционированный.</span><span class="sxs-lookup"><span data-stu-id="fca8a-259">As we discussed earlier in this tutorial in the A Look at the URL Authorization Workflow section, anytime an unauthorized request transpires, the `UrlAuthorizationModule` aborts the request and returns an HTTP 401 Unauthorized status.</span></span> <span data-ttu-id="fca8a-260">Изменяется после этого состояния 401 `FormsAuthenticationModule` в 302 перенаправления состояние, которое направляет пользователя на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-260">This 401 status is modified by the `FormsAuthenticationModule` into a 302 Redirect status that sends the user to the login page.</span></span> <span data-ttu-id="fca8a-261">Этот рабочий процесс происходит на любой неавторизованный запрос, даже если пользователь прошел проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="fca8a-261">This workflow occurs on any unauthorized request, even if the user is authenticated.</span></span>

<span data-ttu-id="fca8a-262">Возврат на страницу входа пользователя, прошедшего проверку, скорее всего путайте их, так как они уже вошедшие в систему.</span><span class="sxs-lookup"><span data-stu-id="fca8a-262">Returning an authenticated user to the login page is likely to confuse them since they have already logged into the system.</span></span> <span data-ttu-id="fca8a-263">С помощью небольшой работы мы можем улучшить этот рабочий процесс, перенаправляя прошедшего проверку подлинности пользователей, устанавливающих неавторизованные запросы к странице, объясняющее, что они пытались получить доступ к странице с ограниченным доступом.</span><span class="sxs-lookup"><span data-stu-id="fca8a-263">With a little bit of work we can improve this workflow by redirecting authenticated users who make unauthorized requests to a page that explains that they have attempted to access a restricted page.</span></span>

<span data-ttu-id="fca8a-264">Начнем с создания новой страницы ASP.NET в веб-приложения в корневую папку с именем `UnauthorizedAccess.aspx`; не забудьте связать эту страницу с помощью `Site.master` главной страницы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-264">Start by creating a new ASP.NET page in the web application's root folder named `UnauthorizedAccess.aspx`; don't forget to associate this page with the `Site.master` master page.</span></span> <span data-ttu-id="fca8a-265">После создания этой страницы, удалите элемент управления содержимым, который ссылается на `LoginContent` ContentPlaceHolder таким образом, чтобы стандартная содержимого главной страницы будет отображаться.</span><span class="sxs-lookup"><span data-stu-id="fca8a-265">After creating this page, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the master page's default content will be displayed.</span></span> <span data-ttu-id="fca8a-266">Добавьте сообщение, поясняющее ситуации, а именно пользователь попытался получить доступ к защищенному ресурсу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-266">Next, add a message that explains the situation, namely that the user attempted to access a protected resource.</span></span> <span data-ttu-id="fca8a-267">После добавления такого сообщения `UnauthorizedAccess.aspx` декларативная разметка страницы должен выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="fca8a-267">After adding such a message, the `UnauthorizedAccess.aspx` page's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample7.aspx)]

<span data-ttu-id="fca8a-268">Теперь нам нужно изменить рабочий процесс, если неавторизованный запрос выполняется пользователем, прошедшим аутентификацию они отправляются `UnauthorizedAccess.aspx` страницы, а не на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-268">We now need to alter the workflow so that if an unauthorized request is performed by an authenticated user they are sent to the `UnauthorizedAccess.aspx` page instead of the login page.</span></span> <span data-ttu-id="fca8a-269">Логика, которая перенаправляет неавторизованных запросов на страницу входа скрыта в закрытый метод `FormsAuthenticationModule` класса, поэтому это поведение нельзя настроить.</span><span class="sxs-lookup"><span data-stu-id="fca8a-269">The logic that redirects unauthorized requests to the login page is buried within a private method of the `FormsAuthenticationModule` class, so we cannot customize this behavior.</span></span> <span data-ttu-id="fca8a-270">Что мы можем сделать, однако является добавление на страницу входа, который перенаправляет пользователя для нашего собственного логики `UnauthorizedAccess.aspx`, при необходимости.</span><span class="sxs-lookup"><span data-stu-id="fca8a-270">What we can do, however, is add our own logic to the login page that redirects the user to `UnauthorizedAccess.aspx`, if needed.</span></span>

<span data-ttu-id="fca8a-271">Когда `FormsAuthenticationModule` посетитель несанкционированного перенаправляет на страницу входа он добавляет URL-адрес запрошенного, несанкционированного строку запроса с именем `ReturnUrl`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-271">When the `FormsAuthenticationModule` redirects an unauthorized visitor to the login page it appends the requested, unauthorized URL to the querystring with the name `ReturnUrl`.</span></span> <span data-ttu-id="fca8a-272">Например, если неавторизованный пользователь попытался посетите `OnlyTito.aspx`, `FormsAuthenticationModule` перенаправит их `Login.aspx?ReturnUrl=OnlyTito.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-272">For example, if an unauthorized user attempted to visit `OnlyTito.aspx`, the `FormsAuthenticationModule` would redirect them to `Login.aspx?ReturnUrl=OnlyTito.aspx`.</span></span> <span data-ttu-id="fca8a-273">Таким образом по достижении страницы входа пользователем, прошедшим аутентификацию с помощью строки запроса, который включает в себя `ReturnUrl` параметра, а затем мы знаете, что это не прошедший проверку пользователь просто пытался посетите страницу, она не имеет прав на просмотр.</span><span class="sxs-lookup"><span data-stu-id="fca8a-273">Therefore, if the login page is reached by an authenticated user with a querystring that includes the `ReturnUrl` parameter, then we know that this unauthenticated user just attempted to visit a page she is not authorized to view.</span></span> <span data-ttu-id="fca8a-274">В этом случае мы хотим перенаправляет его на `UnauthorizedAccess.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-274">In such a case, we want to redirect her to `UnauthorizedAccess.aspx`.</span></span>

<span data-ttu-id="fca8a-275">Для этого добавьте следующий код на страницу входа `Page_Load` обработчик событий:</span><span class="sxs-lookup"><span data-stu-id="fca8a-275">To accomplish this, add the following code to the login page's `Page_Load` event handler:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample8.cs)]

<span data-ttu-id="fca8a-276">Приведенный выше код перенаправляет прошедшего проверку подлинности, неавторизованных пользователей `UnauthorizedAccess.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-276">The above code redirects authenticated, unauthorized users to the `UnauthorizedAccess.aspx` page.</span></span> <span data-ttu-id="fca8a-277">Чтобы увидеть эту логику в действии, посетите веб-узел как посетитель анонимные и щелкните ссылку "Создание учетных записей пользователей" в левом столбце.</span><span class="sxs-lookup"><span data-stu-id="fca8a-277">To see this logic in action, visit the site as an anonymous visitor and click on the Creating User Accounts link in the left column.</span></span> <span data-ttu-id="fca8a-278">Это требуется для `~/Membership/CreatingUserAccounts.aspx` страницы, что на шаге 1, мы настроили только разрешить доступ к Tito.</span><span class="sxs-lookup"><span data-stu-id="fca8a-278">This will take you to the `~/Membership/CreatingUserAccounts.aspx` page, which in Step 1 we configured to only permit access to Tito.</span></span> <span data-ttu-id="fca8a-279">Поскольку анонимные пользователи будут запрещены, `FormsAuthenticationModule` перенаправляет нам обратно на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-279">Since anonymous users are prohibited, the `FormsAuthenticationModule` redirects us back to the login page.</span></span>

<span data-ttu-id="fca8a-280">На этом этапе мы являются анонимными, поэтому `Request.IsAuthenticated` возвращает `false` мы не направляются `UnauthorizedAccess.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-280">At this point we are anonymous, so `Request.IsAuthenticated` returns `false` and we are not redirected to `UnauthorizedAccess.aspx`.</span></span> <span data-ttu-id="fca8a-281">Вместо этого отображается на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-281">Instead, the login page is displayed.</span></span> <span data-ttu-id="fca8a-282">Войдите в качестве пользователя, отличного от Tito, например Брюс.</span><span class="sxs-lookup"><span data-stu-id="fca8a-282">Log in as a user other than Tito, such as Bruce.</span></span> <span data-ttu-id="fca8a-283">После ввода правильных учетных данных, страницы входа передает нам обратно `~/Membership/CreatingUserAccounts.aspx`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-283">After entering the appropriate credentials, the login page redirects us back to `~/Membership/CreatingUserAccounts.aspx`.</span></span> <span data-ttu-id="fca8a-284">Тем не менее так как эта страница доступна только для Tito, мы нет доступа для ее просмотра и немедленно возвращаются на страницу входа.</span><span class="sxs-lookup"><span data-stu-id="fca8a-284">However, since this page is only accessible to Tito, we are unauthorized to view it and are promptly returned to the login page.</span></span> <span data-ttu-id="fca8a-285">Однако на этот раз `Request.IsAuthenticated` возвращает `true` (и `ReturnUrl` существует параметр строки запроса), поэтому мы перенаправляются `UnauthorizedAccess.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-285">This time, however, `Request.IsAuthenticated` returns `true` (and the `ReturnUrl` querystring parameter exists), so we are redirected to the `UnauthorizedAccess.aspx` page.</span></span>

<span data-ttu-id="fca8a-286">[![Проверку подлинности, неавторизованные пользователи перенаправляются на UnauthorizedAccess.aspx](user-based-authorization-cs/_static/image17.png)](user-based-authorization-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-286">[![Authenticated, Unauthorized Users are Redirected to UnauthorizedAccess.aspx](user-based-authorization-cs/_static/image17.png)](user-based-authorization-cs/_static/image16.png)</span></span>

<span data-ttu-id="fca8a-287">**Рис. 6**: Проверку подлинности, неавторизованные пользователи перенаправляются `UnauthorizedAccess.aspx` ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-287">**Figure 6**: Authenticated, Unauthorized Users are Redirected to `UnauthorizedAccess.aspx` ([Click to view full-size image](user-based-authorization-cs/_static/image18.png))</span></span>

<span data-ttu-id="fca8a-288">Этот настраиваемый рабочий процесс возвращает в пользовательском интерфейсе более продуманной и простую замыкание цикла, изображенный на рис. 2.</span><span class="sxs-lookup"><span data-stu-id="fca8a-288">This customized workflow presents a more sensible and straightforward user experience by short circuiting the cycle depicted in Figure 2.</span></span>

## <a name="step-3-limiting-functionality-based-on-the-currently-logged-in-user"></a><span data-ttu-id="fca8a-289">Шаг 3. Ограничение функций зависимости от выполнившего вход пользователя</span><span class="sxs-lookup"><span data-stu-id="fca8a-289">Step 3: Limiting Functionality Based on the Currently Logged In User</span></span>

<span data-ttu-id="fca8a-290">Авторизация URL-адреса позволяет легко указать правила авторизации крупных фрагментов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-290">URL authorization makes it easy to specify coarse authorization rules.</span></span> <span data-ttu-id="fca8a-291">Как мы видели в шаге 1, с URL-адрес авторизации мы можно кратко состояния какие удостоверения разрешены и какие из них запрещен просмотр определенной страницы или все страницы в папке.</span><span class="sxs-lookup"><span data-stu-id="fca8a-291">As we saw in Step 1, with URL authorization we can succinctly state what identities are permitted and which ones are denied from viewing a particular page or all pages in a folder.</span></span> <span data-ttu-id="fca8a-292">В некоторых сценариях тем не менее, мы может потребоваться разрешить всем пользователям посетите страницу, но ограничить функциональные возможности страницы, на основе пользователя, посетив его.</span><span class="sxs-lookup"><span data-stu-id="fca8a-292">In certain scenarios, however, we may want to allow all users to visit a page, but limit the page's functionality based on the user visiting it.</span></span>

<span data-ttu-id="fca8a-293">Рассмотрим случай использования на веб-сайте электронной коммерции, который допускает прошедшего проверку подлинности просмотрите свои продукты.</span><span class="sxs-lookup"><span data-stu-id="fca8a-293">Consider the case of an eCommerce website that allows authenticated visitors to review their products.</span></span> <span data-ttu-id="fca8a-294">Когда анонимный пользователь посещает страницу продукта, они увидят только сведения о продукте и не будет дано возможность оставить отзыв.</span><span class="sxs-lookup"><span data-stu-id="fca8a-294">When an anonymous user visits a product's page, they would see just the product information and would not be given the opportunity to leave a review.</span></span> <span data-ttu-id="fca8a-295">Тем не менее прошедший проверку пользователь посещения этой же странице отображался рецензирования интерфейс.</span><span class="sxs-lookup"><span data-stu-id="fca8a-295">However, an authenticated user visiting the same page would see the reviewing interface.</span></span> <span data-ttu-id="fca8a-296">Если еще прошедшего проверку подлинности пользователя не были проверены этот продукт, интерфейс позволила бы им для отправки рецензии; в противном случае он будет отображать их проверку отправленного ранее.</span><span class="sxs-lookup"><span data-stu-id="fca8a-296">If the authenticated user had not yet reviewed this product, the interface would enable them to submit a review; otherwise it would show them their previously-submitted review.</span></span> <span data-ttu-id="fca8a-297">Кроме того, чтобы сделать этот сценарий шаг на странице продукта может просмотреть дополнительные сведения и предлагают расширенные возможности для тех пользователей, которые работают на компанию электронной коммерции.</span><span class="sxs-lookup"><span data-stu-id="fca8a-297">To take this scenario a step further, the product page might show additional information and offer extended features for those users that work for the eCommerce company.</span></span> <span data-ttu-id="fca8a-298">Например на странице продукта может списке запасов на складе и включают в себя параметры для изменения цены продукта и описание при посещении сотрудником.</span><span class="sxs-lookup"><span data-stu-id="fca8a-298">For example, the product page might list the inventory in stock and include options to edit the product's price and description when visited by an employee.</span></span>

<span data-ttu-id="fca8a-299">Можно реализовать таких правил авторизации высокогранулированных декларативно или программно (или через сочетание двух).</span><span class="sxs-lookup"><span data-stu-id="fca8a-299">Such fine grain authorization rules can be implemented either declaratively or programmatically (or through some combination of the two).</span></span> <span data-ttu-id="fca8a-300">В следующем разделе вы узнаете, как реализовать высокогранулированных авторизацию с помощью элемента управления LoginView.</span><span class="sxs-lookup"><span data-stu-id="fca8a-300">In the next section we will see how to implement fine grain authorization via the LoginView control.</span></span> <span data-ttu-id="fca8a-301">После этого мы изучим программные методы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-301">Following that, we will explore programmatic techniques.</span></span> <span data-ttu-id="fca8a-302">Прежде чем мы рассмотрим применение правил авторизации реализуя более точное, тем не менее, необходимо сначала создать, функциональность которого зависит от пользователя, посетив его страницу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-302">Before we can look at applying fine grain authorization rules, however, we first need to create a page whose functionality depends on the user visiting it.</span></span>

<span data-ttu-id="fca8a-303">Давайте создадим страницу, которая перечисляет файлы из определенного каталога в элементе управления GridView.</span><span class="sxs-lookup"><span data-stu-id="fca8a-303">Let's create a page that lists the files in a particular directory within a GridView.</span></span> <span data-ttu-id="fca8a-304">А также список имя каждого файла, размер и другие сведения, GridView будет содержать два столбца из элементов управления LinkButton: один под названием представления и один названием Delete.</span><span class="sxs-lookup"><span data-stu-id="fca8a-304">Along with listing each file's name, size, and other information, the GridView will include two columns of LinkButtons: one titled View and one titled Delete.</span></span> <span data-ttu-id="fca8a-305">При щелчке мышью элемента управления LinkButton представление, будет отображаться содержимое выбранного файла; При щелчке мышью элемента управления LinkButton удаление, файл будет удален.</span><span class="sxs-lookup"><span data-stu-id="fca8a-305">If the View LinkButton is clicked, the contents of the selected file will be displayed; if the Delete LinkButton is clicked, the file will be deleted.</span></span> <span data-ttu-id="fca8a-306">Давайте первоначально создать эту страницу, таким образом, что его представление и delete функциональность доступна всем пользователям.</span><span class="sxs-lookup"><span data-stu-id="fca8a-306">Let's initially create this page such that its view and delete functionality is available to all users.</span></span> <span data-ttu-id="fca8a-307">В рамках элемента управления LoginView и программным образом ограничивая функциональные возможности разделы, будет показано, как включить или отключить эти функции, в зависимости от пользователя, посещающего страницу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-307">In the Using the LoginView Control and Programmatically Limiting Functionality sections we will see how to enable or disable these features based on the user visiting the page.</span></span>

> [!NOTE]
> <span data-ttu-id="fca8a-308">Мы должны создавать страницы ASP.NET использует элемент управления GridView для отображения списка файлов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-308">The ASP.NET page we are about to build uses a GridView control to display a list of files.</span></span> <span data-ttu-id="fca8a-309">Так как в этом учебном курсе посвящены форм проверки подлинности, авторизации, учетные записи пользователей и ролей я не хочу тратить слишком много времени на обсуждение внутренней работы элемента управления GridView.</span><span class="sxs-lookup"><span data-stu-id="fca8a-309">Since this tutorial series focuses on forms authentication, authorization, user accounts, and roles, I do not want to spend too much time discussing the inner workings of the GridView control.</span></span> <span data-ttu-id="fca8a-310">Хотя этот учебник конкретных пошаговые инструкции по настройке этой страницы, он не подробно рассмотрены почему были внесены те или иные, или у определенных свойств эффекта в выводимых данных.</span><span class="sxs-lookup"><span data-stu-id="fca8a-310">While this tutorial provides specific step-by-step instructions for setting up this page, it does not delve into the details of why certain choices were made, or what effect particular properties have on the rendered output.</span></span> <span data-ttu-id="fca8a-311">Полное тестирование элемента управления GridView, см. Мой *[работа с данными в ASP.NET 2.0](../../data-access/index.md)* серии руководств.</span><span class="sxs-lookup"><span data-stu-id="fca8a-311">For a thorough examination of the GridView control, consult my *[Working with Data in ASP.NET 2.0](../../data-access/index.md)* tutorial series.</span></span>

<span data-ttu-id="fca8a-312">Сначала откройте `UserBasedAuthorization.aspx` файл `Membership` папки и добавление элемента управления GridView на страницу с именем `FilesGrid`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-312">Start by opening the `UserBasedAuthorization.aspx` file in the `Membership` folder and adding a GridView control to the page named `FilesGrid`.</span></span> <span data-ttu-id="fca8a-313">Смарт-теге элемента GridView щелкните ссылку Изменить столбцы, чтобы запустить диалоговое окно "поля".</span><span class="sxs-lookup"><span data-stu-id="fca8a-313">From the GridView's Smart Tag, click the Edit Columns link to launch the Fields dialog box.</span></span> <span data-ttu-id="fca8a-314">На этой странице снимите флажок поля автоматически создавать в левом нижнем углу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-314">From here, uncheck the Auto-generate fields checkbox in the lower left corner.</span></span> <span data-ttu-id="fca8a-315">Добавьте кнопки "выбрать", кнопку «Удалить» и два поля BoundField, кроме из верхнего левого угла (кнопки Select и Delete можно найти в поле CommandField тип).</span><span class="sxs-lookup"><span data-stu-id="fca8a-315">Next, add a Select button, a Delete button, and two BoundFields from the upper left corner (the Select and Delete buttons can be found under the CommandField type).</span></span> <span data-ttu-id="fca8a-316">Задайте кнопки Select `SelectText` свойства для просмотра и первый BoundField `HeaderText` и `DataField` свойства к имени.</span><span class="sxs-lookup"><span data-stu-id="fca8a-316">Set the Select button's `SelectText` property to View and the first BoundField's `HeaderText` and `DataField` properties to Name.</span></span> <span data-ttu-id="fca8a-317">Установите второй BoundField `HeaderText` свойства размер в байтах, его `DataField` свойство до длины, его `DataFormatString` свойства {0:N0} и его `HtmlEncode` значение False.</span><span class="sxs-lookup"><span data-stu-id="fca8a-317">Set the second BoundField's `HeaderText` property to Size in Bytes, its `DataField` property to Length, its `DataFormatString` property to {0:N0} and its `HtmlEncode` property to False.</span></span>

<span data-ttu-id="fca8a-318">После настройки столбцов GridView, нажмите кнопку ОК, чтобы закрыть диалоговое окно "поля".</span><span class="sxs-lookup"><span data-stu-id="fca8a-318">After configuring the GridView's columns, click OK to close the Fields dialog box.</span></span> <span data-ttu-id="fca8a-319">В окне «Свойства» задайте GridView `DataKeyNames` свойства `FullName`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-319">From the Properties window, set the GridView's `DataKeyNames` property to `FullName`.</span></span> <span data-ttu-id="fca8a-320">На этом этапе декларативная разметка GridView должен выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="fca8a-320">At this point the GridView's declarative markup should look like the following:</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample9.aspx)]

<span data-ttu-id="fca8a-321">С помощью разметки, созданной для элемента GridView мы готовы написать код, который извлечет файлы из определенного каталога и привязывать их к GridView.</span><span class="sxs-lookup"><span data-stu-id="fca8a-321">With the GridView's markup created, we're ready to write the code that will retrieve the files in a particular directory and bind them to the GridView.</span></span> <span data-ttu-id="fca8a-322">Добавьте следующий код на страницу `Page_Load` обработчик событий:</span><span class="sxs-lookup"><span data-stu-id="fca8a-322">Add the following code to the page's `Page_Load` event handler:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample10.cs)]

<span data-ttu-id="fca8a-323">Приведенный выше код использует [ `DirectoryInfo` класс](https://msdn.microsoft.com/library/system.io.directoryinfo.aspx) для получения списка файлов в корневой папке приложения.</span><span class="sxs-lookup"><span data-stu-id="fca8a-323">The above code uses the [`DirectoryInfo` class](https://msdn.microsoft.com/library/system.io.directoryinfo.aspx) to obtain a list of the files in the application's root folder.</span></span> <span data-ttu-id="fca8a-324">[ `GetFiles()` Метод](https://msdn.microsoft.com/library/system.io.directoryinfo.getfiles.aspx) возвращает все файлы в каталоге как массив [ `FileInfo` объектов](https://msdn.microsoft.com/library/system.io.fileinfo.aspx), который затем привязывается к GridView.</span><span class="sxs-lookup"><span data-stu-id="fca8a-324">The [`GetFiles()` method](https://msdn.microsoft.com/library/system.io.directoryinfo.getfiles.aspx) returns all of the files in the directory as an array of [`FileInfo` objects](https://msdn.microsoft.com/library/system.io.fileinfo.aspx), which is then bound to the GridView.</span></span> <span data-ttu-id="fca8a-325">`FileInfo` Объект имеет целый ряд свойств, таких как `Name`, `Length`, и `IsReadOnly`, среди прочего.</span><span class="sxs-lookup"><span data-stu-id="fca8a-325">The `FileInfo` object has an assortment of properties, such as `Name`, `Length`, and `IsReadOnly`, among others.</span></span> <span data-ttu-id="fca8a-326">Как видно из его декларативная разметка GridView выведет на экран только `Name` и `Length` свойства.</span><span class="sxs-lookup"><span data-stu-id="fca8a-326">As you can see from its declarative markup, the GridView displays just the `Name` and `Length` properties.</span></span>

> [!NOTE]
> <span data-ttu-id="fca8a-327">`DirectoryInfo` И `FileInfo` классы находятся в [ `System.IO` пространства имен](https://msdn.microsoft.com/library/system.io.aspx).</span><span class="sxs-lookup"><span data-stu-id="fca8a-327">The `DirectoryInfo` and `FileInfo` classes are found in the [`System.IO` namespace](https://msdn.microsoft.com/library/system.io.aspx).</span></span> <span data-ttu-id="fca8a-328">Таким образом, потребуются либо имена этих классов с их имен пространств имен в начале или пространство имен, импортируемое в файл класса (через `using System.IO`).</span><span class="sxs-lookup"><span data-stu-id="fca8a-328">Therefore, you will either need to preface these class names with their namespace names or have the namespace imported into the class file (via `using System.IO`).</span></span>

<span data-ttu-id="fca8a-329">Отвлекитесь на эту страницу через обозреватель.</span><span class="sxs-lookup"><span data-stu-id="fca8a-329">Take a moment to visit this page through a browser.</span></span> <span data-ttu-id="fca8a-330">Появится список файлов, находящихся в корневом каталоге приложения.</span><span class="sxs-lookup"><span data-stu-id="fca8a-330">It will display the list of files residing in the application's root directory.</span></span> <span data-ttu-id="fca8a-331">Щелкнув любой представления или удаления элементов управления LinkButton приведет к обратной передачи, но вмешательство произойдет в том случае, так как еще не создать необходимые обработчики событий.</span><span class="sxs-lookup"><span data-stu-id="fca8a-331">Clicking any of the View or Delete LinkButtons will cause a postback, but no action will occur because we've yet to create the necessary event handlers.</span></span>

<span data-ttu-id="fca8a-332">[![GridView Перечисляет файлы в корневом каталоге веб-приложения](user-based-authorization-cs/_static/image20.png)](user-based-authorization-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-332">[![The GridView Lists the Files in the Web Application's Root Directory](user-based-authorization-cs/_static/image20.png)](user-based-authorization-cs/_static/image19.png)</span></span>

<span data-ttu-id="fca8a-333">**Рис. 7**: GridView Перечисляет файлы в корневом каталоге веб-приложения ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-333">**Figure 7**: The GridView Lists the Files in the Web Application's Root Directory  ([Click to view full-size image](user-based-authorization-cs/_static/image21.png))</span></span>

<span data-ttu-id="fca8a-334">Нам нужен способ отображения содержимого выбранного файла.</span><span class="sxs-lookup"><span data-stu-id="fca8a-334">We need a means to display the contents of the selected file.</span></span> <span data-ttu-id="fca8a-335">Вернитесь в Visual Studio и текстовое поле с именем `FileContents` над элементом управления GridView.</span><span class="sxs-lookup"><span data-stu-id="fca8a-335">Return to Visual Studio and add a TextBox named `FileContents` above the GridView.</span></span> <span data-ttu-id="fca8a-336">Задайте его `TextMode` свойства `MultiLine` и его `Columns` и `Rows` свойства до 95% и 10 соответственно.</span><span class="sxs-lookup"><span data-stu-id="fca8a-336">Set its `TextMode` property to `MultiLine` and its `Columns` and `Rows` properties to 95% and 10, respectively.</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample11.aspx)]

<span data-ttu-id="fca8a-337">Создайте обработчик событий для элемента GridView [ `SelectedIndexChanged` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.selectedindexchanged.aspx) и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="fca8a-337">Next, create an event handler for the GridView's [`SelectedIndexChanged` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.selectedindexchanged.aspx) and add the following code:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample12.cs)]

<span data-ttu-id="fca8a-338">Этот код использует GridView `SelectedValue` свойства, чтобы определить полное имя выбранного файла.</span><span class="sxs-lookup"><span data-stu-id="fca8a-338">This code uses the GridView's `SelectedValue` property to determine the full file name of the selected file.</span></span> <span data-ttu-id="fca8a-339">На внутреннем уровне `DataKeys` Коллекция указывается для получения `SelectedValue`, поэтому крайне важно установить GridView `DataKeyNames` свойство с именем, как описано ранее в этом шаге.</span><span class="sxs-lookup"><span data-stu-id="fca8a-339">Internally, the `DataKeys` collection is referenced in order to obtain the `SelectedValue`, so it is imperative that you set the GridView's `DataKeyNames` property to Name, as described earlier in this step.</span></span> <span data-ttu-id="fca8a-340">[ `File` Класс](https://msdn.microsoft.com/library/system.io.file.aspx) используется для считывания содержимое выбранного файла в строку, которая затем присваивается `FileContents` текстового поля `Text` свойство, поэтому отображается содержимое файла, выбранного на странице.</span><span class="sxs-lookup"><span data-stu-id="fca8a-340">The [`File` class](https://msdn.microsoft.com/library/system.io.file.aspx) is used to read the selected file's contents into a string, which is then assigned to the `FileContents` TextBox's `Text` property, thereby displaying the contents of the selected file on the page.</span></span>

<span data-ttu-id="fca8a-341">[![Содержимое выбранного файла отображаются в текстовом поле](user-based-authorization-cs/_static/image23.png)](user-based-authorization-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-341">[![The Selected File's Contents are Displayed in the TextBox](user-based-authorization-cs/_static/image23.png)](user-based-authorization-cs/_static/image22.png)</span></span>

<span data-ttu-id="fca8a-342">**Рис. 8**: Содержимое выбранного файла отображаются в текстовом поле ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-342">**Figure 8**: The Selected File's Contents are Displayed in the TextBox  ([Click to view full-size image](user-based-authorization-cs/_static/image24.png))</span></span>

> [!NOTE]
> <span data-ttu-id="fca8a-343">Если просмотреть содержимое файла, содержащего разметку HTML и затем попытаться просмотреть или удалить файл, вы получите `HttpRequestValidationException` ошибки.</span><span class="sxs-lookup"><span data-stu-id="fca8a-343">If you view the contents of a file that contains HTML markup, and then attempt to view or delete a file, you will receive an `HttpRequestValidationException` error.</span></span> <span data-ttu-id="fca8a-344">Это происходит, поскольку при обратной передаче содержимое текстового поля отправляются обратно в веб-сервера.</span><span class="sxs-lookup"><span data-stu-id="fca8a-344">This occurs because on postback the TextBox's contents are sent back to the web server.</span></span> <span data-ttu-id="fca8a-345">По умолчанию ASP.NET вызывает `HttpRequestValidationException` ошибка при обнаружении потенциально опасных обратной передачи содержимого, такого как HTML-разметка.</span><span class="sxs-lookup"><span data-stu-id="fca8a-345">By default, ASP.NET raises an `HttpRequestValidationException` error whenever potentially dangerous postback content, such as HTML markup, is detected.</span></span> <span data-ttu-id="fca8a-346">Чтобы отключить Эта ошибка возникнет, отключить проверку запроса для страницы, добавив `ValidateRequest="false"` для `@Page` директива.</span><span class="sxs-lookup"><span data-stu-id="fca8a-346">To disable this error from occurring, turn off request validation for the page by adding `ValidateRequest="false"` to the `@Page` directive.</span></span> <span data-ttu-id="fca8a-347">Дополнительные сведения о преимуществах проверку запроса, что также какие действия следует предпринять при отключении, чтение [проверка запросов — предотвращение атак скрипт](https://asp.net/learn/whitepapers/request-validation/).</span><span class="sxs-lookup"><span data-stu-id="fca8a-347">For more information on the benefits of request validation as well as what precautions you should take when disabling it, read [Request Validation - Preventing Script Attacks](https://asp.net/learn/whitepapers/request-validation/).</span></span>

<span data-ttu-id="fca8a-348">Наконец, добавьте обработчик событий следующим кодом для элемента GridView [ `RowDeleting` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleting.aspx):</span><span class="sxs-lookup"><span data-stu-id="fca8a-348">Finally, add an event handler with the following code for the GridView's [`RowDeleting` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleting.aspx):</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample13.cs)]

<span data-ttu-id="fca8a-349">Код просто отображает полное имя файла для удаления в `FileContents` TextBox *без* фактического удаления файла.</span><span class="sxs-lookup"><span data-stu-id="fca8a-349">The code simply displays the full name of the file to delete in the `FileContents` TextBox *without* actually deleting the file.</span></span>

<span data-ttu-id="fca8a-350">[![Нажатие кнопки удаления файл не удаляется фактически](user-based-authorization-cs/_static/image26.png)](user-based-authorization-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-350">[![Clicking the Delete Button Does Not Actually Delete the File](user-based-authorization-cs/_static/image26.png)](user-based-authorization-cs/_static/image25.png)</span></span>

<span data-ttu-id="fca8a-351">**Рис. 9**: Нажав кнопку Delete кнопки не фактически удаляет файл ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-351">**Figure 9**: Clicking the Delete Button Does Not Actually Delete the File  ([Click to view full-size image](user-based-authorization-cs/_static/image27.png))</span></span>

<span data-ttu-id="fca8a-352">На шаге 1, мы настроили правила авторизации URL-адрес, чтобы запретить анонимным пользователям просмотр страниц в `Membership` папку.</span><span class="sxs-lookup"><span data-stu-id="fca8a-352">In Step 1 we configured the URL authorization rules to prohibit anonymous users from viewing the pages in the `Membership` folder.</span></span> <span data-ttu-id="fca8a-353">Чтобы лучше демонстрировать высокогранулированных проверки подлинности, разрешите возможность посещения анонимным пользователям `UserBasedAuthorization.aspx` страницы, но с ограниченной функциональностью.</span><span class="sxs-lookup"><span data-stu-id="fca8a-353">In order to better exhibit fine grain authentication, let's allow anonymous users to visit the `UserBasedAuthorization.aspx` page, but with limited functionality.</span></span> <span data-ttu-id="fca8a-354">Чтобы открыть эту страницу, всем пользователям доступ к которым, добавьте следующий `<location>` элемент `Web.config` файл `Membership` папку:</span><span class="sxs-lookup"><span data-stu-id="fca8a-354">To open this page up to be accessed by all users, add the following `<location>` element to the `Web.config` file in the `Membership` folder:</span></span>

[!code-xml[Main](user-based-authorization-cs/samples/sample14.xml)]

<span data-ttu-id="fca8a-355">После добавления этого `<location>` элемент, тестирования новых правил авторизации URL-адрес войти из узла.</span><span class="sxs-lookup"><span data-stu-id="fca8a-355">After adding this `<location>` element, test the new URL authorization rules by logging out of the site.</span></span> <span data-ttu-id="fca8a-356">Как анонимный пользователь должен быть разрешен посетить `UserBasedAuthorization.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-356">As an anonymous user you should be permitted to visit the `UserBasedAuthorization.aspx` page.</span></span>

<span data-ttu-id="fca8a-357">В настоящее время можно посетить любого пользователя, прошедшего проверку подлинности или анонимные `UserBasedAuthorization.aspx` странице, чтобы просмотреть или удалить файлы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-357">Currently, any authenticated or anonymous user can visit the `UserBasedAuthorization.aspx` page and view or delete files.</span></span> <span data-ttu-id="fca8a-358">Давайте превратим его, чтобы только прошедшие проверку подлинности пользователи могут просматривать содержимое файла и только Tito можно удалить файл.</span><span class="sxs-lookup"><span data-stu-id="fca8a-358">Let's make it so that only authenticated users can view contents of a file and only Tito can delete a file.</span></span> <span data-ttu-id="fca8a-359">Таких правил авторизации высокогранулированных может применяться декларативно, программно или через сочетание обоих методов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-359">Such fine grain authorization rules can be applied declaratively, programmatically, or through a combination of both methods.</span></span> <span data-ttu-id="fca8a-360">Давайте использовать декларативный подход для ограничения, кто может просматривать содержимое файла; Мы будем использовать программный подход для ограничения доступа можно удалить файл.</span><span class="sxs-lookup"><span data-stu-id="fca8a-360">Let's use the declarative approach to limit who can view the contents of a file; we'll use the programmatic approach to limit who can delete a file.</span></span>

### <a name="using-the-loginview-control"></a><span data-ttu-id="fca8a-361">С помощью элемента управления LoginView</span><span class="sxs-lookup"><span data-stu-id="fca8a-361">Using the LoginView Control</span></span>

<span data-ttu-id="fca8a-362">Как мы видели в предыдущих учебных курсах, элемент управления LoginView может использоваться для отображения разных интерфейсов для прошедшего проверку подлинности и анонимных пользователей и предлагает простой способ скрыть функциональные возможности, недоступной для анонимных пользователей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-362">As we've seen in past tutorials, the LoginView control is useful for displaying different interfaces for authenticated and anonymous users, and offers an easy way to hide functionality that is not accessible to anonymous users.</span></span> <span data-ttu-id="fca8a-363">Поскольку анонимные пользователи не может просмотреть или удалить файлы, мы должны только Показывать `FileContents` текстового поля при просмотре пользователем, прошедшим проверку.</span><span class="sxs-lookup"><span data-stu-id="fca8a-363">Since anonymous users cannot view or delete files, we only need to show the `FileContents` TextBox when the page is visited by an authenticated user.</span></span> <span data-ttu-id="fca8a-364">Для этого добавьте на страницу элемент управления LoginView, назовите его `LoginViewForFileContentsTextBox`и переместите `FileContents` декларативная разметка текстового поля в элемент управления LoginView `LoggedInTemplate`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-364">To achieve this, add a LoginView control to the page, name it `LoginViewForFileContentsTextBox`, and move the `FileContents` TextBox's declarative markup into the LoginView control's `LoggedInTemplate`.</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample15.aspx)]

<span data-ttu-id="fca8a-365">Веб-элементы управления в шаблонах LoginView больше не доступны непосредственно из кода класса.</span><span class="sxs-lookup"><span data-stu-id="fca8a-365">The Web controls in the LoginView's templates are no longer directly accessible from the code-behind class.</span></span> <span data-ttu-id="fca8a-366">Например `FilesGrid` GridView `SelectedIndexChanged` и `RowDeleting` данный момент ссылаются на обработчики событий `FileContents` элемент управления TextBox с кодом, такие как:</span><span class="sxs-lookup"><span data-stu-id="fca8a-366">For example, the `FilesGrid` GridView's `SelectedIndexChanged` and `RowDeleting` event handlers currently reference the `FileContents` TextBox control with code like:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample16.cs)]

<span data-ttu-id="fca8a-367">Тем не менее этот код больше не является допустимым.</span><span class="sxs-lookup"><span data-stu-id="fca8a-367">However, this code is no longer valid.</span></span> <span data-ttu-id="fca8a-368">Путем перемещения `FileContents` текстовое поле в `LoggedInTemplate` текстового поля невозможно открыть напрямую.</span><span class="sxs-lookup"><span data-stu-id="fca8a-368">By moving the `FileContents` TextBox into the `LoggedInTemplate` the TextBox cannot be directly accessed.</span></span> <span data-ttu-id="fca8a-369">Вместо этого мы используем `FindControl("controlId")` способ создавать программную ссылку на элемент управления.</span><span class="sxs-lookup"><span data-stu-id="fca8a-369">Instead, we must use the `FindControl("controlId")` method to programmatically reference the control.</span></span> <span data-ttu-id="fca8a-370">Обновление `FilesGrid` обработчики событий для ссылки на текстовое поле следующим образом:</span><span class="sxs-lookup"><span data-stu-id="fca8a-370">Update the `FilesGrid` event handlers to reference the TextBox like so:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample17.cs)]

<span data-ttu-id="fca8a-371">После перемещения текстового поля в LoginView `LoggedInTemplate` и обновление страницы кода для ссылки на текстовое поле с помощью `FindControl("controlId")` шаблонов, посетите страницу как анонимный пользователь.</span><span class="sxs-lookup"><span data-stu-id="fca8a-371">After moving the TextBox to the LoginView's `LoggedInTemplate` and updating the page's code to reference the TextBox using the `FindControl("controlId")` pattern, visit the page as an anonymous user.</span></span> <span data-ttu-id="fca8a-372">Как показано на рис. 10, `FileContents` текстовое поле не отображается.</span><span class="sxs-lookup"><span data-stu-id="fca8a-372">As Figure 10 shows, the `FileContents` TextBox is not displayed.</span></span> <span data-ttu-id="fca8a-373">Тем не менее по-прежнему отображается представление элемента управления LinkButton.</span><span class="sxs-lookup"><span data-stu-id="fca8a-373">However, the View LinkButton is still displayed.</span></span>

<span data-ttu-id="fca8a-374">[![Элемент управления LoginView только отрисовывает текстовое поле FileContents для прошедших проверку пользователей](user-based-authorization-cs/_static/image29.png)](user-based-authorization-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-374">[![The LoginView Control Only Renders the FileContents TextBox for Authenticated Users](user-based-authorization-cs/_static/image29.png)](user-based-authorization-cs/_static/image28.png)</span></span>

<span data-ttu-id="fca8a-375">**Рис. 10**: Элемент управления LoginView только отображает `FileContents` текстовое поле для Authenticated Users ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-375">**Figure 10**: The LoginView Control Only Renders the `FileContents` TextBox for Authenticated Users  ([Click to view full-size image](user-based-authorization-cs/_static/image30.png))</span></span>

<span data-ttu-id="fca8a-376">Чтобы скрыть кнопки представления для анонимных пользователей рекомендуется преобразовать GridView поле в TemplateField.</span><span class="sxs-lookup"><span data-stu-id="fca8a-376">One way to hide the View button for anonymous users is to convert the GridView field into a TemplateField.</span></span> <span data-ttu-id="fca8a-377">Будет создан шаблон, который содержит декларативная разметка для представления элемента управления LinkButton.</span><span class="sxs-lookup"><span data-stu-id="fca8a-377">This will generate a template that contains the declarative markup for the View LinkButton.</span></span> <span data-ttu-id="fca8a-378">Мы затем добавьте элемент управления LoginView TemplateField и поместите LinkButton в LoginView `LoggedInTemplate`, тем самым скрытие «представление» из анонимных пользователей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-378">We can then add a LoginView control to the TemplateField and place the LinkButton within the LoginView's `LoggedInTemplate`, thereby hiding the View button from anonymous visitors.</span></span> <span data-ttu-id="fca8a-379">Для этого щелкните ссылку Изменить столбцы смарт-теге элемента GridView диалогового окна «поля».</span><span class="sxs-lookup"><span data-stu-id="fca8a-379">To accomplish this, click on the Edit Columns link from the GridView's Smart Tag to launch the Fields dialog box.</span></span> <span data-ttu-id="fca8a-380">Затем выберите кнопки "выбрать" в списке в левом нижнем углу и нажмите кнопку Преобразовать это поле в TemplateField связь.</span><span class="sxs-lookup"><span data-stu-id="fca8a-380">Next, select the Select button from the list in the lower left corner and then click the Convert this field to a TemplateField link.</span></span> <span data-ttu-id="fca8a-381">Это изменит декларативная разметка поля из:</span><span class="sxs-lookup"><span data-stu-id="fca8a-381">Doing so will modify the field's declarative markup from:</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample18.aspx)]

 <span data-ttu-id="fca8a-382">В:</span><span class="sxs-lookup"><span data-stu-id="fca8a-382">To:</span></span> 

[!code-aspx[Main](user-based-authorization-cs/samples/sample19.aspx)]

<span data-ttu-id="fca8a-383">На этом этапе мы можем добавить LoginView TemplateField.</span><span class="sxs-lookup"><span data-stu-id="fca8a-383">At this point, we can add a LoginView to the TemplateField.</span></span> <span data-ttu-id="fca8a-384">Следующая разметка отображает LinkButton представления только для прошедших проверку пользователей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-384">The following markup displays the View LinkButton only for authenticated users.</span></span>

[!code-aspx[Main](user-based-authorization-cs/samples/sample20.aspx)]

<span data-ttu-id="fca8a-385">Как показано на рис. 11, конечный результат не является, что довольно как представление столбцов по-прежнему отображается несмотря на то, что представление элементов управления LinkButton внутри столбца скрыты.</span><span class="sxs-lookup"><span data-stu-id="fca8a-385">As Figure 11 shows, the end result is not that pretty as the View column is still displayed even though the View LinkButtons within the column are hidden.</span></span> <span data-ttu-id="fca8a-386">Как скрыть всего столбца GridView (и не только LinkButton) будут рассмотрены в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="fca8a-386">We will look at how to hide the entire GridView column (and not just the LinkButton) in the next section.</span></span>

<span data-ttu-id="fca8a-387">[![Элемент управления LoginView скрывает представление элементов управления LinkButton для анонимных пользователей](user-based-authorization-cs/_static/image32.png)](user-based-authorization-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-387">[![The LoginView Control Hides the View LinkButtons for Anonymous Visitors](user-based-authorization-cs/_static/image32.png)](user-based-authorization-cs/_static/image31.png)</span></span>

<span data-ttu-id="fca8a-388">**Рис. 11**: Элемент управления LoginView скрывает представление элементов управления LinkButton для анонимных пользователей ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-388">**Figure 11**: The LoginView Control Hides the View LinkButtons for Anonymous Visitors  ([Click to view full-size image](user-based-authorization-cs/_static/image33.png))</span></span>

### <a name="programmatically-limiting-functionality"></a><span data-ttu-id="fca8a-389">Программно ограничение функций</span><span class="sxs-lookup"><span data-stu-id="fca8a-389">Programmatically Limiting Functionality</span></span>

<span data-ttu-id="fca8a-390">В некоторых случаях декларативной методики, недостаточны для ограничение функций на страницу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-390">In some circumstances, declarative techniques are insufficient for limiting functionality to a page.</span></span> <span data-ttu-id="fca8a-391">Например доступность некоторых функций страницы может зависеть критерии за пределы того пользователя, посещающего страницу анонимных или прошедших проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="fca8a-391">For example, the availability of certain page functionality may be dependent on criteria beyond whether the user visiting the page is anonymous or authenticated.</span></span> <span data-ttu-id="fca8a-392">В таких случаях различных элементов пользовательского интерфейса можно отобразить или скрыть через программные средства.</span><span class="sxs-lookup"><span data-stu-id="fca8a-392">In such cases, the various user interface elements can be displayed or hidden through programmatic means.</span></span>

<span data-ttu-id="fca8a-393">Чтобы ограничить функциональные возможности программным образом, нам нужно выполнить две задачи:</span><span class="sxs-lookup"><span data-stu-id="fca8a-393">In order to limit the functionality programmatically, we need to perform two tasks:</span></span>

1. <span data-ttu-id="fca8a-394">Определяют, доступны ли пользователя, посещающего страницу функциональные возможности, и</span><span class="sxs-lookup"><span data-stu-id="fca8a-394">Determine whether the user visiting the page can access the functionality, and</span></span>
2. <span data-ttu-id="fca8a-395">Измените пользовательский интерфейс, в зависимости от того, имеет ли пользователь доступ к функциям в вопросе программным образом.</span><span class="sxs-lookup"><span data-stu-id="fca8a-395">Programmatically modify the user interface based on whether the user has access to the functionality in question.</span></span>

<span data-ttu-id="fca8a-396">Чтобы продемонстрировать применение эти две задачи, давайте разрешают только Tito для удаления файлов из GridView.</span><span class="sxs-lookup"><span data-stu-id="fca8a-396">To demonstrate the application of these two tasks, let's only allow Tito to delete files from the GridView.</span></span> <span data-ttu-id="fca8a-397">Наша первая задача, то для определения, является ли Tito, посетив страницу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-397">Our first task, then, is to determine whether it is Tito visiting the page.</span></span> <span data-ttu-id="fca8a-398">После определения, нам нужно скрыть (или отображение) удалить столбец к GridView.</span><span class="sxs-lookup"><span data-stu-id="fca8a-398">Once that has been determined, we need to hide (or show) the GridView's Delete column.</span></span> <span data-ttu-id="fca8a-399">Столбцы GridView, доступны через его `Columns` свойство; столбец отображается только в том случае, если его `Visible` свойству `true` (по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="fca8a-399">The GridView's columns are accessible through its `Columns` property; a column is only rendered if its `Visible` property is set to `true` (the default).</span></span>

<span data-ttu-id="fca8a-400">Добавьте следующий код, чтобы `Page_Load` обработчик событий до привязка данных к GridView:</span><span class="sxs-lookup"><span data-stu-id="fca8a-400">Add the following code to the `Page_Load` event handler prior to binding the data to the GridView:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample21.cs)]

<span data-ttu-id="fca8a-401">Как уже говорилось в [ *Обзор аутентификации форм* ](../introduction/an-overview-of-forms-authentication-cs.md) руководстве `User.Identity.Name` возвращает имя удостоверения.</span><span class="sxs-lookup"><span data-stu-id="fca8a-401">As we discussed in the [*An Overview of Forms Authentication*](../introduction/an-overview-of-forms-authentication-cs.md) tutorial, `User.Identity.Name` returns the identity's name.</span></span> <span data-ttu-id="fca8a-402">Это соответствует имени пользователя, введенный в элементе управления Login.</span><span class="sxs-lookup"><span data-stu-id="fca8a-402">This corresponds to the username entered in the Login control.</span></span> <span data-ttu-id="fca8a-403">При посещении страницы, второй столбец GridView Tito `Visible` свойству `true`; в противном случае он становится равным `false`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-403">If it is Tito visiting the page, the GridView's second column's `Visible` property is set to `true`; otherwise, it is set to `false`.</span></span> <span data-ttu-id="fca8a-404">Конечным результатом будет то, что если кто-то отличного от Tito посещает страницу, либо другого пользователя, прошедшего проверку подлинности, или анонимного пользователя, удалить столбец не отображается (см. рис. 12); Тем не менее, когда Tito посещает страницу, удалить столбец присутствует (см. рис. 13).</span><span class="sxs-lookup"><span data-stu-id="fca8a-404">The net result is that when someone other than Tito visits the page, either another authenticated user or an anonymous user, the Delete column is not rendered (see Figure 12); however, when Tito visits the page, the Delete column is present (see Figure 13).</span></span>

<span data-ttu-id="fca8a-405">[![Удалить столбец является не отображается при посещен, кто-то отличное от Tito (например, Брюс)](user-based-authorization-cs/_static/image35.png)](user-based-authorization-cs/_static/image34.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-405">[![The Delete Column is Not Rendered When Visited By Someone Other Than Tito (Such as Bruce)](user-based-authorization-cs/_static/image35.png)](user-based-authorization-cs/_static/image34.png)</span></span>

<span data-ttu-id="fca8a-406">**Рис. 12**: Удалить столбец является не отображается при посещен, кто-то отличное от Tito (например, Брюс) ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image36.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-406">**Figure 12**: The Delete Column is Not Rendered When Visited By Someone Other Than Tito (Such as Bruce)  ([Click to view full-size image](user-based-authorization-cs/_static/image36.png))</span></span>

<span data-ttu-id="fca8a-407">[![Удалить столбец отображается для Tito](user-based-authorization-cs/_static/image38.png)](user-based-authorization-cs/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-407">[![The Delete Column is Rendered for Tito](user-based-authorization-cs/_static/image38.png)](user-based-authorization-cs/_static/image37.png)</span></span>

<span data-ttu-id="fca8a-408">**Рис. 13**: Удалить столбец отображается для Tito ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image39.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-408">**Figure 13**: The Delete Column is Rendered for Tito  ([Click to view full-size image](user-based-authorization-cs/_static/image39.png))</span></span>

## <a name="step-4-applying-authorization-rules-to-classes-and-methods"></a><span data-ttu-id="fca8a-409">Шаг 4. Применение правил авторизации для классов и методов</span><span class="sxs-lookup"><span data-stu-id="fca8a-409">Step 4: Applying Authorization Rules to Classes and Methods</span></span>

<span data-ttu-id="fca8a-410">На шаге 3 мы запрещено анонимным пользователям просматривать содержимое файла и права всем пользователям, но Tito удаление файлов.</span><span class="sxs-lookup"><span data-stu-id="fca8a-410">In Step 3 we disallowed anonymous users from viewing a file's contents and prohibited all users but Tito from deleting files.</span></span> <span data-ttu-id="fca8a-411">Это осуществлялось с сокрытие элементов интерфейса пользователя для несанкционированного посетителей через декларативные и программные методы.</span><span class="sxs-lookup"><span data-stu-id="fca8a-411">This was accomplished by hiding the associated user interface elements for unauthorized visitors through declarative and programmatic techniques.</span></span> <span data-ttu-id="fca8a-412">В нашем примере простого правильно скрытие элементов пользовательского интерфейса был простым, но как насчет более сложные сайты которых может быть много различных способов выполнения одинаковой функциональности?</span><span class="sxs-lookup"><span data-stu-id="fca8a-412">For our simple example, properly hiding the user interface elements was straightforward, but what about more complex sites where there may be many different ways to perform the same functionality?</span></span> <span data-ttu-id="fca8a-413">Ограничения эти функции для неавторизованных пользователей, что произойдет, если мы забыли скрыть или отключить все элементы интерфейса пользователя?</span><span class="sxs-lookup"><span data-stu-id="fca8a-413">In limiting that functionality to unauthorized users, what happens if we forget to hide or disable all of the applicable user interface elements?</span></span>

<span data-ttu-id="fca8a-414">Чтобы убедиться, что конкретная часть функциональности может быть недоступна для несанкционированного удобно для оформления этого класса или метода с [ `PrincipalPermission` атрибут](https://msdn.microsoft.com/library/system.security.permissions.principalpermissionattribute.aspx).</span><span class="sxs-lookup"><span data-stu-id="fca8a-414">An easy way to ensure that a particular piece of functionality cannot be accessed by an unauthorized user is to decorate that class or method with the [`PrincipalPermission` attribute](https://msdn.microsoft.com/library/system.security.permissions.principalpermissionattribute.aspx).</span></span> <span data-ttu-id="fca8a-415">Когда среда выполнения .NET используется класс или выполняет одну из его методов, выполняется проверка того, что текущий контекст безопасности имеет разрешение на использование класса или выполнения метода.</span><span class="sxs-lookup"><span data-stu-id="fca8a-415">When the .NET runtime uses a class or executes one of its methods, it checks to ensure that the current security context has permission to use the class or execute the method.</span></span> <span data-ttu-id="fca8a-416">`PrincipalPermission` Атрибут предоставляет механизм, через который можно определить эти правила.</span><span class="sxs-lookup"><span data-stu-id="fca8a-416">The `PrincipalPermission` attribute provides a mechanism through which we can define these rules.</span></span>

<span data-ttu-id="fca8a-417">Давайте демонстрируют использование `PrincipalPermission` атрибут для элемента GridView `SelectedIndexChanged` и `RowDeleting` обработчики событий, чтобы запретить выполнение анонимные пользователи и пользователи, не являющиеся Tito, соответственно.</span><span class="sxs-lookup"><span data-stu-id="fca8a-417">Let's demonstrate using the `PrincipalPermission` attribute on the GridView's `SelectedIndexChanged` and `RowDeleting` event handlers to prohibit execution by anonymous users and users other than Tito, respectively.</span></span> <span data-ttu-id="fca8a-418">Нам нужно сделать всего лишь добавить соответствующий атрибут поверх каждое определение функции:</span><span class="sxs-lookup"><span data-stu-id="fca8a-418">All we need to do is add the appropriate attribute atop each function definition:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample22.cs)]

<span data-ttu-id="fca8a-419">Атрибут для `SelectedIndexChanged` определяет обработчик событий, которые только прошедшие проверку пользователи могут выполнять процедуру обработчика событий, а в атрибуте `RowDeleting` обработчик событий ограничивает к Tito при выполнении.</span><span class="sxs-lookup"><span data-stu-id="fca8a-419">The attribute for the `SelectedIndexChanged` event handler dictates that only authenticated users can execute the event handler, where as the attribute on the `RowDeleting` event handler limits the execution to Tito.</span></span>

<span data-ttu-id="fca8a-420">Если каким-то образом пользователя, отличного от Tito пытается выполнить `RowDeleting` обработчик событий или без проверки подлинности пользователь пытается выполнить `SelectedIndexChanged` обработчик событий, которые будут вызывать среду выполнения .NET `SecurityException`.</span><span class="sxs-lookup"><span data-stu-id="fca8a-420">If, somehow, a user other than Tito attempts to execute the `RowDeleting` event handler or a non-authenticated user attempts to execute the `SelectedIndexChanged` event handler, the .NET runtime will raise a `SecurityException`.</span></span>

<span data-ttu-id="fca8a-421">[![Если контекст безопасности не авторизован для выполнения метода, то выдается SecurityException](user-based-authorization-cs/_static/image41.png)](user-based-authorization-cs/_static/image40.png)</span><span class="sxs-lookup"><span data-stu-id="fca8a-421">[![If the Security Context is not Authorized to Execute the Method, a SecurityException is Thrown](user-based-authorization-cs/_static/image41.png)](user-based-authorization-cs/_static/image40.png)</span></span>

<span data-ttu-id="fca8a-422">**Рис. 14**: Если контекст безопасности не авторизован для выполнения метода, `SecurityException` возникает исключение ([Просмотр полноразмерного изображения](user-based-authorization-cs/_static/image42.png))</span><span class="sxs-lookup"><span data-stu-id="fca8a-422">**Figure 14**: If the Security Context is not Authorized to Execute the Method, a `SecurityException` is Thrown  ([Click to view full-size image](user-based-authorization-cs/_static/image42.png))</span></span>

> [!NOTE]
> <span data-ttu-id="fca8a-423">Чтобы разрешить несколько контекстов безопасности для доступа к класса или метода, снабдить класса или метода с `PrincipalPermission` атрибут для каждого контекста безопасности.</span><span class="sxs-lookup"><span data-stu-id="fca8a-423">To allow multiple security contexts to access a class or method, decorate the class or method with a `PrincipalPermission` attribute for each security context.</span></span> <span data-ttu-id="fca8a-424">То есть Tito и Брюс, для выполнения `RowDeleting` обработчик событий, добавьте *два* `PrincipalPermission` атрибуты:</span><span class="sxs-lookup"><span data-stu-id="fca8a-424">That is, to allow both Tito and Bruce to execute the `RowDeleting` event handler, add *two* `PrincipalPermission` attributes:</span></span>

[!code-csharp[Main](user-based-authorization-cs/samples/sample23.cs)]

<span data-ttu-id="fca8a-425">В дополнение к страницы ASP.NET многие приложения также имеют архитектуру, которая включает в себя различные уровни, такие как бизнес-логики и уровни доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="fca8a-425">In addition to ASP.NET pages, many applications also have an architecture that includes various layers, such as Business Logic and Data Access Layers.</span></span> <span data-ttu-id="fca8a-426">Эти уровни обычно реализуются как библиотеки классов и предоставляют классы и методы для выполнения бизнес-логики и связанные данные функции.</span><span class="sxs-lookup"><span data-stu-id="fca8a-426">These layers are typically implemented as Class Libraries and offer classes and methods for performing business logic- and data-related functionality.</span></span> <span data-ttu-id="fca8a-427">`PrincipalPermission` Атрибут полезен для применения правила авторизации для этих уровней.</span><span class="sxs-lookup"><span data-stu-id="fca8a-427">The `PrincipalPermission` attribute is useful for applying authorization rules to these layers.</span></span>

<span data-ttu-id="fca8a-428">Дополнительные сведения об использовании `PrincipalPermission` атрибут для определения правил авторизации на классы и методы, см. [Скотт Гатри](https://weblogs.asp.net/scottgu/)на запись в блоге [добавления правила авторизации для бизнеса и слои с помощью `PrincipalPermissionAttributes` ](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx).</span><span class="sxs-lookup"><span data-stu-id="fca8a-428">For more information on using the `PrincipalPermission` attribute to define authorization rules on classes and methods, refer to [Scott Guthrie](https://weblogs.asp.net/scottgu/)'s blog entry [Adding Authorization Rules to Business and Data Layers Using `PrincipalPermissionAttributes`](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx).</span></span>

## <a name="summary"></a><span data-ttu-id="fca8a-429">Сводка</span><span class="sxs-lookup"><span data-stu-id="fca8a-429">Summary</span></span>

<span data-ttu-id="fca8a-430">В этом учебнике мы рассмотрели способы применения правил авторизации на основе пользователя.</span><span class="sxs-lookup"><span data-stu-id="fca8a-430">In this tutorial we looked at how to apply user-based authorization rules.</span></span> <span data-ttu-id="fca8a-431">Мы начали с рассмотрения ASP. В .NET framework авторизации URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="fca8a-431">We started with a look at ASP.NET's URL authorization framework.</span></span> <span data-ttu-id="fca8a-432">Для каждого запроса, механизм ASP.NET `UrlAuthorizationModule` проверяет правила авторизации URL-адреса, определенные в конфигурации приложения, чтобы определить, авторизован ли удостоверение для доступа к запрошенному ресурсу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-432">On each request, the ASP.NET engine's `UrlAuthorizationModule` inspects the URL authorization rules defined in the application's configuration to determine whether the identity is authorized to access the requested resource.</span></span> <span data-ttu-id="fca8a-433">Короче говоря Авторизация URL-адреса позволяет легко указать правила авторизации для конкретной страницы или для всех страниц из определенного каталога.</span><span class="sxs-lookup"><span data-stu-id="fca8a-433">In short, URL authorization makes it easy to specify authorization rules for a specific page or for all pages in a particular directory.</span></span>

<span data-ttu-id="fca8a-434">Инфраструктуры авторизации URL-адрес применяет правила авторизации на основе страниц.</span><span class="sxs-lookup"><span data-stu-id="fca8a-434">The URL authorization framework applies authorization rules on a page-by-page basis.</span></span> <span data-ttu-id="fca8a-435">Авторизации URL-адрес запрашивающий удостоверений имеет права для доступа к определенному ресурсу или нет.</span><span class="sxs-lookup"><span data-stu-id="fca8a-435">With URL authorization, either the requesting identity is authorized to access a particular resource or not.</span></span> <span data-ttu-id="fca8a-436">Во многих сценариях, однако, вызвать дополнительные правила авторизации высокогранулированных.</span><span class="sxs-lookup"><span data-stu-id="fca8a-436">Many scenarios, however, call for more fine grain authorization rules.</span></span> <span data-ttu-id="fca8a-437">Вместо того, чтобы определить, кто имеет разрешение на доступ к странице, нам может понадобиться разрешать доступ к странице, но для отображение различных данных или предлагать различные функциональные возможности в зависимости от пользователя, посещающего страницу.</span><span class="sxs-lookup"><span data-stu-id="fca8a-437">Rather than defining who is permitted to access a page, we may need to let everyone access a page, but to show different data or offer different functionality depending on the user visiting the page.</span></span> <span data-ttu-id="fca8a-438">Авторизацию на уровне страницы обычно включает в себя скрытие элементов пользовательского интерфейса, чтобы предотвратить несанкционированный доступ к функциональным возможностям запрещенных.</span><span class="sxs-lookup"><span data-stu-id="fca8a-438">Page-level authorization usually involves hiding specific user interface elements in order to prevent unauthorized users from accessing prohibited functionality.</span></span> <span data-ttu-id="fca8a-439">Кроме того можно использовать атрибуты для ограничения доступа к классам и выполнения его методов для определенных пользователей.</span><span class="sxs-lookup"><span data-stu-id="fca8a-439">Additionally, it is possible to use attributes to restrict access to classes and execution of its methods for certain users.</span></span>

<span data-ttu-id="fca8a-440">Счастливого вам программирования!</span><span class="sxs-lookup"><span data-stu-id="fca8a-440">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="fca8a-441">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="fca8a-441">Further Reading</span></span>

<span data-ttu-id="fca8a-442">Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:</span><span class="sxs-lookup"><span data-stu-id="fca8a-442">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="fca8a-443">Добавление к бизнесу и уровни данных с помощью правил авторизации `PrincipalPermissionAttributes`</span><span class="sxs-lookup"><span data-stu-id="fca8a-443">Adding Authorization Rules to Business and Data Layers Using `PrincipalPermissionAttributes`</span></span>](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)
- [<span data-ttu-id="fca8a-444">Проверки подлинности ASP.NET</span><span class="sxs-lookup"><span data-stu-id="fca8a-444">ASP.NET Authorization</span></span>](https://msdn.microsoft.com/library/wce3kxhd.aspx)
- [<span data-ttu-id="fca8a-445">Изменения между IIS6 и системы безопасности в IIS7</span><span class="sxs-lookup"><span data-stu-id="fca8a-445">Changes Between IIS6 and IIS7 Security</span></span>](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/Changes-between-IIS6-and-IIS7-Security)
- [<span data-ttu-id="fca8a-446">Настройка отдельных файлов и подкаталогов</span><span class="sxs-lookup"><span data-stu-id="fca8a-446">Configuring Specific Files and Subdirectories</span></span>](https://msdn.microsoft.com/library/6hbkh9s7.aspx)
- [<span data-ttu-id="fca8a-447">Ограничение функций изменения данных на основе пользователя</span><span class="sxs-lookup"><span data-stu-id="fca8a-447">Limiting Data Modification Functionality Based on the User</span></span>](../../data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-cs.md)
- [<span data-ttu-id="fca8a-448">Примеры использования элемента управления LoginView</span><span class="sxs-lookup"><span data-stu-id="fca8a-448">LoginView Control QuickStarts</span></span>](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/loginview.aspx)
- [<span data-ttu-id="fca8a-449">Основные сведения об авторизации URL-адреса IIS7</span><span class="sxs-lookup"><span data-stu-id="fca8a-449">Understanding IIS7 URL Authorization</span></span>](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization)
- [<span data-ttu-id="fca8a-450">`UrlAuthorizationModule` Техническая документация</span><span class="sxs-lookup"><span data-stu-id="fca8a-450">`UrlAuthorizationModule` Technical Documentation</span></span>](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx)
- [<span data-ttu-id="fca8a-451">Работа с данными в ASP.NET 2.0</span><span class="sxs-lookup"><span data-stu-id="fca8a-451">Working with Data in ASP.NET 2.0</span></span>](../../data-access/index.md)

### <a name="about-the-author"></a><span data-ttu-id="fca8a-452">Об авторе</span><span class="sxs-lookup"><span data-stu-id="fca8a-452">About the Author</span></span>

<span data-ttu-id="fca8a-453">Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года.</span><span class="sxs-lookup"><span data-stu-id="fca8a-453">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="fca8a-454">Скотт — независимый консультант, преподаватель и автор.</span><span class="sxs-lookup"><span data-stu-id="fca8a-454">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="fca8a-455">Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span><span class="sxs-lookup"><span data-stu-id="fca8a-455">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="fca8a-456">Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).</span><span class="sxs-lookup"><span data-stu-id="fca8a-456">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="fca8a-457">Особая благодарность</span><span class="sxs-lookup"><span data-stu-id="fca8a-457">Special Thanks To</span></span>

<span data-ttu-id="fca8a-458">В этой серии руководств пособий рецензировалась многими компетентными редакторами.</span><span class="sxs-lookup"><span data-stu-id="fca8a-458">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="fca8a-459">Хотите поработать с моих последующих статей для MSDN?</span><span class="sxs-lookup"><span data-stu-id="fca8a-459">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="fca8a-460">Если Да, напишите мне [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4GuysFromRolla.com).</span><span class="sxs-lookup"><span data-stu-id="fca8a-460">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="fca8a-461">[Назад](validating-user-credentials-against-the-membership-user-store-cs.md)
> [Вперед](storing-additional-user-information-cs.md)</span><span class="sxs-lookup"><span data-stu-id="fca8a-461">[Previous](validating-user-credentials-against-the-membership-user-store-cs.md)
[Next](storing-additional-user-information-cs.md)</span></span>
