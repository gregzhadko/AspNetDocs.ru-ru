---
uid: web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
title: Проверка учетных данных пользователя в хранилище пользователей членства (C#) | Документация Майкрософт
author: rick-anderson
description: В этом учебнике мы рассмотрим, как проверить учетные данные пользователя в хранилище пользователей членства с помощью программных средств и элемента управления Login....
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 61aa4e08-aa81-4aeb-8ebe-19ba7a65e04c
msc.legacyurl: /web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
msc.type: authoredcontent
ms.openlocfilehash: fd50f4e63c75cf77eb21629d0c11a859da6b357d
ms.sourcegitcommit: 4e6d586faadbe4d9ef27122f86335ec9385134af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2020
ms.locfileid: "89045238"
---
# <a name="validating-user-credentials-against-the-membership-user-store-c"></a>Проверка учетных данных пользователей в хранилище авторизованных пользователей (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_CS.zip) или [скачать PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_cs.pdf)

> В этом учебнике мы рассмотрим, как проверить учетные данные пользователя в хранилище пользователей членства с помощью программных средств и элемента управления Login. Также будет рассмотрена настройка внешнего вида и поведения элемента управления Login.

## <a name="introduction"></a>Введение

В <a id="Tutorial05"></a> [предыдущем учебном курсе](creating-user-accounts-cs.md) мы рассматривали, как создать новую учетную запись пользователя в инфраструктуре членства. Сначала мы рассмотрели программное создание учетных записей пользователей с помощью `Membership` `CreateUser` метода класса, а затем проверили с помощью веб-элемента управления CreateUserWizard. Однако страница входа в настоящее время проверяет предоставленные учетные данные по жестко закодированному списку пар имя пользователя и пароль. Необходимо обновить логику страницы входа таким образом, чтобы она проверяла учетные данные в хранилище пользователя инфраструктуры членства.

Подобно созданию учетных записей пользователей, учетные данные можно проверять программно или декларативно. API членства включает метод для программной проверки учетных данных пользователя в хранилище пользователя. И ASP.NET поставляется с веб-элементом управления Login, который отображает пользовательский интерфейс с текстовыми полями для имени пользователя и пароля, а также кнопку для входа.

В этом учебнике мы рассмотрим, как проверить учетные данные пользователя в хранилище пользователей членства с помощью программных средств и элемента управления Login. Также будет рассмотрена настройка внешнего вида и поведения элемента управления Login. Приступим к работе!

## <a name="step-1-validating-credentials-against-the-membership-user-store"></a>Шаг 1. Проверка учетных данных в хранилище пользователей членства

Для веб-сайтов, использующих проверку подлинности с помощью форм, пользователь входит на веб-сайт, посетив страницу входа и вводя свои учетные данные. Затем эти учетные данные сравниваются с хранилищем пользователя. Если они являются допустимыми, пользователю предоставляется билет проверки подлинности форм, который является маркером безопасности, указывающим удостоверение и подлинность посетителя.

Чтобы проверить пользователя в инфраструктуре членства, используйте `Membership` [ `ValidateUser` метод](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx)класса. `ValidateUser`Метод принимает два входных параметра, *`username`* а *`password`* -и возвращает логическое значение, указывающее, являются ли учетные данные допустимыми. Как и в `CreateUser` случае с методом, который мы рассматривали в предыдущем руководстве, `ValidateUser` метод делегирует фактическую проверку настроенному поставщику членства.

Объект `SqlMembershipProvider` проверяет предоставленные учетные данные, получая указанный пароль пользователя с помощью `aspnet_Membership_GetPasswordWithFormat` хранимой процедуры. Помните, что `SqlMembershipProvider` пароли пользователей хранятся в одном из трех форматов: Clear, encrypted или Hashed. `aspnet_Membership_GetPasswordWithFormat`Хранимая процедура возвращает пароль в необработанном формате. Для зашифрованных или хэшированных паролей преобразует `SqlMembershipProvider` *`password`* значение, передаваемое в `ValidateUser` метод, в эквивалентное ему зашифрованное или хэшированное состояние, а затем сравнивает его с тем, что было возвращено из базы данных. Если пароль, хранящийся в базе данных, соответствует форматированному паролю, введенному пользователем, то учетные данные являются действительными.

Давайте изменим страницу входа (~/ `Login.aspx` ) таким образом, чтобы она проверяла предоставленные учетные данные в хранилище пользователя инфраструктуры членства. Мы создали эту страницу входа обратно в <a id="Tutorial02"></a> [*обзоре учебника по проверке подлинности*](../introduction/an-overview-of-forms-authentication-cs.md) с помощью форм, создав интерфейс с двумя текстовыми полями для имени пользователя и пароля, флажок Запомнить учетные данные и кнопку входа (см. рис. 1). Код проверяет указанные учетные данные по жестко закодированному списку пар "имя пользователя и пароль" (Скотт/Password, Цзисунь/пароль, SAM/Password). В <a id="Tutorial03"></a> учебнике [*Настройка проверки подлинности с помощью форм и дополнительные разделы*](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md) мы обновили код страницы входа для хранения дополнительных сведений в свойстве билета проверки подлинности с помощью форм `UserData` .

[![Интерфейс страницы входа включает два текстовых поля, CheckBoxList и кнопку](validating-user-credentials-against-the-membership-user-store-cs/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image1.png)

**Рис. 1**. интерфейс страницы входа содержит два текстовых поля, CheckBoxList и кнопку ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image3.png)).

Пользовательский интерфейс страницы входа может остаться неизменным, но необходимо заменить обработчик событий кнопки входа на `Click` код, проверяющий пользователя в соответствии с хранилищем пользователя инфраструктуры членства. Обновите обработчик событий таким образом, чтобы его код выявлялся следующим образом:

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample1.cs)]

Этот код очень прост. Начнем с вызова `Membership.ValidateUser` метода, передав ему указанные имя пользователя и пароль. Если этот метод возвращает значение true, то пользователь подписывается на сайт с помощью `FormsAuthentication` метода RedirectFromLoginPage класса. (Как мы обсуждали в <a id="Tutorial2"></a> В обзоре учебника по [*проверке подлинности*](../introduction/an-overview-of-forms-authentication-cs.md) с помощью форм `FormsAuthentication.RedirectFromLoginPage` создается билет проверки подлинности форм, а затем пользователь перенаправляется на соответствующую страницу.) Если учетные данные недопустимы, то `InvalidCredentialsMessage` отображается метка, информирующее пользователя о неправильном имени пользователя или пароле.

Вот и все!

Чтобы проверить, правильно работает страница входа, попробуйте войти с помощью одной из учетных записей пользователя, созданных в предыдущем руководстве. Если вы еще не создали учетную запись, создайте ее на `~/Membership/CreatingUserAccounts.aspx` странице.

> [!NOTE]
> Когда пользователь вводит свои учетные данные и отправляет форму страницы входа, учетные данные, включая пароль, передаются через Интернет на веб-сервер в *виде обычного текста*. Это означает, что любой злоумышленник, прослушивать сетевой трафик, может видеть имя пользователя и пароль. Чтобы избежать этого, важно зашифровать сетевой трафик с помощью [SSL](http://en.wikipedia.org/wiki/Secure_Sockets_Layer). Это гарантирует, что учетные данные (а также все HTML-разметка страницы) будут зашифрованы с момента выхода из браузера, пока они не будут получены веб-сервером.

### <a name="how-the-membership-framework-handles-invalid-login-attempts"></a>Как инфраструктура членства обрабатывает недопустимые попытки входа

Когда посетитель достигает страницы входа и отправляет свои учетные данные, браузер отправляет запрос HTTP на страницу входа. Если учетные данные допустимы, HTTP-ответ содержит билет проверки подлинности в файле cookie. Таким образом, злоумышленник, пытающийся перейти на ваш сайт, может создать программу, которая последовательно отправляет HTTP-запросы на страницу входа с допустимым именем пользователя и предположением пароля. Если предположение пароля правильное, страница входа будет возвращать файл cookie билета проверки подлинности, после чего программа знает, что она трудностями по допустимой паре имени пользователя и пароля. С помощью принудительного подбора такая программа может наткнулись на пароль пользователя, особенно в том случае, если пароль слабый.

Чтобы предотвратить подобные атаки методом подбора, инфраструктура членства блокирует пользователя, если имеется определенное количество неудачных попыток входа в течение определенного периода времени. Точные параметры настраиваются с помощью следующих двух параметров конфигурации поставщика членства:

- `maxInvalidPasswordAttempts` — Указывает, сколько недопустимых попыток ввода пароля разрешено для пользователя в течение периода времени, по истечении которого учетная запись блокируется. Значение по умолчанию — 5.
- `passwordAttemptWindow` — Указывает период времени в минутах, в течение которого указанное число недопустимых попыток входа в систему приведет к блокировке учетной записи. Значение по умолчанию — 10.

Если пользователь заблокирован, он не может войти в систему, пока администратор не разблокирует свою учетную запись. Когда пользователь заблокирован, `ValidateUser` метод *всегда* возвращает значение `false` , даже если предоставляются действительные учетные данные. Хотя такое поведение уменьшает вероятность того, что злоумышленник будет разбиваться на ваш сайт с помощью методов подбора, он может завершить блокировку допустимого пользователя, который просто забыл пароль или случайно заблокировал блокировку или имеет неверный день ввода.

К сожалению, нет встроенного средства для разблокировки учетной записи пользователя. Чтобы разблокировать учетную запись, можно изменить базу данных напрямую — изменить `IsLockedOut` поле в `aspnet_Membership` таблице на соответствующую учетную запись пользователя или создать веб-интерфейс со списком заблокированных учетных записей с параметрами для их разблокировки. Мы рассмотрим создание административных интерфейсов для выполнения общих задач, связанных с учетными записями и ролями пользователей, в будущем руководстве.

> [!NOTE]
> Один из недостатков `ValidateUser` метода заключается в том, что если предоставленные учетные данные недопустимы, они не предоставляют пояснения. Учетные данные могут быть недопустимыми, так как в хранилище пользователя отсутствует совпадающая пара имя пользователя и пароль или пользователь не был утвержден или пользователь заблокирован. На этапе 4 мы покажем, как показать пользователю более подробное сообщение при неудачной попытке входа.

## <a name="step-2-collecting-credentials-through-the-login-web-control"></a>Шаг 2. сбор учетных данных с помощью веб-элемента управления Login

[Веб-элемент управления Login](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx) визуализирует пользовательский интерфейс по умолчанию, очень похожий на тот, который мы создали в <a id="SKM5"></a> [*обзоре учебника по проверке подлинности*](../introduction/an-overview-of-forms-authentication-cs.md) с помощью форм. Использование элемента управления Login позволяет нам создавать интерфейс для получения учетных данных посетителя. Более того, элемент управления Login автоматически подписывает пользователя (предполагая, что предоставленные учетные данные действительны), тем самым экономя от необходимости писать код.

Попробуем обновить `Login.aspx` , заменив вручную созданный интерфейс и код элементом управления Login. Начните с удаления существующей разметки и кода в `Login.aspx` . Вы можете удалить это право или просто закомментировать его. Чтобы закомментировать декларативную разметку, заключите ее в `<%--` `--%>` разделители и. Эти разделители можно вводить вручную, или, как показано на рис. 2, можно выбрать текст для комментирования и щелкнуть значок закомментировать выбранные строки на панели инструментов. Аналогичным образом можно использовать закомментировать значок выбранные строки, чтобы закомментировать выбранный код в классе кода программной части.

[![Закомментируйте существующую декларативную разметку и исходный код в файле Login. aspx](validating-user-credentials-against-the-membership-user-store-cs/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image4.png)

**Рис. 2**. комментирование существующей декларативной разметки и исходного кода в `Login.aspx` ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image6.png))

> [!NOTE]
> При просмотре декларативной разметки в Visual Studio 2005 значок выбранные строки недоступен. Если вы не используете Visual Studio 2008, нужно будет вручную добавить `<%--` `--%>` разделители и.

Затем перетащите элемент управления Login с панели элементов на страницу и присвойте `ID` свойству значение `myLogin` . На этом этапе экран должен выглядеть примерно так, как показано на рис. 3. Обратите внимание, что интерфейс по умолчанию элемента управления Login включает в себя элементы управления TextBox для имени пользователя и пароля, флажок Запомнить меня в следующий раз и кнопку войти в систему. Существуют также `RequiredFieldValidator` элементы управления для двух текстовых полей.

[![Добавление элемента управления Login на страницу](validating-user-credentials-against-the-membership-user-store-cs/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image7.png)

**Рис. 3**. Добавление элемента управления Login на страницу ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image9.png))

И все готово! При нажатии кнопки входа в систему элемента управления Login произойдет обратная передача, и элемент управления Login вызовет `Membership.ValidateUser` метод, передавая ему указанное имя пользователя и пароль. Если учетные данные недопустимы, элемент управления Login отображает сообщение, уведомляющее об этом. Однако если учетные данные действительны, то элемент управления Login создает билет проверки подлинности форм и перенаправляет пользователя на соответствующую страницу.

Элемент управления Login использует четыре фактора для определения соответствующей страницы для перенаправления пользователя при успешном входе:

- Указывает, находится ли элемент управления Login на странице входа, как определено `loginUrl` параметром в конфигурации проверки подлинности с помощью форм. значение по умолчанию: `Login.aspx`
- Наличие `ReturnUrl` параметра QueryString
- Значение [ `DestinationUrl` Свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx) элемента управления Login
- `defaultUrl`Значение, указанное в параметрах конфигурации проверки подлинности с помощью форм; значение по умолчанию:`Default.aspx`

На рис. 4 показано, как элемент управления Login использует эти четыре параметра для получения соответствующего решения страницы.

[![Добавление элемента управления Login на страницу](validating-user-credentials-against-the-membership-user-store-cs/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image10.png)

**Рис. 4**. Добавление элемента управления Login на страницу ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image12.png))

Уделите время на тестирование элемента управления Login, посетив сайт в браузере и войдя в систему в качестве существующего пользователя в инфраструктуре членства.

Отображаемый интерфейс элемента управления Login имеет широкие возможности настройки. Существует ряд свойств, влияющих на его внешний вид. более того, элемент управления Login можно преобразовать в шаблон для точного управления макетом элементов пользовательского интерфейса. В оставшейся части этого шага рассматривается настройка внешнего вида и макета.

### <a name="customizing-the-login-controls-appearance"></a>Настройка внешнего вида элемента управления Login

Параметры свойства по умолчанию для элемента управления Login отображают пользовательский интерфейс с заголовком (вход), TextBox и элементом управления Label для ввода имени пользователя и пароля, флажок Запомнить меня в следующий раз и кнопку Вход в систему. Внешний вид этих элементов можно настроить с помощью многочисленных свойств элемента управления Login. Кроме того, дополнительные элементы пользовательского интерфейса, например ссылка на страницу для создания новой учетной записи пользователя, можно добавить, задав свойство или два.

Подождите несколько секунд, чтобы Гусси внешний вид элемента управления входом. Так как `Login.aspx` страница уже содержит текст в верхней части страницы с текстом Login, заголовок элемента управления Login является излишним. Поэтому очистите значение [ `TitleText` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx) , чтобы удалить заголовок элемента управления Login.

Метки имя пользователя: и пароль: слева от двух элементов управления TextBox можно настроить с помощью [`UserNameLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx) [ `PasswordLabelText` свойств](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx)и соответственно. Давайте изменим имя пользователя: метка на чтение имя пользователя:. Стили меток и текстовых полей настраиваются с помощью [`LabelStyle`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx) [ `TextBoxStyle` свойств](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx)и соответственно.

Свойство Text этого флажка Запомнить время может быть задано через элемент управления Login [`RememberMeText property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx) , и его состояние по умолчанию можно настроить с помощью параметра [`RememberMeSet property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx) (значение по умолчанию — false). Присвойте `RememberMeSet` свойству значение true, чтобы флажок Запомнить меня в следующий раз проверялся по умолчанию.

Элемент управления Login предлагает два свойства для настройки макета элементов управления пользовательского интерфейса. [`TextLayout property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx)Указывает, отображаются ли метки username: и Password: слева от соответствующих текстовых полей (по умолчанию) или над ними. [`Orientation property`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx)Указывает, расположены ли входные данные имени пользователя и пароля по вертикали (один над другим) или по горизонтали. Я собираюсь оставить эти два свойства по умолчанию, но я рекомендую попробовать установить эти два свойства в значения, отличные от значений по умолчанию, чтобы увидеть полученный результат.

> [!NOTE]
> В следующем разделе Настройка макета элемента управления Login будет рассмотрено использование шаблонов для определения точного макета элементов пользовательского интерфейса элемента управления макета.

Заключить параметры свойства элемента управления для входа, установив [`CreateUserText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx) для [ `CreateUserUrl` свойств](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx) и значение "еще не зарегистрировано"? Создайте учетную запись. и `~/Membership/CreatingUserAccounts.aspx` соответственно. При этом добавляется гиперссылка на интерфейс элемента управления Login, указывающий на страницу, созданную в <a id="SKM6"></a> [предыдущем руководстве](creating-user-accounts-cs.md). Параметры и свойства элемента управления для входа [`HelpPageText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx) [ `HelpPageUrl` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx) [`PasswordRecoveryText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx) работают [ `PasswordRecoveryUrl` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx) одинаково, выводятся ссылки на страницу справки и страницу восстановления пароля.

После внесения этих изменений в свойства декларативная разметка и внешний вид элемента управления входа должны выглядеть примерно так, как показано на рис. 5.

[![Значения свойств элемента управления Login определяют его внешний вид](validating-user-credentials-against-the-membership-user-store-cs/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image13.png)

**Рис. 5**. значения свойств элемента управления для входа определяют его внешний вид ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image15.png))

### <a name="configuring-the-login-controls-layout"></a>Настройка макета элемента управления Login

Пользовательский интерфейс веб-элемента управления Login по умолчанию размещает интерфейс в HTML `<table>` . Но что делать, если нам нужен более точный контроль над отображаемыми выходными данными? Возможно, мы хотим заменить на `<table>` ряд `<div>` тегов. Или что делать, если нашему приложению требуются дополнительные учетные данные для проверки подлинности? Многие финансовые веб-сайты, например, должны предоставлять пользователям не только имя пользователя и пароль, но и персональный идентификационный номер (ПИН-код) или другие идентификационные данные. По каким-либо причинам можно преобразовать элемент управления Login в шаблон, из которого мы можем явно определить декларативную разметку интерфейса.

Чтобы обновить элемент управления Login для получения дополнительных учетных данных, необходимо выполнить две операции:

1. Обновите интерфейс элемента управления входа, чтобы включить веб-элементы управления для получения дополнительных учетных данных.
2. Переопределите внутреннюю логику проверки подлинности элемента управления Login, чтобы пользователь прошел проверку подлинности только в том случае, если его имя пользователя и пароль действительны, а их дополнительные учетные данные являются действительными.

Чтобы выполнить первую задачу, необходимо преобразовать элемент управления Login в шаблон и добавить необходимые веб-элементы управления. Как и для второй задачи, логику проверки подлинности элемента управления входа можно заменить путем создания обработчика событий для [ `Authenticate` события](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx)элемента управления.

Давайте изменим элемент управления Login таким образом, чтобы он задавал пользователю запрос на ввод имени пользователя, пароля и адреса электронной почты и прошел проверку подлинности только в том случае, если указанный адрес электронной почты совпадает с адресом электронной почты в файле. Сначала необходимо преобразовать интерфейс элемента управления Login в шаблон. В смарт-теге элемента управления Login выберите параметр преобразовать в шаблон.

[![Преобразование элемента управления Login в шаблон](validating-user-credentials-against-the-membership-user-store-cs/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image16.png)

**Рис. 6**. Преобразование элемента управления Login в шаблон ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image18.png))

> [!NOTE]
> Чтобы вернуть элемент управления Login к версии, предшествующей шаблону, щелкните ссылку сбросить в смарт-теге элемента управления.

Преобразование элемента управления Login в шаблон добавляет `LayoutTemplate` к декларативной разметке элемента управления с ЭЛЕМЕНТАМИ HTML и веб-элементами управления, определяющими пользовательский интерфейс. Как показано на рис. 7, преобразование элемента управления в шаблон удаляет ряд свойств из окно свойств, таких как `TitleText` , `CreateUserUrl` и т. д., так как эти значения свойств игнорируются при использовании шаблона.

[![При преобразовании элемента управления Login в шаблон доступно меньшее число свойств](validating-user-credentials-against-the-membership-user-store-cs/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image19.png)

**Рис. 7**. Если элемент управления для входа преобразуется в шаблон ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image21.png)), доступно меньшее число свойств

Разметка HTML в `LayoutTemplate` может быть изменена по мере необходимости. Аналогичным образом вы можете добавить в шаблон новые веб-элементы управления. Однако важно, чтобы основные веб-элементы управления входа оставались в шаблоне и сохранили назначенные им `ID` значения. В частности, не удаляйте и не переименовывайте `UserName` `Password` текстовые поля или, `RememberMe` флажок, `LoginButton` кнопку, `FailureText` метку или `RequiredFieldValidator` элементы управления.

Чтобы получить адрес электронной почты посетителя, необходимо добавить в шаблон текстовое поле. Добавьте следующую декларативную разметку между строкой таблицы ( `<tr>` ), содержащей `Password` текстовое поле, и строкой таблицы, содержащей флажок Запомнить меня в следующий раз:

[!code-aspx[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample2.aspx)]

После добавления `Email` текстового поля откройте страницу в браузере. Как показано на рис. 8, Пользовательский интерфейс элемента управления Login теперь включает в себя третье текстовое поле.

[![Элемент управления Login теперь включает в себя текстовое поле для адреса электронной почты пользователя](validating-user-credentials-against-the-membership-user-store-cs/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image22.png)

**Рис. 8**. Теперь элемент управления Login содержит текстовое поле для адреса электронной почты пользователя ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image24.png)).

На этом этапе элемент управления Login по-прежнему использует `Membership.ValidateUser` метод для проверки предоставленных учетных данных. Соответственно, значение, указанное в `Email` текстовом поле, не зависит от того, может ли пользователь войти в систему. На этапе 3 мы рассмотрим, как переопределить логику проверки подлинности элемента управления Login, чтобы учетные данные считались допустимыми только в том случае, если имя пользователя и пароль действительны, а предоставленный адрес электронной почты совпадает с адресом электронной почты в файле.

## <a name="step-3-modifying-the-login-controls-authentication-logic"></a>Шаг 3. изменение логики проверки подлинности элемента управления Login

Когда посетитель передает свои учетные данные и нажимает кнопку Вход, выполняется обратная передача, и элемент управления входа проходит через рабочий процесс проверки подлинности. Рабочий процесс начинается с вызова [ `LoggingIn` события](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx). Все обработчики событий, связанные с этим событием, могут отменить операцию входа, присвоив `e.Cancel` свойству значение `true` .

Если операция входа в систему не отменена, Рабочий процесс выполняется путем вызова [ `Authenticate` события](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx). Если для события существует обработчик `Authenticate` , он отвечает за определение того, являются ли предоставленные учетные данные допустимыми. Если обработчик событий не указан, элемент управления Login использует `Membership.ValidateUser` метод для определения допустимости учетных данных.

Если предоставлены допустимые учетные данные, создается билет проверки подлинности форм, вызывается [ `LoggedIn` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx) , и пользователь перенаправляется на соответствующую страницу. Однако если учетные данные считаются недопустимыми, возникает [ `LoginError` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx) , и отображается сообщение, информирующее пользователя о том, что его учетные данные недопустимы. По умолчанию при сбое элемент управления Login просто устанавливает `FailureText` свойство Text элемента управления Label в сообщение об ошибке (попытка входа не удалась). Повторите попытку). Однако если [ `FailureAction` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx) элемента управления Login имеет значение `RedirectToLoginPage` , то элемент управления Login выдает на `Response.Redirect` страницу входа, добавляя параметр QueryString `loginfailure=1` (что приводит к тому, что элемент управления входа отображает сообщение об ошибке).

На рис. 9 имеется блок-схема рабочего процесса проверки подлинности.

[![Рабочий процесс проверки подлинности элемента управления Login](validating-user-credentials-against-the-membership-user-store-cs/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image25.png)

**Рис. 9**. Рабочий процесс проверки подлинности элемента управления Login ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image27.png))

> [!NOTE]
> Если вы хотите использовать `FailureAction` `RedirectToLogin` параметр страницы, рассмотрим следующий сценарий. Сейчас `Site.master` Главная страница в данный момент содержит текст Hello, Стрэнджер отображается в левом столбце при посещении анонимного пользователя, но представьте, что мы хотим заменить этот текст элементом управления Login. Это позволит анонимному пользователю входить в систему с любой страницы на сайте, а не требовать непосредственного посещения страницы входа. Однако если пользователь не смог войти в систему с помощью элемента управления входа, подготовленного к просмотру на главной странице, может иметь смысл перенаправить их на страницу входа ( `Login.aspx` ), так как эта страница, вероятно, содержит дополнительные инструкции, ссылки и другие справочные материалы, например ссылки для создания новой учетной записи или получения утерянного пароля, которые не были добавлены на главную страницу.

### <a name="creating-theauthenticateevent-handler"></a>Создание `Authenticate` обработчика событий

Чтобы подключить собственную логику проверки подлинности, необходимо создать обработчик событий для события элемента управления Login `Authenticate` . Создание обработчика событий для `Authenticate` события приведет к созданию следующего определения обработчика событий:

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample3.cs)]

Как видите, `Authenticate` обработчик событий передает в [`AuthenticateEventArgs`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx) качестве второго входного параметра объект типа. `AuthenticateEventArgs`Класс содержит логическое свойство с именем `Authenticated` , которое используется, чтобы указать, являются ли предоставленные учетные данные допустимыми. Наша задача, в своюмся, заключается в написании кода, который определяет, являются ли предоставленные учетные данные допустимыми или нет, а также устанавливает `e.Authenticate` соответствующее свойство.

### <a name="determining-and-validating-the-supplied-credentials"></a>Определение и Проверка предоставленных учетных данных

Используйте [`UserName`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx) [ `Password` Свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx) и для элемента управления Login, чтобы определить имя пользователя и пароль, указанные пользователем. Чтобы определить значения, введенные в любые дополнительные веб-элементы управления (например, `Email` текстовое поле, добавленное на предыдущем шаге), используйте *`LoginControlID`* `.FindControl` (" *`controlID`* "), чтобы получить программную ссылку на веб-элемент управления в шаблоне, `ID` свойство которого равно *`controlID`* . Например, чтобы получить ссылку на `Email` текстовое поле, используйте следующий код:

`TextBox EmailTextBox = myLogin.FindControl("Email") as TextBox;`

Чтобы проверить учетные данные пользователя, необходимо выполнить два действия:

1. Убедитесь, что указанные имя пользователя и пароль действительны.
2. Убедитесь, что введенный адрес электронной почты соответствует адресу электронной почты в файле для пользователя, пытающегося войти в систему.

Чтобы выполнить первую проверку, можно просто использовать метод, `Membership.ValidateUser` как показано на шаге 1. Для второй проверки необходимо определить адрес электронной почты пользователя, чтобы можно было сравнить его с адресом электронной почты, введенным в элемент управления TextBox. Чтобы получить сведения об определенном пользователе, используйте `Membership` [ `GetUser` метод](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx)класса.

`GetUser`Метод имеет ряд перегрузок. Если используется без передачи каких бы то ни было параметров, он возвращает сведения о текущем пользователе, вошедшем в систему. Чтобы получить сведения о конкретном пользователе, вызовите метод `GetUser` передачи имени пользователя. В любом случае `GetUser` возвращает [ `MembershipUser` объект](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), который имеет такие свойства, как `UserName` , `Email` ,, `IsApproved` `IsOnline` и т. д.

Следующий код реализует эти две проверки. Если оба параметра прошли, то устанавливается `e.Authenticate` в значение `true` , в противном случае назначается `false` .

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample4.cs)]

Используя этот код, попытайтесь войти в качестве допустимого пользователя, введя правильное имя пользователя, пароль и адрес электронной почты. Попробуйте еще раз, но на этот раз намеренно использовать неверный адрес электронной почты (см. рис. 10). Наконец, попробуйте использовать несуществующее имя пользователя в третий раз. В первом случае вы успешно вошли на сайт, но в двух последних случаях вы увидите сообщение об ошибке "недопустимые учетные данные элемента управления входа".

[![Тито не удается войти в систему при указании неправильного адреса электронной почты](validating-user-credentials-against-the-membership-user-store-cs/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image28.png)

**Рис. 10**. Тито не удается войти в систему при вводе неправильного адреса электронной почты ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image30.png))

> [!NOTE]
> Как описано в разделе Инфраструктура членства обрабатывает недопустимые попытки входа в систему на шаге 1, когда `Membership.ValidateUser` метод вызывается и передает недопустимые учетные данные, он отслеживает неудачную попытку входа и блокирует пользователя, если он превышает определенное пороговое значение недопустимых попыток в течение заданного временного интервала. Так как наша пользовательская логика проверки подлинности вызывает `ValidateUser` метод, неверный пароль для допустимого имени пользователя увеличивает значение счетчика неудачных попыток входа, но этот счетчик не увеличивается в случае, когда имя пользователя и пароль действительны, но адрес электронной почты неверен. Вероятно, это поведение подходит, так как маловероятно, чтобы злоумышленник знал имя пользователя и пароль, но для определения адреса электронной почты пользователя необходимо использовать методы принудительной силы.

## <a name="step-4-improving-the-login-controls-invalid-credentials-message"></a>Шаг 4. Улучшение сообщения об недопустимых учетных данных элемента управления Login

Когда пользователь пытается войти в систему с недопустимыми учетными данными, элемент управления Login отображает сообщение о том, что попытка входа была неудачной. В частности, элемент управления отображает сообщение, заданное [ `FailureText` свойством](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx), которое по умолчанию не прошло попытку входа. Повторите попытку.

Помните, что существует множество причин, по которым учетные данные пользователя могут быть недопустимыми:

- Возможно, имя пользователя не существует
- Имя пользователя существует, но пароль недействителен
- Имя пользователя и пароль действительны, но пользователь еще не утвержден
- Имя пользователя и пароль действительны, но пользователь заблокирован (скорее всего, из-за превышения числа недопустимых попыток входа в течение заданного интервала времени).

При использовании настраиваемой логики проверки подлинности могут возникнуть и другие причины. Например, в коде, написанном на шаге 3, имя пользователя и пароль могут быть допустимыми, но адрес электронной почты может быть неверным.

Независимо от того, почему учетные данные являются недопустимыми, элемент управления Login отображает одно и то же сообщение об ошибке. Такое отсутствие отзывов может быть запутанным для пользователя, учетная запись которого еще не утверждена или заблокирована. Но с небольшой скоростью работы, элемент управления Login может отобразить более подходящее сообщение.

Каждый раз, когда пользователь пытается войти с недействительными учетными данными, элемент управления входа вызывает `LoginError` событие. Создайте обработчик событий для этого события и добавьте следующий код:

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample5.cs)]

Приведенный выше код начинается с присвоения свойству элемента управления Login `FailureText` значения по умолчанию (попытка входа не удалась. Повторите попытку). Затем он проверяет, сопоставлено ли имя пользователя с существующей учетной записью пользователя. В этом случае он обращается к полученным `MembershipUser` `IsLockedOut` свойствам объекта и, `IsApproved` чтобы определить, была ли учетная запись заблокирована или еще не утверждена. В любом случае `FailureText` свойство обновляется до соответствующего значения.

Чтобы протестировать этот код, намеренно попытку входа в систему от имени существующего пользователя, но используйте неверный пароль. Сделайте это пять раз в строке в течение 10-минутного интервала, и учетная запись будет заблокирована. Как показано на рис. 11, при последующих попытках входа всегда произойдет сбой (даже при наличии правильного пароля), но теперь будет отображено более подробное описание учетной записи из-за слишком большого числа неудачных попыток входа. Обратитесь к администратору, чтобы ваша учетная запись разблокировала сообщение.

[![Тито выполнил слишком много недопустимых попыток входа в систему и был заблокирован](validating-user-credentials-against-the-membership-user-store-cs/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image31.png)

**Рис. 11**. Тито выполнил слишком много недопустимых попыток входа в систему и был заблокирован ([щелкните, чтобы просмотреть изображение с полным размером](validating-user-credentials-against-the-membership-user-store-cs/_static/image33.png))

## <a name="summary"></a>Сводка

В ходе работы с этим руководством страница входа проверила предоставленные учетные данные на жестко закодированный список пар имя пользователя/пароль. В этом руководстве мы обновили страницу для проверки учетных данных в инфраструктуре членства. На этапе 1 мы рассматривали использование `Membership.ValidateUser` метода программным способом. На этапе 2 мы заменили пользовательский интерфейс и код, созданные вручную, на элемент управления Login.

Элемент управления Login визуализирует стандартный пользовательский интерфейс входа и автоматически проверяет учетные данные пользователя в среде членства. Более того, в случае допустимых учетных данных элемент управления Login подписывает пользователя с помощью проверки подлинности с использованием форм. Коротко говоря, доступ к полнофункциональному пользователю можно получить, просто перетащив элемент управления Login на страницу, не требует дополнительной декларативной разметки или кода. Более того, элемент управления Login очень настраиваемый, что позволяет точно контролировать как отображаемый пользовательский интерфейс, так и логику проверки подлинности.

На этом этапе Посетители веб-сайта могут создать новую учетную запись пользователя и войти на сайт, но мы еще не просматриваете доступ к страницам на основе пользователя, прошедшего проверку подлинности. В настоящее время любой пользователь, аутентифицированный или анонимный, может просматривать любую страницу на нашем сайте. Наряду с управлением доступом к страницам сайта на уровне пользователя, у нас могут быть определенные страницы, функциональность которых зависит от пользователя. В следующем учебнике рассматривается ограничение доступа и функциональных возможностей на странице в зависимости от пользователя, вошедшего в систему.

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Отображение пользовательских сообщений для заблокированных и неутвержденных пользователей](http://aspnet.4guysfromrolla.com/articles/050306-1.aspx)
- [Изучение членства, ролей и профиля ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Как создать страницу входа в ASP.NET](https://msdn.microsoft.com/library/ms178331.aspx)
- [Техническая документация по элементу управления Login](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)
- [Использование элементов управления входа](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/login.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — *[Sams обучать себя ASP.NET 2,0 за 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скотт можно связаться по адресу [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/) .

### <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого учебника были Терезой Мерфи и Майкл Оливеро. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, удалите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com) .

> [!div class="step-by-step"]
> [Назад](creating-user-accounts-cs.md)
> [Вперед](user-based-authorization-cs.md)
