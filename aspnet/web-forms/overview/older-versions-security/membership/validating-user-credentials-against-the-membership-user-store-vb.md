---
uid: web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-vb
title: Проверка учетных данных пользователей Store пользователя членства (Visual Basic) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве мы рассмотрим, как для проверки учетных данных пользователей в хранилище авторизованных пользователей, с помощью программных средств и элемент управления Login...
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 17772912-b47b-4557-9ce9-80f22df642f7
msc.legacyurl: /web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-vb
msc.type: authoredcontent
ms.openlocfilehash: 98c13d076e20f8f57fc551cbcffe140d42c652da
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65108383"
---
# <a name="validating-user-credentials-against-the-membership-user-store-vb"></a>Проверка учетных данных пользователей в хранилище авторизованных пользователей (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_VB.zip) или [скачать PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_vb.pdf)

> В этом руководстве мы рассмотрим, как для проверки учетных данных пользователей в хранилище авторизованных пользователей, с помощью программных средств и элемент управления Login. Кроме того, мы рассмотрим способы настройки внешнего вида и поведения элемента управления login.

## <a name="introduction"></a>Вступление

В <a id="Tutorial05"> </a> [предыдущем учебном курсе](creating-user-accounts-vb.md) мы рассмотрели способы создания учетной записи пользователя в структуру членства. Сначала мы рассмотрели программное создание учетных записей пользователей с помощью `Membership` класса `CreateUser` метод, а затем проверяются с помощью элемента управления CreateUserWizard. Тем не менее на страницу входа в настоящее время проверяет предоставленные учетные данные от жестко список пар "имя пользователя и пароль". Нам нужно обновить логику на страницу входа, чтобы он проверяет учетные данные на хранилище структуры членства пользователя.

Во многом как с созданием учетных записей пользователей, учетных данных может быть проверен программным или декларативным способом. API членства включает метод программным путем проверки учетных данных пользователя в хранилище пользователя. И ASP.NET поставляется с входа веб-элементе управления, который отображает пользовательский интерфейс с текстовые поля для имени пользователя и пароля, а также кнопки для входа.

В этом руководстве мы рассмотрим, как для проверки учетных данных пользователей в хранилище авторизованных пользователей, с помощью программных средств и элемент управления Login. Кроме того, мы рассмотрим способы настройки внешнего вида и поведения элемента управления login. Давайте начнем!

## <a name="step-1-validating-credentials-against-the-membership-user-store"></a>Шаг 1. Проверка учетных данных Store пользователя членства

Для веб-сайтов, использующих проверку подлинности форм входа в систему на веб-сайт, посетив страницу входа и введя свои учетные данные. Затем эти учетные данные сравниваются с хранилище пользователя. Если они являются допустимыми, пользователю предоставляется билета проверки подлинности, который является маркером безопасности, который указывает удостоверений и подлинность посетителя.

Для проверки пользователя от структуры членства, используйте `Membership` класса [ `ValidateUser` метод](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx). `ValidateUser` Метод принимает два входных параметра - `username` и `password` — и возвращает логическое значение, указывающее, является ли учетные данные были допустимыми. Как с помощью `CreateUser` метод, мы рассмотрели в предыдущем учебном курсе, `ValidateUser` метод делегирует фактическая проверка систему настроенного поставщика членства.

`SqlMembershipProvider` Проверяет предоставленные учетные данные путем получения указанного пароля с помощью `aspnet_Membership_GetPasswordWithFormat` хранимой процедуры. Помните, что `SqlMembershipProvider` хранит пароли пользователей, используя один из трех форматов: очистить, в зашифрованном виде или хэшируется. `aspnet_Membership_GetPasswordWithFormat` Хранимая процедура возвращает пароль в необработанном формате. Пароли зашифрованном или хэшированном виде `SqlMembershipProvider` преобразует `password` значение, передаваемое в `ValidateUser` метода в его эквивалент зашифрованы или хэшируются состояние и затем сравнивает его с чем был возвращен из базы данных. Если пароль, которые хранятся в базе данных соответствует форматированный пароль, введенный пользователем, учетные данные допустимы.

Давайте обновим страницу входа в систему (~ /`Login.aspx`) таким образом, проверяет предоставленные учетные данные в хранилище пользователя членства framework. Мы создали Эта страница для входа в <a id="Tutorial02"> </a> [ *Обзор аутентификации форм* ](../introduction/an-overview-of-forms-authentication-vb.md) учебник, создания интерфейса с помощью двух текстовых полях имя пользователя и пароль, Запомнить меня флажка и кнопки входа (см. рис. 1). Код проверяет введенные учетные данные с жестко список пар имя пользователя и пароль (Scott и пароля, Цзисунь и пароля и Sam и пароль). В <a id="Tutorial03"> </a> [ *конфигурацию проверки подлинности форм и дополнительные разделы* ](../introduction/forms-authentication-configuration-and-advanced-topics-vb.md) руководстве, мы обновили код на страницу входа для хранения дополнительной информации в формах билет проверки подлинности `UserData` свойство.

[![Интерфейс на страницу входа включает два текстовых поля, CheckBoxList и кнопка](validating-user-credentials-against-the-membership-user-store-vb/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image1.png)

**Рис. 1**: На страницу входа интерфейса включает в себя два текстовых поля, CheckBoxList и кнопка ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image3.png))

Интерфейс пользователя на страницу входа может оставаться неизменным, но нам нужно заменить кнопки входа `Click` обработчик событий с кодом, который проверяет пользователя в хранилище пользователя членства framework. Обновите этот обработчик событий, таким образом, чтобы его код выглядит следующим образом:

[!code-vb[Main](validating-user-credentials-against-the-membership-user-store-vb/samples/sample1.vb)]

Этот код примечательно прост. Мы начнем с вызова `Membership.ValidateUser` метод, передавая введенное имя пользователя и пароль. Если этот метод возвращает значение True, то пользователь вошел на сайт выполняется с помощью `FormsAuthentication` RedirectFromLoginPage метод класса. (Как уже говорилось в <a id="Tutorial02"> </a> [ *Обзор аутентификации форм* ](../introduction/an-overview-of-forms-authentication-vb.md) руководстве `FormsAuthentication.RedirectFromLoginPage` создает билет проверки подлинности форм и затем перенаправляет пользователя Отобразится соответствующая страница.) Если учетные данные являются недопустимыми, однако `InvalidCredentialsMessage` метка будет отображаться, сообщая пользователю, что его имя пользователя или пароль неправильный.

Вот и все!

Чтобы проверить, что на страницу входа работает должным образом, попытка входа с помощью одной из учетных записей пользователя, созданную в предыдущем учебном курсе. Или, если вы еще не создали учетную запись затем создадим из `~/Membership/CreatingUserAccounts.aspx` страницы.

> [!NOTE]
> Когда пользователь вводит свои учетные данные и отправляет форму страницы входа, учетные данные, включая пароль, передаются через Интернет на веб-сервер в *обычный текст*. Это означает, что любой злоумышленник, проанализировать сетевой трафик можно увидеть имя пользователя и пароль. Чтобы избежать этого, очень важно для шифрования сетевого трафика с помощью [Secure слои сокетов (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer). Это позволит гарантировать, что учетные данные (а также всей страницы HTML-разметка) будут зашифрованы с момента они покидают браузера, пока они не будут получены веб-сервером.

### <a name="how-the-membership-framework-handles-invalid-login-attempts"></a>Как платформу членства обрабатывает недопустимые входов

Когда посетитель достигает на страницу входа и отправляет свои учетные данные, их браузер выполняет HTTP-запрос на страницу входа. Если учетные данные допустимы, HTTP-ответа содержит билет проверки подлинности в файле cookie. Таким образом злоумышленник попытка взлома веб-узла может создать программу, тщательное отправляет HTTP-запросы на страницу входа с допустимое имя пользователя и алкогольных пароль. Если предположение пароль указан правильно, на страницу входа возвращает файл cookie билет проверки подлинности, после чего программа знает, что он наткнулся пару допустимое имя пользователя и пароль. Через подбора такую программу можно наткнулись пароль пользователя, особенно в том случае, если пароль является слабым.

Для предотвращения подобных атак методом подбора, структуру членства блокирует работу пользователя при наличии определенного числа неудачных входов за определенный период времени. Точные параметры, можно настроить следующие параметры конфигурации два поставщика членства:

- `maxInvalidPasswordAttempts` -Указывает, сколько неверный пароль попыток разрешены для пользователя в течение периода времени, прежде чем учетная запись заблокирована. Значение по умолчанию — 5.
- `passwordAttemptWindow` -Указывает период времени в минутах, в течение которых указанное число попыток входа недопустимый приведет к учетной записи будет заблокирован. Значение по умолчанию — 10.

Если пользователь заблокирована, она не может выполнить вход до снятия блокировки администратором своей учетной записи. Когда пользователь будет заблокирован, `ValidateUser` будет метод *всегда* возвращают `False`, даже если допустимые учетные данные указаны. Хотя это уменьшает вероятность того, что злоумышленник будет разбить на веб-узла через методы подбора, может оказаться блокировки действительный пользователь, который просто забыл свой пароль или случайно Caps Lock или является наличие повезет ввода.

К сожалению нет не встроенное средство для разблокировки учетной записи пользователя. Чтобы разблокировать учетную запись, можно изменить базу данных непосредственно - изменять `IsLockedOut` в `aspnet_Membership` таблицы для учетной записи соответствующего пользователя — или создать веб-интерфейс, который перечисляет заблокированных учетных записей с параметрами для их разблокировки. Мы рассмотрим создание интерфейсов администратора для выполнения общих пользовательских задач, связанные с учетной записью и роли в дальнейших учебных курсах.

> [!NOTE]
> Единственным недостатком того `ValidateUser` метод является то, что если предоставленные учетные данные являются недопустимыми, он не поддерживает любой объяснение, почему. Учетные данные может быть недопустимым из-за без совпадающей пары имени пользователя и пароля в хранилище пользователя или пользователь еще не был утвержден, или пользователь был заблокирован. На шаге 4 мы увидим, как отображать более подробное сообщение для пользователя, после их неудачного входа.

## <a name="step-2-collecting-credentials-through-the-login-web-control"></a>Шаг 2. Сбор учетных данных через веб-элемента управления Login

[Входа веб-элемента управления](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx) отображает пользовательский интерфейс по умолчанию, очень похожий на тот, который мы создали в <a id="Tutorial02"> </a> [ *Обзор аутентификации форм* ](../introduction/an-overview-of-forms-authentication-vb.md) руководства. С помощью элемента управления Login позволяет экономить работу по необходимости создания интерфейса для получения учетных данных посетителя. Кроме того элемент управления Login автоматически входит в систему пользователя (при условии, что отправленные учетные данные допустимы), тем самым сохранение нам от необходимости написания кода.

Давайте обновим `Login.aspx`, заменив вручную созданный интерфейс и кодирование, элемент управления Login. Удалите существующую разметку и код в `Login.aspx`. Можно удалить прямо сейчас, или просто закомментируйте его. Чтобы закомментировать декларативная разметка, поместите его между `<%--` и `--%>` разделители. Эти разделители можно ввести вручную или, как показано на рис. 2, можно выбрать текст комментария, а затем нажмите кнопку Закомментировать выбранные строки значок на панели инструментов. Аналогичным образом закомментируйте значок выделенные строки можно использовать чтобы закомментировать выделенный код в классе фонового кода.

[![Закомментируйте существующий декларативной разметки и исходного кода на страницу Login.aspx](validating-user-credentials-against-the-membership-user-store-vb/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image4.png)

**Рис. 2**: Комментарий Out существующих декларативную разметку и исходного кода на страницу Login.aspx ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image6.png))

> [!NOTE]
> Закомментировать выбранные строки значок недоступен, при просмотре декларативная разметка в Visual Studio 2005. Если вы не используете Visual Studio 2008 необходимо вручную добавить `<%--` и `--%>` разделители.

Затем перетащите элемент управления Login из области элементов на страницу и задать его `ID` свойства `myLogin`. На этом этапе экран должен выглядеть аналогично рис. 3. Обратите внимание на то, что интерфейс по умолчанию элемент управления Login включает элементы управления текстового поля для имени пользователя и пароля, Запомнить меня в следующий раз флажок и кнопку в журнал. Существуют также `RequiredFieldValidator` элементы управления для двух текстовых полей.

[![Добавьте на страницу элемент управления Login](validating-user-credentials-against-the-membership-user-store-vb/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image7.png)

**Рис. 3**: Добавьте на страницу элемент управления Login ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image9.png))

И все готово! При нажатии кнопки входа элемента управления вход в систему, обратная передача будет выполняться и будет вызывать элемент управления Login `Membership.ValidateUser` , передавая введенное имя пользователя и пароль. Если учетные данные недействительны, элемент управления Login отображает сообщение о том, например. Если, однако учетные данные допустимы, элемент управления Login создает билет проверки подлинности форм и перенаправляет пользователя на соответствующую страницу.

Элемент управления Login использует четыре фактора для определения на соответствующую страницу, чтобы перенаправить пользователя после успешного входа:

- Элемент управления Login является ли на странице входа в соответствии с определением `loginUrl` Настройка проверки подлинности форм; этот параметр по умолчанию равно `Login.aspx`
- Наличие `ReturnUrl` параметр строки запроса
- Значение элемента управления Login [ `DestinationUrl` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx)
- `defaultUrl` Значение, указанное в формах параметры конфигурации проверки подлинности; значение по умолчанию этот параметр — Default.aspx

Рис. 4 показаны как элемент управления Login использует эти четыре параметра, можно перейти на соответствующую страницу решения.

[![Добавьте на страницу элемент управления Login](validating-user-credentials-against-the-membership-user-store-vb/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image10.png)

**Рис. 4**: Добавьте на страницу элемент управления Login ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image12.png))

Отвлекитесь и проверьте элемент управления Login с посещения веб-узла в обозревателе и входа в систему как существующего пользователя в структуру членства.

Интерфейс, готовый для просмотра элемент управления Login очень гибок в конфигурировании. Существует ряд свойств, которые влияют на его внешний вид; Более того элемент управления Login можно преобразовать в шаблон для точного контроля над макета элементов пользовательского интерфейса. В оставшейся части этого шага рассматривается настроить внешний вид и макет.

### <a name="customizing-the-login-controls-appearance"></a>Настройка внешнего вида элемента управления Login

Параметры свойств по умолчанию элемент управления Login визуализации пользовательского интерфейса с заголовком (вход), элементов управления TextBox и метки для входных данных имя пользователя и пароль, Запомнить мои время следующего флажок и кнопку входа. Внешний вид этих элементов, все можно настроить несколько свойств элемента управления Login. Кроме того можно добавить дополнительных элементах пользовательского интерфейса — например, укажите ссылку на страницу, чтобы создать учетную запись пользователя -, задав свойство или два.

Давайте потратить некоторое gussy вверх внешний вид наш элемент управления Login. Так как `Login.aspx` страницы уже есть текст в верхней части страницы входа, элемент управления Login title является излишним. Таким образом, очистите [ `TitleText` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx) значение, чтобы удалить заголовок элемента управления Login.

: Имя пользователя и пароль: Метки слева от два элемента управления TextBox можно настроить с помощью [ `UserNameLabelText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx) и [ `PasswordLabelText` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx), соответственно. Давайте изменим имя пользователя: Метка на чтение Username:. Стили метку и текстовое поле, можно настроить [ `LabelStyle` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx) и [ `TextBoxStyle` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx), соответственно.

Запомнить меня свойства Text далее флажок времени можно задать с помощью элемента управления Login [ `RememberMeText` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx), и значение по умолчанию проверяется состояние настраивается через [ `RememberMeSet` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx)(который по умолчанию — False). Дальше и установить `RememberMeSet` значение True, таким образом, чтобы Запомнить меня время следующего флажок будет установлен по умолчанию.

Элемент управления Login предлагает два свойства для подгонки макета его элементы управления пользовательского интерфейса. [ `TextLayout` Свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx) указывает, является ли имя пользователя: и пароль: Метки отображаются слева, их соответствующие текстовые поля (по умолчанию) или более высокого уровня. [ `Orientation` Свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx) указывает, расположены ли входные данные пользователя и пароль по вертикали (друг с другом) или по горизонтали. Я собираюсь эти два свойства, значения по умолчанию, но я советую вам попробовать установить эти два свойства для их значения по умолчанию, чтобы увидеть полученный результат.

> [!NOTE]
> В следующем разделе Настройка макета элемента управления Login, мы рассмотрим использование шаблонов для определения точную разметку элементов макета элемента управления пользовательского интерфейса.

Подведение итогов параметры свойств элемента управления Login, задав [ `CreateUserText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx) и [ `CreateUserUrl` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx) для не зарегистрирована? Создание учетной записи! и `~/Membership/CreatingUserAccounts.aspx`, соответственно. Это добавляет гиперссылку для интерфейса элемента управления Login, указывает на странице мы создали в <a id="Tutorial05"> </a> [предыдущем учебном курсе](creating-user-accounts-vb.md). Элемент управления Login [ `HelpPageText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx) и [ `HelpPageUrl` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx) и [ `PasswordRecoveryText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx) и [ `PasswordRecoveryUrl` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx) работают так же, ссылки на страницу справки и страницу восстановления пароля.

После внесения этих изменений свойств, декларативную разметку и внешний вид элемента управления входа в систему должен выглядеть, как показано на рис. 5.

[![Значения свойств элемента управления Login определяют его внешний вид](validating-user-credentials-against-the-membership-user-store-vb/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image13.png)

**Рис. 5**: Свойства элемента управления Login значения определяют его внешний вид ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image15.png))

### <a name="configuring-the-login-controls-layout"></a>Настройка макета элемента управления Login

Пользовательский интерфейс входа веб-элемента управления по умолчанию размещает интерфейсе в HTML- `<table>`. Но что делать, если нам нужен более точный контроль выводимых данных? Допустим, требуется заменить `<table>` последовательностью `<div>` теги. Или, что делать, если приложение требует дополнительные учетные данные для проверки подлинности? Финансовые многие веб-сайты, к примеру, пользователям необходимо указать не только имя пользователя и пароль, но также личный идентификационный номер (ПИН-код) или другие идентификационные сведения. Независимо от причины, возможно, его можно преобразовать в шаблон, из которого мы можно явным образом определить интерфейс декларативная разметка элемента управления Login.

Нам нужно выполнить два действия, чтобы обновить элемент управления Login для сбора дополнительных учетных данных:

1. Обновления интерфейса элемента управления Login для включения элементов управления Web, чтобы собирать дополнительные учетные данные.
2. Переопределение логики элемента управления Login внутренней проверки подлинности, таким образом, чтобы пользователь прошел только в том случае, если имя пользователя и пароль является допустимым, и их дополнительные учетные данные допустимы, слишком.

Для выполнения первой задачи, нам нужно преобразовать в шаблон элемента управления Login и добавьте необходимые веб-элементов управления. Как и для второй задачи, элемент управления Login логику проверки подлинности могут быть заменены Создание обработчика событий для элемента управления [ `Authenticate` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx).

Давайте обновим элемента управления Login, чтобы он запрашивает у пользователя ввести имя пользователя, пароль и адрес электронной почты и только проверяет подлинность пользователя, если предоставленный адрес электронной почты совпадает с адреса электронной почты для файла. Необходимо сначала преобразовать в шаблон элемента управления Login интерфейс. Смарт-теге элемента управления Login выберите Преобразовать в шаблон.

[![Преобразовать в шаблон элемента управления Login](validating-user-credentials-against-the-membership-user-store-vb/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image16.png)

**Рис. 6**: Преобразовать в шаблон элемента управления Login ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image18.png))

> [!NOTE]
> Чтобы восстановить состояние до версии предварительно template элемента управления Login, щелкните ссылку сброса смарт-теге элемента управления.

Преобразование элемента управления Login в шаблон добавляет `LayoutTemplate` чтобы декларативная разметка элемента управления с помощью HTML-элементов и определение пользовательского интерфейса в веб-элементов управления. Как показано на рис. 7, преобразование элемента управления в шаблон удаляет несколько свойств из окна свойств, таких как `TitleText`, `CreateUserUrl`, и т. д., так как значения этих свойств учитываются при использовании шаблона.

[![Меньше свойств, доступных при элемент управления Login преобразуется в шаблон](validating-user-credentials-against-the-membership-user-store-vb/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image19.png)

**Рис. 7**: Меньше свойств, доступных при элемент управления Login преобразуется в шаблон ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image21.png))

HTML-разметку в `LayoutTemplate` могут быть изменены по мере необходимости. Аналогичным образом вы можете добавить любые новые веб-элементов управления в шаблон. Тем не менее, очень важно, этот элемент управления Login core веб-элементы управления остаются в шаблон и сохранить назначенных им `ID` значения. В частности, не удалите или переименуйте `UserName` или `Password` текстовые поля, `RememberMe` флажок, `LoginButton` кнопки `FailureText` метку, или `RequiredFieldValidator` элементов управления.

Чтобы собрать посетителя адрес электронной почты, необходимо добавить текстовое поле в шаблон. Добавление следующей декларативной разметке между строкой таблицы (`<tr>`), содержащий `Password` текстового поля и строки таблицы, содержащий Запомнить меня рядом время флажок:

[!code-aspx[Main](validating-user-credentials-against-the-membership-user-store-vb/samples/sample2.aspx)]

После добавления `Email` TextBox, посетите страницу через обозреватель. Как показано на рис. 8, пользовательский интерфейс элемента управления Login теперь включает третьего текстового поля.

[![Элемент управления Login теперь включает текстовое поле для адреса электронной почты пользователя](validating-user-credentials-against-the-membership-user-store-vb/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image22.png)

**Рис. 8**: Элемент управления Login теперь включает текстовое поле для адреса электронной почты пользователя ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image24.png))

На этом этапе по-прежнему используется элемент управления Login `Membership.ValidateUser` метод, чтобы проверить предоставленные учетные данные. Соответственно, значение, введенное в `Email` TextBox не имеет отношения к ли пользователь может войти. На шаге 3 мы рассмотрим переопределение логики проверки подлинности элемента управления Login, чтобы учетные данные, только считаются допустимыми, если имя пользователя и пароль являются допустимыми и соотносит адрес эл с адресом электронной почты на файл.

## <a name="step-3-modifying-the-login-controls-authentication-logic"></a>Шаг 3. Изменение элемента управления Login логику проверки подлинности

Когда посетитель предоставляет ей учетные данные и щелчков, обратная передача «вход», обратную передачу и имя входа управления проходит через рабочий процесс проверки подлинности. Рабочий процесс начинается, вызывая [ `LoggingIn` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx). Все обработчики событий, связанные с этим событием может отменить операции входа, задав `e.Cancel` свойства `True`.

Если в журнале в операции не отменяется, рабочий процесс продвижения, вызывая [ `Authenticate` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx). Если имеется обработчик событий для `Authenticate` события, то он отвечает за определение, являются ли указанные учетные данные допустимыми. Если ни один обработчик событий, использует элемент управления Login `Membership.ValidateUser` метод для определения действительности учетных данных.

Если предоставленные учетные данные являются допустимыми, то создается билета проверки подлинности, [ `LoggedIn` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx) возникает, и пользователь перенаправляется на соответствующую страницу. Если, однако учетные данные считаются недопустимыми, то [ `LoginError` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx) возникает и отображается сообщение, информирующее пользователя, что их учетные данные были недопустимыми. По умолчанию при сбое входа управления просто устанавливает его `FailureText` метки свойство Text элемента управления, чтобы сообщение о сбое (попытку входа в систему не удалось. Повторите попытку позже). Тем не менее если элемент управления Login [ `FailureAction` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx) присваивается `RedirectToLoginPage`, затем управления проблем со входом `Response.Redirect` на страницу входа, добавив параметр строки запроса `loginfailure=1` (что приводит к имени входа элемент управления для отображения сообщений о сбое).

Рис. 9 предлагает блок-схема рабочего процесса проверки подлинности.

[![Рабочий процесс проверки подлинности имени входа элемента управления](validating-user-credentials-against-the-membership-user-store-vb/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image25.png)

**Рис. 9**: Рабочий процесс проверки подлинности имени входа элемента управления ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image27.png))

> [!NOTE]
> Если вас интересует, для чего используется `FailureAction`в `RedirectToLogin` странице параметр, рассмотрим следующий сценарий. Сейчас наши `Site.master` Главная страница в данный момент имеет текст, Hello, stranger отображается в левом столбце, открываемая при анонимного пользователя, но представьте себе, что мы хотели бы замените этот текст в элемент управления Login. Это позволит анонимным пользователям войти на любой странице на сайте, а не непосредственно на странице входа. Тем не менее, если пользователь не удалось войти в систему через элемент управления Login, преобразовываемый для главной страницы, он может быть целесообразно перенаправит их на страницу входа (`Login.aspx`) так, как, скорее всего, страница включает дополнительные инструкции, ссылок и других "Справка" — например ссылки на создание Новая учетная запись или получить утраченный пароль -, не были добавлены на главную страницу.

### <a name="creating-theauthenticateevent-handler"></a>Создание`Authenticate`обработчик событий

Чтобы подключить логику настраиваемой проверки подлинности, нам нужно создать обработчик событий для элемента управления Login `Authenticate` событий. Создание обработчика событий для `Authenticate` событий создаст следующее определение обработчика событий:

[!code-vb[Main](validating-user-credentials-against-the-membership-user-store-vb/samples/sample3.vb)]

Как вы видите, `Authenticate` обработчику события передаются в объект типа [ `AuthenticateEventArgs` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx) как второй входной параметр. `AuthenticateEventArgs` Класс содержит логическое свойство с именем `Authenticated` , используемый для указания, допустимы ли указанные учетные данные. Наша задача будет писать код здесь, определяющее, являются ли указанные учетные данные допустимыми, а также задать `e.Authenticate` свойство соответствующим образом.

### <a name="determining-and-validating-the-supplied-credentials"></a>Определение и проверка предоставленные учетные данные

Используйте элемент управления Login [ `UserName` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx) и [ `Password` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx) определить учетные данные имени пользователя и пароль, введенный пользователем. Чтобы определить значения, вводимые в дополнительных элементов управления Web (такие как `Email` TextBox, мы добавили на предыдущем шаге), использовать `LoginControlID.FindControl`(» *`controlID`* «) для получения программную ссылку на веб-узле элемент управления в шаблоне `ID` равно *`controlID`* . Например, чтобы получить ссылку на `Email` текстового поля, используйте следующий код:

`Dim EmailTextBox As TextBox = CType(myLogin.FindControl("Email"), TextBox)`

Чтобы проверить учетные данные пользователя, нам нужно сделать две вещи:

1. Убедитесь, что указанное имя пользователя и пароль являются допустимыми
2. Убедитесь, что введенный адрес электронной почты совпадает с адресом электронной почты в файл пытаются войти в систему пользователя

Для выполнения первой проверки, можно просто использовать `Membership.ValidateUser` метод, как мы видели в шаге 1. Для второй проверки мы должны определить адрес электронной почты пользователя, таким образом, чтобы его можно сравнить на адрес электронной почты, введенные в элементе управления TextBox. Чтобы получить сведения о конкретном пользователе, используйте `Membership` класса [ `GetUser` метод](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx).

`GetUser` Метод имеет несколько перегрузок. При использовании без передачи в любые параметры, он возвращает сведения о пользователе, выполнившего вход. Чтобы получить сведения о конкретном пользователе, вызывать `GetUser` передавая свое имя пользователя. В любом случае `GetUser` возвращает [ `MembershipUser` объект](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), который имеет свойства, такие как `UserName`, `Email`, `IsApproved`, `IsOnline`, и т. д.

Следующий код реализует эти две проверки. Если оба передачи, затем `e.Authenticate` присваивается `True`, в противном случае ему назначается `False`.

[!code-vb[Main](validating-user-credentials-against-the-membership-user-store-vb/samples/sample4.vb)]

Этот код в месте попытайтесь войти в качестве допустимого пользователя, введя правильные имя пользователя, пароль и адрес электронной почты. Попробуйте еще раз, но намеренно на этот раз используйте неправильный адрес электронной почты (см. рис. 10). Наконец попробуйте сделать это третий раз, с указанием имени пользователя не существует. В первом случае пользователь должен успешно войти на сайт, но в последних двух случаях вы должны увидеть сообщение недопустимые учетные данные входа элемента управления.

[![Tito не удается войти, указывая неправильный адрес электронной почты](validating-user-credentials-against-the-membership-user-store-vb/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image28.png)

**Рис. 10**: Tito нельзя журнала в при указав неверный адрес электронной почты ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image30.png))

> [!NOTE]
> Как описано в разделе как членство Framework обрабатывает недопустимые попытки входа на шаге 1, когда `Membership.ValidateUser` вызывается метод и передать недопустимые учетные данные, он отслеживает Неудачная попытка входа и блокирует работу пользователя, если они превышают определенную Пороговое значение попыток в течение указанного интервала. Так как вызовы логики настраиваемой проверки подлинности `ValidateUser` метод, неправильный пароль для допустимое имя пользователя будет увеличивает счетчик попыток недопустимое имя для входа, но этот счетчик не увеличивается в случае, если имя пользователя и пароль допустимы, но Неправильный адрес электронной почты. Скорее всего, это подходит, так как маловероятно, что злоумышленник будет знать имя пользователя и пароль, но нужно использовать методики подбора, чтобы определить адрес электронной почты пользователя.

## <a name="step-4-improving-the-login-controls-invalid-credentials-message"></a>Шаг 4. Улучшение управления Login недопустимые учетные данные сообщения

Когда пользователь пытается выполнить вход с использованием недопустимых учетных данных, элемент управления Login отображается сообщение, объясняющее, что попытка входа была неудачной. В частности, элемент управления отображает сообщение, заданное параметром его [ `FailureText` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx), который имеет значение по умолчанию попытку входа не удалась. Повторите попытку.

Вспомните, что есть много причин, почему учетные данные пользователя может быть недопустимым:

- Имя пользователя не существует
- Имя пользователя существует, но пароль является недопустимым
- Имя пользователя и пароль являются допустимыми, но пользователь еще не утверждено
- Имя пользователя и пароль являются допустимыми, но пользователь заблокирован out (скорее всего, так как оно превышает количество попыток недопустимое имя для входа в течение указанного промежутка времени)

Также может возникнуть по другим причинам при использовании логики настраиваемой проверки подлинности. К примеру с помощью кода мы создали на шаге 3, имя пользователя и пароль могут быть допустимы, но адрес электронной почты могут быть неправильными.

Независимо от того, почему учетные данные недействительны элемент управления Login отображается такое сообщение об ошибке. Отсутствие обратной связи может вызывать трудности для пользователя, чья учетная запись еще не был утвержден или кто заблокирована. С небольшой фрагмент работы Однако мы может иметь сообщение более подходящего элемента управления Login.

Каждый раз, когда пользователь пытается войти в систему с недействительными учетными данными, элемент управления Login вызывает его `LoginError` событий. Действуйте и создайте обработчик событий для этого события и добавьте следующий код:

[!code-vb[Main](validating-user-credentials-against-the-membership-user-store-vb/samples/sample5.vb)]

Приведенный выше код начинается с настройки элемента управления Login `FailureText` свойство, значение по умолчанию (попытку входа в систему не удалось. Повторите попытку позже). Затем он проверяет, если предоставленное имя пользователя сопоставляется с существующей учетной записи. Если таким образом, она учитывает итоговый `MembershipUser` объекта `IsLockedOut` и `IsApproved` свойства, чтобы определить, если учетная запись была заблокирована или не был утвержден. В любом случае `FailureText` свойство обновляется в соответствующее значение.

Чтобы протестировать этот код, намеренно попытаться войдите в качестве существующего пользователя, но использовать неправильный пароль. Сделать это в пять раз подряд в течение 10-минутного промежутка времени, и учетная запись будет заблокирована. Как показано на рис. 11, входа последующие попытки будут всегда (даже с правильным паролем) при сбое, теперь отображаются более описательное учетную запись была заблокирована из-за слишком много попыток входа. Обратитесь к администратору, чтобы настроить сообщение разблокировать учетную запись.

[![Tito выполняется слишком много попыток входа и была заблокирована](validating-user-credentials-against-the-membership-user-store-vb/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-vb/_static/image31.png)

**Рис. 11**: Tito выполняется слишком много недопустимые попытки входа и имеет был заблокирован Out ([Просмотр полноразмерного изображения](validating-user-credentials-against-the-membership-user-store-vb/_static/image33.png))

## <a name="summary"></a>Сводка

Предыдущий будем нашу страницу входа проверить предоставленные учетные данные от жестко список пар "имя пользователя/пароль". В этом руководстве мы обновили страницы, чтобы проверить учетные данные от структуры членства. На шаге 1, мы рассмотрели применение `Membership.ValidateUser` метод программным способом. На шаге 2 мы заменили наших созданные вручную пользовательского интерфейса и кода с помощью элемента управления Login.

Элемент управления Login предоставляет интерфейс пользователя, стандартное имя входа и автоматически проверяет учетные данные пользователя на платформу членства. Кроме того в случае действительные учетные данные, элемент управления Login выполняет вход пользователя с помощью проверки подлинности форм. Короче говоря в пользовательском интерфейсе полностью функциональной входа доступна, просто перетащив элемент управления Login на страницы, не очень декларативную разметку или код, необходимый. Что такое дополнительные, элемент управления Login широкие возможности настройки, что обеспечивает высокую степень контроля над обоих готовый для просмотра пользователем интерфейс и логика проверки подлинности.

На этом этапе посетителей нашего веб-сайта можно создать новую учетную запись пользователя и журнала в веб-узел, но у нас есть еще рассмотреть ограничения доступа к страницам, в зависимости от прошедшего проверку подлинности пользователя. В настоящее время любого пользователя, прошедшего проверку подлинности или анонимные, можно просмотреть любую страницу на нашем сайте. А также управление доступом на нашем сайте страницы на основе пользователя по, мы возможно, некоторые страницы, функциональность которого зависит от пользователя. Следующем учебном курсе рассказывается, как ограничить доступ и функций на странице в зависимости от текущего пользователя.

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Отображение пользовательских сообщений заблокирована и неутвержденного пользователей](http://aspnet.4guysfromrolla.com/articles/050306-1.aspx)
- [Изучение ASP.NET 2.0 членства, ролей и профиля](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Практическое руководство. Создание страницы входа ASP.NET](https://msdn.microsoft.com/library/ms178331.aspx)
- [Техническая документация для элемента управления Login](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)
- [С помощью элементов управления входом](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/login.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* . Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Терезой Мерфи и Майкл Olivero, стали Лиз Шалок в этом руководстве. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4GuysFromRolla.com).

> [!div class="step-by-step"]
> [Назад](creating-user-accounts-vb.md)
> [Вперед](user-based-authorization-vb.md)
