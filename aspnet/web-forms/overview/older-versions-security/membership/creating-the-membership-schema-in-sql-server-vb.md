---
uid: web-forms/overview/older-versions-security/membership/creating-the-membership-schema-in-sql-server-vb
title: Создание схемы членства в SQL Server (Visual Basic) | Документация Майкрософт
author: rick-anderson
description: Этот учебник начинает проверять методы для добавления необходимую схему в базу данных для использования SqlMembershipProvider. После этого мы wi...
ms.author: riande
ms.date: 01/18/2008
ms.assetid: 112a674d-716f-41a6-99b8-4074d65a54c0
msc.legacyurl: /web-forms/overview/older-versions-security/membership/creating-the-membership-schema-in-sql-server-vb
msc.type: authoredcontent
ms.openlocfilehash: 62a6113c9ddad1722160c7092308939cf7883588
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57055471"
---
<a name="creating-the-membership-schema-in-sql-server-vb"></a>Создание схемы членства в SQL Server (VB)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_04_VB.zip) или [скачать PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial04_MembershipSetup_vb.pdf)

> Этот учебник начинает проверять методы для добавления необходимую схему в базу данных для использования SqlMembershipProvider. После этого мы проверка ключей таблиц в схеме и обсудить их назначении и важности. Этот учебник завершает со взгляда на инструкции по определению приложения ASP.NET, какой поставщик, следует использовать платформу членства.


## <a name="introduction"></a>Вступление

Двух предыдущих учебных при просмотре с помощью проверки подлинности форм для идентификации посетителей веб-сайта. Структуры проверки подлинности forms упрощает для разработчиков для входа пользователя в веб-сайт и запомнить их посещений страницы при помощи билеты проверки подлинности. `FormsAuthentication` Класс включает методы для генерации билета и его добавления к файлам cookie посетителя. `FormsAuthenticationModule` Проверяет все входящие запросы и для тех, с помощью билета проверки подлинности, создает и связывает `GenericPrincipal` и `FormsIdentity` объект с текущим запросом. Проверка подлинности форм — просто в механизм предоставления билет проверки подлинности пользователь при входе в и при последующих запросах, синтаксический анализ Этот билет для определения удостоверения пользователя. Для веб-приложения для поддержки учетных записей пользователей по-прежнему необходимо реализовать пользовательского хранилища и расширяют его функциональные возможности проверить учетные данные, регистрировать новых пользователей и множество других пользовательских задач, связанные с учетной записью.

До версии ASP.NET 2.0 разработчикам было на ком оно висит для реализации всех этих задач связанные с учетной записью пользователя. К счастью, группа разработчиков ASP.NET распознан этот недостаток и появился структуру членства в ASP.NET 2.0. Структуру членства — это набор классов в .NET Framework, предоставляющие программный интерфейс для выполнения основных задач, связанных с учетной записи пользователя. Эта платформа строится поверх [модель поставщика](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx), что позволяет разработчикам подключать настраиваемую реализацию стандартизированный API-Интерфейс.

Как уже говорилось в <a id="Tutorial1"> </a> [ *основы управления и поддержки ASP.NET* ](../introduction/security-basics-and-asp-net-support-vb.md) учебник, в .NET Framework поставляется с двумя встроенными поставщиками членства: [ `ActiveDirectoryMembershipProvider` ](https://msdn.microsoft.com/library/system.web.security.activedirectorymembershipprovider.aspx) и [ `SqlMembershipProvider` ](https://msdn.microsoft.com/library/system.web.security.sqlmembershipprovider.aspx). Как понятно из названия, `SqlMembershipProvider` использует базу данных Microsoft SQL Server в качестве хранилища пользователя. Чтобы использовать этот поставщик в приложении, нам нужно указать поставщику, какую базу данных для использования в качестве хранилища. Как можно себе представить, `SqlMembershipProvider` ожидает, что базе данных хранилища пользователя, чтобы определенные таблицы базы данных, представления и хранимые процедуры. Необходимо добавить этот ожидаемую схему для выбранной базы данных.

Этот учебник начинает проверять методы для добавления необходимую схему в базу данных для использования `SqlMembershipProvider`. После этого мы проверка ключей таблиц в схеме и обсудить их назначении и важности. Этот учебник завершает со взгляда на инструкции по определению приложения ASP.NET, какой поставщик, следует использовать платформу членства.

Давайте начнем!

## <a name="step-1-deciding-where-to-place-the-user-store"></a>Шаг 1. Принятия решения о расположении пользователя Store

Приложения ASP.NET данные обычно хранятся в несколько таблиц в базе данных. При реализации `SqlMembershipProvider` схемы базы данных, нам необходимо решить, следует ли заключать схемы членства в той же базе данных, как данные приложения или в альтернативную базу данных.

Я рекомендую, поиск схемы членства в той же базе данных, как данные приложения по следующим причинам:

- **Удобство поддержки** приложения, данные которых инкапсулируется в одной базе данных проще понять, обслуживании и развертывании чем приложения, которое содержит две отдельные базы данных.
- **Реляционной целостности** , найдя в таблицах, связанных с членством в той же базе данных, как приложение таблицы, он является возможность установления [ограничения внешнего ключа](http://en.wikipedia.org/wiki/Foreign_key) первичных ключей в Таблицы, связанные с членством и связанный с приложением таблицы.

Разделение данных хранилища и приложения пользователя в разных базах данных имеет смысл только при наличии нескольких приложений, что каждый используются отдельные базы данных, но должны совместно использовать общее хранилище пользователя.

### <a name="creating-a-database"></a>Создание базы данных

Приложение, которое мы занимаются созданием так как второе руководство еще не обязательно базы данных. Вам понадобится один, тем не менее, для хранилища пользователя. Давайте создайте ее, а затем добавьте к нему схему, необходимую `SqlMembershipProvider` поставщика (см. шаг 2).

> [!NOTE]
> Данной серии учебных курсов мы будем использовать [Microsoft SQL Server 2005 Express Edition](https://msdn.microsoft.com/sql/Aa336346.aspx) базу данных для хранения наших таблиц приложений и `SqlMembershipProvider` схемы. Было принято это решение по двум причинам: во-первых, из-за его стоимости — бесплатная версия — Express Edition — это наиболее легче читаются, доступный версия SQL Server 2005; Во-вторых, базы данных SQL Server 2005 Express Edition можно поместить непосредственно в веб-приложения `App_Data` папку, что делает несложной упаковка базы данных и веб-приложения в один ZIP-файл и повторно развернуть ее без специальной настройки инструкции или параметры конфигурации. Если вы предпочитаете для выполнения этой процедуры с помощью экспресс-выпуск не - версии SQL Server, вы можете. Действия практически идентичны. `SqlMembershipProvider` Схемы будет работать с любой версией Microsoft SQL Server 2000 и до.

В обозревателе решений щелкните правой кнопкой мыши `App_Data` папку и выберите команду Добавить новый элемент. (Если вы не видите `App_Data` в проекте, щелкните правой кнопкой мыши проект в обозревателе решений, выберите Добавить папку ASP.NET и выбрать `App_Data`.) В диалоговом окне Add New Item выберите, чтобы добавить новую базу данных SQL с именем `SecurityTutorials.mdf`. В этом руководстве мы добавим `SqlMembershipProvider` схемы к этой базе данных; в последующих руководствах мы создадим дополнительных таблиц для захвата наши данные приложения.


[![Добавить новую базу данных SQL с именем SecurityTutorials.mdf базы данных в папку App_Data](creating-the-membership-schema-in-sql-server-vb/_static/image2.png)](creating-the-membership-schema-in-sql-server-vb/_static/image1.png)

**Рис. 1**: Добавление новой базы данных SQL с именем `SecurityTutorials.mdf` базы данных для `App_Data` папку ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image3.png))


Добавление базы данных к `App_Data` папки автоматически включит его в представлении обозревателя базы данных. (В экспресс-выпуск не - версии Visual Studio, обозреватель баз данных называется обозревателя серверов). Перейдите в обозреватель базы данных и разверните узел только что добавленные `SecurityTutorials` базы данных. Если вы не видите обозреватель баз данных на экране, перейдите к меню "Вид" и выберите Обозреватель баз данных или нажмите сочетание клавиш Ctrl + Alt + S. Как показано на рис. 2, `SecurityTutorials` база данных пуста — он содержит ни одной таблицы, нет представлений и хранимых процедур.


[![Базы данных SecurityTutorials сейчас пуст.](creating-the-membership-schema-in-sql-server-vb/_static/image5.png)](creating-the-membership-schema-in-sql-server-vb/_static/image4.png)

**Рис. 2**: `SecurityTutorials` Базы данных сейчас пуст ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image6.png))


## <a name="step-2-adding-thesqlmembershipproviderschema-to-the-database"></a>Шаг 2. Добавление`SqlMembershipProvider`схемы в базу данных

`SqlMembershipProvider` Требует определенный набор таблиц, представлений и хранимых процедур для установки в пользовательской базе данных хранилища. Эти объекты необходимые базы данных могут добавляться с помощью [ `aspnet_regsql.exe` средство](https://msdn.microsoft.com/library/ms229862.aspx). Этот файл находится в `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\` папку.

> [!NOTE]
> `aspnet_regsql.exe` Средство предоставляет графический пользовательский интерфейс и функции командной строки. Графический интерфейс — более понятные и что будут рассмотрены в этом руководстве. Интерфейс командной строки используется при добавлении `SqlMembershipProvider` схему необходимо автоматизировать, например сборки скрипты или автоматические сценарии тестирования.

`aspnet_regsql.exe` Средство используется для добавления или удаления *служб приложений ASP.NET* в указанную базу данных SQL Server. Службы приложения ASP.NET включают схемы для `SqlMembershipProvider` и `SqlRoleProvider`, а также схем для поставщиков на базе SQL для других платформ ASP.NET 2.0. Необходимо предоставить два бита информации для `aspnet_regsql.exe` средство:

- Нужно ли добавлять или удалять приложения службы, и
- Схема служб базы данных, из которой нужно добавить или удалить приложение

В выполнении запроса на ее использование, `aspnet_regsql.exe` средство запрос на указание имени сервера базы данных размещаются на учетные данные безопасности для подключения к базе данных и имя базы данных. Если вы используете в не - экспресс выпуск SQL Server, вы уже знаете эти сведения, так как это те же сведения, которые нужно указать в строке подключения при работе с базой данных через веб-страницу ASP.NET. Определение имени сервера и базы данных, при использовании базы данных SQL Server 2005 Express Edition в `App_Data` папку, но немного сложнее.

В следующем разделе рассматриваются простым способом для указания имени сервера и базы данных для базы данных SQL Server 2005 Express Edition в `App_Data` папку. Если вы не используете SQL Server 2005 Express Edition Вы можете сразу перейти к установке в разделе службы приложений.

### <a name="determining-the-server-and-database-name-for-a-sql-server-2005-express-edition-database-in-theappdatafolder"></a>Определить имена сервера и базы данных для базы данных экспресс-выпуск SQL Server 2005 в`App_Data`папки

Чтобы использовать `aspnet_regsql.exe` средство, нам нужно знать имена сервера и базы данных. Имя сервера — `localhost\InstanceName`. Скорее всего, *InstanceName* является `SQLExpress`. Тем не менее если вы вручную установили SQL Server 2005 Express Edition (то есть вы не устанавливали его автоматически при установке Visual Studio), то может возникнуть ситуация, что вы выбрали другое имя экземпляра.

Имя базы данных будет несколько сложнее определить. Баз данных в `App_Data` папку обычно имеют имя базы данных, который включает в себя [глобальный уникальный идентификатор](http://en.wikipedia.org/wiki/Globally_Unique_Identifier) вместе с путем к файлу базы данных. Нам нужно определить имя этой базы данных, чтобы добавить схему службы приложений через `aspnet_regsql.exe`.

Самый простой способ выяснить имя базы данных — в том, чтобы изучить его через SQL Server Management Studio. SQL Server Management Studio предоставляет графический интерфейс для управления базами данных SQL Server 2005, но он не входит в состав Express Edition SQL Server 2005. Хорошая новость в том, что [можно загрузить](https://www.microsoft.com/downloads/details.aspx?FamilyId=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796&amp;displaylang=en) бесплатный Express Edition из SQL Server Management Studio.

> [!NOTE]
> Если у вас также есть экспресс-выпуск не - версию SQL Server 2005 установлен на рабочем столе, то скорее всего установлена полная версия Management Studio. Полную версию можно использовать для определения имени базы данных, выполните те же действия, как описано ниже, для экспресс-выпуск.

Сначала необходимо закрыть Visual Studio, чтобы убедиться, что закрыты все блокировки, наложенные Visual Studio в файле базы данных. Затем запустите SQL Server Management Studio и подключитесь к `localhost\InstanceName` базы данных для SQL Server 2005 Express Edition. Как отмечалось ранее, скорее всего, имя экземпляра должно `SQLExpress`. Для проверки подлинности выберите проверку подлинности Windows.


[![Подключитесь к экземпляру SQL Server 2005, экспресс-выпуск](creating-the-membership-schema-in-sql-server-vb/_static/image8.png)](creating-the-membership-schema-in-sql-server-vb/_static/image7.png)

**Рис. 3**: Подключение к экземпляру SQL Server 2005 Express Edition ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image9.png))


После подключения к экземпляру SQL Server 2005 Express Edition, Management Studio отображаются папки для базы данных, параметры безопасности, серверные объекты и т. д. Если развернуть вкладку базы данных вы увидите, что `SecurityTutorials.mdf` база данных является *не* зарегистрированным в экземпляре базы данных -, нам нужно сначала присоединить базу данных.

Щелкните правой кнопкой мыши на папку базы данных и выберите присоединение в контекстном меню. Откроется диалоговое окно Присоединение баз данных. На этой странице нажмите кнопку "Добавить", перейдите к `SecurityTutorials.mdf` базы данных и нажмите кнопку ОК. Рис. 4 показано диалоговое окно Присоединение баз данных после `SecurityTutorials.mdf` выбрать базу данных. Рис. 5 показан в обозревателе объектов среды Management Studio после присоединения базы данных.


[![Присоедините базу данных SecurityTutorials.mdf](creating-the-membership-schema-in-sql-server-vb/_static/image11.png)](creating-the-membership-schema-in-sql-server-vb/_static/image10.png)

**Рис. 4**: Присоединение `SecurityTutorials.mdf` базы данных ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image12.png))


[![SecurityTutorials.mdf базы данных появится в папке базы данных](creating-the-membership-schema-in-sql-server-vb/_static/image14.png)](creating-the-membership-schema-in-sql-server-vb/_static/image13.png)

**Рис. 5**: `SecurityTutorials.mdf` Базы данных появится в папке базы данных ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image15.png))


Как показано на рис. 5, `SecurityTutorials.mdf` базы данных имеет имя, а abstruse. Давайте изменим его, чтобы легче запоминать (и проще набирать) имя. Щелкните правой кнопкой мыши, в базе данных, выберите команду "Переименовать" в контекстном меню и переименуйте его `SecurityTutorialsDatabase`. При этом не изменяется имя файла, имени базы данных использует для собственной идентификации в SQL Server.


[![Переименовать базу данных для SecurityTutorialsDatabase](creating-the-membership-schema-in-sql-server-vb/_static/image17.png)](creating-the-membership-schema-in-sql-server-vb/_static/image16.png)

**Рис. 6**: Переименовать базу данных для `SecurityTutorialsDatabase`([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image18.png))


На этом этапе мы знаем, имена сервера и базы данных для `SecurityTutorials.mdf` файл базы данных: `localhost\InstanceName` и `SecurityTutorialsDatabase`, соответственно. Теперь мы готовы установить службами приложений через `aspnet_regsql.exe` средство.

### <a name="installing-the-application-services"></a>Установка служб приложений

Чтобы запустить `aspnet_regsql.exe` средство, перейдите в меню "Пуск" и выберите Run. Введите `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\aspnet_regsql.exe` в текстовое поле и нажмите кнопку ОК. Кроме того, можно использовать Windows Explorer детализировать углублением соответствующую папку и дважды щелкните `aspnet_regsql.exe` файл. Любой из этих подходов будет net те же результаты.

Под управлением `aspnet_regsql.exe` графического пользовательского интерфейса ASP.NET мастер установки SQL Server запускает средство без аргументов командной строки. Мастер позволяет легко добавлять или удалять службы приложения ASP.NET в указанной базе данных. Первый экран мастера, показанный на рис. 7, описывающая назначение инструмента.


[![Используйте программу установки мастер ASP.NET SQL Server делает для добавления схемы членства](creating-the-membership-schema-in-sql-server-vb/_static/image20.png)](creating-the-membership-schema-in-sql-server-vb/_static/image19.png)

**Рис. 7**: Используйте ASP.NET SQL Server создает программа установки мастера для добавления схемы членства ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image21.png))


Второй шаг в мастере запрашивает ли мы хотим добавить службы приложений или удалить их. Поскольку мы хотим добавить таблицы, представления и хранимые процедуры, необходимые для `SqlMembershipProvider`, выбрать SQL Server настройте для параметра службы приложений. Позже Если вы хотите удалить эту схему из базы данных, повторно запустите этот мастер, но вместо этого выбрать сведения о службах удаление приложений из существующего параметра базы данных.


[![Нажмите кнопку настроить для приложения служб SQL Server](creating-the-membership-schema-in-sql-server-vb/_static/image23.png)](creating-the-membership-schema-in-sql-server-vb/_static/image22.png)

**Рис. 8**: Выберите SQL Server можно настроить для параметра службы приложений ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image24.png))


Третий шаг запрашивает сведения о базе данных: имя сервера, сведения о проверке подлинности и имя базы данных. Если действия с этим руководством и добавили `SecurityTutorials.mdf` базы данных для `App_Data`, присоединена к `localhost\InstanceName`и переименован в `SecurityTutorialsDatabase`, затем используйте следующие значения:

- Сервер: `localhost\InstanceName`
- Аутентификация Windows
- База данных: `SecurityTutorialsDatabase`


[![Введите сведения о базе данных](creating-the-membership-schema-in-sql-server-vb/_static/image26.png)](creating-the-membership-schema-in-sql-server-vb/_static/image25.png)

**Рис. 9**: Введите сведения о базе данных ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image27.png))


После ввода сведений о базе данных, нажмите кнопку "Далее". Последним шагом описаны шаги, которые будут выполнены. Для установки службы приложений и завершите работу мастера, нажмите кнопку "Далее".

> [!NOTE]
> Если вы использовали Management Studio для присоединения базы данных и переименуйте файл базы данных, не забудьте отсоединить базу данных и закройте Management Studio, прежде чем повторно открыть Visual Studio. Чтобы отключить `SecurityTutorialsDatabase` базы данных, щелкните правой кнопкой мыши имя базы данных и, в меню "задачи", выберите команду отсоединения.

После завершения работы мастера вернитесь в Visual Studio и перейдите в обозревателе базы данных. Разверните папку «таблицы». Вы увидите несколько таблиц, имена которых начинаются с префикса `aspnet_`. Аналогично широкий набор представлений и хранимых процедур можно найти в папках, представления и хранимые процедуры. Эти объекты базы данных, составляющие схему службы приложения. Мы рассмотрим объекты конкретного членство и роли базы данных на шаге 3.


[![Широкий набор таблиц, представлений и хранимых процедур были добавлены в базу данных](creating-the-membership-schema-in-sql-server-vb/_static/image29.png)](creating-the-membership-schema-in-sql-server-vb/_static/image28.png)

**Рис. 10**: В различные таблицы, представления и хранимые процедуры были добавлены в базу данных ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image30.png))


> [!NOTE]
> `aspnet_regsql.exe` Графический пользовательский интерфейс программы устанавливает схему служб всего приложения. Но при выполнении `aspnet_regsql.exe` из командной строки можно указать, какие конкретного приложения служб компонентов для установки (или удаления). Таким образом, если вы хотите добавить только таблицы, представления и хранимых процедур, необходимых для `SqlMembershipProvider` и `SqlRoleProvider` поставщиков, запустите `aspnet_regsql.exe` из командной строки. Кроме того, вы можете вручную запустить соответствующий подмножество T-SQL создания сценариев, используемых `aspnet_regsql.exe`. Эти сценарии находятся в `WINDIR%\Microsoft.Net\Framework\v2.0.50727\` папки с именами вида `InstallCommon.sql`, `InstallMembership.sql`, `InstallRoles.sql`, `InstallProfile.sql`, `InstallSqlState.sql`, и т. д.

На этом этапе мы создали объекты базы данных, необходимые `SqlMembershipProvider`. Тем не менее, мы по-прежнему необходимо указать структуру членства, следует использовать `SqlMembershipProvider` (и, скажем, `ActiveDirectoryMembershipProvider`) и что `SqlMembershipProvider` следует использовать `SecurityTutorials` базы данных. Мы рассмотрим способы указания какой поставщик для использования и как настроить параметры выбранного поставщика на шаге 4. Но сначала давайте подробнее рассмотрим объекты базы данных, которые были только что создали.

## <a name="step-3-a-look-at-the-schemas-core-tables"></a>Шаг 3. Краткий обзор схемы основных таблиц

При работе с платформами членства и ролей в приложении ASP.NET, детали реализации инкапсулированы поставщиком. В будущих учебных курсах, мы будет взаимодействовать с помощью этих платформ с помощью платформы .NET Framework `Membership` и `Roles` классы. При использовании этих API высокого уровня нам не нужно заниматься сами низкоуровневые детали, как выполняются запросы или изменения какие таблицы с `SqlMembershipProvider` и `SqlRoleProvider`.

Учитывая это, мы может уверенно использовать членства и ролей платформы без изучать схему базы данных, созданного на шаге 2. Тем не менее при создании таблицы для хранения данных приложений мы может потребоваться создать сущности, которые относятся к пользователям и ролям. Необходимо иметь хорошее знание `SqlMembershipProvider` и `SqlRoleProvider` схем при создании внешнего ключа ограничения между таблицами данных приложения и эти таблицы, созданные на шаге 2. Кроме того, в некоторых редких случаях нам может понадобиться для взаимодействия с пользователем и сохраняет роли на уровне базы данных (вместо использования `Membership` или `Roles` классы).

### <a name="partitioning-the-user-store-into-applications"></a>Секционирование Store пользователей в приложения

На платформах членства и ролей разработаны таким образом, что одно хранилище пользователя и роли могут совместно использоваться множества различных приложений. Приложение ASP.NET, использующее платформы членства или ролей необходимо указать, какие секции приложения для использования. Короче говоря нескольких веб-приложений можно использовать одинаковые хранилища пользователя и роли. Рис. 11 показана хранилищ пользователя и роли, на которые секционируются в три приложения: HRSite CustomerSite и SalesSite. Эти три веб-приложения каждого имеют собственные уникальных пользователей и ролей, но все они физически хранить учетные данные учетной записи и роли в тех же таблицах базы данных.


[![Учетные записи пользователей, которые могут быть секционированы несколькими приложениями](creating-the-membership-schema-in-sql-server-vb/_static/image32.png)](creating-the-membership-schema-in-sql-server-vb/_static/image31.png)

**Рис. 11**: Пользователя учетные записи могут быть секционированы по несколько приложений ([Просмотр полноразмерного изображения](creating-the-membership-schema-in-sql-server-vb/_static/image33.png))


`aspnet_Applications` Таблица является то, что определяет этих секций. Строки в этой таблице представлены каждого приложения, которое использует базу данных для хранения учетных записей пользователей. `aspnet_Applications` Таблица имеет четыре столбца: `ApplicationId`, `ApplicationName`, `LoweredApplicationName`, и `Description`.`ApplicationId` имеет тип [ `uniqueidentifier` ](https://msdn.microsoft.com/library/ms187942.aspx) и является первичным ключом таблицы; `ApplicationName` предоставляет уникальное имя понятном для каждого приложения.

Другие таблицы, связанные с членством и ролями, связаны с `ApplicationId` в `aspnet_Applications`. Например `aspnet_Users` таблицы, которая содержит запись для каждой учетной записи пользователя, имеет `ApplicationId` поле внешнего ключа; это также касается `aspnet_Roles` таблицы. `ApplicationId` Поля в этих таблицах указывает раздел приложения учетной записи пользователя или роль.

### <a name="storing-user-account-information"></a>Хранение учетных записей пользователей

Сведения об учетной записи пользователя размещается в двух таблицах: `aspnet_Users` и `aspnet_Membership`. `aspnet_Users` Таблица содержит поля, которые содержат важные учетные данные. Ниже приведены три наиболее важные столбцы.

- `UserId`
- `UserName`
- `ApplicationId`

`UserId` является первичным ключом (и типа `uniqueidentifier`). `UserName` имеет тип `nvarchar(256)` и вместе с паролем, составляющий учетные данные пользователя. (Пароль хранится в `aspnet_Membership` таблицы.) `ApplicationId` связывает учетной записи пользователя к конкретному приложению в `aspnet_Applications`. Нет составного [ `UNIQUE` ограничение](https://msdn.microsoft.com/library/ms191166.aspx) на `UserName` и `ApplicationId` столбцов. Это гарантирует, что определенного приложения каждое имя пользователя является уникальным, но он позволяет одним и тем же `UserName` для использования в разных приложениях.

`aspnet_Membership` Таблица содержит дополнительные сведения, такие как пароль пользователя, адрес электронной почты, последняя дата входа и времени и т. д. Имеется взаимно-однозначное соответствие между записями в `aspnet_Users` и `aspnet_Membership` таблицы. Это отношение, за счет `UserId` в `aspnet_Membership`, который используется в качестве первичного ключа таблицы. Как и `aspnet_Users` таблицы, `aspnet_Membership` включает в себя `ApplicationId` поле, которое связывает эту информацию для определенного раздела приложений.

### <a name="securing-passwords"></a>Защита паролей

Сведения о пароле хранится в `aspnet_Membership` таблицы. `SqlMembershipProvider` Позволяет пароли не нужно хранить в базе данных с помощью одного из следующих трех способов:

- **Очистить** -пароль хранится в базе данных как обычный текст. Я настоятельно не рекомендуется создавать с помощью этого параметра. При компрометации базы данных — будь то злоумышленник нашедший черным или обозленных сотрудников, которые имеют доступ к базе данных - учетные данные каждого одного пользователя существуют для выполнения.
- **Хэшированные** -пароли хэшируются с помощью одностороннего алгоритма хеширования и произвольно создаваемого случайного значения. Это хэшированное значение (вместе с солью) хранится в базе данных.
- **Шифрование** -зашифрованную версию пароля хранится в базе данных.

Пароль хранилища методика зависит от `SqlMembershipProvider` , заданные в `Web.config`. Мы рассмотрим Настройка `SqlMembershipProvider` параметры на шаге 4. Поведение по умолчанию — сохранять хэш пароля.

Столбцы, ответственный за хранение пароля `Password`, `PasswordFormat`, и `PasswordSalt`. `PasswordFormat` является полем типа `int` , значение которого указывает метод, используемый для хранения пароля: 0 для Clear; 1 для Hashed; 2 для шифрования. `PasswordSalt` назначается случайным строка независимо от того, пароль хранилища методика; значение `PasswordSalt` используется только в том случае, если вычисления хэша пароля. Наконец `Password` столбец содержит данные фактический пароль, будь то обычный текст пароля, хэш пароля или зашифрованный пароль.

В таблице 1 показано, как эти три столбца может выглядеть для различных методов хранения при сохранении пароля MySecret! .

| **Storage Technique&lt;\_o3a\_p /&gt;** | **Пароль&lt;\_o3a\_p /&gt;** | **PasswordFormat&lt;\_o3a\_p /&gt;** | **PasswordSalt&lt;\_o3a\_p /&gt;** |
| --- | --- | --- | --- |
| Clear | MySecret! | 0 | tTnkPlesqissc2y2SMEygA== |
| Хэшированный | 2oXm6sZHWbTHFgjgkGQsc2Ec9ZM= | 1 | wFgjUfhdUFOCKQiI61vtiQ== |
| Шифрование | 62RZgDvhxykkqsMchZ0Yly7HS6onhpaoCYaRxV8g0F4CW56OXUU3e7Inza9j9BKp | 2 | LSRzhGS/aa/oqAXGLHJNBw== |

**Таблица 1**: Примеры значений для полей, связанные с паролем при сохранении пароля MySecret!

> [!NOTE]
> Определенный шифрования или алгоритм хэширования, используемый `SqlMembershipProvider` определяется параметрами в `<machineKey>` элемент. Мы рассмотрели данного элемента конфигурации на шаге 3 <a id="Tutorial3"> </a> [ *конфигурацию проверки подлинности форм и дополнительные разделы* ](../introduction/forms-authentication-configuration-and-advanced-topics-vb.md) руководства.

### <a name="storing-roles-and-role-associations"></a>Хранение роли и роли ассоциации

Роли framework позволяет разработчикам определить набор ролей и указать, какие пользователи принадлежат к роли. Эта информация сохраняется в базе данных с помощью двух таблиц: `aspnet_Roles` и `aspnet_UsersInRoles`. Каждая запись в `aspnet_Roles` таблице представляет роль для конкретного приложения. Подобно тому как `aspnet_Users` таблицы, `aspnet_Roles` таблица содержит три столбца, необходимой для нашего обсуждения:

- `RoleId`
- `RoleName`
- `ApplicationId`

`RoleId` является первичным ключом (и типа `uniqueidentifier`). `RoleName` имеет тип `nvarchar(256)`. И `ApplicationId` связывает учетной записи пользователя к конкретному приложению в `aspnet_Applications`. Нет составного `UNIQUE` ограничение на `RoleName` и `ApplicationId` столбцы, обеспечение что определенного приложения каждой роли используется уникальное имя.

`aspnet_UsersInRoles` Таблицы служит сопоставление пользователей и ролей. Существует только два столбца - `UserId` и `RoleId` - и вместе они составляют составного первичного ключа.

## <a name="step-4-specifying-the-provider-and-customizing-its-settings"></a>Шаг 4. Указание поставщика и настройка параметров

Всеми платформами, которые поддерживают модели поставщика — например, членства и ролей платформы - отсутствуют сведения о реализации, сами и вместо этого делегировать ответственность на класс поставщика. В случае структуру членства `Membership` класс определяет API управления учетными записями пользователей, но он не взаимодействует напрямую с любого хранилища пользователя. Вместо этого `Membership` методы класса будут передавать запрос на настроенный поставщик — мы будем использовать `SqlMembershipProvider`. Когда мы вызываем один из методов в `Membership` класса, как платформу членства узнает, делегировать вызов `SqlMembershipProvider`?

`Membership` Класс имеет [ `Providers` свойство](https://msdn.microsoft.com/library/system.web.security.membership.providers.aspx) , содержащий ссылку на все классы зарегистрированного поставщика, доступных для использования платформой членства. Каждый зарегистрированный поставщик имеет соответствующее имя и тип. Имя предоставляет способ понятном, чтобы ссылаться на определенного поставщика в `Providers` коллекции, а тип определяет класс поставщика. Кроме того каждый зарегистрированный поставщик может включать параметры конфигурации. Параметры конфигурации для структуры членства `PasswordFormat` и `requiresUniqueEmail`, среди прочих. См. в таблице 2 полный список параметров конфигурации, используемые `SqlMembershipProvider`.

`Providers` Содержимое свойства указываются с помощью параметров конфигурации веб-приложения. По умолчанию все веб-приложения имеется поставщик с именем `AspNetSqlMembershipProvider` типа `SqlMembershipProvider`. Этот поставщик членства по умолчанию регистрируется в `machine.config` (расположенный `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG`):

[!code-xml[Main](creating-the-membership-schema-in-sql-server-vb/samples/sample1.xml)]

Как разметка выше [ `<membership>` элемент](https://msdn.microsoft.com/library/1b9hw62f.aspx) определяет параметры конфигурации для структуры членства при [ `<providers>` дочерний элемент](https://msdn.microsoft.com/library/6d4936ht.aspx) указывает зарегистрированный Поставщики. Поставщики могут быть добавлены или удалены с помощью [ `<add>` ](https://msdn.microsoft.com/library/whae3t94.aspx) или [ `<remove>` ](https://msdn.microsoft.com/library/aykw9a6d.aspx) элементов; используйте [ `<clear>` ](https://msdn.microsoft.com/library/t062y6yc.aspx) элемент для удаления всех сейчас зарегистрированных поставщиков. Как разметка выше `machine.config` добавляет поставщик с именем `AspNetSqlMembershipProvider` типа `SqlMembershipProvider`.

В дополнение к `name` и `type` атрибуты, `<add>` содержит атрибуты, определяющие значения для различных настройку параметров. В таблице 2 перечислены доступные `SqlMembershipProvider`-определенных настроек конфигурации, а также описание каждого из них.

> [!NOTE]
> Любые значения по умолчанию, указанных в таблице 2 см. значения по умолчанию, определенные в `SqlMembershipProvider` класса. Обратите внимание, что не все параметры конфигурации в `AspNetSqlMembershipProvider` соответствуют значениям по умолчанию `SqlMembershipProvider` класса. Например, если не указан в поставщике членства `requiresUniqueEmail` задание значения по умолчанию true. Тем не менее `AspNetSqlMembershipProvider` переопределяет это значение по умолчанию, явно указав значение `false`.

| **Установка&lt;\_o3a\_p /&gt;** | **Описание&lt;\_o3a\_p /&gt;** |
| --- | --- |
| `ApplicationName` | Помните, что структуры членства разрешает одного пользовательского хранилища между несколькими приложениями. Этот параметр указывает имя секции приложения, используемый поставщиком членства. Если это значение не указано явным образом, он установлен, во время выполнения, равным пути виртуального корневого каталога приложения. |
| `commandTimeout` | Указывает значение времени ожидания команды SQL (в секундах). Значение по умолчанию — 30. |
| `connectionStringName` | Имя строки подключения в `<connectionStrings>` элемент, используемый для подключения к базе данных хранилища пользователя. Это значение является обязательным. |
| `description` | Содержит описание понятном зарегистрированного поставщика. |
| `enablePasswordRetrieval` | Указывает, могут ли пользователи получить их забытого пароля. Значение по умолчанию — `false`. |
| `enablePasswordReset` | Указывает, разрешено ли пользователям для сброса пароля. По умолчанию — `true`. |
| `maxInvalidPasswordAttempts` | Максимальное количество неудачных входов, которые могут возникнуть для данного пользователя в определенное `passwordAttemptWindow` пользователь блокируется. Значение по умолчанию — 5. |
| `minRequiredNonalphanumericCharacters` | Минимальное число не буквенно-цифровых символов, которые должны располагаться в пароле пользователя. Это значение должно быть в диапазоне от 0 до 128. значение по умолчанию равно 1. |
| `minRequiredPasswordLength` | Минимальное число символов в пароле. Это значение должно быть в диапазоне от 0 до 128. значение по умолчанию — 7. |
| `name` | Имя зарегистрированного поставщика. Это значение является обязательным. |
| `passwordAttemptWindow` | Количество минут в течение которого не отслеживаются попыток входа. Если пользователь предоставляет учетные данные для входа недопустимый `maxInvalidPasswordAttempts` указано время в данном окне, они заблокированы. Значение по умолчанию — 10. |
| `PasswordFormat` | Формат хранения паролей: `Clear`, `Hashed`, или `Encrypted`. Значение по умолчанию — `Hashed`. |
| `passwordStrengthRegularExpression` | Если указано, это регулярное выражение используется для оценки надежности выбранного пароля пользователя при создании новой учетной записи или при изменении пароля. Значение по умолчанию - пустая строка. |
| `requiresQuestionAndAnswer` | Указывает, является ли пользователь должен ответить его контрольный вопрос при извлечении или сбросе пароля. Значение по умолчанию — `true`. |
| `requiresUniqueEmail` | Указывает, является ли все учетные записи пользователей в разделе данного приложения должен иметь уникальный адрес электронной почты. Значение по умолчанию — `true`. |
| `type` | Указывает тип поставщика. Это значение является обязательным. |

**Таблица 2**: Членство и `SqlMembershipProvider` параметры конфигурации

В дополнение к `AspNetSqlMembershipProvider`, другие поставщики членства могут быть зарегистрированы на основе приложений по, добавив аналогичные разметку для `Web.config` файла.

> [!NOTE]
> Framework ролей работает во многом так же: нет зарегистрированных роли поставщика по умолчанию в `machine.config` и зарегистрированных поставщиков можно настроить для отдельных приложений по в `Web.config`. Мы рассмотрим framework ролей и его разметку настройки подробно в следующем учебном курсе.

### <a name="customizing-thesqlmembershipprovidersettings"></a>Настройка`SqlMembershipProvider`параметры

Значение по умолчанию `SqlMembershipProvider` (`AspNetSqlMembershipProvider`) имеет его `connectionStringName` атрибут `LocalSqlServer`. Как и `AspNetSqlMembershipProvider` поставщика, имя строки подключения `LocalSqlServer` определяется в `machine.config`.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-vb/samples/sample2.xml)]

Как видите, эта строка подключения определяет SQL 2005 Express Edition базы данных, расположенный | DataDirectory|aspnetdb.mdf. Строка | DataDirectory | преобразуется во время выполнения, чтобы они указывали `~/App_Data/` каталога, поэтому путь к базе данных | Преобразуется DataDirectory|aspnetdb.mdf `~/App_Data` / `aspnet.mdf`.

Если мы не указали сведения о поставщиках членства в нашем приложении `Web.config` файл, приложение использует поставщик членства по умолчанию зарегистрированные, `AspNetSqlMembershipProvider`. Если `~/App_Data/aspnet.mdf` базы данных не существует, среда выполнения ASP.NET будет автоматически создать его и добавить схему служб приложения. Тем не менее, мы не хотим использовать `aspnet.mdf` базы данных; вместо этого мы хотим использовать `SecurityTutorials.mdf` базы данных, созданную на шаге 2. Это изменение можно выполнить одним из двух способов:

- <strong>Укажите значение для</strong><strong>`LocalSqlServer`</strong><strong>имя строки подключения в</strong><strong>`Web.config`</strong><strong>.</strong> Путем перезаписи `LocalSqlServer` значение имя строки подключения в `Web.config`, можно использовать поставщик членства по умолчанию зарегистрированные (`AspNetSqlMembershipProvider`), который будет правильно работать с `SecurityTutorials.mdf` базы данных. Этот метод подходит, если вы являетесь содержимого с параметрами конфигурации, заданные `AspNetSqlMembershipProvider`. Дополнительные сведения об этом приеме см. в разделе [Скотт Гатри](https://weblogs.asp.net/scottgu/)в записи блога, [Настройка ASP.NET 2.0 службы приложений для использования SQL Server 2000 или SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx).
- <strong>Добавить новый зарегистрированный поставщик типа</strong><strong>`SqlMembershipProvider`</strong><strong>и настроить его</strong><strong>`connectionStringName`</strong><strong>параметр для указания</strong> <strong>`SecurityTutorials.mdf`</strong> <strong>базы данных.</strong> Этот подход полезен в сценариях, где вы хотите настроить другие свойства конфигурации, в дополнение к строке подключения базы данных. В собственных проектах я всегда использую этот подход из-за его гибкости и удобства чтения.

Перед добавлением нового зарегистрированного поставщика, который ссылается на `SecurityTutorials.mdf` базы данных, необходимо сначала добавить строковое значение соответствующее соединение в `<connectionStrings>` статьи `Web.config`. Следующая разметка добавляет новую строку подключения с именем `SecurityTutorialsConnectionString` , ссылающийся на SQL Server 2005 Express Edition `SecurityTutorials.mdf` базы данных в `App_Data` папку.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-vb/samples/sample3.xml)]

> [!NOTE]
> Если вы используете файл альтернативной базы данных, обновите строку подключения, при необходимости. Дополнительные сведения о формировании правильная строка подключения, см. [ConnectionStrings.com](http://www.connectionstrings.com/).

Добавьте следующую разметку настройки членства, чтобы `Web.config` файл. Эта разметка регистрирует новый поставщик с именем `SecurityTutorialsSqlMembershipProvider`.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-vb/samples/sample4.xml)]

В дополнение к регистрации `SecurityTutorialsSqlMembershipProvider` поставщик, приведенная выше разметка определяет `SecurityTutorialsSqlMembershipProvider` как поставщик по умолчанию (с помощью `defaultProvider` атрибут в `<membership>` элемент). Помните, что структуры членства может иметь несколько зарегистрированных поставщиков. Так как `AspNetSqlMembershipProvider` регистрируется как первый поставщик в `machine.config`, он служит в качестве поставщика по умолчанию если мы указываем, в противном случае.

В настоящее время наше приложение имеет два зарегистрированных поставщиков: `AspNetSqlMembershipProvider` и `SecurityTutorialsSqlMembershipProvider`. Тем не менее, перед регистрацией `SecurityTutorialsSqlMembershipProvider` поставщика, нам удалось очистки всех ранее зарегистрированных поставщиков, добавив [ `<clear />` элемент](https://msdn.microsoft.com/library/t062y6yc.aspx) непосредственно перед наших `<add>` элемент. Это будет очистить `AspNetSqlMembershipProvider` из списка зарегистрированных поставщиков, что означает, что `SecurityTutorialsSqlMembershipProvider` бы только зарегистрированного поставщика членства. Если мы использовали этот подход, то мы бы не нужно отмечать `SecurityTutorialsSqlMembershipProvider` как поставщик по умолчанию, так как было бы только зарегистрированного поставщика членства. Дополнительные сведения об использовании `<clear />`, см. в разделе [Using `<clear />` при добавлении поставщиков](https://weblogs.asp.net/scottgu/archive/2006/11/20/common-gotcha-don-t-forget-to-clear-when-adding-providers.aspx).

Обратите внимание, что `SecurityTutorialsSqlMembershipProvider` `connectionStringName` Указание ссылок только что добавленные `SecurityTutorialsConnectionString` имя строки подключения и что его `applicationName` параметр было присвоено значение SecurityTutorials. Кроме того `requiresUniqueEmail` параметру было присвоено `true`. Все другие параметры конфигурации совпадают со значениями в `AspNetSqlMembershipProvider`. Можно вносить любые изменения конфигурации, при необходимости. Например это сделать надежность пароля, требуя двух не буквенно-цифровых символов вместо одного, или, увеличивая длину пароля до восьми символов, а не семь.

> [!NOTE]
> Помните, что структуры членства разрешает одного пользовательского хранилища между несколькими приложениями. Поставщик членства `applicationName` параметр указывает, какое приложение, поставщик использует при работе с хранилище пользователя. Очень важно, явно задать значение для `applicationName` значение параметра конфигурации, поскольку если `applicationName` не заданы явным образом, она назначается виртуальный корневой путь веб-приложения во время выполнения. Это работает отлично до тех пор, пока не изменяется путь виртуального корневого каталога приложения, но при перемещении приложения по другому пути, `applicationName` слишком изменит параметр. В этом случае поставщик членства будет начать работу с раздел различных приложений, который использовался ранее. Учетные записи пользователей, созданные до перемещения будет находиться в другом приложении секции, и эти пользователи больше не смогут войти на сайт. Более подробные сведения по данному вопросу см. в разделе [всегда значение `applicationName` свойство при настройке ASP.NET 2.0 поставщиков членства и других](https://weblogs.asp.net/scottgu/443634).

## <a name="summary"></a>Сводка

На этом этапе у нас есть базы данных со службами настроенное приложение (`SecurityTutorials.mdf`) и настроили нашего веб-приложения, таким образом, использовал платформу членства `SecurityTutorialsSqlMembershipProvider` мы только что зарегистрировали поставщик. Этот зарегистрированного поставщика имеет тип `SqlMembershipProvider` и имеет его `connectionStringName` равным соответствующей строкой подключения (`SecurityTutorialsConnectionString`) и его `applicationName` явно задать значение.

Теперь мы готовы использовать платформу членства из нашего приложения. В следующем учебном курсе мы рассмотрим, как создавать новые учетные записи пользователей. После того, что мы изучим, проверка подлинности пользователей, выполняет авторизацию на основе пользователя и сохраняя дополнительную информацию, связанную с пользователем в базе данных.

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Всегда значение `applicationName` свойства при настройке 2.0 членства ASP.NET и других поставщиков](https://weblogs.asp.net/scottgu/443634)
- [Настройка ASP.NET 2.0 служб приложений для использования SQL Server 2000 или SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx)
- [Скачать SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?FamilyId=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796&amp;displaylang=en)
- [Изучение ASP.NET 2.0 s членства, ролей и профиля](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [`<add>` Элемент для поставщиков](https://msdn.microsoft.com/library/whae3t94.aspx)
- [`<membership>` Элемент](https://msdn.microsoft.com/library/1b9hw62f.aspx)
- [`<providers>` Элемент для членства](https://msdn.microsoft.com/library/6d4936ht.aspx)
- [С помощью `<clear />` при добавлении поставщиков](https://weblogs.asp.net/scottgu/archive/2006/11/20/common-gotcha-don-t-forget-to-clear-when-adding-providers.aspx)
- [Работа непосредственно с `SqlMembershipProvider`](http://aspnet.4guysfromrolla.com/articles/091207-1.aspx)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a>Учебные видеоматериалы по таким темам, содержащихся в этом руководстве

- [Общие сведения о членствах ASP.NET](../../../videos/authentication/understanding-aspnet-memberships.md)
- [Настройка SQL для работы со схемами членства](../../../videos/authentication/configuring-sql-to-work-with-membership-schemas.md)
- [Изменение настроек членства в схеме членства по умолчанию](../../../videos/authentication/changing-membership-settings-in-the-default-membership-schema.md)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Основной рецензент этого учебного был Alicja Maziarz. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4GuysFromRolla.com).

> [!div class="step-by-step"]
> [Назад](storing-additional-user-information-cs.md)
> [Вперед](creating-user-accounts-vb.md)
