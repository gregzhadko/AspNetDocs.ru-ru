---
uid: web-forms/overview/older-versions-security/membership/creating-the-membership-schema-in-sql-server-cs
title: Создание схемы членства в SQL Server (C#) | Документация Майкрософт
author: rick-anderson
description: Этот учебник начинается с изучения методов добавления необходимой схемы в базу данных для использования SqlMembershipProvider. Далее мы работаем...
ms.author: riande
ms.date: 01/18/2008
ms.assetid: b4ac129d-1b8e-41ca-a38f-9b19d7c7bb0e
msc.legacyurl: /web-forms/overview/older-versions-security/membership/creating-the-membership-schema-in-sql-server-cs
msc.type: authoredcontent
ms.openlocfilehash: 97623e7c13ab7799b9dadbb8e52be8e0cd99e252
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78464442"
---
# <a name="creating-the-membership-schema-in-sql-server-c"></a>Создание схемы членства в SQL Server (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_04_CS.zip) или [скачать PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial04_MembershipSetup_cs.pdf)

> Этот учебник начинается с изучения методов добавления необходимой схемы в базу данных для использования SqlMembershipProvider. После этого мы рассмотрим ключевые таблицы в схеме и обсудим их назначение и важность. В этом руководстве рассказывается о том, как сообщить ASP.NET приложению, какой поставщик должен использовать платформа членства.

## <a name="introduction"></a>Введение

В предыдущих двух учебниках рассматривалась проверка подлинности с помощью форм для идентификации посетителей веб-сайта. Платформа проверки подлинности с помощью форм упрощает для разработчиков регистрацию пользователя на веб-сайте и запоминать их на страницах, используя билеты проверки подлинности. Класс `FormsAuthentication` содержит методы для создания билета и его добавления в файлы cookie посетителя. `FormsAuthenticationModule` проверяет все входящие запросы и для них с допустимым билетом проверки подлинности создает и связывает `GenericPrincipal` и объект `FormsIdentity` с текущим запросом. Проверка подлинности с помощью форм — это просто механизм предоставления билета проверки подлинности посетителю при входе в систему и, при последующих запросах, анализ этого билета для определения удостоверения пользователя. Чтобы веб-приложение поддерживало учетные записи пользователей, нам по-прежнему необходимо реализовать хранилище пользователей и добавить функции для проверки учетных данных, регистрации новых пользователей и множества других задач, связанных с учетной записью пользователя.

До ASP.NET 2,0 разработчики были в процессе реализации всех этих задач, связанных с учетной записью пользователя. К счастью, команда ASP.NET распознал этот недостаток и представил инфраструктуру членства с ASP.NET 2,0. Платформа членства — это набор классов в .NET Framework, предоставляющих программный интерфейс для выполнения основных задач, связанных с учетной записью пользователя. Эта платформа построена на основе [модели поставщика](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx), которая позволяет разработчикам подключать пользовательскую реализацию к стандартизированному API.

Как обсуждалось в <a id="Tutorial1"> </a>учебнике [*основы безопасности и поддержка ASP.NET*](../introduction/security-basics-and-asp-net-support-cs.md) , .NET Framework поставляется с двумя встроенными поставщиками членства: [`ActiveDirectoryMembershipProvider`](https://msdn.microsoft.com/library/system.web.security.activedirectorymembershipprovider.aspx) и [`SqlMembershipProvider`](https://msdn.microsoft.com/library/system.web.security.sqlmembershipprovider.aspx). Как следует из названия, `SqlMembershipProvider` использует базу данных Microsoft SQL Server в качестве хранилища пользователя. Чтобы использовать этот поставщик в приложении, необходимо сообщить поставщику, какую базу данных использовать в качестве хранилища. Как вы, возможно, представим, `SqlMembershipProvider` предполагает, что база данных хранилища пользователей имеет определенные таблицы, представления и хранимые процедуры базы данных. Необходимо добавить эту ожидаемую схему в выбранную базу данных.

Этот учебник начинается с изучения методов добавления необходимой схемы в базу данных для использования `SqlMembershipProvider`. После этого мы рассмотрим ключевые таблицы в схеме и обсудим их назначение и важность. В этом руководстве рассказывается о том, как сообщить ASP.NET приложению, какой поставщик должен использовать платформа членства.

Приступим.

## <a name="step-1-deciding-where-to-place-the-user-store"></a>Шаг 1. Выбор места размещения хранилища пользователей

Данные приложения ASP.NET обычно хранятся в нескольких таблицах базы данных. При реализации схемы базы данных `SqlMembershipProvider` необходимо решить, следует ли поместить схему членства в ту же базу данных, что и данные приложения, или в альтернативную базу данных.

Я рекомендую найти схему членства в той же базе данных, что и данные приложения, по следующим причинам:

- **Удобство сопровождения** приложение, данные которого инкапсулируются в одной базе данных, проще понимать, обслуживать и развертывать, чем приложение с двумя отдельными базами данных.
- **Реляционная целостность** путем поиска связанных с членством таблиц в той же базе данных, что и таблицы приложения, можно установить [ограничения внешнего ключа](http://en.wikipedia.org/wiki/Foreign_key) между первичными ключами в связанных с членством таблицах и связанных таблицах приложений.

Отделение хранилища пользователей от данных приложений к отдельным базам данных имеет смысл только в том случае, если у вас несколько приложений, каждый из которых использует отдельные базы данных, но им нужно предоставить общий доступ к хранилищу пользователей.

### <a name="creating-a-database"></a>Создание базы данных

Приложение, которое мы создали с момента создания второго руководства, еще не требовало базы данных. Однако для магазина пользователя нам нужно еще одно. Давайте создадим его, а затем добавим к нему схему, необходимую поставщику `SqlMembershipProvider` (см. шаг 2).

> [!NOTE]
> В рамках этой серии руководств мы будем использовать базу данных [Microsoft SQL Server 2005 Express Edition](https://msdn.microsoft.com/sql/Aa336346.aspx) для хранения таблиц приложений и схемы `SqlMembershipProvider`. Это решение было принято по двум причинам: во-первых, это связано с тем, что выпуск Express Edition является самой доступной для чтения версией SQL Server 2005; Во-вторых, SQL Server 2005, экспресс-выпуск базы данных могут размещаться непосредственно в папке `App_Data` веб – приложения, что делает так, чтобы они очень просто базу данных и веб-приложение в одном СЖАТом файле и повторно развертывать их без каких-либо специальных инструкций по настройке или параметров конфигурации. Если вы предпочитаете использовать версию SQL Server, отличную от Express Edition, вы можете бесплатно воспользоваться этой версией. Эти шаги практически идентичны. Схема `SqlMembershipProvider` будет работать с любой версией Microsoft SQL Server 2000 и выше.

В обозреватель решений щелкните правой кнопкой мыши папку `App_Data` и выберите Добавить новый элемент. (Если в проекте не отображается папка `App_Data`, щелкните правой кнопкой мыши проект в обозреватель решений, выберите Добавить папку ASP.NET и выберите `App_Data`.) В диалоговом окне Добавление нового элемента выберите Добавление новой базы данных SQL с именем `SecurityTutorials.mdf`. В этом учебнике в эту базу данных будет добавлена схема `SqlMembershipProvider`. в последующих учебных курсах будут созданы дополнительные таблицы для записи данных приложения.

[![добавить новую базу данных SQL с именем Секурититуториалс. mdf в папку App_Data](creating-the-membership-schema-in-sql-server-cs/_static/image2.png)](creating-the-membership-schema-in-sql-server-cs/_static/image1.png)

**Рис. 1**. Добавление новой базы данных SQL с именем `SecurityTutorials.mdf` базу данных в папку `App_Data` ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image3.png))

Добавление базы данных в папку `App_Data` автоматически включает ее в представление обозреватель базы данных. (В версии Visual Studio, отличной от Express Edition, обозреватель базы данных называется обозреватель сервера.) Перейдите к обозреватель базы данных и разверните только что добавленную `SecurityTutorials` базу данных. Если на экране не отображается обозреватель базы данных, перейдите в меню Вид и выберите пункт обозреватель базы данных или нажмите клавиши CTRL + ALT + S. Как показано на рис. 2, база данных `SecurityTutorials` пуста — она не содержит ни таблиц, ни представлений, ни хранимых процедур.

[![база данных Секурититуториалс сейчас пуста](creating-the-membership-schema-in-sql-server-cs/_static/image5.png)](creating-the-membership-schema-in-sql-server-cs/_static/image4.png)

**Рис. 2**. база данных `SecurityTutorials` в настоящее время пуста ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image6.png))

## <a name="step-2-adding-thesqlmembershipproviderschema-to-the-database"></a>Шаг 2. Добавление схемы`SqlMembershipProvider`в базу данных

`SqlMembershipProvider` требуется установить определенный набор таблиц, представлений и хранимых процедур в базу данных хранилища пользователей. Эти необходимые объекты базы данных можно добавить с помощью [средства`aspnet_regsql.exe`](https://msdn.microsoft.com/library/ms229862.aspx). Этот файл находится в папке `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\`.

> [!NOTE]
> Средство `aspnet_regsql.exe` предлагает как функциональность командной строки, так и графический пользовательский интерфейс. Графический интерфейс является более удобным для пользователя, и он будет рассмотрен в этом руководстве. Интерфейс командной строки полезен, когда Добавление схемы `SqlMembershipProvider` необходимо автоматизировать, например в сценариях сборки или в сценариях автоматического тестирования.

Средство `aspnet_regsql.exe` используется для добавления или удаления *служб приложений ASP.NET* в указанной SQL Server базе данных. Службы приложений ASP.NET охватывают схемы для `SqlMembershipProvider` и `SqlRoleProvider`, а также схемы для поставщиков на основе SQL для других платформ ASP.NET 2,0. В средство `aspnet_regsql.exe` необходимо предоставить два бита информации:

- Нужно ли добавлять или удалять службы приложений;
- База данных, из которой будет добавлена или удалена схема служб приложений

При запросе использования базы данных средство `aspnet_regsql.exe` запрашивает имя сервера, на котором находится база данных, учетные данные безопасности для подключения к базе данных и имя базы данных. Если вы используете SQL Server, отличный от Express, эти сведения уже должны быть знакомы, так как это те же сведения, которые необходимо предоставить через строку подключения при работе с базой данных через веб-страницу ASP.NET. Однако определение имени сервера и базы данных при использовании базы данных SQL Server 2005, экспресс-выпуск в папке `App_Data`, тем не менее, является более сложным.

В следующем разделе рассматривается простой способ указания имени сервера и базы данных для SQL Server 2005, экспресс-выпуск базы данных в папке `App_Data`. Если вы не используете SQL Server 2005, экспресс-выпуск вы можете перейти к разделу Установка Службы приложений.

### <a name="determining-the-server-and-database-name-for-a-sql-server-2005-express-edition-database-in-theapp_datafolder"></a>Определение имени сервера и базы данных для SQL Server 2005, экспресс-выпуск базы данных в папке`App_Data`

Чтобы использовать средство `aspnet_regsql.exe`, необходимо знать имена сервера и базы данных. Имя сервера — `localhost\InstanceName`. Скорее всего, *InstanceName* `SQLExpress`. Однако если вы установили SQL Server 2005, экспресс-выпуск вручную (то есть не устанавливали его автоматически при установке Visual Studio), возможно, выбрано другое имя экземпляра.

Имя базы данных немного сложнее для определения. Базы данных в папке `App_Data` обычно имеют имя базы данных, содержащее [глобальный уникальный идентификатор](http://en.wikipedia.org/wiki/Globally_Unique_Identifier) вместе с путем к файлу базы данных. Чтобы добавить схему служб приложений с помощью `aspnet_regsql.exe`, необходимо определить это имя базы данных.

Самый простой способ выяснить имя базы данных — это проверить ее с помощью SQL Server Management Studio. SQL Server Management Studio предоставляет графический интерфейс для управления базами данных SQL Server 2005, но он не поставляется с выпуском Express SQL Server 2005. Хорошая новость заключается в том, что [вы можете скачать](https://www.microsoft.com/downloads/details.aspx?FamilyId=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796&amp;displaylang=en) бесплатную экспресс-версию SQL Server Management Studio.

> [!NOTE]
> Если на рабочем столе установлена версия SQL Server 2005, не являющейся Express Edition, скорее всего, будет установлена полная версия Management Studio. Можно использовать полную версию для определения имени базы данных, выполнив те же действия, что описаны ниже для выпуска Express.

Сначала закройте Visual Studio, чтобы убедиться, что все блокировки, накладываемые Visual Studio на файл базы данных, закрыты. Затем запустите SQL Server Management Studio и подключитесь к базе данных `localhost\InstanceName` для SQL Server 2005, экспресс-выпуск. Как отмечалось ранее, вероятность того, что имя экземпляра `SQLExpress`. Для параметра Проверка подлинности выберите Проверка подлинности Windows.

[![подключиться к экземпляру SQL Server 2005, экспресс-выпуск](creating-the-membership-schema-in-sql-server-cs/_static/image8.png)](creating-the-membership-schema-in-sql-server-cs/_static/image7.png)

**Рис. 3**. подключение к экземпляру SQL Server 2005, Экспресс-выпуск ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image9.png))

После подключения к экземпляру SQL Server 2005, экспресс-выпуск Management Studio отображает папки для баз данных, параметры безопасности, объекты сервера и т. д. Если развернуть вкладку базы данных, вы увидите, что `SecurityTutorials.mdf` база данных *не* зарегистрирована в экземпляре базы данных — сначала необходимо присоединить базу данных.

Щелкните правой кнопкой мыши папку базы данных и выберите команду Присоединить в контекстном меню. Отобразится диалоговое окно Присоединение баз данных. Здесь нажмите кнопку Добавить, перейдите к базе данных `SecurityTutorials.mdf` и нажмите кнопку ОК. На рис. 4 показано диалоговое окно Присоединение баз данных после выбора `SecurityTutorials.mdf` базы данных. На рис. 5 показан обозреватель объектов Management Studio после успешного подключения базы данных.

[![присоединение базы данных Секурититуториалс. mdf](creating-the-membership-schema-in-sql-server-cs/_static/image11.png)](creating-the-membership-schema-in-sql-server-cs/_static/image10.png)

**Рис. 4**. Присоединение базы данных `SecurityTutorials.mdf` ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image12.png))

[![база данных Секурититуториалс. mdf появится в папке базы данных](creating-the-membership-schema-in-sql-server-cs/_static/image14.png)](creating-the-membership-schema-in-sql-server-cs/_static/image13.png)

**Рис. 5**. база данных `SecurityTutorials.mdf` отображается в папке базы данных ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image15.png))

Как показано на рис. 5, `SecurityTutorials.mdf` база данных имеет абструсе имя. Давайте изменим его на более запоминающееся (и проще в вводе) имени. Щелкните правой кнопкой мыши базу данных, выберите команду Переименовать в контекстном меню и переименуйте ее `SecurityTutorialsDatabase`. При этом имя файла не изменяется, просто имя, используемое базой данных для идентификации себя в SQL Server.

[![переименовать базу данных в Секурититуториалсдатабасе](creating-the-membership-schema-in-sql-server-cs/_static/image17.png)](creating-the-membership-schema-in-sql-server-cs/_static/image16.png)

**Рис. 6**. Переименование базы данных в `SecurityTutorialsDatabase`([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image18.png))

На этом этапе мы понимаем имена сервера и базы данных для `SecurityTutorials.mdf`ного файла базы данных: `localhost\InstanceName` и `SecurityTutorialsDatabase`соответственно. Теперь все готово для установки служб приложений с помощью средства `aspnet_regsql.exe`.

### <a name="installing-the-application-services"></a>Установка Службы приложений

Чтобы запустить средство `aspnet_regsql.exe`, перейдите в меню Пуск и выберите выполнить. Введите `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\aspnet_regsql.exe` в текстовое поле и нажмите кнопку ОК. Кроме того, можно воспользоваться проводником Windows, чтобы выполнить детализацию до соответствующей папки и дважды щелкнуть файл `aspnet_regsql.exe`. Один из этих подходов выдает одинаковые результаты.

Запуск средства `aspnet_regsql.exe` без аргументов командной строки запускает графический пользовательский интерфейс мастера установки ASP.NET SQL Server. Мастер упрощает добавление или удаление служб приложений ASP.NET в указанной базе данных. На первом экране мастера, показанном на рис. 7, описывается назначение этого средства.

[![использовании мастера установки SQL Server ASP.NET для добавления схемы членства](creating-the-membership-schema-in-sql-server-cs/_static/image20.png)](creating-the-membership-schema-in-sql-server-cs/_static/image19.png)

**Рис. 7**. Использование мастера установки ASP.NET SQL Server для добавления схемы членства ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image21.png))

На втором шаге мастера запрашивается, нужно ли добавить службы приложений или удалить их. Так как мы хотим добавить таблицы, представления и хранимые процедуры, необходимые для `SqlMembershipProvider`, выберите параметр настроить SQL Server для служб приложений. Позже, если вы хотите удалить эту схему из базы данных, перезапустите этот мастер, а вместо этого выберите параметр удалить сведения о службах приложений из существующей базы данных.

[![выберите параметр настроить SQL Server для Службы приложений.](creating-the-membership-schema-in-sql-server-cs/_static/image23.png)](creating-the-membership-schema-in-sql-server-cs/_static/image22.png)

**Рис. 8**. Выбор параметра настройки SQL Server для службы приложений ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image24.png))

На третьем шаге запрашиваются сведения о базе данных: имя сервера, сведения о проверке подлинности и имя базы данных. Если вы выполнили действия в этом руководстве и добавили базу данных `SecurityTutorials.mdf` для `App_Data`, подключили ее к `localhost\InstanceName`и переименовали ее в `SecurityTutorialsDatabase`, используйте следующие значения:

- Сервер: `localhost\InstanceName`
- Проверка подлинности Windows
- База данных: `SecurityTutorialsDatabase`

[![введите сведения о базе данных](creating-the-membership-schema-in-sql-server-cs/_static/image26.png)](creating-the-membership-schema-in-sql-server-cs/_static/image25.png)

**Рис. 9**. Ввод сведений о базе данных ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image27.png))

После ввода сведений о базе данных нажмите кнопку Далее. На последнем шаге выполняется сводка действий, которые будут выполнены. Нажмите кнопку Далее, чтобы установить службы приложений и завершить работу мастера.

> [!NOTE]
> Если вы использовали Management Studio для присоединения базы данных и переименования файла базы данных, не забудьте отсоединить базу данных и закрыть Management Studio перед повторной попыткой открытия Visual Studio. Чтобы отсоединить `SecurityTutorialsDatabase` базу данных, щелкните ее имя правой кнопкой мыши и выберите в меню задачи пункт Отсоединить.

После завершения работы мастера вернитесь в Visual Studio и перейдите к обозреватель базы данных. Разверните папку Таблицы. Вы увидите ряд таблиц, имена которых начинаются с префикса `aspnet_`. Аналогично, в папках views и хранимые процедуры можно найти разнообразные представления и хранимые процедуры. Эти объекты базы данных составляют схему служб приложений. В шаге 3 будут рассмотрены объекты базы данных, относящиеся к членству и ролям.

[![в базу данных добавлены разнообразные таблицы, представления и хранимые процедуры](creating-the-membership-schema-in-sql-server-cs/_static/image29.png)](creating-the-membership-schema-in-sql-server-cs/_static/image28.png)

**Рис. 10**. в базу данных добавлены разнообразные таблицы, представления и хранимые процедуры ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image30.png))

> [!NOTE]
> Графический пользовательский интерфейс средства `aspnet_regsql.exe` устанавливает всю схему служб приложений. Но при выполнении `aspnet_regsql.exe` из командной строки можно указать, какие конкретные компоненты служб приложений следует установить (или удалить). Поэтому, если нужно добавить только таблицы, представления и хранимые процедуры, необходимые для поставщиков `SqlMembershipProvider` и `SqlRoleProvider`, запустите `aspnet_regsql.exe` из командной строки. Кроме того, можно вручную запустить соответствующее подмножество скриптов создания T-SQL, используемых `aspnet_regsql.exe`. Эти сценарии находятся в папке `WINDIR%\Microsoft.Net\Framework\v2.0.50727\` с такими именами, как `InstallCommon.sql`,`InstallMembership.sql`,`InstallRoles.sql`, `InstallProfile.sql`,`InstallSqlState.sql`и т. д.

На этом этапе мы создали объекты базы данных, необходимые для `SqlMembershipProvider`. Однако нам по-прежнему нужно указать платформе членства, что она должна использовать `SqlMembershipProvider` (и, скажем, `ActiveDirectoryMembershipProvider`) и что `SqlMembershipProvider` должен использовать базу данных `SecurityTutorials`. Мы рассмотрим, как указать, какой поставщик использовать, и как настроить параметры выбранного поставщика на шаге 4. Но сначала давайте более подробно рассмотрим объекты базы данных, которые были только что созданы.

## <a name="step-3-a-look-at-the-schemas-core-tables"></a>Шаг 3. Просмотр основных таблиц схемы

При работе с платформами членства и ролей в приложении ASP.NET сведения о реализации инкапсулируются поставщиком. В следующих учебных курсах мы будем взаимодействовать с этими платформами с помощью .NET Framework классов `Membership` и `Roles`. При использовании этих API-интерфейсов высокого уровня не нужно заботиться о низком уровне, например о том, какие запросы выполняются или какие таблицы изменяются `SqlMembershipProvider` и `SqlRoleProvider`.

Учитывая это, можно было бы уверенно использовать платформы членства и ролей без изучения схемы базы данных, созданной на шаге 2. Однако при создании таблиц для хранения данных приложения может потребоваться создать сущности, связанные с пользователями или ролями. Это помогает ознакомиться с схемами `SqlMembershipProvider` и `SqlRoleProvider` при установке ограничений внешнего ключа между таблицами данных приложения и таблицами, созданными на шаге 2. Более того, в некоторых редких случаях может потребоваться взаимодействовать с хранилищами пользователей и ролей непосредственно на уровне базы данных (вместо классов `Membership` или `Roles`).

### <a name="partitioning-the-user-store-into-applications"></a>Разделение пользовательского хранилища на приложения

Структуры членства и ролей спроектированы таким образом, что один пользователь и хранилище ролей могут совместно использоваться разными приложениями. Приложение ASP.NET, использующее платформы членства или ролей, должно указывать, какую секцию приложения следует использовать. Вкратце, несколько веб-приложений могут использовать одни и те же хранилища пользователей и ролей. На рис. 11 показаны хранилища пользователей и ролей, разделенные на три приложения: Хрсите, Кустомерсите и Салессите. Каждый из этих трех веб-приложений имеет собственные уникальные пользователи и роли, но все они физически хранят свои учетные записи и сведения о ролях в одних и тех же таблицах базы данных.

[![учетные записи пользователей могут быть разделены между несколькими приложениями.](creating-the-membership-schema-in-sql-server-cs/_static/image32.png)](creating-the-membership-schema-in-sql-server-cs/_static/image31.png)

**Рис. 11**. учетные записи пользователей могут быть разделены между несколькими приложениями ([щелкните, чтобы просмотреть изображение с полным размером](creating-the-membership-schema-in-sql-server-cs/_static/image33.png))

Эти секции определяются `aspnet_Applications` таблицей. Каждое приложение, использующее базу данных для хранения данных учетной записи пользователя, представлено строкой в этой таблице. Таблица `aspnet_Applications` содержит четыре столбца: `ApplicationId`, `ApplicationName`, `LoweredApplicationName`и `Description`. `ApplicationId` имеет тип [`uniqueidentifier`](https://msdn.microsoft.com/library/ms187942.aspx) и является первичным ключом таблицы; `ApplicationName` предоставляет уникальное удобное для человека имя для каждого приложения.

Другие таблицы, связанные с членством и ролями, связываются с полем `ApplicationId` в `aspnet_Applications`. Например, таблица `aspnet_Users`, содержащая запись для каждой учетной записи пользователя, имеет `ApplicationId` внешний ключ. Дитто для таблицы `aspnet_Roles`. В поле `ApplicationId` в этих таблицах указывается Секция приложения, к которой принадлежит учетная запись пользователя или роль.

### <a name="storing-user-account-information"></a>Хранение сведений об учетной записи пользователя

Сведения об учетной записи пользователя размещены в двух таблицах: `aspnet_Users` и `aspnet_Membership`. Таблица `aspnet_Users` содержит поля, в которых хранятся сведения о наиболее ценных учетных записях пользователей. Ниже перечислены три наиболее подсоответствующие столбцы.

- `UserId`
- `UserName`
- `ApplicationId`

`UserId` является первичным ключом (и типа `uniqueidentifier`). `UserName` имеет тип `nvarchar(256)` и, вместе с паролем, создает учетные данные пользователя. (Пароль пользователя хранится в таблице `aspnet_Membership`.) `ApplicationId` связывает учетную запись пользователя с определенным приложением в `aspnet_Applications`. Для столбцов `UserName` и `ApplicationId` существует составное [ограничение`UNIQUE`](https://msdn.microsoft.com/library/ms191166.aspx) . Это гарантирует уникальность каждого имени пользователя в данном приложении, но позволяет использовать один и тот же `UserName` в разных приложениях.

Таблица `aspnet_Membership` содержит дополнительные сведения об учетной записи пользователя, такие как пароль пользователя, адрес электронной почты, Дата и время последнего входа в систему и т. д. Существует соответствие "один к одному" между записями в `aspnet_Users` и `aspnet_Membership` таблицах. Эта связь обеспечивается полем `UserId` в `aspnet_Membership`, которое служит первичным ключом таблицы. Как и в `aspnet_Users` таблице, `aspnet_Membership` содержит поле `ApplicationId`, которое связывает эту информацию с определенной секцией приложения.

### <a name="securing-passwords"></a>Защита паролей

Сведения о пароле хранятся в таблице `aspnet_Membership`. `SqlMembershipProvider` позволяет хранить пароли в базе данных с помощью одного из следующих трех методов:

- **Clear** — пароль хранится в базе данных в виде обычного текста. Я настоятельно не хочу использовать этот параметр. Если база данных скомпрометирована, то злоумышленник, который находит заднюю дверцу или недовольным сотрудника, имеющего доступ к базе данных, может использовать все учетные данные одного пользователя.
- **Хэшированные** — пароли хэшируются с использованием одностороннего алгоритма хэширования и случайным образом сформированным расширяющим значением. Это хэшированное значение (вместе с Salt) хранится в базе данных.
- **Зашифровано** — зашифрованная версия пароля хранится в базе данных.

Используемый способ хранения паролей зависит от параметров `SqlMembershipProvider`, указанных в `Web.config`. Мы рассмотрим настройку параметров `SqlMembershipProvider` на шаге 4. Поведение по умолчанию — хранить хэш пароля.

К столбцам, ответственным за хранение пароля, относятся `Password`, `PasswordFormat`и `PasswordSalt`. `PasswordFormat` — это поле типа `int`, значение которого указывает метод, используемый для хранения пароля: 0 для Clear; 1 для хэширования; 2 для шифрования. `PasswordSalt` назначается случайным образом сформированная строка независимо от используемого метода хранения паролей. значение `PasswordSalt` используется только при вычислении хэша пароля. Наконец, столбец `Password` содержит фактические данные пароля, то есть пароль в виде обычного текста, хэш пароля или зашифрованный пароль.

В таблице 1 показано, как могут выглядеть эти три столбца для различных методов хранения при хранении пароля MySecret! .

| **Способ хранения&lt;\_O3A\_p/&gt;** | **Пароль&lt;\_O3A\_p/&gt;** | **Пассвордформат&lt;\_O3A\_p/&gt;** | **Пассвордсалт&lt;\_O3A\_p/&gt;** |
| --- | --- | --- | --- |
| Clear | MySecret! | 0 | tTnkPlesqissc2y2SMEygA== |
| Хэшируется | 2oXm6sZHWbTHFgjgkGQsc2Ec9ZM= | 1 | wFgjUfhdUFOCKQiI61vtiQ = = |
| зашифрованные; | 62RZgDvhxykkqsMchZ0Yly7HS6onhpaoCYaRxV8g0F4CW56OXUU3e7Inza9j9BKp | 2 | LSRzhGS/aa/oqAXGLHJNBw== |

**Таблица 1**. примеры значений для полей, связанных с паролем, при хранении пароля mysecret!

> [!NOTE]
> Определенный алгоритм шифрования или хэширования, используемый `SqlMembershipProvider`, определяется параметрами в элементе `<machineKey>`. Мы обсуждали этот элемент конфигурации на шаге 3 <a id="Tutorial3"> </a>учебника [*Настройка проверки подлинности с помощью форм и дополнительные разделы*](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md) .

### <a name="storing-roles-and-role-associations"></a>Хранение ролей и сопоставлений ролей

Платформа ролей позволяет разработчикам определять набор ролей и указывать, к каким ролям относятся пользователи. Эти сведения фиксируются в базе данных с помощью двух таблиц: `aspnet_Roles` и `aspnet_UsersInRoles`. Каждая запись в таблице `aspnet_Roles` представляет роль для конкретного приложения. Подобно таблице `aspnet_Users`, `aspnet_Roles` таблица имеет три столбца, которые относятся к нашему обсуждению:

- `RoleId`
- `RoleName`
- `ApplicationId`

`RoleId` является первичным ключом (и типа `uniqueidentifier`). Свойство `RoleName` имеет тип `nvarchar(256)`. И `ApplicationId` связывает учетную запись пользователя с определенным приложением в `aspnet_Applications`. Для столбцов `RoleName` и `ApplicationId` существует составное ограничение `UNIQUE`, гарантируя уникальность имени каждой роли в данном приложении.

`aspnet_UsersInRoles` таблица служит сопоставлением между пользователями и ролями. Существует только два столбца — `UserId` и `RoleId`. Вместе они составляют составной первичный ключ.

## <a name="step-4-specifying-the-provider-and-customizing-its-settings"></a>Шаг 4. Указание поставщика и настройка его параметров

Все платформы, поддерживающие модель поставщика (например, структуры членства и ролей), не имеют самих деталей реализации, а делегируют ответственность за класс поставщика. В случае платформы членства класс `Membership` определяет API для управления учетными записями пользователей, но не взаимодействует напрямую с каким-либо хранилищем пользователя. Вместо этого методы класса `Membership` передают запрос настроенному поставщику — мы будем использовать `SqlMembershipProvider`. Когда мы вызываем один из методов класса `Membership`, как платформа членства знает, как делегировать вызов `SqlMembershipProvider`?

Класс `Membership` имеет [свойство`Providers`](https://msdn.microsoft.com/library/system.web.security.membership.providers.aspx) , которое содержит ссылку на все зарегистрированные классы поставщиков, доступные для использования платформой членства. Каждый зарегистрированный поставщик имеет связанное имя и тип. Имя представляет собой удобный способ ссылки на конкретный поставщик в коллекции `Providers`, а тип определяет класс поставщика. Кроме того, каждый зарегистрированный поставщик может включать параметры конфигурации. Параметры конфигурации для платформы членства включают `passwordFormat` и `requiresUniqueEmail`, среди многих других. Полный список параметров конфигурации, используемых `SqlMembershipProvider`, см. в табл. 2.

Содержимое свойства `Providers` задается с помощью параметров конфигурации веб-приложения. По умолчанию у всех веб-приложений есть поставщик с именем `AspNetSqlMembershipProvider` типа `SqlMembershipProvider`. Этот поставщик членства по умолчанию регистрируется в `machine.config` (находится в `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG)`:

[!code-xml[Main](creating-the-membership-schema-in-sql-server-cs/samples/sample1.xml)]

Как показано в приведенной выше разметке, [элемент`<membership>`](https://msdn.microsoft.com/library/1b9hw62f.aspx) определяет параметры конфигурации для платформы членства, а [дочерний элемент`<providers>`](https://msdn.microsoft.com/library/6d4936ht.aspx) указывает зарегистрированные поставщики. Поставщики можно добавлять или удалять с помощью элементов [`<add>`](https://msdn.microsoft.com/library/whae3t94.aspx) или [`<remove>`](https://msdn.microsoft.com/library/aykw9a6d.aspx) ; Используйте элемент [`<clear>`](https://msdn.microsoft.com/library/t062y6yc.aspx) , чтобы удалить все зарегистрированные в настоящее время поставщики. Как показано в приведенной выше разметке, `machine.config` добавляет поставщик с именем `AspNetSqlMembershipProvider` типа `SqlMembershipProvider`.

В дополнение к атрибутам `name` и `type` элемент `<add>` содержит атрибуты, определяющие значения для различных параметров настройки. В табл. 2 перечислены доступные параметры конфигурации `SqlMembershipProvider`, а также описание каждого из них.

> [!NOTE]
> Все значения по умолчанию, указанные в таблице 2, относятся к значениям по умолчанию, определенным в классе `SqlMembershipProvider`. Обратите внимание, что не все параметры конфигурации в `AspNetSqlMembershipProvider` соответствуют значениям по умолчанию класса `SqlMembershipProvider`. Например, если значение не указано в поставщике членства, то для параметра `requiresUniqueEmail` по умолчанию будет задано значение true. Однако `AspNetSqlMembershipProvider` переопределяет это значение по умолчанию, явно указав значение `false`.

| **Настройка&lt;\_O3A\_p/&gt;** | **Description&lt;\_O3A\_p/&gt;** |
| --- | --- |
| `ApplicationName` | Вспомним, что платформа членства позволяет секционировать единое хранилище пользователей в нескольких приложениях. Этот параметр указывает имя секции приложения, используемой поставщиком членства. Если это значение явно не указано, во время выполнения задается значение виртуального корневого пути приложения. |
| `commandTimeout` | Указывает значение времени ожидания команды SQL (в секундах). Значение по умолчанию — 30. |
| `connectionStringName` | Имя строки подключения в элементе `<connectionStrings>`, используемой для подключения к базе данных хранилища пользователей. Это значение обязательно. |
| `description` | Предоставляет удобное описание зарегистрированного поставщика. |
| `enablePasswordRetrieval` | Указывает, могут ли пользователи извлекать забытый пароль. Значение по умолчанию — `false`. |
| `enablePasswordReset` | Указывает, разрешено ли пользователям сбрасывать свой пароль. По умолчанию равен `true`. |
| `maxInvalidPasswordAttempts` | Максимальное количество неудачных попыток входа, которые могут произойти для данного пользователя в течение указанного `passwordAttemptWindow` до блокировки пользователя. Значение по умолчанию — 5. |
| `minRequiredNonalphanumericCharacters` | Минимальное число символов, отличных от буквенно-цифровых, которые должны присутствовать в пароле пользователя. Это значение должно находиться в диапазоне от 0 до 128; значение по умолчанию — 1. |
| `minRequiredPasswordLength` | Минимальное число символов, необходимых в пароле. Это значение должно находиться в диапазоне от 0 до 128; значение по умолчанию — 7. |
| `name` | Имя зарегистрированного поставщика. Это значение обязательно. |
| `passwordAttemptWindow` | Количество минут, в течение которых отправляются неудачные попытки входа. Если пользователь предоставляет недопустимые учетные данные входа `maxInvalidPasswordAttempts` раз в пределах указанного окна, они блокируются. Значение по умолчанию — 10. |
| `PasswordFormat` | Формат хранения паролей: `Clear`, `Hashed`или `Encrypted`. Значение по умолчанию — `Hashed`. |
| `passwordStrengthRegularExpression` | Это регулярное выражение используется для проверки силы выбранного пароля пользователя при создании новой учетной записи или при смене пароля. Значение по умолчанию — пустая строка. |
| `requiresQuestionAndAnswer` | Указывает, должен ли пользователь отвечать на свой контрольный вопрос при получении или сбросе пароля. Значение по умолчанию — `true`. |
| `requiresUniqueEmail` | Указывает, должны ли все учетные записи пользователей в заданном разделе приложения иметь уникальный адрес электронной почты. Значение по умолчанию — `true`. |
| `type` | Указывает тип поставщика. Это значение обязательно. |

**Таблица 2**. параметры конфигурации членства и `SqlMembershipProvider`

Помимо `AspNetSqlMembershipProvider`, другие поставщики членства могут быть зарегистрированы на уровне приложения путем добавления аналогичной разметки в файл `Web.config`.

> [!NOTE]
> Платформа ролей работает практически так же: в `machine.config` есть зарегистрированный поставщик ролей по умолчанию, а зарегистрированные поставщики могут быть настроены отдельно для каждого приложения в `Web.config`. В следующем руководстве мы подробно рассмотрим платформу ролей и разметку конфигурации.

### <a name="customizing-thesqlmembershipprovidersettings"></a>Настройка параметров`SqlMembershipProvider`

Для `SqlMembershipProvider` по умолчанию (`AspNetSqlMembershipProvider`) для атрибута `connectionStringName` задано значение `LocalSqlServer`. Как и поставщик `AspNetSqlMembershipProvider`, имя строки подключения `LocalSqlServer` определено в `machine.config`.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-cs/samples/sample2.xml)]

Как видите, эта строка подключения определяет базу данных SQL 2005 Express Edition, расположенную по адресу | DataDirectory | aspnetdb. mdf. Строка | DataDirectory | преобразуется во время выполнения, чтобы указывать на каталог `~/App_Data/`, поэтому путь к базе данных | DataDirectory | aspnetdb. mdf преобразуется в `~/App_Data`/`aspnet.mdf`.

Если мы не указали сведения о поставщике членства в файле `Web.config` приложения, приложение использует зарегистрированного поставщика членства по умолчанию, `AspNetSqlMembershipProvider`. Если `~/App_Data/aspnet.mdf` базы данных не существует, среда выполнения ASP.NET автоматически создаст ее и добавит схему служб приложений. Однако мы не хотим использовать базу данных `aspnet.mdf`. Вместо этого мы хотим использовать базу данных `SecurityTutorials.mdf`, созданную на шаге 2. Это изменение можно выполнить одним из двух способов:

- <strong>Укажите значение</strong> <strong>`LocalSqlServer`</strong> <strong>имя строки подключения в</strong> <strong>`Web.config`</strong> <strong>.</strong> Перезаписав значение имени строки подключения `LocalSqlServer` в `Web.config`, можно использовать зарегистрированного поставщика членства по умолчанию (`AspNetSqlMembershipProvider`) и правильно работать с базой данных `SecurityTutorials.mdf`. Этот подход подходит, если вы используете содержимое с параметрами конфигурации, заданными `AspNetSqlMembershipProvider`. Дополнительные сведения об этом методе см. в записи блога [Скотта Гатри (](https://weblogs.asp.net/scottgu/), [которая настраивает ASP.NET 2,0 Службы приложений для использования SQL Server 2000 или SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx).
- <strong>Добавьте новый зарегистрированный поставщик типа</strong> <strong>`SqlMembershipProvider`</strong> <strong>и настройте его</strong> параметры<strong>`connectionStringName`</strong>, <strong>чтобы она указывала</strong> на <strong>базу данных</strong> <strong>`SecurityTutorials.mdf`</strong>. Этот подход полезен в сценариях, где необходимо настроить другие свойства конфигурации в дополнение к строке подключения к базе данных. В собственных проектах я всегда использую этот подход из-за его гибкости и удобочитаемости.

Перед добавлением нового зарегистрированного поставщика, который ссылается на `SecurityTutorials.mdf` базу данных, сначала необходимо добавить соответствующее значение строки подключения в раздел `<connectionStrings>` в `Web.config`. Следующая разметка добавляет новую строку подключения с именем `SecurityTutorialsConnectionString`, которая ссылается на базу данных SQL Server 2005, экспресс-выпуск `SecurityTutorials.mdf` в папке `App_Data`.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-cs/samples/sample3.xml)]

> [!NOTE]
> При использовании альтернативного файла базы данных обновите строку подключения по мере необходимости. Дополнительные сведения о создании правильной строки подключения см. в разделе [connectionStrings.com](http://www.connectionstrings.com/).

Затем добавьте следующую разметку конфигурации членства в файл `Web.config`. Эта разметка регистрирует новый поставщик с именем `SecurityTutorialsSqlMembershipProvider`.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-cs/samples/sample4.xml)]

Помимо регистрации поставщика `SecurityTutorialsSqlMembershipProvider`, приведенная выше разметка определяет `SecurityTutorialsSqlMembershipProvider` как поставщик по умолчанию (через атрибут `defaultProvider` в элементе `<membership>`). Вспомним, что инфраструктура членства может иметь несколько зарегистрированных поставщиков. Поскольку `AspNetSqlMembershipProvider` регистрируется в качестве первого поставщика в `machine.config`, он выступает в качестве поставщика по умолчанию, если не указано иное.

В настоящее время наше приложение имеет два зарегистрированных поставщика: `AspNetSqlMembershipProvider` и `SecurityTutorialsSqlMembershipProvider`. Однако перед регистрацией поставщика `SecurityTutorialsSqlMembershipProvider` можно было удалить все ранее зарегистрированные поставщики, добавив [элемент`<clear />`](https://msdn.microsoft.com/library/t062y6yc.aspx) непосредственно перед элементом `<add>`. Это приведет к очистке `AspNetSqlMembershipProvider` из списка зарегистрированных поставщиков, то есть `SecurityTutorialsSqlMembershipProvider` будет единственным зарегистрированным поставщиком членства. Если мы использовали такой подход, то не нужно помечать `SecurityTutorialsSqlMembershipProvider` как поставщик по умолчанию, так как это единственный зарегистрированный поставщик членства. Дополнительные сведения об использовании `<clear />`см. в разделе [использование `<clear />` при добавлении поставщиков](https://weblogs.asp.net/scottgu/archive/2006/11/20/common-gotcha-don-t-forget-to-clear-when-adding-providers.aspx).

Обратите внимание, что параметр `connectionStringName` `SecurityTutorialsSqlMembershipProvider`ссылается на только что добавленное `SecurityTutorialsConnectionString` имя строки подключения, а для его параметра `applicationName` задано значение Секурититуториалс. Кроме того, для параметра `requiresUniqueEmail` задано значение `true`. Все остальные параметры конфигурации идентичны значениям в `AspNetSqlMembershipProvider`. При желании вы можете настроить здесь любые изменения конфигурации. Например, можно усилить стойкость пароля, запросив два небуквенно-цифровых символа, а не один, или увеличить длину пароля до восьми символов, а не семь.

> [!NOTE]
> Вспомним, что платформа членства позволяет секционировать единое хранилище пользователей в нескольких приложениях. Параметр `applicationName` поставщика членства указывает, какое приложение поставщик использует при работе с хранилищем пользователей. Важно явно задать значение для параметра конфигурации `applicationName`, так как если `applicationName` не задан явно, он назначается виртуальному корневому каталогу веб-приложения во время выполнения. Это работает нормально, пока виртуальный корневой каталог приложения не изменится, но при перемещении приложения в другой путь параметр `applicationName` изменится. В этом случае поставщик членства начнет работать с другой секцией приложения, чем использовалась ранее. Учетные записи пользователей, созданные до перемещения, будут находиться в разных разделах приложений, и эти пользователи больше не смогут войти на сайт. Более подробное обсуждение этой проблемы см. в разделе [всегда задавать свойство `applicationName` при настройке членства ASP.NET 2,0 и других поставщиков](https://weblogs.asp.net/scottgu/443634).

## <a name="summary"></a>Сводка

На этом этапе у нас есть база данных с настроенными службами приложений (`SecurityTutorials.mdf`) и настроено веб-приложение, чтобы инфраструктура членства использовала только что зарегистрированный поставщик `SecurityTutorialsSqlMembershipProvider`. Этот зарегистрированный поставщик относится к типу `SqlMembershipProvider` и имеет свой `connectionStringName`, для которого задана соответствующая строка подключения (`SecurityTutorialsConnectionString`) и явно задано значение `applicationName`.

Теперь мы готовы использовать платформу членства из нашего приложения. В следующем учебном курсе будет рассмотрено создание новых учетных записей пользователей. Далее мы рассмотрим проверку подлинности пользователей, выполнение авторизации на основе пользователей и хранение в базе данных дополнительных сведений, относящихся к пользователю.

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Всегда задавайте свойство `applicationName` при настройке членства в ASP.NET 2,0 и других поставщиков.](https://weblogs.asp.net/scottgu/443634)
- [Настройка ASP.NET 2,0 Службы приложений для использования SQL Server 2000 или SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx)
- [Скачать SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?FamilyId=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796&amp;displaylang=en)
- [Проверка членства, ролей и профиля ASP.NET 2,0](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Элемент `<add>` для поставщиков для членства](https://msdn.microsoft.com/library/whae3t94.aspx)
- [Элемент `<membership>`](https://msdn.microsoft.com/library/1b9hw62f.aspx)
- [Элемент `<providers>` для членства](https://msdn.microsoft.com/library/6d4936ht.aspx)
- [Использование `<clear />` при добавлении поставщиков](https://weblogs.asp.net/scottgu/archive/2006/11/20/common-gotcha-don-t-forget-to-clear-when-adding-providers.aspx)
- [Непосредственная работа с `SqlMembershipProvider`](http://aspnet.4guysfromrolla.com/articles/091207-1.aspx)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a>Видеообучение по темам, содержащимся в этом руководстве

- [Общие сведения о членствах ASP.NET](../../../videos/authentication/understanding-aspnet-memberships.md)
- [Настройка SQL для работы со схемами членства](../../../videos/authentication/configuring-sql-to-work-with-membership-schemas.md)
- [Изменение настроек членства в схеме членства по умолчанию](../../../videos/authentication/changing-membership-settings-in-the-default-membership-schema.md)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — *[Sams обучать себя ASP.NET 2,0 за 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)* . Скотт можно получить по адресу [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) или через свой блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Специалист по интересу для этого руководства был Аликжа Мазиарз. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4guysfromrolla.com).

> [!div class="step-by-step"]
> [Дальше](creating-user-accounts-cs.md)
