---
uid: web-forms/overview/older-versions-security/membership/storing-additional-user-information-vb
title: Сохранение дополнительных сведений о пользователе (Visual Basic) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве мы будет ответить на этот вопрос с создания приложения очень просты гостевой книги. Таким образом, мы рассмотрим различные варианты modeli...
ms.author: riande
ms.date: 01/18/2008
ms.assetid: ee4b924e-8002-4dc3-819f-695fca1ff867
msc.legacyurl: /web-forms/overview/older-versions-security/membership/storing-additional-user-information-vb
msc.type: authoredcontent
ms.openlocfilehash: 33e686cc3b977c6c740dfaf1057e1e399d5a298b
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57052981"
---
<a name="storing-additional-user-information-vb"></a>Сохранение дополнительных сведений о пользователе (VB)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_08_VB.zip) или [скачать PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial08_ExtraUserInfo_vb.pdf)

> В этом руководстве мы будет ответить на этот вопрос с создания приложения очень просты гостевой книги. Таким образом, мы рассмотрим различные варианты моделирования сведения о пользователе в базе данных и затем узнать, как связать эти данные с учетные записи пользователей, созданные платформой членства.


## <a name="introduction"></a>Вступление

ASP. Членство в .NET framework предлагает гибкие интерфейс для управления пользователями. API членства включает методы для проверки учетных данных, получения сведений о текущего пользователя, создание учетной записи пользователя и удаление учетной записи пользователя, помимо прочего. Каждая учетная запись пользователя в структуру членства содержит только свойства, необходимые для проверки учетных данных и выполнение задач, связанные с учетной записью essential пользователя. Об этом свидетельствуют методам и свойствам [ `MembershipUser` класс](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), который моделирует учетной записи пользователя в структуру членства. Этот класс имеет свойства, такие как [ `UserName` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.username.aspx), [ `Email` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.email.aspx), и [ `IsLockedOut` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx), и методы, такие как [ `GetPassword` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.getpassword.aspx) и [ `UnlockUser` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).

Очень часто приложений необходимо сохранять дополнительные сведения о пользователе не включены в структуру членства. Например Интернет-магазине может потребоваться разрешить каждому пользователю хранить ее адреса доставки и выставления счетов, сведения о платеже, предпочтения доставки и контактный номер телефона. Кроме того каждый заказ в системе, связанный с записью определенного пользователя.

`MembershipUser` Класс не имеет свойства, такие как `PhoneNumber` или `DeliveryPreferences` или `PastOrders`. Так как мы отслеживать сведения о пользователе, необходимые для приложения и его интеграции с помощью структуры членства? В этом руководстве мы будет ответить на этот вопрос с создания приложения очень просты гостевой книги. Таким образом, мы рассмотрим различные варианты моделирования сведения о пользователе в базе данных и затем узнать, как связать эти данные с учетные записи пользователей, созданные платформой членства. Давайте начнем!

## <a name="step-1-creating-the-guestbook-applications-data-model"></a>Шаг 1. Создание модели данных приложения гостевой книги

Существуют различные методы, которые можно использовать для записи сведения о пользователе в базе данных и связать его с учетные записи пользователей, созданные платформой членства. Чтобы продемонстрировать данные методы, необходимо дополнить учебника веб-приложение, которое включало какую-либо данные о пользователях. (В настоящее время содержит модель данных приложения, только таблицы, необходимые для служб приложений `SqlMembershipProvider`.)

Давайте создадим приложение очень простую гостевую книгу, где прошедший проверку пользователь может оставить комментарий. Помимо хранения комментариях, разрешите подключение для каждого пользователя, для хранения его домашней города, домашней страницы и подпись. Если указано, домашний Город пользователя, домашней страницы и подпись будет отображаться для каждого сообщения, которые он оставил в гостевой книги.

### <a name="adding-theguestbookcommentstable"></a>Добавление`GuestbookComments`таблицы

Чтобы записать в комментариях, нам необходимо создать таблицу базы данных с именем `GuestbookComments` , содержит столбцы, такие как `CommentId`, `Subject`, `Body`, и `CommentDate`. Мы также требуются каждой записи `GuestbookComments` ссылки на таблицу пользователя, который оставил комментарий.

Чтобы добавить эту таблицу в базе данных, перейдите в обозреватель базы данных в Visual Studio и детализировать `SecurityTutorials` базы данных. Щелкните правой кнопкой мыши папку «таблицы» и выберите Добавить новую таблицу. Откроется интерфейс, который позволяет определить столбцы для новой таблицы.


[![Добавить новую таблицу в базе данных SecurityTutorials](storing-additional-user-information-vb/_static/image2.png)](storing-additional-user-information-vb/_static/image1.png)

**Рис. 1**: Добавить новую таблицу для `SecurityTutorials` базы данных ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image3.png))


Затем определите `GuestbookComments`в столбцы. Начните с добавления столбца с именем `CommentId` типа `uniqueidentifier`. Этот столбец будет уникальной идентификации каждого комментария в гостевой книги, поэтому запрещать `NULL` s и пометить его как первичный ключ таблицы. Вместо того, чтобы предоставить значение для `CommentId` на каждый `INSERT`, мы может указывать, что новый `uniqueidentifier` значение должно создаваться автоматически для этого поля на `INSERT` , задав значение столбца по умолчанию `NEWID()`. После добавления этого первого поля, пометив его как первичный ключ и параметров значения по умолчанию и экран должен выглядеть аналогично снимок экрана, показанный на рис. 2.


[![Добавление основной столбец с именем CommentId](storing-additional-user-information-vb/_static/image5.png)](storing-additional-user-information-vb/_static/image4.png)

**Рис. 2**: Добавление основной столбец с именем `CommentId` ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image6.png))


Добавьте столбец с именем `Subject` типа `nvarchar(50)` и столбец с именем `Body` типа `nvarchar(MAX)`, запрет `NULL` s в обоих столбцах. После этого добавьте столбец с именем `CommentDate` типа `datetime`. Запретить `NULL` и установить `CommentDate` по умолчанию значение столбца для `getdate()`.

Все, что остается лишь добавить столбец, который связывает учетную запись пользователя с каждым из этих комментариев гостевой книги. Один из вариантов следовало бы добавить столбец с именем `UserName` типа `nvarchar(256)`. Это является подходящим выбором при использовании поставщика членства, отличные от `SqlMembershipProvider`. Но при использовании `SqlMembershipProvider`, поскольку в этой серии руководств `UserName` столбца в `aspnet_Users` таблицы не обязательно быть уникальным. `aspnet_Users` Является первичным ключом таблицы `UserId` и имеет тип `uniqueidentifier`. Таким образом `GuestbookComments` таблица должна столбец с именем `UserId` типа `uniqueidentifier` (запрет `NULL` значения). Теперь добавим этот столбец.

> [!NOTE]
> Как уже говорилось в [ *Создание схемы членства в SQL Server* ](creating-the-membership-schema-in-sql-server-vb.md) учебника, обеспечивает возможность нескольких веб-приложений с разными учетными записями одного и того же структуру членства хранилище пользователя. Это достигается путем разделения учетных записей пользователей на различных приложений. И хотя каждое имя пользователя гарантированно будет уникальным в пределах приложения, того же имени пользователя может использоваться в различных приложениях, используя то же хранилище пользователя. Имеется составной `UNIQUE` ограничение в `aspnet_Users` таблицы на `UserName` и `ApplicationId` поля, но не на только что `UserName` поля. Следовательно, возможна aspnet\_таблице Users иметь два (или более) записей с одним `UserName` значение. Однако, есть `UNIQUE` ограничение на `aspnet_Users` таблицы `UserId` поле (так как он является первичным ключом). Объект `UNIQUE` ограничение важно, поскольку без него не удается установить ограничение внешнего ключа между `GuestbookComments` и `aspnet_Users` таблицы.


После добавления `UserId` столбцом, сохранить таблицу, щелкнув значок "Сохранить" на панели инструментов. Назовите новую таблицу `GuestbookComments`.

У нас есть один прошлом выпуске, чтобы заняться работой с `GuestbookComments` таблицы: нам необходимо создать [ограничение внешнего ключа](https://msdn.microsoft.com/library/ms175464.aspx) между `GuestbookComments.UserId` столбца и `aspnet_Users.UserId` столбца. Для этого щелкните значок «связи» в панели инструментов, чтобы открыть диалоговое окно связи по внешнему ключу. (Кроме того, можно открыть его, перейдя в меню конструктора таблиц и выборе связи.)

В левом нижнем углу диалогового окна связи по внешнему ключу, нажмите кнопку Добавить. Будут добавлены новые ограничения внешнего ключа, несмотря на то, что мы по-прежнему требуется для определения таблиц, участвующих в связи.


[![Используйте диалоговое окно связей по внешнему ключу для управления ограничения внешнего ключа таблицы](storing-additional-user-information-vb/_static/image8.png)](storing-additional-user-information-vb/_static/image7.png)

**Рис. 3**: Использовать для управления ограничения внешнего ключа таблицы внешнего ключа связи диалоговом окне ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image9.png))


Затем щелкните значок многоточия в строке «Спецификации таблиц и столбцов» в правой части. Это приведет к запуску таблиц и столбцов, диалоговое окно, из которого можно указать таблицы первичного ключа и столбец и столбец внешнего ключа из `GuestbookComments` таблицы. В частности, выбирайте `aspnet_Users` и `UserId` как таблица первичного ключа и столбец, и `UserId` из `GuestbookComments` таблице как столбец внешнего ключа (см. рис. 4). После определения первичного и внешнего ключа таблицы и столбцы, нажмите кнопку ОК, чтобы вернуться в диалоговое окно связи по внешнему ключу.


[![Определение внешнего ключа ограничения между aspnet_Users и GuesbookComments таблиц](storing-additional-user-information-vb/_static/image11.png)](storing-additional-user-information-vb/_static/image10.png)

**Рис. 4**: Установить внешнего ключа ограничения между `aspnet_Users` и `GuesbookComments` таблиц ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image12.png))


На этом этапе было установлено ограничение внешнего ключа. Наличие этого ограничения гарантирует [реляционной целостности](http://en.wikipedia.org/wiki/Referential_integrity) между двумя таблицами, гарантируя, что никогда не будет записи гостевой книги, ссылающийся на учетную запись пользователя не существует. По умолчанию ограничения внешнего ключа запретит родительскую запись удаленным, если существуют соответствующие дочерние записи. То есть если пользователь создает один или несколько комментариях, а затем предпринимается попытка удаления этой учетной записи пользователя, удаления, если не сначала удалить его комментариях.

Ограничения внешнего ключа можно настроить автоматическое удаление связанных дочерних записей при удалении родительской записи. Другими словами мы можете настроить это ограничение внешнего ключа, чтобы записи гостевой книги пользователя будут автоматически удалены при удалении своей учетной записи пользователя. Для этого разверните раздел «INSERT и UPDATE спецификация» и присвойте свойству «Удалить правило» Cascade.


[![Настройка ограничения внешнего ключа для каскадное удаление](storing-additional-user-information-vb/_static/image14.png)](storing-additional-user-information-vb/_static/image13.png)

**Рис. 5**: Настроить ограничение внешнего ключа для каскадные удаления ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image15.png))


Чтобы сохранить ограничение внешнего ключа, нажмите кнопку «Закрыть», чтобы выйти из связи внешних ключей. Щелкните значок "Сохранить" в панели инструментов, чтобы сохранить в таблице и эта связь.

### <a name="storing-the-users-home-town-homepage-and-signature"></a>Хранение домашней Город пользователя, домашней страницы и подпись

`GuestbookComments` Таблице показано, как для хранения информации, один ко многим связь с учетных записей пользователей. Поскольку каждая учетная запись пользователя может иметь произвольное число комментарий, эта связь моделируется путем создания таблицы для хранения комментариев со столбцом, что ссылается каждый комментарий к конкретному пользователю. При использовании `SqlMembershipProvider`, связь лучше всего будет установлена, создав столбец с именем `UserId` типа `uniqueidentifier` и ограничение внешнего ключа между этот столбец и `aspnet_Users.UserId`.

Теперь нам нужно связать три столбца с каждой учетной записи пользователя для хранения пользователя родном городе пользователя домашней страницы и подпись, которая будет отображаться в своем комментарии гостевой книги. Существуют число различных способов выполнения этой задачи:

- <strong>Добавить столбцы</strong><strong>`aspnet_Users`</strong><strong>или</strong><strong>`aspnet_Membership`</strong><strong>таблиц.</strong> Я не рекомендую этот подход, так как она изменяет схемы, используемой `SqlMembershipProvider`. Это решение может вернуться перейдет в будущем. Например, что делать, если будущей версии ASP.NET использует другое `SqlMembershipProvider` схемы. Microsoft может включать средство для переноса в ASP.NET 2.0 `SqlMembershipProvider` данных до новой схемы, но если вы изменили в ASP.NET 2.0 `SqlMembershipProvider` схемы, такое преобразование может оказаться невозможным.

- **С помощью ASP. NET framework профиля, определение свойства профиля для домашних города, домашней страницы и подпись.** ASP.NET включает платформу профиль, предназначенный для хранения дополнительных данных конкретного пользователя. Как структуру членства профиля framework строится поверх модели поставщиков. .NET Framework поставляется с `SqlProfileProvider` , хранящий данные в базе данных SQL Server профилей. На самом деле, нашей базе данных уже есть таблицы, используемой `SqlProfileProvider` (`aspnet_Profile`), как он был добавлен, когда мы добавили служб приложения обратно в [ *Создание схемы членства в SQL Server* ](creating-the-membership-schema-in-sql-server-vb.md)руководства.   
  Основным преимуществом framework профиля — что он позволяет разработчикам определять свойства профиля в `Web.config` — код не нужно писать для сериализации данных профиля в и из базового хранилища данных. Короче говоря это очень просто определить набор свойств профилей и работа с ними в коде. Тем не менее, система профиля далека от идеальной желать лучшего, когда дело доходит до управления версиями, поэтому, если у вас есть приложение, где предполагается, что новые пользовательские свойства для добавления в более позднее время или существующие, чтобы удалить или изменить, а затем framework профиля не может быть  лучшим вариантом. Кроме того `SqlProfileProvider` сохраняет свойство профиля высокой денормализованные образом, что делает практически невозможным для выполнения запросов непосредственно к данные профиля (например, сколько пользователей имеют домашний города Нью-Йорк).   
  Дополнительные сведения о профиле framework см. в разделе «Дополнительные материалы» в конце этого руководства.

- <strong>Добавьте эти три столбца в новую таблицу в базе данных и установить отношение один к одному между этой таблицей и</strong><strong>`aspnet_Users`</strong><strong>.</strong> Этот подход требует немного больше усилий, чем с помощью платформы профиля, но предоставляет максимальную гибкость при как дополнительные пользовательские свойства моделируются в базе данных. Это параметр, которые будут использоваться в этом руководстве.

Мы создадим новую таблицу с именем `UserProfiles` сохранить родного города, домашней страницы и подписи для каждого пользователя. Щелкните правой кнопкой мыши папку «таблицы» в окне обозревателя базы данных и выберите команду Создать новую таблицу. Имя первого столбца `UserId` и установите для него `uniqueidentifier`. Запретить `NULL` значений и пометить столбец как первичный ключ. Добавьте столбцы с именами: `HomeTown` типа `nvarchar(50)`; `HomepageUrl` типа `nvarchar(100)`; и сигнатуры типа `nvarchar(500)`. Каждый из этих трех столбцов может принимать `NULL` значение.


[![Создать таблицу UserProfiles](storing-additional-user-information-vb/_static/image17.png)](storing-additional-user-information-vb/_static/image16.png)

**Рис. 6**: Создание `UserProfiles` таблицы ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image18.png))


Сохраните таблицу и назовите его `UserProfiles`. Наконец, установить ограничение внешнего ключа между `UserProfiles` таблицы `UserId` поля и `aspnet_Users.UserId` поля. Как мы сделали с ограничение внешнего ключа между `GuestbookComments` и `aspnet_Users` таблицы, имеют этого ограничения каскадное удаление. Так как `UserId` в `UserProfiles` первичный ключ — это гарантирует, что будет существовать не более чем одной записи в `UserProfiles` таблицы для каждой учетной записи пользователя. Этот тип связи называется как один к одному.

Теперь, когда у нас есть модель данных, созданная, мы готовы использовать его. В шагах 2 и 3 мы рассмотрим как текущего пользователя можно просматривать и изменять их домашней города, домашней страницы и информацию о подписи. На шаге 4 мы создадим интерфейс для прошедших проверку пользователей отправить новые комментарии в гостевую книгу и просматривать существующие серверы.

## <a name="step-2-displaying-the-users-home-town-homepage-and-signature"></a>Шаг 2. Отображение домашней Город пользователя, домашней страницы и подписи

Существует ряд способов, чтобы разрешить текущего пользователя для просмотра и изменения его домашней города, домашней страницы и информацию о подписи. Можно вручную создать пользовательский интерфейс с текстовым полем и меток или мы использовать один из элементов управления, например элемент управления DetailsView. Для выполнения базы данных `SELECT` и `UPDATE` операторов, ADO.NET можно было бы написать код на нашей странице вспомогательного класса, или в качестве альтернативы использовать декларативный подход с помощью элемента управления SqlDataSource. В идеале наше приложение будет содержать многоуровневые архитектуры, мы, либо может вызвать программно из вспомогательного класса страницы, или декларативно с помощью элемента управления ObjectDataSource.

Так как в этой серии руководств посвящена форм проверки подлинности, авторизации, учетные записи пользователей и ролей, не будет подробное описание этих параметров доступа другими данными или почему многоуровневые архитектуры предпочтительнее, чем выполнение инструкций SQL непосредственно на странице ASP.NET. Я собираюсь изучить использование DetailsView и SqlDataSource — параметр быстрый и простой — но обсуждавшиеся определенно могут применяться к альтернативным Web элементы управления и данных логики доступа к. Дополнительные сведения о работе с данными в ASP.NET см. Мой *[работа с данными в ASP.NET 2.0](../../data-access/index.md)* серии руководств.

Откройте `AdditionalUserInfo.aspx` странице в `Membership` папку и добавьте элемент управления DetailsView на страницу, устанавливая его свойство ID `UserProfile` и очищая его `Width` и `Height` свойства. Разверните DetailsView смарт-тег и выберите привязать его к новый элемент управления источником данных. Это приведет к запуску мастера настройки источника данных (см. рис. 7). Первым шагом просит указать тип источника данных. Так как мы собираемся подключать напрямую к `SecurityTutorials` базы данных, выберите значок базы данных, указав `ID` как `UserProfileDataSource`.


[![Добавление нового элемента управления SqlDataSource с именем UserProfileDataSource](storing-additional-user-information-vb/_static/image20.png)](storing-additional-user-information-vb/_static/image19.png)

**Рис. 7**: Добавление нового элемента управления SqlDataSource с именем `UserProfileDataSource` ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image21.png))


Далее запрашивает для базы данных. Мы уже определили строку подключения в `Web.config` для `SecurityTutorials` базы данных. Это имя строки подключения — `SecurityTutorialsConnectionString` — должны находиться в раскрывающемся списке. Выберите этот вариант и нажмите кнопку Далее.


[![Выберите SecurityTutorialsConnectionString из раскрывающегося списка](storing-additional-user-information-vb/_static/image23.png)](storing-additional-user-information-vb/_static/image22.png)

**Рис. 8**: Выберите `SecurityTutorialsConnectionString` из раскрывающегося списка ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image24.png))


Последующие экране указать таблицы и столбцы для запроса. Выберите `UserProfiles` таблицу из раскрывающегося списка и проверьте все столбцы.


[![Перевести обратно все столбцы из таблицы UserProfiles](storing-additional-user-information-vb/_static/image26.png)](storing-additional-user-information-vb/_static/image25.png)

**Рис. 9**: Переместить назад все столбцы из `UserProfiles` таблицы ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image27.png))


Текущий запрос на рис. 9 возвращает *все* записей в `UserProfiles`, но нас интересует только запись текущего пользователя. Чтобы добавить `WHERE` предложение, щелкните `WHERE` , чтобы открыть добавления `WHERE` предложение диалоговом (см. рис. 10). Здесь можно выбрать столбец для фильтрации, оператора и источник параметра filter. Выберите `UserId` как столбец и «=», что и оператор.

К сожалению, отсутствует встроенный параметр источник для возврата текущего пользователя `UserId` значение. Нам потребуется получить это значение программно. Таким образом задайте исходного стрелку раскрывающегося списка для «Нет» нажмите кнопку Add для добавления параметра, а затем нажмите кнопку ОК.


[![Добавьте параметр фильтра на столбец UserId](storing-additional-user-information-vb/_static/image29.png)](storing-additional-user-information-vb/_static/image28.png)

**Рис. 10**: Добавьте параметр фильтра на `UserId` столбца ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image30.png))


После нажатия кнопки ОК вы вернетесь на экран, показанный на рис. 9. На этот раз тем не менее, SQL-запрос в нижней части экрана должен включать `WHERE` предложение. Для перехода экран «Проверка запроса», нажмите кнопку "Далее". Здесь можно выполнить запрос и просмотреть результаты. Нажмите кнопку Готово, чтобы завершить работу мастера.

После завершения работы мастера настройки источника данных, Visual Studio создает элемент управления SqlDataSource, на основе параметров, указанных в мастере. Кроме того, он самостоятельно добавляет поля BoundField, кроме к элементу управления DetailsView для каждого столбца, возвращаемые SqlDataSource `SelectCommand`. Нет необходимости, чтобы показать `UserId` поле в DetailsView, поскольку пользователь не нужно знать это значение. Вы можете удалить это поле непосредственно из декларативная разметка элемента управления DetailsView или, нажав кнопку «Изменить поля» ссылка из его смарт-тега.

На этом этапе декларативная разметка страницы должна выглядеть следующего вида:

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample1.aspx)]

Нам необходимо программно задать элемента управления SqlDataSource `UserId` параметр для текущего вошедшего пользователя `UserId` до выбора данных. Это можно сделать, создав обработчик событий для элемента управления SqlDataSource `Selecting` событий и добавьте следующий код существует:

[!code-vb[Main](storing-additional-user-information-vb/samples/sample2.vb)]

Приведенный выше код запускается, получив ссылку на текущего пользователя, вызвав `Membership` класса `GetUser` метод. Эта команда возвращает `MembershipUser` , чье свойство `ProviderUserKey` свойство содержит `UserId`. `UserId` Значение затем присваивается SqlDataSource `@UserId` параметра.

> [!NOTE]
> `Membership.GetUser()` Метод возвращает сведения о текущего пользователя. Если анонимный пользователь посетив страницу, то возвращается значение `Nothing`. В таком случае это приведет к `NullReferenceException` на следующую строку кода, при попытке прочесть `ProviderUserKey` свойство. Само собой, нам не нужно беспокоиться о `Membership.GetUser()` возвращает ноль в `AdditionalUserInfo.aspx` странице, поскольку настроен непрерывный режим авторизации URL-адреса в предыдущем руководстве, чтобы только прошедшие проверку удалось получить доступ к ресурсам в этой папке ASP.NET. Если требуется доступ к сведениям о текущего пользователя на странице, где разрешен анонимный доступ, убедитесь в том, чтобы убедиться, что `MembershipUser` объект, возвращенный из `GetUser()` метод не является Nothing перед ссылкой его свойства.


При посещении `AdditionalUserInfo.aspx` страницы в обозревателе вы увидите пустую страницу, так как у нас есть еще добавить ни одной строки для `UserProfiles` таблицы. На шаге 6 мы рассмотрим способы настройки элемента управления CreateUserWizard для автоматического добавления новой строки к `UserProfiles` таблицы при создании учетной записи пользователя. Однако теперь необходимо вручную создать запись в таблице.

Перейдите в обозреватель баз данных в Visual Studio и раскройте папку таблицы. Щелкните правой кнопкой мыши `aspnet_Users` таблицы и выберите «Показать таблицу данных» для просмотра записей в таблице; сделать то же самое `UserProfiles` таблицы. Рис. 11 отобразятся следующие результаты, когда Мозаичная по вертикали. В моей базе данных нет `aspnet_Users` записи для Брюс Fred и Tito, но ни одной записи в `UserProfiles` таблицы.


[![Отображается содержимое aspnet_Users и UserProfiles таблиц](storing-additional-user-information-vb/_static/image32.png)](storing-additional-user-information-vb/_static/image31.png)

**Рис. 11**: Содержание `aspnet_Users` и `UserProfiles` таблиц ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image33.png))


Добавить новую запись для `UserProfiles` таблицы, вручную введя значения для `HomeTown`, `HomepageUrl`, и `Signature` поля. Самый простой способ получить допустимый `UserId` значение в новом `UserProfiles` записи заключается в выборе `UserId` из учетной записи пользователя в `aspnet_Users` таблицы, скопируйте и вставьте его в `UserId` в `UserProfiles`. Рис. 12 показан `UserProfiles` таблицы после добавления новой записи для Брюс.


[![Запись была добавлена к UserProfiles Брюс](storing-additional-user-information-vb/_static/image35.png)](storing-additional-user-information-vb/_static/image34.png)

**Рис. 12**: Была добавлена запись `UserProfiles` для Брюс ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image36.png))


Вернитесь к `AdditionalUserInfo.aspx page`, выполнен вход как Брюс. Как показано на рис. 13, отображаются параметры Bruce's.


[![В настоящее время посещения он показано His параметры](storing-additional-user-information-vb/_static/image38.png)](storing-additional-user-information-vb/_static/image37.png)

**Рис. 13**: В настоящее время посещения он показано His параметры ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image39.png))


> [!NOTE]
> Переход вперед и вручную добавить записи в `UserProfiles` таблицы для каждого пользователя приложения Membership. На шаге 6 мы рассмотрим способы настройки элемента управления CreateUserWizard для автоматического добавления новой строки к `UserProfiles` таблицы при создании учетной записи пользователя.


## <a name="step-3-allowing-the-user-to-edit-his-home-town-homepage-and-signature"></a>Шаг 3. Что позволяет пользователю изменять его домашней города, домашней страницы и подписи

На этом этапе в настоящее время вошедшего в систему пользователь может просмотреть их родного города, домашней страницы и параметры подписи, но они еще не могут изменять их. Давайте обновим элементе управления DetailsView, так что можно изменять данные.

Первое, что нам нужно сделать — добавить `UpdateCommand` для элемента управления SqlDataSource, указав `UPDATE` инструкцию для выполнения и его соответствующие параметры. Выбор элемента управления SqlDataSource и в окне «Свойства» щелкните кнопку с многоточием рядом со свойством UpdateQuery, чтобы открыть диалоговое окно Редактор команд и параметров. Введите следующую `UPDATE` инструкции в текстовое поле:

[!code-sql[Main](storing-additional-user-information-vb/samples/sample3.sql)]

Затем щелкните кнопку «Обновить параметры», которая будет создан параметр в объекте элемента управления SqlDataSource `UpdateParameters` сбор данных для каждого параметра в `UPDATE` инструкции. Оставьте источника для всех набора параметров значение None и нажмите кнопку ОК, чтобы закрыть диалоговое окно.


[![Укажите UpdateCommand и UpdateParameters элемента управления SqlDataSource](storing-additional-user-information-vb/_static/image41.png)](storing-additional-user-information-vb/_static/image40.png)

**Рис. 14**: Укажите SqlDataSource `UpdateCommand` и `UpdateParameters` ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image42.png))


Из-за дополнения мы внесли в элемент управления SqlDataSource, DetailsView, элемент управления теперь поддерживает редактирование. Смарт-теге DetailsView установите флажок «Разрешить редактирование». Это поле добавляет CommandField элемента управления `Fields` коллекции с его `ShowEditButton` свойство присвоено значение True. Это делает кнопка «изменить», при отображении элемента управления DetailsView в режиме только для чтения и обновления и кнопки "Отмена", при отображении в режиме редактирования. Вместо того чтобы требовать от пользователя, щелкните "Изменить", однако мы может иметь отрисовки DetailsView в «всегда» состояние, задав элемента управления DetailsView [ `DefaultMode` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.defaultmode.aspx) для `Edit`.

Этих изменений декларативная разметка элемента управления DetailsView должен выглядеть следующим образом:

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample4.aspx)]

Обратите внимание на добавление CommandField и `DefaultMode` свойство.

Пойти дальше и проверить эту страницу через обозреватель. При посещении с пользователем, который имеет соответствующей записи в `UserProfiles`, параметры пользователя будут отображаться в интерфейс редактирования.


[![Элемент DetailsView отображает интерфейс редактирования](storing-additional-user-information-vb/_static/image44.png)](storing-additional-user-information-vb/_static/image43.png)

**Рис. 15**: Элемент DetailsView отображает интерфейс редактирования ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image45.png))


Попробуйте изменить значения и щелкнув кнопкой "Обновить". Он отображается, как если бы ничего не происходит. Обратная передача значения сохраняются в базу данных, но есть не визуальную обратную связь, произошедшего сохранения.

Чтобы исправить это, вернитесь в Visual Studio и добавьте элемент управления Label выше DetailsView. Задайте его `ID` для `SettingsUpdatedMessage`, ее `Text` свойства «параметры обновлены,» и его `Visible` и `EnableViewState` свойства `False`.

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample5.aspx)]

Нам нужно отобразить `SettingsUpdatedMessage` метки при изменении элемента управления DetailsView. Для этого необходимо создать обработчик событий для элемента DetailsView `ItemUpdated` событий и добавьте следующий код:

[!code-vb[Main](storing-additional-user-information-vb/samples/sample6.vb)]

Вернитесь к `AdditionalUserInfo.aspx` странице через браузер и обновления данных. В данном случае отображается сообщение о состоянии полезными.


[![Короткое сообщение будет отображаться после обновления параметров](storing-additional-user-information-vb/_static/image47.png)](storing-additional-user-information-vb/_static/image46.png)

**Рис. 16**: Короткое сообщение отображается в том случае, если параметры будут обновлены ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image48.png))


> [!NOTE]
> Элемент управления DetailsView редактирования интерфейса оставляет желать много лучшего. Она использует стандартного размера текстовых полей, но поле подписи, вероятно, должно быть многострочном текстовом поле. RegularExpressionValidator следует использовать, чтобы убедиться, что URL-адрес домашней страницы, если указано, начинается с « http://» или « https://». Кроме того, с момента DetailsView, элемент управления имеет его `DefaultMode` свойство значение `Edit`, ничего не происходит кнопки "Отмена". Он должен либо быть удален или, при нажатии перенаправить пользователя на другую страницу (такие как `~/Default.aspx`). Я оставьте эти усовершенствования в качестве упражнения для чтения.


### <a name="adding-a-link-to-theadditionaluserinfoaspxpage-in-the-master-page"></a>Добавление ссылки на`AdditionalUserInfo.aspx`страницы на главной странице

В настоящее время веб-сайт не поддерживает любые ссылки на `AdditionalUserInfo.aspx` страницы. Введите URL-адрес страницы непосредственно в адресной строке браузера является единственным способом получить к нему доступ. Давайте добавим ссылку на эту страницу в `Site.master` главной страницы.

Помните, что главная страница содержит LoginView веб-элемент управления в его `LoginContent` ContentPlaceHolder, отображающий разную разметку для посетителей проверенными и анонимными. Обновление элемента управления LoginView `LoggedInTemplate` включать ссылку на `AdditionalUserInfo.aspx` страницы. После внесения этих изменений в LoginView декларативная разметка элемента управления должен выглядеть следующим образом:

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample7.aspx)]

Обратите внимание, добавление `lnkUpdateSettings` гиперссылки для `LoggedInTemplate`. Вместе со ссылкой на месте прошедших проверку подлинности пользователей можно быстро перейти на страницу для просмотра и изменения их домашней города, домашней страницы и подпись.

## <a name="step-4-adding-new-guestbook-comments"></a>Шаг 4. Добавление новых комментариев гостевой книги

`Guestbook.aspx` Страница является где прошедшего проверку подлинности пользователи могут просматривать гостевой книги и оставьте комментарий. Давайте начнем с создания интерфейса, чтобы добавить новые комментарии гостевой книги.

Откройте `Guestbook.aspx` страницы в Visual Studio, а также создание пользовательского интерфейса, состоящий из двух элементов управления TextBox, новый комментарий субъекта и для его основной части. Значение первого элемента управления TextBox `ID` свойства `Subject` и его `Columns` значение 40; установите второй `ID` для `Body`, ее `TextMode` для `MultiLine`и его `Width` и `Rows` свойства «95%» и 8, соответственно. Чтобы завершить пользовательский интерфейс, добавьте кнопку веб-элемент управления с именем `PostCommentButton` и задайте его `Text` свойства «Опубликовать комментарий».

Так как каждый комментарий гостевой книги требуется тему и текст, добавьте RequiredFieldValidator для каждого из текстовых полей. Задайте `ValidationGroup` свойства этих элементов управления для «EnterComment»; аналогично, установите `PostCommentButton` элемента управления `ValidationGroup` свойства «EnterComment». Дополнительные сведения о ASP. Проверяющие элементы управления NET, извлечение [проверка форм в ASP.NET](http://www.4guysfromrolla.com/webtech/090200-1.shtml), [разбор элементов управления проверки в ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx)и [учебник элементов управления проверки сервера](http://www.w3schools.com/aspnet/aspnet_refvalidationcontrols.asp) на [W3Schools](http://www.w3schools.com/).

После создания пользовательского интерфейса декларативная разметка страницы должен выглядеть примерно следующим образом:

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample8.aspx)]

Полный пользовательский интерфейс, DAL следующей задачей является для вставки новой записи в `GuestbookComments` таблицу при `PostCommentButton` нажатии. Это можно сделать несколькими способами: можно написать код ADO.NET в кнопки `Click` обработчика событий; мы можно добавить на страницу элемент управления SqlDataSource, настройте его `InsertCommand`и затем вызвать его `Insert` метода из `Click` событий обработчик; или мы могли бы создавать среднего уровня, отвечающие за Вставка новых комментариях и вызова этих функций из `Click` обработчик событий. Так как мы рассмотрели применение элемента управления SqlDataSource на шаге 3, воспользуемся кода ADO.NET здесь.

> [!NOTE]
> Классы ADO.NET, используемые для программного доступа к данным из базы данных Microsoft SQL Server находятся в папке `System.Data.SqlClient` пространства имен. Может потребоваться импортировать это пространство имен в класс фонового кода страницы (т. е. `Imports System.Data.SqlClient`).


Создайте обработчик событий для `PostCommentButton`в `Click` событий и добавьте следующий код:

[!code-vb[Main](storing-additional-user-information-vb/samples/sample9.vb)]

`Click` Обработчик событий начинает с проверки допустимости данных, предоставленные пользователем. Если это не так, обработчик событий завершит работу перед вставкой записи. При условии, что является допустимым, предоставленные данные текущего пользователя `UserId` значение извлекается и хранится в `currentUserId` локальной переменной. Это значение требуется, так как нам необходимо предоставить `UserId` значение при вставке записи в `GuestbookComments`.

После этого строка соединения для `SecurityTutorials` базы данных извлекается из `Web.config` и `INSERT` задана инструкция SQL. Объект `SqlConnection` объект создается и открывается. Далее, `SqlCommand` объект создается и значения для параметров используются в `INSERT` запроса относятся. `INSERT` Выполняется инструкция, и подключение закрыто. В конце обработчика событий `Subject` и `Body` текстовые поля `Text` свойства, очищаются, чтобы значения пользователя не сохраняются между обратной передачи.

Продолжим и проверьте страницу в браузере. Так как эта страница находится в `Membership` папку оно не доступно для анонимных пользователей. Таким образом необходимо сначала войти (Если вы еще этого не сделали). Введите значение в `Subject` и `Body` текстовые поля и нажмите кнопку `PostCommentButton` кнопки. Это приведет к записи для добавления `GuestbookComments`. При обратной передаче тему и текст, который вы указали очищены из текстовых полей.

После нажатия кнопки `PostCommentButton` существует кнопка является не визуальную обратную связь, комментарий, добавленный в гостевую книгу. По-прежнему необходимо обновить эту страницу, чтобы отобразить существующие комментарии гостевой книги, которые мы будем использовать на шаге 5. Как только мы сделать это, только что добавлен комментарий будет отображаться в списке комментариев, предоставляя достаточно визуальную обратную связь. Сейчас, убедитесь, что гостевая книга комментарий был сохранен, проверив содержимое из `GuestbookComments` таблицы.

Рис. 17 показано содержимое `GuestbookComments` таблицу были добавлены два комментарии.


[![Вы увидите в комментариях в таблице GuestbookComments](storing-additional-user-information-vb/_static/image50.png)](storing-additional-user-information-vb/_static/image49.png)

**Рис. 17**: Вы увидите в комментариях в `GuestbookComments` таблицы ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image51.png))


> [!NOTE]
> Если пользователь пытается вставить комментарий гостевой книги, который содержит потенциально опасных разметка — например, HTML – ASP.NET вызывает исключение `HttpRequestValidationException`. Дополнительные сведения об этом исключении, почему она возникает исключение, и как разрешить пользователям отправлять потенциально опасных значений обратитесь к [запроса Технический документ проверки](../../../../whitepapers/request-validation.md).


## <a name="step-5-listing-the-existing-guestbook-comments"></a>Шаг 5. Список существующих комментариев гостевой книги

Помимо добавления комментариев, пользователю, просматривающему `Guestbook.aspx` страницы также должен иметь возможность просматривать существующие комментариях. Для этого добавьте элемент управления ListView, с именем `CommentList` в нижней части страницы.

> [!NOTE]
> Элемент управления ListView является новым для ASP.NET версии 3.5. Он предназначен для отображения списка элементов в очень настраиваемым и гибкий макет, но по-прежнему предлагают встроенные редактирование, вставка, удаление, разбиение по страницам и сортировка функциональные возможности, например GridView. Если вы используете ASP.NET 2.0, необходимо вместо этого используйте элемент управления DataList и Repeater. Дополнительные сведения об использовании ListView см. в разделе [Скотт Гатри](https://weblogs.asp.net/scottgu/)на запись в блоге [управления asp: ListView](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx)и моей статье [отображение данных с элементом управления ListView](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx).


Откройте ListView смарт-тег и из раскрывающегося списка Выбор источника данных привязка элемента управления к новому источнику данных. Как мы видели в шаге 2, это приведет к запуску мастера настройки источника данных. Выберите значок базы данных, имя результирующего элемента управления SqlDataSource `CommentsDataSource`и нажмите кнопку ОК. Затем выберите `SecurityTutorialsConnectionString` подключения строка из раскрывающегося списка и нажмите кнопку Далее.

На этом этапе на шаге 2 мы указали данные для запроса путем выбора `UserProfiles` таблицу из раскрывающегося списка и выберите столбцы, возвращаемые (см. рис. 9). На этот раз тем не менее, мы хотим создать инструкцию SQL, которая извлекает не только записи из `GuestbookComments`, но также комментирующий родного города, домашней страницы, подписи и имени пользователя. Таким образом установите переключатель «Указать пользовательские инструкции SQL или хранимой процедуры» и нажмите кнопку Далее.

Это приведет к появлению на экране «Определение пользовательских инструкций или хранимых процедурах». Нажмите кнопку построителя запросов для графического построения запроса. Построитель запросов начинает, предлагающее для указания таблицы, которые нам нужно создать запрос. Выберите `GuestbookComments`, `UserProfiles`, и `aspnet_Users` таблицы и нажмите кнопку ОК. Это добавит все три таблицы в область конструктора. Так как существуют ограничения внешнего ключа между отдельными `GuestbookComments`, `UserProfiles`, и `aspnet_Users` таблицы, построитель запросов автоматически `JOIN` s эти таблицы.

Все, что остается лишь указать столбцы, возвращаемые. Из `GuestbookComments` таблицы выберите `Subject`, `Body`, и `CommentDate` столбцы; возвращают `HomeTown`, `HomepageUrl`, и `Signature` столбцы из `UserProfiles` таблицы; и возвращать `UserName` из `aspnet_Users`. Кроме того, добавьте "`ORDER BY CommentDate DESC`" в конец `SELECT` запроса, чтобы последние записи, будут возвращены первыми. После выбора этих на на рис. 18 снимке экрана должна выглядеть интерфейс построителя запросов.


[![Запрос Constructed объединяет GuestbookComments, UserProfiles и aspnet_Users таблиц](storing-additional-user-information-vb/_static/image53.png)](storing-additional-user-information-vb/_static/image52.png)

**Рис. 18**: Запрос создан `JOIN` s `GuestbookComments`, `UserProfiles`, и `aspnet_Users` таблиц ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image54.png))


Нажмите кнопку ОК, чтобы закрыть окно построителя запросов и вернуться к экрану «Определение пользовательских инструкций или хранимых процедурах». Нажмите кнопку Далее, чтобы перейти на экран «Проверка запроса», где можно просмотреть результаты запроса, нажав кнопку Проверить запрос. Когда вы будете готовы, нажмите кнопку "Готово", чтобы завершить работу мастера настройки источника данных ".

Когда мы выполнили мастер настройки источников данных в шаге 2, сопоставленного элемента управления DetailsView `Fields` коллекция обновляется, чтобы добавить поле BoundField для каждого столбца, возвращаемые `SelectCommand`. ListView остался без изменений; Мы по-прежнему необходимо определить его макет. Макет ListView могут создаваться вручную через его декларативной разметки или из параметра «Настройка ListView» в его смарт-тега. Обычно я предпочитают определение разметку вручную, но использовать любой метод является наиболее естественным для вас.

Я в итоге, выполнив в `LayoutTemplate`, `ItemTemplate`, и `ItemSeparatorTemplate` для моего элемента управления ListView:

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample10.aspx)]

`LayoutTemplate` Определяет разметку передаются элементом управления, хотя `ItemTemplate` отображает каждый элемент, возвращаемый элемента управления SqlDataSource. `ItemTemplate`Полученная в итоге разметка помещается в `LayoutTemplate`в `itemPlaceholder` элемента управления. В дополнение к `itemPlaceholder`, `LayoutTemplate` включает элемент управления DataPager, который ограничивает ListView отображается всего 10 комментариях на одной странице (по умолчанию) и отображает интерфейс разбиения по страницам.

Мои `ItemTemplate` отображает каждый комментарий гостевой книги субъекта в `<h4>` элемент с телом, которые находятся ниже темы. Обратите внимание, что синтаксис, используемый для отображения текста принимает данные, возвращаемые `Eval("Body")` инструкции привязки данных, преобразует его в строку и заменяет разрывы строк с `<br />` элемент. Такое преобразование необходимо, чтобы показать разрывы строки, введенные при отправке комментарий, так как пробелы игнорируются по HTML. Подпись пользователя отображается под текст курсивом, следуют пользователя родном городе пользователя, ссылку на своей домашней страницы, даты и времени, сделанные комментарий, имя пользователя, тому, кто оставил комментарий.

Отвлекитесь и просмотрите страницу через обозреватель. Вы увидите комментарии, добавленные в гостевую книгу на шаге 5, показанные здесь.


[![Сейчас Guestbook.aspx отображается комментариях](storing-additional-user-information-vb/_static/image56.png)](storing-additional-user-information-vb/_static/image55.png)

**Рис. 19**: `Guestbook.aspx` Теперь отображает комментариях ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image57.png))


Попробуйте добавить нового комментария в гостевой книги. После нажатия кнопки `PostCommentButton` обратной передаче страницы кнопку Добавить комментарий к базе данных, а элемент управления ListView не обновляется для отображения нового комментария. Это можно исправить, либо:

- Обновление `PostCommentButton` кнопки `Click` обработчик событий, чтобы он вызывал элемента управления ListView `DataBind()` метод после вставки нового комментария в базе данных, или
- Настройка элемента управления ListView `EnableViewState` свойства `False`. Этот подход работает, поскольку отключение состояния представления элемента управления, его заново привязать к данным при каждой обратной передаче.

Учебника по веб-сайт загрузки из этого учебника описание обоих методов. Элемента управления ListView `EnableViewState` свойства `False` и представлены в код, необходимый для программным способом привяжите данные к ListView `Click` обработчик событий, но закомментирован.

> [!NOTE]
> В настоящее время `AdditionalUserInfo.aspx` страница позволяет пользователям просматривать и редактировать их домашней параметры города, домашней страницы и подпись. Было бы здорово обновить `AdditionalUserInfo.aspx` для отображения вошедшего в комментариях пользователя. То есть, помимо проверки и изменения ее сведения, пользователь может посетить `AdditionalUserInfo.aspx` страницу, чтобы увидеть, какие гостевая книга комментарии, она выполняется в прошлом. Оставить этот в качестве упражнения для интересующихся.


## <a name="step-6-customizing-the-createuserwizard-control-to-include-an-interface-for-the-home-town-homepage-and-signature"></a>Шаг 6. Элемент управления CreateUserWizard, чтобы включить интерфейс для домашней города, домашней страницы и подписи

`SELECT` Запроса, используемого `Guestbook.aspx` странице использует `INNER JOIN` для объединения связанных записей среди `GuestbookComments`, `UserProfiles`, и `aspnet_Users` таблицы. Если пользователь, не имеет записи в `UserProfiles` комментарий делает гостевой книги, комментария не будет отображаться в ListView, поскольку `INNER JOIN` возвращает только `GuestbookComments` записей при наличии совпадающих записей в `UserProfiles` и `aspnet_Users`. И как мы видели в шаге 3, если пользователь не имеет записи `UserProfiles` она нельзя просматривать или изменять ее параметры в `AdditionalUserInfo.aspx` страницы.

Нечего и говорить, из-за нашей структуре решения, очень важно, что все учетные записи пользователей в системе членства с совпадающим записи в `UserProfiles` таблицы. Мы хотим предназначен для соответствующей записи для добавления `UserProfiles` создается каждый раз, когда с помощью CreateUserWizard учетной записи пользователя членства.

Как уже говорилось в [ *Создание учетных записей пользователей* ](creating-user-accounts-vb.md) руководства, после создания новой учетной записи пользователя членства в элементе управления CreateUserWizard вызывает его [ `CreatedUser` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx). Мы можно создать обработчик событий для этого события, получить идентификатор пользователя для только что созданного пользователя и затем вставить запись в `UserProfiles` таблицы со значениями по умолчанию для `HomeTown`, `HomepageUrl`, и `Signature` столбцов. Более того существует возможность запрашивать у пользователя эти значения путем настройки интерфейса элемента управления CreateUserWizard включать дополнительные текстовые поля.

Давайте сначала рассмотрим способы добавления новой строки к `UserProfiles` в таблицу `CreatedUser` обработчик событий со значениями по умолчанию. После этого мы увидим, как настроить пользовательский интерфейс элемента управления CreateUserWizard включать дополнительные поля формы для сбора родного города нового пользователя, домашней страницы и подпись.

### <a name="adding-a-default-row-touserprofiles"></a>Добавление строки по умолчанию`UserProfiles`

В [ *Создание учетных записей пользователей* ](creating-user-accounts-vb.md) руководстве, мы добавили элемент управления CreateUserWizard для `CreatingUserAccounts.aspx` странице в `Membership` папку. Чтобы получить CreateUserWizard управления добавить запись `UserProfiles` таблицы при создании учетной записи пользователя, необходимо обновить функциональные возможности элемента управления CreateUserWizard. Вместо того, чтобы эти изменения к `CreatingUserAccounts.aspx` странице, можно вместо этого добавить новый элемент управления CreateUserWizard для `EnhancedCreateUserWizard.aspx` странице и внесите изменения в этом руководстве, существует.

Откройте `EnhancedCreateUserWizard.aspx` страницы в Visual Studio и перетащите элемент управления CreateUserWizard из панели элементов на странице. Значение элемента управления CreateUserWizard `ID` свойства `NewUserWizard`. Как уже говорилось в [ *Создание учетных записей пользователей* ](creating-user-accounts-vb.md) учебника, CreateUserWizard по умолчанию пользовательский интерфейс предлагает посетителя необходимую информацию. После этого информация предоставлено, элемент управления внутри создает учетную запись пользователя в структуру членства, все это без нам придется писать ни одной строки кода.

Элемент управления CreateUserWizard Возводит число событий во время его рабочего процесса. После посетитель предоставляет необходимые данные и отправляет форму, элемент управления CreateUserWizard изначально запускает его [ `CreatingUser` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.creatinguser.aspx). Если возникла проблема во время процесса создания [ `CreateUserError` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createusererror.aspx) запускается; тем не менее, если пользователь будет создан, то [ `CreatedUser` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx) возникает. В [ *Создание учетных записей пользователей* ](creating-user-accounts-vb.md) руководстве мы создали обработчик событий для `CreatingUser` событий, чтобы убедиться, что введенное имя пользователя не содержит любые начальные или конечные пробелы и, имя пользователя не возникали в любом месте в пароле.

Чтобы добавить строку в `UserProfiles` таблицы для только что созданного пользователя, нам необходимо создать обработчик событий для `CreatedUser` событий. К моменту `CreatedUser` события, учетная запись пользователя уже создан в структуру членства, благодаря чему мы можем получить значение UserId учетной записи.

Создайте обработчик событий для `NewUserWizard`в `CreatedUser` событий и добавьте следующий код:

[!code-vb[Main](storing-additional-user-information-vb/samples/sample11.vb)]

Выше существ кода, получив идентификатор пользователя учетной записи пользователя, только что добавлен. Это достигается с помощью `Membership.GetUser(username)` метод для возврата сведений о конкретного пользователя и затем с помощью `ProviderUserKey` свойство для извлечения их UserId. Имя пользователя, введенное пользователем в элемент управления CreateUserWizard доступен через его [ `UserName` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.username.aspx).

После этого строка подключения извлекается из `Web.config` и `INSERT` задана инструкция. Создаются необходимые объекты ADO.NET, и выполнена команда. Код присваивает [ `DBNull` ](https://msdn.microsoft.com/library/system.dbnull.aspx) экземпляр `@HomeTown`, `@HomepageUrl`, и `@Signature` параметры, которые имеет приведет к добавлению базы данных `NULL` значений в параметре `HomeTown`, `HomepageUrl`, и `Signature` поля.

Посетите `EnhancedCreateUserWizard.aspx` странице через браузер и создать учетную запись пользователя. После этого вернитесь в Visual Studio и изучить содержимое `aspnet_Users` и `UserProfiles` таблиц (как это делалось обратно на рис. 12). Вы увидите новую учетную запись пользователя, в `aspnet_Users` и соответствующий `UserProfiles` строки (с `NULL` значений в параметре `HomeTown`, `HomepageUrl`, и `Signature`).


[![Были добавлены новой учетной записи пользователя и запись UserProfiles](storing-additional-user-information-vb/_static/image59.png)](storing-additional-user-information-vb/_static/image58.png)

**Рис. 20**: Учетной записи пользователя и `UserProfiles` записи были добавлены ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image60.png))


После посетитель предоставляется его новые сведения об учетной записи и нажал кнопку «Create User», создается учетная запись пользователя, и строка `UserProfiles` таблицы. CreateUserWizard выведет его `CompleteWizardStep`, которая отображает сообщение об успешном выполнении и кнопки "Продолжить". Нажатие кнопки "Продолжить" обратную передачу, но никакие действия не выполняются, а пользователь, прикрепленной `EnhancedCreateUserWizard.aspx` страницы.

Можно указать URL-адрес для отправки пользователю при нажатии кнопки "Продолжить" с помощью элемента управления CreateUserWizard [ `ContinueDestinationPageUrl` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.continuedestinationpageurl.aspx). Задать `ContinueDestinationPageUrl` свойства «~ / Membership/AdditionalUserInfo.aspx». Это занимает новому пользователю `AdditionalUserInfo.aspx`, где они могут просматривать и обновлять их параметры.

### <a name="customizing-the-createuserwizards-interface-to-prompt-for-the-new-users-home-town-homepage-and-signature"></a>Настройка интерфейса CreateUserWizard, чтобы запрашивать домашней города нового пользователя, домашней страницы и подписи

Интерфейс по умолчанию элемента управления CreateUserWizard достаточно для сценариев создания простой учетной записи, где должны собираться только данные учетной записи пользователя core как имя пользователя, пароль и адрес электронной почты. Но что делать, если мы хотели бы запрашивать посетителя, ввести свой родного города, домашней страницы и подписи при создании своей учетной записи? Существует возможность настройки интерфейса элемента управления CreateUserWizard для сбора дополнительных сведений при регистрации, и эта информация может использоваться в `CreatedUser` обработчик событий для вставки дополнительных записей в основной базе данных.

Элемент управления CreateUserWizard расширяет элемент управления ASP.NET мастер, который является элементом управления, который позволяет разработчику определить ряд упорядоченный `WizardSteps`. Элемент управления мастер отображает активного шага и предоставляет интерфейс навигации, который позволяет посетителя переместить эти шаги. Элемента управления Wizard идеально подходит для дробления длительной задачи в несколько простых действий. Дополнительные сведения об элементе управления мастера, см. в разделе [Создание пошаговое пользовательского интерфейса с помощью элемента управления ASP.NET 2.0 мастер](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx).

Разметка элемента управления CreateUserWizard по умолчанию определяются два `WizardSteps`: `CreateUserWizardStep` и `CompleteWizardStep`.

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample12.aspx)]

Первый `WizardStep`, `CreateUserWizardStep`, отображает интерфейс, который запрашивает имя пользователя, пароль, адрес электронной почты и т. д. После посетителя отправляет эту информацию и нажимает кнопку «Create User», она отображается `CompleteWizardStep`, который показывает сообщение об успешном выполнении и кнопки "Продолжить".

Для настройки интерфейса элемента управления CreateUserWizard, чтобы включить дополнительные поля формы, можем:

- <strong>Создать один или несколько</strong><strong>`WizardStep`</strong><strong>s, чтобы содержать дополнительных элементах пользовательского интерфейса</strong>. Чтобы добавить новую `WizardStep` чтобы CreateUserWizard, нажмите кнопку «Добавить или удалить `WizardStep` s» ссылка из его смарт-тег, чтобы запустить `WizardStep` редактор коллекции. Оттуда можно добавить, удалить или изменить порядок действий в мастере. Именно этот подход, которые будут использоваться в этом руководстве.

- <strong>Преобразовать</strong><strong>`CreateUserWizardStep`</strong><strong>в изменяемом элементе</strong><strong>`WizardStep`</strong><strong>.</strong> Этот параметр заменяет `CreateUserWizardStep` с эквивалентным `WizardStep` , разметка определяет пользовательский интерфейс, который соответствует `CreateUserWizardStep`"s. Путем преобразования `CreateUserWizardStep` в `WizardStep` можно переместить элементы управления или добавление дополнительных элементах пользовательского интерфейса для этого шага. Для преобразования `CreateUserWizardStep` или `CompleteWizardStep` в изменяемом элементе `WizardStep`, нажмите кнопку «Создать пользователя Настройка Step» или «Настроить выполните шаг» связать смарт-теге элемента управления.

- **Используйте сочетание двух перечисленных выше.**

— Это важно помнить, что элемент управления CreateUserWizard выполняется его процесс создания учетной записи пользователя, при нажатии кнопки «Создать пользователя» изнутри его `CreateUserWizardStep`. Не важно, если существуют дополнительные `WizardStep` s после `CreateUserWizardStep` или нет.

При добавлении пользовательского `WizardStep` управления CreateUserWizard, чтобы собирать дополнительного ввода данных пользователем, пользовательского `WizardStep` можно разместить до или после `CreateUserWizardStep`. Если она предшествует `CreateUserWizardStep` затем собранные дополнительного пользовательского ввода из пользовательского `WizardStep` для `CreatedUser` обработчик событий. Тем не менее если пользовательский `WizardStep` следует после `CreateUserWizardStep` затем, когда пользовательский `WizardStep` отображается новой учетной записи уже создан и `CreatedUser` событие уже возникло.

Рис. 21 показан рабочий процесс при добавленного `WizardStep` предшествует `CreateUserWizardStep`. Поскольку к моменту сбора дополнительных сведений о пользователе `CreatedUser` вызывает событие, все что нужно сделать — обновление `CreatedUser` обработчик событий для получения этих входных данных и использовать их для `INSERT` значения параметров для инструкции (а не `DBNull.Value`).


[![Рабочий процесс CreateUserWizard, когда дополнительные WizardStep предшествует CreateUserWizardStep](storing-additional-user-information-vb/_static/image62.png)](storing-additional-user-information-vb/_static/image61.png)

**Рис. 21**: CreateUserWizard рабочего процесса при дополнительной `WizardStep` Precedes `CreateUserWizardStep` ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image63.png))


Если пользовательский `WizardStep` помещается *после* `CreateUserWizardStep`, однако процесса создания учетной записи пользователя выполняется до того, как пользователь сможет войти в свой домашний города, домашней страницы или подпись. В таком случае эти дополнительные сведения необходимо вставить в базу данных после создания учетной записи пользователя, как показано на рис. 22.


[![При поступлении дополнительных WizardStep после CreateUserWizardStep рабочего процесса CreateUserWizard](storing-additional-user-information-vb/_static/image65.png)](storing-additional-user-information-vb/_static/image64.png)

**Рис. 22**: CreateUserWizard рабочего процесса при дополнительной `WizardStep` поставляется после `CreateUserWizardStep` ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image66.png))


Ожидает вставить запись в рабочий процесс, показанный на рис. 22 `UserProfiles` таблицы до, после завершения шаг 2. Если посетитель закрывает браузер после шага 1, тем не менее, будет достигнут состояния, где создана учетная запись пользователя, но не запись была добавлена к `UserProfiles`. В этом случае является записывать с `NULL` или по умолчанию значениях, вставляемых в `UserProfiles` в `CreatedUser` обработчик событий (который срабатывает после выполнения шага 1) и только затем это записи после завершения шаг 2. Это гарантирует, что `UserProfiles` будет добавлена запись для учетной записи пользователя, даже если пользователь завершает работу во время процесса регистрации.

В этом руководстве давайте создадим новый `WizardStep` , наступающее после `CreateUserWizardStep` до `CompleteWizardStep`. Давайте сначала получите WizardStep в поместите и настроен, а затем мы рассмотрим код.

Смарт-теге элемента управления CreateUserWizard, выберите «Добавить или удалить `WizardStep` s», которая вызывает `WizardStep` диалоговое окно редактора коллекции. Добавьте новый `WizardStep`, устанавливая его `ID` для `UserSettings`, ее `Title` «Your Настройка» и его `StepType` для `Step`. Затем поместите ее так, чтобы он следует после `CreateUserWizardStep` («Регистрация для создания новой учетной записи») и перед `CompleteWizardStep` («полное»), как показано на рис. 23.


[![Добавьте новый WizardStep к элементу управления CreateUserWizard](storing-additional-user-information-vb/_static/image68.png)](storing-additional-user-information-vb/_static/image67.png)

**Рис. 23**: Добавить новый `WizardStep` в элемент управления CreateUserWizard ([Просмотр полноразмерного изображения](storing-additional-user-information-vb/_static/image69.png))


Нажмите кнопку ОК, чтобы закрыть `WizardStep` диалоговое окно редактора коллекции. Новый `WizardStep` свидетельствует обновленные декларативная разметка элемента управления CreateUserWizard:

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample13.aspx)]

Обратите внимание на новое `<asp:WizardStep>` элемент. Нам нужно добавить пользовательский интерфейс для сбора родного города нового пользователя, домашней страницы и подпись здесь. Это содержимое можно ввести в декларативном синтаксисе или с помощью конструктора. Использование конструктора, выберите на шаге «Your параметры» из раскрывающегося списка в смарт-тег для см. шаг в конструкторе.

> [!NOTE]
> При выборе пошагово с раскрывающимся списком смарт-тега обновляется элемент управления CreateUserWizard [ `ActiveStepIndex` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.activestepindex.aspx), который указывает индекс начального шага. Таким образом, при использовании этого раскрывающегося списка, чтобы внести изменения в шаг «Your параметры» в конструкторе, не забудьте снова задайте для нее «Входа для создания новой учетной записи», чтобы этот шаг показан при первом посещении `EnhancedCreateUserWizard.aspx` страницы.


Создание пользовательского интерфейса в пределах шага «Your параметры», который содержит три элемента управления TextBox с именем `HomeTown`, `HomepageUrl`, и `Signature`. После создания этот интерфейс, декларативная разметка CreateUserWizard должен выглядеть следующим образом:

[!code-aspx[Main](storing-additional-user-information-vb/samples/sample14.aspx)]

Продолжим и посетите эту страницу через обозреватель и создать новую учетную запись пользователя, указывая значения для домашних города, домашней страницы и подпись. После завершения `CreateUserWizardStep` учетная запись пользователя создается в структуру членства и `CreatedUser` выполняется обработчик события, которые добавляет новую строку к `UserProfiles`, но с базой данных `NULL` значение `HomeTown`, `HomepageUrl`, и `Signature`. Значения, введенные для домашних города, домашней страницы и подпись никогда не используются. Конечным результатом является новой учетной записи пользователя с `UserProfiles` записи которого `HomeTown`, `HomepageUrl`, и `Signature` поля еще должно быть задано.

Мы должны выполнять код после шага «Your параметры», которая принимает домашней города, honepage и подпись значений, введенных пользователем и обновляет соответствующий `UserProfiles` записи. Каждый раз при перемещении между шагами в мастере элементов управления, мастер [ `ActiveStepChanged` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.wizard.activestepchanged.aspx) активируется. Можно создать обработчик событий для этого события и обновления `UserProfiles` таблицы по завершении шага «Your параметры».

Добавьте обработчик событий для CreateUserWizard `ActiveStepChanged` событий и добавьте следующий код:

[!code-vb[Main](storing-additional-user-information-vb/samples/sample15.vb)]

Приведенный выше код начинается с определения, если только что вышедшей шаг «Завершить». Так как на шаге «Complete» происходит сразу после шага «Your параметры», когда достигает посетитель «Complete» пошагово, означает, что она только что завершили шаг «Your параметры».

В этом случае нам нужно программно сослаться на элементы управления TextBox внутри `UserSettings WizardStep`. Это достигается с помощью первого `FindControl` способ программного обращения `UserSettings WizardStep`, а затем еще раз, чтобы ссылаться на текстовых полей внутри `WizardStep`. После содержатся ссылки на текстовых полей, мы готовы выполнить `UPDATE` инструкции. `UPDATE` Инструкция имеет одинаковое количество параметров, которое `INSERT` инструкции в `CreatedUser` обработчик событий, но здесь мы используем домашней города, домашней страницы и подпись значения, предоставленные пользователем.

С помощью этого обработчика событий в месте, посетите `EnhancedCreateUserWizard.aspx` странице через браузер и создайте учетную запись пользователя, указывая значения для домашних города, домашней страницы и подпись. После создания новой учетной записи вы должны быть перенаправлены к `AdditionalUserInfo.aspx` страницы, где только что введенный домашней города, домашней страницы и подпись информация отображается.

> [!NOTE]
> Наш веб-сайт в настоящее время имеет две страницы, из которых посетитель может создать новую учетную запись: `CreatingUserAccounts.aspx` и `EnhancedCreateUserWizard.aspx`. Sitemap веб сайта и страницу входа точка `CreatingUserAccounts.aspx` страницы, но `CreatingUserAccounts.aspx` страницы не запрашивает пользователя его домашней города, домашней страницы и подпись данные и не добавляет соответствующую строку в `UserProfiles`. Таким образом, либо обновить `CreatingUserAccounts.aspx` странице таким образом, чтобы он обеспечивает эти функциональные возможности или обновить страницу sitemap и войдите в систему, чтобы ссылаться на `EnhancedCreateUserWizard.aspx` вместо `CreatingUserAccounts.aspx`. Если вы выберите второй вариант, не забудьте обновить `Membership` папки `Web.config` файл так, чтобы разрешить анонимным пользователям доступ к `EnhancedCreateUserWizard.aspx` страницы.


## <a name="summary"></a>Сводка

В этом учебнике мы рассмотрели методы для моделирования данных, который связан с учетных записей пользователей в платформу членства. В частности мы рассмотрели моделирования сущностей, которые совместно используют один ко многим связь с учетных записей пользователей, а также данных, совместно использующих взаимно-однозначной связи. Кроме того, мы узнали, как это связанные сведения может отобразить, вставке и обновляется несколько примеров, с помощью элемента управления SqlDataSource и другим пользователям с помощью кода ADO.NET.

Этот учебник завершает наш взгляд на учетные записи пользователей. Начиная с следующем учебном курсе мы будет обратим наше внимание на роли. Следующие несколько учебников, мы рассмотрим framework ролей, см. в разделе Создание новых ролей, как назначать роли пользователям, чтобы определить, какие роли принадлежит пользователь, а также применять проверку подлинности на основе ролей.

Счастливого вам программирования!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Просмотр и обновление данных в ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/011106-1.aspx)
- [Элемент управления ASP.NET 2.0 мастера](https://weblogs.asp.net/scottgu/archive/2006/02/21/438732.aspx)
- [Создание пошаговые пользовательского интерфейса с помощью элемента управления ASP.NET 2.0 мастера](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx)
- [Создание параметров пользовательского источника данных элемента управления](http://aspnet.4guysfromrolla.com/articles/110106-1.aspx)
- [Настройка элементов управления CreateUserWizard](http://aspnet.4guysfromrolla.com/articles/070506-1.aspx)
- [Примеры использования элемента управления DetailsView](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/data/detailsview.aspx)
- [Отображение данных с помощью элемента управления ListView](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx)
- [Разбор элементов управления проверки в ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx)
- [Редактирование, вставка и удаление данных](../../data-access/editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md)
- [Проверка форм в ASP.NET](http://www.4guysfromrolla.com/webtech/090200-1.shtml)
- [Сбор сведений о регистрации пользовательских](https://weblogs.asp.net/scottgu/archive/2006/07/05/Tip_2F00_Trick_3A00_-Gathering-Custom-User-Registration-Information.aspx)
- [Профили в ASP.NET 2.0](http://www.odetocode.com/Articles/440.aspx)
- [Элемент управления asp: ListView](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx)
- [Примеры использования профилей пользователя](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/profile/default.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP.NET и основатель веб-узла 4GuysFromRolla.com, работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга —  *[Sams Teach ASP.NET 2.0 in 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скоттом можно связаться по адресу [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по адресу [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4GuysFromRolla.com).

> [!div class="step-by-step"]
> [Назад](user-based-authorization-vb.md)
