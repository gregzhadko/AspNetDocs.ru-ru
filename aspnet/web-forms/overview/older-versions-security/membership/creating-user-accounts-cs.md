---
uid: web-forms/overview/older-versions-security/membership/creating-user-accounts-cs
title: Создание учетных записейC#пользователей () | Документация Майкрософт
author: rick-anderson
description: В этом учебнике мы рассмотрим использование инфраструктуры членства (с помощью SqlMembershipProvider) для создания новых учетных записей пользователей. Мы посмотрим, как создать новый US...
ms.author: riande
ms.date: 01/18/2008
ms.assetid: f175278c-6079-4d91-b9b4-2493ed43d9ec
msc.legacyurl: /web-forms/overview/older-versions-security/membership/creating-user-accounts-cs
msc.type: authoredcontent
ms.openlocfilehash: 955592320e7d36c7ae3b9c03a361bee2183f1776
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74625484"
---
# <a name="creating-user-accounts-c"></a>Создание учетных записей пользователей (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_05_CS.zip) или [скачать PDF](https://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial05_CreatingUsers_cs.pdf)

> В этом учебнике мы рассмотрим использование инфраструктуры членства (с помощью SqlMembershipProvider) для создания новых учетных записей пользователей. Мы посмотрим, как создавать новых пользователей программным путем и через технологию ASP. Встроенный элемент управления CreateUserWizard NET.

## <a name="introduction"></a>Вступление

<a id="_msoanchor_1"> </a>В [предыдущем учебном курсе](creating-the-membership-schema-in-sql-server-cs.md) мы установили схему служб приложений в базе данных, которая добавила таблицы, представления и хранимые процедуры, необходимые для `SqlMembershipProvider` и `SqlRoleProvider`. Это создало инфраструктуру, которая потребуется для оставшейся части руководств, посвященных этой серии. В этом учебнике будет рассмотрено использование инфраструктуры членства (с помощью `SqlMembershipProvider`) для создания новых учетных записей пользователей. Мы посмотрим, как создавать новых пользователей программным путем и через технологию ASP. Встроенный элемент управления CreateUserWizard NET.

В дополнение к изучению создания новых учетных записей пользователей необходимо также обновить демонстрационный веб-сайт, созданный в обзоре учебника по *<a id="_msoanchor_2"></a>[проверке подлинности с помощью форм](../introduction/an-overview-of-forms-authentication-cs.md)*, а затем расширить учебник по *<a id="https://www.asp.net/learn/security/tutorial-03-cs.aspx"></a> настройке проверки подлинности с помощью форм и дополнительным темам*. В нашем демонстрационном веб-приложении есть страница входа, которая проверяет учетные данные пользователей на соответствие жестко заданным парам имени пользователя и пароля. Более того, `Global.asax` включает код, который создает пользовательские `IPrincipal` и объекты `IIdentity` для пользователей, прошедших проверку подлинности. Мы будем обновлять страницу входа, чтобы проверить учетные данные пользователей в инфраструктуре членства и удалить настраиваемую логику участника и удостоверение.

Приступим к работе!

## <a name="the-forms-authentication-and-membership-checklist"></a>Контрольный список проверки подлинности и членства в формах

Прежде чем приступить к работе с инфраструктурой членства, давайте посмотрим на важные шаги, которые мы предсмотрели для достижения этой точки. При использовании платформы членства с `SqlMembershipProvider` в сценарии проверки подлинности на основе форм, перед реализацией функциональности членства в веб-приложении необходимо выполнить следующие действия.

1. **Включить проверку подлинности на основе форм.** Как мы обсуждали в *<a id="_msoanchor_4"></a>[обзоре проверки подлинности с помощью форм](../introduction/an-overview-of-forms-authentication-cs.md)*, проверка подлинности с помощью форм включается путем изменения `Web.config` и установки `mode` атрибута `<authentication>` элемента в `Forms`. При включенной проверке подлинности с помощью форм каждый входящий запрос проверяется на наличие *билета проверки подлинности форм*, который, если он указан, определяет запрашивающего.
2. **Добавьте схему служб приложений в соответствующую базу данных.** При использовании `SqlMembershipProvider` необходимо установить схему служб приложений в базу данных. Обычно эта схема добавляется в ту же базу данных, в которой находится модель данных приложения. В учебнике *<a id="_msoanchor_5"></a>[создание схемы членства в SQL Server](creating-the-membership-schema-in-sql-server-cs.md)* рассматривалось использование средства `aspnet_regsql.exe` для решения этой задачи.
3. **Настройте параметры веб-приложения для ссылки на базу данных из шага 2.** В учебнике *Создание схемы членства в SQL Server* было показано два способа настройки веб-приложения, чтобы `SqlMembershipProvider` использовал базу данных, выбранную на шаге 2: путем изменения имени строки подключения `LocalSqlServer`. или путем добавления нового зарегистрированного поставщика в список поставщиков инфраструктуры членства и настройки этого нового поставщика для использования базы данных из шага 2.

При создании веб-приложения, использующего `SqlMembershipProvider` и проверку подлинности на основе форм, необходимо выполнить эти три действия перед использованием класса `Membership` или веб-элементов управления входа ASP.NET. Так как мы уже выполнили эти действия в предыдущих учебных курсах, мы готовы приступить к использованию платформы членства!

## <a name="step-1-adding-new-aspnet-pages"></a>Шаг 1. Добавление новых страниц ASP.NET

В этом руководстве и следующих трех мы будем изучать различные функции и возможности, связанные с членством. Для реализации разделов, которые были проверены в рамках этих руководств, потребуется серия ASP.NET страниц. Давайте создадим эти страницы, а затем файл схемы узла `(Web.sitemap)`.

Начните с создания новой папки в проекте с именем `Membership`. Затем добавьте пять новых страниц ASP.NET в папку `Membership`, связав каждую страницу с главной страницей `Site.master`. Назовите страницы:

- `CreatingUserAccounts.aspx`
- `UserBasedAuthorization.aspx`
- `EnhancedCreateUserWizard.aspx`
- `AdditionalUserInfo.aspx`
- `Guestbook.aspx`

На этом этапе обозреватель решений проекта должны выглядеть примерно так, как показано на снимке экрана, показанном на рис. 1.

[![пять новых страниц добавлены в папку членства](creating-user-accounts-cs/_static/image2.png)](creating-user-accounts-cs/_static/image1.png)

**Рис. 1**. В папку `Membership` Добавлено пять новых страниц ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image3.png)).

На этом этапе на каждой странице должно быть два элемента управления содержимым — по одному для каждой элементов управления ContentPlaceHolder главной страницы: `MainContent` и `LoginContent`.

[!code-aspx[Main](creating-user-accounts-cs/samples/sample1.aspx)]

Помните, что разметка `LoginContent` ContentPlaceHolder по умолчанию отображает ссылку на вход или выход из системы сайта в зависимости от того, прошел ли пользователь проверку подлинности. Однако наличие элемента управления содержимым `Content2` переопределяет разметку по умолчанию главной страницы. Как мы обсуждали в *<a id="_msoanchor_6"></a>[обзоре учебника по проверке подлинности](../introduction/an-overview-of-forms-authentication-cs.md)* с помощью форм, это полезно на страницах, где не нужно отображать параметры, связанные с именем входа, в левом столбце.

Однако для этих пяти страниц необходимо отобразить разметку главной страницы по умолчанию для `LoginContent` ContentPlaceHolder. Поэтому удалите декларативную разметку для элемента управления содержимым `Content2`. После этого каждая из пяти разметки страницы должна содержать только один элемент управления содержимым.

## <a name="step-2-creating-the-site-map"></a>Шаг 2. Создание схемы узла

Все, но самые тривиальные веб-сайты должны реализовывать некоторую форму пользовательского интерфейса с навигацией. Пользовательский интерфейс навигации может быть простым списком ссылок на различные разделы сайта. Кроме того, эти ссылки могут быть упорядочены в меню или представлениях в виде дерева. Как разработчикам страниц, создание пользовательского интерфейса с навигацией — лишь половина истории. Также необходимы некоторые средства для определения логической структуры сайта в поддерживаемом и обновляемом виде. По мере добавления новых страниц или удаления существующих страниц нам нужно иметь возможность обновить один источник — карту узла, а эти изменения будут отражены в пользовательском интерфейсе навигации сайта.

Эти две задачи — определение карты узла и реализация пользовательского интерфейса с навигацией на основе карты узла — легко выполнить благодаря инфраструктуре узла и веб-элементам управления навигацией, добавленным в ASP.NET версии 2,0. Инфраструктура карт узла позволяет разработчику определить карту узла, а затем получить к ней доступ через программный API ( [класс`SiteMap`](https://msdn.microsoft.com/library/system.web.sitemap.aspx)). Встроенные веб-элементы управления навигацией включают в себя [элемент управления Menu](https://msdn.microsoft.com/library/bz09dy46.aspx), [элемент управления TreeView](https://msdn.microsoft.com/library/3eafky27.aspx)и [элемент управления SiteMapPath](https://msdn.microsoft.com/library/3eafky27.aspx).

Как и в случае с платформами членства и ролей, инфраструктура карт узла строится на основе [модели поставщика](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx). Задание класса поставщика схемы узла заключается в формировании структуры в памяти, используемой классом `SiteMap`, из постоянного хранилища данных, такого как XML-файл или таблица базы данных. .NET Framework поставляется с поставщиком карт узла по умолчанию, который считывает данные карт узла из XML-файла ([`XmlSiteMapProvider`](https://msdn.microsoft.com/library/system.web.xmlsitemapprovider.aspx)), а именно это поставщик, который мы будем использовать в этом руководстве. Дополнительные реализации поставщиков карт веб-сайтов см. в разделе Дополнительные сведения в конце этого руководства.

Поставщику карт сайта по умолчанию требуется XML-файл правильного формата с именем `Web.sitemap` для существования корневого каталога. Так как мы используем поставщик по умолчанию, необходимо добавить такой файл и определить структуру схемы узла в соответствующем XML-формате. Чтобы добавить файл, щелкните правой кнопкой мыши имя проекта в обозреватель решений и выберите команду Добавить новый элемент. В диалоговом окне выберите Добавить файл типа "гиперкарта" с именем `Web.sitemap`.

[![добавить файл с именем Web. Sitemap в корневой каталог проекта](creating-user-accounts-cs/_static/image5.png)](creating-user-accounts-cs/_static/image4.png)

**Рис. 2**. Добавьте файл с именем `Web.sitemap` в корневой каталог проекта ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image6.png)).

Файл схемы веб-узла XML определяет структуру веб-сайта в качестве иерархии. Эта иерархическая связь моделируется в XML-файле с помощью происхождение элементов `<siteMapNode>`. `Web.sitemap` должен начинаться с `<siteMap>` родительского узла, который содержит ровно один `<siteMapNode>` дочерний элемент. Этот элемент `<siteMapNode>` верхнего уровня представляет корень иерархии и может иметь произвольное число узлов-потомков. Каждый элемент `<siteMapNode>` должен включать атрибут `title` и может дополнительно включать атрибуты `url` и `description`, среди прочего. Каждый непустой атрибут `url` должен быть уникальным.

Введите следующий XML-код в файл `Web.sitemap`:

[!code-xml[Main](creating-user-accounts-cs/samples/sample2.xml)]

Приведенная выше разметка карт веб-узлов определяет иерархию, показанную на рис. 3.

[![схема узла представляет иерархическую структуру навигации](creating-user-accounts-cs/_static/image8.png)](creating-user-accounts-cs/_static/image7.png)

**Рис. 3**. Схема узла представляет иерархическую структуру навигации ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image9.png)).

## <a name="step-3-updating-the-master-page-to-include-a-navigational-user-interface"></a>Шаг 3. Обновление главной страницы для включения пользовательского интерфейса навигации

ASP.NET включает ряд связанных с навигацией веб-элементов управления для разработки пользовательского интерфейса. К ним относятся меню, TreeView и элементы управления SiteMapPath. Элементы управления "меню" и "TreeView" отображают структуру узла в меню или дереве соответственно, в то время как в SiteMapPath отображается навигатор, показывающий текущий посещаемый узел и его предки. Данные карт узла можно привязать к другим веб-элементам управления данными с помощью SiteMapDataSource, и доступ к ним можно получить программно с помощью класса `SiteMap`.

Так как подробное обсуждение инфраструктуры карты узла и элементов управления навигацией выходит за рамки этой серии руководств, вместо того чтобы тратить время на создание собственного пользовательского интерфейса для навигации, вместо этого следует использовать тот, который использовался в моей *[работе с данными в](../../data-access/index.md)* серии руководств по ASP.NET 2,0, которая использует элемент управления Repeater для отображения двухстраничного маркированного списка навигационных ссылок, как показано на рис. 4.

### <a name="adding-a-two-level-list-of-links-in-the-left-column"></a>Добавление двухстраничного списка ссылок в левом столбце

Чтобы создать этот интерфейс, добавьте следующую декларативную разметку в левый столбец главной страницы `Site.master`, где текст "TODO: Откроется меню... " в данный момент находится.

[!code-aspx[Main](creating-user-accounts-cs/samples/sample3.aspx)]

Приведенная выше разметка привязывает элемент управления Repeater с именем `menu` к SiteMapDataSource, который возвращает иерархию карт узла, определенную в `Web.sitemap`. Так как [свойство`ShowStartingNode`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sitemapdatasource.showstartingnode.aspx) элемента управления SiteMapDataSource имеет значение false, оно начинает возвращать иерархию узла, начиная с потомков главного узла. Элемент Repeater отображает каждый из этих узлов (в настоящее время просто "членство") в элементе `<li>`. Другой, внутренний Repeater, затем отображает дочерние элементы текущего узла во вложенном неупорядоченном списке.

На рис. 4 показан отображаемый выше результат разметки с помощью структуры карт узла, созданной на шаге 2. Элемент Repeater визуализирует разметку неупорядоченного списка обычный; правила каскадной таблицы стилей, определенные в `Styles.css`, отвечают за макет визуально. Более подробное описание того, как работает описанная выше разметка, см. в руководстве по [основным страницам и навигации по сайту](https://asp.net/learn/data-access/tutorial-03-cs.aspx) .

[![пользовательский интерфейс навигации подготавливается к просмотру с помощью вложенных неупорядоченных списков](creating-user-accounts-cs/_static/image11.png)](creating-user-accounts-cs/_static/image10.png)

**Рис. 4**. Пользовательский интерфейс навигации подготавливается к просмотру с помощью вложенных неупорядоченных списков ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image12.png)).

### <a name="adding-breadcrumb-navigation"></a>Добавление навигации по навигатору

Помимо списка ссылок в левом столбце, давайте также Попробуем отобразить [Навигатор](http://en.wikipedia.org/wiki/Breadcrumb_%28navigation%29)на каждой странице. Навигатор — это элемент пользовательского интерфейса с навигацией, который позволяет быстро показать пользователям текущую точку в иерархии сайта. Элемент управления SiteMapPath использует инфраструктуру узла для определения расположения текущей страницы на карте узла, а затем отображает навигатор на основе этих сведений.

В частности, добавьте элемент `<span>` в заголовок `<div>` главной страницы и задайте для атрибута `class` нового элемента `<span>` значение "Навигатор". (Класс `Styles.css` содержит правило для "иерархического" класса.) Затем добавьте в этот новый элемент `<span>` объект SiteMapPath.

[!code-aspx[Main](creating-user-accounts-cs/samples/sample4.aspx)]

На рис. 5 показаны выходные данные SiteMapPath при посещении `~/Membership/CreatingUserAccounts.aspx`.

[![навигатор отображает текущую страницу и ее предков на карте узла.](creating-user-accounts-cs/_static/image14.png)](creating-user-accounts-cs/_static/image13.png)

**Рис. 5**. Навигатор отображает текущую страницу и ее предков на карте узла ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image15.png)).

## <a name="step-4-removing-the-custom-principal-and-identity-logic"></a>Шаг 4. Удаление настраиваемой логики субъекта и удостоверения

В учебнике *<a id="_msoanchor_7"></a>[Настройка проверки подлинности с помощью форм и дополнительные разделы](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md)* мы увидели, как связать пользовательские объекты Principal и Identity с прошедшим проверку подлинности пользователю. Это достигается путем создания обработчика событий в `Global.asax` для события `PostAuthenticateRequest` приложения, которое срабатывает после того, как `FormsAuthenticationModule` проходило проверку подлинности пользователя. В этом обработчике событий мы заменили `GenericPrincipal` и `FormsIdentity` объекты, добавленные `FormsAuthenticationModule` с помощью объектов `CustomPrincipal` и `CustomIdentity`, которые мы создали в этом руководстве.

Хотя пользовательские объекты Principal и Identity полезны в определенных сценариях, в большинстве случаев достаточно `GenericPrincipal` и `FormsIdentity` объектов. Как следствие, я полагаю, что стоит бы вернуться к поведению по умолчанию. Внесите это изменение, удалив или закомментируйте обработчик событий `PostAuthenticateRequest` или удалив `Global.asax` файл целиком.

## <a name="step-5-programmatically-creating-a-new-user"></a>Шаг 5. Программное создание нового пользователя

Чтобы создать новую учетную запись пользователя с помощью инфраструктуры членства, используйте [метод`CreateUser`](https://msdn.microsoft.com/library/system.web.security.membership.createuser.aspx)класса `Membership`. Этот метод имеет входные параметры для имени пользователя, пароля и других полей, связанных с пользователем. При вызове он делегирует создание новой учетной записи пользователя настроенному поставщику членства, а затем возвращает [объект`MembershipUser`](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) , представляющий только что созданную учетную запись пользователя.

Метод `CreateUser` имеет четыре перегрузки, каждый из которых принимает разное количество входных параметров:

- [`CreateUser(username, password)`](https://msdn.microsoft.com/library/d8t4h2es.aspx)
- [`CreateUser(username, password, email)`](https://msdn.microsoft.com/library/t8yy6w3h.aspx)
- [`CreateUser(username, password, email, passwordQuestion, passwordAnswer, isApproved, MembershipCreateStatus)`](https://msdn.microsoft.com/library/82xx2e62.aspx)
- [`CreateUser(username, password, email, passwordQuestion, passwordAnswer, isApproved, providerUserKey, MembershipCreateStatus)`](https://msdn.microsoft.com/library/ms152012.aspx)

Эти четыре перегрузки отличаются от объема собираемой информации. Для первой перегрузки, например, требуется только имя пользователя и пароль для новой учетной записи пользователя, а во второй — адрес электронной почты пользователя.

Эти перегрузки существуют, поскольку сведения, необходимые для создания новой учетной записи пользователя, зависят от параметров конфигурации поставщика членства. В SQL Server руководстве по *<a id="_msoanchor_8"></a>[созданию схемы членства](creating-the-membership-schema-in-sql-server-cs.md)* мы рассмотрели указание параметров конфигурации поставщика членства в `Web.config`. В таблице 2 содержится полный список параметров конфигурации.

Один из таких параметров конфигурации поставщика членства, влияющий на то, что можно использовать перегрузки `CreateUser`, — это параметр `requiresQuestionAndAnswer`. Если `requiresQuestionAndAnswer` имеет значение `true` (по умолчанию), то при создании учетной записи пользователя необходимо указать контрольный вопрос и ответ. Эти сведения позже используются, если пользователю необходимо сбросить или изменить пароль. В частности, они показывают контрольный вопрос и должны ввести правильный ответ, чтобы сбросить или изменить пароль. Следовательно, если `requiresQuestionAndAnswer` имеет значение `true` то вызов одного из первых двух перегрузок `CreateUser` приводит к исключению из-за отсутствия контрольного вопроса и ответа. Так как наше приложение настроено на требование контрольного вопроса и ответа, для программного создания пользователя необходимо использовать одну из двух последних перегрузок.

Чтобы проиллюстрировать использование метода `CreateUser`, создадим пользовательский интерфейс, в котором пользователю предлагается ввести имя, пароль, адрес электронной почты и ответ на заранее определенный контрольный вопрос. Откройте страницу `CreatingUserAccounts.aspx` в папке `Membership` и добавьте в элемент управления содержимым следующие веб-элементы управления:

- Текстовое поле с именем `Username`
- Текстовое поле с именем `Password`, свойство `TextMode` которого имеет значение `Password`
- Текстовое поле с именем `Email`
- Метка с именем `SecurityQuestion` со свойством `Text` очищаются
- Текстовое поле с именем `SecurityAnswer`
- Кнопка с именем `CreateAccountButton`, свойство Text которой имеет значение "создать учетную запись пользователя"
- Элемент управления Label с именем `CreateAccountResults` со свойством `Text` очистить

На этом этапе экран должен выглядеть примерно так, как на снимке экрана, показанном на рис. 6.

[![добавления различных веб-элементов управления на страницу Креатингусераккаунтс. aspx](creating-user-accounts-cs/_static/image17.png)](creating-user-accounts-cs/_static/image16.png)

**Рис. 6**. Добавление различных веб-элементов управления на страницу `CreatingUserAccounts.aspx` ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image18.png))

Текстовое поле `SecurityQuestion` метка и `SecurityAnswer` предназначено для вывода заранее определенного контрольного вопроса и получения ответа пользователя. Обратите внимание, что как контрольный вопрос, так и ответ хранятся на уровне пользователя, поэтому каждый пользователь может определить свой контрольный вопрос. Однако в этом примере я решил использовать универсальный секретный вопрос, а именно: «Какой цвет предпочтительнее?»

Чтобы реализовать этот предварительно определенный контрольный вопрос, добавьте константу в класс кода программной части страницы с именем `passwordQuestion`, назначив ему контрольный вопрос. Затем в обработчике событий `Page_Load` назначьте эту константу свойству `Text` метки `SecurityQuestion`:

[!code-csharp[Main](creating-user-accounts-cs/samples/sample5.cs)]

Затем создайте обработчик событий для события `Click` `CreateAccountButton`и добавьте следующий код:

[!code-csharp[Main](creating-user-accounts-cs/samples/sample6.cs)]

Обработчик событий `Click` начинает с определения переменной с именем `createStatus` типа [`MembershipCreateStatus`](https://msdn.microsoft.com/library/system.web.security.membershipcreatestatus.aspx). `MembershipCreateStatus` — это перечисление, указывающее состояние операции `CreateUser`. Например, если учетная запись пользователя создана успешно, то результирующий экземпляр `MembershipCreateStatus` будет установлен в значение `Success`; с другой стороны, если операция завершается ошибкой из-за того, что пользователь с таким именем уже существует, ему будет присвоено значение `DuplicateUserName`. В используемой перегрузке `CreateUser` необходимо передать экземпляр `MembershipCreateStatus` в метод в качестве параметра `out`. Этому параметру присваивается соответствующее значение в методе `CreateUser`, и мы можем проверить его значение после вызова метода, чтобы определить, успешно ли создана учетная запись пользователя.

После вызова `CreateUser`, передавая `createStatus`, для вывода соответствующего сообщения в зависимости от значения, назначенного `createStatus`, используется инструкция `switch`. На рисунках 7 показаны выходные данные при успешном создании нового пользователя. На рисунках 8 и 9 показаны выходные данные, если учетная запись пользователя не создана. На рис. 8 посетитель вводил пароль из пяти букв, который не соответствует требованиям к надежности пароля, указанным в параметрах конфигурации поставщика членства. На рис. 9 посетитель пытается создать учетную запись пользователя с существующим именем пользователя (созданным на рис. 7).

[![успешно создана новая учетная запись пользователя](creating-user-accounts-cs/_static/image20.png)](creating-user-accounts-cs/_static/image19.png)

**Рис. 7**. Новая учетная запись пользователя создана успешно ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image21.png))

[![учетная запись пользователя не создана, так как указанный пароль слишком слабый](creating-user-accounts-cs/_static/image23.png)](creating-user-accounts-cs/_static/image22.png)

**Рис. 8**. Учетная запись пользователя не создана, так как указанный пароль слишком слаб ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image24.png))

[![учетная запись пользователя не создана, так как имя пользователя уже используется](creating-user-accounts-cs/_static/image26.png)](creating-user-accounts-cs/_static/image25.png)

**Рис. 9**. Учетная запись пользователя не создана, так как имя пользователя уже используется ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image27.png))

> [!NOTE]
> Возможно, вы захотите узнать, как определить успешность или сбой при использовании одной из первых двух перегрузок метода `CreateUser`, ни один из которых не имеет параметра типа `MembershipCreateStatus`. Эти первые две перегрузки вызывают [исключение`MembershipCreateUserException`](https://msdn.microsoft.com/library/system.web.security.membershipcreateuserexception.aspx) в случае сбоя, которое включает [свойство`StatusCode`](https://msdn.microsoft.com/library/system.web.security.membershipcreateuserexception.statuscode.aspx) типа `MembershipCreateStatus`.

После создания нескольких учетных записей пользователей убедитесь, что учетные записи созданы путем перечисления содержимого `aspnet_Users` и `aspnet_Membership` таблиц в базе данных `SecurityTutorials.mdf`. Как показано на рис. 10, я добавил два пользователя через `CreatingUserAccounts.aspx` страницу: Тито и Брюс.

[![в хранилище пользователей членства есть два пользователя: Тито и Брюс](creating-user-accounts-cs/_static/image29.png)](creating-user-accounts-cs/_static/image28.png)

**Рис. 10**. В хранилище пользователей членства есть два пользователя: Тито и Брюс ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image30.png))

Хотя хранилище пользователей членства теперь содержит сведения об учетной записи Брюс и Тито, мы еще не реализуем функции, позволяющие Брюс или Тито входить на сайт. В настоящее время `Login.aspx` проверяет учетные данные пользователя на соответствие жестко заданному набору пар "имя пользователя — пароль", но *не* проверяет предоставленные учетные данные в инфраструктуре членства. Для просмотра новых учетных записей пользователей в `aspnet_Users` и `aspnet_Membership` таблицы должны быть достаточными. В следующем учебном курсе *<a id="_msoanchor_9"></a>[проверка учетных данных пользователя в хранилище пользователей членства](validating-user-credentials-against-the-membership-user-store-cs.md)* приведет к обновлению страницы входа для проверки в отношении хранилища членства.

> [!NOTE]
> Если вы не видите пользователей в базе данных `SecurityTutorials.mdf`, это может быть вызвано тем, что в веб-приложении используется поставщик членства по умолчанию, `AspNetSqlMembershipProvider`, который использует базу данных `ASPNETDB.mdf` в качестве своего хранилища пользователя. Чтобы определить, является ли проблема проблемой, нажмите кнопку "Обновить" в обозреватель решений. Если база данных с именем `ASPNETDB.mdf` добавлена в папку `App_Data`, это проблема. Вернитесь к шагу 4 статьи *<a id="_msoanchor_10"></a>[создание схемы членства в SQL Server](creating-the-membership-schema-in-sql-server-cs.md)* руководстве, чтобы получить инструкции по правильной настройке поставщика членства.

В большинстве случаев для создания учетной записи пользователя посетитель представляет собой некоторый интерфейс для ввода имени пользователя, пароля, электронной почты и других необходимых сведений, после чего создается новая учетная запись. На этом этапе мы рассматривали создание такого интерфейса вручную, а затем увидели, как использовать метод `Membership.CreateUser` для программного добавления новой учетной записи пользователя на основе входных данных пользователя. Однако наш код только что создал новую учетную запись пользователя. При этом не выполнялись никакие дальнейшие действия, такие как вход пользователя на сайт под только что созданной учетной записью пользователя, или отправка пользователю сообщения электронной почты с подтверждением. Эти дополнительные действия потребуют дополнительного кода в обработчике событий `Click` кнопки.

ASP.NET поставляется с элементом управления CreateUserWizard, который предназначен для обработки процесса создания учетной записи пользователя, от визуализации пользовательского интерфейса для создания новых учетных записей пользователей, создания учетной записи в инфраструктуре членства и выполнения пост-учета. задачи создания, такие как отправка сообщения электронной почты с подтверждением и запись только что созданного пользователя на сайт. Использование элемента управления CreateUserWizard так же просто, как перетаскивание элемента управления CreateUserWizard из панели элементов на страницу, а затем задание нескольких свойств. В большинстве случаев не нужно писать одну строку кода. Более подробно этот элемент управления будет рассмотрен в шаге 6.

Если новые учетные записи пользователей создаются только с помощью обычной веб-страницы создания учетной записи, маловероятно, что вам понадобится написать код, использующий метод `CreateUser`, так как элемент управления CreateUserWizard, скорее всего, будет соответствовать вашим потребностям. Однако метод `CreateUser` удобен в сценариях, где требуется очень настраиваемый пользовательский интерфейс создания учетной записи или необходимость программного создания новых учетных записей пользователей с помощью альтернативного интерфейса. Например, у вас может быть страница, позволяющая пользователю передать XML-файл, содержащий сведения о пользователях из другого приложения. Страница может проанализировать содержимое переданного XML-файла и создать новую учетную запись для каждого пользователя, представленного в XML, вызвав метод `CreateUser`.

## <a name="step-6-creating-a-new-user-with-the-createuserwizard-control"></a>Шаг 6. Создание нового пользователя с помощью элемента управления CreateUserWizard

ASP.NET поставляется с несколькими веб-элементами управления для входа. Эти элементы управления помогают в многих распространенных сценариях использования учетных записей и входа в систему. [Элемент управления CreateUserWizard](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/createuserwizard.aspx) — это один из таких элементов управления, предназначенный для предоставления пользовательского интерфейса для добавления новой учетной записи пользователя в платформу членства.

Как и многие другие веб-элементы управления, связанные с входом, CreateUserWizard можно использовать без написания одной строки кода. Он интуитивно предоставляет пользовательский интерфейс на основе параметров конфигурации поставщика членства и внутренне вызывает метод `CreateUser` `Membership` класса после того, как пользователь введет необходимые сведения и нажмет кнопку "создать пользователя". Элемент управления CreateUserWizard очень настраиваемый. Существует узел событий, которые срабатывают на различных этапах процесса создания учетной записи. При необходимости можно создать обработчики событий, чтобы внедрить пользовательскую логику в рабочий процесс создания учетной записи. Более того, внешний вид CreateUserWizard очень гибок. Существует ряд свойств, определяющих внешний вид интерфейса по умолчанию. При необходимости можно добавить элемент управления в шаблон или выполнить дополнительные действия по регистрации пользователя.

Начнем с того, что рассмотрим использование интерфейса и поведения по умолчанию элемента управления CreateUserWizard. Затем мы рассмотрим, как настроить внешний вид с помощью свойств и событий элемента управления.

### <a name="examining-the-createuserwizards-default-interface-and-behavior"></a>Проверка интерфейса и поведения по умолчанию для CreateUserWizard

Вернитесь на страницу `CreatingUserAccounts.aspx` в папке `Membership`, переключитесь в режим конструктора или разбиения, а затем добавьте элемент управления CreateUserWizard в верхнюю часть страницы. Элемент управления CreateUserWizard задается в разделе элементы управления входа в область элементов. После добавления элемента управления задайте для его свойства `ID` значение `RegisterUser`. Как видно на снимке экрана на рис. 11, CreateUserWizard отображает интерфейс с текстовыми полями для имени пользователя, пароля, адреса электронной почты и контрольного вопроса и ответа.

[![элемент управления CreateUserWizard визуализирует универсальный пользовательский интерфейс создания](creating-user-accounts-cs/_static/image32.png)](creating-user-accounts-cs/_static/image31.png)

**Рис. 11**. Элемент управления CreateUserWizard визуализирует универсальный пользовательский интерфейс создания ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image33.png))

Давайте рассмотрим сравнение пользовательского интерфейса по умолчанию, созданного элементом управления CreateUserWizard, с интерфейсом, созданным на шаге 5. Для начинающих элемент управления CreateUserWizard позволяет посетителю указать как контрольный вопрос, так и ответ, тогда как интерфейс, созданный вручную, использовал заранее определенный контрольный вопрос. Интерфейс элемента управления CreateUserWizard также включает элементы управления проверки, тогда как мы еще не реализовали проверку в полях формы интерфейса. Кроме того, интерфейс элемента управления CreateUserWizard содержит текстовое поле "подтверждение пароля" (вместе с объектом CompareValidator, чтобы убедиться, что текст, введенный в текстовые поля "пароль" и "сравнить пароль", равен).

Интересно то, что элемент управления CreateUserWizard обращается к параметрам конфигурации поставщика членства при подготовке к просмотру пользовательского интерфейса. Например, текстовые поля контрольные вопросы и ответы отображаются только в том случае, если параметру `requiresQuestionAndAnswer` присвоено значение true. Аналогичным образом CreateUserWizard автоматически добавляет элемент управления Регуларекспрессионвалидатор, чтобы обеспечить соблюдение требований к надежности пароля, и задает свойства `ErrorMessage` и `ValidationExpression` на основе параметров конфигурации `minRequiredPasswordLength`, `minRequiredNonalphanumericCharacters`и `passwordStrengthRegularExpression`.

Элемент управления CreateUserWizard, как предполагает его имя, является производным от [элемента управления Wizard](https://msdn.microsoft.com/library/s2etd1ek.aspx). Элементы управления мастера предназначены для предоставления интерфейса для выполнения многошаговых задач. Элемент управления "Мастер" может иметь произвольное число `WizardSteps`, каждый из которых является шаблоном, определяющим HTML и веб-элементы управления для этого шага. Элемент управления Wizard изначально отображает первый `WizardStep`вместе с элементами управления навигацией, которые позволяют пользователю перейти от одного шага к другому или вернуться к предыдущим шагам.

Как показано в декларативной разметке на рис. 11, интерфейс по умолчанию элемента управления CreateUserWizard включает в себя два `WizardSteps:`

- [`CreateUserWizardStep`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizardstep.aspx) — отображает интерфейс для получения сведений о создании новой учетной записи пользователя. Это шаг, показанный на рис. 11.
- [`CompleteWizardStep`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.completewizardstep.aspx) — готовит сообщение о том, что учетная запись успешно создана.

Внешний вид и поведение CreateUserWizard можно изменить, преобразовав один из этих шагов в шаблоны или добавив собственные `WizardSteps`. Мы рассмотрим добавление `WizardStep` в интерфейс регистрации в руководстве по *хранению дополнительных сведений о пользователях* .

Давайте посмотрим на элемент управления CreateUserWizard в действии. Посетите страницу `CreatingUserAccounts.aspx` в браузере. Начните с ввода недопустимых значений в интерфейс CreateUserWizard. Попробуйте ввести пароль, который не соответствует требованиям к надежности пароля, или оставьте поле "имя пользователя" пустым. В CreateUserWizard отобразится соответствующее сообщение об ошибке. На рис. 12 показаны выходные данные при попытке создать пользователя с недостаточным надежным паролем.

[![CreateUserWizard автоматически внедряет проверочные элементы управления](creating-user-accounts-cs/_static/image35.png)](creating-user-accounts-cs/_static/image34.png)

**Рис. 12**. CreateUserWizard автоматически внедряет элементы управления проверки ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image36.png)).

Затем введите соответствующие значения в CreateUserWizard и нажмите кнопку "создать пользователя". Предполагая, что обязательные поля введены и достаточно силы пароля, CreateUserWizard создаст новую учетную запись пользователя через платформу членства, а затем отобразит интерфейс `CompleteWizardStep`(см. рис. 13). В фоновом режиме CreateUserWizard вызывает метод `Membership.CreateUser`, как в шаге 5.

[![успешно создана новая учетная запись пользователя](creating-user-accounts-cs/_static/image38.png)](creating-user-accounts-cs/_static/image37.png)

**Рис. 13**. Новая учетная запись пользователя успешно создана ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image39.png))

> [!NOTE]
> Как показано на рис. 13, интерфейс `CompleteWizardStep`включает кнопку Continue (продолжить). Однако на этом этапе выполняется только обратная передача, а посетитель остается на той же странице. В разделе «Настройка внешнего вида и поведения CreateUserWizard с помощью свойств» мы рассмотрим, как эта кнопка позволяет отправить посетителя `Default.aspx` (или какая-либо другая страница).

После создания новой учетной записи пользователя вернитесь в Visual Studio и изучите `aspnet_Users` и `aspnet_Membership` таблицы, как показано на рис. 10, чтобы убедиться, что учетная запись была успешно создана.

### <a name="customizing-the-createuserwizards-behavior-and-appearance-through-its-properties"></a>Настройка поведения и внешнего вида CreateUserWizard с помощью свойств

CreateUserWizard можно настроить различными способами, с помощью свойств, `WizardSteps`и обработчиков событий. В этом разделе мы рассмотрим, как настроить внешний вид элемента управления с помощью его свойств. в следующем разделе рассматривается расширение поведения элемента управления с помощью обработчиков событий.

Практически весь текст, отображаемый в пользовательском интерфейсе по умолчанию элемента управления CreateUserWizard, можно настроить с помощью его свойств. Например, метки "имя пользователя", "пароль", "подтверждение пароля", "Электронная почта", "контрольный вопрос" и "ответ на безопасность", отображаемые слева от текстовых полей, можно настроить с помощью свойств [`UserNameLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.usernamelabeltext.aspx), [`PasswordLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.passwordlabeltext.aspx), [`ConfirmPasswordLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.confirmpasswordlabeltext.aspx), [`EmailLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.emaillabeltext.aspx), [`QuestionLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.questionlabeltext.aspx)и [`AnswerLabelText`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.answerlabeltext.aspx) соответственно. Аналогично, существуют свойства для указания текста для кнопок "создать пользователя" и "продолжить" в `CreateUserWizardStep` и `CompleteWizardStep`, а также при отображении этих кнопок в виде кнопок, LinkButton или Имажебуттонс.

Цвета, границы, шрифты и другие визуальные элементы настраиваются с помощью узла свойств стиля. Сам элемент управления CreateUserWizard имеет общие свойства стиля веб-элемента управления: `BackColor`, `BorderStyle`, `CssClass`, `Font`и т. д., и существует ряд свойств стиля для определения внешнего вида определенных разделов интерфейса CreateUserWizard. [Свойство`TextBoxStyle`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.textboxstyle.aspx), например, определяет стили для текстовых полей в `CreateUserWizardStep`, а [свойство`TitleTextStyle`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.titletextstyle.aspx) определяет стиль для заголовка ("зарегистрироваться для создания новой учетной записи").

Помимо свойств, связанных с внешним видом, существует ряд свойств, влияющих на поведение элемента управления CreateUserWizard. Если для [свойства`DisplayCancelButton`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.wizard.displaycancelbutton.aspx)задано значение true, отображается кнопка Отмена рядом с кнопкой "создать пользователя" (значение по умолчанию — false). При отображении кнопки Отмена необходимо также задать [свойство`CancelDestinationPageUrl`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.continuedestinationpageurl.aspx), указывающее страницу, на которую пользователь отправляется после нажатия кнопки Отмена. Как отмечалось в предыдущем разделе, кнопка продолжить в интерфейсе `CompleteWizardStep`вызывает обратную передачу, но посетитель остается на той же странице. Чтобы отправить посетителя на другую страницу после нажатия кнопки продолжить, просто укажите URL-адрес в [свойстве`ContinueDestinationPageUrl`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.continuedestinationpageurl.aspx).

Теперь обновите элемент управления `RegisterUser` CreateUserWizard, чтобы отобразить кнопку Отмена и отправить посетителя `Default.aspx` при нажатии кнопки Отмена или продолжить. Для этого задайте для свойства `DisplayCancelButton` значение true, а для свойств `CancelDestinationPageUrl` и `ContinueDestinationPageUrl` значение "~/Дефаулт.аспкс". На рис. 14 показано обновленное CreateUserWizard при просмотре в браузере.

[![CreateUserWizardStep включает кнопку отмены](creating-user-accounts-cs/_static/image41.png)](creating-user-accounts-cs/_static/image40.png)

**Рис. 14**. `CreateUserWizardStep` включает кнопку "Отмена" ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image42.png))

Когда посетитель вводит имя пользователя, пароль, адрес электронной почты, контрольный вопрос и ответ, и нажимает кнопку "создать пользователя", создается новая учетная запись пользователя, а посетитель входит в систему в качестве созданного пользователя. При условии, что пользователь, посещающий страницу, создает новую учетную запись, это, вероятно, желаемое поведение. Однако может потребоваться разрешить администраторам добавлять новые учетные записи пользователей. При этом учетная запись пользователя будет создана, но администратор останется в системе как администратор (а не в качестве вновь созданной учетной записи). Это поведение можно изменить с помощью свойства логического [`LoginCreatedUser`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).

Учетные записи пользователей в инфраструктуре членства содержат утвержденный флаг; Пользователи, которые не утверждены, не могут войти на сайт. По умолчанию вновь созданная учетная запись помечается как утвержденная, что позволяет пользователю немедленно войти на сайт. Однако возможно, что новые учетные записи пользователей помечаются как неутвержденные. Возможно, вы хотите, чтобы администратор вручную утвердил новых пользователей, прежде чем они смогут войти в систему. или, возможно, вы хотите убедиться, что адрес электронной почты, введенный при регистрации, допустим, прежде чем разрешить пользователю войти в систему. Как и в случае с тем, что созданная учетная запись пользователя помечена как неутвержденная, задав для [свойства`DisableCreatedUser`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx) элемента управления CreateUserWizard значение true (значение по умолчанию — false).

Другие связанные с поведением свойства примечания включают `AutoGeneratePassword` и `MailDefinition`. Если [свойство`AutoGeneratePassword`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.autogeneratepassword.aspx) имеет значение true, то `CreateUserWizardStep` не отображает текстовые поля "пароль" и "подтверждение пароля"; Вместо этого вновь созданный пароль пользователя создается автоматически с помощью [метода`GeneratePassword`](https://msdn.microsoft.com/library/system.web.security.membership.generatepassword.aspx)класса `Membership`. Метод `GeneratePassword` формирует пароль указанной длины и достаточное количество символов, отличных от буквенно-цифровых, для удовлетворения настроенных требований к стойкости пароля.

[Свойство`MailDefinition`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) полезно, если вы хотите отправить сообщение электронной почты по адресу, указанному в процессе создания учетной записи. Свойство `MailDefinition` содержит ряд вложенных свойств для определения сведений о созданном сообщении электронной почты. Эти подсвойства включают такие параметры, как `Subject`, `Priority`, `IsBodyHtml`, `From`, `CC`и `BodyFileName`. [Свойство`BodyFileName`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.maildefinition.bodyfilename.aspx) указывает на текстовый или HTML-файл, содержащий текст сообщения электронной почты. Текстовая часть поддерживает два предварительно определенных заполнителя: `<%UserName%>` и `<%Password%>`. Эти заполнители, если они есть в файле `BodyFileName`, будут заменены именем и паролем только что созданного пользователя.

> [!NOTE]
> Свойство `MailDefinition` элемента управления `CreateUserWizard` просто указывает сведения о сообщении электронной почты, которое отправляется при создании новой учетной записи. Он не содержит никаких сведений о фактической отправке сообщения электронной почты (то есть о том, используется ли SMTP-сервер или каталог для размещения почты, какие данные проверки подлинности и т. д.). Эти сведения низкого уровня необходимо определить в разделе `<system.net>` в `Web.config`. Дополнительные сведения об этих параметрах конфигурации и об отправке электронной почты из ASP.NET 2,0 см. в разделе [часто задаваемые вопросы по SystemNetMail.com](http://www.systemnetmail.com/) и моей статье [Отправка электронной почты в ASP.NET 2,0](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).

### <a name="extending-the-createuserwizards-behavior-using-event-handlers"></a>Расширение поведения CreateUserWizard с помощью обработчиков событий

Элемент управления CreateUserWizard вызывает ряд событий во время рабочего процесса. Например, после того, как посетитель введет свое имя пользователя, пароль и другие сведения и нажмет кнопку "создать пользователя", элемент управления CreateUserWizard вызывает [событие`CreatingUser`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.creatinguser.aspx). При возникновении проблемы во время процесса создания возникает [событие`CreateUserError`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createusererror.aspx) . Однако если пользователь успешно создан, возникает [событие`CreatedUser`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx) . Существуют дополнительные события управления CreateUserWizard, которые вызываются, но это три наиболее немецкие.

В некоторых сценариях мы можем прикоснуться к рабочему процессу CreateUserWizard, который мы можем сделать, создав обработчик событий для соответствующего события. Чтобы проиллюстрировать это, добавим `RegisterUser` элемент управления CreateUserWizard, чтобы включить некоторую пользовательскую проверку имени пользователя и пароля. В частности, давайте улучшаем наш CreateUserWizard, чтобы имена пользователей не могли содержать начальные или конечные пробелы, а имя пользователя не отображалось в любом месте пароля. Вкратце, мы хотим запретить пользователю создавать имя пользователя, например "Скотт", или использовать сочетание имени пользователя и пароля, например "Скотт" и "Скотт. 1234".

Для этого мы создадим обработчик событий для события `CreatingUser`, чтобы выполнить наши дополнительные проверки. Если указанные данные недопустимы, необходимо отменить процесс создания. Нам также нужно добавить на страницу веб-элемент управления Label, чтобы отображалось сообщение о том, что имя пользователя или пароль недействительны. Начните с добавления элемента управления Label под элементом управления CreateUserWizard, установив для его свойства `ID` значение `InvalidUserNameOrPasswordMessage` а свойству `ForeColor` — значение `Red`. Удалите свойство `Text` и задайте для его свойства `EnableViewState` и `Visible` значение false.

[!code-aspx[Main](creating-user-accounts-cs/samples/sample7.aspx)]

Затем создайте обработчик событий для `CreatingUser` события элемента управления CreateUserWizard. Чтобы создать обработчик событий, выберите элемент управления в конструкторе и перейдите к окно свойств. После этого щелкните значок с молнией, а затем дважды щелкните соответствующее событие, чтобы создать обработчик событий.

Добавьте следующий код в обработчик событий `CreatingUser` .

[!code-csharp[Main](creating-user-accounts-cs/samples/sample8.cs)]

Обратите внимание, что имя пользователя и пароль, указанные в элементе управления CreateUserWizard, доступны через свойства [`UserName`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.username.aspx) и [`Password`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.password.aspx)соответственно. Мы используем эти свойства в приведенном выше обработчике событий, чтобы определить, содержит ли указанное имя пользователя начальные или конечные пробелы и найдено ли имя пользователя в пароле. Если одно из этих условий соблюдается, в `InvalidUserNameOrPasswordMessage` метке отображается сообщение об ошибке, а свойству `e.Cancel` обработчика событий задается значение `true`. Если `e.Cancel` имеет значение `true`, CreateUserWizard короткий рабочий процесс, отменяющий процесс создания учетной записи пользователя.

На рис. 15 показан снимок экрана `CreatingUserAccounts.aspx`, когда пользователь вводит имя пользователя с начальными пробелами.

[![имена пользователей с начальными и конечными пробелами не допускаются](creating-user-accounts-cs/_static/image44.png)](creating-user-accounts-cs/_static/image43.png)

**Рис. 15**. Имена пользователей с начальными и конечными пробелами не разрешены ([щелкните, чтобы просмотреть изображение с полным размером](creating-user-accounts-cs/_static/image45.png))

> [!NOTE]
> Мы увидим пример использования события `CreatedUser` элемента управления CreateUserWizard в руководстве по *<a id="_msoanchor_11"></a>[хранению дополнительных сведений о пользователях](storing-additional-user-information-cs.md)* .

## <a name="summary"></a>Сводка

Метод `CreateUser` класса `Membership` создает новую учетную запись пользователя в инфраструктуре членства. Это достигается путем делегирования вызова настроенному поставщику членства. В случае `SqlMembershipProvider`метод `CreateUser` добавляет запись в таблицы базы данных `aspnet_Users` и `aspnet_Membership`.

Хотя новые учетные записи пользователей можно создавать программно (как было показано на шаге 5), более быстрый и простой подход заключается в использовании элемента управления CreateUserWizard. Этот элемент управления отображает многоэтапный пользовательский интерфейс для сбора сведений о пользователе и создания нового пользователя в инфраструктуре членства. Под этим элементом управления используется тот же метод `Membership.CreateUser`, что и в шаге 5, но элемент управления создает пользовательский интерфейс, проверочные элементы управления и реагирует на ошибки создания учетной записи пользователя, не требуя написания кода.

На этом этапе у нас есть функциональные возможности для создания новых учетных записей пользователей. Однако страница входа по-прежнему проверяется на соответствие жестко заданным учетным данным, которые мы указали во втором учебнике. <a id="_msoanchor_12"> </a>В [следующем учебном курсе](validating-user-credentials-against-the-membership-user-store-cs.md) будет обновлен `Login.aspx` для проверки предоставленных пользователем учетных данных в инфраструктуре членства.

Поздравляем с программированием!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Техническая документация по `CreateUser`](https://msdn.microsoft.com/library/system.web.security.membershipprovider.createuser.aspx)
- [Общие сведения об элементе управления CreateUserWizard](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/login/createuserwizard.aspx)
- [Создание поставщика карт сайта на основе файловой системы](http://aspnet.4guysfromrolla.com/articles/020106-1.aspx)
- [Создание пошагового пользовательского интерфейса с помощью элемента управления мастера ASP.NET 2,0](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx)
- [Изучение навигации по веб-узлу ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx)
- [Главные страницы и Навигация по сайту](https://asp.net/learn/data-access/tutorial-03-vb.aspx)
- [Поставщик схемы узла SQL, который вы ожидали](https://msdn.microsoft.com/msdnmag/issues/06/02/WickedCode/default.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких книг по ASP/ASP. NET и основатель 4GuysFromRolla.com, работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — *[Sams обучать себя ASP.NET 2,0 за 24 часа](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скотт можно получить по адресу [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) или через свой блог по адресу [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность...

Эта серия руководств была рассмотрена многими полезными рецензентами. Специалист по интересу для этого руководства был Терезой Мерфи. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com).

> [!div class="step-by-step"]
> [Назад](creating-the-membership-schema-in-sql-server-cs.md)
> [Вперед](validating-user-credentials-against-the-membership-user-store-cs.md)
