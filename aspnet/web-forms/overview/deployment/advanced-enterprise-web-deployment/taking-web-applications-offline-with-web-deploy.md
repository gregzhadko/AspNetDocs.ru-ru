---
uid: web-forms/overview/deployment/advanced-enterprise-web-deployment/taking-web-applications-offline-with-web-deploy
title: Перевод веб-приложений в автономный режим с помощью веб-развертывание | Документация Майкрософт
author: jrjlee
description: В этом разделе описывается, как перевести веб-приложение в автономный режим на период автоматического развертывания с помощью службы IIS (IIS) Web Депл...
ms.author: riande
ms.date: 05/04/2012
ms.assetid: 3e9f6e7d-8967-4586-94d5-d3a122f12529
msc.legacyurl: /web-forms/overview/deployment/advanced-enterprise-web-deployment/taking-web-applications-offline-with-web-deploy
msc.type: authoredcontent
ms.openlocfilehash: ba60664a0c3daa0650cd7e7cfc4ab9da08df3440
ms.sourcegitcommit: e365196c75ce93cd8967412b1cfdc27121816110
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2020
ms.locfileid: "77075142"
---
# <a name="taking-web-applications-offline-with-web-deploy"></a>Перевод веб-приложений в автономный режим с помощью веб-развертывания

кто [Джейсон Иванов](https://github.com/jrjlee)

[Скачать в формате PDF](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> В этом разделе описывается, как перевести веб-приложение в автономный режим на период автоматического развертывания с помощью средства веб-развертывания службы IIS (IIS) (веб-развертывание). Пользователи, просматривающие веб-приложение, перенаправляются в *приложение\_автономного файла. htm* до завершения развертывания.

Этот раздел является частью серии руководств, основанных на требованиях Enterprise к развертыванию вымышленной компании Fabrikam, Inc. В этой серии руководств используется пример решения&#x2014; [диспетчера контактов](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;для представления веб-приложения с реалистичным уровнем сложности, включая приложение ASP.NET MVC 3, службу Windows Communication Foundation (WCF) и проект базы данных.

Метод развертывания в сердце этих учебников основан на подходе к файлам проекта Split, описанному в разделе [понимание файла проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), в котором процесс сборки управляется двумя файлами&#x2014;проекта, содержащими инструкции по сборке, которые применяются к каждой целевой среде, и одна содержит параметры сборки и развертывания, относящиеся к конкретной среде. Во время сборки файл проекта, зависящий от среды, объединяется в файл проекта независимо от среды, чтобы сформировать полный набор инструкций по сборке.

## <a name="task-overview"></a>Обзор задач

В большинстве случаев необходимо перевести веб-приложение в автономный режим во время внесения изменений в связанные компоненты, такие как базы данных или веб-службы. Как правило, в IIS и ASP.NET это можно сделать, поместив файл с именем *App\_offline. htm* в корневую папку веб-сайта IIS или веб-приложения. *Приложение\_автономным htm* -файлом является СТАНДАРТНЫМ HTML-файлом и обычно содержит простое сообщение о том, что сайт временно недоступен из-за обслуживания. Хотя *приложение\_автономного файла. htm* находится в корневой папке веб-сайта, IIS автоматически перенаправит все запросы в файл. После завершения внесения обновлений вы удаляете *приложение\_автономный файл. htm* , и веб-сайт возобновляет обслуживание запросов как обычно.

При использовании веб-развертывание для выполнения автоматизированных или одноэтапных развертываний в целевой среде может потребоваться добавление и удаление *приложения\_автономного файла. htm* в процесс развертывания. Для этого необходимо выполнить следующие задачи высокого уровня:

- В файле проекта Microsoft Build Engine (MSBuild), который используется для управления процессом развертывания, создайте целевой объект MSBuild, который копирует *приложение\_автономный htm* -файл на целевой сервер перед началом выполнения задач развертывания.
- Добавьте еще один целевой объект MSBuild, который удаляет *приложение\_автономного файла. htm* с целевого сервера после завершения всех задач развертывания.
- В проекте веб-приложения создайте файл с *расширением WPP. targets* , который гарантирует, что *приложение\_автономный htm* -файл добавляется в пакет развертывания при вызове веб-развертывание.

В этом разделе будет показано, как выполнять эти процедуры. В задачах и пошаговых руководствах в этом разделе предполагается, что вы уже создали решение, которое содержит по крайней мере один проект веб-приложения, и вы используете пользовательский файл проекта для управления процессом развертывания, как описано в разделе [веб-развертывание на предприятии](../web-deployment-in-the-enterprise/web-deployment-in-the-enterprise.md). Кроме того, вы можете использовать образец решения [Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md) , чтобы выполнить примеры, приведенные в разделе.

## <a name="adding-an-app_offline-file-to-a-web-application-project"></a>Добавление приложения\_автономный файл в проект веб-приложения

Первая задача, которую необходимо выполнить, заключается в добавлении *приложения\_автономный* файл в проект веб-приложения:

- Чтобы предотвратить влияние файла на процесс разработки (вы не хотите, чтобы приложение было постоянно отключено), следует вызвать его, кроме *приложения,\_автономным. htm*. Например, можно присвоить имя файлового *приложения\_оффлине-Темплате. htm*.
- Чтобы запретить развертывание файла "как есть", следует задать для действия сборки значение **нет**.

**Добавление приложения\_автономного файла в проект веб-приложения**

1. Откройте решение в Visual Studio 2010.
2. В окне **Обозреватель решений** щелкните правой кнопкой мыши проект веб-приложения, наведите указатель на пункт **Добавить**и выберите пункт **новый элемент**.
3. В диалоговом окне **Добавление нового элемента** выберите **страница HTML**.
4. В поле **имя** введите **app\_оффлине-Темплате. htm**, а затем нажмите кнопку **добавить**.

    ![](taking-web-applications-offline-with-web-deploy/_static/image1.png)
5. Добавьте простой код HTML, чтобы сообщить пользователям о недоступности приложения, а затем сохраните файл. Не включайте Теги на стороне сервера (например, теги с префиксом "ASP:"). 

    ![](taking-web-applications-offline-with-web-deploy/_static/image2.png)
6. В окне **Обозреватель решений** щелкните правой кнопкой мыши новый файл и выберите пункт **свойства**.
7. В окне **Свойства** в строке **действие построения** выберите **нет**.

    ![](taking-web-applications-offline-with-web-deploy/_static/image3.png)

## <a name="deploying-and-deleting-an-app_offline-file"></a>Развертывание и удаление приложения\_автономный файл

Следующим шагом является изменение логики развертывания, чтобы скопировать файл на целевой сервер в начале процесса развертывания и удалить его в конце.

> [!NOTE]
> В следующей процедуре предполагается, что вы используете пользовательский файл проекта MSBuild для управления процессом развертывания, как описано в разделе [Общие сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md). При развертывании напрямую из Visual Studio необходимо использовать другой подход. Саид Ибрагим Хашими описывает один из таких подходов: [как перевести веб-приложение в автономный режим во время публикации](http://sedodream.com/2012/01/08/HowToTakeYourWebAppOfflineDuringPublishing.aspx).

Чтобы развернуть *приложение\_автономном* файле на целевом веб-сайте IIS, необходимо вызвать msdeploy. exe с помощью [поставщика веб-развертывание **контентпас** ](https://technet.microsoft.com/library/dd569034(WS.10).aspx). Поставщик **контентпас** поддерживает как физические пути, так и веб-сайт IIS или пути приложений, что делает его идеальным выбором для синхронизации файла между папкой проекта Visual Studio и веб-приложением IIS. Чтобы развернуть файл, команда MSDeploy должна выглядеть примерно так:

[!code-console[Main](taking-web-applications-offline-with-web-deploy/samples/sample1.cmd)]

Чтобы удалить файл с конечного сайта в конце процесса развертывания, команда MSDeploy должна выглядеть примерно так:

[!code-console[Main](taking-web-applications-offline-with-web-deploy/samples/sample2.cmd)]

Чтобы автоматизировать эти команды как часть процесса сборки и развертывания, необходимо интегрировать их в файл пользовательского проекта MSBuild. В следующей процедуре описывается, как это сделать.

**Развертывание и удаление приложения\_автономном файле**

1. В Visual Studio 2010 откройте файл проекта MSBuild, который управляет процессом развертывания. В образце решения [диспетчера контактов](../web-deployment-in-the-enterprise/the-contact-manager-solution.md) это файл *Publish. proj* .
2. В корневом элементе **проекта** создайте новый элемент **PropertyGroup** для хранения переменных *приложения\_автономном* развертывании:

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample3.xml)]
3. Свойство **SourceRoot** определено в любом расположении в файле *Publish. proj* . Указывает расположение корневой папки для исходного содержимого относительно текущего пути&#x2014;другими словами относительно расположения файла *Publish. proj* .
4. Поставщик **контентпас** не будет принимать относительные пути к файлам, поэтому необходимо получить абсолютный путь к исходному файлу, прежде чем его можно будет развернуть. Для этого можно использовать задачу [ConvertToAbsolutePath](https://msdn.microsoft.com/library/bb882668.aspx) .
5. Добавьте новый **целевой** элемент с именем **жетаппоффлинеабсолутепас**. В рамках этого целевого объекта используйте задачу **ConvertToAbsolutePath** , чтобы получить абсолютный путь к *приложению\_файл шаблона вне сети* в папке проекта.

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample4.xml)]
6. Этот целевой объект принимает относительный путь к *приложению\_файл шаблона вне сети* в папке проекта и сохраняет его в новом свойстве как абсолютный путь к файлу. Атрибут **бефоретаржетс** указывает, что этот целевой объект должен выполняться перед целевым объектом **деплойаппоффлине** , который будет создан на следующем шаге.
7. Добавьте новый целевой объект с именем **деплойаппоффлине**. В этом целевом объекте вызовите команду MSDeploy. exe, которая развертывает *приложение\_автономный* файл на целевой веб-сервер.

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample5.xml)]
8. В этом примере свойство **контактманажерииспас** определено в любом расположении файла проекта. Это просто путь к приложению IIS в формате *[имя веб-сайта IIS]/[имя приложения]* . Включение условия в целевой объект позволяет пользователям переключать *приложение\_автономное* развертывание, изменяя значение свойства или предоставляя параметр командной строки.
9. Добавьте новый целевой объект с именем **делетеаппоффлине**. В этом целевом объекте вызовите команду MSDeploy. exe, которая удаляет *приложение\_автономный* файл с целевого веб-сервера.

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample6.xml)]
10. Последняя задача — вызвать эти новые цели в соответствующих точках во время выполнения файла проекта. Это можно сделать различными способами. Например, в файле *Publish. proj* свойство **фуллпублишдепендсон** указывает список целевых объектов, которые должны выполняться по порядку при вызове целевого объекта **фуллпублиш** по умолчанию.
11. Измените файл проекта MSBuild, чтобы вызвать целевые объекты **деплойаппоффлине** и **делетеаппоффлине** в соответствующих точках процесса публикации.

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample7.xml)]

При запуске файла пользовательского проекта MSBuild *приложение,\_автономный* файл, будет развернуто на сервере сразу после успешной сборки. После завершения всех задач развертывания она будет удалена с сервера.

## <a name="adding-an-app_offline-file-to-deployment-packages"></a>Добавление приложения\_автономный файл в пакеты развертывания

В зависимости от настройки развертывания любое существующее содержимое в целевом веб-приложении&#x2014;IIS, такое как *приложение\_автономного файла* &#x2014;. htm, может быть удалено автоматически при развертывании веб-пакета в месте назначения. Чтобы убедиться, что *приложение\_автономным htm* -файл остается на месте в течение развертывания, необходимо включить файл в сам пакет веб-развертывания наряду с развертыванием файла непосредственно в начале процесса развертывания.

- Если вы выполнили предыдущие задачи в этом разделе, вы добавите *приложение\_автономный файл. htm* в проект веб-приложения под другим именем (мы использовали *приложение\_оффлине-Темплате. htm*), а для действия сборки задать значение **None**. Эти изменения необходимы для предотвращения влияния файла на разработку и отладку. В результате необходимо настроить процесс упаковки, чтобы *приложение\_автономный htm* -файл был включен в пакет развертывания.

Конвейер веб-публикаций (WPP) использует список элементов с именем **филесфорпаккагингфромпрожект** для создания списка файлов, которые должны быть добавлены в пакет веб-развертывания. Вы можете настроить содержимое веб-пакетов, добавив собственные элементы в этот список. Для этого необходимо выполнить следующие общие действия.

1. Создайте пользовательский файл проекта с именем *[Project name]. wpp. targets* в той же папке, что и файл проекта.

    > [!NOTE]
    > Файл *. wpp. targets* должен находиться в той же папке, что и файл&#x2014;проекта веб-приложения, например *ContactManager. MVC. csproj*&#x2014;, а не в той же папке, что и все пользовательские файлы проекта, используемые для управления процессом сборки и развертывания.
2. В файле *. wpp. targets* создайте новый целевой объект MSBuild, который выполняется *до* целевого объекта **копяллфилестосинглефолдерфорпаккаже** . Это цель WPP, которая создает список объектов, включаемых в пакет.
3. В новом целевом объекте создайте элемент **ItemGroup** .
4. В элементе **ItemGroup** добавьте элемент **Филесфорпаккагингфромпрожект** и укажите *приложение\_автономный htm* -файл.

Файл *. wpp. targets* должен выглядеть следующим образом:

[!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample8.xml)]

Вот ключевые моменты, которые следует учитывать в этом примере:

- Атрибут **бефоретаржетс** вставляет этот целевой объект в конвейер WPP, указывая, что он должен выполняться непосредственно перед целевым объектом **копяллфилестосинглефолдерфорпаккаже** .
- Элемент **филесфорпаккагингфромпрожект** использует значение метаданных **дестинатионрелативепас** для переименования файла из *приложения\_оффлине-темплате. htm* в *приложение\_offline. htm* , добавленное в список.

В следующей процедуре показано, как добавить этот файл *WPP. targets* в проект веб-приложения.

**Добавление файла с расширением WPP. targets в пакет веб-развертывания**

1. Откройте решение в Visual Studio 2010.
2. В окне **Обозреватель решений** щелкните правой кнопкой мыши узел проекта веб-приложения (например, **ContactManager. MVC**), наведите указатель на пункт **добавить**и выберите пункт **новый элемент**.
3. В диалоговом окне **Добавление нового элемента** выберите шаблон **XML-файл** .
4. В поле **имя** введите *[имя проекта] * *. wpp. targets** (например, **ContactManager. MVC. wpp. targets**) и нажмите кнопку **Добавить**.

    ![](taking-web-applications-offline-with-web-deploy/_static/image4.png)

    > [!NOTE]
    > При добавлении нового элемента в корневой узел проекта файл создается в той же папке, что и файл проекта. Это можно проверить, открыв папку в проводнике Windows.
5. В файле добавьте разметку MSBuild, описанную ранее.

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample9.xml)]
6. Сохраните и закройте файл *[имя проекта]. wpp. targets* .

В следующий раз при сборке и упаковке проекта веб-приложения в конвейере WPP автоматически обнаруживается файл с расширением *WPP. targets* . Файл *приложения\_оффлине-Темплате. htm* будет включаться в итоговый пакет веб-развертывания как *приложение\_автономный. htm*.

> [!NOTE]
> В случае сбоя развертывания приложение *\_автономный htm* файл останется на месте, и ваше приложение останется в автономном режиме. Обычно это предпочтительное поведение. Чтобы перевести приложение в режим «в сети», можно удалить *приложение\_автономный htm* -файл с вашего сервера. Кроме того, если устранить ошибки и выполнить успешное развертывание, *приложение\_автономным htm* -файл будет удалено.

## <a name="conclusion"></a>Заключение

В этом разделе описано, как перевести веб-приложение в автономный режим на время развертывания, публикуя *приложение\_автономного файла. htm* на целевом сервере в начале процесса развертывания и удаляя его в конце. Кроме того, в пакет веб-развертывания входит *приложение\_автономного файла. htm.*

## <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о процессе упаковки и развертывания см. в статьях [Создание и упаковка проектов веб-приложений](../web-deployment-in-the-enterprise/building-and-packaging-web-application-projects.md), [Настройка параметров для развертывания веб-пакетов](../web-deployment-in-the-enterprise/configuring-parameters-for-web-package-deployment.md)и [Развертывание веб-пакетов](../web-deployment-in-the-enterprise/deploying-web-packages.md).

При публикации веб-приложений непосредственно из Visual Studio вместо использования пользовательского файла проекта MSBuild, описанного в этих учебниках, необходимо использовать немного другой подход, чтобы перевести приложение в автономный режим во время публикации. процесс.

> [!div class="step-by-step"]
> [Назад](excluding-files-and-folders-from-deployment.md)
> [Вперед](running-windows-powershell-scripts-from-msbuild-project-files.md)
