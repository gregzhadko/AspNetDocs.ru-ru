---
uid: web-forms/overview/deployment/advanced-enterprise-web-deployment/customizing-database-deployments-for-multiple-environments
title: Настройка развертываний баз данных для нескольких сред | Документация Майкрософт
author: jrjlee
description: В этом разделе описывается, как настроить свойства базы данных в соответствии с конкретными целевыми средами в рамках процесса развертывания. Примечание. в этом разделе предполагается, что...
ms.author: riande
ms.date: 05/04/2012
ms.assetid: a172979a-1318-4318-a9c6-4f9560d26267
msc.legacyurl: /web-forms/overview/deployment/advanced-enterprise-web-deployment/customizing-database-deployments-for-multiple-environments
msc.type: authoredcontent
ms.openlocfilehash: 8ae8cb1a322afb95c5d2e8d5e73c7825c7b2fe5a
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78489036"
---
# <a name="customizing-database-deployments-for-multiple-environments"></a>Настройка развертываний баз данных для нескольких сред

кто [Джейсон Иванов](https://github.com/jrjlee)

[Скачать в формате PDF](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> В этом разделе описывается, как настроить свойства базы данных в соответствии с конкретными целевыми средами в рамках процесса развертывания.
> 
> > [!NOTE]
> > В этом разделе предполагается, что вы развертываете проект базы данных Visual Studio 2010 с помощью MSBuild. exe и VSDBCMD. exe. Дополнительные сведения о том, почему вы можете выбрать этот подход, см. [в разделе веб-развертывание на предприятии](../web-deployment-in-the-enterprise/web-deployment-in-the-enterprise.md) и [развертывание проектов баз данных](../web-deployment-in-the-enterprise/deploying-database-projects.md).
> 
> 
> При развертывании проекта базы данных на нескольких целевых объектах часто требуется настроить свойства развертывания базы данных для каждой целевой среды. Например, в тестовой среде вы обычно воссоздаете базу данных при каждом развертывании, в то время как в промежуточной или рабочей среде гораздо большей вероятностью будут выполняться добавочные обновления для сохранения данных.
> 
> В проекте базы данных Visual Studio 2010 параметры развертывания содержатся в файле конфигурации развертывания (. sqldeployment). В этом разделе показано, как создать файлы конфигурации развертывания для конкретной среды и указать, какой из них нужно использовать в качестве параметра VSDBCMD.

Этот раздел является частью серии руководств, основанных на требованиях Enterprise к развертыванию вымышленной компании Fabrikam, Inc. В этой серии руководств используется пример решения&#x2014; [диспетчера контактов](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;для представления веб-приложения с реалистичным уровнем сложности, включая приложение ASP.NET MVC 3, службу Windows Communication Foundation (WCF) и проект базы данных.

Метод развертывания в сердце этих учебников основан на подходе к файлам проекта Split, описанному в разделе [понимание файла проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), в котором процесс сборки управляется двумя файлами&#x2014;проекта, содержащими инструкции по сборке, которые применяются к каждой целевой среде, и одна содержит параметры сборки и развертывания, относящиеся к конкретной среде. Во время сборки файл проекта, зависящий от среды, объединяется в файл проекта независимо от среды, чтобы сформировать полный набор инструкций по сборке.

## <a name="task-overview"></a>Обзор задач

Для этого раздела предполагается следующее.

- Для развертывания решения следует использовать подход к файлам проекта с разделением, как описано в разделе [Общие сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md).
- Чтобы развернуть проект базы данных, необходимо вызвать программу VSDBCMD из файла проекта, как описано в разделе [Основные сведения о процессе сборки](../web-deployment-in-the-enterprise/understanding-the-build-process.md).

Чтобы создать систему развертывания, которая поддерживает различные свойства развертывания базы данных между целевыми средами, необходимо выполнить следующие действия.

- Создайте файл конфигурации развертывания (sqldeployment) для каждой целевой среды.
- Создайте команду VSDBCMD, которая указывает файл конфигурации развертывания в качестве параметра командной строки.
- Параметризация команды VSDBCMD в файле проекта Microsoft Build Engine (MSBuild), чтобы параметры VSDBCMD соответствовали целевой среде.

В этом разделе будет показано, как выполнить каждую из этих процедур.

## <a name="creating-environment-specific-deployment-configuration-files"></a>Создание файлов конфигурации развертывания для конкретной среды

По умолчанию проект базы данных содержит один файл конфигурации развертывания с именем *Database. sqldeployment*. Если открыть этот файл в Visual Studio 2010, можно увидеть различные доступные варианты развертывания:

- **Параметры сортировки сравнения для развертывания**. Это позволяет выбрать, следует ли использовать параметры сортировки базы данных проекта ( *исходные* параметры сортировки) или параметры сортировки базы данных на целевом сервере ( *целевые* параметры сортировки). В большинстве случаев при развертывании в среде разработки или тестирования необходимо использовать исходные параметры сортировки. При развертывании в промежуточной или рабочей среде обычно требуется оставить целевые параметры сортировки без изменений, чтобы избежать проблем с взаимодействием.
- **Разверните свойства базы данных**. Это позволяет выбрать, следует ли применять свойства базы данных, как определено в файле *Database. sqlsettings* . При первом развертывании базы данных необходимо развернуть свойства базы данных. Если вы обновляете существующую базу данных, эти свойства уже должны быть установлены, и вам не нужно повторно развертывать их.
- **Всегда повторно создавать базу данных**. Это позволяет выбрать, следует ли повторно создавать целевую базу данных каждый раз при развертывании или внесении добавочных изменений для обновления целевой базы данных до текущей схемы. При повторном создании базы данных будут потеряны все данные в существующей базе данных. Таким образом, обычно следует установить значение **false** для развертывания в промежуточной или рабочей среде.
- **Блокировать добавочное развертывание, если могут возникать потери данных**. Это позволяет выбрать, должно ли развертывание останавливаться, если изменение схемы базы данных приведет к потере данных. Обычно для этого параметра задано **значение true** для развертывания в рабочей среде, что дает возможность положить и защитить важные данные. Если вы установили **всегда повторно создавать базу данных** в **значение false**, этот параметр не будет действовать.
- **Выполнение развертывания в однопользовательском режиме**. Обычно это не является проблемой в средах разработки или тестирования. Однако обычно это значение **true** для развертываний в промежуточной или рабочей среде. Это не позволит пользователям вносить изменения в базу данных во время развертывания.
- **Резервное копирование базы данных перед развертыванием**. Обычно это значение **true** при развертывании в рабочей среде, в качестве меры предосторожности к потери данных. Можно также задать **значение true** при развертывании в промежуточной среде, если промежуточная база данных содержит большой объем данных.
- **Создайте инструкции DROP для объектов, которые находятся в целевой базе данных, но не находятся в проекте базы данных**. В большинстве случаев это является неотъемлемой и неотъемлемой частью внесения добавочных изменений в базу данных. Если вы установили **всегда повторно создавать базу данных** в **значение false**, этот параметр не будет действовать.
- **Не используйте инструкции ALTER ASSEMBLY для обновления типов CLR**. Этот параметр определяет, как SQL Server должны обновлять типы среды CLR до более новых версий сборки. В большинстве случаев это значение должно быть равно **false** .

В этой таблице показаны стандартные параметры развертывания для различных конечных сред. Однако параметры могут отличаться в зависимости от конкретных требований.

|  | Разработчик и тестирование | Промежуточное хранение и интеграция | Производство |
| --- | --- | --- | --- |
| **Параметры сортировки сравнения для развертывания** | Источник | Назначение | Назначение |
| **Развертывание свойств базы данных** | True | Только в первый раз | Только в первый раз |
| **Всегда повторно создавать базу данных** | True | False | False |
| **Блокировать добавочное развертывание, если могут возникать потери данных** | False | Возможно | True |
| **Выполнение скрипта развертывания в однопользовательском режиме** | False | True | True |
| **Резервное копирование базы данных перед развертыванием** | False | Возможно | True |
| **Создать инструкции DROP для объектов, которые находятся в целевой базе данных, но не находятся в проекте базы данных** | False | True | True |
| **Не используйте инструкции ALTER ASSEMBLY для обновления типов CLR** | False | False | False |

> [!NOTE]
> Дополнительные сведения о свойствах развертывания базы данных и вопросах среды см. в [обзоре параметров проекта базы данных](https://msdn.microsoft.com/library/aa833291(v=VS.100).aspx), о [настройке свойств для сведений о развертывании](https://msdn.microsoft.com/library/dd172125.aspx), [построении и развертывании базы данных в изолированной среде разработки](https://msdn.microsoft.com/library/dd193409.aspx), а также при [построении и развертывании баз данных в промежуточной или рабочей среде](https://msdn.microsoft.com/library/dd193413.aspx).

Для поддержки развертывания проекта базы данных по нескольким местам назначения необходимо создать файл конфигурации развертывания для каждой целевой среды.

**Создание файла конфигурации, относящегося к конкретной среде**

1. В Visual Studio 2010 в окне **Обозреватель решений** щелкните правой кнопкой мыши проект базы данных и выберите пункт **свойства**.
2. На странице Свойства проекта базы данных на вкладке **развертывание** в строке **файл конфигурации развертывания** нажмите кнопку **создать**.

    ![](customizing-database-deployments-for-multiple-environments/_static/image1.png)
3. В диалоговом окне **новый файл конфигурации развертывания** присвойте файлу понятное имя (например, **тестенвиронмент. sqldeployment**) и нажмите кнопку **сохранить**.
4. На странице *[filename] * * *. sqldeployment** задайте свойства развертывания в соответствии с требованиями целевой среды, а затем сохраните файл.

    ![](customizing-database-deployments-for-multiple-environments/_static/image2.png)
5. Обратите внимание, что новый файл добавляется в папку Properties проекта базы данных.

    ![](customizing-database-deployments-for-multiple-environments/_static/image3.png)

## <a name="specifying-the-deployment-configuration-file-in-vsdbcmd"></a>Указание файла конфигурации развертывания в VSDBCMD

При использовании конфигураций решения (таких как отладка и выпуск) в Visual Studio 2010 можно связать файл конфигурации развертывания с каждой конфигурацией. При создании конкретной конфигурации в процессе сборки создается файл манифеста развертывания, относящийся к конфигурации, указывающий на файл конфигурации развертывания, относящийся к конфигурации. Однако одна из главных цель подхода к развертыванию, описанная в этих руководствах, заключается в предоставлении пользователям возможности управления процессом развертывания без использования Visual Studio 2010 и конфигураций решений. При таком подходе конфигурация решения одинакова независимо от целевой среды развертывания. Чтобы настроить развертывание базы данных в определенной целевой среде, можно использовать параметры командной строки VSDBCMD, чтобы указать файл конфигурации развертывания.

Чтобы указать файл конфигурации развертывания в VSDBCMD, используйте параметр **p:/деплойментконфигуратионфиле** и укажите полный путь к файлу. Это приведет к переопределению файла конфигурации развертывания, идентифицируемого манифестом развертывания. Например, эту команду VSDBCMD можно использовать для развертывания базы данных **ContactManager** в тестовой среде:

[!code-console[Main](customizing-database-deployments-for-multiple-environments/samples/sample1.cmd)]

> [!NOTE]
> Обратите внимание, что процесс сборки может переименовать файл. sqldeployment при копировании файла в выходной каталог.

При использовании переменных команды SQL в скриптах SQL, выполняемых перед развертыванием или после развертывания, можно использовать аналогичный подход, чтобы связать с развертыванием SQLCMDVARS-файл, относящийся к конкретной среде. В этом случае вы используете параметр **p:/склкоммандвариаблесфиле** , чтобы указать SQLCMDVARS-файл.

## <a name="running-the-vsdbcmd-command-from-an-msbuild-project-file"></a>Выполнение команды VSDBCMD из файла проекта MSBuild

Команду VSDBCMD можно вызвать из файла проекта MSBuild с помощью задачи **exec** в целевом объекте MSBuild. В простейшем виде он будет выглядеть следующим образом:

[!code-xml[Main](customizing-database-deployments-for-multiple-environments/samples/sample2.xml)]

- На практике, чтобы упростить чтение и повторное использование файлов проекта, необходимо создать свойства для хранения различных параметров командной строки. Это упрощает пользователям предоставление значений свойств в файле проекта конкретной среды или переопределение значений по умолчанию из командной строки MSBuild. При использовании подхода "разделить файл проекта", описанного в разделе [понимание файла проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), необходимо разделить инструкции и свойства сборки между двумя файлами:
- Параметры, зависящие от среды, такие как имя файла конфигурации развертывания, строка подключения к базе данных и имя целевой базы данных, должны находиться в файле проекта, относящемся к конкретной среде.
- Целевой объект MSBuild, который запускает команду VSDBCMD вместе со всеми универсальными свойствами, такими как расположение исполняемого файла VSDBCMD, должен находиться в файле универсального проекта.

Следует также убедиться, что сборка проекта базы данных выполняется до вызова VSDBCMD, чтобы файл. деплойманифест был создан и готов к использованию. Полный пример этого подхода см. в разделе [Основные сведения о процессе сборки](../web-deployment-in-the-enterprise/understanding-the-build-process.md), в котором приведены файлы проекта из [примера решения диспетчера контактов](../web-deployment-in-the-enterprise/the-contact-manager-solution.md).

## <a name="conclusion"></a>Заключение

В этом разделе описывается, как можно адаптировать свойства базы данных к различным конечным средам при развертывании проектов баз данных с помощью MSBuild и VSDBCMD. Этот подход полезен при необходимости развертывания проектов баз данных в рамках крупных решений корпоративного уровня. Эти решения часто развертываются в нескольких назначениях, например в изолированных средах разработки или тестирования, платформах промежуточного хранения или интеграции, а также в рабочих или динамических средах. Для каждой из этих целевых сред обычно требуется уникальный набор свойств развертывания базы данных.

## <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о развертывании проектов баз данных с помощью программы VSDBCMD. exe см. в разделе [развертывание проектов баз данных](../web-deployment-in-the-enterprise/deploying-database-projects.md). Дополнительные сведения об использовании пользовательских файлов проекта MSBuild для управления процессом развертывания см. в разделе [Основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md) и [понимании процесса сборки](../web-deployment-in-the-enterprise/understanding-the-build-process.md).

В этих статьях на сайте MSDN приведены более общие рекомендации по развертыванию базы данных.

- [Общие сведения о параметрах проекта базы данных](https://msdn.microsoft.com/library/aa833291(v=VS.100).aspx)
- [Инструкции. Настройка свойств для сведений о развертывании](https://msdn.microsoft.com/library/dd172125.aspx)
- [Создание и развертывание баз данных в изолированной среде разработки](https://msdn.microsoft.com/library/dd193409.aspx)
- [Создание и развертывание баз данных в промежуточной или рабочей среде](https://msdn.microsoft.com/library/dd193413.aspx)

> [!div class="step-by-step"]
> [Назад](performing-a-what-if-deployment.md)
> [Вперед](deploying-database-role-memberships-to-test-environments.md)
