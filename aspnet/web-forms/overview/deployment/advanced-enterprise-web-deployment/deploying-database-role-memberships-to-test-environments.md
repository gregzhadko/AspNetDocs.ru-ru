---
uid: web-forms/overview/deployment/advanced-enterprise-web-deployment/deploying-database-role-memberships-to-test-environments
title: Развертывание членства в роли базы данных в средах тестирования | Документация Майкрософт
author: jrjlee
description: В этом разделе описывается добавление учетных записей пользователей к ролям базы данных как часть развертывания решения в тестовой среде. При развертывании типа решение, содержащее...
ms.author: riande
ms.date: 05/04/2012
ms.assetid: 9b2af539-7ad9-47aa-b66e-873bd9906e79
msc.legacyurl: /web-forms/overview/deployment/advanced-enterprise-web-deployment/deploying-database-role-memberships-to-test-environments
msc.type: authoredcontent
ms.openlocfilehash: a15f5bf5f659d151e91ef9e53c5ad55bcd8e2b01
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65130407"
---
# <a name="deploying-database-role-memberships-to-test-environments"></a>Развертывание членства в роли базы данных в средах тестирования

по [Джейсон Lee](https://github.com/jrjlee)

[Загрузить PDF-файл](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> В этом разделе описывается добавление учетных записей пользователей к ролям базы данных как часть развертывания решения в тестовой среде.
> 
> Когда вы развертываете решение, содержащее проект базы данных в промежуточной или рабочей среде, обычно не нужно разработчику автоматизировать добавление учетных записей пользователей в роли базы данных. В большинстве случаев разработчику не будет знать, какие учетные записи пользователей должны быть добавлены к роли базы данных, и эти требования могут быть изменены в любое время. Тем не менее при развертывании решения, содержащего проект базы данных для разработки или тестовой среды, ситуация обычно отличается:
> 
> - Разработчик обычно выполняет повторное развертывание решения на регулярной основе, часто несколько раз в день.
> - Базы данных обычно создается заново при каждом развертывании, это означает, что пользователи базы данных необходимо создавать и добавлять в роли после каждого развертывания.
> - Обычно разработчик имеет полный контроль над целевой среды разработки или тестирования.
> 
> В этом случае часто бывает полезным для автоматического создания базы данных пользователей и назначить членство в ролях базы данных как часть процесса развертывания.
> 
> Ключевым фактором является то, что эта операция должна быть условного зависимости от целевой среды. Если вы развертываете в промежуточной или рабочей среде, вы хотите пропустить операцию. Если вы развертываете разработчику или тестовой среде, которую требуется развернуть членства в роли без дальнейшего вмешательства. В этом разделе описываются одним из подходов можно использовать для решения этой задачи.

Этот раздел является частью серии учебников, исходя из требования к развертыванию enterprise вымышленной компании Fabrikam, Inc. В этой серии руководств используется пример решения&#x2014; [решения диспетчера контактов](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;для представления веб-приложения с более реалистичные уровень сложности, включая приложения ASP.NET MVC 3, Windows Communication Служба Foundation (WCF) и проект базы данных.

Метод развертывания в основе этих учебников основан на разбиение проекта файл подход, описанный в [основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), в которой процесс построения управляется двумя файлы проекта&#x2014;один с Создание инструкции, которые применяются для каждой целевой среде и содержащего параметры построения и развертывания для конкретной среды. Во время сборки файл проекта для конкретной среды объединяется в файл проекта независимой от среды, чтобы полный набор инструкций построения.

## <a name="task-overview"></a>Общие сведения о задачах

В этом разделе предполагается, что:

- Вам следует использовать разбиение проекта файл для развертывания решения, как описано в разделе [основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md).
- Вызовите средство VSDBCMD из файла проекта, чтобы развернуть проект базы данных, как описано в разделе [основные сведения о процессе построения](../web-deployment-in-the-enterprise/understanding-the-build-process.md).

Чтобы создать пользователей базы данных и назначить членство в ролях, при развертывании проекта базы данных в тестовой среде, вам потребуется:

- Создайте скрипт Transact язык структурированных запросов (Transact-SQL), который вносит изменения необходимые базы данных.
- Создайте целевой объект Microsoft Build Engine (MSBuild), который использует программы sqlcmd.exe для выполнения скрипта SQL.
- Настройка файлов проекта для вызова целевого при развертывании решения в тестовой среде.

В этом разделе показано, как выполнить каждую из этих процедур.

## <a name="scripting-the-database-role-memberships"></a>Создание сценариев членство в ролях базы данных

Во многих различных способов можно создать сценарий Transact-SQL и в любом месте, выберите. Проще всего создать сценарий в рамках решения в Visual Studio 2010.

**Чтобы создать скрипт SQL**

1. В **обозревателе решений** окне разверните узел проекта базы данных.
2. Щелкните правой кнопкой мыши **сценарии** папку **добавить**, а затем нажмите кнопку **новую папку**.
3. Тип **теста** как имя папки и нажмите клавишу ВВОД.
4. Щелкните правой кнопкой мыши **теста** папку **добавить**и нажмите кнопку **скрипт**.
5. В **Добавление нового элемента** диалогового окна поле, присвойте понятное имя сценария (например, **AddRoleMemberships.sql**) и нажмите кнопку **добавить**.

    ![](deploying-database-role-memberships-to-test-environments/_static/image1.png)
6. В *AddRoleMemberships.sql* добавьте инструкции Transact-SQL:

    1. Создайте пользователя базы данных для имени входа SQL Server, который получит доступ к базе данных.
    2. Добавление пользователя базы данных в любые роли базы данных.
7. Файл должен выглядеть примерно следующим образом:

    [!code-sql[Main](deploying-database-role-memberships-to-test-environments/samples/sample1.sql)]
8. Сохраните файл.

## <a name="executing-the-script-on-the-target-database"></a>Выполнение скрипта в целевой базе данных

В идеале будет запуска всех необходимых скриптов Transact-SQL в скрипте после развертывания, при развертывании проекта базы данных. Тем не менее, после развертывания сценарии не позволяют выполнить логику, в зависимости от конфигурации решения или свойства сборки. Можно выполнять скрипты SQL непосредственно из файла проекта MSBuild, создав **целевой** элемент, который выполняет команду sqlcmd.exe. Эта команда используется для запуска скрипта в целевой базе данных:

[!code-console[Main](deploying-database-role-memberships-to-test-environments/samples/sample2.cmd)]

> [!NOTE]
> Дополнительные сведения о параметрах командной строки sqlcmd, см. в разделе [служебная программа sqlcmd](https://msdn.microsoft.com/library/ms162773.aspx).

Прежде чем внедрить эту команду в целевой объект MSBuild, необходимо учитывать при каких условиях требуется, скрипт для запуска:

- Целевой базы данных должен существовать, прежде чем изменить его членство в ролях. Таким образом, необходимо запустить этот сценарий *после* развертывания базы данных.
- Необходимо включить условие, чтобы скрипт выполняется только для тестовых сред.
- Если вы используете развертывания «what if»&#x2014;другими словами, если создание скриптов развертывания, но фактически не запускать их&#x2014;не следует запустить сценарий SQL.

Если вы используете разбиение проекта файл подход, описанный в [основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), как показано в примере решения диспетчера контактов, вы можете разделить инструкциях по сборке для сценария SQL следующим образом:

- Любые необходимые свойства, относящиеся к среде, вместе со свойством, определяющее, следует ли развертывать разрешения, должны размещаться в файле проекта для конкретной среды (например, *Env Dev.proj*).
- Целевой объект MSBuild, а также любые свойства, которые остаются неизменными между средами назначения должны попадать в файле универсальный проект (например, *Publish.proj*).

В файле проекта для конкретной среды необходимо определить имя сервера базы данных, имя целевой базы данных и логическое свойство, которое позволяет пользователю указать, следует ли развертывать членства в роли.

[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample3.xml)]

В файле универсальный проект необходимо предоставить расположение исполняемом файле sqlcmd и расположение сценария SQL, который вы хотите запустить. Эти свойства остается неизменным независимо от целевой среде. Также необходимо создать целевой объект MSBuild, чтобы выполнить команду sqlcmd.

[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample4.xml)]

Обратите внимание, что добавьте расположение исполняемом файле sqlcmd как статическое свойство, как это может быть полезно для других целевых объектов. Напротив вы определяете расположение сценария SQL и синтаксис команды sqlcmd как динамические свойства в целевой объект, так как они не понадобится целевой объект которого выполняется. В этом случае **DeployTestDBPermissions** целевой объект выполняется только при соблюдении этих условий:

- **DeployTestDBRoleMemberships** свойству **true**.
- Пользователь не указал **WhatIf = true** флаг.

Наконец не забудьте вызвать целевой объект. В *Publish.proj* файл, это можно сделать, добавив целевой объект в список зависимостей по умолчанию **FullPublish** целевой объект. Необходимо убедиться, что **DeployTestDBPermissions** целевой объект не выполняется до **PublishDbPackages** целевой объект был выполнен.

[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample5.xml)]

## <a name="conclusion"></a>Заключение

В этом разделе описывается один из способов, в котором можно добавить пользователей базы данных и членства в роли как действие после развертывания при развертывании проекта базы данных. Это обычно полезно в тех случаях, когда регулярно повторно создать базу данных в тестовой среде, но его следует избегать обычно при развертывании баз данных в промежуточной или рабочей среде. Таким образом следует убедиться, используйте необходимые условную логику, чтобы все пользователи базы данных и членства в роли создаются только при необходимости для этого.

## <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения об использовании VSDBCMD для развертывания проектов баз данных см. в разделе [развертывание проектов баз данных](../web-deployment-in-the-enterprise/deploying-database-projects.md). Руководство по настройке развертывания баз данных для разных целевых сред см. в разделе [Настройка развертываний баз данных для нескольких сред](customizing-database-deployments-for-multiple-environments.md). Дополнительные сведения об использовании настраиваемых файлов проекта MSBuild для управления процессом развертывания, см. в разделе [основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md) и [основные сведения о процессе построения](../web-deployment-in-the-enterprise/understanding-the-build-process.md). Дополнительные сведения о параметрах командной строки sqlcmd, см. в разделе [служебная программа sqlcmd](https://msdn.microsoft.com/library/ms162773.aspx).

> [!div class="step-by-step"]
> [Назад](customizing-database-deployments-for-multiple-environments.md)
> [Вперед](deploying-membership-databases-to-enterprise-environments.md)
