---
uid: web-forms/overview/deployment/advanced-enterprise-web-deployment/deploying-database-role-memberships-to-test-environments
title: Развертывание членства в ролях базы данных в тестовых средах | Документация Майкрософт
author: jrjlee
description: В этом разделе описывается добавление учетных записей пользователей в роли базы данных в рамках развертывания решения в тестовую среду. При развертывании решения, содержащего...
ms.author: riande
ms.date: 05/04/2012
ms.assetid: 9b2af539-7ad9-47aa-b66e-873bd9906e79
msc.legacyurl: /web-forms/overview/deployment/advanced-enterprise-web-deployment/deploying-database-role-memberships-to-test-environments
msc.type: authoredcontent
ms.openlocfilehash: a15f5bf5f659d151e91ef9e53c5ad55bcd8e2b01
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78474948"
---
# <a name="deploying-database-role-memberships-to-test-environments"></a>Развертывание членства в роли базы данных в средах тестирования

кто [Джейсон Иванов](https://github.com/jrjlee)

[Скачать в формате PDF](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> В этом разделе описывается добавление учетных записей пользователей в роли базы данных в рамках развертывания решения в тестовую среду.
> 
> При развертывании решения, содержащего проект базы данных, в промежуточной или рабочей среде разработчику обычно не требуется автоматизировать добавление учетных записей пользователей в роли базы данных. В большинстве случаев разработчик не знает, какие учетные записи должны быть добавлены в роли базы данных, и эти требования могут измениться в любое время. Однако при развертывании решения, содержащего проект базы данных, в среде разработки или тестирования ситуация обычно отличается.
> 
> - Разработчик обычно повторно развертывает решение регулярно, часто несколько раз в день.
> - База данных обычно создается повторно при каждом развертывании. Это означает, что пользователи базы данных должны быть созданы и добавлены к ролям после каждого развертывания.
> - Разработчик обычно имеет полный контроль над целевой средой разработки или тестирования.
> 
> В этом сценарии часто бывает полезно автоматически создавать пользователей базы данных и назначать членство в ролях базы данных в рамках процесса развертывания.
> 
> Ключевым фактором является то, что эта операция должна быть условной, исходя из целевой среды. Если выполняется развертывание в промежуточной или рабочей среде, необходимо пропустить эту операцию. При развертывании в среде разработчика или тестирования необходимо развернуть членство в ролях без дальнейшего вмешательства. В этом разделе описывается один из подходов, которые можно использовать для решения этой задачи.

Этот раздел является частью серии руководств, основанных на требованиях Enterprise к развертыванию вымышленной компании Fabrikam, Inc. В этой серии руководств используется пример решения&#x2014; [диспетчера контактов](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;для представления веб-приложения с реалистичным уровнем сложности, включая приложение ASP.NET MVC 3, службу Windows Communication Foundation (WCF) и проект базы данных.

Метод развертывания в сердце этих учебников основан на подходе к файлам проекта Split, описанному в разделе [понимание файла проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), в котором процесс сборки управляется двумя файлами&#x2014;проекта, содержащими инструкции по сборке, которые применяются к каждой целевой среде, и одна содержит параметры сборки и развертывания, относящиеся к конкретной среде. Во время сборки файл проекта, зависящий от среды, объединяется в файл проекта независимо от среды, чтобы сформировать полный набор инструкций по сборке.

## <a name="task-overview"></a>Обзор задач

Для этого раздела предполагается следующее.

- Для развертывания решения следует использовать подход к файлам проекта с разделением, как описано в разделе [Общие сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md).
- Чтобы развернуть проект базы данных, необходимо вызвать программу VSDBCMD из файла проекта, как описано в разделе [Основные сведения о процессе сборки](../web-deployment-in-the-enterprise/understanding-the-build-process.md).

Чтобы создать пользователей базы данных и назначить членство в ролях при развертывании проекта базы данных в тестовой среде, необходимо выполнить следующие действия.

- Создайте скрипт Transact язык SQL (Transact-SQL), который вносит необходимые изменения в базу данных.
- Создайте целевой объект Microsoft Build Engine (MSBuild), использующий служебную программу sqlcmd. exe для выполнения скрипта SQL.
- Настройте файлы проекта так, чтобы они вызывали целевой объект при развертывании решения в тестовой среде.

В этом разделе будет показано, как выполнить каждую из этих процедур.

## <a name="scripting-the-database-role-memberships"></a>Создание скрипта членства в ролях базы данных

Скрипт Transact-SQL можно создать множеством различных способов и в любом выбранном расположении. Самый простой подход заключается в создании скрипта в решении в Visual Studio 2010.

**Создание скрипта SQL**

1. В окне **Обозреватель решений** разверните узел проекта базы данных.
2. Щелкните правой кнопкой мыши папку **сценарии** , наведите указатель на пункт **Добавить**и выберите пункт **создать папку**.
3. Введите **Test** в качестве имени папки и нажмите клавишу ВВОД.
4. Щелкните правой кнопкой мыши **тестовую** папку, наведите указатель на пункт **Добавить**и выберите пункт **Скрипт**.
5. В диалоговом окне **Добавление нового элемента** присвойте скрипту понятное имя (например, **аддролемембершипс. SQL**) и нажмите кнопку **добавить**.

    ![](deploying-database-role-memberships-to-test-environments/_static/image1.png)
6. В файле *аддролемембершипс. SQL* добавьте инструкции TRANSACT-SQL, которые:

    1. Создайте пользователя базы данных для SQL Server имени входа, которое будет обращаться к базе данных.
    2. Добавьте пользователя базы данных в все необходимые роли базы данных.
7. Файл должен выглядеть примерно так:

    [!code-sql[Main](deploying-database-role-memberships-to-test-environments/samples/sample1.sql)]
8. Сохраните файл.

## <a name="executing-the-script-on-the-target-database"></a>Выполнение скрипта в целевой базе данных

В идеале при развертывании проекта базы данных необходимо выполнить все необходимые скрипты Transact-SQL как часть скрипта, выполняемого после развертывания. Однако скрипты, выполняемые после развертывания, не позволяют выполнять логику по условию на основе конфигураций решения или свойств сборки. Альтернативой является выполнение скриптов SQL непосредственно из файла проекта MSBuild путем создания **целевого** элемента, выполняющего команду SQLCMD. exe. Эту команду можно использовать для запуска скрипта в целевой базе данных:

[!code-console[Main](deploying-database-role-memberships-to-test-environments/samples/sample2.cmd)]

> [!NOTE]
> Дополнительные сведения о параметрах командной строки sqlcmd см. в разделе [программа sqlcmd](https://msdn.microsoft.com/library/ms162773.aspx).

Перед внедрением этой команды в целевой объект MSBuild необходимо принять во внимание условия, при которых должен выполняться сценарий:

- Целевая база данных должна существовать до изменения ее членства в ролях. Таким образом, этот скрипт необходимо запустить *после* развертывания базы данных.
- Необходимо включить условие, чтобы скрипт выполнялся только для тестовых сред.
- Если вы выполняете развертывание&#x2014;"What If" другими словами, если вы создаете скрипты развертывания, но не запускаете их&#x2014;, не следует запускать скрипт SQL.

Если вы используете подход с файлами разделенного проекта, описанный в разделе [понимание файла проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), как показано в примере решения диспетчера контактов, можно разделить инструкции по построению для сценария SQL следующим образом:

- Все необходимые свойства для конкретной среды вместе со свойством, которое определяет, следует ли развертывать разрешения, следует обращаться к файлу проекта конкретной среды (например, *env-dev. proj*).
- Целевой объект MSBuild вместе со всеми свойствами, которые не изменятся между конечными средами, должен находиться в универсальном файле проекта (например, *Publish. proj*).

В файле проекта для конкретной среды необходимо определить имя сервера базы данных, имя целевой базы данных и логическое свойство, которое позволяет пользователю указать, следует ли развертывать членство в ролях.

[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample3.xml)]

В файле универсального проекта необходимо указать расположение исполняемого файла sqlcmd и расположение скрипта SQL, который требуется выполнить. Эти свойства останутся неизменными независимо от среды назначения. Кроме того, необходимо создать целевой объект MSBuild для выполнения команды sqlcmd.

[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample4.xml)]

Обратите внимание, что расположение исполняемого файла sqlcmd добавляется как статическое свойство, так как это может быть полезно для других целевых объектов. В отличие от этого, вы определяете расположение скрипта SQL и синтаксис команды sqlcmd в качестве динамических свойств в пределах целевого объекта, так как они не будут требоваться перед выполнением целевого объекта. В этом случае целевой объект **деплойтестдбпермиссионс** будет выполняться, только если выполняются следующие условия.

- Свойство **деплойтестдбролемембершипс** имеет значение **true**.
- Пользователь не указал флаг **WhatIf = true** .

Наконец, не забудьте вызвать целевой объект. В файле *Publish. proj* это можно сделать, добавив целевой объект в список зависимостей для целевого объекта **фуллпублиш** по умолчанию. Необходимо убедиться, что целевой объект **деплойтестдбпермиссионс** не выполняется до тех пор, пока не будет выполнен целевой объект **публишдбпаккажес** .

[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample5.xml)]

## <a name="conclusion"></a>Заключение

В этом разделе описывается один из способов добавления пользователей базы данных и членства в ролях в качестве действия после развертывания при развертывании проекта базы данных. Это обычно полезно при регулярном повторном создании базы данных в тестовой среде, но ее обычно следует избегать при развертывании баз данных в промежуточных или рабочих средах. Таким образом, следует убедиться, что используется обязательная условная логика, чтобы пользователи базы данных и членство в ролях создавались только тогда, когда это уместно.

## <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения об использовании программы VSDBCMD для развертывания проектов баз данных см. в разделе [развертывание проектов баз данных](../web-deployment-in-the-enterprise/deploying-database-projects.md). Рекомендации по настройке развертываний баз данных для различных целевых сред см. в разделе [Настройка развертываний баз данных для нескольких сред](customizing-database-deployments-for-multiple-environments.md). Дополнительные сведения об использовании пользовательских файлов проекта MSBuild для управления процессом развертывания см. в разделе [Основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md) и [понимании процесса сборки](../web-deployment-in-the-enterprise/understanding-the-build-process.md). Дополнительные сведения о параметрах командной строки sqlcmd см. в разделе [программа sqlcmd](https://msdn.microsoft.com/library/ms162773.aspx).

> [!div class="step-by-step"]
> [Назад](customizing-database-deployments-for-multiple-environments.md)
> [Вперед](deploying-membership-databases-to-enterprise-environments.md)
