---
uid: web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-database-update
title: 'ASP.NET веб-развертывание с помощью Visual Studio: развертывание обновления базы данных | Документация Майкрософт'
author: tdykstra
description: В этой серии руководств показано, как развернуть (опубликовать) веб-приложение ASP.NET в веб-приложениях службы приложений Azure или поставщике услуг размещения стороннего поставщика, Усин...
ms.author: riande
ms.date: 02/15/2013
ms.assetid: 9cad0833-486a-4474-a7f3-7715542ec4ce
msc.legacyurl: /web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-database-update
msc.type: authoredcontent
ms.openlocfilehash: 805eb84c24764cf921291f89054435601dbac48e
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74636832"
---
# <a name="aspnet-web-deployment-using-visual-studio-deploying-a-database-update"></a>Веб-развертывание ASP.NET с помощью Visual Studio: развертывание обновления базы данных

от [Tom Dykstra)](https://github.com/tdykstra)

[Скачать начальный проект](https://go.microsoft.com/fwlink/p/?LinkId=282627)

> В этой серии руководств показано, как развернуть (опубликовать) веб-приложение ASP.NET в веб-приложениях службы приложений Azure или поставщике услуг размещения стороннего поставщика с помощью Visual Studio 2012 или Visual Studio 2010. Сведения о ряде см. в [первом руководстве по ряду](introduction.md).

## <a name="overview"></a>Обзор

В этом руководстве вы вносите изменения в базу данных и связанную с ней изменения кода, тестируете изменения в Visual Studio, а затем развертываете обновление в тестовой, промежуточной и рабочей средах.

Сначала в руководстве показано, как обновить базу данных, управляемую с помощью Code First Migrations, а затем в дальнейшем будет показано, как обновить базу данных с помощью поставщика Дбдакфкс.

Напоминание. Если вы получаете сообщение об ошибке или что-то не работает при работе с этим руководством, обязательно ознакомьтесь со [страницей устранения неполадок](troubleshooting.md).

## <a name="deploy-a-database-update-by-using-code-first-migrations"></a>Развертывание обновления базы данных с помощью Code First Migrations

В этом разделе вы добавите столбец даты рождения в базовый класс `Person` для сущностей `Student` и `Instructor`. Затем вы обновите страницу, на которой отображаются данные о преподавателе, чтобы отобразить новый столбец. Наконец, вы развертываете изменения для тестирования, промежуточного хранения и рабочей среды.

### <a name="add-a-column-to-a-table-in-the-application-database"></a>Добавление столбца в таблицу в базе данных приложения

1. В проекте *ContosoUniversity. DAL* откройте *Person.CS* и добавьте следующее свойство в конце класса `Person` (после него должны быть две закрывающие фигурные скобки):

    [!code-csharp[Main](deploying-a-database-update/samples/sample1.cs)]

    Затем обновите метод `Seed` таким образом, чтобы он выдает значение для нового столбца. Откройте *Migrations\Configuration.CS* и замените блок кода, который начинается `var instructors = new List<Instructor>`, на следующий блок кода, содержащий сведения о дате рождения:

    [!code-csharp[Main](deploying-a-database-update/samples/sample2.cs)]
2. Выполните сборку решения, а затем откройте окно **консоли диспетчера пакетов** . Убедитесь, что ContosoUniversity. DAL по-прежнему выбран в качестве **проекта по умолчанию**.
3. В окне **консоли диспетчера пакетов** выберите **ContosoUniversity. DAL** в качестве **проекта по умолчанию**, а затем введите следующую команду:

    [!code-powershell[Main](deploying-a-database-update/samples/sample3.ps1)]

    По завершении этой команды Visual Studio открывает файл класса, который определяет новый класс `DbMigration`, а в методе `Up` можно увидеть код, создающий новый столбец. Метод `Up` создает столбец при реализации изменения, а метод `Down` удаляет столбец при откате изменения.

    ![AddBirthDate_migration_code](deploying-a-database-update/_static/image1.png)
4. Выполните сборку решения, а затем введите следующую команду в окне **консоли диспетчера пакетов** (убедитесь, что проект CONTOSOUNIVERSITY. DAL по-прежнему выбран):

    [!code-powershell[Main](deploying-a-database-update/samples/sample4.ps1)]

    Entity Framework выполняет метод `Up`, а затем выполняет метод `Seed`.

### <a name="display-the-new-column-in-the-instructors-page"></a>Отображение нового столбца на странице инструкторов

1. В проекте ContosoUniversity откройте *инструкторы. aspx* и добавьте новое поле шаблона, чтобы отобразить дату рождения. Добавьте его между ними для даты найма и назначения Office:

    [!code-aspx[Main](deploying-a-database-update/samples/sample5.aspx?highlight=9-17)]

    (Если отступы кода не синхронизированы, можно нажать сочетание клавиш CTRL-K и CTRL-D, чтобы автоматически переформатировать файл.)
2. Запустите приложение и щелкните ссылку **инструкторы** .

    Когда страница загрузится, вы увидите, что в ней есть новое поле даты рождения.

    ![Страница инструкторов с ДеньРождения](deploying-a-database-update/_static/image2.png)
3. Закройте браузер.

### <a name="deploy-the-database-update"></a>Развертывание обновления базы данных

1. В **Обозреватель решений** выберите проект ContosoUniversity.
2. На панели инструментов **веб-публикация одним щелчком** выберите профиль **тестовой** публикации и щелкните **Опубликовать веб-сайт**. (Если панель инструментов отключена, выберите проект ContosoUniversity в **Обозреватель решений**.)

    Visual Studio развертывает обновленное приложение, и браузер открывается на домашней странице.
3. Запустите страницу **инструкторы** , чтобы убедиться, что обновление успешно развернуто.

    Когда приложение пытается получить доступ к базе данных для этой страницы, Code First обновляет схему базы данных и выполняет метод `Seed`. При отображении страницы отображается столбец ожидаемая **Дата рождения** с датами в нем.
4. На панели инструментов **веб-публикация одним щелчком** выберите профиль **промежуточной** публикации, а затем щелкните **Опубликовать веб-сайт**.
5. Запустите страницу **инструкторов** в промежуточной среде, чтобы убедиться, что обновление успешно развернуто.
6. На панели инструментов **веб-публикация одним щелчком** выберите профиль **рабочей** публикации и нажмите кнопку **Опубликовать веб-сайт**.
7. Запустите страницу **инструкторов** в рабочей среде, чтобы убедиться, что обновление успешно развернуто.

    Для реального обновления производственного приложения, включающего изменение базы данных, обычно приложение переводится в автономный режим во время развертывания с помощью *приложения\_автономно. htm*, как было показано в предыдущем руководстве.

## <a name="deploy-a-database-update-by-using-the-dbdacfx-provider"></a>Развертывание обновления базы данных с помощью поставщика Дбдакфкс

В этом разделе вы добавите столбец *комментариев* в *пользовательскую* таблицу в базе данных членства и создадите страницу, позволяющую отображать и редактировать комментарии для каждого пользователя. Затем вы развертываете изменения для тестирования, промежуточного хранения и рабочей среды.

### <a name="add-a-column-to-a-table-in-the-membership-database"></a>Добавление столбца в таблицу в базе данных членства

1. В Visual Studio откройте **Обозреватель объектов SQL Server**.
2. Разверните узел **(LocalDB) \v11.0**, разверните узел **базы данных**, разверните узел **ASPNET-ContosoUniversity** (не **ASPNET-ContosoUniversity-произв**.), а затем разверните узел **таблицы**.

    Если вы не видите **(LocalDB) \v11.0** в узле **SQL Server** , щелкните правой кнопкой мыши узел **SQL Server** и выберите команду **Добавить SQL Server**. В диалоговом окне **соединение с сервером** введите *(LocalDB) \v11.0* в качестве **имени сервера**и нажмите кнопку **подключить**.

    Если вы не видите элемент **ASPNET-ContosoUniversity**, запустите проект и войдите в систему, используя учетные данные *администратора* (пароль — *девпвд*), а затем обновите окно **Обозреватель объектов SQL Server** .
3. Щелкните правой кнопкой мыши таблицу **Пользователи** и выберите пункт **Конструктор представлений**.

    ![Конструктор представлений SSOX](deploying-a-database-update/_static/image3.png)
4. В конструкторе добавьте столбец *Comments* и сделайте его *nvarchar (128)* и Nullable, а затем нажмите кнопку **Обновить**.

    ![Добавление столбца комментариев](deploying-a-database-update/_static/image4.png)
5. В поле **Предварительный просмотр обновлений базы данных** щелкните **обновить базу данных**.

    ![Предварительный просмотр обновлений базы данных](deploying-a-database-update/_static/image5.png)

### <a name="create-a-page-to-display-and-edit-the-new-column"></a>Создание страницы для просмотра и изменения нового столбца

1. В **Обозреватель решений**щелкните правой кнопкой мыши папку **учетной записи** в проекте ContosoUniversity, выберите **Добавить**, а затем щелкните **новый элемент**.
2. Создайте новую **веб-форму с помощью главной страницы** и назовите ее *userInfo. aspx*. Примите файл *site. master* по умолчанию в качестве главной страницы.
3. Скопируйте следующую разметку в элемент `MainContent` `Content` (последний из 3 `Content` элементов):

    [!code-aspx[Main](deploying-a-database-update/samples/sample6.aspx)]
4. Щелкните правой кнопкой мыши страницу *userInfo. aspx* и выберите пункт **Просмотр в браузере**.
5. Войдите в систему с учетными данными *администратора* ( *девпвд*) и добавьте к пользователю комментарии, чтобы убедиться, что страница работает правильно.

    ![Страница UserInfo](deploying-a-database-update/_static/image6.png)
6. Закройте браузер.

## <a name="deploy-the-database-update"></a>Развертывание обновления базы данных

Чтобы выполнить развертывание с помощью поставщика Дбдакфкс, необходимо просто выбрать параметр **обновить базу данных** в профиле публикации. Однако для первоначального развертывания при использовании этого параметра вы также настроили некоторые дополнительные скрипты SQL для выполнения: они все еще находятся в профиле, и вам нужно будет предотвратить их повторное выполнение.

1. Откройте мастер **публикации веб-сайта** , щелкнув правой кнопкой мыши проект ContosoUniversity и выбрав **Publish (опубликовать**).
2. Выберите профиль **тестирования** .
3. Перейдите на вкладку **Параметры** .
4. В разделе **DefaultConnection**выберите **обновить базу данных**.
5. Отключите дополнительные скрипты, которые были настроены для выполнения начального развертывания:

    1. Щелкните **настроить обновления базы данных**.
    2. В диалоговом окне **Настройка обновлений базы данных** снимите флажки для *GRANT. SQL* и *АСПнет-Дата-дев. SQL*.
    3. Нажмите кнопку **Закрыть**.
6. Перейдите на вкладку **Предварительный просмотр** .
7. В разделе **базы данных** и справа от **DefaultConnection**щелкните ссылку **Предварительная версия базы данных** .

    ![Предварительная версия базы данных](deploying-a-database-update/_static/image7.png)

    В окне предварительного просмотра отображается скрипт, который будет выполняться в целевой базе данных, чтобы схема базы данных совпадала со схемой базы данных источника. Скрипт включает команду ALTER TABLE, которая добавляет новый столбец.
8. Закройте диалоговое окно **Предварительный просмотр базы данных** и нажмите кнопку **опубликовать**.

    Visual Studio развертывает обновленное приложение, и браузер открывается на домашней странице.
9. Запустите страницу UserInfo (добавьте *учетную запись/UserInfo. aspx* к URL-адресу домашней страницы), чтобы убедиться, что обновление успешно развернуто. Вам потребуется войти в систему, введя *Admin* and *девпвд*.

    Данные в таблицах не развертываются по умолчанию, и вы не настроили скрипт развертывания данных для выполнения, поэтому вы не найдете комментарий, добавленный при разработке. Теперь можно добавить новый комментарий в промежуточной среде, чтобы убедиться, что изменение было развернуто в базе данных, и страница работает правильно.
10. Выполните ту же процедуру для развертывания в промежуточной и рабочей среде.

    Не забудьте отключить дополнительные сценарии. Единственная разница по сравнению с профилем тестирования заключается в том, что в промежуточном и рабочем профилях будет отключен только один скрипт, так как они были настроены для запуска только *АСПнет-прод-Дата. SQL*.

    Учетные данные для промежуточного хранения и рабочей среды — Admin и продпвд.

    Для реального обновления производственного приложения, включающего изменение базы данных, обычно приложение переводится в автономный режим во время развертывания путем отправки приложения *\_автономно. htm* перед публикацией и удалением в дальнейшем, как было показано в [предыдущем руководстве](deploying-a-code-update.md).

## <a name="summary"></a>Сводка

Теперь вы развернули обновление приложения, которое включало изменение базы данных, с помощью Code First Migrations и поставщика Дбдакфкс.

![Страница инструкторов с ДеньРождения](deploying-a-database-update/_static/image8.png)

![Страница UserInfo](deploying-a-database-update/_static/image9.png)

В следующем учебнике показано, как выполнять развертывания с помощью командной строки.

> [!div class="step-by-step"]
> [Назад](deploying-a-code-update.md)
> [Вперед](command-line-deployment.md)
