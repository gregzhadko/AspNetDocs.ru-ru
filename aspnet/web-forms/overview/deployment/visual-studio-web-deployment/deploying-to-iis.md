---
uid: web-forms/overview/deployment/visual-studio-web-deployment/deploying-to-iis
title: 'ASP.NET веб-развертывание с помощью Visual Studio: Развертывание в тест | Документация Майкрософт'
author: tdykstra
description: В этой серии руководств показано, как развернуть (опубликовать) веб-приложение ASP.NET в веб-приложениях службы приложений Azure или поставщике услуг размещения стороннего поставщика, Усин...
ms.author: riande
ms.date: 01/16/2019
ms.assetid: 8bf2c4fb-4ee5-4841-bfc2-03462c1f7a7a
msc.legacyurl: /web-forms/overview/deployment/visual-studio-web-deployment/deploying-to-iis
msc.type: authoredcontent
ms.openlocfilehash: c45003325832258466a787bc589bf40e844248a2
ms.sourcegitcommit: 4b324a11131e38f920126066b94ff478aa9927f8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2019
ms.locfileid: "70985859"
---
# <a name="aspnet-web-deployment-using-visual-studio-deploying-to-test"></a>ASP.NET веб-развертывание с помощью Visual Studio: Развертывание в тестовой среде

от [Tom Dykstra)](https://github.com/tdykstra)

В этой серии руководств показано, как развернуть (опубликовать) веб-приложение ASP.NET в веб-приложениях службы приложений Azure или поставщик услуг размещения стороннего поставщика с помощью Visual Studio 2017. Сведения о ряде см. в [первом руководстве по ряду](introduction.md).

Текущую версию развертывания в Azure см. [в статье Создание веб-приложения ASP.NET Core в Azure](/azure/app-service/app-service-web-get-started-dotnet).

## <a name="overview"></a>Обзор

В этом руководстве вы развернете веб-приложение ASP.NET на локальном компьютере в Internet Information Server (IIS).

Как правило, при разработке приложения его можно запускать и тестировать в Visual Studio. По умолчанию проекты веб-приложений в Visual Studio 2017 используют IIS Express в качестве веб-сервера разработки. IIS Express работает более похоже на полные службы IIS, чем Visual Studio Development Server (также известный как Cassini), которые Visual Studio 2017 использует по умолчанию. Но ни веб-сервер разработки не работает точно так же, как IIS. Следовательно, приложение может быть запущено и правильно тестироваться в Visual Studio, но при развертывании в IIS оно завершается ошибкой.

Вы можете надежно протестировать приложение двумя способами:

1. Разверните приложение в службах IIS на компьютере разработчика, используя тот же процесс, который будет использоваться позже для развертывания в рабочей среде.

   Вы можете настроить Visual Studio для использования IIS при запуске веб-проекта, но это не проверит процесс развертывания. Этот метод проверяет процесс развертывания и корректное выполнение приложения в службах IIS.

2. Разверните приложение в тестовой среде, подобной рабочей среде. 
 
   Рабочая среда для этих руководств — это веб-приложения в службе приложений Azure. Идеальная тестовая среда — это дополнительное веб-приложение, созданное в службе Azure. Хотя он настраивается так же, как и рабочее веб-приложение, его можно использовать только для тестирования.

Вариант 2 является наиболее надежным способом тестирования. При использовании варианта 2 вам не обязательно использовать вариант 1. Однако при развертывании на сторонних поставщика услуг размещения вариант 2 может быть неосуществимым или дорогостоящим, поэтому в этом руководстве показаны оба метода. Руководство по варианту 2 приведено в учебнике [развертывание в рабочей среде](deploying-to-production.md) .

Дополнительные сведения об использовании веб-серверов в Visual Studio см. в разделе веб- [серверы в Visual Studio для веб-проектов ASP.NET](https://msdn.microsoft.com/library/58wxa9w5.aspx).

Напоминание Если появляется сообщение об ошибке или что-то не работает при работе с учебником, обязательно ознакомьтесь со [страницей устранения неполадок](troubleshooting.md).

## <a name="download-the-contoso-university-starter-project"></a>Скачайте начальный проект университета Contoso

Скачайте и установите решение и проект начального решения Visual Studio для университета университетов contoso. Это решение содержит завершенный учебник. 

[Скачать начальный проект](http://go.microsoft.com/fwlink/p/?LinkId=282627)

## <a name="install-iis"></a>Установка служб IIS

Чтобы выполнить развертывание в службах IIS на компьютере разработчика, убедитесь, что установлены службы IIS и веб-развертывание. По умолчанию Visual Studio устанавливает веб-развертывание, но службы IIS не входят в конфигурацию Windows 10, Windows 8 или Windows 7 по умолчанию. Если вы уже установили службы IIS, а пул приложений по умолчанию уже имеет значение .NET 4, перейдите к [следующему разделу](#sqlexpress).

1. Для установки служб IIS и веб-развертывание рекомендуется использовать [установщик веб-платформы (ВПИ)](https://www.microsoft.com/web/downloads/platform.aspx) . ВПИ устанавливает рекомендуемую конфигурацию IIS, которая включает в себя службы IIS и веб-развертывание необходимые условия.

   Если вы уже установили IIS, веб-развертывание или любой из необходимых компонентов, ВПИ устанавливает только то, что отсутствует.

   * Используйте установщик веб-платформы для установки служб IIS и веб-развертывание.
    
     ![Установка IIS с помощью ВПИ](deploying-to-iis/_static/image30.png)

     ![Установка веб-развертывание с помощью ВПИ](deploying-to-iis/_static/image31.png)

     Вы увидите сообщения о том, что будут установлены службы IIS 7. Ссылка работает для IIS 8 в Windows 8; но для Windows 8 и более поздних версий выполните следующие действия, чтобы убедиться, что установлен ASP.NET 4,7:

   * Откройте **панель** > управления**программы** > программы**и компоненты** > **Включение или отключение компонентов Windows**.

   * Разверните **службы IIS**, **веб-службы**и **функции разработки приложений**.
   
   * Убедитесь, что выбран **ASP.NET 4,7** .

     ![Выберите ASP.NET 4,7](deploying-to-iis/_static/image1a.png)

   * Убедитесь, что выбраны **службы** Интернета и **консоль управления IIS** . При этом устанавливаются службы IIS и Диспетчер IIS.
    
     ![Выберите службы Интернета](deploying-to-iis/_static/image24.png)    
  
   * Нажмите кнопку **ОК**. Отображаются сообщения диалогового окна, указывающие на наличие установки.

После установки служб IIS запустите **Диспетчер IIS** , чтобы убедиться, что .NET Framework версии 4 назначено пулу приложений по умолчанию.

1. Нажмите WINDOWS + R, чтобы открыть диалоговое окно **выполнить** .

   (В Windows 8 или более поздней версии введите "Run" на **начальной** странице. В Windows 7 выберите пункт **выполнить** из меню " **Пуск** ". Если **команда запустить** отсутствует в меню " **Пуск** ", щелкните правой кнопкой мыши панель задач, выберите пункт " **Свойства**", перейдите на вкладку " **меню** ", выберите " **Настройка**" и нажмите кнопку " **выполнить команду**".)

2. Введите "inetmgr" и нажмите кнопку " **ОК**".

3. В области **подключения** разверните узел сервера и выберите **Пулы приложений**. В области **Пулы приложений** , если схема **DefaultAppPool** назначена .NET Framework версии 4, как показано на следующем рисунке, перейдите к следующему разделу.

   ![Inetmgr_showing_ 4.0 _app_pools](deploying-to-iis/_static/image5a.png)

4. Если вы видите только два пула приложений и оба имеют значение .NET Framework 2,0, установите ASP.NET 4 в службах IIS.

   Для Windows 8 или более поздней версии ознакомьтесь с инструкциями в предыдущем разделе, чтобы убедиться, что установлен ASP.NET 4,7, или Узнайте, [как установить ASP.NET 4,5 в Windows 8 и Windows Server 2012](https://support.microsoft.com/kb/2736284). В Windows 7 Откройте окно командной строки, щелкнув правой кнопкой мыши пункт **Командная строка** в меню **Пуск** Windows и выбрав команду **Запуск от имени администратора**. Запустите [файл\_ASPNET regiis. exe](https://msdn.microsoft.com/library/k6h9cz8h.aspx) для установки ASP.NET 4 в IIS с помощью следующих команд. (В 32-разрядных системах замените "Framework64" на "Framework".)

   [!code-console[Main](deploying-to-iis/samples/sample1.cmd)]

   Эта команда создает новые пулы приложений для .NET Framework 4, но пул приложений по умолчанию останется установленным в 2,0. Выполняется развертывание приложения, предназначенного для .NET 4, в пул приложений, поэтому измените пул приложений на .NET 4.

5. Если вы закрыли **Диспетчер IIS**, запустите его снова, разверните узел сервера и выберите **Пулы приложений**.

6. В области **Пулы приложений** выберите **DefaultAppPool**. На панели **действия** выберите **Основные параметры**.

   ![Inetmgr_selecting_Basic_Settings_for_app_pool](deploying-to-iis/_static/image25.png)

7. В диалоговом окне **Изменение пула приложений** измените **версию CLR .NET** на **.NET CLR v 4.0.30319**. Нажмите кнопку **ОК**.

   ![Selecting_.NET_4_for_DefaultAppPool](deploying-to-iis/_static/image6a.png)

Теперь все готово для публикации веб-приложения в службах IIS. Однако сначала создайте базы данных для тестирования.

<a id="sqlexpress"></a>

## <a name="install-sql-server-express"></a>Установка SQL Server Express

LocalDB не предназначен для работы в службах IIS, поэтому в тестовой среде должна быть установлена SQL Server Express. Если вы используете Visual Studio 2010 SQL Server Express, он уже установлен по умолчанию. Если вы используете Visual Studio 2012 или более поздней версии, установите SQL Server Express.

Чтобы установить SQL Server Express, скачайте и установите его из [центра загрузки: Microsoft SQL Server 2017 Express Edition](https://www.microsoft.com/sql-server/sql-server-editions-express). 

На первой странице центра установки SQL Server выберите **создать SQL Server изолированная установка или добавить компоненты к существующей установке** и следуйте инструкциям, принимающим параметры по умолчанию. В мастере установки примите параметры по умолчанию. Дополнительные сведения о параметрах установки см. в разделе [Install SQL Server (установка с помощью мастера установки)](https://msdn.microsoft.com/library/ms143219.aspx).

## <a name="create-sql-server-express-databases-for-the-test-environment"></a>Создание баз данных SQL Server Express для тестовой среды

Приложение университета Contoso имеет две базы данных: 

1. База данных членства 
2. База данных приложения 

Эти базы данных можно развернуть в двух отдельных базах данных или в одной базе данных. Объединение между ними упрощает объединение баз данных. 

Если вы развертываете поставщик услуг размещения стороннего производителя, план размещения может также дать вам причину их объединения. Например, поставщик может взимать дополнительную плату за несколько баз данных или даже не допускает более одной базы данных.

В этом руководстве вы развернетесь в двух базах данных в тестовой среде и в одной базе данных в промежуточной и рабочей средах.

В меню **вид** в Visual Studio выберите **Обозреватель сервера** (**Обозреватель базы данных** в Visual Web Developer). Щелкните правой кнопкой мыши элемент **подключения к данным** и выберите команду **создать новую базу данных SQL Server**.

![Selecting_Create_New_SQL_Server_Database](deploying-to-iis/_static/image8.png)

В диалоговом окне **Создание новой SQL Server базы данных** введите ".\SQLEXPRESS" в поле **имя сервера** и "ASPNET-ContosoUniversity" в поле **имя новой базы данных** . Нажмите кнопку **ОК**.

![Создание ASPNET-ContosoUniversity](deploying-to-iis/_static/image9.png)

Выполните ту же процедуру, чтобы создать новую базу данных SQL Server Express School `ContosoUniversity`с именем.

В **Обозреватель сервера** показаны две новые базы данных.

![Новые базы данных в обозреватель сервера](deploying-to-iis/_static/image10.png)

## <a name="create-a-grant-script-for-the-new-databases"></a>Создание скрипта предоставления для новых баз данных

Когда приложение запускается в службах IIS на компьютере разработчика, оно использует для доступа к базе данных учетные данные пула приложений по умолчанию. Однако по умолчанию пул приложений не имеет разрешения на открытие баз данных. Это означает, что для предоставления этого разрешения необходимо выполнить сценарий. В этом разделе вы создадите этот скрипт и запустите его позже, чтобы убедиться, что приложение может открывать базы данных при запуске в службах IIS.

В текстовом редакторе скопируйте следующие команды SQL в новый файл и сохраните его как *GRANT. SQL*. 

[!code-sql[Main](deploying-to-iis/samples/sample2.sql)]

В Visual Studio откройте решение университета Contoso. Щелкните правой кнопкой мыши решение (не один из проектов) и выберите **Добавить**. Выберите **существующий элемент**, перейдите к *GRANT. SQL*и откройте его.

> [!NOTE]
> Этот сценарий предназначен для работы с SQL Server Express 2012 или более поздней версии и с параметрами IIS в Windows 10, Windows 8 или Windows 7, как указано в этом руководстве. Если вы используете другую версию SQL Server или Windows или если службы IIS настроены по-разному, может потребоваться внести изменения в этот сценарий. Дополнительные сведения о скриптах SQL Server см. в разделе [Электронная документация на SQL Server](https://go.microsoft.com/fwlink/?LinkId=132511).

> [!NOTE] 
> **Примечание по безопасности** Этот сценарий предоставляет `db_owner` пользователю разрешения, обращающиеся к базе данных во время выполнения, что будет в рабочей среде. В некоторых сценариях может потребоваться указать пользователя с полными разрешениями на обновление схемы базы данных только для развертывания и указать для времени выполнения другого пользователя, имеющего разрешения только на чтение и запись данных. Дополнительные сведения см. в разделе [Просмотр автоматических изменений Web. config для Code First migrations](#reviewingmigrations) далее в этом руководстве.

<a id="publish"></a>

## <a name="run-the-grant-script-in-the-application-database"></a>Выполнение скрипта Grant в базе данных приложения

Вы можете настроить профиль публикации для запуска сценария предоставления в базе данных членства во время развертывания, так как это развертывание базы данных использует поставщик [дбдакфкс](https://docs.microsoft.com/iis/publish/using-web-deploy/dbdacfx-provider-for-incremental-database-publishing) . Нельзя запускать скрипты во время развертывания Code First Migrations, что заключается в развертывании базы данных приложения. Это означает, что необходимо вручную запустить скрипт перед развертыванием в базе данных приложения.

1. В Visual Studio откройте созданный ранее файл *GRANT. SQL* .

2. Выберите **подключить**. 

    ![Кнопка "подключиться"](deploying-to-iis/_static/image11.png)

3. В диалоговом окне **соединение с сервером** введите *.\SQLEXPRESS* в качестве **имени сервера**. Выберите **подключить**.

4. В раскрывающемся списке База данных выберите **ContosoUniversity**. Выберите **выполнить**. 

   ![](deploying-to-iis/_static/image12.png)

Удостоверение пула приложений по умолчанию теперь имеет достаточные разрешения в базе данных приложения для Code First Migrations создания таблиц базы данных при запуске приложения.

## <a name="publish-to-iis"></a>Публикация в службах IIS

Существует несколько способов развертывания служб IIS с помощью Visual Studio и веб-развертывание.

* Используйте команду "опубликовать" одним щелчком Visual Studio.
* Опубликуйте из командной строки.
* Создайте пакет развертывания и установите его с помощью диспетчера IIS. Пакет содержит ZIP-файл со всеми файлами и метаданными, необходимыми для установки сайта в службах IIS.
* Создайте пакет развертывания и установите его с помощью командной строки.

Процесс, который вы выполнили в предыдущих руководствах, чтобы настроить Visual Studio для автоматизации задач развертывания, применяется ко всем этим методам. В этих учебниках используются первые два метода. Сведения об использовании пакетов развертывания см. в разделе [Развертывание веб-приложения путем создания и установки пакета веб-развертывания](https://go.microsoft.com/fwlink/p/?LinkId=282413#package) в карте содержимого веб-развертывания для Visual Studio и ASP.NET.

Перед публикацией убедитесь, что вы используете Visual Studio в режиме администратора. Если вы не видите **(администратор)** в заголовке окна, закройте Visual Studio. На **начальной** странице Windows 8 (или более поздней версии) или в меню **Пуск** Windows 7 щелкните правой кнопкой мыши значок Visual Studio и выберите **Запуск от имени администратора**. Режим администратора требуется только для публикации при публикации в службах IIS на локальном компьютере.

### <a name="create-the-publish-profile"></a>Создание профиля публикации

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект **ContosoUniversity** (не проект **ContosoUniversity. DAL** ). Нажмите **Публиковать**. Откроется страница **Публикация** .

2. Выберите **создать профиль**. Откроется диалоговое окно **Выбор целевого объекта публикации** .

3. Выберите **IIS, FTP и т. д**. Выберите **Создать профиль**. Откроется мастер **публикации** .

   ![Вкладка профиля мастера публикации веб-сайта](deploying-to-iis/_static/image26.png)

4. В раскрывающемся меню **метод публикации** выберите **веб-развертывание**.

5. В качестве **сервера**введите *localhost*.

6. В качестве **имени сайта**введите *Default Web site/ContosoUniversity*.

7. В качестве **URL-адреса назначения**введите *http://localhost/ContosoUniversity* .

   Параметр **URL-адреса назначения** не является обязательным. Когда Visual Studio завершит развертывание приложения, автоматически откроется браузер по умолчанию с этим URL-адресом. Если вы не хотите, чтобы браузер открывался автоматически после развертывания, оставьте это поле пустым.

8. Выберите **проверить подключение** , чтобы убедиться, что параметры заданы правильно, и вы можете подключиться к службам IIS на локальном компьютере.

   Зеленая галочка проверяет, успешно ли установлено соединение.

   ![Вкладка подключения мастера публикации веб-сайта](deploying-to-iis/_static/image27.png)

9. Нажмите кнопку **Далее** , чтобы перейти на вкладку **Параметры** .

10. В раскрывающемся списке **Конфигурация** указывается развертываемая конфигурация сборки. Оставьте значение по умолчанию для параметра **выпуск**. В этом руководстве Развертывание отладочных сборок не выполняется.

11. Разверните **Параметры публикации файла**. Выберите **исключить файлы из папки данных\_приложения**.

    В тестовой среде приложение получает доступ к базам данных, созданным в локальном экземпляре SQL Server Express, а не MDF-файлы в папке *данных приложения\_* .

12. Снимите флажки **Предварительная компиляция во время публикации** и **удаления дополнительных файлов в месте назначения** .

    ![Параметры публикации файла на вкладке "Параметры"](deploying-to-iis/_static/image15a.png)

    Предварительная компиляция является вариантом, который полезен в основном для больших сайтов. Это позволяет сократить время запуска при первом запросе страницы после публикации сайта.

    Удалять дополнительные файлы не требуется, так как это первое развертывание, и пока в папке назначения не будет файлов.

    > [!NOTE] 
    > Если вы выбрали вариант **удалить дополнительные файлы в месте назначения** для последующего развертывания на том же сайте, убедитесь, что вы используете предварительную версию функции, чтобы увидеть, какие файлы будут удалены перед развертыванием. Ожидаемое поведение заключается в том, что веб-развертывание удалит файлы на целевом сервере, которые были удалены в проекте. Тем не менее, вся структура папок в исходной и конечной папках сравнивается. в некоторых сценариях веб-развертывание может удалять файлы, которые не нужно удалять.
    > 
    > Например, если веб-приложение находится во вложенной папке на сервере при развертывании проекта в корневой папке, то вложенная папка будет удалена. У вас может быть один проект для основного сайта в contoso.com и другой проект для блога по адресу contoso.com/blog. Приложение блога находится во вложенной папке. При выборе пункта **удалить дополнительные файлы в месте назначения** при развертывании основного сайта приложение блога будет удалено.
    > 
    > В другом примере папка данных приложения\_может неожиданно удалиться. Некоторые базы данных, такие как SQL Server Compact файлы базы данных хранилища\_, находятся в папке данных приложения. После первоначального развертывания не нужно копировать файлы базы данных при последующих развертываниях, поэтому на вкладке Пакет/Публикация веб-сайта следует выбрать **исключить данные приложения\_** . После этого вы сможете удалить файлы базы данных и саму папку данных приложения\_при следующей публикации, если они были удалены в выбранном **месте назначения** .

### <a name="configure-deployment-for-the-membership-database"></a>Настройка развертывания для базы данных членства

Следующие шаги применяются к базе данных **DefaultConnection** в разделе " **базы данных** " диалогового окна.

1. В поле **строка удаленного подключения** введите следующую строку подключения, которая указывает на новую базу данных членства SQL Server Express.

   [!code-console[Main](deploying-to-iis/samples/sample3.cmd)]

   Процесс развертывания помещает эту строку подключения в развернутый файл Web. config, так как выбран параметр **использовать эту строку подключения во время выполнения** .

    Также можно получить строку подключения из **Обозреватель сервера**. В **Обозреватель сервера**разверните **подключения к данным**  **&lt;&gt;** и выберите базу данных MachineName \склекспресс.АСПнет-контосауниверсити, а затем в окне **свойств** скопируйте **строку подключения.** значение. Эта строка подключения будет содержать один дополнительный параметр, который можно удалить: `Pooling=False`.

2. Выберите **обновить базу данных**.

   Это приводит к созданию схемы базы данных в целевой базе данных во время развертывания. На следующих шагах необходимо указать дополнительные скрипты, которые необходимо выполнить: один для предоставления доступа к базе данных в пул приложений по умолчанию и один для развертывания данных.

3. Выберите **настроить обновления базы данных**.
 
4. В диалоговом окне **Настройка обновлений базы данных** выберите **Добавить скрипт SQL**. Перейдите к скрипту *GRANT. SQL* , сохраненному ранее в папке решения.

5. Повторите эту процедуру, чтобы добавить скрипт *АСПнет-Дата-дев. SQL* .

   ![Настройка обновлений базы данных для базы данных членства](deploying-to-iis/_static/image16.png)

6. Нажмите кнопку **Закрыть**.

### <a name="configure-deployment-for-the-application-database"></a>Настройка развертывания для базы данных приложения

Когда Visual Studio обнаруживает класс Entity Framework `DbContext` , он создает запись в разделе **базы данных** с флажком **выполнить Code First migrations** вместо флажка **обновить базу данных** . В этом руководстве этот флажок используется для указания развертывания Code First Migrations.

В некоторых случаях может использоваться `DbContext` база данных, но для развертывания базы данных необходимо использовать поставщик дбдакфкс вместо миграции. В этом случае см. раздел [разделы справки развертывание базы данных Code First без миграции?](https://msdn.microsoft.com/library/ee942158.aspx#deploy_code_first_without_migrations) в разделе часто задаваемых вопросов по веб-развертыванию ASP.NET на сайте MSDN.

Следующие шаги применяются к базе данных **SchoolContext** в разделе " **базы данных** " диалогового окна.

1. В поле **строка удаленного подключения** введите следующую строку подключения, указывающую на новую базу данных приложения SQL Server Express.

   [!code-console[Main](deploying-to-iis/samples/sample4.cmd)]

   Процесс развертывания помещает эту строку подключения в развернутый файл Web. config, так как выбран параметр **использовать эту строку подключения во время выполнения** .

   Кроме того, строку подключения к базе данных приложения можно получить из **Обозреватель сервера** так же, как и строка подключения к базе данных членства.

2. Выберите **выполнить Code First migrations (выполняется при запуске приложения)** .

   Этот параметр приводит к тому, что процесс развертывания настраивает развернутый файл Web. `MigrateDatabaseToLatestVersion` config для указания инициализатора. Этот инициализатор автоматически обновляет базу данных до последней версии, когда приложение обращается к базе данных в первый раз после развертывания.

### <a name="configure-publish-profile-transforms"></a>Настройка преобразований профиля публикации

1. Нажмите кнопку **Закрыть**. При появлении запроса на сохранение изменений выберите **Да** .

2. В **Обозреватель решений**разверните узел **свойства**, разверните **PublishProfiles**.

3. Щелкните правой кнопкой мыши *кустомпрофиле. pubxml* и переименуйте его *Test. pubxml*.

4. Щелкните правой кнопкой мыши *Test. pubxml*. Выберите **добавить преобразование конфигурации**.

   ![Меню "добавить преобразование конфигурации"](deploying-to-iis/_static/image17.png)

   Visual Studio создаст файл преобразования *Web. Test. config* и откроет его.

5. В файле преобразования *Web. Test. config* вставьте следующий код сразу после открывающего тега конфигурации.

   [!code-xml[Main](deploying-to-iis/samples/sample5.xml)]

    При использовании профиля тестовой публикации это преобразование задает для индикатора среды значение "тест". На развернутом сайте вы увидите "(тест)" после заголовка "H1" университета Contoso ".

6. Сохраните и закройте файл.

7. Щелкните правой кнопкой мыши файл *Web. Test. config* и выберите пункт **предварительное преобразование** , чтобы убедиться, что преобразованное преобразование создает ожидаемые изменения.

    В окне **Предварительный просмотр Web. config** отображается результат применения преобразований *Web. Release. config* и преобразований *Web. Test. config* .

### <a name="preview-the-deployment-updates"></a>Предварительный просмотр обновлений развертывания

1. Снова откройте мастер **публикации веб-сайта** (щелкните правой кнопкой мыши проект ContosoUniversity, выберите **опубликовать**, а затем — **Предварительный просмотр**).

2. В диалоговом окне **Предварительный просмотр** нажмите кнопку **начать просмотр** , чтобы просмотреть список файлов, которые будут скопированы. 

   ![Предварительный просмотр публикации](deploying-to-iis/_static/image29.png)

   Можно также выбрать ссылку на **базу данных предварительного просмотра** , чтобы просмотреть скрипты, которые будут выполняться в базе данных членства. (Скрипты не запускаются для Code First Migrations развертывания, поэтому предварительная версия для базы данных приложения не требуется.)

3. Нажмите **Публиковать**.

   Если Visual Studio не находится в режиме администратора, может появиться сообщение об ошибке разрешений. В этом случае закройте Visual Studio, откройте его в режиме администратора и повторите попытку публикации.

   Если Visual Studio находится в режиме администратора, окно **вывода** сообщает об успешной сборке и публикации.

   ![Output_window_publish_Test](deploying-to-iis/_static/image20.png)

   Если вы указали URL-адрес в поле **URL-адрес назначения** на вкладке Публикация профиля **подключения** , браузер автоматически откроет домашнюю страницу университета Contoso, запущенную в службах IIS на компьютере.

## <a name="test-in-the-test-environment"></a>Тестирование в тестовой среде

Обратите внимание, что индикатор среды отображает "(Test)" вместо "(dev)", который показывает, что преобразование *Web. config* для индикатора среды прошло успешно.

Запустите страницу **инструкторы** , чтобы убедиться, что Code First заполнена базой данных с помощью данных преподавателя. При выборе этой страницы Загрузка может занять несколько минут, поскольку Code First создает базу данных, а затем запускает `Seed` метод. (Это не было сделано, когда вы находились на домашней странице, так как приложение еще не пытается получить доступ к базе данных.)

Перейдите на вкладку **учащиеся** , чтобы убедиться, что в развернутой базе данных нет учащихся.

В меню **учащихся** выберите **Добавить учащихся** . Добавьте учащийся, а затем просмотрите новый учащийся на странице **учащихся** . Это подтверждает, что можно успешно выполнить запись в базу данных.

В меню **курсы** выберите **Обновить кредиты**. На странице " **Обновление кредитов** " требуются разрешения администратора, поэтому отображается страница **входа** . Введите учетные данные администратора, созданные ранее ("admin" и "девпвд"). Отобразится страница **Обновление кредитов** . Это подтверждает, что учетная запись администратора, созданная в предыдущем руководстве, правильно развернута в тестовой среде.

Убедитесь, что папка *ELMAH* существует в папке *к:\инетпуб\ввврут\контосауниверсити* с файлом заполнителя.

<a id="reviewingmigrations"></a>

## <a name="review-the-automatic-webconfig-changes-for-code-first-migrations"></a>Изучите автоматические изменения Web. config для Code First Migrations

Откройте файл *Web. config* в развернутом приложении на сайте *к:\инетпуб\ввврут\контосауниверсити* , и вы увидите, где в процессе развертывания настроен Code First migrations для автоматического обновления базы данных до последней версии.

![](deploying-to-iis/_static/image21.png)

В процессе развертывания также создается новая строка подключения для Code First Migrations для использования исключительно для обновления схемы базы данных.

![Строка подключения Database_Publish](deploying-to-iis/_static/image22.png)

Эта дополнительная строка подключения позволяет указать одну учетную запись пользователя для обновлений схемы базы данных и другую учетную запись пользователя для доступа к данным приложения. Например, можно назначить роль **владельца базы данных\_** для Code First Migrations и **\_DB DataReader** с ролями **базы данных\_** в приложении. Это распространенный шаблон глубокой защиты, который предотвращает изменение схемы базы данных потенциально вредоносным кодом в приложении. (Например, это может произойти при успешной атаке путем внедрения кода SQL.) Эти учебники не используют этот шаблон. Чтобы реализовать этот шаблон в сценарии, выполните следующие действия.

1. В мастере **публикации веб-сайта** на вкладке **Параметры** введите строку подключения, указывающую пользователя с полными разрешениями на обновление схемы базы данных. Снимите флажок **использовать эту строку подключения во время выполнения** . В развернутом файле Web. config это `DatabasePublish` строка подключения.

2. Создайте преобразование файла Web. config для строки подключения, которую приложение должно использовать во время выполнения.

## <a name="summary"></a>Сводка

Теперь вы развернули приложение в службах IIS на компьютере разработчика и протестировали его там.

![Домашняя страница в тесте](deploying-to-iis/_static/image23.png)

Это подтверждает, что процесс развертывания скопировал содержимое приложения в нужное расположение (за исключением файлов, которые вы не хотите развертывать), а также веб-развертывание правильно настроить IIS во время развертывания. В следующем руководстве вы выполните еще один тест, который найдет задачу развертывания, которая еще не выполнена: Задание разрешений для папки в папке *Елм AH* .

## <a name="more-information"></a>Дополнительные сведения

Сведения о запуске IIS или IIS Express в Visual Studio см. в следующих ресурсах:

- [IIS Express обзор](https://www.iis.net/learn/extensions/introduction-to-iis-express/iis-express-overview) сайта IIS.NET.
- [Введение IIS Express](https://weblogs.asp.net/scottgu/archive/2010/06/28/introducing-iis-express.aspx) в блог Скотта Гатри (.
- [Веб-серверы в Visual Studio для веб-проектов ASP.NET](https://msdn.microsoft.com/library/58wxa9w5.aspx).
- [Основные различия между IIS и ASP.NET Development Server](../../older-versions-getting-started/deploying-web-site-projects/core-differences-between-iis-and-the-asp-net-development-server-cs.md) на сайте ASP.NET.

Сведения о проблемах, которые могут возникнуть при работе приложения со средним уровнем доверия, см. в разделе [размещение ASP.NET приложений в среднем доверии](http://www.4guysfromrolla.com/articles/100307-1.aspx) для четырех из ролла сайта.

> [!div class="step-by-step"]
> [Назад](project-properties.md)
> [Вперед](setting-folder-permissions.md)
