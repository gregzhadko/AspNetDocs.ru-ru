---
uid: web-forms/overview/deployment/visual-studio-web-deployment/preparing-databases
title: Веб-развертывание ASP.NET с помощью Visual Studio. Подготовка к развертыванию базы данных | Документация Майкрософт
author: tdykstra
description: В этой серии руководств показано, как развернуть ASP.NET (публикации) веб-приложения, веб-приложениях службы приложений Azure или у стороннего поставщика размещения, Пол...
ms.author: riande
ms.date: 02/15/2013
ms.assetid: ae4def81-fa37-4883-a13e-d9896cbf6c36
msc.legacyurl: /web-forms/overview/deployment/visual-studio-web-deployment/preparing-databases
msc.type: authoredcontent
ms.openlocfilehash: 67f44d9f23a2fe83c48e68328b1dee739056e32f
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57029781"
---
<a name="aspnet-web-deployment-using-visual-studio-preparing-for-database-deployment"></a>Веб-развертывание ASP.NET с помощью Visual Studio. Подготовка к развертыванию базы данных
====================
по [том Дайкстра](https://github.com/tdykstra)

[Загрузите начальный проект](http://go.microsoft.com/fwlink/p/?LinkId=282627)

> В этой серии руководств показано, как развернуть ASP.NET (публикации) веб-приложения для веб-приложениях службы приложений Azure или стороннего поставщика услуг размещения, с помощью Visual Studio 2012 или Visual Studio 2010. Сведения об этой серии см. в разделе [в первом учебнике серии](introduction.md).


## <a name="overview"></a>Обзор

Этот учебник показывает способ получения проект готов к развертыванию базы данных. Структуру базы данных и некоторые (но не все) данных в двух приложения баз данных должны быть развернуты для тестирования, промежуточной и рабочей среды.

Как правило при разработке приложения, введите тестовые данные в базу данных, не требуется для развертывания на действующем сайте. Тем не менее также возможно, некоторые данные рабочей среде, которые вы хотите развернуть. В этом руководстве вам настроить проект университета Contoso и подготовить скрипты SQL правильные данные, включенные при развертывании.

Напоминание. Если вы получаете сообщение об ошибке, или что-то не работает, как работать с руководством, обязательно проверьте [страница устранения неполадок](troubleshooting.md).

## <a name="sql-server-express-localdb"></a>SQL Server Express LocalDB

В примере приложения используется SQL Server Express LocalDB. SQL Server Express — это бесплатная версия SQL Server. Она часто используется во время разработки, так как он основан на одном ядре СУБД как полные версии SQL Server. Можно проверить с помощью SQL Server Express и быть уверенным, что приложение будет вести себя так же, в рабочей среде, за некоторыми исключениями для компонентов, которые отличаются в различных выпусках SQL Server.

LocalDB — это специального режима выполнения SQL Server Express, которая позволяет работать с базами данных как *.mdf* файлов. Как правило, хранятся файлы базы данных LocalDB в *приложения\_данных* папку веб-проекта. Функции пользовательского экземпляра в SQL Server Express также позволяет работать с *.mdf* файлы, но функции пользовательского экземпляра устарело; таким образом, рекомендуется использовать LocalDB для работы с *.mdf* файлов.

Обычно SQL Server Express не используется для рабочих веб-приложений. LocalDB в частности не рекомендуется для использования в рабочей среде с веб-приложение, так как он не предназначен для работы со службами IIS.

В Visual Studio 2012 LocalDB устанавливается по умолчанию с помощью Visual Studio. В Visual Studio 2010 и более ранних версиях SQL Server Express (без LocalDB) устанавливается по умолчанию с помощью Visual Studio; то есть почему оно было установлено как один из необходимых компонентов в [в первом учебнике этой серии](introduction.md).

Дополнительные сведения о выпусках SQL Server, включая LocalDB, см. следующие ресурсы [работы с базами данных SQL Server](../../../../whitepapers/aspnet-data-access-content-map.md#sqlserver).

## <a name="entity-framework-and-universal-providers"></a>Entity Framework и универсальные поставщики

Для доступа к базе данных приложения университета Contoso требуется следующее программное обеспечение, которые должны быть развернуты вместе с приложением, так как он не включен в .NET Framework:

- [Универсальные поставщики ASP.NET](http://www.hanselman.com/blog/IntroducingSystemWebProvidersASPNETUniversalProvidersForSessionMembershipRolesAndUserProfileOnSQLCompactAndSQLAzure.aspx) (позволяет система членства ASP.NET для использования базы данных SQL Azure)
- [Entity Framework](https://msdn.microsoft.com/library/gg696172.aspx)

Так как это программное обеспечение включается в пакетах NuGet, проект уже настроен таким образом, чтобы нужные сборки развертываются с проектом. (Ссылки указывают на текущие версии этих пакетов, которые могут быть более новой версии установленных в начальный проект, загруженный в этом руководстве).

Если вы развертываете стороннего поставщика услуг размещения вместо Azure, убедитесь в том, использовать Entity Framework 5.0 или более поздней версии. Более ранних версиях Code First Migrations необходим полный уровень доверия, и большинство поставщиков услуг размещения будет выполняться приложение в со средним уровнем доверия. Дополнительные сведения о со средним уровнем доверия, см. в разделе [развертывание в IIS в качестве среды тестирования](deploying-to-iis.md) руководства.

## <a name="configure-code-first-migrations-for-application-database-deployment"></a>Настроить Code First Migrations для развертывания базы данных приложения

База данных приложения университета Contoso управляется Code First, и вы сможете развернуть с помощью Code First Migrations. Обзор развертывания базы данных с помощью Code First Migrations, см. в разделе [в первом учебнике этой серии](introduction.md).

При развертывании базы данных приложения, обычно не развертывается просто базы данных разработки со всеми данными в рабочей среде, так как значительная часть данных в нем есть возможно только для целей тестирования. Например учащихся в тестовую базу данных, называются вымышленной. С другой стороны часто невозможно развернуть только структуру базы данных с данными, в его вообще. Некоторые данные в тестовой базе данных может быть реальными данными и должен присутствовать при пользователи начнут использовать приложения. Например базы данных возможно, таблица, содержащая допустимые корпоративного класса значения или названия отделов реальных.

Чтобы смоделировать этот сценарий, нужно настроить Code First Migrations `Seed` метод, который вставляет в базе данных только данные, которые вы хотите отставать в рабочей среде. Это `Seed` метод не следует вставлять тестовые данные, так как она будет запущена в рабочей среде после Code First создает базу данных в рабочей среде.

В более ранних версиях Code First до миграции выпуска, было обычным `Seed` методы для вставки данных теста также, так как при каждом изменении модели во время разработки базы данных должны были быть полностью удаляется и создается заново с нуля. С помощью Code First Migrations, тест, данные сохраняются после изменения базы данных, таким образом включая тестовых данных в `Seed` метода нет необходимости. Проект, который вы скачали использует метод, в том числе все данные в `Seed` метод инициализатор класса. В этом учебнике будет отключено инициализатор класса и `enable Migrations. Then you'll update the `начальное значение "метода в конфигурации миграции класса таким образом, чтобы он вставляет только данных, который требуется вставить в рабочей среде.

На следующей схеме показана схема базы данных приложения:

[![School_database_diagram](preparing-databases/_static/image2.png)](preparing-databases/_static/image1.png)

Для этих учебников будет предполагается, что `Student` и `Enrollment` таблицы должно быть пустым, при первом развертывании сайта. Другие таблицы содержат данные, должно быть предварительно загружено при активации приложения.

### <a name="disable-the-initializer"></a>Отключить инициализатор

Так как вы будете использовать Code First Migrations, нет необходимости использовать `DropCreateDatabaseIfModelChanges` Code First инициализатор. Код для этого инициализатора находится в *SchoolInitializer.cs* файл в проекте ContosoUniversity.DAL. Параметр в `appSettings` элемент *Web.config* файл вызывает этот инициализатор для выполнения всякий раз, когда приложение пытается получить доступ к базе данных в первый раз:

[!code-xml[Main](preparing-databases/samples/sample1.xml?highlight=3)]

Откройте приложение *Web.config* файл и удалите или закомментируйте `add` элемент, который задает класс инициализатора Code First. `appSettings` Элемента теперь выглядит следующим образом:

[!code-xml[Main](preparing-databases/samples/sample2.xml)]

> [!NOTE]
> Еще один способ указать класс инициализатора является выполняется путем вызова `Database.SetInitializer` в `Application_Start` метод в *Global.asax* файл. При включении миграции в проекте, который использует этот метод для указания инициализатор, удалите эту строку кода.

> [!NOTE]
> Если вы используете Visual Studio 2013, сделайте следующее: между шаги 2 и 3: (a) в PMC введите «entityframework update-package-версии 6.1.1» для получения текущей версии EF. Затем (b) создайте проект для получения списка ошибок сборки и исправлять их. Удалите операторы using для пространства имен, которые больше не существует, щелкните правой кнопкой мыши и выберите разрешение, чтобы добавить с помощью инструкций, где они требуются и измените вхождения System.Data.EntityState System.Data.Entity.EntityState.

### <a name="enable-code-first-migrations"></a>Включение Code First Migrations

1. Убедитесь, что проект ContosoUniversity (не ContosoUniversity.DAL) задан в качестве запускаемого проекта. В **обозревателе решений**, щелкните правой кнопкой мыши проект ContosoUniversity и выберите **Назначить запускаемым проектом**. Code First Migrations будет выглядеть в Автозагружаемый проект, чтобы найти строку подключения к базе данных.
2. Из **средства** меню, выберите **диспетчер пакетов NuGet** > **консоль диспетчера пакетов**.

    ![Selecting_Package_Manager_Console](preparing-databases/_static/image3.png)
3. В верхней части **консоль диспетчера пакетов** окне выберите в качестве проекта по умолчанию, а затем at ContosoUniversity.DAL `PM>` командной строке введите «enable-migrations».

    ![команды Enable-migrations](preparing-databases/_static/image4.png)

    (Если появится ошибка *enable-migrations* команда не опознана, введите команду *EntityFramework update-package-переустановить* и повторите попытку.)

    Эта команда создает *миграций* папки в проекте ContosoUniversity.DAL и он помещает в нее два файла: *Configuration.cs* файл, который можно использовать для настройки миграции, а также *InitialCreate.cs* файл для первой миграции, который создает базу данных.

    ![Папку migrations](preparing-databases/_static/image5.png)

    Вы выбрали проект DAL в **проект по умолчанию** стрелку раскрывающегося списка **консоль диспетчера пакетов** поскольку `enable-migrations` команда должна выполняться в проект, содержащий Code First класс контекста. Когда этот класс находится в проекте библиотеки классов, Code First Migrations ищет строку подключения базы данных в Автозагружаемый проект для решения. В решении "ContosoUniversity" веб-проекта задано как автозагружаемый проект. Если вы не хотите назначить этот проект, который содержит строку подключения в качестве запускаемого проекта в Visual Studio, запускаемого проекта можно указать в команде PowerShell. Чтобы просмотреть синтаксис команды, введите команду `get-help enable-migrations`.

    `enable-migrations` Команда автоматически создал первой миграции, так как база данных уже существует. Альтернативой является миграций создать базу данных. Чтобы сделать это, используйте **обозревателя серверов** или **обозреватель объектов SQL Server** удалить базу данных ContosoUniversity, прежде чем включать миграций. После включения миграции, создайте первую миграцию вручную с помощью команды «add-migration это InitialCreate». Затем можно создать базу данных, введя команду «update-database».

### <a name="set-up-the-seed-method"></a>Настройка метода заполнения

В этом руководстве вы добавите основных данных, добавив код `Seed` метод Code First Migrations `Configuration` класса. Code First Migrations вызовы `Seed` метод после каждой миграции.

Так как `Seed` метод запускается после каждой миграции, уже существует данных в таблицах после первой миграции. Чтобы решить эту проблему, вы будете использовать `AddOrUpdate` метода, чтобы обновить строки, которые уже были вставлены или вставить их, если они еще не существует. `AddOrUpdate` Метод может оказаться лучшим выбором для вашего сценария. Дополнительные сведения см. в разделе [Будьте внимательны с помощью метода AddOrUpdate 4.3 EF](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) блога Джули Лерман.

1. Откройте *Configuration.cs* файл и замените комментарии в `Seed` метод следующим кодом:

    [!code-csharp[Main](preparing-databases/samples/sample3.cs)]
2. Ссылки на `List` имеют красной волнистой линией под их, так как у вас нет `using` еще оператор для пространства имен. Щелкните правой кнопкой мыши один из экземпляров `List` и нажмите кнопку **устранить**, а затем нажмите кнопку **using System.Collections.Generic**.

    ![Разрешить с помощью инструкции](preparing-databases/_static/image6.png)

    Следующий код добавляет этот выбор меню `using` инструкций в верхней части файла.

    [!code-csharp[Main](preparing-databases/samples/sample4.cs)]
3. Нажмите клавиши CTRL + SHIFT + B для сборки проекта.

Теперь проект готов для развертывания *ContosoUniversity* базы данных. После развертывания приложения, во время первого запуска его и перейти на страницу, которая обращается к базе данных, Code First создает базы данных и запустим `Seed` метод.

> [!NOTE]
> Добавление кода для `Seed` метод является одним из многих способов, которые можно вставлять основных данных в базу данных. Альтернативным вариантом является добавление кода для `Up` и `Down` методы каждого класса миграции. `Up` И `Down` методы содержат код, который реализует изменения в базе данных. Вы увидите примеры из них в [развертывание обновления базы данных](deploying-a-database-update.md) руководства.
> 
> Можно также написать код, который выполняет инструкции SQL с помощью `Sql` метод. Например, если имеется Добавление столбца бюджета таблица Department определена и необходимо инициализировать все бюджеты отделов для 1 000,00 долл. США в ходе переноса, удалось добавить соответствовать строки кода для `Up` метод миграции:
> 
> `Sql("UPDATE Department SET Budget = 1000");`


## <a name="create-scripts-for-membership-database-deployment"></a>Создание сценариев для развертывания базы данных членства

Приложение университета Contoso использует проверки подлинности системы и форм членства ASP.NET для проверки подлинности и авторизации пользователей. **Обновления кредиты** страница доступна только для пользователей, которым назначена роль администратора.

Запустите приложение и нажмите кнопку **курсы**, а затем нажмите кнопку **обновления кредиты**.

![Нажмите кнопку обновления кредиты](preparing-databases/_static/image7.png)

**Вход** откроется страница, так как **обновления кредиты** страницы требуются права администратора.

Введите *администратора* имени пользователя и *devpwd* пароль и нажмите кнопку **вход**.

![Страница входа](preparing-databases/_static/image8.png)

**Обновления кредиты** появится страница.

![Обновление страницы деньги на счете](preparing-databases/_static/image9.png)

Сведения о пользователях и роли находится в *aspnet ContosoUniversity* базы данных, который задается параметром **DefaultConnection** строку подключения в *Web.config* файл.

Эта база данных не управляется Entity Framework Code First, поэтому ее невозможно использовать миграции для его развертывания. Вы будете использовать поставщик dbDacFx для развертывания схемы базы данных, и вы настроите профиль публикации, чтобы запустить скрипт, который будет вставлять начальные данные в таблицы базы данных.

> [!NOTE]
> С помощью Visual Studio 2013 появилась новая система членства ASP.NET (теперь называется ASP.NET Identity). Новая система позволяет поддерживать приложения и таблицы членства в той же базе данных, и можно использовать Code First Migrations для развертывания обеих. Пример приложения использует более ранних система членства ASP.NET, который не может быть развернут с помощью Code First Migrations. Процедуры развертывания этой базы данных членства также применяются к любому сценарию, в котором в приложении необходимо развернуть базу данных SQL Server, не созданный с помощью Entity Framework Code First.


Здесь слишком, обычно требуется те же данные в рабочей среде, у вас в разработке. При развертывании узла в первый раз, довольно часто, чтобы исключить большинство или все учетные записи пользователей, созданные для тестирования. Таким образом, загруженного проекта имеет две базы данных членства: *aspnet ContosoUniversity.mdf* с пользователями разработки и *aspnet-ContosoUniversity-Prod.mdf* с пользователями в рабочей среде. В этом руководстве имена пользователей совпадают в обеих базах данных: *администратора* и *nonadmin*. У обоих пользователей есть пароль *devpwd* в базе данных разработки и *prodpwd* рабочей базы данных.

Используется для развертывания пользователи разработки в тестовой среде и конечных пользователей в промежуточной и рабочей среде. Для этого вы создадите два скрипта SQL в этом руководстве, для разработки и для рабочей среды, и в последующих руководствах вы настроите процесс публикации для их выполнения.

> [!NOTE]
> Базы данных членства сохраняет хэш паролей учетных записей. Чтобы выполнить развертывание учетных записей с одного компьютера на другой, необходимо убедиться в том, что процедуры хэширования не создавать разных хэшей на конечном сервере, чем на исходном компьютере. Они будут создают хэшам же при использовании универсальные поставщики ASP.NET, до тех пор, пока вы не меняли алгоритм по умолчанию. По умолчанию алгоритм HMACSHA256 и сохраняется в **проверки** атрибут **[machineKey](https://msdn.microsoft.com/library/system.web.configuration.machinekeysection.aspx)** в файле Web.config.


Скрипты развертывания данных можно создать вручную, с помощью SQL Server Management Studio (SSMS) или с помощью стороннего средства. Далее в этом руководстве показано, как сделать это в среде SSMS, но если вы не хотите установить и использовать SSMS можно получить скрипты из готовую версию проекта и перейдите к разделу, где они хранятся в папке решения.

Чтобы установить SSMS, установите его из [центра загрузки: Microsoft SQL Server 2012 Express](https://www.microsoft.com/download/details.aspx?id=29062) , щелкнув [ENU\x64\SQLManagementStudio\_x64\_ENU.exe](https://download.microsoft.com/download/8/D/D/8DD7BDBA-CEF7-4D8E-8C16-D9F69527F909/ENU/x64/SQLManagementStudio_x64_ENU.exe) или [ENU\x86\SQLManagementStudio\_x86\_ENU.exe](https://download.microsoft.com/download/8/D/D/8DD7BDBA-CEF7-4D8E-8C16-D9F69527F909/ENU/x86/SQLManagementStudio_x86_ENU.exe). При выборе другой для вашей системы его не удается установить, и вы можете попробовать другой.

(Обратите внимание, что для загрузки размером 600 мегабайт. Может занять длительное время установки и требуют перезагрузки компьютера.)

На первой странице Центр установки SQL Server, нажмите кнопку **автономная установка нового SQL Server или добавление компонентов к существующей установке**и следуйте инструкциям, принимая параметры по умолчанию.

### <a name="create-the-development-database-script"></a>Создание скрипта базы данных разработки

1. Запустите SSMS.
2. В **соединение с сервером** диалогового окна введите *(localdb) \v11.0* как **имя_сервера**, оставьте **проверки подлинности** присвоено **Проверки подлинности Windows**, а затем нажмите кнопку **Connect**.

    ![Подключение SSMS к серверу](preparing-databases/_static/image10.png)
3. В **обозревателя объектов** окне разверните **баз данных**, щелкните правой кнопкой мыши **aspnet ContosoUniversity**, нажмите кнопку **задачи**и нажмите кнопку **Создание скриптов**.

    ![SSMS Создание скриптов](preparing-databases/_static/image11.png)
4. В **формирования и публикации скриптов** диалоговом окне щелкните **задание параметров скрипта**.

    Вы можете пропустить **Выбор объектов** шаг, так как по умолчанию **внести в скрипт всю базу данных и все объекты базы данных** именно то, что нужно.
5. Нажмите кнопку **Дополнительно**.

    ![Параметры скриптов SSMS](preparing-databases/_static/image12.png)
6. В **Дополнительные параметры создания скриптов** диалоговое окно, прокрутите страницу вниз до **типы данных для скрипта**и нажмите кнопку **только данные** параметр в раскрывающемся списке.
7. Изменение **скрипт USE DATABASE** для **False**. ИСПОЛЬЗОВАТЬ инструкции являются недопустимыми для базы данных SQL Azure и не требуются для развертывания в SQL Server Express в тестовой среде.

    ![SSMS скрипт только данные, инструкция USE](preparing-databases/_static/image13.png)
8. Нажмите кнопку **ОК**.
9. В **формирования и публикации скриптов** диалоговом окне **имя файла** поле указывает, где будут создаваться скрипт. Измените путь к папке решения (в папку, где файл ContosoUniversity.sln) и имя файла для *aspnet-data-dev.sql*.
10. Нажмите кнопку **Далее** к **Сводка** , а затем щелкните **Далее** еще раз, чтобы создать скрипт.

    ![SSMS сценарий, созданный](preparing-databases/_static/image14.png)
11. Нажмите кнопку **Готово**.

### <a name="create-the-production-database-script"></a>Создайте скрипт рабочей базы данных

Так как проект еще не выполняются рабочей базы данных, она не еще привязывается к экземпляру LocalDB. Таким образом, вам нужно сначала присоединить базу данных.

1. В SSMS **обозревателя объектов**, щелкните правой кнопкой мыши **баз данных** и нажмите кнопку **Attach**.

    ![Подключение SSMS](preparing-databases/_static/image15.png)
2. В **присоединение баз данных** диалоговом окне щелкните **добавить** и перейдите к *aspnet-ContosoUniversity-Prod.mdf* файл *приложения\_ Данные* папки.

     ![Добавление SSMS MDF-файла для присоединения](preparing-databases/_static/image16.png)
3. Нажмите кнопку **ОК**.
4. Выполните ту же процедуру, которую вы ранее использовали для создания сценария для файла рабочей среде. Имя файла скрипта *aspnet-data-prod.sql*.

## <a name="summary"></a>Сводка

Обе базы данных теперь готово к развертыванию и у вас есть два сценария развертывания данных в папке решения.

![Скрипты развертывания данных](preparing-databases/_static/image17.png)

В следующем руководстве параметры проекта, влияющие на развертывание и настройка автоматического *Web.config* преобразования файла для параметров, которые должны быть разными в развернутом приложении.

## <a name="more-information"></a>Дополнительные сведения

Дополнительные сведения о NuGet см. в разделе [Управление библиотеками проектов с помощью NuGet](https://msdn.microsoft.com/magazine/hh547106.aspx) и [документации по NuGet](http://docs.nuget.org/docs/start-here/overview). Если вы не хотите использовать NuGet, вам потребуется научиться анализировать пакет NuGet, чтобы определить, какие действия происходят при установке. (Например, он может настроить *Web.config* преобразования, настроить сценарии PowerShell для выполнения во время сборки и т. д.) Дополнительные сведения о том, как NuGet работает, см. в разделе [создания и публикации пакета](http://docs.nuget.org/docs/creating-packages/creating-and-publishing-a-package) и [файл конфигурации и преобразования исходного кода](http://docs.nuget.org/docs/creating-packages/configuration-file-and-source-code-transformations).

> [!div class="step-by-step"]
> [Назад](introduction.md)
> [Вперед](web-config-transformations.md)
