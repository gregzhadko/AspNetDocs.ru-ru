---
uid: web-forms/overview/deployment/visual-studio-web-deployment/preparing-databases
title: 'Веб-развертывание ASP.NET с помощью Visual Studio: подготовка к развертыванию базы данных | Документация Майкрософт'
author: tdykstra
description: В этой серии руководств показано, как развернуть (опубликовать) веб-приложение ASP.NET в веб-приложениях службы приложений Azure или поставщике услуг размещения стороннего поставщика, Усин...
ms.author: riande
ms.date: 02/15/2013
ms.assetid: ae4def81-fa37-4883-a13e-d9896cbf6c36
msc.legacyurl: /web-forms/overview/deployment/visual-studio-web-deployment/preparing-databases
msc.type: authoredcontent
ms.openlocfilehash: cdcb3578725c41e3c801afd54e6d34455bc4b281
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78517284"
---
# <a name="aspnet-web-deployment-using-visual-studio-preparing-for-database-deployment"></a>Веб-развертывание ASP.NET с помощью Visual Studio: подготовка к развертыванию базы данных

от [Tom Dykstra)](https://github.com/tdykstra)

[Скачать начальный проект](https://go.microsoft.com/fwlink/p/?LinkId=282627)

> В этой серии руководств показано, как развернуть (опубликовать) веб-приложение ASP.NET в веб-приложениях службы приложений Azure или поставщике услуг размещения стороннего поставщика с помощью Visual Studio 2012 или Visual Studio 2010. Сведения о ряде см. в [первом руководстве по ряду](introduction.md).

## <a name="overview"></a>Обзор

В этом руководстве показано, как подготовить проект к развертыванию базы данных. Структура базы данных и некоторые (не все) данные в двух базах данных приложения должны быть развернуты в тестовой, промежуточной и рабочей средах.

Как правило, при разработке приложения необходимо ввести тестовые данные в базу данных, которую не нужно развертывать на активном сайте. Однако у вас также могут быть некоторые рабочие данные, которые необходимо развернуть. В этом учебнике вы настроите проект университета Contoso и подготовите скрипты SQL, чтобы при развертывании были добавлены правильные данные.

Напоминание. Если вы получаете сообщение об ошибке или что-то не работает при работе с этим руководством, обязательно ознакомьтесь со [страницей устранения неполадок](troubleshooting.md).

## <a name="sql-server-express-localdb"></a>SQL Server Express LocalDB

В примере приложения используется SQL Server Express LocalDB. SQL Server Express — это бесплатный выпуск SQL Server. Он обычно используется во время разработки, поскольку он основан на том же ядре СУБД, что и полные версии SQL Server. Можно протестировать SQL Server Express и быть уверенным в том, что приложение будет вести себя одинаково в рабочей среде с несколькими исключениями для функций, которые отличаются в разных выпусках SQL Server.

LocalDB — это специальный режим выполнения SQL Server Express, который позволяет работать с базами данных в виде *MDF* -файлов. Как правило, файлы базы данных LocalDB хранятся в папке *приложения\_данных* веб-проекта. Функция пользовательского экземпляра в SQL Server Express также позволяет работать с *MDF* -файлами, но функция пользовательского экземпляра является устаревшей. Поэтому для работы с *MDF* -файлами рекомендуется использовать LocalDB.

Обычно SQL Server Express не используется для рабочих веб-приложений. LocalDB в частности не рекомендуется для использования в рабочей среде с веб-приложением, поскольку оно не предназначено для работы с IIS.

В Visual Studio 2012 LocalDB устанавливается по умолчанию в Visual Studio. В Visual Studio 2010 и более ранних версиях SQL Server Express (без LocalDB) устанавливается по умолчанию в Visual Studio. Именно поэтому вы установили его как одно из предварительных требований в [первом учебнике этой серии](introduction.md).

Дополнительные сведения о SQL Server выпусках, включая LocalDB, см. в следующих ресурсах, [работающих с базами данных SQL Server](../../../../whitepapers/aspnet-data-access-content-map.md#sqlserver).

## <a name="entity-framework-and-universal-providers"></a>Entity Framework и универсальные поставщики

Для доступа к базе данных программе университета Contoso требуется следующее программное обеспечение, которое должно быть развернуто вместе с приложением, поскольку оно не включено в .NET Framework:

- [Универсальные поставщики ASP.NET](http://www.hanselman.com/blog/IntroducingSystemWebProvidersASPNETUniversalProvidersForSessionMembershipRolesAndUserProfileOnSQLCompactAndSQLAzure.aspx) (позволяет системе членства в ASP.NET использовать базу данных SQL Azure)
- [Entity Framework](https://msdn.microsoft.com/library/gg696172.aspx)

Так как это программное обеспечение включено в пакеты NuGet, проект уже настроен таким образом, что необходимые сборки развертываются вместе с проектом. (Ссылки указывают на текущие версии этих пакетов, которые могут быть более новыми, чем установленные в начальном проекте, скачанном для этого руководства.)

Если вы развертываете поставщик услуг размещения стороннего поставщика вместо Azure, убедитесь, что вы используете Entity Framework 5,0 или более поздней версии. В более ранних версиях Code First Migrations требуется полное доверие, и большинство поставщиков услуг размещения запустит приложение со средним уровнем доверия. Дополнительные сведения о среднем уровне доверия см. в учебнике [развертывание в IIS в качестве тестовой среды](deploying-to-iis.md) .

## <a name="configure-code-first-migrations-for-application-database-deployment"></a>Настройка Code First Migrations для развертывания базы данных приложения

База данных приложения университета Contoso управляется Code First, и вы развертываете ее с помощью Code First Migrations. Общие сведения о развертывании базы данных с помощью Code First Migrations см. в [первом учебнике этой серии](introduction.md).

При развертывании базы данных приложений обычно не требуется развертывать базу данных разработки со всеми данными в рабочей среде, так как большая часть данных в ней, вероятно, существует только в целях тестирования. Например, имена учащихся в тестовой базе данных являются вымышленными. С другой стороны, часто нельзя развертывать только структуру базы данных без каких бы то ни было данных. Некоторые данные в тестовой базе данных могут быть реальными и должны быть там, когда пользователи начинают использовать приложение. Например, база данных может иметь таблицу, содержащую допустимые значения категории или имена реальных отделов.

Для имитации этого распространенного сценария вы настроите метод Code First Migrations `Seed`, который вставляет в базу данных только те данные, которые должны находиться в рабочей среде. Этот метод `Seed` не должен вставлять тестовые данные, так как он будет выполняться в рабочей среде после того, как Code First создаст базу данных в рабочей среде.

В более ранних версиях Code First до выпуска миграций было распространено `Seed` методов вставки тестовых данных, так как при каждом изменении модели во время разработки база данных была полностью удалена и создана заново с нуля. При использовании Code First Migrations тестовые данные сохранены после внесения изменений в базу данных, поэтому не требуется включать тестовые данные в метод `Seed`. Скачанный проект использует метод, включающий все данные в методе `Seed` класса инициализатора. В этом учебнике вы отключите этот класс инициализатора и включите миграцию. Затем вы обновите метод `Seed` в классе конфигурации миграции, чтобы вставить только те данные, которые необходимо вставить в рабочую среду.

На следующей схеме показана схема базы данных приложения.

[![School_database_diagram](preparing-databases/_static/image2.png)](preparing-databases/_static/image1.png)

В этих учебниках предполагается, что `Student` и `Enrollment` таблицы должны быть пустыми при первом развертывании сайта. Другие таблицы содержат данные, которые должны быть предварительно загружены, когда приложение становится активным.

### <a name="disable-the-initializer"></a>Отключение инициализатора

Так как вы будете использовать Code First Migrations, нет необходимости использовать инициализатор Code First `DropCreateDatabaseIfModelChanges`. Код для этого инициализатора находится в файле *SchoolInitializer.CS* в проекте CONTOSOUNIVERSITY. DAL. Параметр в элементе `appSettings` файла *Web. config* вызывает запуск этого инициализатора всякий раз, когда приложение пытается получить доступ к базе данных в первый раз:

[!code-xml[Main](preparing-databases/samples/sample1.xml?highlight=3)]

Откройте файл *Web. config* приложения и удалите или закомментируйте элемент `add`, указывающий класс инициализатора Code First. Элемент `appSettings` теперь выглядит следующим образом:

[!code-xml[Main](preparing-databases/samples/sample2.xml)]

> [!NOTE]
> Другой способ указания класса инициализатора — это сделать, вызвав `Database.SetInitializer` в методе `Application_Start` в файле *Global. asax* . Если вы включаете миграцию в проекте, который использует этот метод для указания инициализатора, удалите эту строку кода.

> [!NOTE]
> Если вы используете Visual Studio 2013, добавьте следующие шаги между шагами 2 и 3: (a) в PMC введите "Update-package entityframework-Version 6.1.1", чтобы получить текущую версию EF. Затем (б) выполните сборку проекта, чтобы получить список ошибок сборки и исправить их. Удалите операторы using для пространств имен, которые больше не существуют, щелкните правой кнопкой мыши и выберите команду "разрешить", чтобы добавить операторы using там, где они необходимы, и измените вхождения System. Data. EntityState на System. Data. Entity. EntityState.

### <a name="enable-code-first-migrations"></a>Включить Code First Migrations

1. Убедитесь, что проект ContosoUniversity (не ContosoUniversity. DAL) задан в качестве запускаемого проекта. В **Обозреватель решений**щелкните правой кнопкой мыши проект ContosoUniversity и выберите **Назначить запускаемым проектом**. Code First Migrations будет искать в проекте запуска, чтобы найти строку подключения к базе данных.
2. В меню **Сервис** выберите **диспетчер пакетов NuGet** > **консоль диспетчера пакетов**.

    ![Selecting_Package_Manager_Console](preparing-databases/_static/image3.png)
3. В верхней части окна **консоли диспетчера пакетов** выберите CONTOSOUNIVERSITY. DAL в качестве проекта по умолчанию, а затем в `PM>` строке введите "Enable-migrations".

    ![Команда "включить-миграция"](preparing-databases/_static/image4.png)

    (Если вы получаете сообщение об ошибке, сообщающее о том, что команда " *включить миграцию* " не распознана, введите команду *Update-package entityframework-REINSTALL* и повторите попытку.)

    Эта команда создает папку *migrations* в проекте CONTOSOUNIVERSITY. DAL и помещает в нее два файла: файл *Configuration.CS* , который можно использовать для настройки миграций, и файл *InitialCreate.CS* для первой миграции, которая создает базу данных.

    ![Папка "миграции"](preparing-databases/_static/image5.png)

    Вы выбрали проект DAL в раскрывающемся списке **проект по умолчанию** **консоли диспетчера пакетов** , так как команда `enable-migrations` должна выполняться в проекте, содержащем класс контекста Code First. Если этот класс находится в проекте библиотеки классов, Code First Migrations ищет строку подключения к базе данных в запускаемом проекте для решения. В решении ContosoUniversity веб-проект был задан как запускаемый проект. Если вы не хотите назначать проект со строкой подключения в качестве запускаемого проекта в Visual Studio, можно указать запускаемый проект в команде PowerShell. Чтобы увидеть синтаксис команды, введите команду `get-help enable-migrations`.

    Команда `enable-migrations` автоматически создала первую миграцию, так как база данных уже существует. Альтернативой является создание миграции базы данных. Для этого используйте **Обозреватель сервера** или **Обозреватель объектов SQL Server** , чтобы удалить базу данных ContosoUniversity перед включением миграции. После включения миграции вручную создайте первую миграцию, введя команду "Add-Migration InitialCreate". Затем можно создать базу данных, введя команду Update-Database.

### <a name="set-up-the-seed-method"></a>Настройка метода начального значения

В этом учебнике мы добавим фиксированные данные, добавив код в метод `Seed` класса `Configuration` Code First Migrations. Code First Migrations вызывает метод `Seed` после каждой миграции.

Поскольку метод `Seed` выполняется после каждой миграции, в таблицах после первой миграции уже есть данные. Чтобы справиться с этой ситуацией, используйте метод `AddOrUpdate` для обновления уже вставленных строк или вставьте их, если они еще не существуют. Метод `AddOrUpdate` может быть не лучшим выбором для вашего сценария. Дополнительные сведения см. в разделе о [методе EF 4,3 AddOrUpdate](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) в блоге Юлия Лерман.

1. Откройте файл *Configuration.CS* и замените комментарии в методе `Seed` следующим кодом:

    [!code-csharp[Main](preparing-databases/samples/sample3.cs)]
2. Ссылки на `List` имеют красные волнистые линии, так как у вас еще нет оператора `using` для ее пространства имен. Щелкните правой кнопкой мыши один из экземпляров `List` и выберите пункт **Разрешить**, а затем щелкните **использование System. Collections. Generic**.

    ![Разрешение с помощью инструкции using](preparing-databases/_static/image6.png)

    Этот фрагмент меню добавляет следующий код к операторам `using` в верхней части файла.

    [!code-csharp[Main](preparing-databases/samples/sample4.cs)]
3. Нажмите клавиши CTRL + SHIFT + B, чтобы выполнить сборку проекта.

Теперь проект готов к развертыванию базы данных *ContosoUniversity* . После развертывания приложения при первом запуске и переходе к странице, которая обращается к базе данных, Code First создаст базу данных и выполнит этот метод `Seed`.

> [!NOTE]
> Добавление кода в метод `Seed` является одним из множества способов вставки фиксированных данных в базу данных. Альтернативой является добавление кода в методы `Up` и `Down` каждого класса миграции. Методы `Up` и `Down` содержат код, который реализует изменения базы данных. Примеры можно увидеть в учебнике [развертывание обновления базы данных](deploying-a-database-update.md) .
> 
> Кроме того, можно написать код, выполняющий инструкции SQL, с помощью метода `Sql`. Например, если вы добавили столбец бюджета в таблицу отдел и хотите инициализировать все бюджеты отдела до $1 000,00 в рамках миграции, можно добавить следующую строку кода в метод `Up` для этой миграции:
> 
> `Sql("UPDATE Department SET Budget = 1000");`

## <a name="create-scripts-for-membership-database-deployment"></a>Создание скриптов для развертывания базы данных членства

Приложение университета Contoso использует систему контроля членства ASP.NET и проверку подлинности с помощью форм для проверки подлинности и авторизации пользователей. Страница **Обновление кредитов** доступна только пользователям, которые находятся в роли администратора.

Запустите приложение и щелкните **курсы**, а затем — **Обновить кредиты**.

![Щелкните Обновить кредиты.](preparing-databases/_static/image7.png)

Откроется страница **входа** , так как для страницы **Обновление кредитов** требуются права администратора.

Введите имя пользователя *Admin* и *девпвд* в качестве пароля и нажмите кнопку **войти**.

![Страница входа](preparing-databases/_static/image8.png)

Откроется страница **Обновление кредитов** .

![Страница "обновление кредитов"](preparing-databases/_static/image9.png)

Сведения о пользователях и ролях находятся в базе данных *ASPNET-ContosoUniversity* , указанной в строке подключения **DefaultConnection** в файле *Web. config* .

Эта база данных не находится под управлением Entity Framework Code First, поэтому для ее развертывания нельзя использовать миграции. Вы будете использовать поставщик Дбдакфкс для развертывания схемы базы данных, и вы настроите профиль публикации для выполнения сценария, который вставит исходные данные в таблицы базы данных.

> [!NOTE]
> Новая система членства ASP.NET (теперь с именем ASP.NET Identity) была введена с Visual Studio 2013. Новая система позволяет размещать как приложения, так и таблицы членства в одной базе данных. Кроме того, можно использовать Code First Migrations для развертывания обоих приложений. В примере приложения используется более ранняя система членства ASP.NET, которая не может быть развернута с помощью Code First Migrations. Процедуры развертывания этой базы данных членства также применяются к любому другому сценарию, в котором приложению требуется развернуть базу данных SQL Server, которая не создана Entity Framework Code First.

Здесь, как правило, не требуется использовать одни и те же данные в рабочей среде в разработке. При первом развертывании сайта обычно исключаются большинство или все учетные записи пользователей, создаваемые для тестирования. Таким образом, скачанный проект имеет две базы данных членства: *АСПнет-контосауниверсити. mdf* с пользователями разработки и *АСПнет-контосауниверсити-прод. mdf* с рабочими пользователями. В этом руководстве имена пользователей одинаковы в обеих базах данных: *Admin* и *unadmin*. Оба пользователя имеют пароль *девпвд* в базе данных разработки и *продпвд* в рабочей базе данных.

Пользователи разработки развертываются в тестовой среде, а рабочие пользователи — в промежуточном и рабочем. Для этого в этом учебнике вы создадите два скрипта SQL: один для разработки и один для рабочей среды, а в последующих руководствах вы настроите процесс публикации для их запуска.

> [!NOTE]
> В базе данных членства хранится хэш паролей учетных записей. Чтобы развернуть учетные записи с одного компьютера на другой, необходимо убедиться, что подпрограммы хэширования не создают на целевом сервере разные хэши, чем на исходном компьютере. Они будут создавать одинаковые хэши при использовании универсальные поставщики ASP.NET, если не изменить алгоритм по умолчанию. Алгоритмом по умолчанию является HMACSHA256, который указывается в атрибуте **проверки** элемента **[machineKey](https://msdn.microsoft.com/library/system.web.configuration.machinekeysection.aspx)** в файле Web. config.

Скрипты развертывания данных можно создавать вручную с помощью SQL Server Management Studio (SSMS) или стороннего средства. В оставшейся части этого руководства вы узнаете, как это сделать в SSMS, но если вы не хотите устанавливать и использовать SSMS, вы можете получить скрипты из завершенной версии проекта и перейти к разделу, в котором они хранятся в папке решения.

Чтобы установить SSMS, установите его из [центра загрузки: Microsoft SQL Server 2012 Express](https://www.microsoft.com/download/details.aspx?id=29062) , щелкнув [ENU\x64\SQLManagementStudio\_x64\_RUS. exe](https://download.microsoft.com/download/8/D/D/8DD7BDBA-CEF7-4D8E-8C16-D9F69527F909/ENU/x64/SQLManagementStudio_x64_ENU.exe) или [ENU\x86\SQLManagementStudio\_x86\_RUS. exe](https://download.microsoft.com/download/8/D/D/8DD7BDBA-CEF7-4D8E-8C16-D9F69527F909/ENU/x86/SQLManagementStudio_x86_ENU.exe). Если выбрать для системы неверное значение, его установка будет невозможна, и вы сможете попробовать другой вариант.

(Обратите внимание, что это загрузка 600 МБ. Установка может занять много времени, и потребуется перезагрузка компьютера.)

На первой странице центра установки SQL Server щелкните **создать SQL Server изолированную установку или добавить компоненты к существующей установке**и следуйте инструкциям, принимая значения по умолчанию.

### <a name="create-the-development-database-script"></a>Создание скрипта базы данных разработки

1. Запустите SSMS.
2. В диалоговом окне **соединение с сервером** введите *(LocalDB) \v11.0* в качестве **имени сервера**, оставьте для параметра **authentication (проверка** **подлинности Windows**) значение Authentication, а затем нажмите кнопку **подключить**.

    ![Подключение SSMS к серверу](preparing-databases/_static/image10.png)
3. В окне **Обозреватель объектов** разверните узел **базы данных**, щелкните правой кнопкой мыши элемент **ASPNET-ContosoUniversity**, выберите пункт **задачи**, а затем выберите команду **Сформировать скрипты**.

    ![Создание скриптов в SSMS](preparing-databases/_static/image11.png)
4. В диалоговом окне **Создание и публикация скриптов** нажмите кнопку **задать параметры создания скриптов**.

    Можно пропустить шаг **Выбор объектов** , так как по умолчанию используется **сценарий для всей базы данных и всех объектов базы данных** , и именно то, что вам нужно.
5. Щелкните **Дополнительно**.

    ![Параметры создания скриптов SSMS](preparing-databases/_static/image12.png)
6. В диалоговом окне **Дополнительные параметры скрипта** прокрутите вниз до пункта **типы данных для создания скрипта**и выберите параметр **только данные** в раскрывающемся списке.
7. Измените значение в **сценарии использовать базу данных** на **false**. Инструкции USE недопустимы для базы данных SQL Azure и не требуются для развертывания на SQL Server Express в тестовой среде.

    ![Только данные скриптов SSMS, без инструкции USE](preparing-databases/_static/image13.png)
8. Нажмите кнопку **ОК**.
9. В диалоговом окне **Создание и публикация скриптов** в поле **имя файла** указывается, где будет создан скрипт. Измените путь к папке решения (папке с файлом ContosoUniversity. sln) и именем файла *АСПнет-Дата-дев. SQL*.
10. Нажмите кнопку **Далее** , чтобы открыть вкладку **Сводка** , а затем еще раз нажмите кнопку **Далее** , чтобы создать скрипт.

    ![Создан скрипт SSMS](preparing-databases/_static/image14.png)
11. Нажмите кнопку **Готово**.

### <a name="create-the-production-database-script"></a>Создание скрипта рабочей базы данных

Так как проект не был запущен с рабочей базой данных, он еще не присоединен к экземпляру LocalDB. Поэтому сначала необходимо присоединить базу данных.

1. В **обозревателе объектов**SSMS щелкните правой кнопкой мыши элемент **базы данных** и выберите команду **присоединить**.

    ![Присоединение SSMS](preparing-databases/_static/image15.png)
2. В диалоговом окне **Присоединение баз данных** нажмите кнопку **Добавить** , а затем перейдите к файлу *АСПнет-контосауниверсити-прод. mdf* в папке *app\_Data* .

     ![Надстройка SSMS Add. mdf для присоединения](preparing-databases/_static/image16.png)
3. Нажмите кнопку **ОК**.
4. Выполните ту же процедуру, которая использовалась ранее, чтобы создать скрипт для рабочего файла. Назовите файл скрипта *АСПнет-Дата-прод. SQL*.

## <a name="summary"></a>Сводка

Теперь обе базы данных готовы к развертыванию, и в папке решения есть два скрипта развертывания данных.

![Скрипты развертывания данных](preparing-databases/_static/image17.png)

В следующем учебнике вы настраиваете параметры проекта, влияющие на развертывание, и настраиваете автоматическое преобразование файла *Web. config* для параметров, которые должны отличаться в развернутом приложении.

## <a name="more-information"></a>Дополнительные сведения

Дополнительные сведения о NuGet см. в статье [руководство по](http://docs.nuget.org/docs/start-here/overview) [управлению библиотеками проектов с помощью NuGet](https://msdn.microsoft.com/magazine/hh547106.aspx) и NuGet. Если вы не хотите использовать NuGet, вам потребуется изучить, как анализировать пакет NuGet, чтобы определить, что он делает при установке. (Например, это может быть Настройка преобразований *Web. config* , Настройка сценариев PowerShell для выполнения во время сборки и т. д.). Дополнительные сведения о том, как работает NuGet, см. в разделе [Создание и Публикация пакета](http://docs.nuget.org/docs/creating-packages/creating-and-publishing-a-package) , [файла конфигурации и преобразований исходного кода](http://docs.nuget.org/docs/creating-packages/configuration-file-and-source-code-transformations).

> [!div class="step-by-step"]
> [Назад](introduction.md)
> [Вперед](web-config-transformations.md)
