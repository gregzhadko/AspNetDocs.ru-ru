---
uid: web-forms/overview/deployment/visual-studio-web-deployment/web-config-transformations
title: 'ASP.NET веб-развертывание с помощью Visual Studio: преобразования файла Web. config | Документация Майкрософт'
author: tdykstra
description: В этой серии руководств показано, как развернуть (опубликовать) веб-приложение ASP.NET в веб-приложениях службы приложений Azure или поставщике услуг размещения стороннего поставщика, Усин...
ms.author: riande
ms.date: 02/15/2013
ms.assetid: 5a2a927b-14cb-40bc-867a-f0680f9febd7
msc.legacyurl: /web-forms/overview/deployment/visual-studio-web-deployment/web-config-transformations
msc.type: authoredcontent
ms.openlocfilehash: a9d39547c94a63003442ba6fe1257693dde24b05
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74621792"
---
# <a name="aspnet-web-deployment-using-visual-studio-webconfig-file-transformations"></a>ASP.NET веб-развертывание с помощью Visual Studio: преобразования файла Web. config

от [Tom Dykstra)](https://github.com/tdykstra)

[Скачать начальный проект](https://go.microsoft.com/fwlink/p/?LinkId=282627)

> В этой серии руководств показано, как развернуть (опубликовать) веб-приложение ASP.NET в веб-приложениях службы приложений Azure или поставщике услуг размещения стороннего поставщика с помощью Visual Studio 2012 или Visual Studio 2010. Сведения о ряде см. в [первом руководстве по ряду](introduction.md).

## <a name="overview"></a>Обзор

В этом учебнике показано, как автоматизировать процесс изменения файла *Web. config* при его развертывании в различных целевых средах. Большинство приложений имеют параметры в файле *Web. config* , которые должны отличаться при развертывании приложения. Автоматизация процесса внесения этих изменений позволяет не выполнять их вручную при каждом развертывании, что может быть утомительным и подверженным ошибкам.

Напоминание. Если вы получаете сообщение об ошибке или что-то не работает при работе с этим руководством, обязательно ознакомьтесь со [страницей устранения неполадок](troubleshooting.md).

## <a name="webconfig-transformations-versus-web-deploy-parameters"></a>Преобразования Web. config и параметры веб-развертывание

Существует два способа автоматизации процесса изменения параметров файла *Web. config* : [преобразования Web. config](https://msdn.microsoft.com/library/dd465326.aspx) и [веб-развертывание параметров](https://msdn.microsoft.com/library/ff398068.aspx). Файл преобразования *Web. config* содержит XML-разметку, которая определяет способ изменения файла *Web. config* при его развертывании. Можно указать различные изменения для конкретных конфигураций сборки и для конкретных профилей публикации. Конфигурации сборки по умолчанию — Debug и Release, а также можно создавать пользовательские конфигурации сборки. Профиль публикации обычно соответствует целевой среде. (Дополнительные сведения о профилях публикации см. в учебнике [развертывание в службах IIS в качестве тестовой среды](deploying-to-iis.md) .)

Параметры веб-развертывание можно использовать для указания множества различных типов параметров, которые должны быть настроены во время развертывания, включая параметры, которые находятся в файлах *Web. config* . При использовании для указания изменений в файле *Web. config* веб-развертывание параметры более сложны для настройки, но они могут оказаться полезными, если вы не уверены, что значение должно быть задано до развертывания. Например, в корпоративной среде вы можете создать *пакет развертывания* и передать его пользователю в ИТ-отделе для установки в рабочую среду, и этот человек должен иметь возможность вводить строки подключения или пароли, которые незнакомы.

Для сценария, который охватывает эта серия руководств, вы заранее знакомы с тем, что нужно сделать с файлом *Web. config* , поэтому не нужно использовать веб-развертывание параметры. Вы настроите некоторые преобразования, которые различаются в зависимости от используемой конфигурации сборки, и некоторые из них различаются в зависимости от используемого профиля публикации.

<a id="watransforms"></a>

## <a name="specifying-webconfig-settings-in-azure"></a>Указание параметров Web. config в Azure

Если параметры файла *Web. config* , которые требуется изменить, находятся в `<connectionStrings>` или элементе `<appSettings>`, а при развертывании в веб-приложения в службе приложений Azure вы можете использовать другой вариант автоматизации изменений во время развертывания. Вы можете ввести параметры, которые будут действовать в Azure, на вкладке **Настройка** страницы портала управления для веб-приложения (прокрутите вниз до раздела **Параметры приложения** и **строки подключения** ). При развертывании проекта Azure автоматически применяет изменения. Дополнительные сведения см. в статье [веб-сайты Windows Azure: как работают строки приложения и строки подключения](https://blogs.msdn.com/b/windowsazure/archive/2013/07/17/windows-azure-web-sites-how-application-strings-and-connection-strings-work.aspx).

## <a name="default-transformation-files"></a>Файлы преобразования по умолчанию

В **Обозреватель решений**разверните файл *Web. config* , чтобы просмотреть файлы преобразования *Web. Debug. config* и *Web. Release. config* , которые создаются по умолчанию для двух конфигураций сборки по умолчанию.

![Web. config_transform_files](web-config-transformations/_static/image1.png)

Чтобы создать файлы преобразования для пользовательских конфигураций сборки, щелкните правой кнопкой мыши файл Web. config и в контекстном меню выберите команду **Добавить преобразования конфигурации** . В этом учебнике это не требуется, и параметр меню отключен, так как не были созданы пользовательские конфигурации сборки.

Позже вы создадите еще три файла преобразования, по одному для профилей тестирования, промежуточного хранения и рабочей публикации. Типичный пример параметра, который будет обработано в файле преобразования профиля публикации, так как он зависит от среды назначения — это конечная точка WCF, которая отличается для тестирования в сравнении с рабочими средами. Вы создадите файлы преобразования профиля публикации в последующих руководствах после создания профилей публикации, с которыми они проходят.

## <a name="disable-debug-mode"></a>Отключить режим отладки

Примером параметра, зависящего от конфигурации сборки, а не целевой среды, является атрибут `debug`. Для сборки выпуска Отладка обычно должна быть отключена независимо от среды, в которой выполняется развертывание. Таким образом, по умолчанию шаблоны проектов Visual Studio создают файлы преобразования *Web. Release. config* с кодом, который удаляет атрибут `debug` из элемента `compilation`. Ниже приведен *файл Web. Release. config*по умолчанию. в дополнение к примеру кода преобразования с комментарием, он содержит код в элементе `compilation`, который удаляет атрибут `debug`:

[!code-xml[Main](web-config-transformations/samples/sample1.xml?highlight=18)]

Атрибут `xdt:Transform="RemoveAttributes(debug)"` указывает, что необходимо удалить атрибут `debug` из элемента `system.web/compilation` в развернутом файле *Web. config* . Это выполняется каждый раз при развертывании сборки выпуска.

## <a name="limit-error-log-access-to-administrators"></a>Ограничение доступа к журналу ошибок администраторам

Если во время выполнения приложения произошла ошибка, приложение отображает общую страницу ошибки вместо страницы ошибки, созданной системой, и использует [пакет ELMAH NuGet](http://www.hanselman.com/blog/NuGetPackageOfTheWeek7ELMAHErrorLoggingModulesAndHandlersWithSQLServerCompact.aspx) для ведения журнала ошибок и создания отчетов. Элемент `customErrors` в файле *Web. config* приложения определяет страницу ошибки:

[!code-xml[Main](web-config-transformations/samples/sample2.xml)]

Чтобы просмотреть страницу ошибки, временно измените атрибут `mode` элемента `customErrors` с "RemoteOnly" на "on" и запустите приложение из Visual Studio. Вызвать ошибку, запросив недопустимый URL-адрес, например *студентскскскс. aspx*. Вместо страницы ошибки, созданной в IIS, отобразится страница *женерицеррорпаже. aspx* .

![Страница ошибки](web-config-transformations/_static/image2.png)

Чтобы просмотреть журнал ошибок, замените все URL-адреса после номера порта *ELMAH. axd* (например, `http://localhost:51130/elmah.axd`) и нажмите клавишу ВВОД:

![Страница ELMAH](web-config-transformations/_static/image3.png)

Не забудьте установить элемент `customErrors` обратно в режим "RemoteOnly" по завершении.

На компьютере разработчика удобно разрешить бесплатный доступ к странице журнала ошибок, но в рабочей среде это может представлять угрозу безопасности. Для рабочего сайта необходимо добавить правило авторизации, ограничивающее доступ к журналу ошибок для администраторов, а также убедиться, что это ограничение работает в тестовой и промежуточной среде. Поэтому это еще одно изменение, которое необходимо реализовать при каждом развертывании сборки выпуска, и оно входит в файл *Web. Release. config* .

Откройте *файл Web. Release. config* и добавьте новый элемент `location` непосредственно перед закрывающим тегом `configuration`, как показано ниже.

[!code-xml[Main](web-config-transformations/samples/sample3.xml?highlight=27-34)]

Значение атрибута `Transform` "Insert" приводит к тому, что элемент `location` добавляется в качестве одноуровневого элемента в любые существующие элементы `location` в файле *Web. config* . (Уже имеется один элемент `location`, указывающий правила авторизации для страницы **Обновление кредитов** .)

Теперь можно выполнить предварительный просмотр преобразования, чтобы убедиться, что он правильно закодирован.

В **Обозреватель решений**щелкните правой кнопкой мыши *Web. Release. config* и выберите пункт **Предварительный просмотр преобразования**.

![Предварительный просмотр меню преобразования](web-config-transformations/_static/image4.png)

Откроется страница, на которой отображается файл *Web. config* для разработки слева, а также то, как развернутый файл *Web. config* будет выглядеть справа с выделенными изменениями.

![Предварительный просмотр преобразования отладки](web-config-transformations/_static/image5.png)

![Предварительный просмотр преобразования местоположения](web-config-transformations/_static/image6.png)

(В предварительной версии можно заметить некоторые дополнительные изменения, для которых не были записаны преобразования. обычно это касается удаления пробелов, которые не влияют на функциональность.)

При тестировании сайта после развертывания можно также проверить, действительно ли действует правило авторизации.

> [!NOTE] 
> 
> **Примечание по безопасности** Никогда не отображать сведения об ошибках в рабочем приложении или хранить их в общедоступном месте. Злоумышленники могут использовать сведения об ошибке для обнаружения уязвимостей на сайте. Если вы используете ELMAH в своем приложении, настройте ELMAH, чтобы снизить риски безопасности. Пример ELMAH в этом учебнике не следует рассматривать как рекомендуемую конфигурацию. Это пример, который был выбран для того, чтобы продемонстрировать, как обрабатывать папку, в которой приложение должно иметь возможность создавать файлы. Дополнительные сведения см. [в разделе Защита конечной точки ELMAH](https://code.google.com/p/elmah/wiki/SecuringErrorLogPages).

## <a name="a-setting-that-youll-handle-in-publish-profile-transformation-files"></a>Параметр, который будет работать в файлах преобразования профиля публикации

Распространенный сценарий состоит в том, что параметры файла *Web. config* должны быть разными в каждой среде, развертываемой в. Например, приложению, которое вызывает службу WCF, может потребоваться другая конечная точка в тестовой и рабочей средах. Кроме того, приложение университета Contoso включает параметр этого типа. Этот параметр управляет видимым индикатором на страницах сайта с указанием среды, в которой вы являетесь, например, для разработки, тестирования или производства. Значение параметра определяет, будет ли приложение добавлять "(dev)" или "(тест)" к главному заголовку на главной странице *site. master* :

![Индикатор среды](web-config-transformations/_static/image7.png)

Индикатор среды опускается, если приложение выполняется в промежуточной или рабочей среде.

Веб-страницы университета Contoso считывают значение, заданное в `appSettings` в файле *Web. config* , чтобы определить, в какой среде выполняется приложение.

[!code-xml[Main](web-config-transformations/samples/sample4.xml)]

Значение должно быть "Test" в тестовой среде и "Production" для промежуточной и рабочей среды.

Следующий код в файле преобразования будет реализовывать это преобразование:

[!code-xml[Main](web-config-transformations/samples/sample5.xml)]

Значение атрибута `xdt:Transform` "Сетаттрибутес" указывает, что назначение этого преобразования заключается в изменении значений атрибутов существующего элемента в файле *Web. config* . Значение атрибута `xdt:Locator` "Match (ключ)" указывает, что изменяемый элемент является элементом, атрибут `key` которого соответствует атрибуту `key`, указанному здесь. Единственным другим атрибутом элемента `add` является `value`, который будет изменен в развернутом файле *Web. config* . Приведенный здесь код приводит к тому, что атрибуту `value` `Environment` элемента `appSettings` присваивается значение Test в развертываемом файле *Web. config* .

Это преобразование относится к файлам преобразования профиля публикации, которые еще не созданы. Вы создадите и обновите файлы преобразования, которые реализуют это изменение, при создании профилей публикации для тестовой, промежуточной и рабочей сред. Это можно сделать в учебниках [развертывание в IIS](deploying-to-iis.md) и [развертывание в рабочей среде](deploying-to-production.md) .

> [!NOTE]
> Поскольку этот параметр находится в элементе `<appSettings>`, у вас есть другая альтернатива для указания преобразования при развертывании в веб-приложениях в службе приложений Azure. см. раздел [Указание параметров Web. config в Azure](#watransforms) ранее в этом разделе.

## <a name="setting-connection-strings"></a>Настройка строк подключения

Несмотря на то, что файл преобразования по умолчанию содержит пример, демонстрирующий обновление строки подключения, в большинстве случаев нет необходимости настраивать преобразования строк подключения, так как в профиле публикации можно указать строки подключения. Это можно сделать в учебниках [развертывание в IIS](deploying-to-iis.md) и [развертывание в рабочей среде](deploying-to-production.md) .

## <a name="summary"></a>Сводка

Теперь перед созданием профилей публикации вы сделали то, что можно сделать с преобразованиями *Web. config* , и вы увидели предварительный просмотр того, что будет в развернутом файле Web. config.

![Предварительный просмотр преобразования местоположения](web-config-transformations/_static/image8.png)

В следующем учебнике будут рассмотрены задачи настройки развертывания, требующие настройки свойств проекта.

## <a name="more-information"></a>Дополнительные сведения

Дополнительные сведения о темах, описываемых в этом руководстве, см. в разделе [Использование преобразований Web. config для изменения параметров в целевом файле Web. config или файле App. config во время развертывания](https://go.microsoft.com/fwlink/p/?LinkId=282413#transforms) в карте содержимого веб-развертывания для Visual Studio и ASP.NET.

> [!div class="step-by-step"]
> [Назад](preparing-databases.md)
> [Вперед](project-properties.md)
