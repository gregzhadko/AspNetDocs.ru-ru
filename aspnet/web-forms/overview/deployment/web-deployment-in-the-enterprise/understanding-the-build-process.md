---
uid: web-forms/overview/deployment/web-deployment-in-the-enterprise/understanding-the-build-process
title: Общие сведения о процессе сборки | Документация Майкрософт
author: jrjlee
description: Этот раздел содержит пошаговое руководство процесса построения и развертывания корпоративного уровня. Подход, описанный в этом разделе использует пользовательские Денис сборки Microsoft...
ms.author: riande
ms.date: 05/04/2012
ms.assetid: 5b982451-547b-4a2f-a5dc-79bc64d84d40
msc.legacyurl: /web-forms/overview/deployment/web-deployment-in-the-enterprise/understanding-the-build-process
msc.type: authoredcontent
ms.openlocfilehash: 6f526b9842e02031b54b0a7519486ef8aa69021b
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59397400"
---
# <a name="understanding-the-build-process"></a>Общие сведения о процессе сборки

по [Джейсон Lee](https://github.com/jrjlee)

[Загрузить PDF-файл](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> Этот раздел содержит пошаговое руководство процесса построения и развертывания корпоративного уровня. Подход, описанный в этом разделе использует пользовательские файлы проекта Microsoft Build Engine (MSBuild) для обеспечения точного управления каждый аспект процесса. В файлах проекта пользовательских целевых объектов MSBuild используются для запуска программы развертывания, как средство веб-развертывания Internet Information Services (IIS) (MSDeploy.exe) и VSDBCMD.exe программы развертывания базы данных.
> 
> > [!NOTE]
> > Предыдущий раздел, [основные сведения о файле проекта](understanding-the-project-file.md), описано ключевые компоненты файла проекта MSBuild и введена концепция разделенные файлы проекта для поддержки развертывания в нескольких целевых средах. Если вы еще не знакомы с этими понятиями, следует ознакомиться с [основные сведения о файле проекта](understanding-the-project-file.md) перед началом работы с этим разделом.


Этот раздел является частью серии учебников, исходя из требования к развертыванию enterprise вымышленной компании Fabrikam, Inc. В этой серии руководств используется пример решения&#x2014; [решения диспетчера контактов](the-contact-manager-solution.md)&#x2014;для представления веб-приложения с более реалистичные уровень сложности, включая приложения ASP.NET MVC 3, Windows Communication Служба Foundation (WCF) и проект базы данных.

Метод развертывания в основе этих учебников основан на разбиение проекта файл подход, описанный в [основные сведения о файле проекта](understanding-the-project-file.md), в которой процесс построения управляется двумя файлы проекта&#x2014;один с Создание инструкции, которые применяются для каждой целевой среде и содержащего параметры построения и развертывания для конкретной среды. Во время сборки файл проекта для конкретной среды объединяется в файл проекта независимой от среды, чтобы полный набор инструкций построения.

## <a name="build-and-deployment-overview"></a>Сборки и общие сведения о развертывании

В [решения диспетчера контактов](the-contact-manager-solution.md), три файла управления процессом построения и развертывания:

- Объект *универсальный проект файл* (*Publish.proj*). Содержит инструкции сборки и развертывания, которые не изменяют между средами назначения.
- *Файл проекта для конкретной среды* (*Env Dev.proj*). Он содержит параметры построения и развертывания, относящихся к среде определенного места назначения. Например, можно использовать *Env Dev.proj* файл, чтобы указать параметры в среде разработки или тестирования и создать альтернативный файл с именем *Env Stage.proj* для предоставления параметров для промежуточного хранения Среда.
- Объект *командный файл* (*Dev.cmd публикации*). Этот файл содержит MSBuild.exe необходимо выполнить команду, которая указывает, какой проект файлов. Можно создать командный файл для каждой целевой среде, где каждый файл содержит команду MSBuild.exe, которая задает файл на другой проект конкретной среды. Это позволяет разработчику развертывания в разных средах, просто запустив файл соответствующую команду.

В примере решения можно найти эти три файла в папке публикации решения.

![](understanding-the-build-process/_static/image1.png)

Прежде чем рассматривать эти файлы, более подробно рассмотрим как процесс построения работает при использовании этого подхода. На высоком уровне процесс построения и развертывания выглядит следующим образом:

![](understanding-the-build-process/_static/image2.png)

Первое, что произойдет, — файлы два проекта&#x2014;с универсальной инструкции сборки и развертывания, а также, содержащий параметры, относящиеся к среде&#x2014;объединяются в один файл проекта. Затем MSBuild работает с помощью инструкции в файле проекта. Он создает все проекты в решении, в файле проекта для каждого проекта. Он затем вызывает другие средства, такие как Web Deploy (MSDeploy.exe) и служебную программу VSDBCMD для развертывания веб-содержимого и баз данных в целевой среде.

От начала до конца процесса построения и развертывания выполняет следующие задачи:

1. Он удаляет содержимое в выходной каталог, в процессе подготовки к новой сборки.
2. Он создает каждый проект в решении:

    1. Для веб-проектов&#x2014;таким образом, веб-приложение ASP.NET MVC и WCF веб-службы&#x2014;в процессе сборки создается пакет веб-развертывания для каждого проекта.
    2. Для проектов баз данных в процессе сборки создается манифест развертывания (DEPLOYMANIFEST-файл) для каждого проекта.
3. Она использует программу VSDBCMD.exe развертывание каждого проекта базы данных в решении, используя различные свойства из файлов проекта&#x2014;целевой строки подключения и имя базы данных&#x2014;вместе с DEPLOYMANIFEST-файл.
4. Он использует MSDeploy.exe программы для развертывания каждого веб-проекта в решении, используя различные свойства из файлов проекта для управления процессом развертывания.

В примере решения можно использовать для трассировки этот процесс более подробно.

> [!NOTE]
> Рекомендации по настройке файлы проекта для конкретной среды для серверных сред, см. в разделе [настройки свойств развертывания для целевой среды](../configuring-server-environments-for-web-deployment/configuring-deployment-properties-for-a-target-environment.md).


## <a name="invoking-the-build-and-deployment-process"></a>Вызов сборки и процесса развертывания

Чтобы развернуть решение диспетчера контактов в тестовой среде разработчика, разработчик запускает *Dev.cmd публикации* командный файл. При этом вызывается MSBuild.exe, указав *Publish.proj* файлом проекта для выполнения и *Env Dev.proj* как значение параметра.


[!code-console[Main](understanding-the-build-process/samples/sample1.cmd)]


> [!NOTE]
> **/Fl** переключения (сокращенно **/fileLogger**) записывает выходные данные сборки в файл с именем *msbuild.log* в текущем каталоге. Дополнительные сведения см. в разделе [Справочник по командной строке MSBuild](https://msdn.microsoft.com/library/ms164311.aspx).


На этом этапе MSBuild начинается выполнение, загружает *Publish.proj* файла и начинает обработку инструкциям в нем. Первая инструкция сообщает MSBuild, чтобы импортировать проект файл, который **TargetEnvPropsFile** указывает параметр.


[!code-xml[Main](understanding-the-build-process/samples/sample2.xml)]


**TargetEnvPropsFile** параметр указывает *Env Dev.proj* файла, поэтому MSBuild объединяет содержимое *Env Dev.proj* файл в  *Publish.proj* файл.

Следующие элементы, которые MSBuild находит в файле проекта объединенных являются группы свойств. Свойства обрабатываются в порядке, в котором они появляются в файле. MSBuild создает пару ключ значение для каждого свойства, предоставляя любого указанного условия. Свойства, определенные позднее в файле перезапишет любые свойства с тем же именем, указанным ранее в файле. Например, рассмотрим **OutputRoot** свойства.


[!code-xml[Main](understanding-the-build-process/samples/sample3.xml)]


Когда MSBuild обрабатывает первый **OutputRoot** элемента, предоставляющего параметр с таким же именем не предоставлен, то процедура присваивает значение **OutputRoot** свойства **... \Publish\Out**. Обнаружив второй **OutputRoot** элементе, если условие принимает значение **true**, будут перезаписаны значение **OutputRoot** свойство со значением **OutDir** параметра.

На элемент, который подсистема MSBuild сталкивается с является группой один элемент, содержащий элемент с именем **ProjectsToBuild**.


[!code-xml[Main](understanding-the-build-process/samples/sample4.xml)]


MSBuild обрабатывает эту инструкцию, создав список элементов с именем **ProjectsToBuild**. В этом случае в списке элементов содержит одно значение&#x2014;путь и имя файла решения.

На этом этапе целевыми объектами являются оставшиеся элементы. Целевые объекты обрабатываются по-разному из свойства и элементы&#x2014;по сути, целевые объекты не обрабатываются только после их либо явно указанный пользователем или вызван другой конструкции в файле проекта. Помните, что открывающий **проекта** тег включает **DefaultTargets** атрибута.


[!code-xml[Main](understanding-the-build-process/samples/sample5.xml)]


Это MSBuild использует для вызова **FullPublish** целевой объект, если целевые объекты не задан, при вызове MSBuild.exe. **FullPublish** целевой объект не содержит ни одной задачи; вместо этого он просто указывает список зависимостей.


[!code-xml[Main](understanding-the-build-process/samples/sample6.xml)]


Эта зависимость сообщает MSBuild, в порядке, для выполнения **FullPublish** целевого, она должна вызвать этот список целевых объектов в указанном порядке:

1. Он должен вызывать **Очистить** целевой объект.
2. Он должен вызывать **BuildProjects** целевой объект.
3. Он должен вызывать **GatherPackagesForPublishing** целевой объект.
4. Он должен вызывать **PublishDbPackages** целевой объект.
5. Он должен вызывать **PublishWebPackages** целевой объект.

### <a name="the-clean-target"></a>Целевой объект Clean

**Очистить** целевой объект по сути удаляет в выходной каталог и все его содержимое при подготовке к новой сборки.


[!code-xml[Main](understanding-the-build-process/samples/sample7.xml)]


Обратите внимание, что целевой объект включает в себя **ItemGroup** элемент. При определении свойства или элементы в **целевой** элемент, вы создаете *динамическое* свойства и элементы. Другими словами свойства или элементы не обрабатываться, пока целевой объект выполняется. В выходной каталог может не существует или не содержит файлов, пока не начнется процесс сборки, поэтому не может создавать  **\_FilesToDelete** статических элементов в списке; вам придется ждать, пока выполнение не ведется. Таким образом при создании списка в качестве динамического элемента в целевой объект.

> [!NOTE]
> В этом случае так как **Очистить** целевой является первым для выполнения, нет реальной необходимости в использовании динамического элемента группы. Тем не менее рекомендуется использовать динамические свойства и элементы в такой ситуации, так как может потребоваться запустить выполнение целевых объектов в другом порядке в определенный момент.  
> Кроме того, постарайтесь не объявляйте элементы, которые никогда не будут использоваться. Если у вас есть элементы, которые будут использоваться только для определенной цели, рассмотрите возможность их размещения в целевой объект для удаления ненужных служебных данных о процессе создания.


Динамические элементы, **Очистить** целевой довольно прост и использует встроенный **сообщение**, **удалить**, и **RemoveDir**задач:

1. Отправьте сообщение в средство ведения журнала.
2. Создавайте список файлов для удаления.
3. Удалите файлы.
4. Удалите выходной каталог.

### <a name="the-buildprojects-target"></a>Целевой объект BuildProjects

**BuildProjects** целевой объект по сути построение всех проектов в решении.


[!code-xml[Main](understanding-the-build-process/samples/sample8.xml)]


Этот целевой объект был в статье приведены в предыдущем разделе, [основные сведения о файле проекта](understanding-the-project-file.md), чтобы проиллюстрировать, как задачи и целевые объекты сослаться на свойства и элементы. На этом этапе вам интересно главным образом **MSBuild** задачи. Эту задачу можно использовать для создания нескольких проектов. Задача не создает новый экземпляр MSBuild.exe; для построения каждого проекта используется текущий выполняемый экземпляр. Основные особенности в этом примере приведены свойства развертывания.

- **DeployOnBuild** свойство MSBuild использует для выполнения любой инструкции по развертыванию в параметрах проекта при сборке каждого проекта.
- **DeployTarget** свойство идентифицирует целевой объект, который нужно вызвать после сборки проекта. В этом случае **пакета** целевого встраивает выходных файлов проекта в развертывание веб-пакета.

> [!NOTE]
> **Пакета** целевой вызывает Web Publishing конвейера (WPP), который обеспечивает интеграцию между MSBuild и веб-развертывания. Если вы хотите, взгляните на встроенные целевые объекты, которые предоставляет WPP, просмотрите *Microsoft.Web.Publishing.targets* файл в папке % PROGRAMFILES (x 86) %\MSBuild\Microsoft\VisualStudio\v10.0\Web.


### <a name="the-gatherpackagesforpublishing-target"></a>Целевой объект GatherPackagesForPublishing

Если вы изучите **GatherPackagesForPublishing** целевой объект, вы заметите, что он не содержит фактически ни одной задачи. Вместо этого он содержит группу один элемент, определяющий три динамических элементов.


[!code-xml[Main](understanding-the-build-process/samples/sample9.xml)]


Эти элементы ссылаться на пакеты развертывания, которые были созданы при **BuildProjects** целевой объект был выполнен. Вам не удалось определить эти элементы статически в файле проекта, так как файлы, на которые ссылаются элементы не существует, пока не **BuildProjects** выполнения целевого объекта. Вместо этого элементы должны быть определены динамически в целевой объект, который не вызывается до после **BuildProjects** выполнения целевого объекта.

Элементы не используются в этом целевом объекте&#x2014;этот целевой объект просто создает элементы и метаданные, связанные со значением каждого элемента. Как только эти элементы обрабатываются, **PublishPackages** элемент будет содержать два значения, путь к *ContactManager.Mvc.deploy.cmd* файла и путь к  *ContactManager.Service.deploy.cmd* файл. Веб-развертывание создает эти файлы как часть веб-пакета для каждого проекта и файлы, которые необходимо вызвать на целевом сервере для развертывания пакетов. Если открыть один из этих файлов, по сути появится команда MSDeploy.exe при различных значениях параметров, относящихся к сборке.

**DbPublishPackages** элемент будет содержать одно значение, путь к *ContactManager.Database.deploymanifest* файла.

> [!NOTE]
> DEPLOYMANIFEST-файл создается при построении проекта базы данных, и использует ту же схему в качестве файла проекта MSBuild. Он содержит все сведения, необходимые для развертывания базы данных, включая расположение схема базы данных (DBSCHEMA) и сведения о всех сценариев перед развертыванием и после развертывания. Дополнительные сведения см. в разделе [Обзор из построения базы данных и развертывания](https://msdn.microsoft.com/library/aa833165.aspx).


Дополнительные сведения о том, как пакеты развертывания и манифесты развертывания базы данных создаются и используются в [сборка и упаковка проектов веб-приложений](building-and-packaging-web-application-projects.md) и [развертывание проектов баз данных](deploying-database-projects.md).

### <a name="the-publishdbpackages-target"></a>Целевой объект PublishDbPackages

Кратко говоря, **PublishDbPackages** целевой вызывает служебную программу VSDBCMD, чтобы развернуть **ContactManager** базы данных к целевой среде. Настройка развертывания базы данных включает в себя множество решений и особенности, и вы узнаете об этом в [развертывание проектов баз данных](deploying-database-projects.md) и [Настройка развертываний баз данных для нескольких сред](../advanced-enterprise-web-deployment/customizing-database-deployments-for-multiple-environments.md). В этом разделе мы сосредоточимся на фактически работой данного целевого объекта.

Во-первых, обратите внимание, что открывающий тег включает **выходные данные** атрибута.


[!code-xml[Main](understanding-the-build-process/samples/sample10.xml)]


Это пример *пакетной обработке целевых объектов*. В файлах проектов MSBuild Пакетная обработка — это метод для итерации по коллекции. Значение **выходные данные** атрибут, **«% (DbPublishPackages.Identity)»**, ссылается на **удостоверений** свойство метаданных **DbPublishPackages**  списка элементов. Эти обозначения **Outputs=%***(ItemList.ItemMetadataName)*, преобразуется следующим образом:

- Разделить элементы в **DbPublishPackages** на пакеты элементов, которые содержат одинаковые **удостоверений** значение метаданных.
- Выполнение целевого один раз в пакете.

> [!NOTE]
> **Удостоверение** является одним из [значения встроенные метаданные](https://msdn.microsoft.com/library/ms164313.aspx) , назначенный каждому элементу при создании. Он ссылается на значение **Include** атрибут в **элемент** элемент&#x2014;другими словами, путь и имя файла элемента.


В этом случае так как их не должно быть больше одного элемента с один и тот же путь и имя файла, по сути работа осуществляется с размеры пакетов одного. Целевой объект выполняется один раз для каждого пакета базы данных.

Вы увидите аналогичные нотацию в  **\_Cmd** свойство, которое создает команду VSDBCMD с соответствующими параметрами.


[!code-xml[Main](understanding-the-build-process/samples/sample11.xml)]


В этом случае **%(DbPublishPackages.DatabaseConnectionString)**, **%(DbPublishPackages.TargetDatabase)**, и **%(DbPublishPackages.FullPath)** ссылаются значения метаданных **DbPublishPackages** коллекции элементов.  **\_Cmd** используется объектами **Exec** задачу, которая вызывает команду.


[!code-xml[Main](understanding-the-build-process/samples/sample12.xml)]


В результате этой нотации **Exec** задача создаст пакеты на основании уникальных сочетаний **DatabaseConnectionString**, **TargetDatabase**и **FullPath** значения метаданных и задача выполняется один раз для каждого пакета. Это пример *пакетной обработке задач*. Тем не менее, так как пакетная обработка целевого уровня уже поделила нашей коллекции элементов на пакеты одним элементом **Exec** задача будет выполняться только один раз для каждой итерации целевого объекта. Другими словами эта задача вызывает служебную программу VSDBCMD один раз для каждого пакета базы данных в решении.

> [!NOTE]
> Дополнительные сведения о целевой и пакетная обработка задач, см. в разделе MSBuild [Пакетная обработка](https://msdn.microsoft.com/library/ms171473.aspx), [метаданные элементов в пакетной обработке целевых объектов](https://msdn.microsoft.com/library/ms228229.aspx), и [метаданные элементов в пакетной обработке задач](https://msdn.microsoft.com/library/ms171474.aspx).


### <a name="the-publishwebpackages-target"></a>Целевой объект PublishWebPackages

К этому моменту, которые были активированы **BuildProjects** целевой объект, который создает пакет веб-развертывания для каждого проекта в решении. Сопутствующий каждого пакета является *deploy.cmd* файл, содержащий MSDeploy.exe команд, необходимых для развертывания пакета в целевой среде, и *SetParameters.xml* файл, который указывает необходимые сведения о целевой среде. Кроме того, были активированы **GatherPackagesForPublishing** целевой объект, который создает элемент коллекцию, содержащую *deploy.cmd* файлы, которые вас интересуют. По сути **PublishWebPackages** целевой выполняет следующие функции:

- Он управляет *SetParameters.xml* файл для каждого пакета, укажите правильные сведения для целевой среды, с помощью **XmlPoke** задачи.
- Он вызывает *deploy.cmd* файл для каждого пакета, с помощью нужных параметров.

Так же, как **PublishDbPackages** целевой объект, **PublishWebPackages** целевой объект использует Пакетная обработка целевых объектов для убедитесь, что целевой объект выполняется один раз для каждого веб-пакета.


[!code-xml[Main](understanding-the-build-process/samples/sample13.xml)]


В пределах целевого **Exec** задач используется для запуска *deploy.cmd* файл для каждого веб-пакета.


[!code-xml[Main](understanding-the-build-process/samples/sample14.xml)]


Дополнительные сведения о настройке развертывания веб-пакетов, см. в разделе [сборка и упаковка проектов веб-приложений](building-and-packaging-web-application-projects.md).

## <a name="conclusion"></a>Заключение

В этом разделе предоставляются Пошаговое руководство по использованию разделенные файлы проекта для управления процессом построения и развертывания от начала до конца для примера решения диспетчера контактов. При таком подходе позволяет выполнения комплексных, развертывание предприятию в единый, повторяемый шаг, просто запустив конкретной среды командный файл.

## <a name="further-reading"></a>Дополнительные сведения

Более подробное введение в файлы проекта и WPP, см. в разделе [Inside the Microsoft Build Engine: С помощью MSBuild и Team Foundation Build](http://amzn.com/0735645248) Саид Ибрагим Хашими и William Bartholomew, ISBN: 978-0-7356-4524-0.

> [!div class="step-by-step"]
> [Назад](understanding-the-project-file.md)
> [Вперед](building-and-packaging-web-application-projects.md)
