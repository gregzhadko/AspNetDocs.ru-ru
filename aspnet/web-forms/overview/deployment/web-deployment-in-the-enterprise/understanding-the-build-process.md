---
uid: web-forms/overview/deployment/web-deployment-in-the-enterprise/understanding-the-build-process
title: Основные сведения о процессе сборки | Документация Майкрософт
author: jrjlee
description: В этом разделе приводится пошаговое руководство по процессу сборки и развертывания корпоративного уровня. Описанный в этом разделе подход использует пользовательскую Енгин Microsoft Build...
ms.author: riande
ms.date: 05/04/2012
ms.assetid: 5b982451-547b-4a2f-a5dc-79bc64d84d40
msc.legacyurl: /web-forms/overview/deployment/web-deployment-in-the-enterprise/understanding-the-build-process
msc.type: authoredcontent
ms.openlocfilehash: 802d93f7ca987d018967275bae68b8c56d883a25
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78520836"
---
# <a name="understanding-the-build-process"></a>Общие сведения о процессе сборки

кто [Джейсон Иванов](https://github.com/jrjlee)

[Скачать в формате PDF](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> В этом разделе приводится пошаговое руководство по процессу сборки и развертывания корпоративного уровня. Описанный в этом разделе подход использует пользовательские файлы проекта Microsoft Build Engine (MSBuild) для обеспечения точного контроля над каждым аспектом процесса. В файлах проекта пользовательские целевые объекты MSBuild используются для запуска таких программ развертывания, как средство веб-развертывания службы IIS (IIS) (MSDeploy. exe) и программа развертывания базы данных VSDBCMD. exe.
> 
> > [!NOTE]
> > В предыдущем разделе, посвященном [файлу проекта](understanding-the-project-file.md), описаны ключевые компоненты файла проекта MSBuild и представлена концепция разделенных файлов проекта для поддержки развертывания в нескольких целевых средах. Если вы еще не знакомы с этими понятиями, перед началом работы с этим разделом следует изучить [файл проекта](understanding-the-project-file.md) .

Этот раздел является частью серии руководств, основанных на требованиях Enterprise к развертыванию вымышленной компании Fabrikam, Inc. В этой серии руководств используется пример решения&#x2014; [диспетчера контактов](the-contact-manager-solution.md)&#x2014;для представления веб-приложения с реалистичным уровнем сложности, включая приложение ASP.NET MVC 3, службу Windows Communication Foundation (WCF) и проект базы данных.

Метод развертывания в сердце этих учебников основан на подходе к файлам проекта Split, описанному в разделе [понимание файла проекта](understanding-the-project-file.md), в котором процесс сборки управляется двумя файлами&#x2014;проекта, содержащими инструкции по сборке, которые применяются к каждой целевой среде, и одна содержит параметры сборки и развертывания, относящиеся к конкретной среде. Во время сборки файл проекта, зависящий от среды, объединяется в файл проекта независимо от среды, чтобы сформировать полный набор инструкций по сборке.

## <a name="build-and-deployment-overview"></a>Обзор сборка и развертывание

В [решении диспетчера контактов](the-contact-manager-solution.md)три файла управляют процессом сборки и развертывания:

- *Универсальный файл проекта* (*Publish. proj*). Содержит инструкции по сборке и развертыванию, которые не меняются между конечными средами.
- *Зависящий от среды файл проекта* (*env-dev. proj*). Содержит параметры сборки и развертывания, относящиеся к определенной целевой среде. Например, файл *env-dev. proj* можно использовать для предоставления параметров для среды разработки или тестирования и создания альтернативного файла с именем *env-Stage. proj* для предоставления параметров промежуточной среде.
- *Командный файл* (*публиш-дев. cmd*). Он содержит команду MSBuild. exe, которая указывает, какие файлы проекта необходимо выполнить. Можно создать командный файл для каждой целевой среды, где каждый файл содержит команду MSBuild. exe, которая указывает другой файл проекта для конкретной среды. Это позволяет разработчику развертывать в разных средах, просто выполняя соответствующий командный файл.

В примере решения эти три файла можно найти в папке публикация решения.

![](understanding-the-build-process/_static/image1.png)

Прежде чем рассматривать эти файлы более подробно, давайте посмотрим, как работает общий процесс сборки при использовании этого подхода. На высоком уровне процесс сборки и развертывания выглядит следующим образом:

![](understanding-the-build-process/_static/image2.png)

Первое, что происходит, состоит в том, что два&#x2014;файла проекта, содержащие универсальные инструкции по сборке и развертыванию, и одна&#x2014;из которых содержит параметры, относящиеся к конкретной среде, объединяются в один файл проекта. Затем MSBuild работает с инструкциями в файле проекта. Он создает каждый из проектов в решении, используя файл проекта для каждого проекта. Затем он обращается к другим средствам, таким как веб-развертывание (MSDeploy. exe) и служебной программе VSDBCMD, для развертывания веб-содержимого и баз данных в целевой среде.

От начала до конца процесс сборки и развертывания выполняет следующие задачи:

1. Он удаляет содержимое выходного каталога в процессе подготовки к новой сборке.
2. Он создает каждый проект в решении:

    1. Для веб-&#x2014;проектов в этом случае веб-приложение ASP.NET MVC и веб-служба&#x2014;WCF создают пакет веб-развертывания для каждого проекта.
    2. Для проектов баз данных процесс сборки создает манифест развертывания (деплойманифест-файл) для каждого проекта.
3. Он использует служебную программу VSDBCMD. exe для развертывания каждого проекта базы данных в решении, используя различные свойства из файлов&#x2014;проекта, а также целевую строку подключения и&#x2014;имя базы данных вместе с деплойманифест-файлом.
4. В нем используется служебная программа MSDeploy. exe для развертывания каждого веб-проекта в решении с использованием различных свойств файлов проекта для управления процессом развертывания.

Для более подробного отслеживания этого процесса можно использовать пример решения.

> [!NOTE]
> Рекомендации по настройке файлов проекта для конкретной среды сервера см. в разделе [Настройка свойств развертывания для целевой среды](../configuring-server-environments-for-web-deployment/configuring-deployment-properties-for-a-target-environment.md).

## <a name="invoking-the-build-and-deployment-process"></a>Вызов сборка и развертывание процесса

Чтобы развернуть решение диспетчера контактов в тестовой среде разработчика, разработчик запускает командный файл *публиш-дев. cmd* . Это вызывает MSBuild. exe, указывая *Publish. proj* в качестве файла проекта для выполнения и *env-dev. proj* в качестве значения параметра.

[!code-console[Main](understanding-the-build-process/samples/sample1.cmd)]

> [!NOTE]
> Параметр **/ФЛ** (Short для **/филелогжер**) записывает выходные данные сборки в файл с именем *MSBuild. log* в текущем каталоге. Дополнительные сведения см. в [справочнике по командной строке MSBuild](https://msdn.microsoft.com/library/ms164311.aspx).

На этом этапе MSBuild начинает выполняться, загружает файл *Publish. proj* и начинает обработку инструкций внутри него. Первая инструкция указывает MSBuild импортировать файл проекта, который указывает параметр **таржетенвпропсфиле** .

[!code-xml[Main](understanding-the-build-process/samples/sample2.xml)]

Параметр **таржетенвпропсфиле** указывает файл *env-dev. proj* , поэтому MSBuild объединяет содержимое файла *env-dev. proj* в файл *Publish. proj* .

Следующие элементы, которые MSBuild обнаруживает в объединенном файле проекта, являются группами свойств. Свойства обрабатываются в том порядке, в котором они отображаются в файле. MSBuild создает пару "ключ-значение" для каждого свойства, предоставляя выполнение всех указанных условий. Свойства, определенные далее в файле, будут перезаписывать все свойства с тем же именем, которое было определено ранее в файле. Например, рассмотрим свойства **аутпутрут** .

[!code-xml[Main](understanding-the-build-process/samples/sample3.xml)]

Когда MSBuild обрабатывает первый элемент **аутпутрут** , предоставляя не указанный параметр с таким же именем, он устанавливает для свойства **аутпутрут** значение **. \Публиш\аут**. При обнаружении второго элемента **аутпутрут** , если условие принимает значение **true**, оно перезаписывает значение свойства **аутпутрут** значением параметра **OutDir** .

Следующий элемент, который обнаруживает MSBuild, — это единственная группа элементов, содержащая элемент с именем **ProjectsToBuild**.

[!code-xml[Main](understanding-the-build-process/samples/sample4.xml)]

MSBuild обрабатывает эту инструкцию, создавая список элементов с именем **ProjectsToBuild**. В этом случае список элементов содержит одно значение&#x2014;, содержащее путь и имя файла решения.

На этом этапе остальные элементы являются целевыми. Целевые объекты обрабатываются не так,&#x2014;как свойства и элементы, поэтому целевые объекты не обрабатываются, если они явно не указаны пользователем или не вызываются другой конструкцией в файле проекта. Вспомним, что открывающий тег **проекта** содержит атрибут **DefaultTargets** .

[!code-xml[Main](understanding-the-build-process/samples/sample5.xml)]

Это указывает MSBuild на вызов целевого объекта **фуллпублиш** , если целевые объекты не указаны при вызове MSBuild. exe. Целевой объект **фуллпублиш** не содержит никаких задач. Вместо этого он просто указывает список зависимостей.

[!code-xml[Main](understanding-the-build-process/samples/sample6.xml)]

Эта зависимость сообщает MSBuild, что для выполнения целевого объекта **фуллпублиш** необходимо вызвать этот список целевых объектов в указанном порядке:

1. Он должен вызвать цель **Clean** .
2. Он должен вызвать целевой объект **буилдпрожектс** .
3. Он должен вызвать целевой объект **гасерпаккажесфорпублишинг** .
4. Он должен вызвать целевой объект **публишдбпаккажес** .
5. Он должен вызвать целевой объект **публишвебпаккажес** .

### <a name="the-clean-target"></a>Целевой объект Clean

Цель **очистки** , по сути, удаляет выходной каталог и все его содержимое в качестве подготовки к свежей сборке.

[!code-xml[Main](understanding-the-build-process/samples/sample7.xml)]

Обратите внимание, что целевой объект содержит элемент **ItemGroup** . При определении свойств или элементов в **целевом** элементе создаются *динамические* свойства и элементы. Иными словами, свойства или элементы не обрабатываются до тех пор, пока не будет выполнена цель. Выходной каталог может не существовать или содержать какие-либо файлы до начала процесса сборки, поэтому нельзя построить список **\_филестоделете** как статический элемент. необходимо дождаться завершения выполнения. Таким образом, вы создаете список в качестве динамического элемента в пределах целевого объекта.

> [!NOTE]
> В этом случае, поскольку цель **Clean** является первой для выполнения, нет никакой реальной необходимости использовать динамическую группу элементов. Однако рекомендуется использовать динамические свойства и элементы в сценарии такого типа, так как в некоторый момент может потребоваться выполнить целевые объекты в другом порядке.  
> Следует также избегать объявления элементов, которые никогда не будут использоваться. Если у вас есть элементы, которые будут использоваться только конкретным целевым объектом, рассмотрите возможность поместить их в целевой объект, чтобы удалить ненужные издержки на процесс сборки.

Динамические элементы **в этом случае** довольно просты и используют встроенные задачи **Message**, **Delete**и **RemoveDir** для выполнения следующих задач:

1. Отправка сообщения в средство ведения журнала.
2. Создайте список файлов для удаления.
3. Удалите файлы.
4. Удалите выходной каталог.

### <a name="the-buildprojects-target"></a>Целевой объект Буилдпрожектс

Цель **буилдпрожектс** , по сути, создает все проекты в примере решения.

[!code-xml[Main](understanding-the-build-process/samples/sample8.xml)]

Этот целевой объект был подробно описан в предыдущем разделе, посвященном [файлу проекта](understanding-the-project-file.md), чтобы продемонстрировать, как задачи и целевые объекты ссылаются на свойства и элементы. На этом этапе вы в основном заинтересованы в задаче **MSBuild** . Эту задачу можно использовать для построения нескольких проектов. Задача не создает новый экземпляр MSBuild. exe; для сборки каждого проекта используется текущий выполняющийся экземпляр. Ключевые моменты, представляющие интерес в этом примере, являются свойствами развертывания:

- Свойство **деплойонбуилд** указывает MSBuild на выполнение каких-либо инструкций по развертыванию в параметрах проекта при завершении сборки каждого проекта.
- Свойство **деплойтаржет** определяет целевой объект, который необходимо вызвать после построения проекта. В этом случае целевой объект **пакета** выполняет сборку выходных данных проекта в развертываемый веб-пакет.

> [!NOTE]
> Цель **пакета** вызывает конвейер веб-публикаций (WPP), который обеспечивает интеграцию между MSBuild и веб-развертывание. Если вы хотите ознакомиться со встроенными целевыми объектами, предоставляемыми в КОНВЕЙЕРе, просмотрите файл *Microsoft. Web. Publishing. targets* в папке% ProgramFiles (x86)% \ MSBuild\Microsoft\VisualStudio\v10.0\Web.

### <a name="the-gatherpackagesforpublishing-target"></a>Целевой объект Гасерпаккажесфорпублишинг

При изучении целевого объекта **гасерпаккажесфорпублишинг** вы заметите, что на самом деле он не содержит никаких задач. Вместо этого он содержит одну группу элементов, которая определяет три динамических элемента.

[!code-xml[Main](understanding-the-build-process/samples/sample9.xml)]

Эти элементы относятся к пакетам развертывания, которые были созданы при выполнении целевого объекта **буилдпрожектс** . Невозможно определить эти элементы статически в файле проекта, так как файлы, на которые ссылаются элементы, не существуют до тех пор, пока не будет выполнен целевой объект **буилдпрожектс** . Вместо этого элементы должны быть динамически определены в целевом объекте, который не вызывается до тех пор, пока не будет выполнен целевой объект **буилдпрожектс** .

Элементы не используются в этом целевом объекте&#x2014;. Эта цель просто создает элементы и метаданные, связанные с каждым из значений элементов. После обработки этих элементов элемент **публишпаккажес** будет содержать два значения: путь к файлу *ContactManager. MVC. deploy. cmd* и путь к файлу *ContactManager. Service. deploy. cmd* . Веб-развертывание создает эти файлы как часть веб-пакета для каждого проекта, и это файлы, которые необходимо вызвать на целевом сервере для развертывания пакетов. Если открыть один из этих файлов, по сути, вы увидите команду MSDeploy. exe с различными значениями параметров, специфичными для сборки.

Элемент **дбпублишпаккажес** будет содержать одно значение — путь к файлу *ContactManager. Database. деплойманифест* .

> [!NOTE]
> Файл. деплойманифест создается при построении проекта базы данных и использует ту же схему, что и файл проекта MSBuild. Он содержит все сведения, необходимые для развертывания базы данных, включая расположение схемы базы данных (DBSCHEMA) и сведения о сценариях, выполняемых перед развертыванием и после него. Дополнительные сведения см. [в обзоре сборка и развертывание базы данных](https://msdn.microsoft.com/library/aa833165.aspx).

Вы узнаете больше о том, как создаются и используются манифесты развертывания, а также их использование при [сборке и упаковке проектов веб-приложений](building-and-packaging-web-application-projects.md) и [развертывании проектов баз данных](deploying-database-projects.md).

### <a name="the-publishdbpackages-target"></a>Целевой объект Публишдбпаккажес

Вкратце говоря, цель **публишдбпаккажес** вызывает служебную программу VSDBCMD для развертывания базы данных **ContactManager** в целевой среде. Настройка развертывания базы данных включает в себя множество решений и нюансов, и вы узнаете об этом подробнее в статье [развертывание проектов баз данных](deploying-database-projects.md) и [Настройка развертываний баз данных для нескольких сред](../advanced-enterprise-web-deployment/customizing-database-deployments-for-multiple-environments.md). В этом разделе мы рассмотрим, как эта цель фактически функционирует.

Во первых, обратите внимание, что открывающий тег содержит атрибут **Outputs** .

[!code-xml[Main](understanding-the-build-process/samples/sample10.xml)]

Это пример *пакетной обработки целевых объектов*. В файлах проекта MSBuild Пакетная обработка — это метод для прохода по коллекциям. Значение атрибута **Outputs** **"% (дбпублишпаккажес. Identity)"** ссылается на свойство метаданных **Identity** в списке элементов **дбпублишпаккажес** . Эта нотация, **Outputs =% * * * (итемлист. итемметадатанаме)* , преобразуется следующим образом:

- Разделите элементы в **дбпублишпаккажес** на пакеты элементов, которые содержат одно и то же значение метаданных **Identity** .
- Выполните целевой объект один раз для каждого пакета.

> [!NOTE]
> **Identity** — это одно из [встроенных значений метаданных](https://msdn.microsoft.com/library/ms164313.aspx) , которое назначается каждому элементу при создании. Он ссылается на значение атрибута **include** в элементе&#x2014; **Item** , иными словами, путь и имя файла элемента.

В этом случае, поскольку никогда не должно быть более одного элемента с одинаковым путем и именем файла, мы фактически работаем с размерами пакетов одного из них. Целевой объект выполняется один раз для каждого пакета базы данных.

Аналогичную нотацию можно увидеть в свойстве **Cmd\_** , которое создает команду VSDBCMD с соответствующими параметрами.

[!code-xml[Main](understanding-the-build-process/samples/sample11.xml)]

В этом случае **% (дбпублишпаккажес. DatabaseConnectionString)** , **% (дбпублишпаккажес. TargetDatabase)** и **% (дбпублишпаккажес. FullPath)** ссылаются на значения метаданных коллекции элементов **дбпублишпаккажес** . Свойство **\_cmd** используется задачей **exec** , которая вызывает команду.

[!code-xml[Main](understanding-the-build-process/samples/sample12.xml)]

В результате задача **exec** создаст пакеты на основе уникальных сочетаний значений метаданных **DatabaseConnectionString**, **TargetDatabase**и **FullPath** , и задача будет выполняться по одному разу для каждого пакета. Это пример *пакетной обработки задач*. Однако поскольку Пакетная обработка на уровне целевого объекта уже разделяет коллекцию элементов на пакеты с одним элементом, задача **exec** будет выполняться один раз и только один раз для каждой итерации целевого объекта. Иными словами, эта задача вызывает служебную программу VSDBCMD один раз для каждого пакета базы данных в решении.

> [!NOTE]
> Дополнительные сведения о пакетировании целевых объектов и задач см. в разделах [Пакетная обработка](https://msdn.microsoft.com/library/ms171473.aspx)MSBuild, [метаданные элементов в пакетной обработке целевых объектов](https://msdn.microsoft.com/library/ms228229.aspx)и [метаданные элементов в пакетной обработке задач](https://msdn.microsoft.com/library/ms171474.aspx).

### <a name="the-publishwebpackages-target"></a>Целевой объект Публишвебпаккажес

К этому моменту вы вызвали целевой объект **буилдпрожектс** , который создает пакет веб-развертывания для каждого проекта в примере решения. Сопутствующий каждый пакет — это файл *deploy. cmd* , который содержит команды msdeploy. exe, необходимые для развертывания пакета в целевой среде, и файл *SetParameters. XML* , который указывает необходимые сведения о целевой среде. Вы также вызвали целевой объект **гасерпаккажесфорпублишинг** , который создает коллекцию элементов, содержащую файлы *deploy. cmd* , которые вас интересуют. По сути, цель **публишвебпаккажес** выполняет следующие функции:

- Он управляет файлом *SetParameters. XML* для каждого пакета, чтобы включить в него правильные сведения о целевой среде с помощью задачи **задача XmlPoke** .
- Он вызывает файл *deploy. cmd* для каждого пакета, используя соответствующие параметры.

Как и целевой объект **публишдбпаккажес** , целевой объект **публишвебпаккажес** использует пакетную обработку целевых объектов, чтобы обеспечить выполнение целевого объекта для каждого веб-пакета по одному разу.

[!code-xml[Main](understanding-the-build-process/samples/sample13.xml)]

В целевом объекте задача **exec** используется для запуска файла *deploy. cmd* для каждого веб-пакета.

[!code-xml[Main](understanding-the-build-process/samples/sample14.xml)]

Дополнительные сведения о настройке развертывания веб-пакетов см. в разделе [Создание и упаковка проектов веб-приложений](building-and-packaging-web-application-projects.md).

## <a name="conclusion"></a>Заключение

В этом разделе представлено пошаговое руководство по использованию разделенных файлов проекта для управления процессом сборки и развертывания с начала до конца для примера решения диспетчера контактов. Такой подход позволяет выполнять сложные развертывания корпоративного уровня в одном повторяемом шаге, просто выполняя командный файл, относящийся к конкретной среде.

## <a name="further-reading"></a>Дополнительные материалы

Более подробные сведения о файлах проекта и конвейере WPP см. в разделе [Microsoft Build Engine: использование MSBuild и Team Foundation Build](http://amzn.com/0735645248) by Саид Ибрагим Хашими and Уильям БАРСОЛОМЕВ, ISBN: 978-0-7356-4524-0.

> [!div class="step-by-step"]
> [Назад](understanding-the-project-file.md)
> [Вперед](building-and-packaging-web-application-projects.md)
