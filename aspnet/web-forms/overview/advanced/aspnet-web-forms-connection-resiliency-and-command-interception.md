---
uid: web-forms/overview/advanced/aspnet-web-forms-connection-resiliency-and-command-interception
title: Устойчивость подключения ASP.NET Web Forms и перехват команд | Документация Майкрософт
author: Erikre
description: Это руководство содержит инструкции изменить пример приложения для поддержки устойчивость подключений и перехват команд.
ms.author: riande
ms.date: 03/31/2014
ms.assetid: 6d497001-fa80-4765-b4cc-181fe90b894e
msc.legacyurl: /web-forms/overview/advanced/aspnet-web-forms-connection-resiliency-and-command-interception
msc.type: authoredcontent
ms.openlocfilehash: 067542e8b8aa9909bbb2147f8e11e34604986d87
ms.sourcegitcommit: 289e051cc8a90e8f7127e239fda73047bde4de12
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/25/2019
ms.locfileid: "58424031"
---
<a name="aspnet-web-forms-connection-resiliency-and-command-interception"></a>Устойчивость подключений и перехват команд в веб-формах ASP.NET
====================
по [Erik Reitan](https://github.com/Erikre)

В этом руководстве вы измените пример приложения Wingtip Toys для поддержки устойчивость подключений и перехват команд. Включив устойчивость подключений, пример приложения Wingtip Toys автоматически повторит вызовов данных, при возникновении временных ошибок, характерным для облачной среды. Кроме того, реализовав перехват команд, пример приложения Wingtip Toys, он перехватывает все SQL-запросы, отправляемые в базу данных для входа или их изменения.

> [!NOTE] 
> 
> Этот учебник веб-форм был основан на том Дайкстра следующие руководство по MVC:  
> [Устойчивость подключений и перехват команд с помощью Entity Framework в приложении ASP.NET MVC](../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)


## <a name="what-youll-learn"></a>Вы узнаете, как:

- Как обеспечить устойчивость подключения.
- Как реализовать перехват команд.

## <a name="prerequisites"></a>Предварительные требования

Перед началом работы убедитесь, что у вас есть следующее программное обеспечение на компьютере:

- [Microsoft Visual Studio 2013](https://www.microsoft.com/visualstudio/11/downloads#vs) или [Microsoft Visual Studio Express 2013 для Web](https://www.microsoft.com/visualstudio/11/downloads#express-web). Платформа .NET Framework устанавливается автоматически.
- Компания Wingtip Toys пример проекта, так что можно реализовать, упоминаемые в этом руководстве в проекте Wingtip Toys. Следующая ссылка предоставляет сведения о скачивании:

    - [Начало работы с ASP.NET 4.5.1 веб-формы - Wingtip Toys](https://go.microsoft.com/fwlink/?LinkID=389434&amp;clcid=0x409) (C#)
- До завершения этого учебника рекомендуется ознакомиться связанных руководств [Приступая к работе с веб-форм ASP.NET 4.5 и Visual Studio 2013](../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md). Серии руководств поможет вам ознакомиться с **WingtipToys** проекта и кода.

## <a name="connection-resiliency"></a>Устойчивость подключений

При выборе развертывания приложения в Windows Azure, попробуйте выполняет развертывание базы данных **Windows** **базы данных SQL Azure**, облачная служба баз данных. При подключении к облачная служба баз данных, чем при веб-сервер и сервер базы данных непосредственно соединены друг с другом в одном центре обработки данных, временных ошибок подключения обычно чаще. Даже если веб-сервер cloud и облачная служба баз данных размещаются в одном центре обработки данных, существуют дополнительные сетевые подключения между ними, которые могут возникнуть проблемы, такие как подсистемы балансировки нагрузки.

Также это облачная служба обычно совместно используется другими пользователями, это означает, что отклик может зависеть от их. И доступ к базе данных может быть подвергаются регулированию. Регулирование означает, что служба базы данных создает исключения, при попытке доступа к нему чаще, чем разрешено в вашей *соглашение об уровне обслуживания* (SLA).

Многие или большинство проблем подключения, возникающих при обращении к облачной службе являются временными, то есть они устранить самостоятельно за короткий период времени. Поэтому при попытке выполнения операции базы данных получить тип ошибки, обычно временное, можно попробовать операцию после короткого ожидания и операции может пройти успешно. Можно предоставить значительно удобней для пользователей, если обработка временных ошибок с автоматически повторить попытку, невидимую большинство из них для клиента. Функция устойчивости подключений в Entity Framework 6 автоматизирует, что процесс повторного не удалось выполнить SQL-запросов.

Функция устойчивости подключений должен быть настроен для определенной базы данных службы:

1. Он должен знать, какие исключения могут быть временными. Вы хотите повторить попытку ошибки, вызванные временная потеря в сетевое подключение не ошибки, например из-за ошибок программы.
2. Она должна ожидать соответствующий период времени между повторными попытками, сбой операции. Вы можете ожидать больше между повторными попытками для пакетной обработки, чем вы можете на интерактивной веб-странице, где пользователь ожидает ответа.
3. Он должен повторить попытку на соответствующее число раз, прежде чем прекратить попытки. Может потребоваться повторить несколько раз в рамках пакетного процесса, как в интерактивном приложении.

Можно настроить эти параметры вручную для любой среды базы данных, поддерживаемом поставщиком Entity Framework.

Вам нужно выполнить, чтобы включить устойчивость подключений — это создать класс, производный от сборки `DbConfiguration` и в этом классе укажите стратегии выполнения базы данных SQL, который в Entity Framework — другое название политики повторных попыток.

### <a name="implementing-connection-resiliency"></a>Реализация устойчивость подключений

1. Скачайте и откройте [WingtipToys](https://go.microsoft.com/fwlink/?LinkID=389434&amp;clcid=0x409) пример приложения веб-форм в Visual Studio.
2. В *логики* папке **WingtipToys** приложения, добавьте файл класса с именем *WingtipToysConfiguration.cs*.
3. Замените существующий код следующим кодом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample1.cs)]

Платформа Entity Framework автоматически выполняет код в класс, производный от `DbConfiguration`. Можно использовать `DbConfiguration` класса, чтобы выполнять задачи по настройке в коде, в противном случае это делается в *Web.config* файл. Дополнительные сведения см. в разделе [EntityFramework конфигурация на основе кода](https://msdn.microsoft.com/data/jj680699).

1. В *логики* откройте *AddProducts.cs* файла.
2. Добавить `using` инструкции для `System.Data.Entity.Infrastructure` , выделенный желтым цветом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample2.cs?highlight=6)]
3. Добавить `catch` блок `AddProduct` метод, чтобы `RetryLimitExceededException` регистрируется как в выделяется желтым цветом:   

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample3.cs?highlight=14-15,17-22)]

Добавив `RetryLimitExceededException` исключения, можно предоставить лучше ведения журнала или отображать сообщение об ошибке для пользователя, где они могут выбрать повторите процесс. Перехват `RetryLimitExceededException` исключение, только ошибки, скорее всего, будут временными будет уже были испытаны и не удалось несколько раз. Фактическое исключение, возвращенное будет вставлено в `RetryLimitExceededException` исключение. Кроме того вы также добавили общий блок catch. Дополнительные сведения о `RetryLimitExceededException` исключения, см. в разделе [Entity Framework Connection Resiliency / логика повторных попыток](https://msdn.microsoft.com/data/dn456835).

## <a name="command-interception"></a>Перехват команд

Теперь, когда вы включили политику повтора, как протестировать чтобы убедиться, что он работает должным образом? Это не так просто заставить временная ошибка происходит, особенно при работе локально, и было бы особенно трудно интегрировать фактическое временных ошибок в автоматизированные модульные тест. Чтобы протестировать функция устойчивости подключений, нужен способ перехватывать запросы, которые отправляет Entity Framework для SQL Server и замените типа исключения, которое обычно временное ответ от сервера SQL.

Перехват запросов также можно использовать для реализации рекомендации для облачных приложений: журнала, задержки и успешность всех вызовы к внешним службах, таких как службы баз данных.

В этом разделе руководства вы используете Entity Framework [ *механизма перехвата* ](https://msdn.microsoft.com/data/dn469464) для имитации временных ошибок и для ведения журнала.

### <a name="create-a-logging-interface-and-class"></a>Создайте класс и интерфейс ведения журнала

Для ведения журнала рекомендуется сделать это с помощью [ `interface` ](https://msdn.microsoft.com/library/ms173156.aspx) вместо того чтобы жестко программировать вызовы `System.Diagnostics.Trace` или класса ведения журнала. Что упрощает изменение вашего механизма ведения позже, если вы захотите это сделать. Поэтому в этом разделе вы создадите интерфейс ведения журнала и класс для его реализации.

Исходя из приведенного выше, загрузки и открыть **WingtipToys** пример приложения в Visual Studio.

1. Создайте папку в **WingtipToys** проект и назовите его *ведение журнала*.
2. В *ведение журнала* папке создайте файл класса с именем *ILogger.cs* и замените код по умолчанию следующим кодом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample4.cs)]

   Этот интерфейс предоставляет три уровня трассировки, чтобы указать относительную важность журналы и один, предоставляет сведения о задержке для внешней службы вызовы, такие как запросы к базе данных. Методы ведения журнала имеют перегрузки, которые позволяют передавать исключение. Это так, что сведения об исключении, включая стек трассировки и внутренние исключения надежно регистрируется классом, который реализует интерфейс, а не полагаться на который выполняется в каждом вызове метода ведения журнала в приложении.  
  
   `TraceApi` Методы позволяют отслеживать задержку каждого вызова определенной внешней службы, такие как базы данных SQL.
3. В *ведение журнала* папке создайте файл класса с именем *Logger.cs* и замените код по умолчанию следующим кодом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample5.cs)]

Реализация использует `System.Diagnostics` для выполнения трассировки. Это встроенная функция .NET, что позволяет легко создать и использовать данные трассировки. Существует много &quot;прослушиватели&quot; можно использовать с `System.Diagnostics` трассировки, записывать журналы к файлам, к примеру, или для записи их в хранилище больших двоичных объектов Windows Azure. Некоторые из вариантов, а также ссылки на другие ресурсы, Дополнительные сведения см. в [Устранение неполадок Windows Azure веб-сайтов в Visual Studio](https://docs.microsoft.com/azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio). В этом учебнике вы рассмотрим только журналы в Visual Studio **вывода** окна.

В рабочем приложении вы можете рассмотреть возможность использования платформы трассировки не `System.Diagnostics`и `ILogger` интерфейс позволяет относительно легко переключиться на механизм разных трассировки, если вы решили сделать это.

### <a name="create-interceptor-classes"></a>Создайте перехватчик классы

Далее вы создадите классы, которые Entity Framework будет вызывать каждый раз, когда оно для отправки запроса к базе данных для имитации временных ошибок и сделать ведения журнала. Эти классы перехватчик должен быть производным от `DbCommandInterceptor` класса. В них вы напишете переопределения методов, которые вызываются автоматически в том случае, когда запрос будет выполняться. В этих методах можно изучать или запрос, который отправляется в базу данных к журналу, а также можно изменить запрос перед отправкой в базу данных или возвращать результат Entity Framework самостоятельно без даже передача запроса к базе данных.

1. Чтобы создать класс перехватчик, которая будет записывать каждый запрос SQL, перед отправкой в базу данных, создайте файл класса с именем *InterceptorLogging.cs* в *логики* папку и замените значение по умолчанию код с Следующий код:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample6.cs)]

   Для успешно выполненных запросов или команд этот код записывает в журнал сведения с сведения о задержке. Для исключений он создает журнал ошибок.
2. Для создания класса-перехватчика, вызывающая фиктивный временных ошибок при вводе &quot;Throw&quot; в **имя** текстовое поле на странице с именем *AdminPage.aspx*, создайте класс файл с именем *InterceptorTransientErrors.cs* в *логики* папку и замените значение по умолчанию код следующим кодом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample7.cs)]

    Этот код только переопределения `ReaderExecuting` метод, который вызывается для запросов, которые могут возвращать несколько строк данных. Если вы хотите проверить устойчивость подключения для других типов запросов, можно также переопределить `NonQueryExecuting` и `ScalarExecuting` методы, как ведение журнала перехватчик.  
  
   Далее войдите в систему как «Admin» и выберите **администратора** ссылку на верхней панели навигации. Затем на *AdminPage.aspx* страницы, вы добавите продукт с именем &quot;Throw&quot;. Код создает исключение пустой базы данных SQL для номер ошибки 20, типом, известным обычно временной. Другие коды ошибок, момент опознаны как временные являются 64, 233, 10053, 10054, 10060, 10928, 10929, 40197, 40501 и 40613, но они могут быть изменены в новые версии базы данных SQL. Продукт будет переименован в «TransientErrorExample», можно выполнить в коде *InterceptorTransientErrors.cs* файла.  
  
   Код возвращает исключение в Entity Framework, вместо выполнения запроса и передачи результаты. Возвращается Временное исключение *четыре* раз, после чего восстанавливает код обычную процедуру передачи запроса к базе данных.

    Так как все, что в системе, вы сможете см. в разделе Entity Framework пытается выполнить запрос предшествовало в четыре раза, что в приложении отличается только что занимает больше времени для визуализации страницы с результатами запроса.  
  
   Количество раз, когда Entity Framework будет повторять попытку настраивается; код определяет четыре раза, потому что это значение по умолчанию для политики выполнения базы данных SQL. Если изменить политику выполнения, необходимо было также изменение здесь расположен код, указывает, сколько раз создаются временные ошибки. Можно также изменить код, чтобы создать дополнительные исключения, чтобы платформа Entity Framework вызывает исключение `RetryLimitExceededException` исключение.
3. В *Global.asax*, добавьте следующие операторы using:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample8.cs)]
4. Затем добавьте выделенные строки, чтобы `Application_Start` метод:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample9.cs?highlight=17-20)]

Эти строки кода являются, что вызывает перехватчик кода для запуска в том случае, когда Entity Framework отправляет запросы к базе данных. Обратите внимание, что так как вы создали отдельные перехватчик классы для имитации временных ошибок и ведение журнала, вы можете независимо друг от друга, включить или отключить их.   
  
 Можно добавить с помощью перехватчики `DbInterception.Add` метод в любом месте кода; он не должен быть в `Application_Start` метод. Другой вариант, если вы не добавляли перехватчики в `Application_Start` метод, можно обновить или добавить класс с именем *WingtipToysConfiguration.cs* и поместите приведенный выше код в конце конструктора `WingtipToysConfiguration` класса.

Везде, где поместить этот код, нужно избегать выполнения `DbInterception.Add` для же перехватчик более чем один раз, или вы получите дополнительные перехватчик экземпляров. Например если дважды добавить перехватчик ведения журнала, вы увидите два журнала для каждого запроса SQL.

Перехватчики выполняются в порядке регистрации (порядок, в котором `DbInterception.Add` вызывается метод). Порядок может имеет значения в зависимости от выполняемых задач в перехватчик. Например, перехватчик может изменить команду SQL, получаемый в `CommandText` свойство. Если это приводит к изменению команду SQL, далее перехватчик получите измененные команду SQL, не исходную команду SQL.

Вы написали код имитации временной ошибки способом, который позволяет вызывать временные ошибки, введя другое значение в пользовательском Интерфейсе. Кроме того можно написать код перехватчик всегда создать последовательность временных исключений без проверки на наличие значения определенного параметра. Затем вы сможете добавить перехватчик только в том случае, если вы хотите создавать временные ошибки. Если в этом случае не добавляйте перехватчик до после завершения инициализации базы данных. Другими словами выполните операции по крайней мере одна база данных, например запрос на одном из своего набора сущностей, перед началом создания временных ошибок. Платформа Entity Framework выполняет несколько запросов во время инициализации базы данных, и они не выполняются в транзакции, в случае ошибки во время инициализации может возникнуть контекст которого необходимо получить в несогласованное состояние.

## <a name="test-logging-and-connection-resiliency"></a>Тест ведения журнала и устойчивость подключений

1. В Visual Studio нажмите клавишу **F5** для запуска приложения в режиме отладки, а затем войдите в систему как «Admin», с помощью «word Pa$ $» в качестве пароля.
2. Выберите **администратора** на панели навигации вверху.
3. Введите новый продукт с именем «Throw» с подходящими описание, цену и изображение.
4. Нажмите клавишу **добавить продукт** кнопки.  
   Вы заметите, что браузер кажется зависает на несколько секунд, пока Entity Framework повторением запроса несколько раз. Первый Повтор происходит очень быстро, а затем увеличивает время ожидания перед каждой следующей попытки. Процесс больше ожидания перед каждым повтором называется *экспоненциального откладывания* .
5. Подождите, пока страницы больше не пытается загрузить.
6. Остановите проект и посмотреть на Visual Studio **вывода** окно, чтобы просмотреть выходные данные трассировки. Можно найти **вывода** окно, выбрав **Отладка**  - &gt; **Windows**  - &gt;  **Выходные данные**. Может потребоваться прокрутить за последние несколько другие журналы, сохраняемые в средство ведения журналов.  
  
   Обратите внимание на то, что вы видите фактические SQL-запросы, отправляемые в базу данных. Вы увидите некоторые начальные запросы и команды, которые выполняет платформа Entity Framework, чтобы приступить к работе, проверяя таблицу журнала версии и миграции базы данных.   
    ![Окно выходных данных](aspnet-web-forms-connection-resiliency-and-command-interception/_static/image1.png)   
   Обратите внимание на то, что нельзя повторите этот тест, если вы остановите приложение и перезапустите его. Если вы хотите иметь возможность тестировать устойчивость подключения несколько раз в рамках одного запуска приложения, можно написать код, чтобы сбросить счетчик ошибок в `InterceptorTransientErrors` .
7. Чтобы увидеть разницу стратегии выполнения (политика повтора) делает, комментарий `SetExecutionStrategy` строку в *WingtipToysConfiguration.cs* файл *логики* папку, запустите **администратора**  страницы в режиме отладки, еще раз и добавить продукт с именем &quot;Throw&quot; еще раз.  
  
   Это время отладчик останавливается на первой порожденное исключение немедленно в том случае, когда предпринимается попытка выполнения запроса в первый раз.  
    ![Отладка — Просмотр сведений](aspnet-web-forms-connection-resiliency-and-command-interception/_static/image2.png)
8. Раскомментируйте `SetExecutionStrategy` строку в *WingtipToysConfiguration.cs* файла.

## <a name="summary"></a>Сводка

В этом руководстве вы узнали, как изменить пример приложения веб-форм для поддержки устойчивость подключений и перехват команд.

## <a name="next-steps"></a>Следующие шаги

После просмотра устойчивость подключений и перехват команд в веб-форм ASP.NET, ознакомьтесь с разделом, веб-форм ASP.NET [асинхронных методов в ASP.NET 4.5](../performance-and-caching/using-asynchronous-methods-in-aspnet-45.md). Раздел будет основы создания асинхронных приложений веб-форм ASP.NET с помощью Visual Studio.
