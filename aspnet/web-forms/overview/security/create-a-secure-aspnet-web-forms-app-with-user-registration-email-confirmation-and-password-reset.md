---
uid: web-forms/overview/security/create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset
title: Создание безопасного приложения веб-форм ASP.NET с регистрацией пользователей, отправить по электронной почте подтверждение и сброс пароля (C#) | Документация Майкрософт
author: Erikre
description: Этот учебник показывает, как создавать приложения веб-форм ASP.NET с помощью регистрации пользователей, подтверждение по электронной почте и сбрасывать пароль с помощью элемента ASP.NET Identity...
ms.author: riande
ms.date: 10/02/2014
ms.assetid: 0a8d6044-5fab-4213-82d6-5618d5601358
msc.legacyurl: /web-forms/overview/security/create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset
msc.type: authoredcontent
ms.openlocfilehash: 3df728891103de9c8e461ab9507237c9b14e8251
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59390692"
---
# <a name="create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset-c"></a>Создание безопасного приложения веб-форм ASP.NET с регистрацией пользователей, подтверждением электронной почты и сбросом пароля (C#)

по [Erik Reitan](https://github.com/Erikre)

> Этом руководстве показано, как создать приложение веб-форм ASP.NET с помощью регистрации пользователей, подтверждение по электронной почте и сбрасывать пароль с помощью системы членства ASP.NET Identity. Этот учебник был основан на Рик Андерсон [руководство по MVC](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).


## <a name="introduction"></a>Вступление

Этот учебник поможет выполнить шаги, необходимые для создания приложения веб-форм ASP.NET с помощью Visual Studio и ASP.NET 4.5 для создания безопасного приложения веб-форм с регистрацией пользователей, отправить по электронной почте подтверждение и сброс пароля.

### <a name="tutorial-tasks-and-information"></a>Учебника по задачам и сведениям:

- [Создание веб-ASP.NET приложения форм](#createWebForms)
- [Подключить SendGrid](#SG)
- [Требуется подтверждение по электронной почте до входа](#require)
- [Восстановление пароля и сброс](#reset)
- [Повторно отправить ссылку для подтверждения по электронной почте](#rsend)
- [Устранение неполадок приложения](#dbg)
- [Дополнительные ресурсы](#addRes)

<a id="createWebForms"></a>
## <a name="create-an-aspnet-web-forms-app"></a>Создание приложения ASP.NET Web Forms

Начните с установки и запуска [Visual Studio Express 2013 для Web](https://go.microsoft.com/fwlink/?LinkId=299058) или [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566). Установка [Visual Studio 2013 с обновлением 3](https://go.microsoft.com/fwlink/?LinkId=390465) или более поздней версии также.

> [!NOTE]
> Предупреждение: Необходимо установить [Visual Studio 2013 с обновлением 3](https://go.microsoft.com/fwlink/?LinkId=390465) или более поздней версии для работы с этим руководством.


1. Создайте новый проект (**файл**  - &gt; **новый проект**) и выберите **веб-приложение ASP.NET** шаблона и последней версии .NET Framework версия из **новый проект** диалоговое окно.
2. Из **новый проект ASP.NET** выберите **веб-форм** шаблона. Оставьте проверку подлинности по умолчанию как **учетные записи отдельных пользователей**. Если вы хотите разместить приложение в Azure, оставьте **разместить в облаке** флажков.   
 Щелкните **ОК** для создания нового проекта.  
    ![Диалоговое окно "новый проект ASP.NET"](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image1.png)
3. Включите протокол Secure Sockets Layer (SSL) для проекта. Выполните действия, доступные в **включить SSL для проекта** раздел [Приступая к работе с веб-форм серии руководств](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#SSLWebForms).
4. Запустите приложение, нажмите кнопку **зарегистрировать** ссылку и зарегистрируйте нового пользователя. На этом этапе проверку только на адрес электронной почты на основе [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) атрибута, чтобы гарантировать, адрес электронной почты имеет правильный формат. Вы измените код, чтобы добавить подтверждение по электронной почте. Закройте окно браузера.
5. В **обозревателя серверов** из Visual Studio (**представление**  - &gt; **обозревателя серверов**), перейдите к **Connections\ данных DefaultConnection\Tables\AspNetUsers**, щелкните правой кнопкой мыши и выберите **откройте определение таблицы**. 

    На следующем рисунке показана `AspNetUsers` схема таблицы:

    ![Схема таблицы AspNetUsers](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image2.png)
6. В **обозревателя серверов**, щелкните правой кнопкой мыши **AspNetUsers** таблицы и выберите **Показать таблицу данных**.  
  
    ![Данные таблицы AspNetUsers](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image3.png)  
 На этом этапе для зарегистрированного пользователя адрес электронной почты не подтвержден.
7. Выберите в строке и выберите delete для удаления пользователя. Можно снова добавить на следующем шаге этот адрес электронной почты и отправить сообщение с подтверждением на адрес электронной почты.

## <a name="email-confirmation"></a>Подтверждение по электронной почте

Это рекомендуется, чтобы подтвердить адрес электронной почты во время регистрации нового пользователя для проверки того, они не выполняется олицетворение кто-то другой (то есть они еще не зарегистрировано другого пользователя по электронной почте). Предположим, что у вас есть дискуссионный форум, следует предотвратить `"bob@cpandl.com"` из регистрации в качестве `"joe@contoso.com"`. Без подтверждение по электронной почте `"joe@contoso.com"` удалось получить нежелательные сообщения электронной почты из приложения. Предположим, что Боб случайно зарегистрирован как `"bib@cpandl.com"` и не заметили, он не сможет использовать пароль восстановления, так как приложение не имеет правильное сообщение электронной почты. Подтверждение по электронной почте предоставляет ограниченную защиту от программ-роботов и не предоставляет защиту от определено отправителей нежелательной почты.

Обычно требуется запретить новым пользователям из учета данных для веб-сайта, прежде чем они были подтверждены либо электронная почта, SMS-сообщения или другой механизм. В следующих разделах мы включим подтверждение по электронной почте и измените код, чтобы предотвратить только что зарегистрированным пользователям войти в систему, пока не будет подтверждена доступ к электронной почте. В этом руководстве используется служба электронной почты SendGrid.

<a id="SG"></a>
## <a name="hook-up-sendgrid"></a>Подключить SendGrid

SendGrid изменилось его API, так как этот учебник написан. Актуальные инструкции SendGrid, см. в разделе [SendGrid](http://sendgrid.com/) или [включить учетную запись, пароль и Подтверждение восстановления](xref:security/authentication/accconfirm#enable-account-confirmation-and-password-recovery).

Несмотря на то, что этот учебник только показано, как добавить уведомление по электронной почте через [SendGrid](http://sendgrid.com/), вы можете отправить электронную почту с помощью SMTP и другие механизмы (см. в разделе [дополнительные ресурсы](#addRes)).

1. В Visual Studio откройте **консоль диспетчера пакетов** (**средства**  - &gt; **диспетчера пакетов NuGet**  - &gt; **Консоль диспетчера пакетов**) и введите следующую команду:  
    `Install-Package SendGrid`
2. Перейдите к [страницу регистрации Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) и зарегистрируйтесь для участия в учетной записи SendGrid. Вы можете также зарегистрироваться для бесплатной учетной записи SendGrid непосредственно на [SendGrid сайта](http://www.sendgrid.com).
3. Из **обозревателе решений** откройте *IdentityConfig.cs* файл в *приложения\_запустить* папку и добавьте следующий код, они выделены желтым цветом, чтобы `EmailService` класс для настройки **SendGrid**:

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample1.cs?highlight=3,5,8-37)]
4. Кроме того, добавьте следующий `using` инструкции в начало *IdentityConfig.cs* файла: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample2.cs?highlight=1-4)]
5. Для простоты в этом примере мы сохраним значения учетной записи службы электронной почты в `appSettings` раздел *web.config* файл. Добавьте следующий код XML, они выделены желтым цветом, чтобы *web.config* файл в корне проекта:

    [!code-xml[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample3.xml?highlight=2-5)]

    > [!WARNING]
    > Безопасность — никогда не сохраняйте конфиденциальные данные в исходном коде. В этом примере учетная запись и учетные данные хранятся в **appSetting** раздел *Web.config* файл. В Azure, вы можете безопасно хранить эти значения на **[Настройка](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** вкладка на портале Azure. Дополнительные сведения см. в разделе Рик Андерсон под названием [советы и рекомендации по развертыванию паролей и других конфиденциальных данных в ASP.NET и Azure](https://go.microsoft.com/fwlink/?LinkId=513141).
6. Добавьте значения службы электронной почты для отражения значения проверки подлинности SendGrid (имя пользователя и пароль) и чтобы пользователь мог успешно отправлять сообщения электронной почты из вашего приложения. Обязательно используйте имя учетной записи SendGrid, а не адрес электронной почты, предоставляемых SendGrid.

### <a name="enable-email-confirmation"></a>Включить подтверждение по электронной почте

 Чтобы включить подтверждение по электронной почте, вы измените код регистрации, следующим образом.  
 

1. В *учетной записи* откройте *Register.aspx.cs* кода и обновлять `CreateUser_Click` способ включения следующие выделенные изменения: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample4.cs?highlight=9-11)]
2. В **обозревателе решений**, щелкните правой кнопкой мыши *Default.aspx* и выберите **задать в качестве начальной страницы**.
3. Запустите приложение, нажав клавишу **F5.** Эта страница отображается, нажмите кнопку **зарегистрировать** ссылку на страницу регистрации.
4. Введите адрес электронной почты и пароль, а затем щелкните **зарегистрировать** кнопку, чтобы отправить сообщение электронной почты через SendGrid.  
   Текущее состояние проекта и кода позволит пользователю входить в систему после их заполните эту регистрационную форму, несмотря на то, что они еще не подтвержден своей учетной записью.
5. Проверьте учетную запись электронной почты и щелкните ссылку, чтобы подтвердить свой адрес электронной почты.  
   После отправки формы регистрации можно будет выполнить вход.  
    ![Пример веб-сайта — в системе](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image4.png)

<a id="require"></a>
## <a name="require-email-confirmation-before-log-in"></a>Требуется подтверждение по электронной почте до входа

Несмотря на то, что вы убедились, учетная запись электронной почты, на этом этапе вы не потребуется щелкнуть ссылку, содержащихся в сообщении проверки, чтобы быть полностью вошедшего в систему. В следующем разделе будет измените код так, чтобы новый пользователям иметь подтвержден по электронной почте, прежде чем они вошли (с проверкой подлинности).

1. В **обозревателе решений** Visual Studio, обновление `CreateUser_Click` событие в *Register.aspx.cs* кода программной части, содержащиеся в *учетные записи* папку с следующие выделенные изменения: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample5.cs?highlight=13-14,17-21)]
2. Обновление `LogIn` метод в *Login.aspx.cs* кода с следующие выделенные изменения: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample6.cs?highlight=9-19,45-46)]

### <a name="run-the-application"></a>Запуск приложения

 Теперь, когда вы реализовали код проверки, подтвержден ли адрес электронной почты пользователя, можно проверить функциональные возможности на обоих **зарегистрировать** и **входа** страниц. 

1. Удалить все учетные записи в **AspNetUsers** таблица, которая содержит псевдоним электронной почты, который вы хотите протестировать.
2. Запустите приложение (**F5**) и проверьте, не может зарегистрироваться как пользователь, пока вы подтвердили свой адрес электронной почты.
3. Перед тем как подтвердить учетную запись по электронной почте, которая была недавно отправлена, попытайтесь войти, используя новую учетную запись.  
 Вы увидите, что вы не можете выполнить вход и что вам необходима учетная запись подтверждена электронной почты.
4. После того как вы убедились, адрес электронной почты, войдите в приложение.

<a id="reset"></a>
## <a name="password-recovery-and-reset"></a>Восстановление пароля и сброс

1. В Visual Studio, удалите символы комментария из `Forgot` метод в *Forgot.aspx.cs* кода программной части, содержащиеся в *учетной записи* папки, таким образом, чтобы метод отображается в виде ниже: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample7.cs?highlight=16-18)]
2. Откройте *Login.aspx* страницы. Замените существующую разметку ближе к концу **loginForm** разделе, как показано ниже: 

    [!code-aspx[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample8.aspx?highlight=52-53)]
3. Откройте *Login.aspx.cs* кода и раскомментируйте следующую строку кода, выделена желтым из `Page_Load` обработчик событий: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample9.cs?highlight=5)]
4. Запустите приложение, нажав клавишу **F5.** Эта страница отображается, нажмите кнопку **вход** ссылку.
5. Нажмите кнопку **забыли пароль?** ссылку, чтобы отобразить **забытый пароль** страницы.
6. Введите адрес электронной почты и нажмите кнопку **отправить** кнопку, чтобы отправить сообщение электронной почты на адрес, который вы сможете сбросить свой пароль.   
   Проверьте учетную запись электронной почты и щелкните ссылку для отображения **сброс пароля** страницы.
7. На **сброс пароля** введите ваш адрес электронной почты, пароль и подтвердите пароль. Затем нажмите клавишу **Сброс** кнопки.  
   Когда вы успешно сбросить свой пароль, **пароль изменен** будет отображена страница. Теперь можно войти, используя новый пароль.

<a id="rsend"></a>
## <a name="resend-email-confirmation-link"></a>Повторно отправить ссылку для подтверждения по электронной почте

Когда пользователь создает новую учетную запись локального, по электронной почте ссылку для подтверждения, они необходимы для использования, прежде чем они могут войти на. Если пользователь случайно удалил подтверждение по электронной почте или никогда не приходит сообщение электронной почты, им потребуется повторная отправка ссылку для подтверждения. Следующие изменения кода показано, как для этого.

1. В Visual Studio откройте **Login.aspx.cs** кода программной части и добавьте следующий обработчик событий после `LogIn` обработчик событий:   

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample10.cs)]
2. Изменить `LogIn` обработчик событий в *Login.aspx.cs* кода путем изменения кода, выделены желтым цветом, следующим образом: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample11.cs?highlight=15-17)]
3. Обновление *Login.aspx* страницы путем добавления кода, выделены желтым цветом, следующим образом: 

    [!code-aspx[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample12.aspx?highlight=45-46)]
4. Удалить все учетные записи в **AspNetUsers** таблица, которая содержит псевдоним электронной почты, который вы хотите протестировать.
5. Запустите приложение (**F5**) и зарегистрировать свой адрес электронной почты.
6. Перед тем как подтвердить учетную запись по электронной почте, которая была недавно отправлена, попытайтесь войти, используя новую учетную запись.  
   Вы увидите, что вы не можете выполнить вход и что вам необходима учетная запись подтверждена электронной почты. Кроме того теперь можно переслать сообщение с подтверждением учетную запись электронной почты.
7. Введите свой адрес электронной почты и пароль, затем нажмите клавишу **повторно отправить подтверждение** кнопки.
8. После того как вы убедились ваш адрес электронной почты, на основе отправленных по электронной почте сообщения, войдите в приложение.

<a id="dbg"></a>
## <a name="troubleshooting-the-app"></a>Устранение неполадок приложения

Если вы не получите сообщение электронной почты, содержащее ссылку, чтобы проверить учетные данные:

- Проверьте папку нежелательной или Нежелательная почта.
- Войдите в учетную запись SendGrid и выберите [действия по электронной почте ссылку](https://sendgrid.com/logs/index).
- Убедитесь, вы использовали имя пользователя учетной записи SendGrid как *Web.config* преимущества, а не адрес электронной почты учетной записи SendGrid.

<a id="addRes"></a>
## <a name="additional-resources"></a>Дополнительные ресурсы

- [Рекомендуемые ресурсы по ссылкам в ASP.NET Identity](../../../identity/overview/getting-started/aspnet-identity-recommended-resources.md)
- [Подтверждение учетной записи и восстановление пароля в ASP.NET Identity](../../../identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity.md)
- [Серии руководств веб-форм ASP.NET - Добавление поставщика OAuth 2.0](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#OAuthWebForms)
- [Развертывание безопасного веб-форм приложение ASP.NET с членством, OAuth и базой данных SQL в службе приложений Azure](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-deploy-aspnet-webforms-app-membership-oauth-sql-database/)
- [ASP.NET Web Forms серии руководств — включить SSL для проекта](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#SSLWebForms)
