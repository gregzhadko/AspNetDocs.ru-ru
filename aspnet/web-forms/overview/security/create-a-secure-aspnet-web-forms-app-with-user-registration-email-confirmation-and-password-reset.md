---
uid: web-forms/overview/security/create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset
title: Создание безопасного приложения веб-форм ASP.NET с регистрацией пользователя, подтверждением электронной почты иC#сбросом пароля () | Документация Майкрософт
author: Erikre
description: В этом руководстве показано, как создать приложение веб-форм ASP.NET с регистрацией пользователя, подтверждением электронной почты и сбросом пароля с помощью члена ASP.NET Identity...
ms.author: riande
ms.date: 10/02/2014
ms.assetid: 0a8d6044-5fab-4213-82d6-5618d5601358
msc.legacyurl: /web-forms/overview/security/create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset
msc.type: authoredcontent
ms.openlocfilehash: af3653bc164810126bc3bf8f1b1794d75642d807
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78507132"
---
# <a name="create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset-c"></a>Создание безопасного приложения веб-форм ASP.NET с регистрацией пользователей, подтверждением электронной почты и сбросом пароля (C#)

по [Эрик Реитан](https://github.com/Erikre)

> В этом руководстве показано, как создать приложение веб-форм ASP.NET с регистрацией пользователя, подтверждением электронной почты и сбросом пароля с помощью системы членства ASP.NET Identity. Это руководство основано на [руководстве по MVC](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md)в Рик Андерсон (.

## <a name="introduction"></a>Введение

В этом руководстве описано, как создать приложение веб-форм ASP.NET с помощью Visual Studio и ASP.NET 4,5, чтобы создать защищенное приложение веб-форм с регистрацией пользователей, подтверждением электронной почты и сбросом пароля.

### <a name="tutorial-tasks-and-information"></a>Задачи и сведения в учебнике:

- [Создание приложения веб-форм ASP.NET](#createWebForms)
- [Подключение SendGrid](#SG)
- [Требовать подтверждение по электронной почте перед входом](#require)
- [Восстановление и сброс пароля](#reset)
- [Ссылка для подтверждения повторной отправки по электронной почте](#rsend)
- [Устранение неполадок приложения](#dbg)
- [Дополнительные ресурсы](#addRes)

<a id="createWebForms"></a>
## <a name="create-an-aspnet-web-forms-app"></a>Создание приложения веб-форм ASP.NET

Начните с установки и запуска [Visual Studio Express 2013 для Web](https://go.microsoft.com/fwlink/?LinkId=299058) или [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566). Установите [Visual Studio 2013 обновление 3](https://go.microsoft.com/fwlink/?LinkId=390465) или более поздней версии.

> [!NOTE]
> Предупреждение. для работы с этим руководством необходимо установить [Visual Studio 2013 обновление 3](https://go.microsoft.com/fwlink/?LinkId=390465) или более поздней версии.

1. Создайте новый проект (**файл** -&gt; **Новый проект**) и выберите шаблон **веб-приложение ASP.NET** и последнюю версию .NET Framework в диалоговом окне **Новый проект** .
2. В диалоговом окне **Новый проект ASP.NET** выберите шаблон **веб-формы** . Оставьте проверку подлинности по умолчанию как **учетные записи отдельных пользователей**. Если вы хотите разместить приложение в Azure, оставьте установленным флажок **узел в облаке** .   
 Затем нажмите кнопку **ОК** , чтобы создать новый проект.  
    ![Диалоговое окно "Новый проект ASP.NET"](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image1.png)
3. Включите SSL (SSL) для проекта. Выполните действия, описанные в разделе **Включение SSL для проекта** статьи [учебник начало работы with Web Forms](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#SSLWebForms).
4. Запустите приложение, щелкните ссылку **Register (регистрация** ) и зарегистрируйте нового пользователя. На этом этапе единственная проверка по электронной почте основана на атрибуте [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) , чтобы убедиться, что адрес электронной почты имеет правильный формат. Вы измените код, чтобы добавить подтверждение по электронной почте. Закройте окно браузера.
5. В **Обозреватель сервера** Visual Studio (**View** -&gt; **Обозреватель сервера**) перейдите к **коннектионс\дефаултконнектион\таблес\аспнетусерс данных**, щелкните правой кнопкой мыши и выберите **Открыть определение таблицы**. 

    На следующем рисунке показана схема таблицы `AspNetUsers`:

    ![Схема таблицы AspNetUsers](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image2.png)
6. В **Обозреватель сервера**щелкните правой кнопкой мыши таблицу **AspNetUsers** и выберите команду **отобразить данные таблицы**.  
  
    ![Данные таблицы AspNetUsers](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image3.png)  
 На этом этапе электронная почта зарегистрированного пользователя не подтверждена.
7. Щелкните строку и выберите Удалить, чтобы удалить пользователя. Вы снова добавите это сообщение электронной почты на следующем шаге и отправите на адрес электронной почты сообщение с подтверждением.

## <a name="email-confirmation"></a>Подтверждение по электронной почте

Рекомендуется подтвердить сообщение электронной почты во время регистрации нового пользователя, чтобы убедиться, что он не олицетворяет кого-то другого (то есть они не зарегистрированы в электронной почте). Предположим, у вас есть дискуссионный форум, и вы хотели бы предотвратить регистрацию `"bob@cpandl.com"` как `"joe@contoso.com"`. Без подтверждения по электронной почте `"joe@contoso.com"` может получить от приложения нежелательную почту. Предположим, что Боб случайно зарегистрировался как `"bib@cpandl.com"` и не заметил его, он не сможет использовать восстановление пароля, так как у приложения нет нужной электронной почты. Подтверждение электронной почты обеспечивает только ограниченную защиту от программы-роботы и не обеспечивает защиту от определенных отправителей.

Обычно требуется запретить новым пользователям отправлять данные на веб-сайт, прежде чем они будут подтверждены электронной почтой, SMS-сообщением или другим механизмом. В следующих разделах мы допустили подтверждение по электронной почте и изменим код, чтобы предотвратить вход новых зарегистрированных пользователей до подтверждения их электронной почты. В этом руководстве вы будете использовать службу электронной почты SendGrid.

<a id="SG"></a>
## <a name="hook-up-sendgrid"></a>Подключение SendGrid

SendGrid изменил API, так как этот учебник написан. Текущие инструкции SendGrid см. в разделе [SendGrid](http://sendgrid.com/) или [Включение подтверждения учетной записи и восстановление пароля](xref:security/authentication/accconfirm#enable-account-confirmation-and-password-recovery).

Хотя в этом учебнике показано, как добавлять уведомления по электронной почте через [SendGrid](http://sendgrid.com/), можно отправлять электронную почту с помощью SMTP и других механизмов (см. [Дополнительные ресурсы](#addRes)).

1. В Visual Studio откройте **консоль диспетчера пакетов** (**средства** -&gt; диспетчер **пакетов NuGet** -&gt; **консоли диспетчера пакетов**) и введите следующую команду:  
    `Install-Package SendGrid`
2. Перейдите на [страницу регистрации Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) и зарегистрируйтесь для бесплатной учетной записи SendGrid. Вы также можете зарегистрироваться для бесплатной учетной записи SendGrid непосредственно на [сайте SendGrid](http://www.sendgrid.com).
3. В **Обозреватель решений** откройте файл *IdentityConfig.CS* в папке *app\_Start* и добавьте следующий код, выделенный желтым цветом в класс `EmailService` для настройки **SendGrid**:

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample1.cs?highlight=3,5,8-37)]
4. Кроме того, добавьте следующие `using` операторы в начало файла *IdentityConfig.CS* : 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample2.cs?highlight=1-4)]
5. Чтобы не усложнять этот пример, вы храните значения учетной записи службы электронной почты в разделе `appSettings` файла *Web. config* . Добавьте следующий код XML, выделенный желтым цветом, в файл *Web. config* в корне проекта:

    [!code-xml[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample3.xml?highlight=2-5)]

    > [!WARNING]
    > Безопасность — никогда не храните конфиденциальные данные в исходном коде. В этом примере учетная запись и учетные данные хранятся в разделе **appSetting** файла *Web. config* . В Azure эти значения можно безопасно сохранить на вкладке **[Настройка](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** в портал Azure. Дополнительные сведения см. в разделе Рик Андерсон (, озаглавленном рекомендации [по развертыванию паролей и других конфиденциальных данных в ASP.NET и Azure](https://go.microsoft.com/fwlink/?LinkId=513141).
6. Добавьте значения службы электронной почты, чтобы они отражали значения проверки подлинности SendGrid (имя пользователя и пароль), чтобы можно было успешно отправлять электронную почту из приложения. Не забудьте использовать имя учетной записи SendGrid, а не адрес электронной почты, предоставленный SendGrid.

### <a name="enable-email-confirmation"></a>Включить подтверждение электронной почты

 Чтобы включить подтверждение по электронной почте, измените регистрационный код, выполнив следующие действия.  

1. В папке *Account* Откройте код программной части *Register.aspx.CS* и обновите метод `CreateUser_Click`, чтобы включить следующие выделенные изменения: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample4.cs?highlight=9-11)]
2. В **Обозреватель решений**щелкните правой кнопкой мыши *Default. aspx* и выберите **задать в качестве начальной страницы**.
3. Запустите приложение, нажав клавишу **F5.** После отображения страницы щелкните ссылку **Регистрация** , чтобы отобразить страницу Регистрация.
4. Введите свой адрес электронной почты и пароль, а затем нажмите кнопку **Register (зарегистрировать** ), чтобы отправить сообщение электронной почты через SendGrid.  
   Текущее состояние проекта и кода позволит пользователю выполнить вход после заполнения регистрационной формы, даже если они не подтвердили свою учетную запись.
5. Проверьте учетную запись электронной почты и щелкните ссылку, чтобы подтвердить свою электронную почту.  
   После отправки регистрационной формы вы войдете в систему.  
    ![Пример веб-сайта — вход выполнен](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/_static/image4.png)

<a id="require"></a>
## <a name="require-email-confirmation-before-log-in"></a>Требовать подтверждение по электронной почте перед входом

Хотя вы подтвердили учетную запись электронной почты, на этом этапе вам не нужно щелкать ссылку, содержащуюся в электронном письме с подтверждением, для полного входа. В следующем разделе вы измените код, требующий, чтобы новые пользователи имели подтвержденное сообщение электронной почты, прежде чем они будут входить в систему (с проверкой подлинности).

1. В **Обозреватель решений** Visual Studio обновите событие `CreateUser_Click` в коде программной части *Register.aspx.CS* , который содержится в папке *Accounts* со следующими выделенными изменениями: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample5.cs?highlight=13-14,17-21)]
2. Обновите метод `LogIn` *в коде программной части,* выделив следующие изменения: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample6.cs?highlight=9-19,45-46)]

### <a name="run-the-application"></a>Запуск приложения

 Теперь, когда вы реализовали код для проверки того, подтвержден ли адрес электронной почты пользователя, можно проверить функциональность на страницах **Регистрация** и **Вход** в систему. 

1. Удалите все учетные записи в таблице **AspNetUsers** , содержащие псевдоним электронной почты, который нужно протестировать.
2. Запустите приложение (**F5**) и убедитесь, что вы не можете зарегистрироваться в качестве пользователя, пока не подтвердите свой адрес электронной почты.
3. Перед подтверждением новой учетной записи через отправленное сообщение электронной почты попытайтесь войти в систему с помощью новой учетной записи.  
 Вы увидите, что вы не можете войти в систему и у вас должна быть подтвержденная учетная запись электронной почты.
4. После подтверждения адреса электронной почты войдите в приложение.

<a id="reset"></a>
## <a name="password-recovery-and-reset"></a>Восстановление и сброс пароля

1. В Visual Studio удалите символы комментариев из метода `Forgot` в коде программной части *Forgot.aspx.CS* , который содержится в папке *Account* , чтобы метод был представлен следующим образом: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample7.cs?highlight=16-18)]
2. Откройте страницу *Login. aspx* . Замените разметку рядом с концом раздела **loginForm** , как показано ниже: 

    [!code-aspx[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample8.aspx?highlight=52-53)]
3. Откройте код программной части *Login.aspx.CS* и раскомментируйте следующую строку кода, выделенную желтым цветом, из обработчика событий `Page_Load`: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample9.cs?highlight=5)]
4. Запустите приложение, нажав клавишу **F5.** После отображения страницы щелкните ссылку **Вход** .
5. Щелкните ссылку **забыли пароль?** , чтобы отобразить страницу **забытый пароль** .
6. Введите свой адрес электронной почты и нажмите кнопку " **Отправить** ", чтобы отправить сообщение электронной почты на ваш адрес, что позволит сбросить пароль.   
   Проверьте учетную запись электронной почты и щелкните ссылку, чтобы отобразить страницу **сброса пароля** .
7. На странице **Сброс пароля** введите адрес электронной почты, пароль и подтверждение пароля. Затем нажмите кнопку **Reset (Сброс** ).  
   При успешном сбросе пароля будет отображаться страница **изменения пароля** . Теперь вы можете войти в систему, используя новый пароль.

<a id="rsend"></a>
## <a name="resend-email-confirmation-link"></a>Ссылка для подтверждения повторной отправки по электронной почте

После того как пользователь создает новую локальную учетную запись, он отправляет по электронной почте ссылку на подтверждение, которую необходимо использовать, прежде чем они смогут войти в систему. Если пользователь случайно удалил сообщение электронной почты с подтверждением или сообщение не будет доставлено, ему потребуется снова отправить ссылку на подтверждение. В следующем примере кода показано, как это сделать.

1. В Visual Studio откройте код программной части **Login.aspx.CS** и добавьте следующий обработчик событий после обработчика событий `LogIn`:   

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample10.cs)]
2. Измените обработчик событий `LogIn` в коде программной части *Login.aspx.CS* , изменив код, выделенный желтым цветом, следующим образом: 

    [!code-csharp[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample11.cs?highlight=15-17)]
3. Обновите страницу *Login. aspx* , добавив код, выделенный желтым цветом, следующим образом: 

    [!code-aspx[Main](create-a-secure-aspnet-web-forms-app-with-user-registration-email-confirmation-and-password-reset/samples/sample12.aspx?highlight=45-46)]
4. Удалите все учетные записи в таблице **AspNetUsers** , содержащие псевдоним электронной почты, который нужно протестировать.
5. Запустите приложение (**F5**) и зарегистрируйте свой адрес электронной почты.
6. Перед подтверждением новой учетной записи через отправленное сообщение электронной почты попытайтесь войти в систему с помощью новой учетной записи.  
   Вы увидите, что вы не можете войти в систему и у вас должна быть подтвержденная учетная запись электронной почты. Кроме того, теперь можно повторно отправить сообщение с подтверждением в учетную запись электронной почты.
7. Введите свой адрес электронной почты и пароль, а затем нажмите кнопку **повторно отправить подтверждение** .
8. После подтверждения адреса электронной почты на основе недавно отправленного сообщения электронной почты войдите в приложение.

<a id="dbg"></a>
## <a name="troubleshooting-the-app"></a>Устранение неполадок приложения

Если вы не получаете электронное сообщение со ссылкой для проверки учетных данных:

- Проверьте папку нежелательной почты или спама.
- Войдите в учетную запись SendGrid и щелкните [ссылку действие электронной почты](https://sendgrid.com/logs/index).
- Убедитесь, что вы использовали имя учетной записи пользователя SendGrid в качестве значения *Web. config* , а не адреса электронной почты вашей учетной записи SendGrid.

<a id="addRes"></a>
## <a name="additional-resources"></a>Дополнительные ресурсы

- [Ссылки на ASP.NET Identity Рекомендуемые ресурсы](../../../identity/overview/getting-started/aspnet-identity-recommended-resources.md)
- [Подтверждение учетной записи и восстановление пароля с ASP.NET Identity](../../../identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity.md)
- [Серия руководств по веб-формам ASP.NET. Добавление поставщика OAuth 2,0](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#OAuthWebForms)
- [Развертывание безопасного приложения веб-форм ASP.NET с членством, OAuth и базой данных SQL в службе приложений Azure](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-deploy-aspnet-webforms-app-membership-oauth-sql-database/)
- [Серия руководств по веб-формам ASP.NET. Включение SSL для проекта](../getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal.md#SSLWebForms)
