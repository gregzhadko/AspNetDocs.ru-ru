---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/working-with-computed-columns-cs
title: Работа с вычисленными столбцамиC#() | Документация Майкрософт
author: rick-anderson
description: При создании таблицы базы данных Microsoft SQL Server позволяет определить вычисляемый столбец, значение которого вычисляется из выражения, которое обычно референ...
ms.author: riande
ms.date: 08/03/2007
ms.assetid: 57459065-ed7c-4dfe-ac9c-54c093abc261
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/working-with-computed-columns-cs
msc.type: authoredcontent
ms.openlocfilehash: ad6a96f2721510c2478f707c8eed018ae797f27a
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74603473"
---
# <a name="working-with-computed-columns-c"></a>Работа с вычисляемыми столбцами (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_71_CS.zip) или [скачать PDF](working-with-computed-columns-cs/_static/datatutorial71cs1.pdf)

> При создании таблицы базы данных Microsoft SQL Server позволяет определить вычисляемый столбец, значение которого вычисляется на основе выражения, которое обычно ссылается на другие значения в той же записи базы данных. Такие значения доступны только для чтения в базе данных, что требует особых рекомендаций при работе с адаптерами таблиц. В этом учебнике мы научитесь решать проблемы, связанные с вычисленными столбцами.

## <a name="introduction"></a>Введение

Microsoft SQL Server допускает *[вычисляемые столбцы](https://msdn.microsoft.com/library/ms191250.aspx)* , которые представляют собой столбцы, значения которых вычисляются из выражения, которое обычно ссылается на значения из других столбцов в той же таблице. Например, модель данных отслеживания времени может иметь таблицу с именем `ServiceLog` со столбцами, включая `ServicePerformed`, `EmployeeID`, `Rate`и `Duration`, среди прочих. Хотя сумма оплаты за единицу обслуживания (умноженная на длительность) может быть вычислена через веб-страницу или другой программный интерфейс, может оказаться полезным включить в таблицу `ServiceLog` столбец с именем `AmountDue`, который сообщил об этой информации. Этот столбец может быть создан в виде обычного столбца, но его необходимо обновлять всякий раз, когда изменились `Rate` или `Duration` значения столбцов. Лучшим подходом является создание `AmountDue` столбца вычисляемого столбца с помощью `Rate * Duration`выражения. Это приведет к тому, что SQL Server автоматически вычислит `AmountDue` значение столбца при каждом обращении в запросе.

Поскольку значение вычисляемого столбца определяется выражением, такие столбцы доступны только для чтения и поэтому не могут иметь присвоенные значения в операторах `INSERT` и `UPDATE`. Однако если вычисленные столбцы являются частью основного запроса для TableAdapter, использующего специальные инструкции SQL, они автоматически включаются в автоматически создаваемые `INSERT` и `UPDATE` инструкции. Таким образом, для удаления ссылок на все вычисленные столбцы необходимо обновить `INSERT`ные и `UPDATE`ные запросы TableAdapter, а также свойства `InsertCommand` и `UpdateCommand`.

Одна из проблем использования вычисленных столбцов с TableAdapter, использующих специальные инструкции SQL, заключается в том, что адаптеры `INSERT` и `UPDATE` автоматически создаются повторно при каждом завершении работы мастера настройки TableAdapter. Поэтому вычисленные столбцы, вручную удаленные из `INSERT` и `UPDATE` запросы, будут снова отображаться при повторном запуске мастера. Хотя адаптеры таблиц, использующие хранимые процедуры, не страдает от этого хрупкости, они имеют свои собственные особенности, которые мы будем решать на шаге 3.

В этом учебнике мы добавим вычисляемый столбец в таблицу `Suppliers` базы данных Northwind, а затем создадим соответствующий адаптер TableAdapter для работы с этой таблицей и ее вычисляемым столбцом. Наш адаптер TableAdapter будет использовать хранимые процедуры вместо специальных инструкций SQL, чтобы наши настройки не были потеряны при использовании мастера настройки адаптера таблицы.

Давайте приступим к работе!

## <a name="step-1-adding-a-computed-column-to-thesupplierstable"></a>Шаг 1. Добавление вычисляемого столбца в таблицу`Suppliers`

База данных «Борей» не имеет ни одного вычисленного столбца, поэтому нам нужно будет добавить ее. В этом руководстве мы добавим вычисляемый столбец в таблицу `Suppliers` с именем `FullContactName`, которая возвращает имя контактного лица, название и компанию, в которой они работают, в следующем формате: `ContactName` (`ContactTitle`, `CompanyName`). Этот вычисляемый столбец может использоваться в отчетах при отображении сведений о поставщиках.

Для начала откройте определение таблицы `Suppliers`, щелкнув правой кнопкой мыши таблицу `Suppliers` в обозреватель сервера и выбрав Открыть определение таблицы в контекстном меню. В результате будут отображены столбцы таблицы и их свойства, например тип данных, разрешены ли `NULL` s и т. д. Чтобы добавить вычисляемый столбец, начните с ввода имени столбца в определение таблицы. Затем введите его выражение в текстовое поле (формула) в разделе спецификация вычисляемого столбца окно свойств столбца (см. рис. 1). Присвойте вычисляемому столбцу имя `FullContactName` и используйте следующее выражение:

[!code-sql[Main](working-with-computed-columns-cs/samples/sample1.sql)]

Обратите внимание, что строки можно объединить в SQL с помощью оператора `+`. Оператор `CASE` может использоваться как условный в традиционном языке программирования. В приведенном выше выражении оператор `CASE` можно считать следующим образом: Если `ContactTitle` не `NULL` то выводит значение `ContactTitle`, объединенное с запятой, в противном случае ничего не выдает. Дополнительные сведения о целесообразности оператора `CASE` см. [в разделе возможности SQL `CASE`](http://www.4guysfromrolla.com/webtech/102704-1.shtml).

> [!NOTE]
> Вместо использования оператора `CASE` здесь можно было бы использовать `ISNULL(ContactTitle, '')`. [`ISNULL(checkExpression, replacementValue)`](https://msdn.microsoft.com/library/ms184325.aspx) возвращает *чеккекспрессион* , если он не равен null, в противном случае возвращает *replacementValue*. Хотя `ISNULL` или `CASE` будут работать в этом экземпляре, существуют более сложные сценарии, в которых гибкость оператора `CASE` не может быть сопоставлена с `ISNULL`.

После добавления этого вычисляемого столбца экран должен выглядеть, как на снимке экрана на рис. 1.

[![добавить вычисляемый столбец с именем Фуллконтактнаме в таблицу «Поставщики»](working-with-computed-columns-cs/_static/image2.png)](working-with-computed-columns-cs/_static/image1.png)

**Рис. 1**. Добавление вычисляемого столбца с именем `FullContactName` в таблицу `Suppliers` ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image3.png))

После именования вычисляемого столбца и ввода его выражения сохраните изменения в таблице, щелкнув значок сохранить на панели инструментов, нажав клавиши CTRL + S или выбрав пункт Сохранить `Suppliers`в меню файл.

При сохранении таблицы необходимо обновить обозреватель сервера, включая только что добавленный столбец в списке столбцов `Suppliers` таблица. Кроме того, выражение, вводимое в текстовое поле (формула), автоматически подстраивается к эквивалентному выражению, которое приводит к ненужным пробелам, заключает имена столбцов в квадратные скобки (`[]`) и включает круглые скобки для более четкого отображения порядка операций:

[!code-sql[Main](working-with-computed-columns-cs/samples/sample2.sql)]

Дополнительные сведения о вычисленных столбцах в Microsoft SQL Server см. в [технической документации](https://msdn.microsoft.com/library/ms191250.aspx). Кроме того, ознакомьтесь со [статьей практическое руководство. Указание вычисленных столбцов](https://msdn.microsoft.com/library/ms188300.aspx) для пошагового руководства по созданию вычисленных столбцов.

> [!NOTE]
> По умолчанию вычисляемые столбцы физически не хранятся в таблице, а пересчитываются при каждом обращении к ним в запросе. При установке флажка является материализованным, однако можно указать SQL Server физически сохранить вычисляемый столбец в таблице. Это позволяет создать индекс для вычисляемого столбца, что может повысить производительность запросов, использующих значение вычисляемого столбца в своих `WHERE` предложениях. Дополнительные сведения см. [в разделе Создание индексов на рассчитанных столбцах](https://msdn.microsoft.com/library/ms189292.aspx) .

## <a name="step-2-viewing-the-computed-column-s-values"></a>Шаг 2. Просмотр значений вычисляемого столбца

Прежде чем начать работу на уровне доступа к данным, потратьте минуту, чтобы просмотреть значения `FullContactName`. В обозреватель сервера щелкните правой кнопкой мыши `Suppliers` имя таблицы и выберите в контекстном меню команду Создать запрос. Откроется окно запроса, в котором мы предложим выбрать таблицы для включения в запрос. Добавьте таблицу `Suppliers` и нажмите кнопку Закрыть. Затем проверьте столбцы `CompanyName`, `ContactName`, `ContactTitle`и `FullContactName` из таблицы Поставщики. Наконец, щелкните значок красного восклицательного знака на панели инструментов, чтобы выполнить запрос и просмотреть результаты.

Как показано на рис. 2, результаты включают `FullContactName`, в котором перечислены столбцы `CompanyName`, `ContactName`и `ContactTitle` в формате ldquo;`ContactName` (`ContactTitle`, `CompanyName`).

[![Фуллконтактнаме использует формат ContactName (Контакттитле, CompanyName).](working-with-computed-columns-cs/_static/image5.png)](working-with-computed-columns-cs/_static/image4.png)

**Рис. 2**. `FullContactName` использует формат `ContactName` (`ContactTitle`, `CompanyName`) ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image6.png))

## <a name="step-3-adding-thesupplierstableadapterto-the-data-access-layer"></a>Шаг 3. Добавление`SuppliersTableAdapter`к слою доступа к данным

Чтобы работать со сведениями о поставщиках в нашем приложении, необходимо сначала создать TableAdapter и DataTable в DAL. В идеале это можно сделать с помощью тех же простых действий, которые были проверены в предыдущих учебных курсах. Однако работа с вычисленными столбцами вводит несколько вринклес, которые проводят обсуждение.

При использовании TableAdapter, использующего специальные инструкции SQL, можно просто включить вычисляемый столбец в основной запрос TableAdapter s с помощью мастера настройки адаптера таблицы. Однако это автоматически создаст `INSERT` и `UPDATE` инструкции, включающие вычисляемый столбец. При попытке выполнить один из этих методов `SqlException` с сообщением, что столбец *ColumnName* не может быть изменен, поскольку это либо вычисляемый столбец, либо результат выполнения оператора UNION. Хотя `INSERT` и `UPDATE` можно вручную настроить с помощью свойств TableAdapter s `InsertCommand` и `UpdateCommand`, эти настройки будут потеряны при повторном запуске мастера настройки адаптера таблицы.

Из-за хрупкости адаптеров таблиц, использующих специальные инструкции SQL, рекомендуется использовать хранимые процедуры при работе с вычисленными столбцами. Если вы используете существующие хранимые процедуры, просто настройте TableAdapter, как описано в статье [использование существующих хранимых процедур для адаптеров таблиц с типом DataSet s](using-existing-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) . Если мастер TableAdapter создает хранимые процедуры для вас, важно сначала опустить все вычисленные столбцы из основного запроса. Если включить вычисляемый столбец в основной запрос, мастер настройки адаптера таблицы сообщит, что после завершения не сможет создать соответствующие хранимые процедуры. Вкратце, нам нужно сначала настроить TableAdapter с помощью вычисляемого основного запроса без столбца, а затем вручную обновить соответствующую хранимую процедуру и `SelectCommand` TableAdapter, чтобы включить вычисляемый столбец. Этот подход аналогичен тому, который использовался в руководстве по [обновлению адаптера таблицы TableAdapter для использования](updating-the-tableadapter-to-use-joins-cs.md)`JOIN`*s* .

В этом руководстве мы добавим новый адаптер TableAdapter и автоматически создадим хранимые процедуры для нас. Следовательно, необходимо сначала опустить `FullContactName` вычисляемый столбец из основного запроса.

Сначала откройте набор данных `NorthwindWithSprocs` в папке `~/App_Code/DAL`. Щелкните правой кнопкой мыши в конструкторе и в контекстном меню выберите Добавить новый адаптер таблицы. Запустится мастер настройки адаптера таблицы. Укажите базу данных для запроса данных (`NORTHWNDConnectionString` из `Web.config`) и нажмите кнопку Далее. Так как мы еще не создали хранимые процедуры для запроса или изменения таблицы `Suppliers`, выберите параметр создать новые хранимые процедуры, чтобы мастер создаст их для нас, и нажмите кнопку Далее.

[![выберите параметр создать новые хранимые процедуры.](working-with-computed-columns-cs/_static/image8.png)](working-with-computed-columns-cs/_static/image7.png)

**Рис. 3**. Выбор параметра "создать новые хранимые процедуры" ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image9.png))

На следующем шаге мы предложим ввести основной запрос. Введите следующий запрос, который возвращает столбцы `SupplierID`, `CompanyName`, `ContactName`и `ContactTitle` для каждого поставщика. Обратите внимание, что этот запрос намеренно опускает вычисляемый столбец (`FullContactName`); будет обновлена соответствующая хранимая процедура для включения этого столбца на шаге 4.

[!code-sql[Main](working-with-computed-columns-cs/samples/sample3.sql)]

После ввода основного запроса и нажатия кнопки Далее мастер позволяет присвоить имя четыре хранимых процедурах, которые будут созданы. Назовите эти хранимые процедуры `Suppliers_Select`, `Suppliers_Insert`, `Suppliers_Update`и `Suppliers_Delete`, как показано на рис. 4.

[![настроить имена автоматически создаваемых хранимых процедур](working-with-computed-columns-cs/_static/image11.png)](working-with-computed-columns-cs/_static/image10.png)

**Рис. 4**. Настройка имен автоматически создаваемых хранимых процедур ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image12.png))

Следующий шаг мастера позволяет присвоить имя методам TableAdapter и указать шаблоны, используемые для доступа к данным и их обновления. Оставьте все три флажка установленными, но переименуйте метод `GetData` в `GetSuppliers`. Чтобы завершить работу мастера, нажмите кнопку Готово.

[![переименование метода GetData в поставщики](working-with-computed-columns-cs/_static/image14.png)](working-with-computed-columns-cs/_static/image13.png)

**Рис. 5**. Переименование метода `GetData` в `GetSuppliers` ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image15.png))

После нажатия кнопки Готово мастер создаст четыре хранимых процедуры и добавит TableAdapter и соответствующий объект DataTable в типизированный набор данных.

## <a name="step-4-including-the-computed-column-in-the-tableadapter-s-main-query"></a>Шаг 4. Включение вычисляемого столбца в основной запрос TableAdapter s

Теперь необходимо обновить TableAdapter и DataTable, созданные на шаге 3, чтобы включить `FullContactName` вычисляемый столбец. Это действие состоит из двух этапов:

1. Обновление `Suppliers_Select` хранимой процедуры для получения `FullContactName` вычисляемого столбца;
2. Обновление таблицы данных для включения соответствующего столбца `FullContactName`.

Начните с перехода к обозреватель сервера и углублением в папку хранимых процедур. Откройте `Suppliers_Select` хранимую процедуру и обновите запрос `SELECT`, включив в него `FullContactName` вычисляемый столбец:

[!code-sql[Main](working-with-computed-columns-cs/samples/sample4.sql)]

Сохраните изменения в хранимой процедуре, щелкнув значок сохранить на панели инструментов, нажав клавиши CTRL + S или выбрав пункт Сохранить `Suppliers_Select` в меню файл.

Затем вернитесь в конструктор наборов данных, щелкните правой кнопкой мыши `SuppliersTableAdapter`и выберите в контекстном меню пункт Настроить. Обратите внимание, что столбец `Suppliers_Select` теперь содержит столбец `FullContactName` в коллекции столбцов данных.

[![запуске мастера настройки TableAdapter для обновления столбцов DataTable s](working-with-computed-columns-cs/_static/image17.png)](working-with-computed-columns-cs/_static/image16.png)

**Рис. 6**. Запуск мастера настройки адаптеров таблиц для обновления столбцов DataTable ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image18.png))

Чтобы завершить работу мастера, нажмите кнопку Готово. При этом соответствующий столбец будет автоматически добавлен в `SuppliersDataTable`. Мастер TableAdapter достаточно интеллектуально для определения того, что столбец `FullContactName` является вычисляемым и, следовательно, доступен только для чтения. Следовательно, он устанавливает для свойства Column `ReadOnly` значение `true`. Чтобы проверить это, выберите столбец из `SuppliersDataTable` а затем перейдите к окно свойств (см. рис. 7). Обратите внимание, что свойства `FullContactName` столбцов `DataType` и `MaxLength` также заданы соответствующим образом.

[![столбец Фуллконтактнаме помечен как "только для чтения"](working-with-computed-columns-cs/_static/image20.png)](working-with-computed-columns-cs/_static/image19.png)

**Рис. 7**. столбец `FullContactName` помечен как "только для чтения" ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image21.png))

## <a name="step-5-adding-agetsupplierbysupplieridmethod-to-the-tableadapter"></a>Шаг 5. Добавление метода`GetSupplierBySupplierID`в TableAdapter

В этом учебнике мы создадим страницу ASP.NET, в которой будут отображаться поставщики в обновляемой сетке. В прошлых учебных курсах мы обновили одну запись из уровня бизнес-логики, извлекая эту конкретную запись из DAL в виде строго типизированной таблицы данных, обновляя ее свойства, а затем отправляя обновленную таблицу данных обратно в DAL для распространения изменений в база данных. Чтобы выполнить этот первый шаг, нужно получить запись, обновляемую из DAL. необходимо сначала добавить в DAL метод `GetSupplierBySupplierID(supplierID)`.

Щелкните правой кнопкой мыши `SuppliersTableAdapter` в конструкторе набора данных и выберите в контекстном меню пункт Добавить запрос. Как мы делали на шаге 3, позвольте мастеру создать новую хранимую процедуру для нас, выбрав параметр создать новую хранимую процедуру (см. рис. 3 на снимке экрана этого шага мастера). Поскольку этот метод возвращает запись с несколькими столбцами, укажите, что нам нужно использовать SQL-запрос, который возвращает строки, и нажмите кнопку Далее.

[![выберите параметр выбрать, возвращающий строки.](working-with-computed-columns-cs/_static/image23.png)](working-with-computed-columns-cs/_static/image22.png)

**Рис. 8**. Выбор параметра выбор возвращающих строк ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image24.png))

На следующем шаге мы предложим ввести запрос для использования в этом методе. Введите следующую запись, которая возвращает те же поля данных, что и основной запрос, но для конкретного поставщика.

[!code-sql[Main](working-with-computed-columns-cs/samples/sample5.sql)]

На следующем экране запрашивается имя хранимой процедуры, которая будет создана автоматически. Назовите эту хранимую процедуру `Suppliers_SelectBySupplierID` и нажмите кнопку Далее.

[![имя хранимой процедуры Suppliers_SelectBySupplierID](working-with-computed-columns-cs/_static/image26.png)](working-with-computed-columns-cs/_static/image25.png)

**Рис. 9**. присвойте хранимой процедуре имя `Suppliers_SelectBySupplierID` ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image27.png))

Наконец, мастер запрашивает у нас шаблоны доступа к данным и имена методов для использования в TableAdapter. Оставьте оба флажка установленными, но переименуйте `FillBy` и `GetDataBy` методы в `FillBySupplierID` и `GetSupplierBySupplierID`соответственно.

[![назовите методы TableAdapter Филлбисупплиерид и Жетсупплиербисупплиерид.](working-with-computed-columns-cs/_static/image29.png)](working-with-computed-columns-cs/_static/image28.png)

**Рис. 10**. Именование методов TableAdapter `FillBySupplierID` и `GetSupplierBySupplierID` ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image30.png))

Чтобы завершить работу мастера, нажмите кнопку Готово.

## <a name="step-6-creating-the-business-logic-layer"></a>Шаг 6. Создание уровня бизнес-логики

Перед созданием страницы ASP.NET, использующей вычисляемый столбец, созданный на шаге 1, сначала необходимо добавить соответствующие методы в BLL. Наша страница ASP.NET, которая будет создана на шаге 7, позволит пользователям просматривать и изменять поставщиков. Таким образом, нам нужно, чтобы наш BLL предоставил, как минимум, метод для получения всех поставщиков и другого для обновления конкретного поставщика.

Создайте новый файл класса с именем `SuppliersBLLWithSprocs` в папке `~/App_Code/BLL` и добавьте следующий код:

[!code-csharp[Main](working-with-computed-columns-cs/samples/sample6.cs)]

Как и в других классах BLL, `SuppliersBLLWithSprocs` имеет свойство `protected` `Adapter`, которое возвращает экземпляр класса `SuppliersTableAdapter` вместе с двумя методами `public`: `GetSuppliers` и `UpdateSupplier`. Метод `GetSuppliers` вызывает и возвращает `SuppliersDataTable`, возвращенный соответствующим методом `GetSupplier` в слое доступа к данным. Метод `UpdateSupplier` извлекает сведения об определенном поставщике, который обновляется посредством вызова метода DAL s `GetSupplierBySupplierID(supplierID)`. Затем он обновляет свойства `CategoryName`, `ContactName`и `ContactTitle` и фиксирует эти изменения в базе данных, вызывая метод доступа к данным уровня s `Update`, передавая измененный объект `SuppliersRow`.

> [!NOTE]
> За исключением `SupplierID` и `CompanyName`, все столбцы в таблице «поставщики» допускают значения `NULL`. Таким образом, если переданные параметры `contactName` или `contactTitle` `null` необходимо установить соответствующие свойства `ContactName` и `ContactTitle` для `NULL` значения базы данных с помощью методов `SetContactNameNull` и `SetContactTitleNull` соответственно.

## <a name="step-7-working-with-the-computed-column-from-the-presentation-layer"></a>Шаг 7. Работа с вычисляемым столбцом на уровне представления

Если вычисляемый столбец добавлен в таблицу `Suppliers`, а DAL и BLL обновлены соответствующим образом, мы готовы к созданию страницы ASP.NET, которая работает с вычисляемым столбцом `FullContactName`. Для начала откройте страницу `ComputedColumns.aspx` в папке `AdvancedDAL` и перетащите элемент управления GridView с панели инструментов в конструктор. Задайте для свойства `ID` GridView s значение `Suppliers` и из его смарт-тега привяжите его к новому ObjectDataSource с именем `SuppliersDataSource`. Настройте ObjectDataSource для использования класса `SuppliersBLLWithSprocs`, добавленного на шаге 6, и нажмите кнопку Далее.

[![настроить ObjectDataSource для использования класса Супплиерсбллвисспрокс](working-with-computed-columns-cs/_static/image32.png)](working-with-computed-columns-cs/_static/image31.png)

**Рис. 11**. Настройка ObjectDataSource для использования класса `SuppliersBLLWithSprocs` ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image33.png))

В классе `SuppliersBLLWithSprocs` определены только два метода: `GetSuppliers` и `UpdateSupplier`. Убедитесь, что эти два метода указаны на вкладках выбор и обновление соответственно, и нажмите кнопку Готово, чтобы завершить настройку ObjectDataSource.

После завершения работы мастера настройки источника данных Visual Studio добавит BoundField для каждого возвращаемого поля данных. Удалите `SupplierID` BoundField и измените свойства `HeaderText` `CompanyName`, `ContactName`, `ContactTitle`и `FullContactName` BoundFields на "компания", "имя контакта", "заголовок" и "полное имя контакта" соответственно. В смарт-теге установите флажок Enable Edit (включить редактирование), чтобы включить встроенные возможности редактирования GridView s.

Помимо добавления BoundFields в GridView, завершение работы мастера источников данных также приводит к тому, что Visual Studio устанавливает свойство `OldValuesParameterFormatString` ObjectDataSource s в исходное\_{0}. Верните этот параметр к значению по умолчанию {0}.

После внесения этих изменений в GridView и ObjectDataSource их декларативная разметка должна выглядеть следующим образом:

[!code-aspx[Main](working-with-computed-columns-cs/samples/sample7.aspx)]

Затем перейдите на эту страницу в браузере. Как показано на рис. 12, каждый поставщик перечислен в сетке, которая содержит столбец `FullContactName`, значение которого является просто объединением других трех столбцов, отформатированных как `ContactName` (`ContactTitle`, `CompanyName`).

[![каждый поставщик указан в сетке](working-with-computed-columns-cs/_static/image35.png)](working-with-computed-columns-cs/_static/image34.png)

**Рис. 12**. Каждый поставщик отображается в сетке ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image36.png))

Нажатие кнопки "Изменить" для конкретного поставщика вызывает обратную передачу и отрисовывает эту строку в интерфейсе редактирования (см. рис. 13). Первые три столбца отображаются в интерфейсе редактирования по умолчанию — элемент управления TextBox, для свойства `Text` которого задано значение поля данных. Однако столбец `FullContactName` остается в виде текста. Когда BoundFields был добавлен в GridView после завершения работы мастера настройки источника данных, свойству `FullContactName` BoundField `ReadOnly` s было присвоено значение `true`, так как для соответствующего `FullContactName` столбца в `SuppliersDataTable` свойство `ReadOnly` имеет значение `true`. Как отмечалось на шаге 4, свойству `FullContactName` s `ReadOnly` было присвоено значение `true`, поскольку TableAdapter обнаружил, что столбец был вычисляемым столбцом.

[![столбец Фуллконтактнаме недоступен для редактирования](working-with-computed-columns-cs/_static/image38.png)](working-with-computed-columns-cs/_static/image37.png)

**Рис. 13**. столбец `FullContactName` недоступен для редактирования ([щелкните, чтобы просмотреть изображение с полным размером](working-with-computed-columns-cs/_static/image39.png))

Обновите значение одного или нескольких редактируемых столбцов и нажмите кнопку "Обновить". Обратите внимание, что значение `FullContactName` s автоматически обновляется, чтобы отразить изменение.

> [!NOTE]
> В настоящее время GridView использует BoundFields для редактируемых полей, что приводит к интерфейсу редактирования по умолчанию. Так как поле `CompanyName` является обязательным, оно должно быть преобразовано в TemplateField, включающее RequiredFieldValidator. Я оставлю это в качестве упражнения для заинтересованного читателя. Пошаговые инструкции по преобразованию BoundField в TemplateField и добавлению элементов управления проверки см. в руководстве [Добавление элементов управления проверки в интерфейсы правки и вставки](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md) .

## <a name="summary"></a>Сводка

При определении схемы для таблицы Microsoft SQL Server позволяет включать в нее вычисленные столбцы. Это столбцы, значения которых рассчитываются из выражения, которое обычно ссылается на значения из других столбцов в той же записи. Поскольку значения для вычисленных столбцов основаны на выражении, они доступны только для чтения и им нельзя присвоить значение в `INSERT` или `UPDATE` инструкции. Это приводит к проблемам при использовании вычисляемого столбца в основном запросе адаптера таблицы TableAdapter, который пытается автоматически формировать соответствующие инструкции `INSERT`, `UPDATE`и `DELETE`.

В этом учебнике мы обсуждали методы обхода проблем, вызванных вычисленными столбцами. В частности, мы использовали хранимые процедуры в нашем TableAdapter для преодоления хрупкости, встроенных в адаптеры TableAdapter, которые используют специальные инструкции SQL. При создании новых хранимых процедур с помощью мастера TableAdapter важно, чтобы основной запрос изначально не пропустил все вычисленные столбцы, так как их присутствие не позволит создавать хранимые процедуры модификации данных. После первоначальной настройки TableAdapter можно повторно включить в его `SelectCommand` хранимую процедуру, включив в нее все вычисленные столбцы.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого учебника были Хилтон Жеисенов и Терезой Мерфи. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](adding-additional-datatable-columns-cs.md)
> [Вперед](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs.md)
