---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/debugging-stored-procedures-cs
title: Отладка хранимых процедур (C#) | Документация Майкрософт
author: rick-anderson
description: Выпуски Visual Studio Professional и Team System позволяют задавать точки останова и будут хранимых процедур в SQL Server, упрощая отладку хранимых...
ms.author: riande
ms.date: 08/03/2007
ms.assetid: c655c324-2ffa-4c21-8265-a254d79a693d
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/debugging-stored-procedures-cs
msc.type: authoredcontent
ms.openlocfilehash: 9ac206edee58542ced24ce89adc3393d7a3c1c37
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59392174"
---
# <a name="debugging-stored-procedures-c"></a>Отладка хранимых процедур (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_74_CS.zip) или [скачать PDF](debugging-stored-procedures-cs/_static/datatutorial74cs1.pdf)

> Выпуски Visual Studio Professional и Team System позволяют задавать точки останова и будут хранимых процедур в SQL Server, упрощая отладку хранимых процедур, так же просто, как и отладка кода приложения. В этом учебнике показано прямой отладки базы данных и хранимых процедур отладки приложения.


## <a name="introduction"></a>Вступление

Visual Studio предоставляет широкие возможности отладки. С несколько нажатия клавиш и щелчки мышью его можно использовать точки останова для остановки выполнения программы и проверить его состояние и контроль потока s. А также отладки кода приложения, Visual Studio предлагает поддержку для отладки хранимых процедур в SQL Server. Так же, как можно установить точки останова в коде класса фонового кода ASP.NET или класс уровня бизнес-логики, поэтому слишком они помещены в хранимых процедурах.

В этом руководстве мы рассмотрим шаг с заходом в хранимые процедуры из обозревателя серверов в Visual Studio также как установить точки останова, которые обнаруживаются когда хранимая процедура вызывается из работающего приложения ASP.NET.

> [!NOTE]
> К сожалению хранимые процедуры можно только возможно пошаговое выполнение и отладка через Professional и Team Systems версиях Visual Studio. Если вы используете Visual Web Developer или стандартной версии Visual Studio, можно также читать дальше мы рассмотрим действия, необходимые для отладки хранимых процедур, но вы не сможете выполнить эти шаги на вашем компьютере.


## <a name="sql-server-debugging-concepts"></a>Основные понятия отладки на SQL Server

Microsoft SQL Server 2005 была разработана для обеспечения интеграции с [Common Language Runtime (CLR)](https://msdn.microsoft.com/netframework/aa497266.aspx), который является среда выполнения для всех сборок .NET. Следовательно SQL Server 2005 поддерживает управляемые объекты базы данных. То есть можно создать объекты базы данных, таких как хранимые процедуры и определяемые пользователем функции (UDF) как методы в классе C#. Благодаря этому эти хранимые процедуры и определяемые пользователем функции использовать функции в .NET Framework и из пользовательских классов. Само собой SQL Server 2005 также обеспечивает поддержку для объектов базы данных T-SQL.

SQL Server 2005 предлагает поддержку отладки для T-SQL и управляемых объектов базы данных. Тем не менее эти объекты можно отлаживать только через выпуски Visual Studio 2005 Professional и Team систем. В этом руководстве мы рассмотрим отладки объектов базы данных T-SQL. Последующие руководства рассматривается отладки управляемых объектов базы данных.

[Общие сведения о T-SQL и отладки среды CLR в SQL Server 2005](https://blogs.msdn.com/sqlclr/archive/2006/06/29/651644.aspx) запись в блоге от [интеграция со средой CLR SQL Server 2005 команды](https://blogs.msdn.com/sqlclr/default.aspx) рассказывает о трех способах отладки объектов SQL Server 2005 из Visual Studio:

- **Прямая отладка базы данных (DDD)** — из обозревателя серверов, мы выполнить пошаговую отладку любой объект базы данных T-SQL, например хранимые процедуры и определяемые пользователем функции. Мы рассмотрим DDD на шаге 1.
- **Отладка приложений** -можно установить точки останова в объекте базы данных и затем запустить наше приложение ASP.NET. При выполнении объекта базы данных, будет достигнута точка останова и управления переворачиваются к отладчику. Обратите внимание на то, что с отладкой приложения мы недоступны для пошаговой объекта базы данных из кода приложения. Нам необходимо явно задать точки останова в этих хранимых процедур или определяемых пользователем функций разместим останов отладчика. Отладка приложения исследуется начиная с шага 2.
- **Отладку из проекта SQL Server** -выпуски Visual Studio Professional и Team Systems включают тип проекта SQL Server, который обычно используется для создания управляемых объектов базы данных. Мы рассмотрим использование проектов SQL Server и отладки их содержимое в следующем учебном курсе.

Visual Studio поддерживает отладку хранимых процедур на локальных и удаленных экземплярах SQL Server. Локальный экземпляр SQL Server — это приложения, установленного на одном компьютере с Visual Studio. Если базы данных SQL Server, которую вы используете не находится на компьютере разработки, он считается удаленный экземпляр. В этих учебниках мы использовали локальные экземпляры SQL Server. Отладка хранимых процедур на удаленном экземпляре SQL server требует дополнительных шагов настройки, чем при отладке хранимых процедур на локальном экземпляре.

Если вы используете локальный экземпляр SQL Server, можно начать с шага 1 и работать с этим руководством, до конца. Если вы используете удаленный экземпляр SQL Server, тем не менее, вы будете сначала нужно убедиться, что при отладке вы вошли на свой компьютер разработки, используя учетную запись пользователя Windows, имеющей имя входа SQL Server на удаленном экземпляре. Кроме того, как это имя входа базы данных, так и базы данных имя входа, используемое для подключения к базе данных из работающего приложения ASP.NET должны быть членами `sysadmin` роли. См. в разделе Отладка объектов базы данных T-SQL на раздел удаленных экземпляров в конце этого руководства, Дополнительные сведения о настройке Visual Studio и SQL Server для отладки на удаленном экземпляре.

Наконец понять, что поддержку отладки для объектов базы данных T-SQL не как богатыми возможностями, как поддержку отладки для приложений .NET. Например, условий точки останова и фильтров не поддерживаются, только подмножество диалоговых окон отладки доступны, нельзя использовать изменить и продолжить, окно "Интерпретация" отображается бесполезны и т. д. См. в разделе [ограничения на команды и функции отладчика](https://msdn.microsoft.com/library/ms165035(VS.80).aspx) Дополнительные сведения.

## <a name="step-1-directly-stepping-into-a-stored-procedure"></a>Шаг 1. Непосредственно шаг с заходом в хранимую процедуру

Visual Studio позволяет легко выполнять прямую отладку объектов базы данных. Позвольте s рассмотрим, как использовать функцию прямой отладки базы данных (DDD) выполнять шаги с заходом `Products_SelectByCategoryID` хранимой процедуры в базе данных "Борей". Как понятно из названия, `Products_SelectByCategoryID` возвращает сведения о продукте в определенной категории; он был создан в [существующих хранимых процедур для адаптеров таблиц TableAdapter типизированного набора DataSet s](using-existing-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) руководства. Запуск, перейдя в проводник по серверам и разверните узел базы данных "Борей". Затем углубиться в папке Stored Procedures, щелкните правой кнопкой мыши `Products_SelectByCategoryID` хранимую процедуру и выберите параметр шаг в хранимую процедуру в контекстном меню. Будет запущен отладчик.

Так как `Products_SelectByCategoryID` ожидает, что хранимая процедура `@CategoryID` входного параметра, мы будет предложено ввести его. Введите 1, что будут возвращены сведения о напитков.


![Используйте значение 1 для @CategoryID параметр](debugging-stored-procedures-cs/_static/image1.png)

**Рис. 1**: Используйте значение 1 для `@CategoryID` параметр


После предоставления значение `@CategoryID` параметра, хранимая процедура выполняется. Однако вместо запуска до завершения, отладчик останавливает выполнение на первой инструкции. Обратите внимание, желтая стрелка на поле, указывающее текущее расположение в хранимой процедуре. Можно просмотреть и изменить значения параметров в окне контрольных значений, так и навести указатель мыши на имя параметра в хранимой процедуре.


[![Tон отладчика остановлена на первой инструкции хранимой процедуры](debugging-stored-procedures-cs/_static/image3.png)](debugging-stored-procedures-cs/_static/image2.png)

**Рис. 2**: Произошла остановка отладчика на первой инструкции хранимой процедуры ([Просмотр полноразмерного изображения](debugging-stored-procedures-cs/_static/image4.png))


Чтобы приступить к выполнению хранимой процедуры одной инструкции одновременно, нажмите кнопку "Шаг с обходом" на панели инструментов или нажмите клавишу F10. `Products_SelectByCategoryID` Хранимая процедура содержит единственный `SELECT` инструкции, поэтому обращения F10 будет шаг с обходом одной инструкции и завершения выполнения хранимой процедуры. После завершения хранимой процедуры ее выходные данные будут отображаться в окне вывода и отладчик будет завершена.

> [!NOTE]
> Отладку T-SQL происходит на уровне инструкций; недоступны для пошаговой `SELECT` инструкции.


## <a name="step-2-configuring-the-website-for-application-debugging"></a>Шаг 2. Настройка веб-сайт для отладки приложения

Несмотря на то отладку хранимой процедуры, непосредственно из проводника, удобно во многих сценариях нас интересуют более отладку хранимой процедуры, при вызове из приложения ASP.NET. Мы можно добавить контрольные точки в хранимую процедуру из среды Visual Studio и затем запустить отладку приложения ASP.NET. При вызове хранимой процедуры с точками останова из приложения, выполнение будет остановлено в точке останова, и мы просмотреть и изменить значения параметров хранимой процедуры s и пошаговое выполнение его операторов, как мы это делали на шаге 1.

Прежде чем можно приступать к отладке хранимых процедур, вызывается из приложения, необходимо указать веб-приложение ASP.NET для интеграции с помощью отладчика SQL Server. Запустите правой кнопкой мыши на имя веб-сайта в обозревателе решений (`ASPNET_Data_Tutorial_74_CS`). Параметр страницы свойств в контекстном меню, выберите элемент "Параметры запуска" в левой части, а также установите флажок SQL Server в разделе отладчики (см. рис. 3).


[![CПроверка флажок SQL Server в приложение s страницы свойств](debugging-stored-procedures-cs/_static/image6.png)](debugging-stored-procedures-cs/_static/image5.png)

**Рис. 3**: Установите флажок SQL Server в приложение s страницы свойств ([Просмотр полноразмерного изображения](debugging-stored-procedures-cs/_static/image7.png))


Кроме того нам нужно обновить строку подключения базы данных, используемых приложением, таким образом, чтобы пул подключений отключен. При закрытии соединения с базой данных, соответствующий `SqlConnection` объект помещается в пул доступных подключений. При установлении соединения с базой данных, доступное соединение объекта могут быть получены из этого пула вместо того, чтобы создать и установить новое подключение. Объединения в пул объектов подключения в целях улучшения производительности и включена по умолчанию. Тем не менее при отладке необходимо отключить пулы соединений, так как инфраструктура отладки не восстанавливается правильно при работе с подключением, который был сделан из пула.

Чтобы пул соединений отключено, обновите `NORTHWNDConnectionString` в `Web.config` таким образом, чтобы он включал параметр `Pooling=false` .


[!code-xml[Main](debugging-stored-procedures-cs/samples/sample1.xml)]

> [!NOTE]
> После завершения отладки SQL Server через приложение ASP.NET не забудьте возобновить организация пулов соединений, удалив `Pooling` Azure с помощью строки подключения (или при установке для него `Pooling=true` ).


На этом этапе приложение ASP.NET настроена чтобы разрешить Visual Studio для отладки объектов базы данных SQL Server, при вызове через веб-приложения. Теперь остается лишь добавить точку останова в хранимую процедуру и начните отладку!

## <a name="step-3-adding-a-breakpoint-and-debugging"></a>Шаг 3. Добавление точки останова и отладка

Откройте `Products_SelectByCategoryID` хранимой процедуры и установите точку останова в начале `SELECT` инструкции, щелкнув в поле в соответствующее место или поместив курсор в начале `SELECT` инструкции и нажав клавишу F9. Как показано на рис. 4, точка останова отображается в виде красного круга в поле.


[![Sзадать точку останова в Products_SelectByCategoryID хранимой процедуры](debugging-stored-procedures-cs/_static/image9.png)](debugging-stored-procedures-cs/_static/image8.png)

**Рис. 4**: Установите точку останова в `Products_SelectByCategoryID` хранимой процедуры ([Просмотр полноразмерного изображения](debugging-stored-procedures-cs/_static/image10.png))


Чтобы объект базы данных SQL для отладки через клиентское приложение крайне важно, что база данных быть настроена для поддержки отладки приложения. При первой установке точки останова, этот параметр автоматически должно быть включено, но лучше еще раз проверьте. Щелкните правой кнопкой мыши `NORTHWND.MDF` узла в обозревателе сервера. В контекстном меню должно включать checked команды отладки приложения.


![Убедитесь, что включен параметр отладки приложения](debugging-stored-procedures-cs/_static/image11.png)

**Рис. 5**: Убедитесь, что включен параметр отладки приложения


С набором точек останова и отладка приложения включен параметр мы готовы выполнить отладку хранимой процедуры, при вызове из приложения ASP.NET. Запустите отладчик, выбрав в меню "Отладка" и выбрав начать отладку, нажав клавишу F5 или щелкните зеленый значок воспроизведения на панели инструментов. Это будет Запустите отладчик и запустите веб-сайта.

`Products_SelectByCategoryID` Хранимая процедура была создана в [существующих хранимых процедур для адаптеров таблиц TableAdapter типизированного набора DataSet s](using-existing-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) руководства. Его соответствующей веб-страницы (`~/AdvancedDAL/ExistingSprocs.aspx`) содержит GridView, отображающий результаты, возвращаемые этой хранимой процедуры. Посетите эту страницу в браузере. При достижении странице точки останова в `Products_SelectByCategoryID` хранимая процедура будет достигнута и системы управления версиями вернул в Visual Studio. Так же, как на шаге 1, можно пошагово s инструкции хранимой процедуры и представления и измените значения параметров.


[![TИзначально он ExistingSprocs.aspx страница отображает напитков](debugging-stored-procedures-cs/_static/image13.png)](debugging-stored-procedures-cs/_static/image12.png)

**Рис. 6**: `ExistingSprocs.aspx` Страницы изначально отображает напитков ([Просмотр полноразмерного изображения](debugging-stored-procedures-cs/_static/image14.png))


[![Tон хранимой процедуры s точка останова был достигнут](debugging-stored-procedures-cs/_static/image16.png)](debugging-stored-procedures-cs/_static/image15.png)

**Рис. 7**: Хранимая процедура s, достигнута точка останова ([Просмотр полноразмерного изображения](debugging-stored-procedures-cs/_static/image17.png))


Как показано на рис. 7, значение в окно Watch `@CategoryID` параметр имеет значение 1. Это обусловлено `ExistingSprocs.aspx` страницы изначально отображает продукты в категории «Напитки», который имеет `CategoryID` значение 1. Выберите другую категорию в раскрывающемся списке. Это вызывает обратную передачу и повторно выполняет `Products_SelectByCategoryID` хранимой процедуры. Точка останова достигается снова, но на этот раз `@CategoryID` выбранного раскрывающегося элемента списка s отражает значение параметра s `CategoryID`.


[![CВыберите другую категорию из раскрывающегося списка](debugging-stored-procedures-cs/_static/image19.png)](debugging-stored-procedures-cs/_static/image18.png)

**Рис. 8**: Выберите другую категорию в раскрывающемся списке ([Просмотр полноразмерного изображения](debugging-stored-procedures-cs/_static/image20.png))


[![Tон @CategoryID параметр отражает в категории, выбранные на странице веб](debugging-stored-procedures-cs/_static/image22.png)](debugging-stored-procedures-cs/_static/image21.png)

**Рис. 9**: `@CategoryID` Параметр отражает в категории, выбранные из веб-страницы ([Просмотр полноразмерного изображения](debugging-stored-procedures-cs/_static/image23.png))


> [!NOTE]
> Если точка останова в `Products_SelectByCategoryID` хранимая процедура не будет достигнута при посещении `ExistingSprocs.aspx` убедитесь, что SQL Server флажок в разделе отладчики s страница свойств приложения ASP.NET, что была организация пулов соединений отключения и включения базы данных s параметр отладки приложения. Если вы по-прежнему возникли проблемы, перезапустите Visual Studio и повторите попытку.


## <a name="debugging-t-sql-database-objects-on-remote-instances"></a>Отладка объектов баз данных T-SQL в удаленных экземплярах

Отладка объектов баз данных с помощью Visual Studio, достаточно просто, когда экземпляр базы данных SQL Server находится на одном компьютере с Visual Studio. Тем не менее если SQL Server и Visual Studio, находятся на разных компьютерах затем осторожность необходима некоторая настройка для получения все заработает надлежащим образом. Существует два основных задач, которые мы все чаще сталкиваются с:

- Убедитесь, что имя входа, используемое для подключения к базе данных через ADO.NET принадлежит `sysadmin` роли.
- Убедитесь, что учетной записи пользователя Windows, используемый в Visual Studio на компьютере разработчика допустимым учетной записи входа SQL Server, которой принадлежит `sysadmin` роли.

Первым шагом является относительно простым. Сначала определите учетную запись пользователя для подключения к базе данных из приложения ASP.NET и затем из SQL Server Management Studio, добавьте эту учетную запись входа в `sysadmin` роли.

Вторая задача требует учетной записи пользователя Windows, используемой для отладки приложения является допустимым именем входа на удаленную базу данных. Тем не менее скорее всего, учетная запись Windows, войти на рабочую станцию с не является допустимым именем входа на SQL Server. Вместо добавления учетной записи конкретному имени входа в SQL Server, лучшим выбором будет назначить некоторые учетной записи пользователя Windows в качестве учетной записи SQL Server для отладки. После этого для отладки объектов базы данных удаленного экземпляра SQL Server, выполняется Visual Studio с помощью этого учетные данные для учетной записи s входа Windows.

Пример следует уточнить вещи. Представьте, что учетная запись Windows, с именем `SQLDebug` в домене Windows. Эта учетная запись будет необходимо добавить к удаленному экземпляру SQL Server как допустимое имя входа и как член `sysadmin` роли. Затем, чтобы выполнить отладку удаленного экземпляра SQL Server из Visual Studio, нам понадобится для запуска Visual Studio в качестве `SQLDebug` пользователя. Это можно сделать, выход из нашей рабочей станции, ведение журнала в качестве `SQLDebug`, и затем запускается Visual Studio, но более простой подход, можно войти в систему на нашей рабочей станции с помощью собственных учетных данных, а затем с помощью `runas.exe` для запуска Visual Studio от имени `SQLDebug` пользователя. `runas.exe` позволяет конкретного приложения для выполнения под другой учетной записью. Чтобы запустить Visual Studio в качестве `SQLDebug`, можно ввести следующую инструкцию в командной строке:


[!code-console[Main](debugging-stored-procedures-cs/samples/sample2.cmd)]

Дополнительные сведения об этом процессе, см. в разделе [Уильяма Р.Вона](http://betav.com/BLOG/billva/) s *Hitchhiker s руководство по Visual Studio и SQL Server, седьмое издание* производительны [How To: Задайте разрешения SQL Server для отладки](https://msdn.microsoft.com/library/w1bhybwz(VS.80).aspx).

> [!NOTE]
> Если компьютер разработки работает под управлением Windows XP Service Pack 2 будет необходимо настроить брандмауэр подключения к Интернету, чтобы разрешить удаленную отладку. [Практическое руководство. Разрешить отладку: SQL Server 2005](https://msdn.microsoft.com/library/s0fk6z6e(VS.80).aspx) статье отмечает, что это состоит из двух этапов: (a) на хост-компьютере Visual Studio, необходимо добавить `Devenv.exe` в список исключений и откройте порт TCP 135; и (б) на удаленном компьютере (SQL), необходимо открыть TCP 135 Перенос и добавить `sqlservr.exe` в список исключений. Если политика домена требует связи по сети через IPSec, необходимо открыть порты UDP 4500 и UDP 500.


## <a name="summary"></a>Сводка

Помимо поддержки отладки для кода приложения .NET, Visual Studio также предоставляет широкий набор параметров отладки для SQL Server 2005. В этом учебнике мы рассмотрели два из этих параметров: Прямая отладка базы данных и отладки приложения. Для прямой отладки объекта базы данных T-SQL, найдите объект с помощью обозревателя серверов щелкните его правой кнопкой мыши и выберите шаг с заходом. Это запускает отладчик и останавливается на первой инструкции в объекте базы данных, после чего можно пошагово инструкций s объекта и представления и изменения значений параметров. На этапе 1 мы использовали этот подход, выполнять шаги с заходом `Products_SelectByCategoryID` хранимой процедуры.

Отладка приложения позволяет ставить точки останова непосредственно в объекты базы данных. Когда объект базы данных с точками останова вызывается из клиентского приложения (например, веб-приложения ASP.NET), программа останавливается, как отладчик переходит. Отладка приложения полезно в том случае, так как он более четко понять, какое действие приложения вызывает вызываемый объект определенной базы данных. Однако он требует немного больше конфигурацией и настройкой, чем прямой отладки базы данных.

Также можно отлаживать объекты базы данных через проекты SQL Server. Мы рассмотрим использование проектов SQL Server и как использовать их для создания и отладки управляемых объектов базы данных в следующем учебном курсе.

Счастливого вам программирования!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP.NET и основатель веб- [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга — [ *Sams Teach ASP.NET 2.0 in 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Ним можно связаться по адресу [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).

> [!div class="step-by-step"]
> [Назад](protecting-connection-strings-and-other-configuration-information-cs.md)
> [Вперед](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs.md)
