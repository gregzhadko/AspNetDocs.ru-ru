---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/configuring-the-data-access-layer-s-connection-and-command-level-settings-cs
title: Настройка параметров подключения и уровня командной строки для уровня доступа к данным (C#) | Документация Майкрософт
author: rick-anderson
description: Адаптеры таблиц в типизированном наборе данных автоматически подключаются к базе данных, выдают команды и заполняют объект DataTable результатами...
ms.author: riande
ms.date: 08/03/2007
ms.assetid: cd330dd9-6254-4305-9351-dd727384c83b
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/configuring-the-data-access-layer-s-connection-and-command-level-settings-cs
msc.type: authoredcontent
ms.openlocfilehash: 8fe7a5a2e410b47c8c2be62851f2b7b775d60209
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74604928"
---
# <a name="configuring-the-data-access-layers-connection--and-command-level-settings-c"></a>Настройка параметров подключения и параметров уровня команды на уровне доступа к данным (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_72_CS.zip) или [скачать PDF](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/datatutorial72cs1.pdf)

> Адаптеры таблиц в типизированном наборе данных автоматически подключаются к базе данных, выдают команды и заполняют объект DataTable результатами. Однако в некоторых случаях мы хотим самостоятельно принять эти сведения, а в этом учебнике мы рассмотрите, как получить доступ к параметрам подключения к базе данных и на уровне команд в TableAdapter.

## <a name="introduction"></a>Введение

В рамках серии руководств мы использовали типизированные наборы данных для реализации уровня доступа к данным и бизнес-объектов нашей многоуровневой архитектуры. Как обсуждалось в [первом учебном курсе](../introduction/creating-a-data-access-layer-cs.md), объекты DataTables типизированного набора данных служат в качестве репозиториев данных, тогда как адаптеры таблиц выступают в качестве оболочек для взаимодействия с базой данных для получения и изменения базовых данных. Адаптеры таблиц инкапсулируют сложность работы с базой данных и избавляет от необходимости писать код для подключения к базе данных, выдавать команду или заполнять результаты в таблицу DataTable.

Однако бывают случаи, когда нам нужно бурров в глубину TableAdapter и написать код, который работает непосредственно с объектами ADO.NET. Например, при [внесении изменений в базу данных в рамках руководства по транзакциям](../working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs.md) мы добавили в TableAdapter методы для начала, фиксации и отката ADO.NET транзакций. Эти методы использовали внутренний, вручную созданный `SqlTransaction` объект, который был назначен `SqlCommand` объектам TableAdapter.

В этом учебнике мы рассмотрим, как получить доступ к параметрам подключения к базе данных и на уровне команд в TableAdapter. В частности, мы добавим функции к `ProductsTableAdapter`, которая обеспечивает доступ к базовой строке подключения и параметрам времени ожидания команды.

## <a name="working-with-data-using-adonet"></a>Работа с данными с помощью ADO.NET

Платформа Microsoft .NET содержит множество классов, предназначенных специально для работы с данными. Эти классы, находящиеся в [пространстве имен`System.Data`](https://msdn.microsoft.com/library/system.data.aspx), называются классами *ADO.NET* . Некоторые классы в области ADO.NET привязаны к определенному *поставщику данных*. Поставщик данных можно представить как коммуникационный канал, который позволяет передавать данные между классами ADO.NET и базовым хранилищем данных. Существуют обобщенные поставщики, например OleDb и ODBC, а также поставщики, специально разработанные для конкретной системы баз данных. Например, хотя можно подключиться к базе данных Microsoft SQL Server с помощью поставщика OleDb, Поставщик SqlClient гораздо более эффективен, так как он разработан и оптимизирован специально для SQL Server.

При программном доступе к данным обычно используется следующий шаблон:

- Установите соединение с базой данных.
- Выполните команду.
- Для запросов `SELECT` работает с результирующими записями.

Для выполнения каждого из этих шагов существуют отдельные классы ADO.NET. Для подключения к базе данных с помощью поставщика SqlClient, например, используйте [класс`SqlConnection`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection(VS.80).aspx). Чтобы выдать команду `INSERT`, `UPDATE`, `DELETE`или `SELECT` в базу данных, используйте [класс`SqlCommand`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.aspx).

За исключением [внесения изменений в базу данных в рамках](../working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs.md) учебника по транзакциям, нам не пришлось писать какой-либо код ADO.NET низкого уровня, так как автоматически созданный код TableAdapter включает функции, необходимые для подключения к базе данных, выполнения команд, получения данных и заполнения этих данных в DataTables. Однако могут возникнуть ситуации, когда нам нужно настроить эти низкоуровневые настройки. В следующих нескольких шагах мы рассмотрим, как коснуться объектов ADO.NET, используемых внутренне адаптерами таблиц.

## <a name="step-1-examining-with-the-connection-property"></a>Шаг 1. изучение свойства Connection

Каждый класс TableAdapter имеет свойство `Connection`, которое указывает сведения о подключении к базе данных. Этот тип данных свойства и `ConnectionString` значение определяются параметрами, выбранными в мастере настройки адаптера таблицы. Вспомним, что при первом добавлении TableAdapter к типизированному набору данных этот мастер запрашивает источник базы данных (см. рис. 1). Раскрывающийся список на первом шаге включает в себя базы данных, указанные в файле конфигурации, а также любые другие базы данных в подключениях к данным обозреватель сервера s. Если используемая база данных не существует в раскрывающемся списке, можно указать новое подключение к базе данных, нажав кнопку Создать подключение и указав необходимые сведения о подключении.

[![первого шага мастера настройки адаптера таблицы](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image2.png)](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image1.png)

**Рис. 1**. первый шаг мастера настройки TableAdapter ([щелкните, чтобы просмотреть изображение с полным размером](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image3.png))

Давайте рассмотрим код для свойства `Connection` TableAdapter. Как отмечалось в учебнике [Создание уровня доступа к данным](../introduction/creating-a-data-access-layer-cs.md) , можно просмотреть автоматически созданный код TableAdapter, перейдя в окно Представление классов, выполнив детализацию до соответствующего класса, а затем дважды щелкнув имя этого элемента.

Перейдите в окно представление классов, перейдя в меню Вид и выбрав представление классов (или нажав клавиши CTRL + SHIFT + C). В верхней половине окна представление классов перейдите к пространству имен `NorthwindTableAdapters` и выберите класс `ProductsTableAdapter`. Элементы `ProductsTableAdapter` s будут отображаться в нижней половине представление классов, как показано на рис. 2. Дважды щелкните свойство `Connection`, чтобы увидеть его код.

![Дважды щелкните свойство Connection в представление классов, чтобы просмотреть его автоматически созданный код.](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image4.png)

**Рис. 2**. дважды щелкните свойство Connection в представление классов, чтобы просмотреть его автоматически созданный код.

Свойства `Connection` TableAdapter и другой код, связанный с соединением, приведены ниже.

[!code-csharp[Main](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/samples/sample1.cs)]

При создании экземпляра класса TableAdapter переменная-член `_connection` равна `null`. При доступе к свойству `Connection` сначала проверяется наличие экземпляра переменной-члена `_connection`. Если это не так, вызывается метод `InitConnection`, который создает экземпляр `_connection` и задает для его свойства `ConnectionString` значение строки подключения, указанное на первом шаге мастера настройки адаптера таблицы.

Свойство `Connection` также может быть назначено объекту `SqlConnection`. Это связывает новый объект `SqlConnection` с каждым из `SqlCommand` объектов TableAdapter.

## <a name="step-2-exposing-connection-level-settings"></a>Шаг 2. предоставление параметров уровня подключения

Сведения о соединении должны оставаться инкапсулированными в TableAdapter и быть недоступны другим слоям в архитектуре приложения. Однако могут возникнуть ситуации, когда доступ к данным на уровне подключения TableAdapter должен быть доступен или настраиваемым для запроса, пользователя или страницы ASP.NET.

Добавим `ProductsTableAdapter` в наборе данных `Northwind`, чтобы включить свойство `ConnectionString`, которое может использоваться уровнем бизнес-логики для чтения или изменения строки подключения, используемой TableAdapter.

> [!NOTE]
> *Строка подключения* — это строка, указывающая сведения о подключении к базе данных, такие как используемый поставщик, расположение базы данных, учетные данные для проверки подлинности и другие параметры, связанные с базой данных. Список шаблонов строк подключения, используемых различными хранилищами данных и поставщиками, см. в разделе [connectionStrings.com](http://www.connectionstrings.com/).

Как обсуждалось в учебнике [Создание уровня доступа к данным](../introduction/creating-a-data-access-layer-cs.md) , автоматически создаваемые классы типизированного набора данных можно расширить с помощью разделяемых классов. Сначала создайте новую вложенную папку в проекте с именем `ConnectionAndCommandSettings` под папкой `~/App_Code/DAL`.

![Добавить вложенную папку с именем Коннектионандкоммандсеттингс](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image5.png)

**Рис. 3**. Добавление вложенной папки с именем `ConnectionAndCommandSettings`

Добавьте новый файл класса с именем `ProductsTableAdapter.ConnectionAndCommandSettings.cs` и введите следующий код:

[!code-csharp[Main](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/samples/sample2.cs)]

Этот разделяемый класс добавляет свойство `public` с именем `ConnectionString` в класс `ProductsTableAdapter`, который позволяет любому слою считывать или обновлять строку подключения для базового соединения TableAdapter.

Если этот разделяемый класс создан (и сохранен), откройте класс `ProductsBLL`. Перейдите к одному из существующих методов и введите `Adapter` а затем нажмите клавишу точка, чтобы открыть IntelliSense. В IntelliSense должно отобразиться новое свойство `ConnectionString`, означающее, что можно программно считывать или изменять это значение из BLL.

## <a name="exposing-the-entire-connection-object"></a>Предоставление доступа ко всему объекту соединения

Этот разделяемый класс предоставляет только одно свойство базового объекта соединения: `ConnectionString`. Если необходимо сделать весь объект соединения доступным за пределами TableAdapter, можно изменить уровень защиты `Connection` свойств. Автоматически созданный код, который мы рассматривали на шаге 1, показал, что свойство `Connection` TableAdapter помечено как `internal`, то есть к нему могут обращаться только классы в той же сборке. Однако это можно изменить с помощью свойства `ConnectionModifier` TableAdapter.

Откройте `Northwind` набор данных, щелкните `ProductsTableAdapter` в конструкторе и перейдите к окно свойств. Вы увидите, что `ConnectionModifier` задано значение по умолчанию `Assembly`. Чтобы сделать свойство `Connection` доступным вне сборки типизированного набора данных, измените свойство `ConnectionModifier` на `Public`.

[![уровень доступности свойства подключения s можно настроить с помощью свойства Коннектионмодифиер.](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image7.png)](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image6.png)

**Рис. 4**. уровень доступности `Connection` свойств s можно настроить с помощью свойства `ConnectionModifier` ([щелкните, чтобы просмотреть изображение с полным размером](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/_static/image8.png))

Сохраните набор данных, а затем вернитесь к классу `ProductsBLL`. Как и ранее, перейдите к одному из существующих методов и введите `Adapter` а затем нажмите клавишу точка, чтобы открыть IntelliSense. В список должен входить свойство `Connection`, означающее, что теперь можно программно считывать или назначать любые параметры уровня соединения из слоя BLL.

## <a name="step-3-examining-the-command-related-properties"></a>Шаг 3. Проверка свойств, связанных с командой

Адаптер таблицы TableAdapter состоит из основного запроса, который по умолчанию содержит автоматически созданные инструкции `INSERT`, `UPDATE`и `DELETE`. Эти основные запросы `INSERT`, `UPDATE`и `DELETE` реализуются в коде TableAdapter s как объект адаптера данных ADO.NET через свойство `Adapter`. Как и свойство `Connection`, тип данных `Adapter` свойства s определяется используемым поставщиком данных. Поскольку в этих учебниках используется поставщик SqlClient, свойство `Adapter` имеет тип [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter(VS.80).aspx).

Свойство `Adapter` TableAdapter имеет три свойства типа `SqlCommand`, которые используются для выписки `INSERT`, `UPDATE`и `DELETE`.

- `InsertCommand`
- `UpdateCommand`
- `DeleteCommand`

Объект `SqlCommand` отвечает за отправку определенного запроса в базу данных и имеет такие свойства, как: [`CommandText`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.commandtext.aspx), который содержит специальный оператор SQL или хранимую процедуру для выполнения. и [`Parameters`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.parameters.aspx)— коллекция объектов `SqlParameter`. Как мы видели в учебнике [Создание уровня доступа к данным](../introduction/creating-a-data-access-layer-cs.md) , эти командные объекты можно настроить с помощью окно свойств.

В дополнение к основному запросу TableAdapter может включать переменное число методов, которые при вызове отправляют указанную команду в базу данных. Основной объект команды запроса и командные объекты для всех дополнительных методов хранятся в свойстве `CommandCollection` TableAdapter.

Давайте взглянем на код, формируемый `ProductsTableAdapter` в наборе данных `Northwind` для этих двух свойств и их вспомогательных переменных-членов и вспомогательных методов:

[!code-csharp[Main](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/samples/sample3.cs)]

Код для свойств `Adapter` и `CommandCollection` точно имитируется в свойстве `Connection`. Существуют переменные элементов, которые содержат объекты, используемые свойствами. Методы доступа `get` свойства начинаются с проверки, является ли соответствующая переменная-член `null`. Если это так, вызывается метод инициализации, который создает экземпляр переменной-члена и назначает основные свойства, связанные с командой.

## <a name="step-4-exposing-command-level-settings"></a>Шаг 4. предоставление параметров на уровне команд

В идеале сведения на уровне команды должны оставаться инкапсулированными в слое доступа к данным. Эта информация должна быть необходима на других уровнях архитектуры, однако она может быть предоставлена через разделяемый класс, как и параметры уровня соединения.

Так как TableAdapter имеет только одно свойство `Connection`, код для предоставления параметров уровня соединения довольно прост. При изменении параметров на уровне команды это немного сложнее, так как TableAdapter может иметь несколько командных объектов: `InsertCommand`, `UpdateCommand`и `DeleteCommand`, а также переменное число объектов Command в свойстве `CommandCollection`. При обновлении параметров на уровне команды эти параметры необходимо распространить на все командные объекты.

Например, представьте, что в TableAdapter были определенные запросы, выполнение которых заняло слишком много времени. При использовании TableAdapter для выполнения одного из этих запросов может потребоваться увеличить [`CommandTimeout` свойства](https://msdn.microsoft.com/library/system.data.sqlclient.sqlcommand.commandtimeout.aspx)командного объекта. Это свойство указывает количество секунд ожидания выполнения команды, по умолчанию — 30.

Чтобы разрешить настройку свойства `CommandTimeout` BLL, добавьте следующий метод `public` в `ProductsDataTable` с помощью файла разделяемого класса, созданного на шаге 2 (`ProductsTableAdapter.ConnectionAndCommandSettings.cs`):

[!code-csharp[Main](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs/samples/sample4.cs)]

Этот метод можно вызвать из слоя BLL или представления, чтобы задать время ожидания команды для всех команд, решаемых этим экземпляром TableAdapter.

> [!NOTE]
> Свойства `Adapter` и `CommandCollection` помечаются как `private`, то есть доступ к ним можно получить только из кода в TableAdapter. В отличие от свойства `Connection` эти модификаторы доступа не настраиваются. Поэтому, если необходимо предоставить свойства на уровне команд другим слоям в архитектуре, необходимо использовать описанный выше подход к разделяемому классу, чтобы предоставить `public` метод или свойство, считывающее и записывающее данные в объекты команд `private`.

## <a name="summary"></a>Сводка

Адаптеры таблиц в типизированном наборе данных служат для инкапсуляции сведений о доступе к данным и сложности. С помощью адаптеров таблиц нам не нужно беспокоиться о написании кода ADO.NET для подключения к базе данных, выдаче команды или заполнении результатов в DataTable. Все это автоматически обрабатывается для нас.

Однако иногда требуется настроить низкоуровневые ADO.NET, например изменить строку подключения или значения по умолчанию для соединения или времени ожидания команды. TableAdapter автоматически создает `Connection`, `Adapter`и `CommandCollection` свойства, но по умолчанию это `internal` или `private`. Эта внутренняя информация может быть предоставлена путем расширения TableAdapter с помощью разделяемых классов для включения `public` методов или свойств. Кроме того, модификатор доступа к свойству TableAdapter `Connection` можно настроить с помощью свойства `ConnectionModifier` TableAdapter.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого руководства были Бурнадетте Леигх, S REN Джейкоб Лауритсен, Терезой Мерфи и Хилтон Жеисенов. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](working-with-computed-columns-cs.md)
> [Вперед](protecting-connection-strings-and-other-configuration-information-cs.md)
