---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/protecting-connection-strings-and-other-configuration-information-cs
title: Защита строк подключения и других сведений о конфигурацииC#() | Документация Майкрософт
author: rick-anderson
description: Приложение ASP.NET обычно хранит сведения о конфигурации в файле Web. config. Некоторые из этих сведений являются конфиденциальными и гарантируют защиту. По DEF...
ms.author: riande
ms.date: 08/03/2007
ms.assetid: ad8dd396-30f7-4abe-ac02-a0b84422e5be
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/protecting-connection-strings-and-other-configuration-information-cs
msc.type: authoredcontent
ms.openlocfilehash: 15970bee1e990d3a139673efe12486e08f79814c
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74573538"
---
# <a name="protecting-connection-strings-and-other-configuration-information-c"></a><span data-ttu-id="f85e3-105">Защита строк подключения и других сведений о конфигурации (C#)</span><span class="sxs-lookup"><span data-stu-id="f85e3-105">Protecting Connection Strings and Other Configuration Information (C#)</span></span>

<span data-ttu-id="f85e3-106">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="f85e3-106">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="f85e3-107">[Скачать код](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_73_CS.zip) или [скачать PDF](protecting-connection-strings-and-other-configuration-information-cs/_static/datatutorial73cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="f85e3-107">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_73_CS.zip) or [Download PDF](protecting-connection-strings-and-other-configuration-information-cs/_static/datatutorial73cs1.pdf)</span></span>

> <span data-ttu-id="f85e3-108">Приложение ASP.NET обычно хранит сведения о конфигурации в файле Web. config.</span><span class="sxs-lookup"><span data-stu-id="f85e3-108">An ASP.NET application typically stores configuration information in a Web.config file.</span></span> <span data-ttu-id="f85e3-109">Некоторые из этих сведений являются конфиденциальными и гарантируют защиту.</span><span class="sxs-lookup"><span data-stu-id="f85e3-109">Some of this information is sensitive and warrants protection.</span></span> <span data-ttu-id="f85e3-110">По умолчанию этот файл не будет обслуживаться посетителем веб-узла, но администратор или злоумышленник может получить доступ к файловой системе веб-сервера и просмотреть содержимое файла.</span><span class="sxs-lookup"><span data-stu-id="f85e3-110">By default this file will not be served to a Web site visitor, but an administrator or a hacker may gain access to the Web server's file system and view the contents of the file.</span></span> <span data-ttu-id="f85e3-111">В этом учебнике мы рассмотрите, что ASP.NET 2,0 позволяет нам защищать конфиденциальные данные путем шифрования разделов файла Web. config.</span><span class="sxs-lookup"><span data-stu-id="f85e3-111">In this tutorial we learn that ASP.NET 2.0 allows us to protect sensitive information by encrypting sections of the Web.config file.</span></span>

## <a name="introduction"></a><span data-ttu-id="f85e3-112">Введение</span><span class="sxs-lookup"><span data-stu-id="f85e3-112">Introduction</span></span>

<span data-ttu-id="f85e3-113">Сведения о конфигурации для приложений ASP.NET обычно хранятся в XML-файле с именем `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-113">Configuration information for ASP.NET applications is commonly stored in an XML file named `Web.config`.</span></span> <span data-ttu-id="f85e3-114">В рамках этих руководств мы обновили `Web.config` несколько раз.</span><span class="sxs-lookup"><span data-stu-id="f85e3-114">Over the course of these tutorials we have updated the `Web.config` a handful of times.</span></span> <span data-ttu-id="f85e3-115">При создании `Northwind` типизированного набора данных в [первом руководстве](../introduction/creating-a-data-access-layer-cs.md), например, сведения о строке подключения были автоматически добавлены в `Web.config` в разделе `<connectionStrings>`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-115">When creating the `Northwind` Typed DataSet in the [first tutorial](../introduction/creating-a-data-access-layer-cs.md), for example, connection string information was automatically added to `Web.config` in the `<connectionStrings>` section.</span></span> <span data-ttu-id="f85e3-116">Позже в руководстве " [главные страницы и Навигация по сайту](../introduction/master-pages-and-site-navigation-cs.md) " мы вручную обновили `Web.config`, добавив `<pages>` элемент, указывающий, что все страницы ASP.NET в проекте должны использовать тему `DataWebControls`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-116">Later, in the [Master Pages and Site Navigation](../introduction/master-pages-and-site-navigation-cs.md) tutorial, we manually updated `Web.config`, adding a `<pages>` element indicating that all of the ASP.NET pages in our project should use the `DataWebControls` Theme.</span></span>

<span data-ttu-id="f85e3-117">Поскольку `Web.config` может содержать конфиденциальные данные, такие как строки подключения, важно, чтобы содержимое `Web.config` быть безопасно и скрыто от неавторизованных средств просмотра.</span><span class="sxs-lookup"><span data-stu-id="f85e3-117">Since `Web.config` may contain sensitive data such as connection strings, it is important that the contents of `Web.config` be kept safe and hidden from unauthorized viewers.</span></span> <span data-ttu-id="f85e3-118">По умолчанию любой HTTP-запрос к файлу с расширением `.config` обрабатывается подсистемой ASP.NET, которая возвращает *этот тип страницы, не* обозначает сообщение, показанное на рис. 1.</span><span class="sxs-lookup"><span data-stu-id="f85e3-118">By default, any HTTP request to a file with the `.config` extension is handled by the ASP.NET engine, which returns the *This type of page is not served* message shown in Figure 1.</span></span> <span data-ttu-id="f85e3-119">Это означает, что посетители не смогут просматривать содержимое `Web.config` файлов, просто вводя http://www.YourServer.com/Web.config в адресную строку браузера.</span><span class="sxs-lookup"><span data-stu-id="f85e3-119">This means that visitors cannot view your `Web.config` file s contents by simply entering http://www.YourServer.com/Web.config into their browser s Address bar.</span></span>

<span data-ttu-id="f85e3-120">[![посещении Web. config через браузер возвращает сообщение Этот тип страницы не обрабатывается](protecting-connection-strings-and-other-configuration-information-cs/_static/image2.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="f85e3-120">[![Visiting Web.config Through a Browser Returns a This type of page is not served Message](protecting-connection-strings-and-other-configuration-information-cs/_static/image2.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image1.png)</span></span>

<span data-ttu-id="f85e3-121">**Рис. 1**. посещение `Web.config` через браузер возвращает сообщение Этот тип страницы не обрабатывается ([щелкните, чтобы просмотреть изображение с полным размером](protecting-connection-strings-and-other-configuration-information-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="f85e3-121">**Figure 1**: Visiting `Web.config` Through a Browser Returns a This type of page is not served Message ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image3.png))</span></span>

<span data-ttu-id="f85e3-122">Но что делать, если злоумышленнику удается найти какую-нибудь другую атаку, позволяющую просматривать содержимое `Web.config` файлов?</span><span class="sxs-lookup"><span data-stu-id="f85e3-122">But what if an attacker is able to find some other exploit that allows her to view your `Web.config` file s contents?</span></span> <span data-ttu-id="f85e3-123">Что может сделать злоумышленник с этой информацией и какие действия можно предпринять для дальнейшей защиты конфиденциальной информации в `Web.config`?</span><span class="sxs-lookup"><span data-stu-id="f85e3-123">What could an attacker do with this information, and what steps can be taken to further protect the sensitive information within `Web.config`?</span></span> <span data-ttu-id="f85e3-124">К счастью, большинство разделов в `Web.config` не содержат конфиденциальных сведений.</span><span class="sxs-lookup"><span data-stu-id="f85e3-124">Fortunately, most sections in `Web.config` do not contain sensitive information.</span></span> <span data-ttu-id="f85e3-125">Какой ущерб злоумышленник может перпетрате, если им известно имя темы по умолчанию, используемой страницами ASP.NET?</span><span class="sxs-lookup"><span data-stu-id="f85e3-125">What harm can an attacker perpetrate if they know the name of the default Theme used by your ASP.NET pages?</span></span>

<span data-ttu-id="f85e3-126">Однако некоторые `Web.config` разделы содержат конфиденциальную информацию, которая может содержать строки подключения, имена пользователей, пароли, имена серверов, ключи шифрования и т. д.</span><span class="sxs-lookup"><span data-stu-id="f85e3-126">Certain `Web.config` sections, however, contain sensitive information that may include connection strings, user names, passwords, server names, encryption keys, and so forth.</span></span> <span data-ttu-id="f85e3-127">Эти сведения обычно находятся в следующих разделах `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-127">This information is typically found in the following `Web.config` sections:</span></span>

- `<appSettings>`
- `<connectionStrings>`
- `<identity>`
- `<sessionState>`

<span data-ttu-id="f85e3-128">В этом учебнике мы рассмотрим методы защиты конфиденциальных сведений о конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f85e3-128">In this tutorial we will look at techniques for protecting such sensitive configuration information.</span></span> <span data-ttu-id="f85e3-129">Как мы увидим, .NET Framework версии 2,0 включает систему защищенных конфигураций, которая упрощает шифрование и расшифровку выбранных разделов конфигурации с помощью программирования.</span><span class="sxs-lookup"><span data-stu-id="f85e3-129">As we will see, the .NET Framework version 2.0 includes a protected configurations system that makes programmatically encrypting and decrypting selected configuration sections a breeze.</span></span>

> [!NOTE]
> <span data-ttu-id="f85e3-130">В этом руководстве в конце рассматриваются рекомендации по подключению к базе данных из приложения ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f85e3-130">This tutorial concludes with a look at Microsoft s recommendations for connecting to a database from an ASP.NET application.</span></span> <span data-ttu-id="f85e3-131">Помимо шифрования строк подключения можно защитить систему, гарантируя безопасное подключение к базе данных в безопасном режиме.</span><span class="sxs-lookup"><span data-stu-id="f85e3-131">In addition to encrypting your connection strings, you can help harden your system by ensuring that you are connecting to the database in a secure fashion.</span></span>

## <a name="step-1-exploring-aspnet-20-s-protected-configuration-options"></a><span data-ttu-id="f85e3-132">Шаг 1. изучение параметров защищенной конфигурации ASP.NET 2,0 s</span><span class="sxs-lookup"><span data-stu-id="f85e3-132">Step 1: Exploring ASP.NET 2.0 s Protected Configuration Options</span></span>

<span data-ttu-id="f85e3-133">ASP.NET 2,0 включает систему защищенной конфигурации для шифрования и расшифровки информации о конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f85e3-133">ASP.NET 2.0 includes a protected configuration system for encrypting and decrypting configuration information.</span></span> <span data-ttu-id="f85e3-134">Сюда входят методы в .NET Framework, которые можно использовать для программного шифрования или расшифровки сведений о конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f85e3-134">This includes methods in the .NET Framework that can be used to programmatically encrypt or decrypt configuration information.</span></span> <span data-ttu-id="f85e3-135">Защищенная система конфигурации использует [модель поставщика](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx), которая позволяет разработчикам выбрать используемую реализацию шифрования.</span><span class="sxs-lookup"><span data-stu-id="f85e3-135">The protected configuration system uses the [provider model](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx), which allows developers to choose what cryptographic implementation is used.</span></span>

<span data-ttu-id="f85e3-136">.NET Framework поставляется с двумя поставщиками защищенной конфигурации:</span><span class="sxs-lookup"><span data-stu-id="f85e3-136">The .NET Framework ships with two protected configuration providers:</span></span>

- <span data-ttu-id="f85e3-137">[`RSAProtectedConfigurationProvider`](https://msdn.microsoft.com/library/system.configuration.rsaprotectedconfigurationprovider.aspx) — использует асимметричный [алгоритм RSA](http://en.wikipedia.org/wiki/Rsa) для шифрования и расшифровки.</span><span class="sxs-lookup"><span data-stu-id="f85e3-137">[`RSAProtectedConfigurationProvider`](https://msdn.microsoft.com/library/system.configuration.rsaprotectedconfigurationprovider.aspx) - uses the asymmetric [RSA algorithm](http://en.wikipedia.org/wiki/Rsa) for encryption and decryption.</span></span>
- <span data-ttu-id="f85e3-138">[`DPAPIProtectedConfigurationProvider`](https://msdn.microsoft.com/system.configuration.dpapiprotectedconfigurationprovider.aspx) — использует [API защиты данных Windows (DPAPI)](https://msdn.microsoft.com/library/ms995355.aspx) для шифрования и расшифровки.</span><span class="sxs-lookup"><span data-stu-id="f85e3-138">[`DPAPIProtectedConfigurationProvider`](https://msdn.microsoft.com/system.configuration.dpapiprotectedconfigurationprovider.aspx) - uses the Windows [Data Protection API (DPAPI)](https://msdn.microsoft.com/library/ms995355.aspx) for encryption and decryption.</span></span>

<span data-ttu-id="f85e3-139">Поскольку защищенная система конфигурации реализует шаблон проектирования поставщика, можно создать собственный поставщик защищенной конфигурации и подключить его к приложению.</span><span class="sxs-lookup"><span data-stu-id="f85e3-139">Since the protected configuration system implements the provider design pattern, it is possible to create your own protected configuration provider and plug it into your application.</span></span> <span data-ttu-id="f85e3-140">Дополнительные сведения об этом процессе см. в разделе [Реализация поставщика защищенной конфигурации](https://msdn.microsoft.com/library/wfc2t3az(VS.80).aspx) .</span><span class="sxs-lookup"><span data-stu-id="f85e3-140">See [Implementing a Protected Configuration Provider](https://msdn.microsoft.com/library/wfc2t3az(VS.80).aspx) for more information on this process.</span></span>

<span data-ttu-id="f85e3-141">Поставщики RSA и DPAPI используют ключи для своих подпрограмм шифрования и расшифровки, и эти ключи могут храниться на уровне компьютера или пользователя.</span><span class="sxs-lookup"><span data-stu-id="f85e3-141">The RSA and DPAPI providers use keys for their encryption and decryption routines, and these keys can be stored at the machine- or user-level.</span></span> <span data-ttu-id="f85e3-142">Ключи уровня компьютера идеально подходят для сценариев, в которых веб-приложение выполняется на собственном выделенном сервере или если на сервере есть несколько приложений, которым требуется совместное использование зашифрованных данных.</span><span class="sxs-lookup"><span data-stu-id="f85e3-142">Machine-level keys are ideal for scenarios where the web application runs on its own dedicated server or if there are multiple applications on a server that need to share encrypted information.</span></span> <span data-ttu-id="f85e3-143">Ключи уровня пользователя являются более безопасным вариантом в общих средах размещения, где другие приложения на том же сервере не должны расшифровывать разделы конфигурации, защищенные приложением.</span><span class="sxs-lookup"><span data-stu-id="f85e3-143">User-level keys are a more secure option in shared hosting environments where other applications on the same server should not be able to decrypt your application s protected configuration sections.</span></span>

<span data-ttu-id="f85e3-144">В этом учебнике в нашем примере будут использоваться поставщик DPAPI и ключи уровня компьютера.</span><span class="sxs-lookup"><span data-stu-id="f85e3-144">In this tutorial our examples will use the DPAPI provider and machine-level keys.</span></span> <span data-ttu-id="f85e3-145">В частности, мы рассмотрим шифрование `<connectionStrings>` разделе в `Web.config`, хотя защищенную систему конфигурации можно использовать для шифрования большинства разделов `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-145">Specifically, we will look at encrypting the `<connectionStrings>` section in `Web.config`, although the protected configuration system can be used to encrypt most any `Web.config` section.</span></span> <span data-ttu-id="f85e3-146">Сведения об использовании ключей уровня пользователя или поставщика RSA см. в разделе Дополнительные материалы в конце этого руководства.</span><span class="sxs-lookup"><span data-stu-id="f85e3-146">For information on using user-level keys or using the RSA provider, consult the resources in the Further Readings section at the end of this tutorial.</span></span>

> [!NOTE]
> <span data-ttu-id="f85e3-147">Поставщики `RSAProtectedConfigurationProvider` и `DPAPIProtectedConfigurationProvider` регистрируются в файле `machine.config` с именами поставщиков `RsaProtectedConfigurationProvider` и `DataProtectionConfigurationProvider`соответственно.</span><span class="sxs-lookup"><span data-stu-id="f85e3-147">The `RSAProtectedConfigurationProvider` and `DPAPIProtectedConfigurationProvider` providers are registered in the `machine.config` file with the provider names `RsaProtectedConfigurationProvider` and `DataProtectionConfigurationProvider`, respectively.</span></span> <span data-ttu-id="f85e3-148">При шифровании или расшифровке сведений о конфигурации необходимо указать соответствующее имя поставщика (`RsaProtectedConfigurationProvider` или `DataProtectionConfigurationProvider`) вместо фактического имени типа (`RSAProtectedConfigurationProvider` и `DPAPIProtectedConfigurationProvider`).</span><span class="sxs-lookup"><span data-stu-id="f85e3-148">When encrypting or decrypting configuration information we will need to supply the appropriate provider name (`RsaProtectedConfigurationProvider` or `DataProtectionConfigurationProvider`) rather than the actual type name (`RSAProtectedConfigurationProvider` and `DPAPIProtectedConfigurationProvider`).</span></span> <span data-ttu-id="f85e3-149">Файл `machine.config` можно найти в папке `$WINDOWS$\Microsoft.NET\Framework\version\CONFIG`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-149">You can find the `machine.config` file in the `$WINDOWS$\Microsoft.NET\Framework\version\CONFIG` folder.</span></span>

## <a name="step-2-programmatically-encrypting-and-decrypting-configuration-sections"></a><span data-ttu-id="f85e3-150">Шаг 2. программное шифрование и расшифровка разделов конфигурации</span><span class="sxs-lookup"><span data-stu-id="f85e3-150">Step 2: Programmatically Encrypting and Decrypting Configuration Sections</span></span>

<span data-ttu-id="f85e3-151">С помощью нескольких строк кода можно зашифровать или расшифровать определенный раздел конфигурации, используя указанного поставщика.</span><span class="sxs-lookup"><span data-stu-id="f85e3-151">With a few lines of code we can encrypt or decrypt a particular configuration section using a specified provider.</span></span> <span data-ttu-id="f85e3-152">Код, как мы увидим чуть ниже, просто необходимо программно ссылаться на соответствующий раздел конфигурации, вызвать его `ProtectSection` или метод `UnprotectSection`, а затем вызвать метод `Save`, чтобы сохранить изменения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-152">The code, as we will see shortly, simply needs to programmatically reference the appropriate configuration section, call its `ProtectSection` or `UnprotectSection` method, and then call the `Save` method to persist the changes.</span></span> <span data-ttu-id="f85e3-153">Более того, .NET Framework содержит полезную программу командной строки, которая может шифровать и расшифровывать сведения о конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f85e3-153">Moreover, the .NET Framework includes a helpful command line utility that can encrypt and decrypt configuration information.</span></span> <span data-ttu-id="f85e3-154">Эта служебная программа командной строки будет рассмотрена на шаге 3.</span><span class="sxs-lookup"><span data-stu-id="f85e3-154">We will explore this command line utility in Step 3.</span></span>

<span data-ttu-id="f85e3-155">Чтобы продемонстрировать программную защиту сведений о конфигурации, давайте создадим страницу ASP.NET, которая включает кнопки для шифрования и расшифровки `<connectionStrings>` разделе в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-155">To illustrate programmatically protecting configuration information, let s create an ASP.NET page that includes buttons for encrypting and decrypting the `<connectionStrings>` section in `Web.config`.</span></span>

<span data-ttu-id="f85e3-156">Для начала откройте страницу `EncryptingConfigSections.aspx` в папке `AdvancedDAL`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-156">Start by opening the `EncryptingConfigSections.aspx` page in the `AdvancedDAL` folder.</span></span> <span data-ttu-id="f85e3-157">Перетащите элемент управления TextBox из области элементов в конструктор, задав для его свойства `ID` значение `WebConfigContents`, его свойство `TextMode` значение `MultiLine`, а свойства `Width` и `Rows` — в 95% и 15 соответственно.</span><span class="sxs-lookup"><span data-stu-id="f85e3-157">Drag a TextBox control from the Toolbox onto the Designer, setting its `ID` property to `WebConfigContents`, its `TextMode` property to `MultiLine`, and its `Width` and `Rows` properties to 95% and 15, respectively.</span></span> <span data-ttu-id="f85e3-158">Этот элемент управления TextBox будет отображать содержимое `Web.config` позволяя быстро увидеть, зашифровано ли содержимое.</span><span class="sxs-lookup"><span data-stu-id="f85e3-158">This TextBox control will display the contents of `Web.config` allowing us to quickly see if the contents are encrypted or not.</span></span> <span data-ttu-id="f85e3-159">Конечно, в реальном приложении никогда не нужно отображать содержимое `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-159">Of course, in a real application you would never want to display the contents of `Web.config`.</span></span>

<span data-ttu-id="f85e3-160">Под текстовым полем добавьте два элемента управления "Кнопка" с именами `EncryptConnStrings` и `DecryptConnStrings`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-160">Beneath the TextBox, add two Button controls named `EncryptConnStrings` and `DecryptConnStrings`.</span></span> <span data-ttu-id="f85e3-161">Задайте для свойств текста шифрование строк подключения и расшифровку строк подключения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-161">Set their Text properties to Encrypt Connection Strings and Decrypt Connection Strings .</span></span>

<span data-ttu-id="f85e3-162">На этом этапе экран должен выглядеть примерно так, как показано на рис. 2.</span><span class="sxs-lookup"><span data-stu-id="f85e3-162">At this point your screen should look similar to Figure 2.</span></span>

<span data-ttu-id="f85e3-163">[![добавить на страницу текстовое поле и два веб-элемента управления "Кнопка"](protecting-connection-strings-and-other-configuration-information-cs/_static/image5.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="f85e3-163">[![Add a TextBox and Two Button Web Controls to the Page](protecting-connection-strings-and-other-configuration-information-cs/_static/image5.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image4.png)</span></span>

<span data-ttu-id="f85e3-164">**Рис. 2**. Добавление на страницу элемента управления TextBox и двух кнопок ([щелкните, чтобы просмотреть изображение с полным размером](protecting-connection-strings-and-other-configuration-information-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="f85e3-164">**Figure 2**: Add a TextBox and Two Button Web Controls to the Page ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image6.png))</span></span>

<span data-ttu-id="f85e3-165">Далее необходимо написать код, который загружает и отображает содержимое `Web.config` в текстовом поле `WebConfigContents` при первой загрузке страницы.</span><span class="sxs-lookup"><span data-stu-id="f85e3-165">Next, we need to write code that loads and displays the contents of `Web.config` in the `WebConfigContents` TextBox when the page is first loaded.</span></span> <span data-ttu-id="f85e3-166">Добавьте следующий код в класс кода программной части Pages.</span><span class="sxs-lookup"><span data-stu-id="f85e3-166">Add the following code to the page s code-behind class.</span></span> <span data-ttu-id="f85e3-167">Этот код добавляет метод с именем `DisplayWebConfig` и вызывает его из обработчика событий `Page_Load`, когда `Page.IsPostBack` `false`:</span><span class="sxs-lookup"><span data-stu-id="f85e3-167">This code adds a method named `DisplayWebConfig` and calls it from the `Page_Load` event handler when `Page.IsPostBack` is `false`:</span></span>

[!code-csharp[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample1.cs)]

<span data-ttu-id="f85e3-168">Метод `DisplayWebConfig` использует [класс`File`](https://msdn.microsoft.com/library/system.io.file.aspx) для открытия файла `Web.config` приложения, [класс`StreamReader`](https://msdn.microsoft.com/library/system.io.streamreader.aspx) для считывания его содержимого в строку, а [класс`Path`](https://msdn.microsoft.com/library/system.io.path.aspx) — для создания физического пути к файлу `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-168">The `DisplayWebConfig` method uses the [`File` class](https://msdn.microsoft.com/library/system.io.file.aspx) to open the application s `Web.config` file, the [`StreamReader` class](https://msdn.microsoft.com/library/system.io.streamreader.aspx) to read its contents into a string, and the [`Path` class](https://msdn.microsoft.com/library/system.io.path.aspx) to generate the physical path to the `Web.config` file.</span></span> <span data-ttu-id="f85e3-169">Все эти три класса находятся в [пространстве имен`System.IO`](https://msdn.microsoft.com/library/system.io.aspx).</span><span class="sxs-lookup"><span data-stu-id="f85e3-169">These three classes are all found in the [`System.IO` namespace](https://msdn.microsoft.com/library/system.io.aspx).</span></span> <span data-ttu-id="f85e3-170">Следовательно, необходимо добавить оператор `using` `System.IO` в верхнюю часть класса кода программной части или, в качестве префикса, к именам этих классов `System.IO.`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-170">Consequently, you will need to add a `using` `System.IO` statement to the top of the code-behind class or, alternatively, prefix these class names with `System.IO.` .</span></span>

<span data-ttu-id="f85e3-171">Далее необходимо добавить обработчики событий для двух элементов управления "Кнопка" `Click` событиями и добавить необходимый код для шифрования и расшифровки `<connectionStrings>` раздела, используя ключ уровня компьютера с поставщиком DPAPI.</span><span class="sxs-lookup"><span data-stu-id="f85e3-171">Next, we need to add event handlers for the two Button controls `Click` events and add the necessary code to encrypt and decrypt the `<connectionStrings>` section using a machine-level key with the DPAPI provider.</span></span> <span data-ttu-id="f85e3-172">В конструкторе дважды щелкните каждую из кнопок, чтобы добавить обработчик событий `Click` в класс кода программной части, а затем добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="f85e3-172">From the Designer, double-click each of the Buttons to add a `Click` event handler in the code-behind class and then add the following code:</span></span>

[!code-csharp[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample2.cs)]

<span data-ttu-id="f85e3-173">Код, используемый в двух обработчиках событий, практически идентичен.</span><span class="sxs-lookup"><span data-stu-id="f85e3-173">The code used in the two event handlers is nearly identical.</span></span> <span data-ttu-id="f85e3-174">Они начинают с получения сведений о текущем приложении `Web.config` файл с помощью метода [`WebConfigurationManager` класса](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.aspx) s [`OpenWebConfiguration`](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.openwebconfiguration.aspx).</span><span class="sxs-lookup"><span data-stu-id="f85e3-174">They both start by getting information about the current application s `Web.config` file via the [`WebConfigurationManager` class](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.aspx) s [`OpenWebConfiguration` method](https://msdn.microsoft.com/library/system.web.configuration.webconfigurationmanager.openwebconfiguration.aspx).</span></span> <span data-ttu-id="f85e3-175">Этот метод возвращает файл веб-конфигурации для указанного виртуального пути.</span><span class="sxs-lookup"><span data-stu-id="f85e3-175">This method returns the web configuration file for the specified virtual path.</span></span> <span data-ttu-id="f85e3-176">Затем доступ к разделу `Web.config` Files `<connectionStrings>` осуществляется через метод [`Configuration` класса](https://msdn.microsoft.com/library/system.configuration.configuration.aspx) s [`GetSection(sectionName)`](https://msdn.microsoft.com/library/system.configuration.configuration.getsection.aspx), который возвращает объект [`ConfigurationSection`](https://msdn.microsoft.com/library/system.configuration.configurationsection.aspx) .</span><span class="sxs-lookup"><span data-stu-id="f85e3-176">Next, the `Web.config` file s `<connectionStrings>` section is accessed via the [`Configuration` class](https://msdn.microsoft.com/library/system.configuration.configuration.aspx) s [`GetSection(sectionName)` method](https://msdn.microsoft.com/library/system.configuration.configuration.getsection.aspx), which returns a [`ConfigurationSection`](https://msdn.microsoft.com/library/system.configuration.configurationsection.aspx) object.</span></span>

<span data-ttu-id="f85e3-177">Объект `ConfigurationSection` включает [свойство`SectionInformation`](https://msdn.microsoft.com/library/system.configuration.configurationsection.sectioninformation.aspx) , которое предоставляет дополнительные сведения и функциональные возможности, касающиеся раздела конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f85e3-177">The `ConfigurationSection` object includes a [`SectionInformation` property](https://msdn.microsoft.com/library/system.configuration.configurationsection.sectioninformation.aspx) that provides additional information and functionality regarding the configuration section.</span></span> <span data-ttu-id="f85e3-178">Как показано в приведенном выше коде, можно определить, зашифрован ли раздел конфигурации, проверив свойство `SectionInformation` свойства `IsProtected`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-178">As the code above shows, we can determine whether the configuration section is encrypted by checking the `SectionInformation` property s `IsProtected` property.</span></span> <span data-ttu-id="f85e3-179">Более того, раздел можно шифровать или расшифровать с помощью `SectionInformation` свойств `ProtectSection(provider)` и методов `UnprotectSection`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-179">Moreover, the section can be encrypted or decrypted via the `SectionInformation` property s `ProtectSection(provider)` and `UnprotectSection` methods.</span></span>

<span data-ttu-id="f85e3-180">Метод `ProtectSection(provider)` принимает в качестве входных данных строку, указывающую имя поставщика защищенной конфигурации, который будет использоваться при шифровании.</span><span class="sxs-lookup"><span data-stu-id="f85e3-180">The `ProtectSection(provider)` method accepts as input a string specifying the name of the protected configuration provider to use when encrypting.</span></span> <span data-ttu-id="f85e3-181">В обработчике событий кнопки `EncryptConnString` s мы передаем Датапротектионконфигуратионпровидер в метод `ProtectSection(provider)`, чтобы использовался поставщик DPAPI.</span><span class="sxs-lookup"><span data-stu-id="f85e3-181">In the `EncryptConnString` Button s event handler we pass DataProtectionConfigurationProvider into the `ProtectSection(provider)` method so that the DPAPI provider is used.</span></span> <span data-ttu-id="f85e3-182">Метод `UnprotectSection` может определить поставщика, который использовался для шифрования раздела конфигурации, и поэтому не требует входных параметров.</span><span class="sxs-lookup"><span data-stu-id="f85e3-182">The `UnprotectSection` method can determine the provider that was used to encrypt the configuration section and therefore does not require any input parameters.</span></span>

<span data-ttu-id="f85e3-183">После вызова метода `ProtectSection(provider)` или `UnprotectSection` необходимо вызвать метод `Configuration` Object s [`Save`](https://msdn.microsoft.com/library/system.configuration.configuration.save.aspx) , чтобы сохранить изменения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-183">After calling the `ProtectSection(provider)` or `UnprotectSection` method, you must call the `Configuration` object s [`Save` method](https://msdn.microsoft.com/library/system.configuration.configuration.save.aspx) to persist the changes.</span></span> <span data-ttu-id="f85e3-184">После того как сведения о конфигурации будут зашифрованы или расшифрованы, а изменения сохранены, мы вызываем `DisplayWebConfig`, чтобы загрузить обновленное содержимое `Web.config` в элемент управления TextBox.</span><span class="sxs-lookup"><span data-stu-id="f85e3-184">Once the configuration information has been encrypted or decrypted and the changes saved, we call `DisplayWebConfig` to load the updated `Web.config` contents into the TextBox control.</span></span>

<span data-ttu-id="f85e3-185">После введения приведенного выше кода протестируйте его, посетив страницу `EncryptingConfigSections.aspx` в браузере.</span><span class="sxs-lookup"><span data-stu-id="f85e3-185">Once you have entered the above code, test it by visiting the `EncryptingConfigSections.aspx` page through a browser.</span></span> <span data-ttu-id="f85e3-186">Сначала должна отобразиться страница со списком содержимого `Web.config` с `<connectionStrings>`ным разделом в виде обычного текста (см. рис. 3).</span><span class="sxs-lookup"><span data-stu-id="f85e3-186">You should initially see a page that lists the contents of `Web.config` with the `<connectionStrings>` section displayed in plain-text (see Figure 3).</span></span>

<span data-ttu-id="f85e3-187">[![добавить на страницу текстовое поле и два веб-элемента управления "Кнопка"](protecting-connection-strings-and-other-configuration-information-cs/_static/image8.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="f85e3-187">[![Add a TextBox and Two Button Web Controls to the Page](protecting-connection-strings-and-other-configuration-information-cs/_static/image8.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image7.png)</span></span>

<span data-ttu-id="f85e3-188">**Рис. 3**. Добавление на страницу элемента управления TextBox и двух кнопок ([щелкните, чтобы просмотреть изображение с полным размером](protecting-connection-strings-and-other-configuration-information-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="f85e3-188">**Figure 3**: Add a TextBox and Two Button Web Controls to the Page ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image9.png))</span></span>

<span data-ttu-id="f85e3-189">Теперь нажмите кнопку шифрование строк подключения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-189">Now click the Encrypt Connection Strings button.</span></span> <span data-ttu-id="f85e3-190">Если проверка запросов включена, разметка, отправленная обратно из текстового поля `WebConfigContents`, создаст `HttpRequestValidationException`, в котором отображается сообщение, в клиенте было обнаружено потенциально опасное значение `Request.Form`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-190">If request validation is enabled, the markup posted back from the `WebConfigContents` TextBox will produce an `HttpRequestValidationException`, which displays the message, A potentially dangerous `Request.Form` value was detected from the client.</span></span> <span data-ttu-id="f85e3-191">Проверка запросов, которая включена по умолчанию в ASP.NET 2,0, запрещает обратные передачи, включающие в себя незакодированный HTML, и предназначено для предотвращения атак путем внедрения скриптов.</span><span class="sxs-lookup"><span data-stu-id="f85e3-191">Request validation, which is enabled by default in ASP.NET 2.0, prohibits postbacks that include un-encoded HTML and is designed to help prevent script-injection attacks.</span></span> <span data-ttu-id="f85e3-192">Эту проверку можно отключить на уровне страницы или приложения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-192">This check can be disabled at the page- or application-level.</span></span> <span data-ttu-id="f85e3-193">Чтобы отключить его для этой страницы, задайте для параметра `ValidateRequest` значение `false` в директиве `@Page`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-193">To turn it off for this page, set the `ValidateRequest` setting to `false` in the `@Page` directive.</span></span> <span data-ttu-id="f85e3-194">Директива `@Page` находится в верхней части декларативной разметки страницы s.</span><span class="sxs-lookup"><span data-stu-id="f85e3-194">The `@Page` directive is found at the top of the page s declarative markup.</span></span>

[!code-aspx[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample3.aspx)]

<span data-ttu-id="f85e3-195">Дополнительные сведения о проверке запросов, ее назначении, отключении на уровне страницы и приложения, а также о том, как кодировать HTML, см. в разделе [Проверка запросов — предотвращение атак с помощью сценариев](../../../../whitepapers/request-validation.md).</span><span class="sxs-lookup"><span data-stu-id="f85e3-195">For more information on request validation, its purpose, how to disable it at the page- and application-level, as well as how to HTML encode markup, see [Request Validation - Preventing Script Attacks](../../../../whitepapers/request-validation.md).</span></span>

<span data-ttu-id="f85e3-196">После отключения проверки запроса для страницы снова нажмите кнопку шифрование строк подключения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-196">After disabling request validation for the page, try clicking the Encrypt Connection Strings button again.</span></span> <span data-ttu-id="f85e3-197">При обратной передаче доступ к файлу конфигурации будет осуществляться, а его `<connectionStrings>` раздел шифруется с помощью поставщика DPAPI.</span><span class="sxs-lookup"><span data-stu-id="f85e3-197">On postback, the configuration file will be accessed and its `<connectionStrings>` section encrypted using the DPAPI provider.</span></span> <span data-ttu-id="f85e3-198">Затем текстовое поле обновляется для вывода нового содержимого `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-198">The TextBox is then updated to display the new `Web.config` content.</span></span> <span data-ttu-id="f85e3-199">Как показано на рис. 4, `<connectionStrings>`ная информация теперь зашифрована.</span><span class="sxs-lookup"><span data-stu-id="f85e3-199">As Figure 4 shows, the `<connectionStrings>` information is now encrypted.</span></span>

<span data-ttu-id="f85e3-200">[![нажатии кнопки "шифровать строки подключения" шифрует &lt;раздел connectionString&gt;](protecting-connection-strings-and-other-configuration-information-cs/_static/image11.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="f85e3-200">[![Clicking the Encrypt Connection Strings Button Encrypts the &lt;connectionString&gt; Section](protecting-connection-strings-and-other-configuration-information-cs/_static/image11.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image10.png)</span></span>

<span data-ttu-id="f85e3-201">**Рис. 4**. нажатие кнопки "шифровать строки подключения" шифрует раздел `<connectionString>` ([щелкните, чтобы просмотреть изображение с полным размером](protecting-connection-strings-and-other-configuration-information-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="f85e3-201">**Figure 4**: Clicking the Encrypt Connection Strings Button Encrypts the `<connectionString>` Section ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image12.png))</span></span>

<span data-ttu-id="f85e3-202">Зашифрованный раздел `<connectionStrings>`, созданный на моем компьютере, хотя часть содержимого элемента `<CipherData>` была удалена для краткости:</span><span class="sxs-lookup"><span data-stu-id="f85e3-202">The encrypted `<connectionStrings>` section generated on my computer follows, although some of the content in the `<CipherData>` element has been removed for brevity:</span></span>

[!code-xml[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample4.xml)]

> [!NOTE]
> <span data-ttu-id="f85e3-203">Элемент `<connectionStrings>` указывает поставщика, используемого для шифрования (`DataProtectionConfigurationProvider`).</span><span class="sxs-lookup"><span data-stu-id="f85e3-203">The `<connectionStrings>` element specifies the provider used to perform the encryption (`DataProtectionConfigurationProvider`).</span></span> <span data-ttu-id="f85e3-204">Эти сведения используются методом `UnprotectSection` при нажатии кнопки расшифровывать строки подключения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-204">This information is used by the `UnprotectSection` method when the Decrypt Connection Strings button is clicked.</span></span>

<span data-ttu-id="f85e3-205">Когда доступ к сведениям о строке подключения осуществляется из `Web.config`ного кода, из элемента управления SqlDataSource или автоматически созданного кода из адаптеров таблиц TableAdapter в типизированных наборах данных, он автоматически расшифровывается.</span><span class="sxs-lookup"><span data-stu-id="f85e3-205">When the connection string information is accessed from `Web.config` - either by code we write, from a SqlDataSource control, or the auto-generated code from the TableAdapters in our Typed DataSets - it is automatically decrypted.</span></span> <span data-ttu-id="f85e3-206">Вкратце, нам не нужно добавлять дополнительный код или логику для расшифровки зашифрованного раздела `<connectionString>`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-206">In short, we do not need to add any extra code or logic to decrypt the encrypted `<connectionString>` section.</span></span> <span data-ttu-id="f85e3-207">Чтобы продемонстрировать это, посетите один из предыдущих руководств в настоящее время, например в учебнике по простому экрану в разделе "базовый отчет" (`~/BasicReporting/SimpleDisplay.aspx`).</span><span class="sxs-lookup"><span data-stu-id="f85e3-207">To demonstrate this, visit one of the earlier tutorials at this time, such as the Simple Display tutorial from the Basic Reporting section (`~/BasicReporting/SimpleDisplay.aspx`).</span></span> <span data-ttu-id="f85e3-208">Как показано на рис. 5, учебник работает точно так же, как и предполагается, что означает, что зашифрованная информация строки подключения автоматически расшифровывается страницей ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="f85e3-208">As Figure 5 shows, the tutorial works exactly as we would expect it, indicating that the encrypted connection string information is being automatically decrypted by the ASP.NET page.</span></span>

<span data-ttu-id="f85e3-209">[![уровень доступа к данным автоматически расшифровывает сведения строки подключения](protecting-connection-strings-and-other-configuration-information-cs/_static/image14.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="f85e3-209">[![The Data Access Layer Automatically Decrypts the Connection String Information](protecting-connection-strings-and-other-configuration-information-cs/_static/image14.png)](protecting-connection-strings-and-other-configuration-information-cs/_static/image13.png)</span></span>

<span data-ttu-id="f85e3-210">**Рис. 5**. уровень доступа к данным автоматически расшифровывает данные строки подключения ([щелкните, чтобы просмотреть изображение с полным размером](protecting-connection-strings-and-other-configuration-information-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="f85e3-210">**Figure 5**: The Data Access Layer Automatically Decrypts the Connection String Information ([Click to view full-size image](protecting-connection-strings-and-other-configuration-information-cs/_static/image15.png))</span></span>

<span data-ttu-id="f85e3-211">Чтобы вернуть `<connectionStrings>` раздел к текстовому представлению, нажмите кнопку расшифровать строки подключения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-211">To revert the `<connectionStrings>` section back to its plain-text representation, click the Decrypt Connection Strings button.</span></span> <span data-ttu-id="f85e3-212">При обратной передаче строки подключения должны отображаться в `Web.config` в виде обычного текста.</span><span class="sxs-lookup"><span data-stu-id="f85e3-212">On postback you should see the connection strings in `Web.config` in plain-text.</span></span> <span data-ttu-id="f85e3-213">На этом этапе экран должен выглядеть, как при первом посещении этой страницы (см. рис. 3).</span><span class="sxs-lookup"><span data-stu-id="f85e3-213">At this point your screen should look like it did when first visiting this page (see in Figure 3).</span></span>

## <a name="step-3-encrypting-configuration-sections-usingaspnet_regiisexe"></a><span data-ttu-id="f85e3-214">Шаг 3. Шифрование разделов конфигурации с помощью`aspnet_regiis.exe`</span><span class="sxs-lookup"><span data-stu-id="f85e3-214">Step 3: Encrypting Configuration Sections Using`aspnet_regiis.exe`</span></span>

<span data-ttu-id="f85e3-215">.NET Framework включает в себя различные средства командной строки в папке `$WINDOWS$\Microsoft.NET\Framework\version\`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-215">The .NET Framework includes a variety of command line tools in the `$WINDOWS$\Microsoft.NET\Framework\version\` folder.</span></span> <span data-ttu-id="f85e3-216">Например, в учебнике [Использование зависимостей кэша SQL](../caching-data/using-sql-cache-dependencies-cs.md) мы рассматривали использование программы командной строки `aspnet_regsql.exe` для добавления инфраструктуры, необходимой для зависимостей кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="f85e3-216">In the [Using SQL Cache Dependencies](../caching-data/using-sql-cache-dependencies-cs.md) tutorial, for instance, we looked at using the `aspnet_regsql.exe` command line tool to add the infrastructure necessary for SQL cache dependencies.</span></span> <span data-ttu-id="f85e3-217">Еще одним полезным средством командной строки в этой папке является [средство регистрации ASP.NET IIS (`aspnet_regiis.exe`)](https://msdn.microsoft.com/library/k6h9cz8h(VS.80).aspx).</span><span class="sxs-lookup"><span data-stu-id="f85e3-217">Another useful command line tool in this folder is the [ASP.NET IIS Registration tool (`aspnet_regiis.exe`)](https://msdn.microsoft.com/library/k6h9cz8h(VS.80).aspx).</span></span> <span data-ttu-id="f85e3-218">Как следует из названия, средство регистрации ASP.NET IIS в основном используется для регистрации приложения ASP.NET 2,0 с веб-сервером Microsoft s профессионального уровня, IIS.</span><span class="sxs-lookup"><span data-stu-id="f85e3-218">As its name implies, the ASP.NET IIS Registration tool is primarily used to register an ASP.NET 2.0 application with Microsoft s professional-grade Web server, IIS.</span></span> <span data-ttu-id="f85e3-219">Помимо функций, связанных с IIS, средство регистрации ASP.NET IIS также можно использовать для шифрования или расшифровки указанных разделов конфигурации в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-219">In addition to its IIS-related features, the ASP.NET IIS Registration tool can also be used to encrypt or decrypt specified configuration sections in `Web.config`.</span></span>

<span data-ttu-id="f85e3-220">В следующей инструкции показан общий синтаксис, используемый для шифрования раздела конфигурации с помощью средства командной строки `aspnet_regiis.exe`.</span><span class="sxs-lookup"><span data-stu-id="f85e3-220">The following statement shows the general syntax used to encrypt a configuration section with the `aspnet_regiis.exe` command line tool:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample5.cmd)]

<span data-ttu-id="f85e3-221">*раздел* — это раздел конфигурации для шифрования (например, ConnectionString), *физический\_каталог* — полный физический путь к корневому каталогу веб-приложения, а *provider* — имя поставщика защищенной конфигурации для использования (например, датапротектионконфигуратионпровидер).</span><span class="sxs-lookup"><span data-stu-id="f85e3-221">*section* is the configuration section to encrypt (like connectionStrings ), the *physical\_directory* is the full, physical path to the web application s root directory, and *provider* is the name of the protected configuration provider to use (such as DataProtectionConfigurationProvider ).</span></span> <span data-ttu-id="f85e3-222">Кроме того, если веб-приложение зарегистрировано в службах IIS, можно ввести виртуальный путь вместо физического пути, используя следующий синтаксис:</span><span class="sxs-lookup"><span data-stu-id="f85e3-222">Alternatively, if the web application is registered in IIS you can enter the virtual path instead of the physical path using the following syntax:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample6.cmd)]

<span data-ttu-id="f85e3-223">В следующем примере `aspnet_regiis.exe` `<connectionStrings>` раздел шифруется с помощью поставщика DPAPI с ключом уровня компьютера:</span><span class="sxs-lookup"><span data-stu-id="f85e3-223">The following `aspnet_regiis.exe` example encrypts the `<connectionStrings>` section using the DPAPI provider with a machine-level key:</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample7.cmd)]

<span data-ttu-id="f85e3-224">Аналогичным образом средство командной строки `aspnet_regiis.exe` можно использовать для расшифровки разделов конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f85e3-224">Similarly, the `aspnet_regiis.exe` command line tool can be used to decrypt configuration sections.</span></span> <span data-ttu-id="f85e3-225">Вместо использования параметра `-pef` используйте `-pdf` (или вместо `-pe`используйте `-pd`).</span><span class="sxs-lookup"><span data-stu-id="f85e3-225">Instead of using the `-pef` switch, use `-pdf` (or instead of `-pe`, use `-pd`).</span></span> <span data-ttu-id="f85e3-226">Кроме того, обратите внимание, что при расшифровке не требуется имя поставщика.</span><span class="sxs-lookup"><span data-stu-id="f85e3-226">Also, note that the provider name is not necessary when decrypting.</span></span>

[!code-console[Main](protecting-connection-strings-and-other-configuration-information-cs/samples/sample8.cmd)]

> [!NOTE]
> <span data-ttu-id="f85e3-227">Так как мы используем поставщик DPAPI, который использует ключи, относящиеся к компьютеру, необходимо запустить `aspnet_regiis.exe` с того же компьютера, с которого обслуживаются веб-страницы.</span><span class="sxs-lookup"><span data-stu-id="f85e3-227">Since we are using the DPAPI provider, which uses keys specific to the computer, you must run `aspnet_regiis.exe` from the same machine from which the web pages are being served.</span></span> <span data-ttu-id="f85e3-228">Например, если запустить эту программу командной строки с локального компьютера разработки, а затем передать зашифрованный файл Web. config рабочему серверу, то рабочий сервер не сможет расшифровать данные строки подключения с момента шифрования. Использование ключей, характерных для компьютера разработки.</span><span class="sxs-lookup"><span data-stu-id="f85e3-228">For example, if you run this command line program from your local development machine and then upload the encrypted Web.config file to the production server, the production server will not be able to decrypt the connection string information since it was encrypted using keys specific to your development machine.</span></span> <span data-ttu-id="f85e3-229">Поставщик RSA не имеет этого ограничения, так как можно экспортировать ключи RSA на другой компьютер.</span><span class="sxs-lookup"><span data-stu-id="f85e3-229">The RSA provider does not have this limitation as it is possible to export the RSA keys to another machine.</span></span>

## <a name="understanding-database-authentication-options"></a><span data-ttu-id="f85e3-230">Основные сведения о параметрах аутентификации базы данных</span><span class="sxs-lookup"><span data-stu-id="f85e3-230">Understanding Database Authentication Options</span></span>

<span data-ttu-id="f85e3-231">Прежде чем какое-либо приложение сможет выдавать `SELECT`, `INSERT`, `UPDATE`или `DELETE` запросы к базе данных Microsoft SQL Server, база данных сначала должна опознать запрашивающий.</span><span class="sxs-lookup"><span data-stu-id="f85e3-231">Before any application can issue `SELECT`, `INSERT`, `UPDATE`, or `DELETE` queries to a Microsoft SQL Server database, the database first must identify the requestor.</span></span> <span data-ttu-id="f85e3-232">Этот процесс называется *проверкой подлинности* , а SQL Server предоставляет два метода проверки подлинности:</span><span class="sxs-lookup"><span data-stu-id="f85e3-232">This process is known as *authentication* and SQL Server provides two methods of authentication:</span></span>

- <span data-ttu-id="f85e3-233">**Проверка подлинности Windows** . процесс, при котором выполняется приложение, используется для взаимодействия с базой данных.</span><span class="sxs-lookup"><span data-stu-id="f85e3-233">**Windows Authentication** - the process under which the application is running is used to communicate with the database.</span></span> <span data-ttu-id="f85e3-234">При запуске приложения ASP.NET с помощью Visual Studio 2005 s ASP.NET Development Server в приложении ASP.NET предполагается удостоверение вошедшего в систему пользователя.</span><span class="sxs-lookup"><span data-stu-id="f85e3-234">When running an ASP.NET application through Visual Studio 2005 s ASP.NET Development Server, the ASP.NET application assumes the identity of the currently logged on user.</span></span> <span data-ttu-id="f85e3-235">Для ASP.NET приложений на сервере Microsoft Internet Information Server (IIS) ASP.NET приложения обычно предполагают идентификацию `domainName``\MachineName` или `domainName``\NETWORK SERVICE`, хотя это можно настроить.</span><span class="sxs-lookup"><span data-stu-id="f85e3-235">For ASP.NET applications on Microsoft Internet Information Server (IIS), ASP.NET applications usually assume the identity of `domainName``\MachineName` or `domainName``\NETWORK SERVICE`, although this can be customized.</span></span>
- <span data-ttu-id="f85e3-236">**Проверка подлинности SQL** . значения идентификатора пользователя и пароля предоставляются в качестве учетных данных для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="f85e3-236">**SQL Authentication** - a user ID and password values are supplied as credentials for authentication.</span></span> <span data-ttu-id="f85e3-237">При использовании проверки подлинности SQL идентификатор пользователя и пароль предоставляются в строке подключения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-237">With SQL authentication, the user ID and password are provided in the connection string.</span></span>

<span data-ttu-id="f85e3-238">Проверка подлинности Windows предпочтительнее, чем проверка подлинности SQL, так как она более безопасна.</span><span class="sxs-lookup"><span data-stu-id="f85e3-238">Windows authentication is preferred over SQL authentication because it is more secure.</span></span> <span data-ttu-id="f85e3-239">При использовании проверки подлинности Windows строка подключения предоставляется бесплатно из имени пользователя и пароля. Если веб-сервер и сервер базы данных находятся на двух разных компьютерах, то эти учетные данные не отправляются по сети в виде обычного текста.</span><span class="sxs-lookup"><span data-stu-id="f85e3-239">With Windows authentication the connection string is free from a username and password and if the web server and database server reside on two different machines, the credentials are not sent over the network in plain-text.</span></span> <span data-ttu-id="f85e3-240">Однако при использовании проверки подлинности SQL учетные данные проверки подлинности жестко запрограммированы в строке подключения и передаются с веб-сервера на сервер базы данных в виде обычного текста.</span><span class="sxs-lookup"><span data-stu-id="f85e3-240">With SQL authentication, however, the authentication credentials are hard-coded in the connection string and are transmitted from the web server to the database server in plain-text.</span></span>

<span data-ttu-id="f85e3-241">В этих учебниках используется проверка подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="f85e3-241">These tutorials have used Windows authentication.</span></span> <span data-ttu-id="f85e3-242">Чтобы узнать, какой режим проверки подлинности используется, проверьте строку подключения.</span><span class="sxs-lookup"><span data-stu-id="f85e3-242">You can tell what authentication mode is being used by inspecting the connection string.</span></span> <span data-ttu-id="f85e3-243">Строка подключения в `Web.config` для наших учебников:</span><span class="sxs-lookup"><span data-stu-id="f85e3-243">The connection string in `Web.config` for our tutorials has been:</span></span>

`Data Source=.\SQLEXPRESS; AttachDbFilename=|DataDirectory|\NORTHWND.MDF; Integrated Security=True; User Instance=True`

<span data-ttu-id="f85e3-244">Встроенная безопасность = true и отсутствие имени пользователя и пароля указывают на то, что используется проверка подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="f85e3-244">The Integrated Security=True and lack of a username and password indicate that Windows authentication is being used.</span></span> <span data-ttu-id="f85e3-245">В некоторых строках подключения используется термин доверительное соединение = да или встроенная безопасность = SSPI вместо встроенной безопасности = true, но все три указывают на использование проверки подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="f85e3-245">In some connection strings the term Trusted Connection=Yes or Integrated Security=SSPI is used instead of Integrated Security=True, but all three indicate the use of Windows authentication.</span></span>

<span data-ttu-id="f85e3-246">В следующем примере показана строка подключения, использующая проверку подлинности SQL.</span><span class="sxs-lookup"><span data-stu-id="f85e3-246">The following example shows a connection string that uses SQL authentication.</span></span> <span data-ttu-id="f85e3-247">Обратите внимание на учетные данные, внедренные в строку подключения:</span><span class="sxs-lookup"><span data-stu-id="f85e3-247">Note the credentials embedded within the connection string:</span></span>

`Server=serverName; Database=Northwind; uid=userID; pwd=password`

<span data-ttu-id="f85e3-248">Представьте себе, что злоумышленник может просмотреть приложение `Web.config` файл.</span><span class="sxs-lookup"><span data-stu-id="f85e3-248">Imagine that an attacker is able to view your application s `Web.config` file.</span></span> <span data-ttu-id="f85e3-249">Если для подключения к базе данных, доступной через Интернет, используется проверка подлинности SQL, злоумышленник может использовать эту строку подключения для подключения к базе данных с помощью SQL Management Studio или ASP.NET страниц на своем собственном веб-сайте.</span><span class="sxs-lookup"><span data-stu-id="f85e3-249">If you use SQL authentication to connect to a database that is accessible over the Internet, the attacker can use this connection string to connect to your database through SQL Management Studio or from ASP.NET pages on their own website.</span></span> <span data-ttu-id="f85e3-250">Чтобы уменьшить эту угрозу, зашифруйте данные строки подключения в `Web.config` с помощью системы защищенной конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f85e3-250">To help mitigate this threat, encrypt the connection string information in `Web.config` using the protected configuration system.</span></span>

> [!NOTE]
> <span data-ttu-id="f85e3-251">Дополнительные сведения о различных типах проверки подлинности, доступных в SQL Server, см. в разделе [Создание безопасных приложений ASP.NET: проверка подлинности, авторизация и безопасная связь](https://msdn.microsoft.com/library/aa302392.aspx).</span><span class="sxs-lookup"><span data-stu-id="f85e3-251">For more information on the different types of authentication available in SQL Server, see [Building Secure ASP.NET Applications: Authentication, Authorization, and Secure Communication](https://msdn.microsoft.com/library/aa302392.aspx).</span></span> <span data-ttu-id="f85e3-252">Дополнительные примеры строк подключения, иллюстрирующие различия между синтаксисом проверки подлинности Windows и SQL, см. в разделе [connectionStrings.com](http://www.connectionstrings.com/).</span><span class="sxs-lookup"><span data-stu-id="f85e3-252">For further connection string examples illustrating the differences between Windows and SQL authentication syntax, refer to [ConnectionStrings.com](http://www.connectionstrings.com/).</span></span>

## <a name="summary"></a><span data-ttu-id="f85e3-253">Сводка</span><span class="sxs-lookup"><span data-stu-id="f85e3-253">Summary</span></span>

<span data-ttu-id="f85e3-254">По умолчанию файлы с расширением `.config` в приложении ASP.NET недоступны через браузер.</span><span class="sxs-lookup"><span data-stu-id="f85e3-254">By default, files with a `.config` extension in an ASP.NET application cannot be accessed through a browser.</span></span> <span data-ttu-id="f85e3-255">Эти типы файлов не возвращаются, так как они могут содержать конфиденциальные сведения, например строки подключения к базе данных, имена пользователей и пароли и т. д.</span><span class="sxs-lookup"><span data-stu-id="f85e3-255">These types of files are not returned because they may contain sensitive information, such as database connection strings, usernames and passwords, and so on.</span></span> <span data-ttu-id="f85e3-256">Защищенная система конфигурации в .NET 2,0 помогает дополнительно защитить конфиденциальную информацию, позволяя зашифровать указанные разделы конфигурации.</span><span class="sxs-lookup"><span data-stu-id="f85e3-256">The protected configuration system in .NET 2.0 helps further protect sensitive information by allowing specified configuration sections to be encrypted.</span></span> <span data-ttu-id="f85e3-257">Существует два встроенных поставщика защищенной конфигурации: один использует алгоритм RSA и один, использующий API защиты данных Windows (DPAPI).</span><span class="sxs-lookup"><span data-stu-id="f85e3-257">There are two built-in protected configuration providers: one that uses the RSA algorithm and one that uses the Windows Data Protection API (DPAPI).</span></span>

<span data-ttu-id="f85e3-258">В этом учебнике мы рассмотрели шифрование и расшифровку параметров конфигурации с помощью поставщика DPAPI.</span><span class="sxs-lookup"><span data-stu-id="f85e3-258">In this tutorial we looked at how to encrypt and decrypt configuration settings using the DPAPI provider.</span></span> <span data-ttu-id="f85e3-259">Это можно сделать программно, как было показано на шаге 2, а также с помощью средства командной строки `aspnet_regiis.exe`, которое было рассмотрено на шаге 3.</span><span class="sxs-lookup"><span data-stu-id="f85e3-259">This can be accomplished both programmatically, as we saw in Step 2, as well as through the `aspnet_regiis.exe` command line tool, which was covered in Step 3.</span></span> <span data-ttu-id="f85e3-260">Дополнительные сведения об использовании ключей уровня пользователя или поставщика RSA см. в разделе ресурсы в дальнейшем.</span><span class="sxs-lookup"><span data-stu-id="f85e3-260">For more information on using user-level keys or using the RSA provider instead, see the resources in the Further Reading section.</span></span>

<span data-ttu-id="f85e3-261">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="f85e3-261">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="f85e3-262">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="f85e3-262">Further Reading</span></span>

<span data-ttu-id="f85e3-263">Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:</span><span class="sxs-lookup"><span data-stu-id="f85e3-263">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="f85e3-264">Создание безопасного приложения ASP.NET: проверка подлинности, авторизация и безопасное взаимодействие</span><span class="sxs-lookup"><span data-stu-id="f85e3-264">Building Secure ASP.NET Application: Authentication, Authorization, and Secure Communication</span></span>](https://msdn.microsoft.com/library/aa302392.aspx)
- [<span data-ttu-id="f85e3-265">Шифрование сведений о конфигурации в приложениях ASP.NET 2,0</span><span class="sxs-lookup"><span data-stu-id="f85e3-265">Encrypting Configuration Information in ASP.NET 2.0 Applications</span></span>](http://aspnet.4guysfromrolla.com/articles/021506-1.aspx)
- [<span data-ttu-id="f85e3-266">Шифрование значений `Web.config` в ASP.NET 2,0</span><span class="sxs-lookup"><span data-stu-id="f85e3-266">Encrypting `Web.config` Values in ASP.NET 2.0</span></span>](https://weblogs.asp.net/scottgu/archive/2006/01/09/434893.aspx)
- [<span data-ttu-id="f85e3-267">Инструкции. Шифрование разделов конфигурации в ASP.NET 2,0 с помощью DPAPI</span><span class="sxs-lookup"><span data-stu-id="f85e3-267">How To: Encrypt Configuration Sections in ASP.NET 2.0 Using DPAPI</span></span>](https://msdn.microsoft.com/library/ms998280.aspx)
- [<span data-ttu-id="f85e3-268">Инструкции. Шифрование разделов конфигурации в ASP.NET 2,0 с помощью RSA</span><span class="sxs-lookup"><span data-stu-id="f85e3-268">How To: Encrypt Configuration Sections in ASP.NET 2.0 Using RSA</span></span>](https://msdn.microsoft.com/library/ms998283.aspx)
- [<span data-ttu-id="f85e3-269">API конфигурации в .NET 2,0</span><span class="sxs-lookup"><span data-stu-id="f85e3-269">The Configuration API in .NET 2.0</span></span>](http://www.odetocode.com/Articles/418.aspx)
- [<span data-ttu-id="f85e3-270">Защита данных Windows</span><span class="sxs-lookup"><span data-stu-id="f85e3-270">Windows Data Protection</span></span>](https://msdn.microsoft.com/library/ms995355.aspx)

## <a name="about-the-author"></a><span data-ttu-id="f85e3-271">Об авторе</span><span class="sxs-lookup"><span data-stu-id="f85e3-271">About the Author</span></span>

<span data-ttu-id="f85e3-272">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998.</span><span class="sxs-lookup"><span data-stu-id="f85e3-272">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="f85e3-273">Скотт работает как независимый консультант, преподаватель и модуль записи.</span><span class="sxs-lookup"><span data-stu-id="f85e3-273">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="f85e3-274">Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="f85e3-274">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="f85e3-275">Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f85e3-275">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="f85e3-276">или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="f85e3-276">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="f85e3-277">Специальная благодарность</span><span class="sxs-lookup"><span data-stu-id="f85e3-277">Special Thanks To</span></span>

<span data-ttu-id="f85e3-278">Эта серия руководств была рассмотрена многими полезными рецензентами.</span><span class="sxs-lookup"><span data-stu-id="f85e3-278">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="f85e3-279">Потенциальные рецензенты для этого учебника были Терезой Мерфи и Рэнди Шмидт.</span><span class="sxs-lookup"><span data-stu-id="f85e3-279">Lead reviewers for this tutorial were Teresa Murphy and Randy Schmidt.</span></span> <span data-ttu-id="f85e3-280">Хотите ознакомиться с моими будущими статьями MSDN?</span><span class="sxs-lookup"><span data-stu-id="f85e3-280">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="f85e3-281">Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f85e3-281">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="f85e3-282">[Назад](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs.md)
> [Вперед](debugging-stored-procedures-cs.md)</span><span class="sxs-lookup"><span data-stu-id="f85e3-282">[Previous](configuring-the-data-access-layer-s-connection-and-command-level-settings-cs.md)
[Next](debugging-stored-procedures-cs.md)</span></span>
