---
uid: web-forms/overview/data-access/enhancing-the-gridview/inserting-a-new-record-from-the-gridview-s-footer-cs
title: Вставка новой записи из нижнего колонтитула GridView (C#) | Документация Майкрософт
author: rick-anderson
description: Хотя элемент управления GridView не предоставляет встроенную поддержку для вставки новой записи данных, в этом руководстве показано, как дополнить GridView, включив...
ms.author: riande
ms.date: 03/06/2007
ms.assetid: 49545652-98af-46ba-9dbc-9ab529805d9b
msc.legacyurl: /web-forms/overview/data-access/enhancing-the-gridview/inserting-a-new-record-from-the-gridview-s-footer-cs
msc.type: authoredcontent
ms.openlocfilehash: 6b337fe395a0ed54b03767111e73ea6d6c0ba23a
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74591899"
---
# <a name="inserting-a-new-record-from-the-gridviews-footer-c"></a>Вставка новой записи из нижнего колонтитула GridView (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_53_CS.exe) или [Загрузка PDF-файла](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/datatutorial53cs1.pdf)

> Хотя элемент управления GridView не предоставляет встроенную поддержку для вставки новой записи данных, в этом руководстве показано, как дополнять GridView для включения интерфейса вставки.

## <a name="introduction"></a>Введение

Как обсуждалось в [обзоре учебника по вставке, обновлению и удалению данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) , в каждом из элементов управления GridView, DetailsView и FormView представлены встроенные возможности изменения данных. При использовании с декларативными элементами управления источниками данных эти три веб-элемента управления можно быстро и легко настроить для изменения данных и в сценариях без необходимости написания одной строки кода. К сожалению, только элементы управления DetailsView и FormView предоставляют встроенные возможности для вставки, редактирования и удаления. GridView предлагает только поддержку редактирования и удаления. Однако с небольшой изогнутой пастой можно дополнить GridView, включив в него интерфейс вставки.

При добавлении возможностей вставки в GridView мы будем отвечать за выбор способа добавления новых записей, создание интерфейса вставки и написание кода для вставки новой записи. В этом учебнике мы рассмотрим Добавление интерфейса вставки в строку нижнего колонтитула GridView (см. рис. 1). Ячейка нижнего колонтитула для каждого столбца содержит соответствующий элемент пользовательского интерфейса сбора данных (текстовое поле для имени продукта, DropDownList для поставщика и т. д.). Нам также нужен столбец для кнопки Add, которая при нажатии вызовет обратную передачу и вставляет новую запись в `Products`ную таблицу, используя значения, указанные в строке нижнего колонтитула.

[![строка нижнего колонтитула предоставляет интерфейс для добавления новых продуктов](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image1.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image1.png)

**Рис. 1**. строка нижнего колонтитула предоставляет интерфейс для добавления новых продуктов ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image2.png))

## <a name="step-1-displaying-product-information-in-a-gridview"></a>Шаг 1. Отображение сведений о продукте в элементе управления GridView

Прежде чем мы будем беспокоиться о создании интерфейса вставки в нижнем колонтитуле GridView, давайте попробуем добавить GridView на страницу, в которой перечислены продукты в базе данных. Для начала откройте страницу `InsertThroughFooter.aspx` в папке `EnhancedGridView` и перетащите элемент управления GridView с панели инструментов в конструктор, установив для свойства `ID` GridView s значение `Products`. Затем используйте смарт-тег GridView s, чтобы привязать его к новому ObjectDataSource с именем `ProductsDataSource`.

[![создать новый элемент управления ObjectDataSource с именем Продуктсдатасаурце](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image2.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image3.png)

**Рис. 2**. Создание нового элемента управления ObjectDataSource с именем `ProductsDataSource` ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image4.png))

Настройте ObjectDataSource для использования метода `ProductsBLL` классов `GetProducts()` для получения сведений о продукте. В этом руководстве мы будем сосредоточиться только на добавлении возможностей вставки, а не беспокоиться об изменении и удалении. Поэтому убедитесь, что раскрывающийся список на вкладке Вставка имеет значение `AddProduct()` и что в раскрывающихся списках на вкладках обновление и удаление установлено значение (нет).

[![сопоставьте метод AddProduct с методом ObjectDataSource s INSERT ()](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image3.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image5.png)

**Рис. 3**. сопоставьте метод `AddProduct` с методом `Insert()` ObjectDataSource ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image6.png))

[![задать для раскрывающихся списков обновления и удаления значение (нет)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image4.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image7.png)

**Рис. 4**. Установка в раскрывающихся СПИСКАХ «обновление» и «удаление» (нет) ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image8.png))

После завершения работы мастера настройки источников данных ObjectDataSource в Visual Studio автоматически добавляются поля в GridView для каждого из соответствующих полей данных. Пока оставьте все поля, добавленные Visual Studio. Далее в этом учебнике мы вернемся и удалим некоторые из полей, значения которых не нужно указывать при добавлении новой записи.

Так как в базе данных имеется близкое к 80 продуктов, пользователю придется прокручивать все до нижнего края веб-страницы, чтобы добавить новую запись. Таким образом, разрешите разбиение по страницам, чтобы сделать интерфейс вставки видимым и доступным. Чтобы включить подкачку, просто установите флажок Включить разбиение по страницам в смарт-теге GridView s.

На этом этапе декларативная разметка GridView и ObjectDataSource s должна выглядеть следующим образом:

[!code-aspx[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample1.aspx)]

[![все поля данных продукта отображаются в элементе управления GridView с постраничным отображением](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image5.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image9.png)

**Рис. 5**. все поля данных продукта отображаются в элементе управления GridView с постраничным[просмотром (щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image10.png))

## <a name="step-2-adding-a-footer-row"></a>Шаг 2. Добавление строки нижнего колонтитула

Вместе с заголовком и строками данных GridView включает строку нижнего колонтитула. Строки верхнего и нижнего колонтитулов отображаются в зависимости от значений свойств [`ShowHeader`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.showheader.aspx) GridView s и [`ShowFooter`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.showfooter.aspx) . Чтобы отобразить строку нижнего колонтитула, просто задайте для свойства `ShowFooter` значение `true`. Как показано на рис. 6, установка свойства `ShowFooter` в `true` добавляет к сетке строку нижнего колонтитула.

[![, чтобы отобразить строку нижнего колонтитула, установите для Шовфутер значение true.](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image6.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image11.png)

**Рис. 6**. чтобы отобразить строку нижнего колонтитула, присвойте параметру `ShowFooter` значение `True` ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image12.png))

Обратите внимание, что строка нижнего колонтитула имеет темно-красный цвет фона. Это связано с тем, что мы создали и применили тему для всех страниц в [данных с помощью](../basic-reporting/displaying-data-with-the-objectdatasource-cs.md) учебника по ObjectDataSource. В частности, файл `GridView.skin` настраивает свойство `FooterStyle` таким образом, что использует класс `FooterStyle` CSS. Класс `FooterStyle` определяется в `Styles.css` следующим образом:

[!code-css[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample2.css)]

> [!NOTE]
> Мы проучили использование строки нижнего колонтитула GridView в предыдущих руководствах. При необходимости вернитесь к [отображению сводных данных в руководстве по нижнему колонтитулу GridView](../custom-formatting/displaying-summary-information-in-the-gridview-s-footer-cs.md) для обновления.

Установив для свойства `ShowFooter` значение `true`, просмотрите выходные данные в браузере. В настоящее время строка нижнего колонтитула не содержит текста или веб-элементов управления. На этапе 3 мы изменим нижний колонтитул для каждого поля GridView, чтобы он включал соответствующий интерфейс вставки.

[![пустая строка нижнего колонтитула отображается над элементами управления "интерфейс разбиения по страницам"](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image7.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image13.png)

**Рис. 7**. пустая строка нижнего колонтитула отображается над элементами управления "интерфейс разбиения по страницам" ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image14.png))

## <a name="step-3-customizing-the-footer-row"></a>Шаг 3. Настройка строки нижнего колонтитула

Вернемся к [использованию полей TemplateField в учебнике по элементу управления GridView](../custom-formatting/using-templatefields-in-the-gridview-control-cs.md) мы увидели, как значительно настроить отображение определенного столбца GridView с помощью полей TemplateField (в отличие от BoundFields или чеккбоксфиелдс). При [настройке интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) мы рассматривали использование полей TemplateField для настройки интерфейса редактирования в GridView. Помните, что TemplateField состоит из нескольких шаблонов, определяющих сочетание разметки, веб-элементов управления и синтаксиса привязки данных, используемого для определенных типов строк. `ItemTemplate`, например, указывает шаблон, используемый для строк только для чтения, а `EditItemTemplate` определяет шаблон для редактируемой строки.

Вместе с `ItemTemplate` и `EditItemTemplate`TemplateField также содержит `FooterTemplate`, которое указывает содержимое для строки нижнего колонтитула. Поэтому мы можем добавить веб-элементы управления, необходимые для вставки интерфейса каждого поля в `FooterTemplate`. Чтобы начать, преобразуйте все поля в элементе управления GridView в полей TemplateField. Это можно сделать, щелкнув ссылку Edit Columns (изменить столбцы) в смарт-теге GridView s, выбрав каждое поле в левом нижнем углу и щелкнув элемент преобразовать это поле в ссылку TemplateField.

![Преобразование каждого поля в TemplateField](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image8.gif)

**Рис. 8**. преобразование каждого поля в TemplateField

При нажатии кнопки преобразовать это поле в TemplateField текущий тип поля преобразуется в эквивалентный TemplateField. Например, каждый BoundField заменяется TemplateField с `ItemTemplate`, содержащей метку, в которой отображается соответствующее поле данных, и `EditItemTemplate`, отображающая поле данных в текстовом поле. `ProductName` BoundField преобразован в следующую разметку TemplateField:

[!code-aspx[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample3.aspx)]

Аналогичным образом `Discontinued` CheckBoxField преобразован в TemplateField, чьи `ItemTemplate` и `EditItemTemplate` содержат веб-элемент управления CheckBox (с отключенным флажком `ItemTemplate` s). `ProductID` BoundField, доступная только для чтения, преобразована в TemplateField с элементом управления Label как в `ItemTemplate`, так и в `EditItemTemplate`. Коротко говоря, преобразование существующего поля GridView в TemplateField — это быстрый и простой способ переключения на более настраиваемый TemplateField без потери существующих функциональных возможностей полей.

Поскольку элемент управления GridView, который мы переработали в режиме поддержки, не поддерживает редактирование, вы можете удалить `EditItemTemplate` из каждого TemplateField, открывая только `ItemTemplate`. После этого декларативная разметка GridView s должна выглядеть следующим образом:

[!code-aspx[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample4.aspx)]

Теперь, когда каждое поле GridView было преобразовано в TemplateField, можно ввести соответствующий интерфейс вставки в каждое поле `FooterTemplate`. Некоторые поля не будут иметь интерфейс вставки (`ProductID`, например); другие зависят от веб-элементов управления, используемых для получения новых сведений о продуктах.

Чтобы создать интерфейс редактирования, выберите ссылку Edit Templates (изменить шаблоны) в смарт-теге GridView s. Затем в раскрывающемся списке выберите соответствующие поля `FooterTemplate` и перетащите соответствующий элемент управления из панели элементов в конструктор.

[![добавить соответствующий интерфейс вставки в каждое поле Футертемплате](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image9.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image15.png)

**Рис. 9**. добавление соответствующего интерфейса вставки в каждое поле `FooterTemplate` ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image16.png))

Следующий маркированный список перечисляет поля GridView, указывая добавляемый интерфейс вставки:

- `ProductID` нет.
- `ProductName` добавить текстовое поле и задать для его `ID` значение `NewProductName`. Добавьте элемент управления RequiredFieldValidator и убедитесь, что пользователь вводит значение для нового имени продукта.
- `SupplierID` нет.
- `CategoryID` нет.
- `QuantityPerUnit` добавить текстовое поле, задав для его `ID` значение `NewQuantityPerUnit`.
- `UnitPrice` добавить текстовое поле с именем `NewUnitPrice` и объект CompareValidator, гарантирующий, что значение является денежным значением, которое больше или равно нулю.
- `UnitsInStock` использовать текстовое поле, для `ID` которого задано значение `NewUnitsInStock`. Включите объект CompareValidator, гарантирующий, что указанное значение является целым числом, которое больше или равно нулю.
- `UnitsOnOrder` использовать текстовое поле, для `ID` которого задано значение `NewUnitsOnOrder`. Включите объект CompareValidator, гарантирующий, что указанное значение является целым числом, которое больше или равно нулю.
- `ReorderLevel` использовать текстовое поле, для `ID` которого задано значение `NewReorderLevel`. Включите объект CompareValidator, гарантирующий, что указанное значение является целым числом, которое больше или равно нулю.
- `Discontinued` добавить флажок, установив для его `ID` значение `NewDiscontinued`.
- `CategoryName` добавить DropDownList и задать для его `ID` значение `NewCategoryID`. Привяжите его к новому ObjectDataSource с именем `CategoriesDataSource` и настройте его для использования метода `CategoriesBLL` класса s `GetCategories()`. Элемент DropDownList `ListItem` s отображает поле данных `CategoryName`, используя `CategoryID` поле данных в качестве значений.
- `SupplierName` добавить DropDownList и задать для его `ID` значение `NewSupplierID`. Привяжите его к новому ObjectDataSource с именем `SuppliersDataSource` и настройте его для использования метода `SuppliersBLL` класса s `GetSuppliers()`. Элемент DropDownList `ListItem` s отображает поле данных `CompanyName`, используя `SupplierID` поле данных в качестве значений.

Для каждого элемента управления проверки Очистите свойство `ForeColor` таким образом, чтобы вместо красного по умолчанию использовался белый цвет переднего плана CSS Class `FooterStyle`. Кроме того, используйте свойство `ErrorMessage` для подробного описания, но для свойства `Text` установите звездочку. Чтобы не допустить, чтобы текст элемента управления проверки переносился к двум строкам, установите для свойства `FooterStyle` s `Wrap` значение false для каждого `FooterTemplate` с использованием элемента управления проверки. Наконец, добавьте элемент управления ValidationSummary под элементом GridView и задайте для его свойства `ShowMessageBox` значение `true` а свойству `ShowSummary` — значение `false`.

При добавлении нового продукта необходимо предоставить `CategoryID` и `SupplierID`. Эти сведения захватываются в элементов управления DropDownList в ячейках нижнего колонтитула для полей `CategoryName` и `SupplierName`. Я решил использовать эти поля в отличие от `CategoryID` и `SupplierID` полей TemplateField, поскольку в строках данных сетки s пользователь, скорее всего, больше заинтересован в просмотре имен категорий и поставщиков, а не их значений ИДЕНТИФИКАТОРов. Так как значения `CategoryID` и `SupplierID` теперь фиксируются в интерфейсах вставки полей `CategoryName` и `SupplierName`, можно удалить `CategoryID` и `SupplierID` полей TemplateField из GridView.

Аналогичным образом `ProductID` не используется при добавлении нового продукта, поэтому `ProductID` TemplateField также можно удалить. Однако добавим поле `ProductID` в сетке. В дополнение к элементам управления TextBox, элементов управления DropDownList, CheckBox и Validation, которые составляют интерфейс вставки, также потребуется кнопка Добавить, которая при нажатии выполняет логику для добавления нового продукта в базу данных. На шаге 4 будет добавлена кнопка Добавить в интерфейс вставки `ProductID` TemplateField s `FooterTemplate`.

Вы можете улучшить внешний вид различных полей GridView. Например, можно отформатировать `UnitPrice` значения как валюту, выровняйте по правому краю поля `UnitsInStock`, `UnitsOnOrder`и `ReorderLevel` и обновить значения `HeaderText` для полей TemplateField.

После создания интерфейсов вставки в `FooterTemplate` s, удаления `SupplierID`и `CategoryID` полей TemplateField, а также улучшения эстетичность сетки с помощью форматирования и согласования полей TemplateField, декларативная разметка GridView s должна выглядеть следующим образом:

[!code-aspx[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample5.aspx)]

При просмотре в браузере строка нижнего колонтитула GridView теперь включает в себя готовый интерфейс вставки (см. рис. 10). На этом этапе интерфейс вставки не содержит средств, позволяющих пользователю указать, что он вводит данные для нового продукта и хочет вставить новую запись в базу данных. Кроме того, мы работаем над тем, как данные, введенные в нижний колонтитул, будут преобразованы в новую запись в базе данных `Products`. На шаге 4 мы рассмотрим, как включить кнопку Добавить в интерфейс вставки и как выполнить код при обратной передаче при нажатии. На шаге 5 показано, как вставить новую запись с использованием данных из нижнего колонтитула.

[![нижний колонтитул GridView предоставляет интерфейс для добавления новой записи](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image10.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image17.png)

**Рис. 10**. Нижний колонтитул GridView предоставляет интерфейс для добавления новой записи ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image18.png))

## <a name="step-4-including-an-add-button-in-the-inserting-interface"></a>Шаг 4. Включение кнопки "Добавить" в интерфейс вставки

В интерфейсе вставки можно включить кнопку Добавить, так как в настоящее время в интерфейсе вставки нижнего колонтитула отсутствуют средства, указывающие, что пользователь завершил ввод новых сведений о продукте. Это можно поместить в один из существующих `FooterTemplate` s или добавить в сетку новый столбец для этой цели. В рамках этого руководства Разместите кнопку Add (Добавить) в `ProductID` TemplateField s `FooterTemplate`.

В конструкторе щелкните ссылку Edit Templates (изменить шаблоны) в смарт-теге GridView s, а затем выберите `ProductID` поля `FooterTemplate` из раскрывающегося списка. Добавьте в шаблон веб-элемент управления Button (или LinkButton или ImageButton), указав для его идентификатора значение `AddProduct`, `CommandName` вставки, а также свойство `Text` для добавления, как показано на рис. 11.

[![поместить кнопку Добавить в ProductID TemplateField s Футертемплате](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image11.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image19.png)

**Рис. 11**. Добавление кнопки "Добавить" в `ProductID` TemplateField s `FooterTemplate` ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image20.png))

После включения кнопки "Добавить" проверьте страницу в браузере. Обратите внимание, что при нажатии кнопки Добавить с недопустимыми данными в интерфейсе вставки выполняется сокращенная обратная передача, а элемент управления ValidationSummary указывает на недопустимые данные (см. рис. 12). После введения соответствующих данных нажатие кнопки Добавить вызывает обратную передачу. Однако записи в базу данных не добавляются. Нам потребуется написать немного кода, чтобы фактически выполнить вставку.

[![обратная передача кнопки добавления в случае недопустимых данных в интерфейсе вставки сокращена.](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image12.gif)](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image21.png)

**Рис. 12**. обратная передача кнопки "Добавить" сокращена, если в интерфейсе вставки есть недопустимые данные ([щелкните, чтобы просмотреть изображение с полным размером](inserting-a-new-record-from-the-gridview-s-footer-cs/_static/image22.png))

> [!NOTE]
> Элементы управления проверки в интерфейсе вставки не были назначены группе проверки. Это нормально, пока интерфейс вставки является единственным набором элементов управления проверки на странице. Однако если на странице есть другие элементы управления проверки (например, элементы управления проверки в интерфейсе редактирования сетки s), элементы управления проверки в интерфейсе вставки и кнопки Добавить `ValidationGroup` свойства должны иметь одинаковое значение, чтобы связать эти элементы управления с определенной группой проверки. Дополнительные сведения о секционировании элементов управления проверки и кнопок на странице в группах проверки см. в разделе [которая разбила The Проверка элементов управления в ASP.NET 2,0](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx) .

## <a name="step-5-inserting-a-new-record-into-theproductstable"></a>Шаг 5. Вставка новой записи в таблицу`Products`

При использовании встроенных функций редактирования GridView элемент GridView автоматически обрабатывает всю работу, необходимую для выполнения обновления. В частности, при нажатии кнопки Обновить значения, указанные в интерфейсе редактирования, копируются в параметры в коллекции ObjectDataSource `UpdateParameters` и запускают обновление, вызывая метод ObjectDataSource `Update()`. Поскольку GridView не предоставляет такие встроенные функции для вставки, необходимо реализовать код, который вызывает метод ObjectDataSource `Insert()` и копирует значения из интерфейса вставки в коллекцию ObjectDataSource `InsertParameters`.

Эта логика вставки должна быть выполнена после нажатия кнопки Добавить. Как обсуждалось в разделе [Добавление и реагирование на кнопки в](../custom-button-actions/adding-and-responding-to-buttons-to-a-gridview-cs.md) руководстве по GridView, когда нажата кнопка, LinkButton или ImageButton в GridView, при обратной передаче возникает событие `RowCommand` GridView s. Это событие срабатывает, если кнопка, LinkButton или ImageButton была добавлена явно, например в кнопку Добавить в строке нижнего колонтитула, или если она была автоматически добавлена элементом GridView (например, в верхней части каждого столбца, если выбран параметр Включить сортировку) или Элемент LinkButton в интерфейсе разбиения по страницам, если выбран параметр Включить разбиение по страницам).

Поэтому, чтобы ответить на пользователя нажатием кнопки "Добавить", необходимо создать обработчик событий для события `RowCommand` GridView s. Поскольку это событие срабатывает при нажатии *любой* кнопки, LinkButton или ImageButton в GridView, крайне важно, чтобы мы пропускали только логику вставки, если свойство `CommandName`, передаваемое в обработчик событий, сопоставляется с `CommandName`ым значением кнопки Добавить (INSERT). Кроме того, мы также будем продолжать, только если проверяющие элементы управления сообщают о допустимых данных. Для этого создайте обработчик событий для `RowCommand` события с помощью следующего кода:

[!code-csharp[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample6.cs)]

> [!NOTE]
> Возможно, вас интересует, почему обработчик событий проверяет свойство `Page.IsValid`. В конце концов, не следует подавлять обратную передачу, если в интерфейсе вставки указаны недопустимые данные? Это предположение верно, если пользователь не отключил JavaScript или выполнил действия по обдействию логики проверки на стороне клиента. Вкратце, один из них не должен зависеть строго от проверки на стороне клиента. Перед началом работы с данными необходимо всегда выполнять проверку на наличие на стороне сервера.

На этапе 1 мы создали `ProductsDataSource` ObjectDataSource таким способом, чтобы его `Insert()` был сопоставлен с методом `ProductsBLL` класса s `AddProduct`. Чтобы вставить новую запись в таблицу `Products`, можно просто вызвать метод ObjectDataSource `Insert()`:

[!code-csharp[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample7.cs)]

Теперь, когда был вызван метод `Insert()`, остается только скопировать значения из интерфейса вставки в параметры, передаваемые в метод `ProductsBLL` класса s `AddProduct`. Как мы видели в статье [изучение событий, связанных с руководством по вставке, обновлению и удалению](../editing-inserting-and-deleting-data/examining-the-events-associated-with-inserting-updating-and-deleting-cs.md) , это можно сделать с помощью события `Inserting` ObjectDataSource. В `Inserting` событии необходимо программно ссылаться на элементы управления из строки нижнего колонтитула `Products` GridView и присваивать их значения коллекции `e.InputParameters`. Если пользователь опускает значение, например оставить поле `ReorderLevel` пустым, необходимо указать, что значение, вставляемое в базу данных, должно быть `NULL`. Так как метод `AddProducts` принимает типы, допускающие значение null, для полей базы данных, допускающих значения NULL, просто используйте тип, допускающий значение null, и задайте для его значения значение `null` в случае, если входные данные пользователя опущены.

[!code-csharp[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample8.cs)]

После завершения обработчика `Inserting` событий новые записи можно добавить в таблицу `Products` базы данных с помощью строки нижнего колонтитула GridView. Попробуйте добавить несколько новых продуктов.

## <a name="enhancing-and-customizing-the-add-operation"></a>Улучшение и настройка операции добавления

В настоящее время нажатие кнопки Добавить добавляет новую запись в таблицу базы данных, но не предоставляет никаких визуальных отзывов о том, что запись была успешно добавлена. В идеале для элемента управления Label или клиентского окна оповещение сообщает пользователю об успешном завершении вставки. Я оставлю это в качестве упражнения для читателя.

Элемент управления GridView, используемый в этом руководстве, не применяет порядок сортировки к указанным продуктам и не позволяет конечному пользователю сортировать данные. Следовательно, записи упорядочиваются по мере их расположения в базе данных по полю первичного ключа. Так как каждая новая запись имеет `ProductID` значение больше, чем последняя, каждый раз, когда добавляется новый продукт, он добавляется в конец сетки. Поэтому при добавлении новой записи пользователь может захотеть автоматически отправить его на последнюю страницу GridView. Это можно сделать, добавив следующую строку кода после вызова метода `ProductsDataSource.Insert()` в обработчике событий `RowCommand`, чтобы указать, что пользователь должен отправить на последнюю страницу после привязки данных к GridView:

[!code-csharp[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample9.cs)]

`SendUserToLastPage` — это логическая переменная на уровне страницы, которой изначально присвоено значение `false`. В обработчике событий `DataBound` GridView s, если `SendUserToLastPage` имеет значение false, свойство `PageIndex` обновляется для отправки пользователя на последнюю страницу.

[!code-csharp[Main](inserting-a-new-record-from-the-gridview-s-footer-cs/samples/sample10.cs)]

Причина, по которой свойство `PageIndex` задано в обработчике событий `DataBound` (в отличие от обработчика событий `RowCommand`), связано с тем, что при срабатывании обработчика событий `RowCommand` мы еще не добавили новую запись в таблицу базы данных `Products`. Таким образом, в обработчике событий `RowCommand` последний индекс страницы (`PageCount - 1`) представляет индекс последней страницы *до* добавления нового продукта. Для большинства добавляемых продуктов индекс последней страницы совпадает после добавления нового продукта. Но если добавленный продукт получает новый индекс последней страницы, то при неправильном обновлении `PageIndex` в обработчике событий `RowCommand` будет выполнено переход на вторую страницу (индекс последней страницы до добавления нового продукта), а не на новый индекс последней страницы. Так как обработчик событий `DataBound` срабатывает после добавления нового продукта и повторной привязки данных к сетке, установив свойство `PageIndex`, можно получить правильный индекс последней страницы.

Наконец, элемент управления GridView, используемый в этом учебнике, является довольно широким из-за количества полей, которые необходимо собрать для добавления нового продукта. Из-за этой ширины предпочтительнее использовать вертикальный макет DetailsView s. Общую ширину GridView можно уменьшить, собрав меньшее число входов. Возможно, нам не нужно составлять `UnitsOnOrder`, `UnitsInStock`и `ReorderLevel` поля при добавлении нового продукта. в этом случае эти поля можно удалить из GridView.

Чтобы настроить собираемые данные, можно использовать один из двух способов.

- Продолжайте использовать метод `AddProduct`, который ожидает значения полей `UnitsOnOrder`, `UnitsInStock`и `ReorderLevel`. В обработчике событий `Inserting` укажите жестко запрограммированные значения по умолчанию, используемые для этих входных данных, которые были удалены из интерфейса вставки.
- Создайте новую перегрузку метода `AddProduct` в классе `ProductsBLL`, который не принимает входные данные для полей `UnitsOnOrder`, `UnitsInStock`и `ReorderLevel`. Затем на странице ASP.NET настройте ObjectDataSource для использования этой новой перегрузки.

Любой из этих вариантов также будет работать одинаково. В прошлых учебных курсах мы использовали второй вариант, создавая несколько перегрузок для метода `UpdateProduct` `ProductsBLL` Class s.

## <a name="summary"></a>Сводка

В GridView отсутствуют встроенные возможности вставки, находящиеся в DetailsView и FormView, но с небольшой наработкой интерфейс вставки можно добавить в строку нижнего колонтитула. Чтобы отобразить строку нижнего колонтитула в GridView, достаточно установить для свойства `ShowFooter` значение `true`. Содержимое строки нижнего колонтитула можно настроить для каждого поля путем преобразования поля в TemplateField и добавления интерфейса вставки в `FooterTemplate`. Как было показано в этом учебнике, `FooterTemplate` может содержать кнопки, текстовые поля, элементов управления DropDownList, флажки, элементы управления источниками данных для заполнения веб-элементов управления, управляемых данными (например, элементов управления DropDownList), и элементов управления проверки. Вместе с элементами управления для сбора входных данных пользователя требуется кнопка Add, LinkButton или ImageButton.

При нажатии кнопки "Добавить" вызывается метод `Insert()` ObjectDataSource s для запуска рабочего процесса вставки. Затем ObjectDataSource вызывает настроенный метод Insert (метод `ProductsBLL` класса s `AddProduct` в этом руководстве). Необходимо скопировать значения из интерфейса вставки GridView s в коллекцию ObjectDataSource `InsertParameters`, прежде чем вызываемый метод вставки. Это можно сделать, программно обратившись к веб-элементам управления "интерфейс вставки" в обработчике событий ObjectDataSource `Inserting`.

В этом руководстве мы подробно рассмотрим методы улучшения внешнего вида GridView s. В следующем наборе учебников рассматривается работа с двоичными данными, такими как изображения, PDF-файлы, документы Word и т. д. и элементы управления данными.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Специалист по интересу для этого руководства был Бернадетте Леигх. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](adding-a-gridview-column-of-checkboxes-cs.md)
> [Вперед](adding-a-gridview-column-of-radio-buttons-vb.md)
