---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/using-parameterized-queries-with-the-sqldatasource-cs
title: Использование параметризованных запросов с помощью элемента управления SqlDataSource (C#) | Документация Майкрософт
author: rick-anderson
description: В этом руководстве мы по-прежнему наш взгляд на элемента управления SqlDataSource и узнайте, как определить параметризованных запросов. Параметры могут быть заданы оба объявл...
ms.author: riande
ms.date: 02/20/2007
ms.assetid: 9128aaac-afe2-449f-84b2-bb1d035083c4
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/using-parameterized-queries-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: 7a6401e881fd66ab21b58fd7d86085e0bc228b6a
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59410855"
---
# <a name="using-parameterized-queries-with-the-sqldatasource-c"></a>Использование параметризованных запросов с помощью элемента управления SqlDataSource (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачайте пример приложения](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_48_CS.exe) или [скачать PDF](using-parameterized-queries-with-the-sqldatasource-cs/_static/datatutorial48cs1.pdf)

> В этом руководстве мы по-прежнему наш взгляд на элемента управления SqlDataSource и узнайте, как определить параметризованных запросов. Параметры можно задать декларативно и программно и могут быть извлечены из нескольких расположений, таких как строку запроса, сеанс состояния, другие элементы управления и многое другое.


## <a name="introduction"></a>Вступление

В предыдущем учебном курсе мы рассмотрели использование элемента управления SqlDataSource для получения данных непосредственно из базы данных. С помощью мастера настройки источника данных, мы могли бы выбрать базу данных и затем либо: выбрать столбцы, возвращаемые из таблицы или представления. Введите пользовательские инструкции SQL; или используйте хранимую процедуру. Ли выбор столбцов из таблицы или представления, или ввести собственную инструкцию SQL, элемента управления SqlDataSource элемент управления s `SelectCommand` свойству назначается в конечном коде SQL ad-hoc `SELECT` инструкции и является это `SELECT` инструкции, которая является выполняется при SqlDataSource s `Select()` вызывается метод (программно или автоматически из данных веб-элемента управления).

SQL `SELECT` операторы, используемые в предыдущем руководстве s демонстрации не было `WHERE` предложения. В `SELECT` инструкции `WHERE` предложение может использоваться для ограничения результатов, возвращаемых. Например чтобы отобразить имена на продукты стоимостью более 50,00 долларов США, можно использовать следующий запрос:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample1.sql)]

Как правило, значения, используемые в `WHERE` предложение определить, какого-либо внешнего источника, например значение строки запроса, переменной сеанса или ввод пользователя с веб-элемент управления на странице. В идеальном случае указаны такие входные данные помощи *параметры*. С помощью Microsoft SQL Server, параметры задаются с помощью `@parameterName`, как в:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample2.sql)]

Элемента управления SqlDataSource поддерживает параметризованные запросы, как для `SELECT` инструкций и `INSERT`, `UPDATE`, и `DELETE` инструкций. Более того значения параметров могут быть автоматически извлечены из различных источников, строку запроса, состояние сеанса, элементы управления на странице и так далее так и программными средствами. В этом руководстве будет показано, как определить также параметризованных запросов, как указать параметр значения декларативно и программно.

> [!NOTE]
> В предыдущем учебном курсе мы по сравнению с ObjectDataSource, который стал наше средство выбора сначала 46 руководства с помощью элемента управления SqlDataSource, заметить сходства концептуальной. Это сходство также применять параметры. Параметры s ObjectDataSource, соответствующие входным параметрам для методов в уровне бизнес-логики. С помощью элемента управления SqlDataSource определения параметров непосредственно в SQL-запроса. Оба элемента управления создавать наборы параметров для их `Select()`, `Insert()`, `Update()`, и `Delete()` методов и оба могут иметь эти значения параметров, заполненное из предварительно определенных источников (значения строк запроса, переменные сеанса и т. д. ) или назначать программным образом.


## <a name="creating-a-parameterized-query"></a>Создание параметризованного запроса

Мастер настройки источника данных s элемента управления SqlDataSource предлагает три пути для определения команды, которые необходимо выполнить, чтобы получить записи базы данных:

- Выбирая столбцы из существующей таблицы или представления,
- Введя пользовательские инструкции SQL, или
- Выбрав хранимой процедуры

При выборе столбцов из существующей таблицы или представления, параметры для `WHERE` предложение необходимо указать с помощью добавления `WHERE` диалоговое окно «предложение». Создавая пользовательские инструкции SQL, однако можно ввести параметры непосредственно в `WHERE` предложение (с помощью `@parameterName` для обозначения каждого параметра). Объект [хранимой процедуры](http://www.awprofessional.com/articles/article.asp?p=25288&amp;rl=1) состоит из одного или нескольких инструкций SQL, и эти инструкции могут быть параметризованы. Параметры, используемые в инструкциях SQL, тем не менее, должны передаваться в качестве входных параметров хранимой процедуры.

Так как создание параметризованного запроса зависит от SqlDataSource s `SelectCommand` является указанного, позволяют s взгляните на всех трех подходов. Чтобы приступить к работе, откройте `ParameterizedQueries.aspx` странице в `SqlDataSource` папки, перетащите элемент управления SqlDataSource из инструментария в конструктор и задайте его `ID` для `Products25BucksAndUnderDataSource`. Затем щелкните ссылку Настройка источника данных в смарт-теге элемента управления s. Выберите базу данных, используемую (`NORTHWINDConnectionString`) и нажмите кнопку Далее.

## <a name="step-1-adding-awhereclause-when-picking-the-columns-from-a-table-or-view"></a>Шаг 1. Добавление`WHERE`предложение, при выборе столбцов из таблицы или представления

При выборе данные, возвращаемые из базы данных с помощью элемента управления SqlDataSource, мастер настройки источников данных позволяет нам просто выберите столбцы, для возвращения из существующей таблицы или представления (см. рис. 1). Это автоматически создает SQL `SELECT` инструкцию, которая отправляется в базу данных при SqlDataSource s `Select()` вызывается метод. Как и в предыдущем учебном курсе, выберите в раскрывающемся списке таблицу Products и проверьте `ProductID`, `ProductName`, и `UnitPrice` столбцов.


[![Выберите столбцы, возвращаемые из таблицы или представления](using-parameterized-queries-with-the-sqldatasource-cs/_static/image1.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image1.png)

**Рис. 1**: Выбрать столбцы для возвращаемого значения из таблицы или представления ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image2.png))


Для включения `WHERE` предложение в `SELECT` инструкцию, нажмите кнопку `WHERE` кнопку, которая вызывает добавление `WHERE` предложение диалоговом (см. рис. 2). Чтобы добавить параметр, чтобы ограничить результаты, возвращенные `SELECT` запрос, сначала выберите столбец, чтобы фильтровать данные по. Затем выберите оператор, используемый для фильтрации (=, &lt;, &lt;=, &gt;, и так далее). Наконец выберите источник s значения параметра, например, из строки запроса или состояние сеанса. После настройки параметра, нажмите кнопку Добавить, чтобы включить ее в `SELECT` запроса.

В этом примере s позволяют возвращать только те результаты где `UnitPrice` значение меньше или равно 25,00 долл. США. Таким образом, выбрать `UnitPrice` из раскрывающегося списка столбцов и &lt;= из списка оператора. При использовании значения параметра жестко (например, $25,00), или если значение параметра должно быть программно задана, выберите Нет исходного стрелку раскрывающегося списка. Затем введите значение параметра жестко в поле ввода значения 25,00 и завершить процесс, нажав кнопку «Добавить».


[![Ограничить результаты, возвращаемые из добавить предложение диалоговое окно](using-parameterized-queries-with-the-sqldatasource-cs/_static/image2.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image3.png)

**Рис. 2**: Ограничить результаты, возвращенные из Add `WHERE` диалоговое окно «предложение» ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image4.png))


После добавления параметра, нажмите кнопку ОК, чтобы вернуться в мастер настройки источника данных. `SELECT` Инструкции в нижней части мастера должен включать `WHERE` предложение with параметр с именем `@UnitPrice`:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample3.sql)]

> [!NOTE]
> Если указать несколько условий в `WHERE` предложение от добавления `WHERE` в диалоговом окне предложения мастера соединяет их с `AND` оператор. Если необходимо включить `OR` в `WHERE` предложение (такие как `WHERE UnitPrice <= @UnitPrice OR Discontinued = 1`) вам необходимо будет создать `SELECT` инструкцию через экран пользовательские инструкции SQL.


Завершить настройку элемента управления SqlDataSource (нажмите кнопку Далее, после чего завершите) и затем проверить декларативную разметку элемента управления SqlDataSource s. Разметка теперь включает `<SelectParameters>` коллекции, которая подробно рассматриваются источники для параметров в `SelectCommand`.


[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample4.aspx)]

Когда SqlDataSource s `Select()` вызывается метод, `UnitPrice` значение параметра (25,00) применяется к `@UnitPrice` параметр в `SelectCommand` перед отправкой в базу данных. Конечным результатом будет то только те продукты, которые меньше или равно $25,00 возвращаются из `Products` таблицы. Чтобы проверить это, добавить GridView к странице, привяжите его к этому источнику данных и просмотрите страницу через обозреватель. Вы увидите только этих продуктов в списке, которые меньше или равно $25,00 подтверждает рис. 3.


[![Отображаются только те продукты меньше чем или равен размеру 25,00 долл. США](using-parameterized-queries-with-the-sqldatasource-cs/_static/image3.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image5.png)

**Рис. 3**: Отображаются только те продукты меньше чем или равен размеру 25,00 долл. США ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image6.png))


## <a name="step-2-adding-parameters-to-a-custom-sql-statement"></a>Шаг 2. Добавление параметров для инструкции настраиваемый SQL

При добавлении пользовательские инструкции SQL можно ввести `WHERE` предложение явным образом или укажите значение в ячейке фильтра построителя запросов. Чтобы продемонстрировать это, позвольте s отобразить только те продукты, в элементе управления GridView, цены, меньше, чем определенного порогового значения. Начните с добавления TextBox для `ParameterizedQueries.aspx` страницу для сбора этого порогового значения от пользователя. Набор TextBox s `ID` свойства `MaxPrice`. Добавьте кнопку веб-элемент управления и задайте его `Text` свойство для отображения соответствующих продуктов.

Затем перетащите элемент управления GridView на страницу, а его смарт-теге, выберите Создание нового элемента управления SqlDataSource с именем `ProductsFilteredByPriceDataSource`. С помощью мастера настройки источника данных, перейдите к Specify собственную инструкцию SQL или хранимой процедуры экрана (см. рис. 4) и введите следующий запрос:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample5.sql)]

После ввода запроса (вручную или через конструктор запросов), нажмите кнопку "Далее".


[![Возвращать только те продукты, меньше или равно значению параметра](using-parameterized-queries-with-the-sqldatasource-cs/_static/image4.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image7.png)

**Рис. 4**: Возврат только тех продуктов меньше чем или равен размеру значение параметра ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image8.png))


Так как запрос включает параметры, на следующем экране мастер запрашивает источником значений параметров. Выберите элемент управления из списка параметров источника раскрывающегося списка и `MaxPrice` (элемент управления TextBox s `ID` значение) в раскрывающемся списке ControlID. Можно также ввести необязательное значение по умолчанию для использования в случае, когда пользователь не ввел любой текст в `MaxPrice` текстового поля. На данный момент, не вводите значение по умолчанию.


[![S MaxPrice текстовое свойство Text используется как источник параметра](using-parameterized-queries-with-the-sqldatasource-cs/_static/image5.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image9.png)

**Рис. 5**: `MaxPrice` TextBox s `Text` свойство используется в качестве источника параметра ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image10.png))


Следуйте указаниям мастера настройки источников данных, кнопку "Далее", а затем завершите. Декларативная разметка для GridView, TextBox, Button и SqlDataSource выглядит следующим образом:


[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample6.aspx)]

Обратите внимание, что параметру в SqlDataSource s `<SelectParameters>` раздел `ControlParameter`, который включает дополнительные свойства, такие `ControlID` и `PropertyName`. Когда SqlDataSource s `Select()` вызывается метод, `ControlParameter` извлекает значение из указанного свойства элемента управления Web и назначает его соответствующий параметр в `SelectCommand`. В этом примере `MaxPrice` s текстовое свойство используется в качестве `@MaxPrice` значение параметра.

Внимательно просмотреть эту страницу через обозреватель. При первом просмотре странице или всякий раз, когда `MaxPrice` текстовое поле не содержит значения, записи не отображаются в GridView.


[![Нет записей, отображаются при MaxPrice TextBox пустое.](using-parameterized-queries-with-the-sqldatasource-cs/_static/image6.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image11.png)

**Рис. 6**: Нет записей, отображаемых при `MaxPrice` пустое текстовое поле ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image12.png))


Продукты не отображаются, так как, по умолчанию пустым значение параметра преобразуется в базу данных `NULL` значение. После сравнения `[UnitPrice] <= NULL` всегда имеет значение false, результаты не возвращаются.

Введите значение в текстовое поле, например 5,00 и нажмите кнопку Display соответствующие продукты. При обратной передаче элемента управления SqlDataSource о том, что GridView, что один из своих источников параметра было изменено. Следовательно для элемента GridView выполняет повторную привязку элемента управления SqlDataSource, отображая продукты меньше или равно $5,00.


[![Отображаются продукты меньше чем или равен размеру 5,00 долл. США](using-parameterized-queries-with-the-sqldatasource-cs/_static/image7.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image13.png)

**Рис. 7**: Отображаются продукты меньше чем или равен размеру 5,00 долл. США ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image14.png))


## <a name="initially-displaying-all-products"></a>Изначально отображение всех продуктов

Может потребоваться отобразить вместо вывода нет продуктов, при первой загрузке страницы, мы *все* продуктов. Один из способов Отображение списка всех продуктов всякий раз, когда `MaxPrice` пуст — присвоить значение по умолчанию параметр s некоторые безумно слишком большое значение, как 1000000, так как оно s, маловероятно, что компания Northwind Traders будет когда-либо иметь инвентаризации цена которых превышает 1 000 000 долларов. Тем не менее этот подход shortsighted и может не работать в других ситуациях.

В предыдущих учебных курсах - [декларативные параметры](../basic-reporting/declarative-parameters-cs.md) и ["основной/подробности" Фильтрация с помощью элемента управления DropDownList](../masterdetail/master-detail-filtering-with-a-dropdownlist-cs.md) мы были вы столкнулись с подобную проблему. Существует наше решение заключалось в том, чтобы поместить эту логику на уровне бизнес-логики. В частности, BLL проверяется входящее значение и, если он был `NULL` или некоторых зарезервированных значение, вызов направлен методу DAL, возвращаются все записи. Если входящее значение нормальное значение фильтрации, выполнен вызов к методу DAL, который выполнил инструкцию SQL, который использовать параметризованную `WHERE` предложение с помощью предоставленного значения.

К сожалению мы обойти архитектуры при использовании элемента управления SqlDataSource. Вместо этого нам нужно настроить инструкцию SQL, чтобы интеллектуально скопировать все записи, если `@MaximumPrice` параметр `NULL` или некоторые зарезервированное значение. В этом упражнении let s будет таким образом, если `@MaximumPrice` равен параметр `-1.0`, затем *все* записей должны быть возвращены (`-1.0` работает как зарезервированное значение, поскольку ни один продукт не может иметь отрицательное `UnitPrice`значение). Для выполнения этой задачи можно использовать следующую инструкцию SQL:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample7.sql)]

Это `WHERE` предложение возвращает *все* Если `@MaximumPrice` slmax равен `-1.0`. Если значение параметра не `-1.0`, только те продукты, `UnitPrice` меньше или равно `@MaximumPrice` возвращаются значения параметра. Установив значение по умолчанию `@MaximumPrice` параметр `-1.0`, при первой загрузке страницы (или каждый раз, когда `MaxPrice` пуст), `@MaximumPrice` будет иметь значение `-1.0` и отображаются все продукты.


[![Теперь все продукты, отображаются при MaxPrice TextBox пустое](using-parameterized-queries-with-the-sqldatasource-cs/_static/image8.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image15.png)

**Рис. 8**: Теперь все продукты, отображаемый при `MaxPrice` пустое текстовое поле ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image16.png))


Существует несколько предостережений отметить при таком подходе. Во-первых, учтите, что тип данных параметра s определяется по его использованию s в SQL-запросе. При изменении `WHERE` предложение из `@MaximumPrice = -1.0` для `@MaximumPrice = -1`, среда выполнения рассматривает параметр как целое число. Если после этого вы пытаетесь назначить `MaxPrice` текстовое поле в десятичное значение (например, 5,00), произойдет ошибка, так как она не может преобразовать 5,00 целое число. Чтобы это исправить, либо убедитесь, что используется `@MaximumPrice = -1.0` в `WHERE` предложение или лучше, установите `ControlParameter` объект s `Type` свойство в десятичное число.

Во-вторых, добавив `OR @MaximumPrice = -1.0` для `WHERE` предложение, обработчик запросов не может использовать индекс `UnitPrice` (при условии, что один существует), таким образом, путем просмотра таблицы. Это может повлиять на производительность при наличии достаточно большим количеством записей в `Products` таблицы. Более удачным подходом было бы переместить эту логику в хранимой процедуре где `IF` либо выполнит инструкцию `SELECT` запрос из `Products` таблицы без `WHERE` предложения, когда все записи должны быть возвращены или одним которого `WHERE` предложение содержит только `UnitPrice` критериям, чтобы можно было использовать индекс.

## <a name="step-3-creating-and-using-parameterized-stored-procedures"></a>Шаг 3. Создание и использование параметризованные хранимые процедуры

Хранимые процедуры можно включить набор входных параметров, которые затем могут использоваться в инструкции SQL, определенные в хранимой процедуре. При настройке элемента управления SqlDataSource использовать хранимую процедуру, которая принимает входные параметры, значения этих параметров можно указать с помощью приемов, как и в случае нерегламентированных инструкций SQL.

Чтобы проиллюстрировать использование хранимых процедур в элемента управления SqlDataSource, s позволяют создать новую хранимую процедуру в базе данных "Борей" с именем `GetProductsByCategory`, который принимает параметр с именем `@CategoryID` и возвращает все столбцы из продуктов, `CategoryID` столбец совпадает `@CategoryID`. Чтобы создать хранимую процедуру, перейдите в проводник по серверам и детализировать `NORTHWND.MDF` базы данных. (Если Дон t см. в разделе проводника, открыть его, перейдя в меню "Вид" и выбрав параметр Server Explorer.)

Из `NORTHWND.MDF` базы данных, щелкните правой кнопкой мыши на папку хранимые процедуры, выберите Добавить новую хранимую процедуру и введите следующий синтаксис:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample8.sql)]

Щелкните Save значок (или Ctrl + S) чтобы сохранить хранимую процедуру. Хранимую процедуру можно проверить, щелкнув его в папке хранимые процедуры и выбор Execute. Это будет запрашивать параметры хранимых процедур s (`@CategoryID`, в данном экземпляре), после которого результаты отображаются в окне вывода.


[![GetProductsByCategory хранимой процедуры, при выполнении с @CategoryID 1](using-parameterized-queries-with-the-sqldatasource-cs/_static/image9.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image17.png)

**Рис. 9**: `GetProductsByCategory` Хранимой процедуры, при выполнении с `@CategoryID` 1 ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image18.png))


Позвольте s Используйте эту хранимую процедуру, чтобы отобразить все продукты в категории «Напитки» в элементе управления GridView. Добавление нового элемента управления GridView на страницу и привязать его к нового элемента управления SqlDataSource с именем `BeverageProductsDataSource`. По-прежнему в указать собственную инструкцию SQL или хранимой процедуры экрана, установите переключатель в хранимые процедуры и выбрать `GetProductsByCategory` хранимую процедуру из раскрывающегося списка.


[![Выберите GetProductsByCategory хранимую процедуру из раскрывающегося списка](using-parameterized-queries-with-the-sqldatasource-cs/_static/image10.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image19.png)

**Рис. 10**: Выберите `GetProductsByCategory` хранимую процедуру из раскрывающегося списка ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image20.png))


Так как хранимая процедура принимает входной параметр (`@CategoryID`), нажав кнопку Далее предлагает указать источник для этого параметра значение s. Напитков `CategoryID` имеет значение 1, поэтому оставьте ни один параметр исходного стрелку раскрывающегося списка и введите 1 в текстовое поле DefaultValue.


[![Использование жестко запрограммированных значений 1 для возврата продуктов в категории «Напитки»](using-parameterized-queries-with-the-sqldatasource-cs/_static/image11.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image21.png)

**Рис. 11**: Использование Hard-Coded значение 1 для возврата продуктов в категории «Напитки» ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image22.png))


Как показано в следующем декларативная разметка, при помощи хранимой процедуры, SqlDataSource s `SelectCommand` свойству присваивается имя хранимой процедуры и [ `SelectCommandType` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.selectcommandtype.aspx) присваивается `StoredProcedure`, указывающее, `SelectCommand` имя хранимой процедуры, а не специальный оператор SQL.


[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample9.aspx)]

Протестировать страницу в браузере. Отображаются только те продукты, принадлежащие к категории «Напитки», несмотря на то что *все* отображения полей продукта с момента `GetProductsByCategory` хранимая процедура возвращает все столбцы из `Products` таблицы. Мы могут, само собой, ограничить или настраивать поля, отображаемый в GridView в диалоговом окне Правка столбцов s GridView.


[![Отображаются все напитков](using-parameterized-queries-with-the-sqldatasource-cs/_static/image12.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image23.png)

**Рис. 12**: Отображаются все напитков ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image24.png))


## <a name="step-4-programmatically-invoking-a-sqldatasource-sselectstatement"></a>Шаг 4. Программного вызова SqlDataSource s`Select()`инструкции

Примеры мы видели в предыдущем учебном курсе, а этот учебник ve привязку элементов управления SqlDataSource непосредственно к GridView. Данные элемента управления s SqlDataSource, тем не менее, может быть программно доступно и перечисления в коде. Это может быть полезно, когда нужно запрашивать данные для ее проверки, но Дон t нужно отобразить ее. Вместо того, чтобы записать все стереотипный код ADO.NET для подключения к базе данных, укажите команду и получать результаты, вы можете разрешить элемента управления SqlDataSource обрабатывать этот монотонную код.

Для иллюстрации работы с SqlDataSource s данных программными средствами, представьте, что начальника достиг вы с запросом на создание веб-страницы, в котором отображается имя случайным образом выбранной категории и соответствующие продукты. То есть, когда пользователь посещает эту страницу, мы хотим случайным образом выбрать категорию из `Categories` таблицы, отображаемое имя категории и затем список продуктов, принадлежащих к этой категории.

Для этого необходимы два элемента управления SqlDataSource один для получения случайных категории из `Categories` таблицу, а другую следует получить категорию продукты. Мы выполним сборку элемента управления SqlDataSource, извлекающий запись случайных категории на этом шаге; Шаг 5 рассматривает берет на себя создание элемента управления SqlDataSource, запрашивающего продукты категории s.

Начните с добавления элемента управления SqlDataSource для `ParameterizedQueries.aspx` и задайте его `ID` для `RandomCategoryDataSource`. Настройте его таким образом, чтобы он использует следующий запрос SQL:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample10.sql)]

`ORDER BY NEWID()` Возвращает записи, отсортированные в случайном порядке (см. в разделе [Using `NEWID()` к случайным образом Сортировка записей](http://www.sqlteam.com/item.asp?ItemID=8747)). `SELECT TOP 1` Возвращает первую запись из результирующего набора. В совокупности этот запрос возвращает `CategoryID` и `CategoryName` значения столбцов из одной, случайно выбранный категории.

Чтобы отобразить категории s `CategoryName` значение, добавьте на страницу элемент управления Label Web, задайте его `ID` свойства `CategoryNameLabel`и очистите его `Text` свойство. Чтобы программным способом извлечения данных из элемента управления SqlDataSource, нам необходимо вызвать его `Select()` метод. [ `Select()` Метод](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.select.aspx) ожидает, что один входной параметр типа [ `DataSourceSelectArguments` ](https://msdn.microsoft.com/library/system.web.ui.datasourceselectarguments.aspx), которое указывает, как данные должны быть сообщения перед возвращением. Это может включать инструкции для сортировки и фильтрации данных и используемые данные, которые веб-элементов управления при сортировке или разбиение по страницам данные из элемента управления SqlDataSource. В нашем примере мы кое t нужно данных изменить перед возвращением и таким образом будет передать в `DataSourceSelectArguments.Empty` объекта.

`Select()` Метод возвращает объект, реализующий `IEnumerable`. Точный тип, возвращенный зависит от значения элемента управления SqlDataSource s [ `DataSourceMode` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.datasourcemode.aspx). Как уже обсуждалось в предыдущем учебном курсе, это свойство может быть присвоено значение `DataSet` или `DataReader`. Если значение `DataSet`, `Select()` возвращает [DataView](https://msdn.microsoft.com/library/01s96x0z.aspx) объекта; Если же задано `DataReader`, он возвращает объект, реализующий [ `IDataReader` ](https://msdn.microsoft.com/library/system.data.idatareader.aspx). Так как `RandomCategoryDataSource` SqlDataSource имеет его `DataSourceMode` свойство значение `DataSet` (по умолчанию), мы будем работать с использованием объекта DataView.

Следующий код показывает, как получить записи из `RandomCategoryDataSource` SqlDataSource как DataView а также способы чтения `CategoryName` значение столбца в первой строке DataView:


[!code-csharp[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample11.cs)]

`randomCategoryView[0]` Возвращает первый `DataRowView` в DataView. `randomCategoryView[0]["CategoryName"]` Возвращает значение `CategoryName` столбца в первом ряду. Обратите внимание, что DataView слабо типизированной. Для ссылки на значение определенного столбца, нам нужно передать имя столбца в виде строки (в данном случае «категория»). Рис. 13 показано сообщение, отображаемое в `CategoryNameLabel` при просмотре страницы. Разумеется, фактическое имя категории отображаемых выбирается случайным образом по `RandomCategoryDataSource` SqlDataSource на каждом посещении страницы (включая обратных передачах).


[![S случайным образом выбрать категорию, отображается имя](using-parameterized-queries-with-the-sqldatasource-cs/_static/image13.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image25.png)

**Рис. 13**: S случайным образом выбранных категорий, название ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image26.png))


> [!NOTE]
> Если элемента управления SqlDataSource элемента управления s `DataSourceMode` свойство было присвоено значение `DataReader`, возвращаемое значение из `Select()` метод пришлось бы привести к `IDataReader`. Для чтения `CategoryName` значение столбца в первой строке, мы d использовать следующий код:


[!code-csharp[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample12.cs)]

С помощью элемента управления SqlDataSource случайным образом выбирать категорию, мы будет готов для добавления GridView, которая перечисляет продукты категории s.

> [!NOTE]
> Вместо того чтобы использовать элемент управления Label Web, чтобы отобразить имя категории s, удалось добавлена FormView и DetailsView на страницу, привязав его к элемента управления SqlDataSource. Тем не менее, с помощью метки, позволил нам о том, как программным способом вызвать SqlDataSource s `Select()` инструкции, а также работать с его полученные данные в коде.


## <a name="step-5-assigning-parameter-values-programmatically"></a>Шаг 5. Назначение значения параметров программно

Во всех примерах мы видели в этом руководстве ve использовали значение параметра жестко или один из одного из источников предварительно определенных параметров (значение строки запроса, веб-элемент управления на странице и т. д.). Тем не менее s параметры элемента управления SqlDataSource могут также устанавливаться программными средствами. До завершения текущего, мы должны SqlDataSource, который возвращает все продукты, принадлежащие к указанной категории. Будет иметь этого элемента управления SqlDataSource `CategoryID` на основе параметра, значение которого требуется задать `CategoryID` значения столбца, возвращенного `RandomCategoryDataSource` SqlDataSource в `Page_Load` обработчик событий.

Начните с добавления элемента управления GridView на страницу и привязать его к нового элемента управления SqlDataSource с именем `ProductsByCategoryDataSource`. Как мы делали на шаге 3, настройте элемента управления SqlDataSource, таким образом, чтобы он вызывает `GetProductsByCategory` хранимой процедуры. Оставьте набор стрелку раскрывающегося списка параметров источника нет, но не вводите значение по умолчанию, как это значение по умолчанию будут заданы программным способом.


[![Не указывайте источник параметра или значение по умолчанию](using-parameterized-queries-with-the-sqldatasource-cs/_static/image14.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image27.png)

**Рис. 14**: Выполнение не указать источник параметра или значение по умолчанию ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image28.png))


После завершения работы мастера SqlDataSource итоговый декларативная разметка должен выглядеть следующим образом:


[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample13.aspx)]

Можно назначить `DefaultValue` из `CategoryID` программно с помощью параметра `Page_Load` обработчик событий:


[!code-csharp[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample14.cs)]

В результате этого добавления страница содержит GridView, отображаются продукты, связанные с случайным образом выбранной категории.


[![Не указывайте источник параметра или значение по умолчанию](using-parameterized-queries-with-the-sqldatasource-cs/_static/image15.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image29.png)

**Рис. 15**: Выполнение не указать источник параметра или значение по умолчанию ([Просмотр полноразмерного изображения](using-parameterized-queries-with-the-sqldatasource-cs/_static/image30.png))


## <a name="summary"></a>Сводка

Элемента управления SqlDataSource позволяет определять параметризованные запросы со значениями параметров, можно жестко, извлеченных из предварительно определенных параметров или назначать программным образом. В этом учебнике мы рассмотрели для быстрого создания параметризованного запроса с помощью мастера настройки источника данных для ad-hoc-запросов SQL и хранимых процедур. Мы также рассмотрели использование параметра жестко источников, веб-элемента управления в качестве источника параметра и программно, указав значение параметра.

Как и с помощью ObjectDataSource, SqlDataSource также предоставляет возможности для изменения базовых данных. В следующем учебном курсе мы рассмотрим способ определения `INSERT`, `UPDATE`, и `DELETE` инструкций с помощью элемента управления SqlDataSource. После добавления этих инструкций, мы используем встроенную Вставка, редактирование и удаление средств элементов управления GridView, DetailsView и FormView.

Счастливого вам программирования!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP.NET и основатель веб- [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга — [ *Sams Teach ASP.NET 2.0 in 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Ним можно связаться по адресу [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Скотт Clyde Шмидт Рэнделл и Кен Pespisa, стали Лиз Шалок в этом руководстве. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](querying-data-with-the-sqldatasource-control-cs.md)
> [Вперед](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
