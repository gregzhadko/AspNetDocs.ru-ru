---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/using-parameterized-queries-with-the-sqldatasource-cs
title: Использование параметризованных запросов с SqlDataSource (C#) | Документация Майкрософт
author: rick-anderson
description: В этом учебнике мы продолжаем знакомство с элементом управления SqlDataSource и научитесь определять параметризованные запросы. Параметры можно указать как объявл...
ms.author: riande
ms.date: 02/20/2007
ms.assetid: 9128aaac-afe2-449f-84b2-bb1d035083c4
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/using-parameterized-queries-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: 241dc8c089d4faa9eb95a63684e8a56756bb302c
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74611298"
---
# <a name="using-parameterized-queries-with-the-sqldatasource-c"></a>Использование параметризованных запросов с помощью элемента управления SqlDataSource (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_48_CS.exe) или [Загрузка PDF-файла](using-parameterized-queries-with-the-sqldatasource-cs/_static/datatutorial48cs1.pdf)

> В этом учебнике мы продолжаем знакомство с элементом управления SqlDataSource и научитесь определять параметризованные запросы. Параметры можно указать как декларативно, так и программно, и их можно извлечь из нескольких расположений, таких как строка запроса, состояние сеанса, другие элементы управления и многое другое.

## <a name="introduction"></a>Введение

В предыдущем учебном курсе было показано, как использовать элемент управления SqlDataSource для получения данных непосредственно из базы данных. С помощью мастера настройки источника данных можно выбрать базу данных, а затем либо выбрать столбцы, возвращаемые из таблицы или представления. Введите пользовательскую инструкцию SQL; или используйте хранимую процедуру. При выборе столбцов из таблицы или представления или при вводе пользовательской инструкции SQL свойству элемента управления SqlDataSource `SelectCommand` присваивается результирующая нерегламентированная инструкция SQL `SELECT`. это `SELECT` инструкция, которая выполняется, когда вызывается метод SqlDataSource `Select()` (программно или автоматически из веб-элемента управления данными).

Инструкции SQL `SELECT`, используемые в предыдущих примерах учебника, не имеют `WHERE` предложений. В операторе `SELECT` можно использовать предложение `WHERE`, чтобы ограничить возвращаемые результаты. Например, чтобы отобразить названия продуктов, стоимость которых превышает $50,00, можно использовать следующий запрос:

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample1.sql)]

Как правило, значения, используемые в предложении `WHERE`, определяются внешним источником, например значением строки запроса, переменной сеанса или пользовательским вводом из веб-элемента управления на странице. В идеале такие входные данные задаются с помощью *параметров*. При использовании Microsoft SQL Server параметры обозначаются с помощью `@parameterName`, как в:

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample2.sql)]

SqlDataSource поддерживает параметризованные запросы для инструкций `SELECT` и `INSERT`, `UPDATE`и `DELETE`. Более того, значения параметров могут быть автоматически извлечены из различных источников: QueryString, состояние сеанса, элементы управления на странице и т. д. или могут быть назначены программно. В этом учебнике мы посмотрим, как определять параметризованные запросы, а также как декларативно и программно указывать значения параметров.

> [!NOTE]
> В предыдущем учебном курсе мы сравнивали ObjectDataSource, который был нашим инструментом по выбору в первых 46 руководствах с SqlDataSource, указывая на концептуальные сходства. Эти сходства также расширяются до параметров. Параметры ObjectDataSource, сопоставленные с входными параметрами для методов на уровне бизнес-логики. С помощью SqlDataSource параметры определяются непосредственно в SQL Query. Оба элемента управления имеют коллекции параметров для методов `Select()`, `Insert()`, `Update()`и `Delete()`, и оба эти значения могут быть заполнены из предварительно определенных источников (значения QueryString, переменные сеанса и т. д.) или назначены программно.

## <a name="creating-a-parameterized-query"></a>Создание параметризованного запроса

Мастер настройки источника данных SqlDataSource предлагает три способа определения выполняемой команды для получения записей базы данных:

- Выбрав столбцы из существующей таблицы или представления,
- Путем ввода пользовательской инструкции SQL или
- Выбор хранимой процедуры

При выборе столбцов из существующей таблицы или представления параметры для предложения `WHERE` должны быть указаны в диалоговом окне Добавление `WHERE` предложения. Однако при создании пользовательской инструкции SQL вы можете вводить параметры непосредственно в предложение `WHERE` (используя `@parameterName` для обозначения каждого параметра). [Хранимая процедура](http://www.awprofessional.com/articles/article.asp?p=25288&amp;rl=1) состоит из одной или нескольких инструкций SQL, и эти инструкции могут быть параметризованы. Однако параметры, используемые в инструкциях SQL, должны передаваться в качестве входных параметров хранимой процедуре.

Поскольку создание параметризованного запроса зависит от того, как задается `SelectCommand` SqlDataSource s, давайте взглянем на все три подхода. Чтобы начать работу, откройте страницу `ParameterizedQueries.aspx` в папке `SqlDataSource`, перетащите элемент управления SqlDataSource из панели элементов в конструктор и задайте для его `ID` значение `Products25BucksAndUnderDataSource`. Затем щелкните ссылку Настроить источник данных в смарт-теге элемента управления. Выберите используемую базу данных (`NORTHWINDConnectionString`) и нажмите кнопку Далее.

## <a name="step-1-adding-awhereclause-when-picking-the-columns-from-a-table-or-view"></a>Шаг 1. Добавление предложения`WHERE`при выборе столбцов из таблицы или представления

При выборе данных, возвращаемых из базы данных с помощью элемента управления SqlDataSource, мастер настройки источников данных позволяет просто выбрать столбцы, возвращаемые из существующей таблицы или представления (см. рис. 1). При этом автоматически создается инструкция SQL `SELECT`, которая отправляется в базу данных при вызове метода SqlDataSource `Select()`. Как и в предыдущем учебном курсе, выберите таблицу Products из раскрывающегося списка и проверьте столбцы `ProductID`, `ProductName`и `UnitPrice`.

[![выбрать столбцы, возвращаемые из таблицы или представления](using-parameterized-queries-with-the-sqldatasource-cs/_static/image1.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image1.png)

**Рис. 1**. Выбор столбцов, возвращаемых из таблицы или представления ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image2.png))

Чтобы включить предложение `WHERE` в инструкцию `SELECT`, нажмите кнопку `WHERE`, которая открывает диалоговое окно Добавление предложения `WHERE` (см. рис. 2). Чтобы добавить параметр для ограничения результатов, возвращаемых запросом `SELECT`, сначала выберите столбец для фильтрации данных. Затем выберите оператор, который будет использоваться для фильтрации (=, &lt;, &lt;=, &gt;и т. д.). Наконец, выберите источник значения параметра s, например из строки запроса или состояния сеанса. После настройки параметра нажмите кнопку Добавить, чтобы включить его в `SELECT`ный запрос.

В этом примере пусть s возвращает только те результаты, в которых значение `UnitPrice` меньше или равно $25,00. Поэтому выберите `UnitPrice` из раскрывающегося списка столбец и &lt;= в раскрывающемся списке Оператор. При использовании жестко запрограммированного значения параметра (например, $25,00) или если значение параметра должно быть указано программно, выберите нет в раскрывающемся списке Источник. Затем введите жестко запрограммированное значение параметра в текстовом поле Value 25,00 и завершите процесс, нажав кнопку Добавить.

[![ограничить результаты, возвращаемые в диалоговом окне «Добавление предложения WHERE»](using-parameterized-queries-with-the-sqldatasource-cs/_static/image2.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image3.png)

**Рис. 2**. Ограничение результатов, возвращаемых в диалоговом окне "добавление предложения `WHERE`" ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image4.png))

После добавления параметра нажмите кнопку ОК, чтобы вернуться в мастер настройки источника данных. Инструкция `SELECT` в нижней части мастера должна включать предложение `WHERE` с параметром с именем `@UnitPrice`:

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample3.sql)]

> [!NOTE]
> Если в предложении `WHERE` указано несколько условий из диалогового окна Добавить `WHERE` предложение, мастер присоединяет их с помощью оператора `AND`. Если необходимо включить `OR` в предложение `WHERE` (например, `WHERE UnitPrice <= @UnitPrice OR Discontinued = 1`), то необходимо создать инструкцию `SELECT` с помощью пользовательского экрана инструкции SQL.

Завершите настройку SqlDataSource (нажмите кнопку "Далее", затем "Готово"), а затем проверьте декларативную разметку SqlDataSource s. Разметка теперь включает коллекцию `<SelectParameters>`, которая содержит исходные параметры для параметров в `SelectCommand`.

[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample4.aspx)]

Когда вызывается метод SqlDataSource `Select()`, `UnitPrice` значение параметра (25,00) применяется к параметру `@UnitPrice` в `SelectCommand` перед отправкой в базу данных. В итоге возвращаются только те продукты, которые меньше или равны $25,00 из таблицы `Products`. Чтобы подтвердить это, добавьте GridView на страницу, привяжите его к этому источнику данных, а затем просмотрите страницу в браузере. Вы увидите только те продукты, которые не меньше $25,00, как показано на рис. 3.

[![отображаются только продукты, не превышающие $25,00.](using-parameterized-queries-with-the-sqldatasource-cs/_static/image3.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image5.png)

**Рис. 3**. отображаются только те продукты, которые меньше или равны $25,00 ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image6.png))

## <a name="step-2-adding-parameters-to-a-custom-sql-statement"></a>Шаг 2. Добавление параметров в пользовательскую инструкцию SQL

При добавлении пользовательской инструкции SQL можно ввести предложение `WHERE` явным образом или указать значение в ячейке фильтра конструктор запросов. Чтобы продемонстрировать это, позвольте отобразить только те продукты в элементе управления GridView, цены которых меньше определенного порогового значения. Начните с добавления текстового поля на страницу `ParameterizedQueries.aspx`, чтобы получить это пороговое значение от пользователя. Задайте для свойства `ID` TextBox значение `MaxPrice`. Добавьте веб-элемент управления "Кнопка" и задайте для него свойство `Text`, чтобы отобразить соответствующие продукты.

Затем перетащите элемент управления GridView на страницу и из его смарт-тега выберите Создание нового элемента управления SqlDataSource с именем `ProductsFilteredByPriceDataSource`. В мастере настройки источника данных перейдите к экрану определение пользовательской инструкции SQL или хранимой процедуры (см. рис. 4) и введите следующий запрос:

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample5.sql)]

После ввода запроса (вручную или с помощью конструктор запросов) нажмите кнопку Далее.

[![возвращать только те продукты, которые меньше или равны значению параметра](using-parameterized-queries-with-the-sqldatasource-cs/_static/image4.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image7.png)

**Рис. 4**. возврат только тех продуктов, которые меньше или равны значению параметра ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image8.png))

Так как запрос содержит параметры, на следующем экране мастера запрашивается источник значений параметров. Выберите элемент управления из раскрывающегося списка Источник параметра и `MaxPrice` (`ID` значение элемента управления TextBox) из раскрывающегося списка ControlID. Можно также ввести необязательное значение по умолчанию, которое будет использоваться в случае, если пользователь не введет текст в текстовое поле `MaxPrice`. Для времени не вводите значение по умолчанию.

[![свойство Text текстового поля Максприце используется в качестве источника параметра.](using-parameterized-queries-with-the-sqldatasource-cs/_static/image5.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image9.png)

**Рис. 5**. свойство `MaxPrice` TextBox `Text` используется в качестве источника параметра ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image10.png))

Завершите работу мастера настройки источника данных, нажав кнопку Далее, а затем Готово. Декларативная разметка для GridView, TextBox, Button и SqlDataSource выглядит следующим образом:

[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample6.aspx)]

Обратите внимание, что параметр в разделе `<SelectParameters>` SqlDataSource s является `ControlParameter`, который включает дополнительные свойства, такие как `ControlID` и `PropertyName`. Когда вызывается метод SqlDataSource `Select()`, `ControlParameter` извлекает значение из указанного свойства веб-элемента управления и присваивает его соответствующему параметру в `SelectCommand`. В этом примере в качестве значения параметра `@MaxPrice` используется свойство `MaxPrice` s Text.

Потратьте минуту, чтобы просмотреть эту страницу в браузере. При первом посещении страницы или при отсутствии значения в текстовом поле `MaxPrice` в GridView не отображаются никакие записи.

[![никакие записи не отображаются, если пустое текстовое поле Максприце](using-parameterized-queries-with-the-sqldatasource-cs/_static/image6.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image11.png)

**Рис. 6**. никакие записи не отображаются, если пустое текстовое поле `MaxPrice` ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image12.png))

Причина, по которой продукты не отображаются, заключается в том, что по умолчанию пустая строка для значения параметра преобразуется в значение `NULL` базы данных. Поскольку при сравнении `[UnitPrice] <= NULL` всегда вычисляется значение false, результаты не возвращаются.

Введите значение в текстовое поле, например 5,00, и нажмите кнопку Показать соответствующие продукты. При обратной передаче SqlDataSource информирует элемент управления GridView о том, что один из его источников параметров изменился. Следовательно, элемент управления GridView выполняет повторную привязку к SqlDataSource, отображая такие продукты, которые меньше или равны $5,00.

[Отображаются ![продукты, не превышающие $5,00.](using-parameterized-queries-with-the-sqldatasource-cs/_static/image7.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image13.png)

**Рис. 7**. отображаются продукты, размер которых меньше или равен $5,00 ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image14.png))

## <a name="initially-displaying-all-products"></a>Изначально отображаются все продукты

Вместо того чтобы отображать продукты при первой загрузке страницы, может потребоваться отобразить *все* продукты. Один из способов перечислить все продукты каждый раз, когда пустое текстовое поле `MaxPrice`, — установить для параметра s значение по умолчанию какое-либо безумно высокое значение, например 1000000, так как маловероятно, что у компании "Борей" когда-либо будет Инвентаризация, Цена за единицу которой превышает $1 000 000. Однако этот подход является шортсигхтед и может не работать в других ситуациях.

В предыдущих учебных курсах — [декларативные параметры](../basic-reporting/declarative-parameters-cs.md) и [Фильтрация "основной/подробности" с помощью DropDownList](../masterdetail/master-detail-filtering-with-a-dropdownlist-cs.md) мы столкнулись с подобной проблемой. Наше решение поместит эту логику на уровне бизнес-логики. В частности, BLL проверил входящее значение и, если оно было `NULL` или какое зарезервированное значение, вызов направляется к методу DAL, который вернул все записи. Если входящее значение было обычной фильтрацией, в метод DAL был выполнен вызов, который выполнил инструкцию SQL, которая использовала параметризованное `WHERE` предложение с предоставленным значением.

К сожалению, мы обходите архитектуру при использовании SqlDataSource. Вместо этого необходимо настроить инструкцию SQL для интеллектуального получения всех записей, если параметр `@MaximumPrice` `NULL` или какое-либо зарезервированное значение. Для этого упражнения добавим его таким образом, чтобы если параметр `@MaximumPrice` равен `-1.0`, *все* записи будут возвращены (`-1.0` работает как зарезервированное значение, так как ни один продукт не может иметь отрицательное значение `UnitPrice`). Для этого можно использовать следующую инструкцию SQL:

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample7.sql)]

Это `WHERE` предложение возвращает *все* записи, если параметр `@MaximumPrice` равен `-1.0`. Если значение параметра не `-1.0`, возвращаются только те продукты, у которых `UnitPrice` меньше или равно значению параметра `@MaximumPrice`. Установив для параметра `@MaximumPrice` значение по умолчанию `-1.0`, при первой загрузке страницы (или при пустом текстовом поле `MaxPrice`) `@MaximumPrice` будет иметь значение `-1.0` и будут отображены все продукты.

[![теперь все продукты отображаются, если пустое текстовое поле Максприце](using-parameterized-queries-with-the-sqldatasource-cs/_static/image8.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image15.png)

**Рис. 8**. Теперь все продукты отображаются, если пустое текстовое поле `MaxPrice` ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image16.png))

Существует несколько предостережений, которые следует учитывать при использовании этого подхода. Во-первых, следует понимать, что тип данных параметра s выводится в результате использования в SQL-запросе. При изменении предложения `WHERE` с `@MaximumPrice = -1.0` на `@MaximumPrice = -1`среда выполнения рассматривает параметр как целое число. Если затем вы попытаетесь присвоить текстовое поле `MaxPrice` десятичному значению (например, 5,00), возникнет ошибка, так как она не может преобразовать 5,00 в целое число. Чтобы устранить эту проблему, убедитесь, что вы используете `@MaximumPrice = -1.0` в предложении `WHERE` или, что еще лучше, установите для свойства `Type` `ControlParameter` объектов значение Decimal.

Во-вторых, добавив `OR @MaximumPrice = -1.0` к предложению `WHERE`, обработчик запросов не сможет использовать индекс в `UnitPrice` (при условии, что он существует), что приведет к просмотру таблицы. Это может повлиять на производительность, если в таблице `Products` достаточно большого количества записей. Лучшим подходом будет перемещение этой логики в хранимую процедуру, где `IF`ная инструкция будет выполнять `SELECT`ный запрос из `Products` таблицы без предложения `WHERE`, когда необходимо вернуть все записи или какое предложение `WHERE` содержит только критерии `UnitPrice`, чтобы можно было использовать индекс.

## <a name="step-3-creating-and-using-parameterized-stored-procedures"></a>Шаг 3. Создание и использование параметризованных хранимых процедур

Хранимые процедуры могут включать набор входных параметров, которые затем можно использовать в инструкциях SQL, определенных в хранимой процедуре. При настройке SqlDataSource для использования хранимой процедуры, принимающей входные параметры, эти значения параметров можно указать с помощью тех же методов, что и для специальных инструкций SQL.

Чтобы продемонстрировать использование хранимых процедур в SqlDataSource, давайте создадим новую хранимую процедуру в базе данных Northwind с именем `GetProductsByCategory`, которая принимает параметр с именем `@CategoryID` и возвращает все столбцы продуктов, столбец `CategoryID` которых соответствует `@CategoryID`. Чтобы создать хранимую процедуру, перейдите к обозреватель сервера и разверните базу данных `NORTHWND.MDF`. (Если вы не видите обозреватель сервера, выведите его, перейдя в меню Вид и выбрав параметр обозреватель сервера.)

В базе данных `NORTHWND.MDF` щелкните правой кнопкой мыши папку Хранимые процедуры, выберите команду Добавить новую хранимую процедуру и введите следующий синтаксис:

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample8.sql)]

Щелкните значок сохранения (или нажмите клавиши CTRL + S), чтобы сохранить хранимую процедуру. Можно протестировать хранимую процедуру, щелкнув ее правой кнопкой мыши в папке хранимые процедуры и выбрав команду выполнить. Будет предложено указать параметры хранимой процедуры s (`@CategoryID`, в этом экземпляре), после чего результаты будут отображаться в окне вывода.

[![хранимой процедуры Жетпродуктсбикатегори при выполнении с @CategoryID 1](using-parameterized-queries-with-the-sqldatasource-cs/_static/image9.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image17.png)

**Рис. 9**. `GetProductsByCategory` хранимая процедура при выполнении с `@CategoryID` 1 ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image18.png))

С помощью этой хранимой процедуры можно отобразить все продукты в категории «напитки» в элементе управления GridView. Добавьте новый элемент управления GridView на страницу и привяжите его к новому SqlDataSource с именем `BeverageProductsDataSource`. Перейдите к экрану определение пользовательской инструкции SQL или хранимой процедуры, выберите переключатель хранимая процедура и выберите `GetProductsByCategory` хранимая процедура из раскрывающегося списка.

[![выберите хранимую процедуру Жетпродуктсбикатегори из раскрывающегося списка.](using-parameterized-queries-with-the-sqldatasource-cs/_static/image10.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image19.png)

**Рис. 10**. Выбор хранимой процедуры `GetProductsByCategory` из раскрывающегося списка ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image20.png))

Поскольку хранимая процедура принимает входной параметр (`@CategoryID`), при нажатии кнопки Далее будет предложено указать источник для этого значения параметра s. `CategoryID` напитки имеет значение 1, поэтому оставьте в раскрывающемся списке Источник параметра значение нет и введите 1 в текстовое поле DefaultValue (значение по умолчанию).

[![использовать жестко запрограммированное значение 1 для возврата продуктов из категории «напитки»](using-parameterized-queries-with-the-sqldatasource-cs/_static/image11.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image21.png)

**Рис. 11**. использование жестко запрограммированного значения 1 для возврата продуктов из категории «напитки» ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image22.png))

Как показано в следующей декларативной разметке, при использовании хранимой процедуры свойству SqlDataSource `SelectCommand` присвоено имя хранимой процедуры, а [свойству`SelectCommandType`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.selectcommandtype.aspx) — значение `StoredProcedure`, указывающее, что `SelectCommand` является именем хранимой процедуры, а не специальной инструкции SQL.

[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample9.aspx)]

Протестируйте страницу в браузере. Отображаются только те продукты, которые относятся к категории «напитки», хотя *все* поля продукта отображаются, поскольку `GetProductsByCategory` хранимая процедура возвращает все столбцы из таблицы `Products`. Конечно, можно ограничить или настроить поля, отображаемые в GridView из диалогового окна Изменение столбцов GridView s.

[![все напитки отображаются](using-parameterized-queries-with-the-sqldatasource-cs/_static/image12.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image23.png)

**Рис. 12**. отображаются все напитки ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image24.png))

## <a name="step-4-programmatically-invoking-a-sqldatasource-sselectstatement"></a>Шаг 4. программный вызов инструкции`Select()`SqlDataSource

В примерах, приведенных в предыдущем учебном курсе, и в этом руководстве ранее привязываются элементы управления SqlDataSource к GridView. Однако данные элемента управления SqlDataSource могут быть программно доступны и перечислены в коде. Это может быть особенно полезно, если необходимо запросить данные для проверки, но не нужно отображать их. Вместо того чтобы писать весь стандартный код ADO.NET для подключения к базе данных, указать команду и получить результаты, можно разрешить SqlDataSource обработку этого кода монотонную.

Чтобы продемонстрировать работу с данными SqlDataSource s программным способом, представьте, что ваш начальник поработал с запросом на создание веб-страницы, в которой отображается имя выбранной категории и связанных с ней продуктов. То есть, когда пользователь посещает эту страницу, нам нужно случайным образом выбрать категорию из таблицы `Categories`, отобразить имя категории, а затем перечислить продукты, принадлежащие этой категории.

Для этого нам нужно два элемента управления SqlDataSource, чтобы получить случайную категорию из таблицы `Categories`, а другую — для получения продуктов категории. Мы создадим средство SqlDataSource, которое получает запись случайной категории в этом шаге. Шаг 5 рассматривает создание средства SqlDataSource, которое получает продукты категории.

Начните с добавления элемента SqlDataSource в `ParameterizedQueries.aspx` и задайте для его `ID` значение `RandomCategoryDataSource`. Настройте его так, чтобы он использовал следующий запрос SQL:

[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample10.sql)]

`ORDER BY NEWID()` возвращает записи, отсортированные в случайном порядке (см. раздел [использование `NEWID()` для случайной сортировки записей](http://www.sqlteam.com/item.asp?ItemID=8747)). `SELECT TOP 1` возвращает первую запись из результирующего набора. Вместе этот запрос возвращает значения столбцов `CategoryID` и `CategoryName` из одной, случайной выбранной категории.

Чтобы отобразить категорию `CategoryName` значение, добавьте на страницу веб-элемент управления Label, задайте для его свойства `ID` значение `CategoryNameLabel`и удалите его свойство `Text`. Для программного получения данных из элемента управления SqlDataSource необходимо вызвать метод `Select()`. [Метод`Select()`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.select.aspx) принимает один входной параметр типа [`DataSourceSelectArguments`](https://msdn.microsoft.com/library/system.web.ui.datasourceselectarguments.aspx), который указывает, каким образом данные должны быть сообщены перед возвратом. Это могут быть инструкции по сортировке и фильтрации данных, а также используются веб-элементами управления данными при сортировке или разбиении по страницам данных из элемента управления SqlDataSource. Однако в нашем примере мы не хотим, чтобы данные были изменены перед возвратом, и поэтому перейдут в объект `DataSourceSelectArguments.Empty`.

Метод `Select()` возвращает объект, реализующий `IEnumerable`. Точный возвращаемый тип зависит от значения [свойства`DataSourceMode`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.datasourcemode.aspx)элемента управления SqlDataSource. Как обсуждалось в предыдущем руководстве, этому свойству можно присвоить значение либо `DataSet`, либо `DataReader`. Если задано значение `DataSet`, метод `Select()` возвращает объект [DataView](https://msdn.microsoft.com/library/01s96x0z.aspx) . Если задано значение `DataReader`, то возвращается объект, реализующий [`IDataReader`](https://msdn.microsoft.com/library/system.data.idatareader.aspx). Так как для свойства `DataSourceMode` `RandomCategoryDataSource` SqlDataSource задано значение `DataSet` (значение по умолчанию), мы будем работать с объектом DataView.

В следующем коде показано, как извлечь записи из `RandomCategoryDataSource` SqlDataSource как DataView, а также как считать значение столбца `CategoryName` из первой строки DataView:

[!code-csharp[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample11.cs)]

`randomCategoryView[0]` возвращает первый `DataRowView` в объекте DataView. `randomCategoryView[0]["CategoryName"]` возвращает значение столбца `CategoryName` в первой строке. Обратите внимание, что объект DataView слабо типизирован. Чтобы сослаться на конкретное значение столбца, необходимо передать имя столбца в виде строки (CategoryName, в данном случае). На рис. 13 показано сообщение, отображаемое в `CategoryNameLabel` при просмотре страницы. Конечно, фактически отображаемое имя категории выбирается случайным образом `RandomCategoryDataSource` SqlDataSource при каждом посещении страницы (включая обратные передачи).

[![отображается имя категории s, выбранное случайным образом](using-parameterized-queries-with-the-sqldatasource-cs/_static/image13.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image25.png)

**Рис. 13**. отображается случайно выбранное имя категории s ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image26.png))

> [!NOTE]
> Если свойству элемента управления SqlDataSource `DataSourceMode` было присвоено значение `DataReader`, то для возвращаемого значения метода `Select()` необходимо привести к `IDataReader`. Чтобы считать значение столбца `CategoryName` из первой строки, мы используем следующий код:

[!code-csharp[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample12.cs)]

При случайном выборе категории с помощью SqlDataSource мы повторно готовы добавить GridView, в котором перечислены продукты категории.

> [!NOTE]
> Вместо использования элемента управления Label для вывода имени категории s можно было добавить FormView или DetailsView на страницу, привязывая его к SqlDataSource. Однако использование метки позволило нам исследовать, как программным способом вызвать инструкцию SqlDataSource `Select()` и работать с полученными в коде данными.

## <a name="step-5-assigning-parameter-values-programmatically"></a>Шаг 5. программное присвоение значений параметров

Все приведенные в этом руководстве примеры использовали жестко запрограммированное значение параметра или одно из предопределенных источников параметров (значение QueryString, веб-элемент управления на странице и т. д.). Однако параметры элемента управления SqlDataSource также можно задать программно. Чтобы выполнить текущий пример, требуется SqlDataSource, возвращающий все продукты, принадлежащие определенной категории. Этот SqlDataSource будет иметь параметр `CategoryID`, значение которого должно быть задано на основе значения столбца `CategoryID`, возвращаемого `RandomCategoryDataSource` SqlDataSource в обработчике событий `Page_Load`.

Сначала добавьте GridView на страницу и привяжите его к новому SqlDataSource с именем `ProductsByCategoryDataSource`. Точно так же, как и на шаге 3, настройте SqlDataSource таким образом, чтобы он вызывал `GetProductsByCategory` хранимую процедуру. Оставьте в раскрывающемся списке Источник параметра значение нет, но не вводите значение по умолчанию, так как это значение будет задано программно.

[![не указывать источник параметра или значение по умолчанию](using-parameterized-queries-with-the-sqldatasource-cs/_static/image14.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image27.png)

**Рис. 14**. не указывайте источник параметра или значение по умолчанию ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image28.png))

После завершения работы мастера SqlDataSource полученная декларативная разметка должна выглядеть следующим образом:

[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample13.aspx)]

В обработчике событий `Page_Load` можно программно назначить `DefaultValue` параметра `CategoryID`:

[!code-csharp[Main](using-parameterized-queries-with-the-sqldatasource-cs/samples/sample14.cs)]

С помощью этого добавления страница содержит элемент управления GridView, в котором отображаются продукты, связанные с выбранным случайным образом категорией.

[![не указывать источник параметра или значение по умолчанию](using-parameterized-queries-with-the-sqldatasource-cs/_static/image15.gif)](using-parameterized-queries-with-the-sqldatasource-cs/_static/image29.png)

**Рис. 15**. не указывайте источник параметра или значение по умолчанию ([щелкните, чтобы просмотреть изображение с полным размером](using-parameterized-queries-with-the-sqldatasource-cs/_static/image30.png))

## <a name="summary"></a>Сводка

SqlDataSource позволяет разработчикам страниц определять параметризованные запросы, значения параметров которых могут быть жестко запрограммированы, извлечены из предварительно определенных источников параметров или назначены программно. В этом учебнике мы увидели, как создавать параметризованные запросы из мастера настройки источников данных для нерегламентированных запросов SQL и хранимых процедур. Мы также рассматривали использование жестко заданных источников параметров, веб-элемента управления в качестве источника параметров и программного указания значения параметра.

Как и в случае с ObjectDataSource, SqlDataSource также предоставляет возможности для изменения базовых данных. В следующем учебном курсе мы рассмотрим, как определить `INSERT`, `UPDATE`и операторы `DELETE` с помощью SqlDataSource. После добавления этих инструкций можно использовать встроенные функции вставки, редактирования и удаления, присущие элементам управления GridView, DetailsView и FormView.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого руководства были Скотт Клиде, Рэнделл Шмидт и Кен Песписа. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](querying-data-with-the-sqldatasource-control-cs.md)
> [Вперед](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
