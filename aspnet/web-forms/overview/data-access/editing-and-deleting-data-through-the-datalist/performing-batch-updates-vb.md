---
uid: web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/performing-batch-updates-vb
title: Выполнение пакетных обновлений (Visual Basic) | Документация Майкрософт
author: rick-anderson
description: Вы научитесь создавать полностью изменяемых пользователем элементов управления DataList, где все элементы находятся в режим редактирования и, значения которых могут сохраняться, щелкнув кнопку «Обновить все»...
ms.author: riande
ms.date: 10/30/2006
ms.assetid: 8dac22a7-91de-4e3b-888f-a4c438b03851
msc.legacyurl: /web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/performing-batch-updates-vb
msc.type: authoredcontent
ms.openlocfilehash: 731272c5f240c97c3ecf845827216857ddc94802
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65132133"
---
# <a name="performing-batch-updates-vb"></a>Выполнение пакетных обновлений (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачайте пример приложения](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_37_VB.exe) или [скачать PDF](performing-batch-updates-vb/_static/datatutorial37vb1.pdf)

> Вы научитесь создавать полностью изменяемых пользователем элементов управления DataList, где все элементы находятся в режим редактирования и, значения которых можно сохранить, нажмите кнопку «Обновить все» на странице.

## <a name="introduction"></a>Вступление

В [предыдущем учебном курсе](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md) мы рассмотрели способы создания уровня элемента DataList. Таким как стандартный изменяемого элемента управления GridView, каждый элемент в элементе управления DataList включены изменения кнопка, при щелчке, сделает изменяемый элемент. Хотя это уровень элемента редактирования подходит для данных, которая обновляется только время от времени, определенных сценариев вариантов использования требуется пользователю изменять большое количество записей. Если пользователь должен изменить десятки записи и принудительно щелкните "Изменить", внесите свои изменения и нажмите кнопку обновления для каждого из них, щелкнув сумма может помешать ее производительность. В таких ситуациях, лучшим вариантом является предоставление полностью изменяемых пользователем элементов управления DataList, которой *все* элементы находятся в режиме правки, а также значения которого можно изменить, щелкнув кнопка "Обновить все" на странице (см. рис. 1).

[![Можно изменить каждый элемент полностью редактирования элемента управления DataList](performing-batch-updates-vb/_static/image2.png)](performing-batch-updates-vb/_static/image1.png)

**Рис. 1**: Можно изменить каждый элемент полностью редактирования элемента управления DataList ([Просмотр полноразмерного изображения](performing-batch-updates-vb/_static/image3.png))

В этом руководстве мы рассмотрим, как разрешить пользователям обновлять информацию об адресе поставщиков, с помощью полностью доступно для редактирования элемента управления DataList.

## <a name="step-1-create-the-editable-user-interface-in-the-datalist-s-itemtemplate"></a>Шаг 1. Создать редактируемый пользовательского интерфейса в s ItemTemplate элемента управления DataList

В предыдущем учебном курсе, где мы создания редактируемой standard, уровень элемента управления DataList, мы использовали два шаблона:

- `ItemTemplate` содержит интерфейс пользователя только для чтения (метка веб-элементы управления для отображения каждого s имя и цену продукта).
- `EditItemTemplate` содержит пользовательский интерфейс (два элемента управления TextBox Web) режиме редактирования.

Элемент управления DataList s `EditItemIndex` свойство определяет, что `DataListItem` (если таковые имеются) отображается с помощью `EditItemTemplate`. В частности `DataListItem` которого `ItemIndex` значение совпадает с DataList s `EditItemIndex` свойство отображается с помощью `EditItemTemplate`. Эта модель хорошо удобен в том случае, если только один элемент можно изменить во время, но друг от друга, использованные при создании полностью изменяемых пользователем элементов управления DataList.

Для полностью доступно для редактирования элемента управления DataList, мы хотим *все* из `DataListItem` s для подготовки к просмотру с помощью интерфейса редактирования. Самый простой способ выполнения этой задачи является определение интерфейса редактирования в `ItemTemplate`. Для изменения информации об адресе поставщики, редактируемый интерфейс содержит имя поставщика, как текст, а затем текстовые поля для адреса, города и страны значения.

Сначала откройте `BatchUpdate.aspx` странице, добавьте элемент управления DataList и задайте его `ID` свойства `Suppliers`. В смарт-теге элемента управления DataList s, необязательно, чтобы добавить новый элемент управления ObjectDataSource с именем `SuppliersDataSource`.

[![Создайте новый ObjectDataSource, именуемого SuppliersDataSource](performing-batch-updates-vb/_static/image5.png)](performing-batch-updates-vb/_static/image4.png)

**Рис. 2**: Создайте новый ObjectDataSource с именем `SuppliersDataSource` ([Просмотр полноразмерного изображения](performing-batch-updates-vb/_static/image6.png))

Настройте элемент ObjectDataSource для извлечения данных с помощью `SuppliersBLL` класс s `GetSuppliers()` метод (см. рис. 3). Как и в предыдущем учебном курсе, а не обновление сведений о поставщике через элемент управления ObjectDataSource, мы будем работать непосредственно с уровня бизнес-логики. Таким образом, задать стрелку раскрывающегося списка (нет) на вкладке "обновления" (см. рис. 4).

[![Получение сведений о поставщике, с помощью метода GetSuppliers()](performing-batch-updates-vb/_static/image8.png)](performing-batch-updates-vb/_static/image7.png)

**Рис. 3**: Получить сведения с помощью поставщика `GetSuppliers()` метод ([Просмотр полноразмерного изображения](performing-batch-updates-vb/_static/image9.png))

[![Задайте стрелку раскрывающегося списка (нет) на вкладке "обновления"](performing-batch-updates-vb/_static/image11.png)](performing-batch-updates-vb/_static/image10.png)

**Рис. 4**: Задайте стрелку раскрывающегося списка (нет) на вкладке "обновления" ([Просмотр полноразмерного изображения](performing-batch-updates-vb/_static/image12.png))

После завершения работы мастера, Visual Studio автоматически создает элемент управления DataList s `ItemTemplate` для отображения каждого поля данных, возвращаемых источником данных в элементе управления Label Web. Нам нужно изменить этот шаблон, чтобы на ней присутствовала интерфейса редактирования. `ItemTemplate` Можно настроить через конструктор в режиме редактирования шаблонов в смарт-теге элемента управления DataList s или напрямую через декларативный синтаксис.

Отвлекитесь и создать интерфейс редактирования, который отображает имя s поставщика в виде текста, но включает текстовые поля для поставщика s адрес, Город и Страна значения. После внесения этих изменений декларативный синтаксис s страницы должен выглядеть примерно следующее:

[!code-aspx[Main](performing-batch-updates-vb/samples/sample1.aspx)]

> [!NOTE]
> Как в предыдущем учебном курсе, элемент управления DataList, в этом руководстве необходим включено.

В `ItemTemplate` я использую два новых класса CSS, `SupplierPropertyLabel` и `SupplierPropertyValue`, которой были добавлены `Styles.css` класса и использует те же параметры стиля, как `ProductPropertyLabel` и `ProductPropertyValue` классы CSS.

[!code-css[Main](performing-batch-updates-vb/samples/sample2.css)]

После внесения этих изменений, посетите эту страницу через обозреватель. Как показано на рис. 5, каждый элемент управления DataList отображает имя поставщика в виде текста и использует текстовые поля для отображения адреса, города и страны.

[![Каждый поставщик в DataList является редактируемое](performing-batch-updates-vb/_static/image14.png)](performing-batch-updates-vb/_static/image13.png)

**Рис. 5**: Каждый поставщик в DataList является редактируемое ([Просмотр полноразмерного изображения](performing-batch-updates-vb/_static/image15.png))

## <a name="step-2-adding-an-update-all-button"></a>Шаг 2. Добавление обновления кнопка "все"

Хотя у каждого поставщика, на рис. 5 есть его адрес, Город и Страна полей, отображаемых в текстовое поле, в настоящее время нет кнопкой "Обновить". Вместо того, кнопка обновления каждого элемента, с полностью доступно для редактирования DataLists обычно наблюдается одной обновить все кнопки на странице, при нажатии обновляет *все* записей в элементе управления DataList. Для этого руководства позволяют добавить два обновить все кнопки — в верхней части страницы и нижней (несмотря на то, что щелкнув одну из кнопок будет иметь тот же эффект) s.

Начните с добавления кнопки веб-элемент управления выше элементов управления DataList и набор его `ID` свойства `UpdateAll1`. Затем добавьте второй веб-управления Button под элемент управления DataList, установка его `ID` для `UpdateAll2`. Задайте `Text` две кнопки, чтобы обновить все свойства. Наконец, создание обработчиков событий для обеих кнопок `Click` события. Вместо того чтобы дублировать логику обновления в каждом из обработчиков событий, позволяют s рефакторинг эту логику в третий метод `UpdateAllSupplierAddresses`, наличие обработчики событий, просто вызывая этот третий метод.

[!code-vb[Main](performing-batch-updates-vb/samples/sample3.vb)]

Рис. 6 показана страница, после добавления обновить все кнопки.

[![Две кнопки все обновления были добавлены на страницу](performing-batch-updates-vb/_static/image17.png)](performing-batch-updates-vb/_static/image16.png)

**Рис. 6**: Две кнопки все обновления были добавлены на страницу ([Просмотр полноразмерного изображения](performing-batch-updates-vb/_static/image18.png))

## <a name="step-3-updating-all-of-the-suppliers-address-information"></a>Шаг 3. Обновление всех сведений об адресе поставщики

Со всеми s элементов управления DataList, отображение интерфейса редактирования и с добавлением обновления всех кнопок все, что остается написание кода для выполнения пакетного обновления. В частности, нам нужно перебрать элементы управления DataList s и вызов `SuppliersBLL` класс s `UpdateSupplierAddress` метод для каждого из них.

Коллекция `DataListItem` экземпляров, состав DataList может осуществляться через элемент управления DataList s [ `Items` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.items.aspx). Со ссылкой на `DataListItem`, можно взять соответствующие `SupplierID` из `DataKeys` коллекции и программно ссылки, элементы управления TextBox Web в `ItemTemplate` как показано в следующем коде:

[!code-vb[Main](performing-batch-updates-vb/samples/sample4.vb)]

Когда пользователь нажимает одну из кнопок, все обновления, `UpdateAllSupplierAddresses` метод перебирает все `DataListItem` в `Suppliers` элементов управления DataList и вызовы `SuppliersBLL` класс s `UpdateSupplierAddress` метод, передавая соответствующие значения. Значение не введено значение для адреса, города или страны передает `Nothing` для `UpdateSupplierAddress` (а не содержит пустую строку), что приводит к базе данных `NULL` для базовой записи s полей.

> [!NOTE]
> Усовершенствование может потребоваться добавить состояние веб-управления Label к странице, предоставляет некоторые сообщение с подтверждением после пакетного обновления.

## <a name="updating-only-those-addresses-that-have-been-modified"></a>Обновление только те адреса, которые были изменены

Алгоритм обновления пакетной службы, используемый для этого учебника вызовов `UpdateSupplierAddress` метод *каждые* поставщика в элементе управления DataList, независимо от того, менялся ли сведения о своем адресе. Во время таких людей с нарушениями зрения обновлений обычно не проблемы с производительностью, они может привести к излишним записей, если изменяется во время аудита в таблицу базы данных. Например, если используются триггеры для записи всех `UPDATE` s, чтобы `Suppliers` таблицы в таблицу аудита, каждый раз, когда пользователь щелкает кнопку Обновить все записи аудита будет создаваться для каждого поставщика в системе, независимо от того, внесла ли пользователь изменения.

Классы ADO.NET DataTable и DataAdapter, позволяют пакетные обновления, где только измененные, удаленные и новые записи приводит все взаимодействие с базой данных. Каждая строка в объекте DataTable содержит [ `RowState` свойство](https://msdn.microsoft.com/library/system.data.datarow.rowstate.aspx) , указывающее, был добавлен к таблице DataTable, удалены из него, изменения, или остается без изменений строки. Когда изначально заполняется объект DataTable, все строки помечаются без изменений. Изменение значения всех столбцов строки s строка помечается как измененный.

В `SuppliersBLL` класс, мы обновляем информации об адресе указанного поставщика s, сначала прочитать статью в записи одного поставщика в `SuppliersDataTable` и задайте `Address`, `City`, и `Country` значения столбцов, используя следующий код:

[!code-vb[Main](performing-batch-updates-vb/samples/sample5.vb)]

Этот код присваивает наивно переданный адрес, Город и Страна значения `SuppliersRow` в `SuppliersDataTable` независимо от того, является ли, что значения изменились. Это вызывает `SuppliersRow` s `RowState` свойство помечается как измененный. Когда s уровня доступа к данным `Update` вызывается метод, он видит, что `SupplierRow` была изменена и таким образом отправляет `UPDATE` команду к базе данных.

Однако представьте, что мы добавили код в этот метод, чтобы только назначить переданный адрес, Город и Страна значения, если они отличаются от `SuppliersRow` s существующие значения. В случае адрес, Город и Страна которых так же, как существующие данные не будут изменены и `SupplierRow` s `RowState` будет помечен как остается неизменной. Конечным результатом будет, когда DAL s `Update` был вызван, будет сделан звонок не базы данных, так как `SuppliersRow` не был изменен.

Для применения этого изменения, замените инструкции, которые просто назначают переданный адрес, Город и Страна значения следующим кодом:

[!code-vb[Main](performing-batch-updates-vb/samples/sample6.vb)]

С этим добавили код, DAL s `Update` метод отправляет `UPDATE` инструкцию в базе данных только те записи, которые были изменены, значения, связанные с адресом.

Кроме того, мы может отслеживать ли имеются различия между полями переданный адрес и данные базы данных и, при отсутствии таких, просто пропустить вызов DAL s `Update` метод. Этот подход работает также в том случае, если вы используете базы данных прямого метода, так как переданный t является прямой метод DB `SuppliersRow` экземпляра которого `RowState` можно проверить, чтобы определить, требуется ли фактически вызов базы данных.

> [!NOTE]
> Каждый раз `UpdateSupplierAddress` вызывается метод, вызов выполняется в базу данных для получения сведений об обновленной записи. Затем, если в данных имеются изменения, еще один вызов к базе данных для обновления строки таблицы. Этот рабочий процесс можно оптимизировать, создав `UpdateSupplierAddress` перегрузку метода, который принимает `EmployeesDataTable` экземпляра, включающего *все* изменений из `BatchUpdate.aspx` страницы. Затем он может сделать один вызов к базе данных, чтобы получить все записи из `Suppliers` таблицы. Затем может быть перечислено два результирующих наборов и могут быть обновлены только те записи, где произошли изменения.

## <a name="summary"></a>Сводка

В этом учебнике мы рассмотрели создание полностью доступно для редактирования элемента управления DataList, что позволяет пользователю быстро изменять сведения об адресах для нескольких поставщиков. Мы начали путем определения интерфейса редактирования текстового поля веб-элемент управления для поставщика s адрес, Город и Страна значения в элементе управления DataList s `ItemTemplate`. Затем мы добавили обновление всех кнопок выше и ниже элемента управления DataList. После его изменения и одну из кнопок, все обновления, нажатии пользователя `DataListItem` перечисляются s и вызов `SuppliersBLL` класс s `UpdateSupplierAddress` метода.

Счастливого вам программирования!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP.NET и основатель веб- [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга — [ *Sams Teach ASP.NET 2.0 in 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Ним можно связаться по адресу [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Стали Зак Джонс и Кен Pespisa Лиз Шалок в этом руководстве. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md)
> [Вперед](handling-bll-and-dal-level-exceptions-vb.md)
