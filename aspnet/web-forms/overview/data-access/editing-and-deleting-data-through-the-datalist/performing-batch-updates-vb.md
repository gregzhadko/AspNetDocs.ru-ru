---
uid: web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/performing-batch-updates-vb
title: Выполнение пакетных обновлений (VB) | Документация Майкрософт
author: rick-anderson
description: Узнайте, как создать полностью изменяемый элемент управления DataList, в котором все его элементы находятся в режиме редактирования, и значения, которые можно сохранить, нажав кнопку "обновить все" на...
ms.author: riande
ms.date: 10/30/2006
ms.assetid: 8dac22a7-91de-4e3b-888f-a4c438b03851
msc.legacyurl: /web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/performing-batch-updates-vb
msc.type: authoredcontent
ms.openlocfilehash: e54c9fc12da278492b54164cf657eea142a3dae6
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78494754"
---
# <a name="performing-batch-updates-vb"></a>Выполнение пакетных обновлений (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_37_VB.exe) или [Загрузка PDF-файла](performing-batch-updates-vb/_static/datatutorial37vb1.pdf)

> Узнайте, как создать полностью изменяемый элемент управления DataList, в котором все его элементы находятся в режиме редактирования, и значения, которые можно сохранить, нажав кнопку "обновить все" на странице.

## <a name="introduction"></a>Введение

В [предыдущем учебном курсе](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md) мы рассмотрели, как создать DataList на уровне элемента. Как и в стандартном изменяемом элементе управления GridView, каждый элемент в DataList включал кнопку «изменить», которая при щелчке сделает элемент редактируемым. Хотя это редактирование на уровне элементов хорошо подходит для данных, которые обновляются только время от времени, для некоторых сценариев вариантов использования требуется, чтобы пользователь редактировал много записей. Если пользователю нужно изменить десятки записей и принудительно нажать кнопку изменить, внести изменения и нажать кнопку Обновить для каждого из них, то объем щелчка может препятствовать его повышению производительности. В таких ситуациях лучшим вариантом является предоставление полностью изменяемого элемента управления DataList, в котором *все* его элементы находятся в режиме редактирования, а значения могут быть изменены с помощью кнопки Обновить все на странице (см. рис. 1).

[![каждый элемент в полностью изменяемом DataList можно изменить](performing-batch-updates-vb/_static/image2.png)](performing-batch-updates-vb/_static/image1.png)

**Рис. 1**. можно изменить каждый элемент в полностью изменяемом элементе управления DataList ([щелкните, чтобы просмотреть изображение с полным размером](performing-batch-updates-vb/_static/image3.png))

В этом учебнике мы рассмотрим, как разрешить пользователям обновлять сведения об адресах поставщиков с помощью полностью изменяемого DataList.

## <a name="step-1-create-the-editable-user-interface-in-the-datalist-s-itemtemplate"></a>Шаг 1. Создание редактируемого пользовательского интерфейса в DataList s ItemTemplate

В предыдущем учебнике, где мы создаем стандартный элемент управления DataList на уровне элементов, мы использовали два шаблона:

- `ItemTemplate` содержал пользовательский интерфейс только для чтения (метки веб-элементов управления для отображения имени и цены каждого продукта).
- `EditItemTemplate` содержал пользовательский интерфейс режима редактирования (два веб-элемента управления TextBox).

Свойство `EditItemIndex` DataList s определяет, какие `DataListItem` (если таковые имеются) отображаются с помощью `EditItemTemplate`. В частности, `DataListItem`, значение `ItemIndex` которых соответствует свойству DataList s `EditItemIndex`, отображается с помощью `EditItemTemplate`. Эта модель хорошо работает, когда в каждый момент времени может быть изменен только один элемент, но при создании полностью изменяемого DataList они делятся друг на друга.

Для полностью изменяемого элемента управления DataList требуется, чтобы *все* `DataListItem` s отображались с помощью редактируемого интерфейса. Самый простой способ сделать это — определить изменяемый интерфейс в `ItemTemplate`. Для изменения сведений об адресе поставщиков редактируемый интерфейс содержит имя поставщика в виде текста, а затем текстовые поля для значений адреса, города и страны.

Для начала откройте страницу `BatchUpdate.aspx`, добавьте элемент управления DataList и задайте для его свойства `ID` значение `Suppliers`. Из смарт-тега DataList s выберите Добавить новый элемент управления ObjectDataSource с именем `SuppliersDataSource`.

[![создать новый элемент управления ObjectDataSource с именем Супплиерсдатасаурце](performing-batch-updates-vb/_static/image5.png)](performing-batch-updates-vb/_static/image4.png)

**Рис. 2**. Создание нового элемента управления ObjectDataSource с именем `SuppliersDataSource` ([щелкните, чтобы просмотреть изображение с полным размером](performing-batch-updates-vb/_static/image6.png))

Настройте ObjectDataSource для получения данных с помощью метода `GetSuppliers()` `SuppliersBLL` классов (см. рис. 3). Как и в предыдущем руководстве, вместо обновления сведений о поставщиках с помощью ObjectDataSource мы будем работать непосредственно с уровнем бизнес-логики. Поэтому установите для раскрывающегося списка значение (нет) на вкладке обновление (см. рис. 4).

[![получить сведения о поставщике с помощью метода-поставщика ()](performing-batch-updates-vb/_static/image8.png)](performing-batch-updates-vb/_static/image7.png)

**Рис. 3**. Получение сведений о поставщике с помощью метода `GetSuppliers()` ([щелкните, чтобы просмотреть изображение с полным размером](performing-batch-updates-vb/_static/image9.png))

[![установите для раскрывающегося списка значение (нет) на вкладке обновление.](performing-batch-updates-vb/_static/image11.png)](performing-batch-updates-vb/_static/image10.png)

**Рис. 4**. Установка в раскрывающемся списке значения (нет) на вкладке "обновление" ([щелкните, чтобы просмотреть изображение с полным размером](performing-batch-updates-vb/_static/image12.png))

После завершения работы мастера Visual Studio автоматически создает `ItemTemplate` DataList s для отображения каждого поля данных, возвращаемого источником данных в веб-элементе управления Label. Необходимо изменить этот шаблон таким образом, чтобы он предоставит интерфейс редактирования. `ItemTemplate` можно настроить с помощью конструктора, используя параметр изменить шаблоны из смарт-тега DataList s или напрямую с помощью декларативного синтаксиса.

Уделите немного времени созданию интерфейса редактирования, который отображает имя поставщика в виде текста, но включает текстовые поля для значений адреса, города и страны поставщика. После внесения этих изменений декларативный синтаксис страницы должен выглядеть следующим образом:

[!code-aspx[Main](performing-batch-updates-vb/samples/sample1.aspx)]

> [!NOTE]
> Как и в предыдущем руководстве, для элемента управления DataList в этом учебнике должно быть включено состояние просмотра.

В `ItemTemplate` I m с использованием двух новых классов CSS `SupplierPropertyLabel` и `SupplierPropertyValue`, которые были добавлены в класс `Styles.css` и настроены на использование тех же параметров стиля, что и классы `ProductPropertyLabel` и `ProductPropertyValue` CSS.

[!code-css[Main](performing-batch-updates-vb/samples/sample2.css)]

После внесения этих изменений посетите эту страницу в браузере. Как показано на рис. 5, каждый элемент DataList отображает имя поставщика как текст и использует текстовые поля для отображения адреса, города и страны.

[![каждый поставщик в DataList доступен для редактирования](performing-batch-updates-vb/_static/image14.png)](performing-batch-updates-vb/_static/image13.png)

**Рис. 5**. Каждый поставщик в DataList доступен для редактирования ([щелкните, чтобы просмотреть изображение с полным размером](performing-batch-updates-vb/_static/image15.png))

## <a name="step-2-adding-an-update-all-button"></a>Шаг 2. Добавление кнопки "обновить все"

Хотя у каждого поставщика на рис. 5 есть поля адрес, город и страна, отображаемые в текстовом поле, кнопка Обновить в настоящее время недоступна. Вместо кнопки Обновить для каждого элемента с полностью изменяемыми списками данных обычно на странице отображается одна кнопка Обновить все, которая при нажатии обновляет *все* записи в DataList. В этом руководстве мы добавим две кнопки Обновить все — одна в верхней части страницы и одна в нижней части (хотя нажатие любой кнопки приведет к одинаковому результату).

Сначала добавьте веб-элемент управления Button над элементом DataList и задайте для его свойства `ID` значение `UpdateAll1`. Затем добавьте второй элемент управления "Кнопка" под элементом DataList, установив для его `ID` значение `UpdateAll2`. Задайте свойства `Text` для этих двух кнопок, чтобы обновить все. Наконец, создайте обработчики событий для обеих кнопок, `Click` события. Вместо дублирования логики обновления в каждом из обработчиков событий добавим эту логику к третьему методу `UpdateAllSupplierAddresses`, получив обработчики событий, просто вызывая этот третий метод.

[!code-vb[Main](performing-batch-updates-vb/samples/sample3.vb)]

На рис. 6 показана страница после добавления кнопки «Обновить все».

[![две кнопки "обновить все" добавлены на страницу](performing-batch-updates-vb/_static/image17.png)](performing-batch-updates-vb/_static/image16.png)

**Рис. 6**. на страницу были добавлены две кнопки "обновить все" ([щелкните, чтобы просмотреть изображение с полным размером](performing-batch-updates-vb/_static/image18.png))

## <a name="step-3-updating-all-of-the-suppliers-address-information"></a>Шаг 3. обновление всех сведений об адресе поставщиков

Все элементы DataList, в которых отображается интерфейс правки, и Добавление кнопок обновить все, остается написанием кода для выполнения пакетного обновления. В частности, необходимо перебрать элементы DataList и вызвать метод `SuppliersBLL` класса `UpdateSupplierAddress` для каждого из них.

Доступ к коллекции экземпляров `DataListItem`, описывающего DataList, можно получить с помощью [свойства`Items`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.items.aspx)DataList. С помощью ссылки на `DataListItem`можно извлечь соответствующие `SupplierID` из коллекции `DataKeys` и программно ссылаться на веб-элементы управления TextBox в `ItemTemplate`, как показано в следующем коде:

[!code-vb[Main](performing-batch-updates-vb/samples/sample4.vb)]

Когда пользователь нажимает одну из кнопок обновить все, `UpdateAllSupplierAddresses` метод проходит по каждой `DataListItem` в `Suppliers` DataList и вызывает метод `SuppliersBLL` Class s `UpdateSupplierAddress`, передавая соответствующие значения. Невведенное значение для передачи адреса, города или страны является значением `Nothing` `UpdateSupplierAddress` (а не пустая строка), что приводит к `NULL` базы данных для полей базовых записей.

> [!NOTE]
> В качестве расширения можно добавить веб-элемент управления метки состояния на страницу, которая предоставляет некоторое сообщение с подтверждением после выполнения пакетного обновления.

## <a name="updating-only-those-addresses-that-have-been-modified"></a>Обновляются только измененные адреса

Алгоритм пакетного обновления, используемый в этом руководстве, вызывает метод `UpdateSupplierAddress` для *каждого* поставщика в DataList, независимо от того, были ли изменены сведения об их адресах. Хотя подобные обновления, как правило, не являются проблемой с производительностью, они могут привести к излишним записям при повторном аудите изменений в таблице базы данных. Например, при использовании триггеров для записи всех `UPDATE` s в `Suppliers` таблицу в таблицу аудита каждый раз, когда пользователь нажимает кнопку Обновить все, будет создана новая запись аудита для каждого поставщика в системе, независимо от того, были ли пользователь внесены какие-либо изменения.

Классы DataTable и DataAdapter ADO.NET предназначены для поддержки пакетных обновлений, в которых только изменения, удаленные и новые записи приводят к обмену данными между базами данных. Каждая строка в DataTable имеет [свойство`RowState`](https://msdn.microsoft.com/library/system.data.datarow.rowstate.aspx) , которое указывает, была ли строка добавлена в таблицу данных, удалена из нее, изменена или остается неизменной. При первоначальном заполнении DataTable все строки помечаются как неизмененные. При изменении значения любого из столбцов Row строка помечается как измененная.

В классе `SuppliersBLL` мы обновляем указанные сведения об адресе поставщика, сначала считывая одну запись поставщика в `SuppliersDataTable`, а затем установите значения столбцов `Address`, `City`и `Country`, используя следующий код:

[!code-vb[Main](performing-batch-updates-vb/samples/sample5.vb)]

Этот код поменяет передаваемые значения адреса, города и страны в `SuppliersRow` в `SuppliersDataTable` независимо от того, изменились ли значения. Эти изменения приводят к тому, что свойство `SuppliersRow` s `RowState` помечается как измененное. Когда вызывается метод `Update` уровня доступа к данным, он видит, что `SupplierRow` был изменен и поэтому отправляет в базу данных команду `UPDATE`.

Но представьте, что мы добавили код в этот метод, чтобы назначить только переданные адреса, города и страны, если они отличаются от существующих значений `SuppliersRow` s. Если адрес, город и страна совпадают с существующими данными, изменения не будут внесены, а `SupplierRow` `RowState` будут оставлены как неизмененные. В итоге, когда вызывается метод DAL `Update`, вызов базы данных не будет произведен, поскольку `SuppliersRow` не был изменен.

Чтобы применить это изменение, замените операторы, которые не присваивают переданным адресам, городу и странам, следующим кодом:

[!code-vb[Main](performing-batch-updates-vb/samples/sample6.vb)]

После добавления этого кода метод DAL `Update` отправляет в базу данных инструкцию `UPDATE` только для тех записей, значения которых изменились.

Кроме того, можно отследить наличие различий между передаваемыми адресными полями и данными базы данных и, если нет, просто обойти вызов метода DAL s `Update`. Этот подход хорошо работает при повторном использовании прямого метода DB, так как прямой метод DB не передает `SuppliersRow` экземпляр, `RowState` можно проверить, чтобы определить, требуется ли вызов базы данных.

> [!NOTE]
> При каждом вызове метода `UpdateSupplierAddress` выполняется вызов базы данных для получения сведений об обновленной записи. При наличии изменений в данных выполняется другой вызов базы данных для обновления строки таблицы. Этот рабочий процесс можно оптимизировать, создав перегрузку `UpdateSupplierAddress` метода, которая принимает экземпляр `EmployeesDataTable`, который содержит *все* изменения со страницы `BatchUpdate.aspx`. Затем он может выполнить один вызов к базе данных, чтобы получить все записи из таблицы `Suppliers`. Затем можно перечислить два результирующих списка и обновить только те записи, в которых произошло изменение.

## <a name="summary"></a>Сводка

В этом учебнике мы рассмотрели создание полностью изменяемого элемента управления DataList, позволяя пользователю быстро изменять сведения об адресах для нескольких поставщиков. Мы начали с определения интерфейса правки. веб-элемент управления TextBox для значений адреса, города и страны поставщика в `ItemTemplate`DataList. Затем были добавлены кнопки Обновить все сверху и снизу элемента управления DataList. После того как пользователь внес изменения и щелкнул одну из кнопок обновить все, `DataListItem`ы перечисляются и выполняется вызов метода `SuppliersBLL` класса s `UpdateSupplierAddress`.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого учебника были Зак Jones и Кен Песписа. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md)
> [Вперед](handling-bll-and-dal-level-exceptions-vb.md)
