---
uid: web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/handling-bll-and-dal-level-exceptions-vb
title: Обработка исключений уровня BLL и DAL (VB) | Документация Майкрософт
author: rick-anderson
description: В этом учебнике мы посмотрим, как тактфулли обработку исключений, возникающих во время рабочего процесса обновления элемента управления DataList.
ms.author: riande
ms.date: 10/30/2006
ms.assetid: ca665073-b379-4239-9404-f597663ca65e
msc.legacyurl: /web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/handling-bll-and-dal-level-exceptions-vb
msc.type: authoredcontent
ms.openlocfilehash: 319ab44f2e65afc77f6f89ca8aa58c529f40d05c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78480156"
---
# <a name="handling-bll--and-dal-level-exceptions-vb"></a>Обработка исключений уровней BLL и DAL (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_38_VB.exe) или [Загрузка PDF-файла](handling-bll-and-dal-level-exceptions-vb/_static/datatutorial38vb1.pdf)

> В этом учебнике мы посмотрим, как тактфулли обработку исключений, возникающих во время рабочего процесса обновления элемента управления DataList.

## <a name="introduction"></a>Введение

В [обзоре редактирования и удаления данных в руководстве по DataList](an-overview-of-editing-and-deleting-data-in-the-datalist-cs.md) мы создали элемент управления DataList, который предлагает простые возможности редактирования и удаления. В то время как все ошибки, произошедшие во время процесса редактирования или удаления, привели к необработанному исключению, хотя это и полностью функционально, это было неудобно для пользователя. Например, если не указать название продукта или при редактировании продукта ввести значение цены очень доступное!, создает исключение. Поскольку это исключение не перехвачено в коде, оно передается в среду выполнения ASP.NET, которая затем отображает подробные сведения об исключениях на веб-странице.

Как было показано в статье [обработка исключений BLL и DAL в учебнике по страницам ASP.NET](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) , если исключение создается из глубины бизнес-логики или уровней доступа к данным, сведения об исключении возвращаются в ObjectDataSource, а затем в GridView. Мы увидели, как правильно обрабатывать эти исключения путем создания `Updated` или `RowUpdated` обработчиков событий для ObjectDataSource или GridView, проверки исключения и последующего указания на то, что исключение было обработано.

Однако наши руководства по DataList не используют ObjectDataSource для обновления и удаления данных. Вместо этого мы работаем непосредственно с BLL. Для обнаружения исключений, исходящих от BLL или DAL, нам нужно реализовать код обработки исключений в коде программной части страницы ASP.NET. В этом руководстве мы рассмотрим, как более тактфулли обработку исключений, возникающих во время изменяемого рабочего процесса DataList s.

> [!NOTE]
> В *обзоре редактирования и удаления данных в учебнике по DataList* мы обсуждали различные методы редактирования и удаления данных из DataList, некоторые методы, связанные с использованием элемента управления ObjectDataSource для обновления и удаления. Если вы применяете эти методы, вы можете выполнять обработку исключений из BLL или DAL с помощью ObjectDataSource `Updated` или `Deleted` обработчиков событий.

## <a name="step-1-creating-an-editable-datalist"></a>Шаг 1. Создание изменяемого элемента управления DataList

Прежде чем беспокоиться об обработке исключений, происходящих во время обновления рабочего процесса, давайте сначала создадим изменяемый элемент управления DataList. Откройте страницу `ErrorHandling.aspx` в папке `EditDeleteDataList`, добавьте в конструктор элемент управления DataList, задайте для свойства `ID` значение `Products`и добавьте новый элемент управления ObjectDataSource с именем `ProductsDataSource`. Настройте ObjectDataSource для использования метода `ProductsBLL` классов `GetProducts()` для выбора записей. Задайте для раскрывающихся списков на вкладках Вставка, обновление и удаление значение (нет).

[![получить сведения о продукте с помощью метода WebMethod ()](handling-bll-and-dal-level-exceptions-vb/_static/image2.png)](handling-bll-and-dal-level-exceptions-vb/_static/image1.png)

**Рис. 1**. Возврат сведений о продукте с помощью метода `GetProducts()` ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-vb/_static/image3.png))

После завершения работы мастера ObjectDataSource Visual Studio автоматически создаст `ItemTemplate` для DataList. Введите здесь `ItemTemplate`, где отображаются названия и цены каждого продукта и включается кнопка "Изменить". Затем создайте `EditItemTemplate` с помощью веб-элемента управления TextBox для Name and Price, а также кнопок Update и Cancel. Наконец, задайте свойству `RepeatColumns` DataList s значение 2.

После этих изменений декларативная разметка страницы должна выглядеть следующим образом. Дважды проверьте, что кнопки Правка, отмена и обновление имеют свойства `CommandName` для которых задано изменение, отмена и обновление соответственно.

[!code-aspx[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample1.aspx)]

> [!NOTE]
> В этом руководстве состояние представления DataList должно быть включено.

Потратьте время на просмотр нашего хода работы в браузере (см. рис. 2).

[![каждый продукт включает кнопку "Изменить"](handling-bll-and-dal-level-exceptions-vb/_static/image5.png)](handling-bll-and-dal-level-exceptions-vb/_static/image4.png)

**Рис. 2**. каждый продукт включает кнопку "Изменить" ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-vb/_static/image6.png))

В настоящее время кнопка Edit (изменить) только вызывает обратную передачу, но не делает продукт редактируемым. Чтобы включить редактирование, необходимо создать обработчики событий для `EditCommand`, `CancelCommand`и `UpdateCommand` событий DataList. События `EditCommand` и `CancelCommand` просто обновляют свойство DataList `EditItemIndex` и повторно привязывают данные к DataList:

[!code-vb[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample2.vb)]

Обработчик событий `UpdateCommand` является немного более сложным. Он должен прочесть измененный продукт s `ProductID` из коллекции `DataKeys` вместе с именем и ценой продукта из текстовых полей в `EditItemTemplate`, а затем вызвать метод `ProductsBLL` Class `UpdateProduct`, прежде чем возвратить элемент управления DataList в состояние предварительного редактирования.

Пока что давайте просто используем тот же код из обработчика событий `UpdateCommand` в разделе *Общие сведения об изменении и удалении данных в* элементе управления DataList. Мы добавим код для корректной обработке исключений на шаге 2.

[!code-vb[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample3.vb)]

На лицевой стороне недопустимых входных данных, которые могут быть в виде неправильно отформатированной цены за единицу, недопустимое значение цены единицы, например-$5,00, или при пропуске имени продукта, будет создано исключение. Так как обработчик событий `UpdateCommand` не включает код обработки исключений на этом этапе, исключение будет восходящей до среды выполнения ASP.NET, где оно будет отображаться для конечного пользователя (см. рис. 3).

![При возникновении необработанного исключения конечный пользователь видит страницу ошибки](handling-bll-and-dal-level-exceptions-vb/_static/image7.png)

**Рис. 3**. при возникновении необработанного исключения конечный пользователь видит страницу ошибки

## <a name="step-2-gracefully-handling-exceptions-in-the-updatecommand-event-handler"></a>Шаг 2. корректное обработка исключений в обработчике событий UpdateCommand

Во время обновления рабочего процесса исключения могут возникать в обработчике событий `UpdateCommand`, BLL или DAL. Например, если пользователь вводит цену слишком дорогостоящей, то оператор `Decimal.Parse` в обработчике событий `UpdateCommand` выдаст исключение `FormatException`. Если пользователь опускает название продукта или если цена имеет отрицательное значение, DAL вызовет исключение.

При возникновении исключения нам нужно отобразить информативное сообщение на самой странице. Добавьте на страницу веб-элемент управления Label, для `ID` которого задано значение `ExceptionDetails`. Настройте текст метки, чтобы он отображался красным, очень крупным полужирным шрифтом и курсивом, назначив его свойство `CssClass` для класса `Warning` CSS, который определен в файле `Styles.css`.

При возникновении ошибки необходимо, чтобы метка отображалась только один раз. Это означает, что при последующих обратных передачах сообщение с предупреждением Label должно исчезнуть. Для этого можно либо очистить свойство Label `Text`, либо указать его свойство `Visible` для `False` в обработчике событий `Page_Load` (как мы делали это при [обработке исключений уровня BLL и DAL в учебнике по страницам ASP.NET](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) ) или путем отключения поддержки состояния просмотра меток s. Позвольте использовать второй вариант.

[!code-aspx[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample4.aspx)]

При возникновении исключения сведения об исключении будут назначаться свойству `ExceptionDetails` меток `Text`. Так как состояние представления отключено, при последующих обратных передачах программные изменения свойств `Text` будут утрачены, возвращается к тексту по умолчанию (пустая строка), тем самым скрываются предупреждающие сообщения.

Чтобы определить, когда возникла ошибка, чтобы на странице отображалось полезное сообщение, необходимо добавить блок `Try ... Catch` в обработчик событий `UpdateCommand`. `Try` часть содержит код, который может привести к исключению, в то время как блок `Catch` содержит код, выполняемый на стороне исключения. Дополнительные сведения о блоке `Try ... Catch` см. в разделе " [основы обработки исключений](https://msdn.microsoft.com/library/2w8f0bss.aspx) " в .NET Framework документации.

[!code-vb[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample5.vb)]

Если в блоке `Try` порождается исключение любого типа, код `Catch` блока s начнет выполняться. Тип исключения, вызываемого `DbException`, `NoNullAllowedException`, `ArgumentException`и т. д., зависит от того, что точно, причиной ошибку в первую очередь. Если на уровне базы данных возникла проблема, будет выдана `DbException`. Если для полей `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`или `ReorderLevel` введено недопустимое значение, будет выдано исключение `ArgumentException`, так как мы добавили код для проверки этих значений полей в классе `ProductsDataTable` (см. Руководство по [созданию уровня бизнес-логики](../introduction/creating-a-business-logic-layer-vb.md) ).

Мы можем предоставить конечному пользователю более полезное объяснение, указав текст сообщения для типа перехваченного исключения. Следующий код, который использовался в практически идентичной форме для [обработки исключений уровня BLL и DAL на странице ASP.NET,](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) предоставляет такой уровень детализации:

[!code-vb[Main](handling-bll-and-dal-level-exceptions-vb/samples/sample6.vb)]

Для работы с этим руководством просто вызовите метод `DisplayExceptionDetails` из блока `Catch`, передав в перехваченный экземпляр `Exception` (`ex`).

При наличии блока `Try ... Catch` пользователям предоставляется более информативное сообщение об ошибке, как показано 4 и 5. Обратите внимание, что в случае исключения элемент управления DataList остается в режиме редактирования. Это происходит из-за того, что после возникновения исключения поток управления сразу же перенаправляется в блок `Catch`, минуя код, возвращающий элемент управления DataList в состояние предварительного редактирования.

[![отображается сообщение об ошибке, если пользователь опускает обязательное поле](handling-bll-and-dal-level-exceptions-vb/_static/image9.png)](handling-bll-and-dal-level-exceptions-vb/_static/image8.png)

**Рис. 4**. отображается сообщение об ошибке, если пользователь опускает обязательное поле ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-vb/_static/image10.png))

[![при вводе отрицательной цены отображается сообщение об ошибке](handling-bll-and-dal-level-exceptions-vb/_static/image12.png)](handling-bll-and-dal-level-exceptions-vb/_static/image11.png)

**Рис. 5**. при вводе отрицательной цены отображается сообщение об ошибке ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-vb/_static/image13.png))

## <a name="summary"></a>Сводка

GridView и ObjectDataSource предоставляют обработчики событий пост-уровня, которые включают сведения обо всех исключениях, возникших во время рабочего процесса обновления и удаления, а также свойства, которые можно задать, чтобы указать, было ли исключение задействован. Однако эти функции недоступны при работе с элементом управления DataList и непосредственном использовании BLL. Вместо этого мы отвечаем за реализацию обработки исключений.

В этом учебнике мы увидели, как добавить обработку исключений в изменяемый рабочий процесс DataList s, добавив блок `Try ... Catch` в обработчик событий `UpdateCommand`. Если во время прогона обновления возникает исключение, код блока `Catch` блокируется, отображая полезную информацию в `ExceptionDetails` метке.

На этом этапе DataList не предпринимает никаких усилий, чтобы предотвратить возникновение исключений на первом месте. Даже если известно, что отрицательная цена приведет к исключению, мы еще не добавили какие-либо функции, чтобы заранее запретить пользователю вводить такие недопустимые входные данные. В следующем учебном курсе мы покажем, как уменьшить количество исключений, вызванных недопустимыми входными данными пользователя, добавив элементы управления проверки в `EditItemTemplate`.

Поздравляем с программированием!

## <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Правила разработки исключений](https://msdn.microsoft.com/library/ms298399.aspx)
- [Модули и обработчики журнала ошибок (ELMAH)](http://workspaces.gotdotnet.com/elmah) (библиотека с открытым исходным кодом для ведения журнала ошибок)
- [Корпоративная библиотека для .NET Framework 2,0](https://www.microsoft.com/downloads/details.aspx?familyid=5A14E870-406B-4F2A-B723-97BA84AE80B5&amp;displaylang=en) (включает в себя блок приложения управления исключениями)

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Специалист по интересу для этого руководства был Кен Песписа. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](performing-batch-updates-vb.md)
> [Вперед](adding-validation-controls-to-the-datalist-s-editing-interface-vb.md)
