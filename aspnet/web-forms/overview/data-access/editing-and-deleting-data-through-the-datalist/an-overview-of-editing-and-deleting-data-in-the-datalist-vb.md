---
uid: web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/an-overview-of-editing-and-deleting-data-in-the-datalist-vb
title: Общие сведения об изменении и удалении данных в DataList (VB) | Документация Майкрософт
author: rick-anderson
description: Хотя в DataList отсутствуют встроенные возможности редактирования и удаления, в этом учебнике будет показано, как создать элемент управления DataList, поддерживающий редактирование и удаление o...
ms.author: riande
ms.date: 10/30/2006
ms.assetid: 9410a23c-9697-4f07-bd71-e62b0ceac655
msc.legacyurl: /web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/an-overview-of-editing-and-deleting-data-in-the-datalist-vb
msc.type: authoredcontent
ms.openlocfilehash: 49b09cbf0f12f7c7233c3bb2a8b3b2c073bf117e
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78495246"
---
# <a name="an-overview-of-editing-and-deleting-data-in-the-datalist-vb"></a>Общие сведения об изменении и удалении данных в DataList (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_36_VB.exe) или [Загрузка PDF-файла](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/datatutorial36vb1.pdf)

> Хотя в DataList отсутствуют встроенные возможности редактирования и удаления, в этом учебнике будет показано, как создать элемент управления DataList, поддерживающий редактирование и удаление базовых данных.

## <a name="introduction"></a>Введение

В [обзоре руководства по вставке,](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) обновлению и удалению данных мы рассматривали способы вставки, обновления и удаления данных с помощью архитектуры приложения, ObjectDataSource и элементов управления GridView, DetailsView и FormView. С помощью ObjectDataSource и этих трех веб-элементов управления данными реализация простых интерфейсов изменения данных была привязкой и вовлечением только пометки флажка из смарт-тега. Не требуется написание кода.

К сожалению, в DataList отсутствуют встроенные возможности редактирования и удаления, присущие элементу управления GridView. Эта отсутствующая функциональность связана с тем, что DataList является Relic из предыдущей версии ASP.NET, когда декларативные элементы управления источниками данных и страницы изменения данных без кода были недоступны. Хотя элемент управления DataList в ASP.NET 2,0 не предоставляет те же возможности модификации данных, что и GridView, мы можем использовать методы ASP.NET 1. x для включения таких функций. Этот подход требует немного кода, но, как мы увидим в этом руководстве, в DataList есть некоторые события и свойства, помогающие в этом процессе.

В этом учебнике мы посмотрим, как создать элемент управления DataList, поддерживающий редактирование и удаление базовых данных. В следующих учебных курсах будут рассмотрены более сложные сценарии редактирования и удаления, включая проверку полей ввода, корректной обработки исключений, возникающих при доступе к данным или уровнях бизнес-логики, и т. д.

> [!NOTE]
> Как и в DataList, элемент управления Repeater не имеет функциональных возможностей для вставки, обновления или удаления. Хотя эти функциональные возможности можно добавить, DataList включает в себя свойства и события, не найденные в элементе управления Repeater, что упрощает добавление таких возможностей. Таким образом, в этом руководстве и будущих версиях, которые будут рассматриваться при редактировании и удалении, основное внимание уделяется только элементу управления DataList.

## <a name="step-1-creating-the-editing-and-deleting-tutorials-web-pages"></a>Шаг 1. Создание веб-страниц с учебниками по редактированию и удалению

Прежде чем начать изучение процесса обновления и удаления данных из DataList, давайте сначала создадим страницы ASP.NET в нашем проекте веб-сайта, которые понадобятся для работы с этим руководством и следующих нескольких. Для начала добавьте новую папку с именем `EditDeleteDataList`. Затем добавьте в эту папку следующие страницы ASP.NET, чтобы связать каждую страницу с главной страницей `Site.master`:

- `Default.aspx`
- `Basics.aspx`
- `BatchUpdate.aspx`
- `ErrorHandling.aspx`
- `UIValidation.aspx`
- `CustomizedUI.aspx`
- `OptimisticConcurrency.aspx`
- `ConfirmationOnDelete.aspx`
- `UserLevelAccess.aspx`

![Добавление страниц ASP.NET для учебников](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image1.png)

**Рис. 1**. добавление страниц ASP.NET для учебников

Как и в других папках, `Default.aspx` в папке `EditDeleteDataList` приводится список руководств в его разделе. Вспомним, что `SectionLevelTutorialListing.ascx` пользовательский элемент управления предоставляет эти функции. Таким образом, добавьте этот пользовательский элемент управления в `Default.aspx`, перетащив его из обозреватель решений на страницу s представление конструирования.

[![добавить пользовательский элемент управления SectionLevelTutorialListing. ascx в Default. aspx](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image3.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image2.png)

**Рис. 2**. Добавление пользовательского элемента управления `SectionLevelTutorialListing.ascx` в `Default.aspx` ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image4.png))

Наконец, добавьте страницы в качестве записей в файл `Web.sitemap`. В частности, добавьте следующую разметку после отчетов «основной/подробности» с элементом управления DataList и Repeater `<siteMapNode>`:

[!code-xml[Main](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/samples/sample1.xml)]

После обновления `Web.sitemap`просмотрите веб-сайт учебников в браузере. Меню слева теперь включает элементы для учебников по редактированию и удалению DataList.

![На карте веб-узла теперь есть записи для учебников по редактированию и удалению DataList.](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image5.png)

**Рис. 3**. схема узла теперь включает записи для учебников по редактированию и удалению DataList

## <a name="step-2-examining-techniques-for-updating-and-deleting-data"></a>Шаг 2. изучение методов обновления и удаления данных

Редактирование и удаление данных с помощью GridView настолько просто, потому что, под ним, GridView и ObjectDataSource работают совместно. Как обсуждалось в разделе [изучение событий, связанных с руководством по вставке, обновлению и удалению](../editing-inserting-and-deleting-data/examining-the-events-associated-with-inserting-updating-and-deleting-cs.md) , при нажатии кнопки обновления строки GridView автоматически назначает поля, использующие двустороннюю привязку данных, в коллекцию `UpdateParameters` элемента ObjectDataSource, а затем вызывает этот метод `Update()` ObjectDataSource.

К сожалению, элемент управления DataList не предоставляет ни одной из этих встроенных функций. Нашей обязанностью является обеспечение того, что значения пользователя присваиваются параметрам ObjectDataSource s и вызывается метод `Update()`. Чтобы помочь нам в этом, элемент управления DataList предоставляет следующие свойства и события:

- При обновлении или удалении **[Свойства`DataKeyField`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.basedatalist.datakeyfield.aspx)** необходимо иметь возможность уникально идентифицировать каждый элемент в DataList. Присвойте этому свойству поле первичный ключ отображаемых данных. Это приведет к заполнению [коллекции`DataKeys`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.basedatalist.datakeys.aspx) DataList с указанным `DataKeyField` значением для каждого элемента DataList.
- **[Событие`EditCommand`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.editcommand.aspx)** срабатывает при нажатии кнопки, LinkButton или ImageButton, свойство `CommandName` которого имеет значение Edit.
- **[Событие`CancelCommand`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.cancelcommand.aspx)** срабатывает при нажатии кнопки, LinkButton или ImageButton, свойство `CommandName` которого имеет значение Cancel.
- **[Событие`UpdateCommand`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.updatecommand.aspx)** срабатывает при нажатии кнопки, LinkButton или ImageButton, свойство `CommandName` которого имеет значение Update.
- **[Событие`DeleteCommand`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.deletecommand.aspx)** срабатывает при нажатии кнопки, LinkButton или ImageButton, свойство `CommandName` которого имеет значение Delete.

Используя эти свойства и события, можно использовать четыре подхода для обновления и удаления данных из DataList:

1. **С помощью методик ASP.NET 1. x** элемент управления DataList существовал до ASP.NET 2,0 и objectdatasources и мог полностью обновлять и удалять данные с помощью программных средств. Этот метод дитчес ObjectDataSource полностью и требует, чтобы мы привязали данные к DataList непосредственно из уровня бизнес-логики, как при получении данных для просмотра, так и при обновлении или удалении записи.
2. **С помощью одного элемента управления ObjectDataSource на странице для выбора, обновления и удаления** в то время как в DataList отсутствуют возможности редактирования и удаления GridView, нет причин, по которым мы не можем сами добавить их. При таком подходе мы используем ObjectDataSource, как в примерах GridView, но должны создать обработчик для события `UpdateCommand` DataList, где мы устанавливаем параметры ObjectDataSource s и вызываем его метод `Update()`.
3. **Используя элемент управления ObjectDataSource для выбора, но обновления и удаления непосредственно для BLL** при использовании варианта 2, нам нужно написать фрагмент кода в событии `UpdateCommand`, назначив значения параметров и т. д. Вместо этого мы можем придерживаться использования ObjectDataSource для выбора, но выполнять обновление и удаление вызовов непосредственно для слоя BLL (например, с параметром 1). По моему мнению, обновление данных путем взаимодействия непосредственно с BLL приводит к более удобочитаемому коду, чем назначение ObjectDataSource `UpdateParameters` и вызов метода `Update()`.
4. **Использование декларативных средств** с помощью нескольких элементов ObjectDataSource в предыдущих трех подходах требует немного кода. Если вы предпочитаете использовать как можно больше декларативного синтаксиса, последний вариант — включить несколько ObjectDataSource на странице. Первый элемент управления ObjectDataSource извлекает данные из слоя BLL и привязывает их к DataList. Для обновления добавляется другой элемент управления ObjectDataSource, который добавляется непосредственно в `EditItemTemplate`DataList s. Чтобы включить поддержку удаления, в `ItemTemplate`потребуется еще один элемент ObjectDataSource. При таком подходе эти внедренные элементы ObjectDataSource используют `ControlParameters` для декларативной привязки параметров ObjectDataSource s к элементам управления вводом данных пользователя (вместо того, чтобы указывать их программным способом в обработчике событий DataList `UpdateCommand`). Этот подход по-прежнему требует фрагмента кода, который нам нужно вызвать с помощью внедренного `Update()` или `Delete()` команды ObjectDataSource, но требуется гораздо меньше, чем в других трех подходах. Недостаток этого подхода состоит в том, что несколько фрагментов ObjectDataSource могут перегружать страницу, отменяя общую удобочитаемость.

Если принудительно использовать один из этих подходов, я использую вариант 1, так как он обеспечивает наибольшую гибкость и так как элемент управления DataList изначально разрабатывался для поддержки этого шаблона. Хотя элемент DataList был расширен для работы с элементами управления источниками данных ASP.NET 2,0, он не обладает всеми точками расширения или функциями официальных веб-элементов управления ASP.NET 2,0 (GridView, DetailsView и FormView). Однако варианты 2 – 4 не имеют.

В этом и будущих руководствах по редактированию и удалению будет использоваться элемент управления ObjectDataSource для получения данных, которые будут отображаться, и прямые вызовы BLL для обновления и удаления данных (вариант 3).

## <a name="step-3-adding-the-datalist-and-configuring-its-objectdatasource"></a>Шаг 3. Добавление элемента управления DataList и настройка его элемента управления ObjectDataSource

В этом учебнике мы создадим элемент управления DataList, который содержит сведения о продукте, и для каждого продукта предоставляет пользователю возможность изменить имя и цену, а также удалить продукт полностью. В частности, мы извлекаем записи, которые будут отображаться с помощью элемента управления ObjectDataSource, но выполняют операции обновления и удаления путем взаимодействия непосредственно с BLL. Прежде чем беспокоиться о реализации возможностей редактирования и удаления в DataList, давайте сначала создадим страницу, чтобы отобразить продукты в интерфейсе только для чтения. Так как мы проверили эти действия в предыдущих руководствах, я продолжу их быстро.

Для начала откройте страницу `Basics.aspx` в папке `EditDeleteDataList` и в представление конструирования добавьте элемент управления DataList на страницу. Затем в смарт-теге DataList создайте новый элемент управления ObjectDataSource. Так как мы работаем с данными продуктов, настройте его для использования класса `ProductsBLL`. Чтобы получить *все* продукты, выберите метод `GetProducts()` на вкладке Выбор.

[![настроить ObjectDataSource для использования класса ProductsBLL](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image7.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image6.png)

**Рис. 4**. Настройка ObjectDataSource для использования класса `ProductsBLL` ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image8.png))

[![получить сведения о продукте с помощью метода WebMethod ()](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image10.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image9.png)

**Рис. 5**. Возврат сведений о продукте с помощью метода `GetProducts()` ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image11.png))

Элемент управления DataList, как и GridView, не предназначен для вставки новых данных; Поэтому выберите параметр (нет) в раскрывающемся списке на вкладке Вставка. Также выберите (нет) для вкладок обновления и удаления, так как обновления и удаления будут выполняться программно с помощью слоя BLL.

[![убедиться, что в раскрывающихся списках на вкладках вставки, обновления и удаления ObjectDataSource s задано значение (нет)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image13.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image12.png)

**Рис. 6**. Убедитесь, что в раскрывающихся списках на вкладках вставки, обновления и удаления элемента управления ObjectDataSource задано значение (нет) ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image14.png))

После настройки элемента управления ObjectDataSource нажмите кнопку Готово, чтобы вернуться в конструктор. Как мы видели в прошлых примерах, при завершении настройки ObjectDataSource Visual Studio автоматически создает `ItemTemplate` для DropDownList, отображая все поля данных. Замените этот `ItemTemplate` на, отображающий только название и цену продукта. Кроме того, задайте для свойства `RepeatColumns` значение 2.

> [!NOTE]
> Как обсуждалось в *обзоре руководства по вставке, обновлению и удалению данных* при изменении данных с помощью ObjectDataSource нашей архитектуры, необходимо удалить свойство `OldValuesParameterFormatString` из декларативной разметки ObjectDataSource (или сбросить его до значения по умолчанию `{0}`). Однако в этом руководстве мы используем ObjectDataSource только для извлечения данных. Поэтому не нужно изменять значение свойства ObjectDataSource `OldValuesParameterFormatString` (хотя это не имеет вреда).

После замены `ItemTemplate` DataList, настроенного по умолчанию, декларативная разметка на странице должна выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/samples/sample2.aspx)]

Уделите время для просмотра хода выполнения в браузере. Как показано на рис. 7, в DataList отображается название продукта и цена за единицу для каждого продукта в двух столбцах.

[![названия и цены продуктов отображаются в DataList с двумя столбцами.](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image16.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image15.png)

**Рис. 7**. названия и цены продуктов отображаются в DataList с двумя столбцами ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image17.png)).

> [!NOTE]
> Элемент управления DataList имеет ряд свойств, необходимых для процесса обновления и удаления, и эти значения хранятся в состоянии представления. Поэтому при создании элемента управления DataList, поддерживающего редактирование или удаление данных, необходимо включить состояние представления DataList.  
>   
> Читатель внимательный может вспомнить, что мы смогли отключить состояние представления при создании редактируемых элементов управления GridView, DetailsView и FormView. Это связано с тем, что веб-элементы управления ASP.NET 2,0 могут включать в себя *состояние элемента управления*, которое сохраняется во всех обратных передачах, таких как состояние представления, но было признано необходимым.

Отключение состояния представления в GridView просто опускает сведения об тривиальных состояниях, но поддерживает состояние элемента управления (включая состояние, необходимое для изменения и удаления). Элемент управления DataList, созданный в интервале ASP.NET 1. x, не использует состояние контроля и поэтому должен иметь включенное состояние представления. Дополнительные сведения о назначении состояния элемента управления и его отличии от состояния представления см. в разделе [состояние элемента управления и состояние просмотра](https://msdn.microsoft.com/library/1whwt1k7.aspx) .

## <a name="step-4-adding-an-editing-user-interface"></a>Шаг 4. Добавление пользовательского интерфейса редактирования

Элемент управления GridView состоит из коллекции полей (BoundFields, Чеккбоксфиелдс, полей TemplateField и т. д.). Эти поля могут изменять отображаемую разметку в зависимости от их режима. Например, в режиме только для чтения BoundField отображает значение поля данных в виде текста. в режиме редактирования он отображает веб-элемент управления TextBox, свойство `Text` которого присваивает значение поля данных.

С другой стороны, элемент управления DataList отображает свои элементы с помощью шаблонов. Элементы, доступные только для чтения, подготавливаются с помощью `ItemTemplate` в то время как элементы в режиме редактирования подготавливаются к просмотру с помощью `EditItemTemplate`. На этом этапе у нашего DataList есть только `ItemTemplate`. Для поддержки функций редактирования на уровне элементов необходимо добавить `EditItemTemplate`, содержащий разметку, отображаемую для редактируемого элемента. В этом руководстве мы будем использовать веб-элементы управления TextBox для изменения имени и цены единицы продукта.

`EditItemTemplate` можно создать декларативно или через конструктор (выбрав параметр изменить шаблоны в смарт-теге DataList). Чтобы использовать параметр изменить шаблоны, сначала щелкните ссылку Edit Templates (изменить шаблоны) в смарт-теге, а затем выберите элемент `EditItemTemplate` из раскрывающегося списка.

[![для работы с элементом управления DataList s](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image19.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image18.png)

**Рис. 8**. необязательное использование `EditItemTemplate` DataList s ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image20.png))

Затем введите название продукта: и Price:, а затем перетащите два элемента управления TextBox из панели элементов в интерфейс `EditItemTemplate` в конструкторе. Задайте для полей `ID` свойства значение `ProductName` и `UnitPrice`.

[![добавить текстовое поле для имени и цены продукта](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image22.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image21.png)

**Рис. 9**. Добавление текстового поля для имени и цены продукта ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image23.png))

Необходимо привязать соответствующие значения полей данных продукта к свойствам `Text` двух текстовых полей. В смарт-тегах текстовых полей щелкните ссылку изменить привязки к данным, а затем свяжите соответствующее поле данных со свойством `Text`, как показано на рис. 10.

> [!NOTE]
> При привязке поля `UnitPrice` данных к полю `Text` поля цены можно отформатировать его как денежное значение (`{0:C}`), общее число (`{0:N}`) или оставить его неформатированным.

![Привязка полей данных ProductName и UnitPrice к свойствам текста текстовых полей](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image24.png)

**Рис. 10**. Привязка полей данных `ProductName` и `UnitPrice` к свойствам `Text` текстовых полей

Обратите внимание, что диалоговое окно Изменение привязок данных на рис. 10 *не включает двусторонний* флажок DataBinding, который имеется при редактировании TemplateField в элементе управления GridView или DetailsView, или в шаблоне FormView. Функция двухсторонней привязки данных допускает, чтобы значение, введенное во входной веб-элемент управления, было автоматически назначено соответствующему ObjectDataSource `InsertParameters` или `UpdateParameters` при вставке или обновлении данных. Элемент управления DataList не поддерживает двустороннюю привязку данных, как будет показано далее в этом руководстве, после того, как пользователь вносит изменения и готов обновить данные, нам потребуется программный доступ к этим текстовым окнам `Text` свойствам и передать их значения соответствующему методу `UpdateProduct` в классе `ProductsBLL`.

Наконец, необходимо добавить кнопки обновления и отмены в `EditItemTemplate`. Как было показано в статье « [основной/подробности» с помощью маркированного списка основных записей с учебником «сведения об элементе DataList](../filtering-scenarios-with-the-datalist-and-repeater/master-detail-using-a-bulleted-list-of-master-records-with-a-details-datalist-cs.md) », если щелкнуть кнопку, LinkButton или ImageButton, свойство `CommandName` которого задано в элементе управления Repeater или DataList, то возникает событие Repeater или datalist s `ItemCommand`. Для элемента управления DataList, если для свойства `CommandName` задано определенное значение, также может возникнуть дополнительное событие. В число дополнительных `CommandName` значений свойств входят следующие.

- Cancel вызывает событие `CancelCommand`
- Edit вызывает событие `EditCommand`
- Обновление вызывает событие `UpdateCommand`

Помните, что эти события создаются *в дополнение к* событию `ItemCommand`.

Добавьте в `EditItemTemplate` два веб-элемента управления "Кнопка", для которых задано `CommandName` обновление, а для другого параметра s — значение Cancel. После добавления этих двух веб-элементов управления для кнопок конструктор должен выглядеть следующим образом:

[![добавить кнопки обновления и отмены в EditItemTemplate](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image26.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image25.png)

**Рис. 11**. Добавление кнопок обновления и отмены в `EditItemTemplate` ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image27.png))

После `EditItemTemplate` завершения декларативной разметки DataList s должен выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/samples/sample3.aspx)]

## <a name="step-5-adding-the-plumbing-to-enter-edit-mode"></a>Шаг 5. Добавление провода для перехода в режим правки

На этом этапе наш элемент управления DataList имеет интерфейс правки, определенный с помощью его `EditItemTemplate`; Однако в настоящее время для пользователя, который посещает нашу страницу, нет способа указать, что он хочет изменить сведения о продукте. Нам нужно добавить кнопку изменить в каждый продукт, который при щелчке отображает этот элемент DataList в режиме редактирования. Начните с добавления кнопки "Изменить" в `ItemTemplate`либо через конструктор, либо декларативно. Убедитесь, что вы установили для свойства `CommandName` изменить свойство s.

После добавления этой кнопки редактирования просмотрите страницу в браузере. С этим добавлением каждый список продуктов должен содержать кнопку Edit (изменить).

[![добавить кнопки обновления и отмены в EditItemTemplate](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image29.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image28.png)

**Рис. 12**. кнопки "добавить обновления" и "Отмена" в `EditItemTemplate` ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image30.png))

Нажатие кнопки вызывает обратную передачу, но *не* переводит список продуктов в режим правки. Чтобы сделать продукт доступным для редактирования, необходимо:

1. Задайте для [свойства`EditItemIndex`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.edititemindex.aspx) DataList значение индекса `DataListItem`, для которого была нажата кнопка "Изменить".
2. Выполните повторную привязку данных к DataList. При повторном отображении элемента управления DataList `DataListItem`, чьи `ItemIndex` соответствуют `EditItemIndex` DataList, будут отображены с помощью `EditItemTemplate`.

Так как событие DataList `EditCommand` возникает при нажатии кнопки Edit (изменить), создайте `EditCommand` обработчик событий с помощью следующего кода:

[!code-vb[Main](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/samples/sample4.vb)]

Обработчик событий `EditCommand` передается в объект типа `DataListCommandEventArgs` в качестве второго входного параметра, который включает ссылку на `DataListItem`, для которого была нажата кнопка Edit (`e.Item`). Обработчик событий сначала устанавливает `EditItemIndex` DataList s `ItemIndex` редактируемого `DataListItem`, а затем повторно привязывает данные к DataList, вызвав метод DataList s `DataBind()`.

После добавления этого обработчика событий перейдите на страницу в браузере. Нажав кнопку "Изменить", вы сделаете редактируемый продукт доступным для изменения (см. рис. 13).

[![нажатии кнопки "Изменить" продукт становится доступным для редактирования](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image32.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image31.png)

**Рис. 13**. при нажатии кнопки "Изменить" продукт становится изменяемым ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image33.png))

## <a name="step-6-saving-the-user-s-changes"></a>Шаг 6. Сохранение изменений пользователя

При нажатии кнопки изменить обновление или отмена продукта на этом этапе ничего не происходит; чтобы добавить эту функцию, необходимо создать обработчики событий для `UpdateCommand` и `CancelCommand` событий DataList. Начните с создания обработчика событий `CancelCommand`, который будет выполняться при нажатии на кнопку измененного продукта Cancel и выполнении задачи возврата элемента управления DataList в состояние предварительного редактирования.

Чтобы элемент управления DataList отображал все элементы в режиме только для чтения, необходимо выполнить следующие действия.

1. Задайте [свойству`EditItemIndex`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.edititemindex.aspx) DataList s индекс несуществующего `DataListItem` индекса. `-1` является надежным выбором, так как индексы `DataListItem` начинаются с `0`.
2. Выполните повторную привязку данных к DataList. Так как ни один из `DataListItem` `ItemIndex` ES не соответствует `EditItemIndex`DataList, все элементы управления DataList будут подготовлены к просмотру в режиме только для чтения.

Эти действия можно выполнить с помощью следующего кода обработчика событий:

[!code-vb[Main](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/samples/sample5.vb)]

С помощью этого добавления, нажав кнопку Отмена, вы вернете элемент управления DataList к состоянию предварительного редактирования.

Последний обработчик событий, который нам нужно выполнить, — обработчик событий `UpdateCommand`. Этот обработчик событий должен:

1. Программный доступ к пользовательским названием продукта и цене, а также к измененному продукту с `ProductID`.
2. Запустите процесс обновления, вызвав соответствующую перегрузку `UpdateProduct` в классе `ProductsBLL`.
3. Задайте [свойству`EditItemIndex`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.edititemindex.aspx) DataList s индекс несуществующего `DataListItem` индекса. `-1` является надежным выбором, так как индексы `DataListItem` начинаются с `0`.
4. Выполните повторную привязку данных к DataList. Так как ни один из `DataListItem` `ItemIndex` ES не соответствует `EditItemIndex`DataList, все элементы управления DataList будут подготовлены к просмотру в режиме только для чтения.

Шаги 1 и 2 отвечают за сохранение изменений пользователя. шаги 3 и 4 возвращают элемент управления DataList в состояние предварительного редактирования после сохранения изменений и идентичны действиям, выполненным в обработчике событий `CancelCommand`.

Чтобы получить обновленное название и цену продукта, необходимо использовать метод `FindControl` для программной ссылки на веб-элементы управления TextBox в `EditItemTemplate`. Также необходимо получить измененное значение `ProductID` продукта. При первоначальной привязке ObjectDataSource к элементу управления DataList Visual Studio назначил свойству DataList `DataKeyField` значение первичного ключа из источника данных (`ProductID`). Затем это значение можно получить из коллекции DataList `DataKeys`. Уделите время, чтобы свойство `DataKeyField` действительно было установлено в `ProductID`.

Следующий код реализует четыре шага:

[!code-vb[Main](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/samples/sample6.vb)]

Обработчик событий начинает чтение измененных `ProductID` продуктов из коллекции `DataKeys`. Затем два текстовых поля в `EditItemTemplate` указываются и их `Text` свойства, хранящиеся в локальных переменных `productNameValue` и `unitPriceValue`. Мы используем метод `Decimal.Parse()` для считывания значения из текстового поля `UnitPrice` поэтому, если введенное значение имеет символ валюты, оно по-прежнему может быть правильно преобразовано в значение `Decimal`.

> [!NOTE]
> Значения из текстовых полей `ProductName` и `UnitPrice` присваиваются только переменным Продуктнамевалуе и Унитприцевалуе, если для текстовых свойств текстового поля задано значение. В противном случае для переменных используется значение `Nothing`, которое влияет на обновление данных с помощью значения `NULL` базы данных. То есть наш код обрабатывает преобразование пустых строк в значения `NULL` базы данных, что является поведением по умолчанию интерфейса редактирования в элементах управления GridView, DetailsView и FormView.

После считывания значений вызывается метод `UpdateProduct` класса `ProductsBLL`, передающий название продукта, цену и `ProductID`. Обработчик событий завершает работу, возвращая элемент управления DataList в состояние предварительного редактирования, используя ту же логику, что и в обработчике событий `CancelCommand`.

После завершения обработчиков событий `EditCommand`, `CancelCommand`и `UpdateCommand` посетитель может изменить имя и цену продукта. Рисунки 14-16. Отображение рабочего процесса редактирования в действии.

[![при первом посещении страницы все продукты находятся в режиме только для чтения](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image35.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image34.png)

**Рис. 14**. при первом посещении страницы все продукты находятся в режиме только для чтения ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image36.png)).

[![для обновления имени или цены продукта нажмите кнопку "Изменить".](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image38.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image37.png)

**Рис. 15**. чтобы обновить название или цену продукта, нажмите кнопку "Изменить" ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image39.png))

[![после изменения значения нажмите кнопку обновить, чтобы вернуться в режим только для чтения.](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image41.png)](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image40.png)

**Рис. 16**. После изменения значения нажмите кнопку обновить, чтобы вернуться в режим только для чтения ([щелкните, чтобы просмотреть изображение с полным размером](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/_static/image42.png)).

## <a name="step-7-adding-delete-capabilities"></a>Шаг 7. Добавление возможностей удаления

Действия по добавлению возможностей удаления в DataList аналогичны тем, что позволяют добавлять возможности редактирования. Вкратце, нам нужно добавить кнопку «Удалить» к `ItemTemplate`, при нажатии которой:

1. Считывает в соответствующем продукте `ProductID` с помощью коллекции `DataKeys`.
2. Выполняет удаление, вызывая метод `ProductsBLL` класса s `DeleteProduct`.
3. Повторно привязывает данные к DataList.

Начнем с добавления кнопки Удалить в `ItemTemplate`.

При нажатии кнопки, `CommandName` изменить, обновить или отменить, вызывает событие DataList s `ItemCommand` вместе с дополнительным событием (например, при использовании команды Изменить событие `EditCommand`). Аналогичным образом любая кнопка, LinkButton или ImageButton в элементе управления DataList, свойство `CommandName` которого имеет значение Delete, вызывает срабатывание события `DeleteCommand` (вместе с `ItemCommand`).

Добавьте кнопку "Удалить" рядом с кнопкой "Изменить" в `ItemTemplate`, задав для свойства `CommandName` значение "Удалить". После добавления этой кнопки элемент управления DataList s `ItemTemplate` декларативный синтаксис должен выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/samples/sample7.aspx)]

Затем создайте обработчик событий для события `DeleteCommand` DataList, используя следующий код:

[!code-vb[Main](an-overview-of-editing-and-deleting-data-in-the-datalist-vb/samples/sample8.vb)]

Нажатие кнопки Удалить вызывает обратную передачу и запускает событие `DeleteCommand` DataList. В обработчике событий в коллекции `DataKeys` используется доступ к `ProductID`ному продукту. Затем продукт удаляется путем вызова метода `ProductsBLL` Class s `DeleteProduct`.

После удаления продукта важно повторно привязать данные к элементу управления DataList (`DataList1.DataBind()`), в противном случае в DataList будет отображаться только что удаленный продукт.

## <a name="summary"></a>Сводка

Хотя в DataList отсутствует точка и нажата кнопка Изменить и удалить поддержку, которая может быть добавлена в GridView, с коротким фрагментом кода его можно улучшить, чтобы включить эти функции. В этом учебнике мы рассмотрели, как создать список продуктов с двумя столбцами, которые можно удалить, а также имена и цены, которые можно изменить. Добавление поддержки редактирования и удаления заключается в том, чтобы включить соответствующие веб-элементы управления в `ItemTemplate` и `EditItemTemplate`, создавать соответствующие обработчики событий, считывать значения вводимых пользователем и первичных ключей, а также взаимодействуя с уровнем бизнес-логики.

Хотя мы добавили базовые возможности редактирования и удаления в DataList, у него нет более сложных функций. Например, отсутствует проверка поля ввода. Если пользователь вводит цену слишком дорого, `Decimal.Parse` при попытке преобразовать слишком дорогостоящий в `Decimal`. Аналогичным образом, если возникла проблема при обновлении данных на уровнях бизнес-логики или доступа к данным, пользователь будет представлен на экране стандартного сообщения об ошибке. Без какого-либо подтверждения на кнопке Delete случайное удаление продукта слишком вероятно.

В следующих учебных курсах будет показано, как улучшить взаимодействие с пользователем при редактировании.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальными рецензентами для этого учебника были Зак Jones, Кен Песписа и Рэнди Шмидт. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](customizing-the-datalist-s-editing-interface-cs.md)
> [Вперед](performing-batch-updates-vb.md)
