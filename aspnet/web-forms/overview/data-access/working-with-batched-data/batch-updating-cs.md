---
uid: web-forms/overview/data-access/working-with-batched-data/batch-updating-cs
title: Пакетное обновлениеC#() | Документация Майкрософт
author: rick-anderson
description: Узнайте, как обновить несколько записей базы данных за одну операцию. На уровне пользовательского интерфейса создается элемент управления GridView, в котором каждая строка является редактируемой. В данных...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: 4e849bcc-c557-4bc3-937e-f7453ee87265
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/batch-updating-cs
msc.type: authoredcontent
ms.openlocfilehash: baaaf37c47cc57d90ea579a5c20949bf8cfc7a3c
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74583617"
---
# <a name="batch-updating-c"></a><span data-ttu-id="8f4b3-105">Пакетное обновление (C#)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-105">Batch Updating (C#)</span></span>

<span data-ttu-id="8f4b3-106">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-106">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="8f4b3-107">[Скачать код](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_64_CS.zip) или [скачать PDF](batch-updating-cs/_static/datatutorial64cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-107">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_64_CS.zip) or [Download PDF](batch-updating-cs/_static/datatutorial64cs1.pdf)</span></span>

> <span data-ttu-id="8f4b3-108">Узнайте, как обновить несколько записей базы данных за одну операцию.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-108">Learn how to update multiple database records in a single operation.</span></span> <span data-ttu-id="8f4b3-109">На уровне пользовательского интерфейса создается элемент управления GridView, в котором каждая строка является редактируемой.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-109">In the User Interface Layer we build a GridView where each row is editable.</span></span> <span data-ttu-id="8f4b3-110">На уровне доступа к данным мы переносите несколько операций обновления в рамках транзакции, чтобы гарантировать успешность всех обновлений или откат всех обновлений.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-110">In the Data Access Layer we wrap the multiple Update operations within a transaction to ensure that all updates succeed or all updates are rolled back.</span></span>

## <a name="introduction"></a><span data-ttu-id="8f4b3-111">Введение</span><span class="sxs-lookup"><span data-stu-id="8f4b3-111">Introduction</span></span>

<span data-ttu-id="8f4b3-112">В [предыдущем учебном курсе](wrapping-database-modifications-within-a-transaction-cs.md) было показано, как расширить уровень доступа к данным, чтобы добавить поддержку транзакций базы данных.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-112">In the [preceding tutorial](wrapping-database-modifications-within-a-transaction-cs.md) we saw how to extend the Data Access Layer to add support for database transactions.</span></span> <span data-ttu-id="8f4b3-113">Транзакции базы данных гарантируют, что ряд инструкций изменения данных будет обрабатываться как одна атомарная операция, что гарантирует, что все изменения завершатся неудачей или все будет успешным.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-113">Database transactions guarantee that a series of data modification statements will be treated as one atomic operation, which ensures that all modifications will fail or all will succeed.</span></span> <span data-ttu-id="8f4b3-114">Благодаря этой функции DAL низкого уровня мы перейдем к созданию интерфейсов модификации данных пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-114">With this low-level DAL functionality out of the way, we re ready to turn our attention to creating batch data modification interfaces.</span></span>

<span data-ttu-id="8f4b3-115">В этом учебнике будет построен элемент управления GridView, в котором каждая строка является редактируемой (см. рис. 1).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-115">In this tutorial we'll build a GridView where each row is editable (see Figure 1).</span></span> <span data-ttu-id="8f4b3-116">Поскольку каждая строка подготавливается к просмотру в интерфейсе редактирования, нет необходимости в столбцах кнопок Правка, обновить и Отмена.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-116">Since each row is rendered in its editing interface, there s no need for a column of Edit, Update, and Cancel buttons.</span></span> <span data-ttu-id="8f4b3-117">Вместо этого на странице есть две кнопки обновить продукты, которые при нажатии перечисляют строки GridView и обновляют базу данных.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-117">Instead, there are two Update Products buttons on the page that, when clicked, enumerate the GridView rows and update the database.</span></span>

<span data-ttu-id="8f4b3-118">[![, что каждая строка в GridView является редактируемой](batch-updating-cs/_static/image1.gif)](batch-updating-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-118">[![Each Row in the GridView is Editable](batch-updating-cs/_static/image1.gif)](batch-updating-cs/_static/image1.png)</span></span>

<span data-ttu-id="8f4b3-119">**Рис. 1**. Каждая строка в GridView является редактируемой ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-119">**Figure 1**: Each Row in the GridView is Editable ([Click to view full-size image](batch-updating-cs/_static/image2.png))</span></span>

<span data-ttu-id="8f4b3-120">Давайте приступим к работе!</span><span class="sxs-lookup"><span data-stu-id="8f4b3-120">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="8f4b3-121">В учебнике [выполнение пакетного обновления](../editing-and-deleting-data-through-the-datalist/performing-batch-updates-cs.md) мы создали интерфейс редактирования пакетной службы с помощью элемента управления DataList.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-121">In the [Performing Batch Updates](../editing-and-deleting-data-through-the-datalist/performing-batch-updates-cs.md) tutorial we created a batch editing interface using the DataList control.</span></span> <span data-ttu-id="8f4b3-122">Этот учебник отличается от предыдущего в том, что использует GridView и пакетное обновление выполняется внутри области транзакции.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-122">This tutorial differs from the previous one in that is uses a GridView and the batch update is performed within the scope of a transaction.</span></span> <span data-ttu-id="8f4b3-123">По завершении работы с этим руководством я рекомендую вернуться к предыдущему учебнику и обновить его, чтобы использовать функции, связанные с транзакциями базы данных, добавленные в предыдущем руководстве.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-123">After completing this tutorial I encourage you to return to the earlier tutorial and update it to use the database transaction-related functionality added in the preceding tutorial.</span></span>

## <a name="examining-the-steps-for-making-all-gridview-rows-editable"></a><span data-ttu-id="8f4b3-124">Изучение шагов, позволяющих вносить изменения в все строки GridView</span><span class="sxs-lookup"><span data-stu-id="8f4b3-124">Examining the Steps for Making All GridView Rows Editable</span></span>

<span data-ttu-id="8f4b3-125">Как обсуждалось в [обзоре руководства по вставке, обновлению и удалению данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) , GridView предлагает встроенную поддержку редактирования базовых данных для отдельных строк.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-125">As discussed in the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView offers built-in support for editing its underlying data on a per-row basis.</span></span> <span data-ttu-id="8f4b3-126">На внутреннем уровне элемент управления GridView замещает строку, которую можно редактировать с помощью [свойства`EditIndex`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.editindex(VS.80).aspx).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-126">Internally, the GridView notes what row is editable through its [`EditIndex` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.editindex(VS.80).aspx).</span></span> <span data-ttu-id="8f4b3-127">Так как GridView привязан к источнику данных, он проверяет каждую строку на предмет того, что индекс строки равен значению `EditIndex`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-127">As the GridView is being bound to its data source, it checks each row to see if the index of the row equals the value of `EditIndex`.</span></span> <span data-ttu-id="8f4b3-128">В этом случае поля строки отображаются с помощью своих интерфейсов редактирования.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-128">If so, that row s fields are rendered using their editing interfaces.</span></span> <span data-ttu-id="8f4b3-129">Для BoundFields интерфейс редактирования — это текстовое поле, которому свойству `Text` присваивается значение поля данных, заданное свойством BoundField `DataField`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-129">For BoundFields, the editing interface is a TextBox whose `Text` property is assigned the value of the data field specified by the BoundField s `DataField` property.</span></span> <span data-ttu-id="8f4b3-130">Для полей TemplateField вместо `ItemTemplate`используется `EditItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-130">For TemplateFields, the `EditItemTemplate` is used in place of the `ItemTemplate`.</span></span>

<span data-ttu-id="8f4b3-131">Помните, что рабочий процесс редактирования запускается, когда пользователь нажимает кнопку изменить строку.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-131">Recall that the editing workflow starts when a user clicks a row s Edit button.</span></span> <span data-ttu-id="8f4b3-132">Это вызывает обратную передачу, задает для свойства `EditIndex` GridView s значение индекса clickd Row, а затем повторно привязывает данные к сетке.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-132">This causes a postback, sets the GridView s `EditIndex` property to the clicked row s index, and rebinds the data to the grid.</span></span> <span data-ttu-id="8f4b3-133">При нажатии кнопки "Отмена" в случае обратной передачи `EditIndex` присваивается значение `-1` перед повторной привязкой данных к сетке.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-133">When a row s Cancel button is clicked, on postback the `EditIndex` is set to a value of `-1` before rebinding the data to the grid.</span></span> <span data-ttu-id="8f4b3-134">Так как GridView-строки в начале индексирования начинаются с нуля, установка `EditIndex` в `-1` приводит к отображению GridView в режиме только для чтения.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-134">Since the GridView s rows start indexing at zero, setting `EditIndex` to `-1` has the effect of displaying the GridView in read-only mode.</span></span>

<span data-ttu-id="8f4b3-135">Свойство `EditIndex` хорошо подходит для редактирования отдельных строк, но не предназначено для пакетного редактирования.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-135">The `EditIndex` property works well for per-row editing, but is not designed for batch editing.</span></span> <span data-ttu-id="8f4b3-136">Чтобы сделать весь элемент GridView доступным для редактирования, необходимо, чтобы каждая строка отображалась с помощью интерфейса правки.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-136">To make the entire GridView editable, we need to have each row render using its editing interface.</span></span> <span data-ttu-id="8f4b3-137">Самый простой способ сделать это — создать место, где каждое редактируемое поле реализуется как TemplateField с интерфейсом правки, определенным в `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-137">The easiest way to accomplish this is to create where each editable field is implemented as a TemplateField with its editing interface defined in the `ItemTemplate`.</span></span>

<span data-ttu-id="8f4b3-138">В следующих нескольких шагах мы создадим полностью редактируемый элемент управления GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-138">Over the next several steps we'll create a completely editable GridView.</span></span> <span data-ttu-id="8f4b3-139">На этапе 1 мы начнем с создания GridView и его ObjectDataSource и преобразуйте его BoundFields и CheckBoxField в полей TemplateField.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-139">In Step 1 we'll start by creating the GridView and its ObjectDataSource and convert its BoundFields and CheckBoxField into TemplateFields.</span></span> <span data-ttu-id="8f4b3-140">В шагах 2 и 3 мы перейдем интерфейсы редактирования из полей TemplateField `EditItemTemplate` s в их `ItemTemplate` s.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-140">In Steps 2 and 3 we'll move the editing interfaces from the TemplateFields `EditItemTemplate` s to their `ItemTemplate` s.</span></span>

## <a name="step-1-displaying-product-information"></a><span data-ttu-id="8f4b3-141">Шаг 1. Отображение сведений о продукте</span><span class="sxs-lookup"><span data-stu-id="8f4b3-141">Step 1: Displaying Product Information</span></span>

<span data-ttu-id="8f4b3-142">Прежде чем беспокоиться о создании элемента управления GridView, где доступны строки для редактирования, начнем с простого отображения сведений о продукте.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-142">Before we worry about creating a GridView where are rows are editable, let s start by simply displaying the product information.</span></span> <span data-ttu-id="8f4b3-143">Откройте страницу `BatchUpdate.aspx` в папке `BatchData` и перетащите элемент управления GridView с панели инструментов в конструктор.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-143">Open the `BatchUpdate.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="8f4b3-144">Установите `ID` GridView s `ProductsGrid` и, выбрав его смарт-тег, привяжите его к новому ObjectDataSource с именем `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-144">Set the GridView s `ID` to `ProductsGrid` and, from its smart tag, choose to bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="8f4b3-145">Настройте ObjectDataSource для извлечения данных из `GetProducts` метода `ProductsBLL` классов.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-145">Configure the ObjectDataSource to retrieve its data from the `ProductsBLL` class s `GetProducts` method.</span></span>

<span data-ttu-id="8f4b3-146">[![настроить ObjectDataSource для использования класса ProductsBLL](batch-updating-cs/_static/image2.gif)](batch-updating-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-146">[![Configure the ObjectDataSource to Use the ProductsBLL Class](batch-updating-cs/_static/image2.gif)](batch-updating-cs/_static/image3.png)</span></span>

<span data-ttu-id="8f4b3-147">**Рис. 2**. Настройка ObjectDataSource для использования класса `ProductsBLL` ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-147">**Figure 2**: Configure the ObjectDataSource to Use the `ProductsBLL` Class ([Click to view full-size image](batch-updating-cs/_static/image4.png))</span></span>

<span data-ttu-id="8f4b3-148">[![получения данных о продуктах с помощью метода Products](batch-updating-cs/_static/image3.gif)](batch-updating-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-148">[![Retrieve the Product Data Using the GetProducts Method](batch-updating-cs/_static/image3.gif)](batch-updating-cs/_static/image5.png)</span></span>

<span data-ttu-id="8f4b3-149">**Рис. 3**. получение данных о продукте с помощью метода `GetProducts` ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-149">**Figure 3**: Retrieve the Product Data Using the `GetProducts` Method ([Click to view full-size image](batch-updating-cs/_static/image6.png))</span></span>

<span data-ttu-id="8f4b3-150">Как и в GridView, функции изменения ObjectDataSource предназначены для работы с каждым строкой.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-150">Like the GridView, the ObjectDataSource s modification features are designed to work on a per-row basis.</span></span> <span data-ttu-id="8f4b3-151">Чтобы обновить набор записей, необходимо написать фрагмент кода в классе кода программной части ASP.NET Page s, который пакетируют данные и передает их BLL.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-151">In order to update a set of records, we'll need to write a bit of code in the ASP.NET page s code-behind class that batches the data and passes it to the BLL.</span></span> <span data-ttu-id="8f4b3-152">Поэтому в раскрывающихся списках на вкладках "Обновить", "вставить" и "Удалить" выберите значение (нет).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-152">Therefore, set the drop-down lists in the ObjectDataSource s UPDATE, INSERT, and DELETE tabs to (None).</span></span> <span data-ttu-id="8f4b3-153">Чтобы завершить работу мастера, нажмите кнопку Готово.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-153">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="8f4b3-154">[![установить в раскрывающихся списках на вкладках обновления, вставки и удаления значение (нет)](batch-updating-cs/_static/image4.gif)](batch-updating-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-154">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](batch-updating-cs/_static/image4.gif)](batch-updating-cs/_static/image7.png)</span></span>

<span data-ttu-id="8f4b3-155">**Рис. 4**. Установка раскрывающихся списков на вкладках обновления, вставки и удаления в (нет) ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-155">**Figure 4**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](batch-updating-cs/_static/image8.png))</span></span>

<span data-ttu-id="8f4b3-156">После завершения работы мастера настройки источника данных декларативная разметка ObjectDataSource s должна выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="8f4b3-156">After completing the Configure Data Source wizard, the ObjectDataSource s declarative markup should look like the following:</span></span>

[!code-aspx[Main](batch-updating-cs/samples/sample1.aspx)]

<span data-ttu-id="8f4b3-157">Завершение работы мастера настройки источника данных также приводит к тому, что Visual Studio создает BoundFields и CheckBoxField для полей данных продукта в GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-157">Completing the Configure Data Source wizard also causes Visual Studio to create BoundFields and a CheckBoxField for the product data fields in the GridView.</span></span> <span data-ttu-id="8f4b3-158">В рамках этого руководства разрешить пользователю только просматривать и изменять название продукта, категорию, цену и состояние неподдерживаемого состояния.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-158">For this tutorial, let s only allow the user to view and edit the product s name, category, price, and discontinued status.</span></span> <span data-ttu-id="8f4b3-159">Удалите все поля, кроме `ProductName`, `CategoryName`, `UnitPrice`и `Discontinued`, и переименуйте свойства `HeaderText` для первых трех полей на продукты, категорию и цену соответственно.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-159">Remove all but the `ProductName`, `CategoryName`, `UnitPrice`, and `Discontinued` fields and rename the `HeaderText` properties of the first three fields to Product, Category, and Price, respectively.</span></span> <span data-ttu-id="8f4b3-160">Наконец, установите флажки Включить разбиение по страницам и включить сортировку в смарт-теге GridView s.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-160">Lastly, check the Enable Paging and Enable Sorting checkboxes in the GridView s smart tag.</span></span>

<span data-ttu-id="8f4b3-161">На этом этапе GridView имеет три BoundFields (`ProductName`, `CategoryName`и `UnitPrice`) и CheckBoxField (`Discontinued`).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-161">At this point the GridView has three BoundFields (`ProductName`, `CategoryName`, and `UnitPrice`) and a CheckBoxField (`Discontinued`).</span></span> <span data-ttu-id="8f4b3-162">Необходимо преобразовать эти четыре поля в полей TemplateField, а затем переместить интерфейс редактирования из TemplateField s `EditItemTemplate` в `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-162">We need to convert these four fields into TemplateFields and then move the editing interface from the TemplateField s `EditItemTemplate` to its `ItemTemplate`.</span></span>

> [!NOTE]
> <span data-ttu-id="8f4b3-163">Мы изучили создание и настройку полей TemplateField в руководстве по [настройке интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="8f4b3-163">We explored creating and customizing TemplateFields in the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial.</span></span> <span data-ttu-id="8f4b3-164">Мы рассмотрим шаги по преобразованию BoundFields и CheckBoxField в полей TemplateField и определении их интерфейсов редактирования в `ItemTemplate` s, но если вы захотите или потребуете обновления, не сможете вернуться к предыдущему руководству.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-164">We'll walk through the steps of converting the BoundFields and CheckBoxField into TemplateFields and defining their editing interfaces in their `ItemTemplate` s, but if you get stuck or need a refresher, don t hesitate to refer back to this earlier tutorial.</span></span>

<span data-ttu-id="8f4b3-165">Из смарт-тега GridView s щелкните ссылку изменить столбцы, чтобы открыть диалоговое окно поля.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-165">From the GridView s smart tag, click the Edit Columns link to open the Fields dialog box.</span></span> <span data-ttu-id="8f4b3-166">Затем выберите каждое поле и щелкните преобразовать это поле в ссылку TemplateField.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-166">Next, select each field and click the Convert this field into a TemplateField link.</span></span>

![Преобразование существующих BoundFields и CheckBoxField в TemplateField](batch-updating-cs/_static/image5.gif)

<span data-ttu-id="8f4b3-168">**Рис. 5**. Преобразование существующих BoundFields и CheckBoxField в TemplateField</span><span class="sxs-lookup"><span data-stu-id="8f4b3-168">**Figure 5**: Convert the Existing BoundFields and CheckBoxField Into TemplateField</span></span>

<span data-ttu-id="8f4b3-169">Теперь, когда каждое поле является TemplateField, мы перейдем к перемещению интерфейса редактирования из `EditItemTemplate` s в `ItemTemplate` s.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-169">Now that each field is a TemplateField, we re ready to move the editing interface from the `EditItemTemplate` s to the `ItemTemplate` s.</span></span>

## <a name="step-2-creating-theproductnameunitprice-anddiscontinuedediting-interfaces"></a><span data-ttu-id="8f4b3-170">Шаг 2. Создание`ProductName`,`UnitPrice`и`Discontinued`интерфейсов редактирования</span><span class="sxs-lookup"><span data-stu-id="8f4b3-170">Step 2: Creating the`ProductName`,`UnitPrice`, and`Discontinued`Editing Interfaces</span></span>

<span data-ttu-id="8f4b3-171">Создание `ProductName`, `UnitPrice`и `Discontinued` интерфейсов редактирования является темой этого шага и довольно проста, так как каждый интерфейс уже определен в `EditItemTemplate`TemplateField s.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-171">Creating the `ProductName`, `UnitPrice`, and `Discontinued` editing interfaces are the topic of this step and are pretty straightforward, as each interface is already defined in the TemplateField s `EditItemTemplate`.</span></span> <span data-ttu-id="8f4b3-172">Создание интерфейса редактирования `CategoryName` является немного более сложным, поскольку необходимо создать DropDownList для применимых категорий.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-172">Creating the `CategoryName` editing interface is a bit more involved since we need to create a DropDownList of the applicable categories.</span></span> <span data-ttu-id="8f4b3-173">Этот `CategoryName` интерфейс редактирования разрешается на шаге 3.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-173">This `CategoryName` editing interface is tackled in Step 3.</span></span>

<span data-ttu-id="8f4b3-174">Давайте начнем с `ProductName` TemplateField.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-174">Let s start with the `ProductName` TemplateField.</span></span> <span data-ttu-id="8f4b3-175">Щелкните ссылку Edit Templates (изменить шаблоны) в смарт-теге GridView s и перейдите к `ProductName` TemplateField s `EditItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-175">Click on the Edit Templates link from the GridView s smart tag and drill down to the `ProductName` TemplateField s `EditItemTemplate`.</span></span> <span data-ttu-id="8f4b3-176">Выберите текстовое поле, скопируйте его в буфер обмена и вставьте в `ProductName` TemplateField s `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-176">Select the TextBox, copy it to the clipboard, and then paste it to the `ProductName` TemplateField s `ItemTemplate`.</span></span> <span data-ttu-id="8f4b3-177">Измените для свойства `ID` TextBox значение `ProductName`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-177">Change the TextBox s `ID` property to `ProductName`.</span></span>

<span data-ttu-id="8f4b3-178">Затем добавьте RequiredFieldValidator в `ItemTemplate`, чтобы гарантировать, что пользователь предоставит значение для каждого названия продукта.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-178">Next, add a RequiredFieldValidator to the `ItemTemplate` to ensure that the user provides a value for each product s name.</span></span> <span data-ttu-id="8f4b3-179">Задайте для свойства `ControlToValidate` значение ProductName, для свойства `ErrorMessage` необходимо указать имя продукта.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-179">Set the `ControlToValidate` property to ProductName, the `ErrorMessage` property to You must provide the product's name.</span></span> <span data-ttu-id="8f4b3-180">и свойство `Text` для \*.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-180">and the `Text` property to \*.</span></span> <span data-ttu-id="8f4b3-181">После внесения этих дополнений в `ItemTemplate`экран должен выглядеть примерно так, как показано на рис. 6.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-181">After making these additions to the `ItemTemplate`, your screen should look similar to Figure 6.</span></span>

<span data-ttu-id="8f4b3-182">[![TemplateField ProductName теперь включает в себя текстовое поле и RequiredFieldValidator](batch-updating-cs/_static/image6.gif)](batch-updating-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-182">[![The ProductName TemplateField Now Includes a TextBox and a RequiredFieldValidator](batch-updating-cs/_static/image6.gif)](batch-updating-cs/_static/image9.png)</span></span>

<span data-ttu-id="8f4b3-183">**Рис. 6**. `ProductName` TemplateField теперь содержит текстовое поле и RequiredFieldValidator ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-183">**Figure 6**: The `ProductName` TemplateField Now Includes a TextBox and a RequiredFieldValidator ([Click to view full-size image](batch-updating-cs/_static/image10.png))</span></span>

<span data-ttu-id="8f4b3-184">Для интерфейса редактирования `UnitPrice` Начните с копирования текстового поля из `EditItemTemplate` в `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-184">For the `UnitPrice` editing interface, start by copying the TextBox from the `EditItemTemplate` to the `ItemTemplate`.</span></span> <span data-ttu-id="8f4b3-185">Затем поместите $ перед текстовым полем и задайте для свойства `ID` значение UnitPrice, а для свойства `Columns` — значение 8.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-185">Next, place a $ in front of the TextBox and set its `ID` property to UnitPrice and its `Columns` property to 8 .</span></span>

<span data-ttu-id="8f4b3-186">Также добавьте объект CompareValidator в `ItemTemplate` `UnitPrice` s, чтобы убедиться, что значение, указанное пользователем, является допустимым значением валюты, которое больше или равно $0,00.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-186">Also add a CompareValidator to the `UnitPrice` s `ItemTemplate` to ensure that the value entered by the user is a valid currency value greater than or equal to $0.00.</span></span> <span data-ttu-id="8f4b3-187">Задайте для свойства `ControlToValidate` проверяющего элемента управления значение UnitPrice, для свойства `ErrorMessage` необходимо ввести допустимое значение валюты.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-187">Set the validator s `ControlToValidate` property to UnitPrice, its `ErrorMessage` property to You must enter a valid currency value.</span></span> <span data-ttu-id="8f4b3-188">Не указывайте символы валют., свойство `Text` для \*, его свойство `Type` для `Currency`, свойство `Operator` в `GreaterThanEqual`, а свойство `ValueToCompare` — в значение 0.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-188">Please omit any currency symbols., its `Text` property to \*, its `Type` property to `Currency`, its `Operator` property to `GreaterThanEqual`, and its `ValueToCompare` property to 0 .</span></span>

<span data-ttu-id="8f4b3-189">[![добавить объект CompareValidator для обеспечения того, что указанная цена является неотрицательным значением валюты](batch-updating-cs/_static/image7.gif)](batch-updating-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-189">[![Add a CompareValidator to Ensure the Price Entered is a Non-Negative Currency Value](batch-updating-cs/_static/image7.gif)](batch-updating-cs/_static/image11.png)</span></span>

<span data-ttu-id="8f4b3-190">**Рис. 7**. Добавление элемента CompareValidator для обеспечения того, что указанная цена является неотрицательным значением валюты ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-190">**Figure 7**: Add a CompareValidator to Ensure the Price Entered is a Non-Negative Currency Value ([Click to view full-size image](batch-updating-cs/_static/image12.png))</span></span>

<span data-ttu-id="8f4b3-191">Для `Discontinued` TemplateField можно использовать флажок, уже определенный в `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-191">For the `Discontinued` TemplateField you can use the CheckBox already defined in the `ItemTemplate`.</span></span> <span data-ttu-id="8f4b3-192">Просто задайте для его `ID` значение больше, а для свойства `Enabled` — значение `true`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-192">Simply set its `ID` to Discontinued and its `Enabled` property to `true`.</span></span>

## <a name="step-3-creating-thecategorynameediting-interface"></a><span data-ttu-id="8f4b3-193">Шаг 3. Создание интерфейса редактирования`CategoryName`</span><span class="sxs-lookup"><span data-stu-id="8f4b3-193">Step 3: Creating the`CategoryName`Editing Interface</span></span>

<span data-ttu-id="8f4b3-194">Интерфейс редактирования в `CategoryName` TemplateField s `EditItemTemplate` содержит текстовое поле, в котором отображается значение поля данных `CategoryName`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-194">The editing interface in the `CategoryName` TemplateField s `EditItemTemplate` contains a TextBox that displays the value of the `CategoryName` data field.</span></span> <span data-ttu-id="8f4b3-195">Необходимо заменить его на DropDownList, в котором перечислены возможные категории.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-195">We need to replace this with a DropDownList that lists the possible categories.</span></span>

> [!NOTE]
> <span data-ttu-id="8f4b3-196">Руководство по [настройке интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) содержит более подробное и полное описание настройки шаблона для включения DropDownList, а не текстового поля.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-196">The [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial contains a more thorough and complete discussion on customizing a template to include a DropDownList as opposed to a TextBox.</span></span> <span data-ttu-id="8f4b3-197">Хотя приведенные здесь действия завершены, они представлены кратко.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-197">While the steps here are complete, they are presented tersely.</span></span> <span data-ttu-id="8f4b3-198">Более подробные сведения о создании и настройке DropDownList см. в разделе [Настройка интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="8f4b3-198">For a more in-depth look at creating and configuring the categories DropDownList, refer back to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial.</span></span>

<span data-ttu-id="8f4b3-199">Перетащите DropDownList с панели элементов на `CategoryName` TemplateField s `ItemTemplate`, установив для его `ID` значение `Categories`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-199">Drag a DropDownList from the Toolbox onto the `CategoryName` TemplateField s `ItemTemplate`, setting its `ID` to `Categories`.</span></span> <span data-ttu-id="8f4b3-200">На этом этапе мы обычно определяем источник данных элементов управления DropDownList s через смарт-тег, создавая новый элемент управления ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-200">At this point we would usually define the DropDownLists s data source through its smart tag, creating a new ObjectDataSource.</span></span> <span data-ttu-id="8f4b3-201">Однако это приведет к добавлению ObjectDataSource в `ItemTemplate`, что приведет к созданию экземпляра ObjectDataSource для каждой строки GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-201">However, this will add the ObjectDataSource within the `ItemTemplate`, which will result in an ObjectDataSource instance created for each GridView row.</span></span> <span data-ttu-id="8f4b3-202">Вместо этого давайте создадим элемент управления ObjectDataSource за пределами GridView s полей TemplateField.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-202">Instead, let s create the ObjectDataSource outside of the GridView s TemplateFields.</span></span> <span data-ttu-id="8f4b3-203">Завершите редактирование шаблона и перетащите элемент управления ObjectDataSource с панели элементов в конструктор под `ProductsDataSource` ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-203">End the template editing and drag an ObjectDataSource from the Toolbox onto the Designer beneath the `ProductsDataSource` ObjectDataSource.</span></span> <span data-ttu-id="8f4b3-204">Присвойте новому элементу ObjectDataSource имя `CategoriesDataSource` и настройте его для использования метода `CategoriesBLL` класса s `GetCategories`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-204">Name the new ObjectDataSource `CategoriesDataSource` and configure it to use the `CategoriesBLL` class s `GetCategories` method.</span></span>

<span data-ttu-id="8f4b3-205">[![настроить ObjectDataSource для использования класса CategoriesBLL](batch-updating-cs/_static/image8.gif)](batch-updating-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-205">[![Configure the ObjectDataSource to Use the CategoriesBLL Class](batch-updating-cs/_static/image8.gif)](batch-updating-cs/_static/image13.png)</span></span>

<span data-ttu-id="8f4b3-206">**Рис. 8**. Настройка ObjectDataSource для использования класса `CategoriesBLL` ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-206">**Figure 8**: Configure the ObjectDataSource to Use the `CategoriesBLL` Class ([Click to view full-size image](batch-updating-cs/_static/image14.png))</span></span>

<span data-ttu-id="8f4b3-207">[![получения данных категории с помощью метода Categories](batch-updating-cs/_static/image9.gif)](batch-updating-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-207">[![Retrieve the Category Data Using the GetCategories Method](batch-updating-cs/_static/image9.gif)](batch-updating-cs/_static/image15.png)</span></span>

<span data-ttu-id="8f4b3-208">**Рис. 9**. получение данных категории с помощью метода `GetCategories` ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-208">**Figure 9**: Retrieve the Category Data Using the `GetCategories` Method ([Click to view full-size image](batch-updating-cs/_static/image16.png))</span></span>

<span data-ttu-id="8f4b3-209">Так как этот элемент ObjectDataSource используется только для получения данных, установите в раскрывающихся списках на вкладках обновление и удаление значение (нет).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-209">Since this ObjectDataSource is used merely to retrieve data, set the drop-down lists in the UPDATE and DELETE tabs to (None).</span></span> <span data-ttu-id="8f4b3-210">Чтобы завершить работу мастера, нажмите кнопку Готово.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-210">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="8f4b3-211">[![установить в раскрывающихся списках на вкладках обновить и удалить значение (нет)](batch-updating-cs/_static/image10.gif)](batch-updating-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-211">[![Set the Drop-Down Lists in the UPDATE and DELETE Tabs to (None)](batch-updating-cs/_static/image10.gif)](batch-updating-cs/_static/image17.png)</span></span>

<span data-ttu-id="8f4b3-212">**Рис. 10**. Установка в раскрывающихся списках на вкладках "Обновить" и "Удалить" (нет) ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-212">**Figure 10**: Set the Drop-Down Lists in the UPDATE and DELETE Tabs to (None) ([Click to view full-size image](batch-updating-cs/_static/image18.png))</span></span>

<span data-ttu-id="8f4b3-213">После завершения работы мастера декларативная разметка `CategoriesDataSource` s должна выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="8f4b3-213">After completing the wizard, the `CategoriesDataSource` s declarative markup should look like the following:</span></span>

[!code-aspx[Main](batch-updating-cs/samples/sample2.aspx)]

<span data-ttu-id="8f4b3-214">После создания и настройки `CategoriesDataSource` вернитесь к `CategoryName` TemplateField s `ItemTemplate` а в смарт-теге DropDownList s щелкните ссылку Выбор источника данных.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-214">With the `CategoriesDataSource` created and configured, return to the `CategoryName` TemplateField s `ItemTemplate` and, from the DropDownList s smart tag, click on the Choose Data Source link.</span></span> <span data-ttu-id="8f4b3-215">В мастере настройки источника данных выберите параметр `CategoriesDataSource` из первого раскрывающегося списка и выберите использование `CategoryName` для вывода и `CategoryID` в качестве значения.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-215">In the Data Source Configuration wizard, select the `CategoriesDataSource` option from the first drop-down list and choose to have `CategoryName` used for the display and `CategoryID` as the value.</span></span>

<span data-ttu-id="8f4b3-216">[![привязать DropDownList к CategoriesDataSource](batch-updating-cs/_static/image11.gif)](batch-updating-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-216">[![Bind the DropDownList to the CategoriesDataSource](batch-updating-cs/_static/image11.gif)](batch-updating-cs/_static/image19.png)</span></span>

<span data-ttu-id="8f4b3-217">**Рис. 11**. Привязка DropDownList к `CategoriesDataSource` ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-217">**Figure 11**: Bind the DropDownList to the `CategoriesDataSource` ([Click to view full-size image](batch-updating-cs/_static/image20.png))</span></span>

<span data-ttu-id="8f4b3-218">На этом этапе `Categories` DropDownList перечисляет все категории, но не автоматически выбирает соответствующую категорию для продукта, привязанного к строке GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-218">At this point the `Categories` DropDownList lists all of the categories, but it does not yet automatically select the appropriate category for the product bound to the GridView row.</span></span> <span data-ttu-id="8f4b3-219">Для этого необходимо установить `Categories` DropDownList `SelectedValue` в значение Product s `CategoryID`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-219">To accomplish this we need to set the `Categories` DropDownList s `SelectedValue` to the product s `CategoryID` value.</span></span> <span data-ttu-id="8f4b3-220">Щелкните ссылку Edit DataBindings (Редактировать привязки данных) в смарт-теге DropDownList и свяжите свойство `SelectedValue` с полем данных `CategoryID`, как показано на рис. 12.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-220">Click on the Edit DataBindings link from the DropDownList s smart tag and associate the `SelectedValue` property with the `CategoryID` data field as shown in Figure 12.</span></span>

![Привяжите значение CategoryID продукта к свойству DropDownList SelectedValue](batch-updating-cs/_static/image12.gif)

<span data-ttu-id="8f4b3-222">**Рис. 12**. Привязка значения Product `CategoryID` к свойству `SelectedValue` DropDownList</span><span class="sxs-lookup"><span data-stu-id="8f4b3-222">**Figure 12**: Bind the Product s `CategoryID` Value to the DropDownList s `SelectedValue` Property</span></span>

<span data-ttu-id="8f4b3-223">Последняя проблема остается: Если для продукта не задано значение `CategoryID`, инструкция DataBinding в `SelectedValue` вызовет исключение.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-223">One last problem remains: if the product doesn t have a `CategoryID` value specified then the databinding statement on `SelectedValue` will result in an exception.</span></span> <span data-ttu-id="8f4b3-224">Это обусловлено тем, что DropDownList содержит только элементы для категорий и не предоставляет параметр для тех продуктов, которые имеют `NULL` значение базы данных для `CategoryID`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-224">This is because the DropDownList contains only items for the categories and does not offer an option for those products that have a `NULL` database value for `CategoryID`.</span></span> <span data-ttu-id="8f4b3-225">Чтобы устранить эту проблему, задайте для свойства DropDownList `AppendDataBoundItems` значение `true` и добавьте новый элемент в DropDownList, опустив свойство `Value` из декларативного синтаксиса.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-225">To remedy this, set the DropDownList s `AppendDataBoundItems` property to `true` and add a new item to the DropDownList, omitting the `Value` property from the declarative syntax.</span></span> <span data-ttu-id="8f4b3-226">Это значит, что декларативный синтаксис `Categories` DropDownList выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="8f4b3-226">That is, make sure that the `Categories` DropDownList s declarative syntax looks like the following:</span></span>

[!code-aspx[Main](batch-updating-cs/samples/sample3.aspx)]

<span data-ttu-id="8f4b3-227">Обратите внимание, что `<asp:ListItem Value="">`--выберите один--атрибут `Value` явно задан пустой строкой.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-227">Note how the `<asp:ListItem Value="">` -- Select One -- has its `Value` attribute explicitly set to an empty string.</span></span> <span data-ttu-id="8f4b3-228">Ознакомьтесь с руководством по [настройке интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) , чтобы получить более полное представление о том, почему этот дополнительный элемент DropDownList необходим для обработки `NULL` случае, и зачем назначение свойства `Value` пустой строке является обязательным.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-228">Refer back to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial for a more thorough discussion on why this additional DropDownList item is needed to handle the `NULL` case and why assignment of the `Value` property to an empty string is essential.</span></span>

> [!NOTE]
> <span data-ttu-id="8f4b3-229">Здесь есть потенциальная ошибка производительности и масштабируемости, которую стоит упомянуть.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-229">There is a potential performance and scalability issue here that is worth mentioning.</span></span> <span data-ttu-id="8f4b3-230">Поскольку каждая строка содержит элемент управления DropDownList, использующий `CategoriesDataSource` в качестве источника данных, метод `CategoriesBLL` класса s `GetCategories` будет называться *n* раз на страницу посещения страницы, где *n* — число строк в GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-230">Since each row has a DropDownList that uses the `CategoriesDataSource` as its data source, the `CategoriesBLL` class s `GetCategories` method will be called *n* times per page visit, where *n* is the number of rows in the GridView.</span></span> <span data-ttu-id="8f4b3-231">Эти *n* вызовов `GetCategories` приводят к появлению *n* запросов к базе данных.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-231">These *n* calls to `GetCategories` result in *n* queries to the database.</span></span> <span data-ttu-id="8f4b3-232">Это влияние на базу данных можно уменьшить путем кэширования возвращенных категорий либо в кэше запросов, либо с помощью уровня кэширования с использованием зависимости кэширования SQL или с очень коротким сроком действия на основе времени.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-232">This impact on the database could be lessened by caching the returned categories either in a per-request cache or through the Caching Layer using a SQL caching dependency or a very short time-based expiry.</span></span> <span data-ttu-id="8f4b3-233">Дополнительные сведения о параметре кэширования для каждого запроса см. в разделе [`HttpContext.Items` хранилище кэша для каждого запроса](http://aspnet.4guysfromrolla.com/articles/060904-1.aspx).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-233">For more information on the per-request caching option, see [`HttpContext.Items` a Per-Request Cache Store](http://aspnet.4guysfromrolla.com/articles/060904-1.aspx).</span></span>

## <a name="step-4-completing-the-editing-interface"></a><span data-ttu-id="8f4b3-234">Шаг 4. Завершение интерфейса редактирования</span><span class="sxs-lookup"><span data-stu-id="8f4b3-234">Step 4: Completing the Editing Interface</span></span>

<span data-ttu-id="8f4b3-235">Мы внесли ряд изменений в шаблоны GridView s без приостановки для просмотра хода выполнения.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-235">We ve made a number of changes to the GridView s templates without pausing to view our progress.</span></span> <span data-ttu-id="8f4b3-236">Уделите время для просмотра хода выполнения в браузере.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-236">Take a moment to view our progress through a browser.</span></span> <span data-ttu-id="8f4b3-237">Как показано на рис. 13, каждая строка отображается с помощью `ItemTemplate`, которая содержит интерфейс редактирования ячеек.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-237">As Figure 13 shows, each row is rendered using its `ItemTemplate`, which contains the cell s editing interface.</span></span>

<span data-ttu-id="8f4b3-238">[![, что каждая строка GridView доступна для редактирования](batch-updating-cs/_static/image13.gif)](batch-updating-cs/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-238">[![Each GridView Row is Editable](batch-updating-cs/_static/image13.gif)](batch-updating-cs/_static/image21.png)</span></span>

<span data-ttu-id="8f4b3-239">**Рис. 13**. Каждая строка GridView доступна для редактирования ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image22.png))</span><span class="sxs-lookup"><span data-stu-id="8f4b3-239">**Figure 13**: Each GridView Row is Editable ([Click to view full-size image](batch-updating-cs/_static/image22.png))</span></span>

<span data-ttu-id="8f4b3-240">На этом этапе следует соблюдать несколько проблем, связанных с форматированием.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-240">There are a few minor formatting issues that we should take care of at this point.</span></span> <span data-ttu-id="8f4b3-241">Сначала обратите внимание, что значение `UnitPrice` содержит четыре десятичных знака.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-241">First, note that the `UnitPrice` value contains four decimal points.</span></span> <span data-ttu-id="8f4b3-242">Чтобы устранить эту проблему, вернитесь к `UnitPrice` TemplateField s `ItemTemplate` и в смарт-теге TextBox щелкните ссылку изменить привязки к данным.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-242">To fix this, return to the `UnitPrice` TemplateField s `ItemTemplate` and, from the TextBox s smart tag, click on the Edit DataBindings link.</span></span> <span data-ttu-id="8f4b3-243">Затем укажите, что свойство `Text` должно быть отформатировано как число.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-243">Next, specify that the `Text` property should be formatted as a number.</span></span>

![Форматирование свойства Text как числа](batch-updating-cs/_static/image14.gif)

<span data-ttu-id="8f4b3-245">**Рис. 14**. форматирование свойства `Text` в виде числа</span><span class="sxs-lookup"><span data-stu-id="8f4b3-245">**Figure 14**: Format the `Text` Property as a Number</span></span>

<span data-ttu-id="8f4b3-246">Во-вторых, давайте разберем флажок в столбце `Discontinued` (вместо того, чтобы он был выровнен по левому краю).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-246">Second, let s center the checkbox in the `Discontinued` column (rather than having it left-aligned).</span></span> <span data-ttu-id="8f4b3-247">Щелкните Edit Columns (изменить столбцы) в смарт-теге GridView s и выберите `Discontinued` TemplateField из списка полей в левом нижнем углу.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-247">Click on Edit Columns from the GridView s smart tag and select the `Discontinued` TemplateField from the list of fields in the bottom left corner.</span></span> <span data-ttu-id="8f4b3-248">Детализируйте углублением `ItemStyle` и задайте для свойства `HorizontalAlign` значение Center, как показано на рис. 15.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-248">Drill down into `ItemStyle` and set the `HorizontalAlign` property to Center as shown in Figure 15.</span></span>

![Центрирование снятого флажка](batch-updating-cs/_static/image15.gif)

<span data-ttu-id="8f4b3-250">**Рис. 15**. центрирование флажка `Discontinued`</span><span class="sxs-lookup"><span data-stu-id="8f4b3-250">**Figure 15**: Center the `Discontinued` CheckBox</span></span>

<span data-ttu-id="8f4b3-251">Затем добавьте на страницу элемент управления ValidationSummary и задайте для его свойства `ShowMessageBox` значение `true`, а для свойства `ShowSummary` значение `false`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-251">Next, add a ValidationSummary control to the page and set its `ShowMessageBox` property to `true` and its `ShowSummary` property to `false`.</span></span> <span data-ttu-id="8f4b3-252">Также добавьте веб-элементы управления "Кнопка", которые при нажатии обновит изменения пользователя.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-252">Also add the Button Web controls that, when clicked, will update the user s changes.</span></span> <span data-ttu-id="8f4b3-253">В частности, добавьте два веб-элемента управления "Кнопка", один из которых находится над GridView, и один под ним, устанавливая оба элемента управления, `Text` свойства для обновления продуктов.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-253">Specifically, add two Button Web controls, one above the GridView and one below it, setting both controls `Text` properties to Update Products .</span></span>

<span data-ttu-id="8f4b3-254">Поскольку интерфейс редактирования GridView s определен в его полей TemplateField `ItemTemplate` s, `EditItemTemplate` s являются избыточными и могут быть удалены.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-254">Since the GridView s editing interface is defined in its TemplateFields `ItemTemplate` s, the `EditItemTemplate` s are superfluous and may be deleted.</span></span>

<span data-ttu-id="8f4b3-255">После внесения перечисленных выше изменений форматирования, добавления элементов управления "Кнопка" и удаления ненужных `EditItemTemplate` s декларативный синтаксис страниц должен выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="8f4b3-255">After making the above mentioned formatting changes, adding the Button controls, and removing the unnecessary `EditItemTemplate` s, your page s declarative syntax should look like the following:</span></span>

[!code-aspx[Main](batch-updating-cs/samples/sample4.aspx)]

<span data-ttu-id="8f4b3-256">Рис. 16 показывает эту страницу при просмотре через браузер после добавления веб-элементов управления "Кнопка" и внесения изменений форматирования.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-256">Figure 16 shows this page when viewed through a browser after the Button Web controls have been added and the formatting changes made.</span></span>

<span data-ttu-id="8f4b3-257">[![страница теперь содержит две кнопки обновления продуктов](batch-updating-cs/_static/image16.gif)](batch-updating-cs/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-257">[![The Page Now Includes Two Update Products Buttons](batch-updating-cs/_static/image16.gif)](batch-updating-cs/_static/image23.png)</span></span>

<span data-ttu-id="8f4b3-258">**Рис. 16**. Теперь страница содержит две кнопки обновления продуктов ([щелкните, чтобы просмотреть изображение с полным размером](batch-updating-cs/_static/image24.png)).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-258">**Figure 16**: The Page Now Includes Two Update Products Buttons ([Click to view full-size image](batch-updating-cs/_static/image24.png))</span></span>

## <a name="step-5-updating-the-products"></a><span data-ttu-id="8f4b3-259">Шаг 5. Обновление продуктов</span><span class="sxs-lookup"><span data-stu-id="8f4b3-259">Step 5: Updating the Products</span></span>

<span data-ttu-id="8f4b3-260">При посещении пользователем этой страницы будут внесены изменения, а затем нажата одна из двух кнопок обновления продуктов.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-260">When a user visits this page they will make their modifications and then click one of the two Update Products buttons.</span></span> <span data-ttu-id="8f4b3-261">В этот момент нам нужно каким-то образом сохранить значения, заданные пользователем для каждой строки, в `ProductsDataTable` экземпляре, а затем передать его в метод BLL, который затем передаст этот экземпляр `ProductsDataTable` в метод DAL s `UpdateWithTransaction`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-261">At that point we need to somehow save the user-entered values for each row into a `ProductsDataTable` instance and then pass that to a BLL method that will then pass that `ProductsDataTable` instance to the DAL s `UpdateWithTransaction` method.</span></span> <span data-ttu-id="8f4b3-262">Метод `UpdateWithTransaction`, созданный в [предыдущем руководстве](wrapping-database-modifications-within-a-transaction-cs.md), гарантирует, что пакет изменений будет обновлен как атомарная операция.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-262">The `UpdateWithTransaction` method, which we created in the [preceding tutorial](wrapping-database-modifications-within-a-transaction-cs.md), ensures that the batch of changes will be updated as an atomic operation.</span></span>

<span data-ttu-id="8f4b3-263">Создайте метод с именем `BatchUpdate` в `BatchUpdate.aspx.cs` и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="8f4b3-263">Create a method named `BatchUpdate` in `BatchUpdate.aspx.cs` and add the following code:</span></span>

[!code-csharp[Main](batch-updating-cs/samples/sample5.cs)]

<span data-ttu-id="8f4b3-264">Этот метод начинается путем возвращения всех продуктов в `ProductsDataTable` с помощью вызова метода `GetProducts` BLL.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-264">This method starts out by getting all of the products back in a `ProductsDataTable` via a call to the BLL s `GetProducts` method.</span></span> <span data-ttu-id="8f4b3-265">Затем выполняется перечисление коллекции `ProductGrid` GridView s [`Rows`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rows(VS.80).aspx).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-265">It then enumerates the `ProductGrid` GridView s [`Rows` collection](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rows(VS.80).aspx).</span></span> <span data-ttu-id="8f4b3-266">Коллекция `Rows` содержит [экземпляр`GridViewRow`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewrow.aspx) для каждой строки, отображаемой в GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-266">The `Rows` collection contains a [`GridViewRow` instance](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewrow.aspx) for each row displayed in the GridView.</span></span> <span data-ttu-id="8f4b3-267">Так как мы видим не более десяти строк на странице, `Rows` коллекция GridView s будет содержать не более десяти элементов.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-267">Since we are showing at most ten rows per page, the GridView s `Rows` collection will have no more than ten items.</span></span>

<span data-ttu-id="8f4b3-268">Для каждой строки, `ProductID` извлеченной из коллекции `DataKeys` и выбрана соответствующая `ProductsRow` из `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-268">For each row the `ProductID` is grabbed from the `DataKeys` collection and the appropriate `ProductsRow` is selected from the `ProductsDataTable`.</span></span> <span data-ttu-id="8f4b3-269">На четыре элемента управления вводом TemplateField программными ссылками, а также их значения, назначенные свойствам экземпляра `ProductsRow`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-269">The four TemplateField input controls are programmatically referenced and their values assigned to the `ProductsRow` instance s properties.</span></span> <span data-ttu-id="8f4b3-270">После того, как для обновления `ProductsDataTable`используются все значения строк GridView, они передавались методу `UpdateWithTransaction` BLL, который, как мы видели в предыдущем руководстве, просто вызывает метод DAL s `UpdateWithTransaction`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-270">After each GridView row s values have been used to update the `ProductsDataTable`, it s passed to the BLL s `UpdateWithTransaction` method which, as we saw in the preceding tutorial, simply calls down into the DAL s `UpdateWithTransaction` method.</span></span>

<span data-ttu-id="8f4b3-271">Алгоритм пакетного обновления, используемый в этом руководстве, обновляет каждую строку в `ProductsDataTable`, соответствующую строке в GridView, независимо от того, изменились ли сведения о продукте.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-271">The batch update algorithm used for this tutorial updates each row in the `ProductsDataTable` that corresponds to a row in the GridView, regardless of whether the product s information has been changed.</span></span> <span data-ttu-id="8f4b3-272">Хотя подобные обновления, как правило, не являются проблемой с производительностью, они могут привести к излишним записям при повторном аудите изменений в таблице базы данных.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-272">While such blind updates aren't usually a performance issue, they can lead to superfluous records if you re auditing changes to the database table.</span></span> <span data-ttu-id="8f4b3-273">В учебнике [выполнение пакетных обновлений](../editing-and-deleting-data-through-the-datalist/performing-batch-updates-cs.md) мы изучили интерфейс обновления пакетной службы с помощью DataList и добавили код, который будет обновлять только те записи, которые фактически были изменены пользователем.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-273">Back in the [Performing Batch Updates](../editing-and-deleting-data-through-the-datalist/performing-batch-updates-cs.md) tutorial we explored a batch updating interface with the DataList and added code that would only update those records that were actually modified by the user.</span></span> <span data-ttu-id="8f4b3-274">При необходимости вы можете использовать методы [выполнения пакетных обновлений](../editing-and-deleting-data-through-the-datalist/performing-batch-updates-cs.md) для обновления кода в этом руководстве.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-274">Feel free to use the techniques from [Performing Batch Updates](../editing-and-deleting-data-through-the-datalist/performing-batch-updates-cs.md) to update the code in this tutorial, if desired.</span></span>

> [!NOTE]
> <span data-ttu-id="8f4b3-275">При привязке источника данных к GridView через его смарт-тег Visual Studio автоматически назначает значения первичного ключа (-ов) источника данных для свойства `DataKeyNames` GridView s.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-275">When binding the data source to the GridView through its smart tag, Visual Studio automatically assigns the data source s primary key value(s) to the GridView s `DataKeyNames` property.</span></span> <span data-ttu-id="8f4b3-276">Если вы не привязали ObjectDataSource к GridView с помощью смарт-тега GridView s, как описано в шаге 1, необходимо вручную задать для свойства `DataKeyNames` GridView s значение ProductID, чтобы получить доступ к `ProductID`ному значению для каждой строки через коллекцию `DataKeys`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-276">If you did not bind the ObjectDataSource to the GridView through the GridView s smart tag as outlined in Step 1, then you will need to manually set the GridView s `DataKeyNames` property to ProductID in order to access the `ProductID` value for each row through the `DataKeys` collection.</span></span>

<span data-ttu-id="8f4b3-277">Код, используемый в `BatchUpdate`, аналогичен тому, который использовался в методах `UpdateProduct` BLL, основное различие заключается в том, что в методах `UpdateProduct` извлекается только один экземпляр `ProductRow` из архитектуры.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-277">The code used in `BatchUpdate` is similar to that used in the BLL s `UpdateProduct` methods, the main difference being that in the `UpdateProduct` methods only a single `ProductRow` instance is retrieved from the architecture.</span></span> <span data-ttu-id="8f4b3-278">Код, который назначает свойства `ProductRow`, одинаков между методами `UpdateProducts` и кодом в цикле `foreach` в `BatchUpdate`, как и общий шаблон.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-278">The code that assigns the properties of the `ProductRow` is the same between the `UpdateProducts` methods and the code within the `foreach` loop in `BatchUpdate`, as is the overall pattern.</span></span>

<span data-ttu-id="8f4b3-279">Для работы с этим руководством необходимо, чтобы метод `BatchUpdate` вызывался при нажатии любой из кнопок обновить продукты.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-279">To complete this tutorial, we need to have the `BatchUpdate` method invoked when either of the Update Products buttons is clicked.</span></span> <span data-ttu-id="8f4b3-280">Создайте обработчики событий для `Click` событий этих двух элементов управления "Кнопка" и добавьте следующий код в обработчики событий:</span><span class="sxs-lookup"><span data-stu-id="8f4b3-280">Create event handlers for the `Click` events of these two Button controls and add the following code in the event handlers:</span></span>

[!code-csharp[Main](batch-updating-cs/samples/sample6.cs)]

<span data-ttu-id="8f4b3-281">Сначала выполняется вызов `BatchUpdate`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-281">First a call is made to `BatchUpdate`.</span></span> <span data-ttu-id="8f4b3-282">Далее `ClientScript property` используется для вставки JavaScript, который будет отображать MessageBox, считывающие продукты, которые были обновлены.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-282">Next, the `ClientScript property` is used to inject JavaScript that will display a messagebox that reads The products have been updated.</span></span>

<span data-ttu-id="8f4b3-283">Протестируйте этот код, уделите минуту.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-283">Take a minute to test out this code.</span></span> <span data-ttu-id="8f4b3-284">Откройте `BatchUpdate.aspx` через браузер, измените несколько строк и нажмите одну из кнопок обновить продукты.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-284">Visit `BatchUpdate.aspx` through a browser, edit a number of rows, and click one of the Update Products buttons.</span></span> <span data-ttu-id="8f4b3-285">Если нет ошибок проверки ввода, вы увидите MessageBox, считывающий продукты, которые были обновлены.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-285">Assuming there are no input validation errors, you should see a messagebox that reads The products have been updated.</span></span> <span data-ttu-id="8f4b3-286">Чтобы проверить атомарность обновления, рассмотрите возможность добавления случайного ограничения `CHECK`, например, которое запрещает `UnitPrice` значения 1234,56.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-286">To verify the atomicity of the update, consider adding a random `CHECK` constraint, like one that disallows `UnitPrice` values of 1234.56.</span></span> <span data-ttu-id="8f4b3-287">Затем из `BatchUpdate.aspx`измените несколько записей, установив для одного из них `UnitPrice` значение запрещено (1234,56).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-287">Then from `BatchUpdate.aspx`, edit a number of records, making sure to set one of the product s `UnitPrice` value to the forbidden value ( 1234.56 ).</span></span> <span data-ttu-id="8f4b3-288">Это должно привести к ошибке при нажатии кнопки обновить продукты с другими изменениями во время отката пакетной операции к исходным значениям.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-288">This should result in an error when clicking Update Products with the other changes during that batch operation rolled back to their original values.</span></span>

## <a name="an-alternativebatchupdatemethod"></a><span data-ttu-id="8f4b3-289">Альтернативный метод`BatchUpdate`</span><span class="sxs-lookup"><span data-stu-id="8f4b3-289">An Alternative`BatchUpdate`Method</span></span>

<span data-ttu-id="8f4b3-290">Метод `BatchUpdate`, который мы только что проверили, извлекает *все* продукты из метода `GetProducts` BLL, а затем обновляет только те записи, которые отображаются в GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-290">The `BatchUpdate` method we just examined retrieves *all* of the products from the BLL s `GetProducts` method and then updates just those records that appear in the GridView.</span></span> <span data-ttu-id="8f4b3-291">Этот подход идеально подходит, если GridView не использует разбиение на страницы, но если это так, то могут быть сотни, тысячи или десятки тысяч продуктов, но только десять строк в GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-291">This approach is ideal if the GridView does not use paging, but if it does, there may be hundreds, thousands, or tens of thousands of products, but only ten rows in the GridView.</span></span> <span data-ttu-id="8f4b3-292">В этом случае получение всех продуктов из базы данных только для изменения 10 из них является менее идеальным вариантом.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-292">In such a case, getting all of the products from the database only to modify 10 of them is less than ideal.</span></span>

<span data-ttu-id="8f4b3-293">Для этих типов ситуаций рассмотрите возможность использования следующего `BatchUpdateAlternate` метода:</span><span class="sxs-lookup"><span data-stu-id="8f4b3-293">For those types of situations, consider using the following `BatchUpdateAlternate` method instead:</span></span>

[!code-csharp[Main](batch-updating-cs/samples/sample7.cs)]

<span data-ttu-id="8f4b3-294">`BatchMethodAlternate` начинается с создания нового пустого `ProductsDataTable` с именем `products`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-294">`BatchMethodAlternate` starts by creating a new empty `ProductsDataTable` named `products`.</span></span> <span data-ttu-id="8f4b3-295">Затем в коллекции GridView s `Rows` и для каждой строки получается информация о продукте с помощью метода `GetProductByProductID(productID)` BLL.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-295">It then steps through the GridView s `Rows` collection and for each row gets the particular product information using the BLL s `GetProductByProductID(productID)` method.</span></span> <span data-ttu-id="8f4b3-296">Свойства полученного экземпляра `ProductsRow` обновляются так же, как `BatchUpdate`, но после обновления строки она импортируется в `products``ProductsDataTable` через метод DataTable s [`ImportRow(DataRow)`](https://msdn.microsoft.com/library/system.data.datatable.importrow(VS.80).aspx).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-296">The retrieved `ProductsRow` instance has its properties updated in the same fashion as `BatchUpdate`, but after updating the row it is imported into the `products``ProductsDataTable` via the DataTable s [`ImportRow(DataRow)` method](https://msdn.microsoft.com/library/system.data.datatable.importrow(VS.80).aspx).</span></span>

<span data-ttu-id="8f4b3-297">После завершения цикла `foreach` `products` содержит один экземпляр `ProductsRow` для каждой строки в GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-297">After the `foreach` loop completes, `products` contains one `ProductsRow` instance for each row in the GridView.</span></span> <span data-ttu-id="8f4b3-298">Так как каждый из `ProductsRow`ных экземпляров был добавлен в `products` (вместо обновления), если они передаются в метод `UpdateWithTransaction`, `ProductsTableAdapter` попытается вставить каждую из записей в базу данных.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-298">Since each of the `ProductsRow` instances have been added to the `products` (instead of updated), if we blindly pass it to the `UpdateWithTransaction` method the `ProductsTableAdapter` will try to insert each of the records into the database.</span></span> <span data-ttu-id="8f4b3-299">Вместо этого необходимо указать, что каждая из этих строк была изменена (не добавлена).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-299">Instead, we need to specify that each of these rows has been modified (not added).</span></span>

<span data-ttu-id="8f4b3-300">Это можно сделать, добавив новый метод в BLL с именем `UpdateProductsWithTransaction`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-300">This can be accomplished by adding a new method to the BLL named `UpdateProductsWithTransaction`.</span></span> <span data-ttu-id="8f4b3-301">`UpdateProductsWithTransaction`, показанный ниже, устанавливает `RowState` для каждого экземпляра `ProductsRow` в `ProductsDataTable` в `Modified`, а затем передает `ProductsDataTable` методу DAL s `UpdateWithTransaction`.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-301">`UpdateProductsWithTransaction`, shown below, sets the `RowState` of each of the `ProductsRow` instances in the `ProductsDataTable` to `Modified` and then passes the `ProductsDataTable` to the DAL s `UpdateWithTransaction` method.</span></span>

[!code-csharp[Main](batch-updating-cs/samples/sample8.cs)]

## <a name="summary"></a><span data-ttu-id="8f4b3-302">Сводка</span><span class="sxs-lookup"><span data-stu-id="8f4b3-302">Summary</span></span>

<span data-ttu-id="8f4b3-303">GridView предоставляет встроенные возможности редактирования для отдельных строк, но не поддерживает создание полностью изменяемых интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-303">The GridView provides built-in per-row editing capabilities, but lacks support for creating fully editable interfaces.</span></span> <span data-ttu-id="8f4b3-304">Как мы видели в этом руководстве, такие интерфейсы возможны, но для них требуется немного работы.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-304">As we saw in this tutorial, such interfaces are possible, but require a bit of work.</span></span> <span data-ttu-id="8f4b3-305">Чтобы создать элемент управления GridView, в котором каждая строка является редактируемой, необходимо преобразовать поля GridView s в полей TemplateField и определить интерфейс редактирования в `ItemTemplate` s.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-305">To create a GridView where every row is editable, we need to convert the GridView s fields into TemplateFields and define the editing interface within the `ItemTemplate` s.</span></span> <span data-ttu-id="8f4b3-306">Кроме того, на страницу должны быть добавлены веб-элементы управления для обновления всех типов, отделенные от GridView.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-306">Additionally, Update All -type Button Web controls must be added to the page, separate from the GridView.</span></span> <span data-ttu-id="8f4b3-307">Эти кнопки `Click` обработчикам событий необходимо перечислить коллекцию `Rows` GridView, сохранить изменения в `ProductsDataTable`и передать обновленные сведения в соответствующий метод BLL.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-307">These Buttons `Click` event handlers need to enumerate the GridView s `Rows` collection, store the changes in a `ProductsDataTable`, and pass the updated information into the appropriate BLL method.</span></span>

<span data-ttu-id="8f4b3-308">В следующем учебном курсе будет показано, как создать интерфейс для пакетного удаления.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-308">In the next tutorial we'll see how to create an interface for batch deleting.</span></span> <span data-ttu-id="8f4b3-309">В частности, каждая строка GridView будет включать в себя флажок, а вместо кнопки Обновить все-типы будут выбраны кнопки Удалить выбранные строки.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-309">In particular, each GridView row will include a checkbox and instead of Update All -type buttons, we'll have Delete Selected Rows buttons.</span></span>

<span data-ttu-id="8f4b3-310">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="8f4b3-310">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="8f4b3-311">Об авторе</span><span class="sxs-lookup"><span data-stu-id="8f4b3-311">About the Author</span></span>

<span data-ttu-id="8f4b3-312">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-312">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="8f4b3-313">Скотт работает как независимый консультант, преподаватель и модуль записи.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-313">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="8f4b3-314">Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-314">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="8f4b3-315">Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-315">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="8f4b3-316">или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="8f4b3-316">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="8f4b3-317">Специальная благодарность</span><span class="sxs-lookup"><span data-stu-id="8f4b3-317">Special Thanks To</span></span>

<span data-ttu-id="8f4b3-318">Эта серия руководств была рассмотрена многими полезными рецензентами.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-318">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="8f4b3-319">Потенциальные рецензенты для этого учебника были Терезой Мерфи и Дэвид суру.</span><span class="sxs-lookup"><span data-stu-id="8f4b3-319">Lead reviewers for this tutorial were Teresa Murphy and David Suru.</span></span> <span data-ttu-id="8f4b3-320">Хотите ознакомиться с моими будущими статьями MSDN?</span><span class="sxs-lookup"><span data-stu-id="8f4b3-320">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="8f4b3-321">Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-321">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="8f4b3-322">[Назад](wrapping-database-modifications-within-a-transaction-cs.md)
> [Вперед](batch-deleting-cs.md)</span><span class="sxs-lookup"><span data-stu-id="8f4b3-322">[Previous](wrapping-database-modifications-within-a-transaction-cs.md)
[Next](batch-deleting-cs.md)</span></span>
