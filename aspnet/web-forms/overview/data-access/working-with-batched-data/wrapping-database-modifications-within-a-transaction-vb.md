---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
title: Перенос изменений базы данных в транзакции (Visual Basic) | Документация Майкрософт
author: rick-anderson
description: Это руководство представляет собой первый из четырех, ищущий обновление, удаление и вставка пакеты данных. В этом учебнике рассказано, как разрешить транзакций базы данных...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: 7d821db5-6cbb-4b38-af14-198f9155fc82
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
msc.type: authoredcontent
ms.openlocfilehash: 2fc7ba3d62d41685c234756709707ff14f81b316
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59380318"
---
# <a name="wrapping-database-modifications-within-a-transaction-vb"></a><span data-ttu-id="a60b4-104">Перенос изменений базы данных в транзакции (VB)</span><span class="sxs-lookup"><span data-stu-id="a60b4-104">Wrapping Database Modifications within a Transaction (VB)</span></span>

<span data-ttu-id="a60b4-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="a60b4-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="a60b4-106">[Скачать код](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) или [скачать PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="a60b4-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span></span>

> <span data-ttu-id="a60b4-107">Это руководство представляет собой первый из четырех, ищущий обновление, удаление и вставка пакеты данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="a60b4-108">В этом руководстве мы Узнайте, как транзакции базы данных позволяют вносить изменения пакета должно быть выполнено как атомарную операцию, которая гарантирует, что все действия завершится успехом или ошибкой все шаги.</span><span class="sxs-lookup"><span data-stu-id="a60b4-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="a60b4-109">Вступление</span><span class="sxs-lookup"><span data-stu-id="a60b4-109">Introduction</span></span>

<span data-ttu-id="a60b4-110">Как мы видели, начиная с [Обзор Вставка, обновление и удаление данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) руководстве GridView предоставляет встроенную поддержку редактирования на уровне строк и удаления.</span><span class="sxs-lookup"><span data-stu-id="a60b4-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="a60b4-111">Несколькими щелчками мыши можно создать интерфейс изменения форматированных данных без написания кода, до тех пор, пока вы являетесь содержимого редактирования и удаления на основе строки.</span><span class="sxs-lookup"><span data-stu-id="a60b4-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="a60b4-112">Однако в некоторых случаях этого недостаточно, и нам нужно предоставить пользователям возможность изменить или удалить пакет записей.</span><span class="sxs-lookup"><span data-stu-id="a60b4-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="a60b4-113">К примеру наиболее веб-клиенты электронной почты использование сетки списка каждое сообщение, где каждая строка включает флажок наряду с информацией по электронной почте s (тема, отправитель и так далее).</span><span class="sxs-lookup"><span data-stu-id="a60b4-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="a60b4-114">Этот интерфейс позволяет пользователю удалить несколько сообщений, установите их и нажмите кнопку Удалить выбранные сообщения.</span><span class="sxs-lookup"><span data-stu-id="a60b4-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="a60b4-115">Интерфейс для редактирования пакета идеально подходит в ситуациях, где пользователи часто изменять множество различных записей.</span><span class="sxs-lookup"><span data-stu-id="a60b4-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="a60b4-116">Вместо того чтобы, что вынуждает пользователя нажмите кнопку Изменить, внести свои изменения и затем нажмите кнопку "Обновить" для каждой записи, которое должно быть изменено, пакетной службы, интерфейс редактирования отображает каждой строки с его интерфейс редактирования.</span><span class="sxs-lookup"><span data-stu-id="a60b4-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="a60b4-117">Пользователь может быстро изменять набор строк, которые должны быть изменены и затем сохранить эти изменения, нажав кнопку все обновления.</span><span class="sxs-lookup"><span data-stu-id="a60b4-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="a60b4-118">В этой серии руководств мы рассмотрим, как создавать интерфейсы для вставки, редактирования и удаления пакетов данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="a60b4-119">При выполнении пакетных операций оно важно определить, является ли возможно для некоторых операций в пакете для успешного выполнения, а другие ошибкой.</span><span class="sxs-lookup"><span data-stu-id="a60b4-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="a60b4-120">Рассмотрите возможность удаления интерфейс — что должно происходить, если первый выбранной записи успешно удален, но вторая завершился неудачно, скажем, из-за нарушения ограничения внешнего ключа пакета?</span><span class="sxs-lookup"><span data-stu-id="a60b4-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="a60b4-121">Сначала удалить запись s откатить или приемлемо для первой записи остаются удаленные?</span><span class="sxs-lookup"><span data-stu-id="a60b4-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="a60b4-122">Если вы не хотите пакетной службы будет считаться [атомарной операции](http://en.wikipedia.org/wiki/Atomic_operation), один где либо все действия успешно или сбоем все действия, а затем уровень доступа к данным необходимо дополнить для поддержки [базы данных транзакции](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="a60b4-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="a60b4-123">Транзакции базы данных гарантирует атомарность для набора `INSERT`, `UPDATE`, и `DELETE` — это компонент, поддерживаемый все большинство современных баз данных и выполняются в рамках транзакции инструкции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="a60b4-124">В этом руководстве мы рассмотрим способы расширения DAL для использования транзакций базы данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="a60b4-125">Последующих руководствах рассмотрим реализацию веб-страниц для пакетной вставки, обновления и удаления интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="a60b4-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="a60b4-126">Позвольте s приступить к работе!</span><span class="sxs-lookup"><span data-stu-id="a60b4-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="a60b4-127">При изменении данных в пакетной транзакции, атомарность требуется не всегда.</span><span class="sxs-lookup"><span data-stu-id="a60b4-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="a60b4-128">В некоторых сценариях может быть допускается использование некоторых изменений данных успешно и другими пользователями в одном пакете ошибкой, например, когда удаление набора данных по электронной почте из клиента веб-службы электронной почты.</span><span class="sxs-lookup"><span data-stu-id="a60b4-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="a60b4-129">Если есть s обработать базу данных ошибок во время выполнения удаления, ее вероятно приемлемым, что эти записи, обрабатываются без ошибок остаются удаленные s.</span><span class="sxs-lookup"><span data-stu-id="a60b4-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="a60b4-130">В таком случае DAL не нужно изменять для поддержки транзакций базы данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="a60b4-131">Существуют другие пакетной операции ситуации, тем не менее, где важна атомарность.</span><span class="sxs-lookup"><span data-stu-id="a60b4-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="a60b4-132">Если клиент перемещается ее средств с одного банковского счета на другой, необходимо выполнить две операции: должно быть вычтено из первой учетной записи и затем добавляется второй денежные средства.</span><span class="sxs-lookup"><span data-stu-id="a60b4-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="a60b4-133">Банк может не волнует, что первым шагом успешного выполнения, но второй шаг не удастся, его пользователи терпимо будут обеспокоен.</span><span class="sxs-lookup"><span data-stu-id="a60b4-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="a60b4-134">Я советую вам для работы с этим руководством и реализовать усовершенствования в слой DAL для поддержки транзакций базы данных, даже если вы не планируете использовать их в пакетной вставки, обновления и удаления интерфейсы, которые мы будем строить в трех следующих руководствах.</span><span class="sxs-lookup"><span data-stu-id="a60b4-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="a60b4-135">Общие сведения о транзакции</span><span class="sxs-lookup"><span data-stu-id="a60b4-135">An Overview of Transactions</span></span>

<span data-ttu-id="a60b4-136">В большинстве баз данных включают поддержку *транзакции*, которые поддерживают несколько команд базе данных быть сгруппированы в одной логической единице работы.</span><span class="sxs-lookup"><span data-stu-id="a60b4-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="a60b4-137">Команды базы данных, которые составляют транзакцию гарантированно атомарным, это означает, что все команды завершится ошибкой или все будет выполнена успешно.</span><span class="sxs-lookup"><span data-stu-id="a60b4-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="a60b4-138">В общем случае транзакции реализуются с помощью инструкций SQL, используя следующий шаблон:</span><span class="sxs-lookup"><span data-stu-id="a60b4-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="a60b4-139">Указывают на начало транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="a60b4-140">Выполнение инструкций SQL, которые составляют транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a60b4-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="a60b4-141">Если возникает ошибка в одной из инструкций из шага 2, производится откат транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="a60b4-142">Если все инструкции из шага 2 завершается без ошибок, зафиксируйте транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a60b4-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="a60b4-143">Инструкции SQL, используемый для создания, фиксации и откат транзакции можно ввести вручную при написания скриптов SQL или создании хранимых процедур или через программный означает использование ADO.NET или классы в [ `System.Transactions` пространство имен](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="a60b4-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="a60b4-144">В этом учебном курсе мы рассмотрим только управление транзакциями, с помощью ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="a60b4-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="a60b4-145">В следующем учебном курсе мы рассмотрим способы использования хранимых процедур в слое доступа к данным, после чего мы изучим инструкции SQL для создания, откат и Фиксация транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="a60b4-146">В то же время, обратитесь к [управление транзакциями в хранимые процедуры SQL Server](http://www.4guysfromrolla.com/webtech/080305-1.shtml) Дополнительные сведения.</span><span class="sxs-lookup"><span data-stu-id="a60b4-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="a60b4-147">[ `TransactionScope` Класс](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) в `System.Transactions` пространства имен позволяет разработчикам программным способом программы-оболочки для ряд инструкций в пределах транзакции и включает в себя поддержку сложных операций с участием нескольких источников, таких как две разные базы данных или даже разнородных типов хранилищ данных, таких как базы данных Microsoft SQL Server, базы данных Oracle и веб-службы.</span><span class="sxs-lookup"><span data-stu-id="a60b4-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="a60b4-148">Я решил использовать транзакции ADO.NET в этом руководстве, а не хранить `TransactionScope` класс, поскольку ADO.NET определено точнее, для транзакций базы данных и во многих случаях являются гораздо меньше много ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a60b4-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="a60b4-149">Кроме того, в некоторых обстоятельствах `TransactionScope` класс использует координатор распределенных транзакций Microsoft (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="a60b4-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="a60b4-150">Проблемы конфигурации, реализации и производительности окружающей MSDTC упрощает довольно специализированные и дополнительные темы и выходит за рамки этих учебников.</span><span class="sxs-lookup"><span data-stu-id="a60b4-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="a60b4-151">При работе с поставщиком SqlClient в ADO.NET, транзакции инициируются путем вызова [ `SqlConnection` класс](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [ `BeginTransaction` метод](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), который возвращает [ `SqlTransaction` объекта](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="a60b4-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="a60b4-152">Инструкции изменения данных, в состав транзакции, помещаются в `try...catch` блока.</span><span class="sxs-lookup"><span data-stu-id="a60b4-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="a60b4-153">Если произошла ошибка в операторе в `try` block, выполнение передается `catch` блока, где можно выполнить откат транзакции с помощью `SqlTransaction` объект s [ `Rollback` метод](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="a60b4-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="a60b4-154">Если все операторы завершился успешно, вызов `SqlTransaction` объект s [ `Commit` метод](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) в конце `try` блок фиксирует транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a60b4-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="a60b4-155">В следующем фрагменте кода показана схема работы.</span><span class="sxs-lookup"><span data-stu-id="a60b4-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="a60b4-156">См. в разделе [поддержание согласованности базы данных с транзакциями](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) дополнительный синтаксис и примеры использования транзакций с помощью ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="a60b4-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample1.vb)]

<span data-ttu-id="a60b4-157">По умолчанию в типизированный набор DataSet TableAdapters не использовать транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="a60b4-158">Чтобы обеспечить поддержку транзакций, нам нужно дополнить классов TableAdapter для включения дополнительных методов, использующих выше шаблон для выполнения ряда инструкций изменения данных в области транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="a60b4-159">На шаге 2 будет показано, как использовать разделяемые классы для добавления этих методов.</span><span class="sxs-lookup"><span data-stu-id="a60b4-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="a60b4-160">Шаг 1. Создание рабочего с пакетными данными веб-страниц</span><span class="sxs-lookup"><span data-stu-id="a60b4-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="a60b4-161">Прежде чем приступать, показывающих, как дополнить DAL для поддержки транзакций базы данных, позволяют s уделим несколько минут для создания веб-страниц ASP.NET, которые понадобятся в этом руководстве, а также три приведенные далее.</span><span class="sxs-lookup"><span data-stu-id="a60b4-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="a60b4-162">Начните с добавления новой папки с именем `BatchData` и добавьте следующие страницы ASP.NET, сопоставление каждой страницы с `Site.master` главной страницы.</span><span class="sxs-lookup"><span data-stu-id="a60b4-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![Добавление страниц ASP.NET для элемента управления SqlDataSource руководств](wrapping-database-modifications-within-a-transaction-vb/_static/image1.gif)

<span data-ttu-id="a60b4-164">**Рис. 1**: Добавление страниц ASP.NET для элемента управления SqlDataSource руководств</span><span class="sxs-lookup"><span data-stu-id="a60b4-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="a60b4-165">Как и в других папках, `Default.aspx` будет использовать `SectionLevelTutorialListing.ascx` пользовательский элемент управления, чтобы получить список учебников в своем разделе.</span><span class="sxs-lookup"><span data-stu-id="a60b4-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="a60b4-166">Поэтому добавьте данный пользовательский элемент управления для `Default.aspx` , перетащив его из обозревателя решений на странице s режиме конструктора.</span><span class="sxs-lookup"><span data-stu-id="a60b4-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="a60b4-167">[![Добавление элемента управления Sectionleveltutoriallisting.ascx к странице Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="a60b4-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span></span>

<span data-ttu-id="a60b4-168">**Рис. 2**: Добавить `SectionLevelTutorialListing.ascx` для пользовательского элемента управления `Default.aspx` ([Просмотр полноразмерного изображения](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="a60b4-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span></span>


<span data-ttu-id="a60b4-169">Наконец, добавьте эти четыре страницы как записи для `Web.sitemap` файла.</span><span class="sxs-lookup"><span data-stu-id="a60b4-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="a60b4-170">В частности, добавьте следующую разметку после Настройка карты узла `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="a60b4-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample2.xml)]

<span data-ttu-id="a60b4-171">После обновления `Web.sitemap`, Отвлекитесь и просмотрите учебный веб-узел в обозревателе.</span><span class="sxs-lookup"><span data-stu-id="a60b4-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="a60b4-172">В меню слева теперь есть элементы по работе с пакетными данными учебниками.</span><span class="sxs-lookup"><span data-stu-id="a60b4-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![Карта узла теперь включают записи для работы с учебниками пакетными данными](wrapping-database-modifications-within-a-transaction-vb/_static/image3.gif)

<span data-ttu-id="a60b4-174">**Рис. 3**: Карта узла теперь включают записи для работы с учебниками пакетными данными</span><span class="sxs-lookup"><span data-stu-id="a60b4-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="a60b4-175">Шаг 2. Обновление уровня доступа к данным для поддержки транзакций базы данных</span><span class="sxs-lookup"><span data-stu-id="a60b4-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="a60b4-176">Как уже говорилось в первом учебнике [создание уровня доступа к данным](../introduction/creating-a-data-access-layer-vb.md), представляет собой DataTables и адаптеров таблиц TableAdapter типизированного набора DataSet в DAL.</span><span class="sxs-lookup"><span data-stu-id="a60b4-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="a60b4-177">DataTables хранят данные в то время как адаптеры таблиц обеспечивают функциональные возможности для считывания данных из базы данных в DataTables, обновить базу данных с помощью изменения, внесенные в таблицы данных и т. д.</span><span class="sxs-lookup"><span data-stu-id="a60b4-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="a60b4-178">Помните, что TableAdapters предоставляет два шаблона для обновления данных, которую я называют пакетного обновления и непосредственные методы DB.</span><span class="sxs-lookup"><span data-stu-id="a60b4-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="a60b4-179">С помощью шаблона пакетного обновления TableAdapter передается DataSet, DataTable или коллекции из DataRow.</span><span class="sxs-lookup"><span data-stu-id="a60b4-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="a60b4-180">Эти данные перечисляется и для каждой вставки, изменения или удаленной строки, `InsertCommand`, `UpdateCommand`, или `DeleteCommand` выполняется.</span><span class="sxs-lookup"><span data-stu-id="a60b4-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="a60b4-181">С помощью непосредственного шаблона DB TableAdapter вместо этого передается значения столбцов, необходимые для вставки, обновления или удаления одной записи.</span><span class="sxs-lookup"><span data-stu-id="a60b4-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="a60b4-182">DB прямой метод шаблона затем использует эти значения, переданный для выполнения соответствующего `InsertCommand`, `UpdateCommand`, или `DeleteCommand` инструкции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="a60b4-183">Независимо от того, шаблон обновления, используемый создаваемые автоматически методы TableAdapters не использовать транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="a60b4-184">По умолчанию каждой инструкции insert, update или delete, выполненных TableAdapter рассматривается как дискретные одной операции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="a60b4-185">Например представьте, что непосредственного шаблона DB используется некоторый код в BLL для вставки десяти записей в базе данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="a60b4-186">Этот код вызовет TableAdapter s `Insert` метод десять раз.</span><span class="sxs-lookup"><span data-stu-id="a60b4-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="a60b4-187">Если выполнена первые пять операций вставки, но шестого вызывающий исключение, первые пять вставленной записи останется в базе данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="a60b4-188">Аналогичным образом, если шаблон пакетного обновления используется для выполнения операций вставки, обновления и удаления для вставленных, изменения и удаленные строки в объект DataTable, если первый некоторых изменений выполнено успешно, но поздней произошла ошибка, эти более ранние изменения, завершена, будет оставаться в базе данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="a60b4-189">В некоторых сценариях мы стремимся обеспечить атомарность через последовательность изменений.</span><span class="sxs-lookup"><span data-stu-id="a60b4-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="a60b4-190">Для этого мы вручную расширить TableAdapter, добавив новые методы, которые выполняются `InsertCommand`, `UpdateCommand`, и `DeleteCommand` s в рамках транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="a60b4-191">В [создание уровня доступа к данным](../introduction/creating-a-data-access-layer-vb.md) рассматривалось использование [разделяемые классы](http://en.wikipedia.org/wiki/Partial_type) для расширения функциональных возможностей DataTables в типизированный набор DataSet.</span><span class="sxs-lookup"><span data-stu-id="a60b4-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="a60b4-192">Этот метод можно также с помощью адаптеров таблиц TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="a60b4-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="a60b4-193">Типизированный набор DataSet `Northwind.xsd` находится в `App_Code` папка s `DAL` во вложенную папку.</span><span class="sxs-lookup"><span data-stu-id="a60b4-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="a60b4-194">Создайте вложенную папку в `DAL` папку с именем `TransactionSupport` и добавьте новый файл класса с именем `ProductsTableAdapter.TransactionSupport.vb` (см. рис. 4).</span><span class="sxs-lookup"><span data-stu-id="a60b4-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.vb` (see Figure 4).</span></span> <span data-ttu-id="a60b4-195">Этот файл будет содержать частичная реализация `ProductsTableAdapter` , включает методы для выполнения изменений данных, используя транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a60b4-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![Добавьте папку с именем TransactionSupport и файл класса с именем ProductsTableAdapter.TransactionSupport.vb](wrapping-database-modifications-within-a-transaction-vb/_static/image4.gif)

<span data-ttu-id="a60b4-197">**Рис. 4**: Добавьте папку с именем `TransactionSupport` и файл класса с именем `ProductsTableAdapter.TransactionSupport.vb`</span><span class="sxs-lookup"><span data-stu-id="a60b4-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.vb`</span></span>


<span data-ttu-id="a60b4-198">Введите следующий код в `ProductsTableAdapter.TransactionSupport.vb` файла:</span><span class="sxs-lookup"><span data-stu-id="a60b4-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.vb` file:</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample3.vb)]

<span data-ttu-id="a60b4-199">`Partial` Ключевое слово в объявлении класса указывает компилятору, что элементы, добавленные в пределах, должны быть добавлены в `ProductsTableAdapter` в класс `NorthwindTableAdapters` пространства имен.</span><span class="sxs-lookup"><span data-stu-id="a60b4-199">The `Partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="a60b4-200">Примечание `Imports System.Data.SqlClient` инструкция в верхней части файла.</span><span class="sxs-lookup"><span data-stu-id="a60b4-200">Note the `Imports System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="a60b4-201">Поскольку TableAdapter был настроен на использование поставщика SqlClient, внутренне он использует [ `SqlDataAdapter` ](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) объекта для выдачи команд в базе данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="a60b4-202">Следовательно, нам нужно использовать `SqlTransaction` класс на начало транзакции, а затем зафиксировать его или ее отката.</span><span class="sxs-lookup"><span data-stu-id="a60b4-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="a60b4-203">Если вы используете хранилище данных, отличных от Microsoft SQL Server, необходимо использовать соответствующий поставщик.</span><span class="sxs-lookup"><span data-stu-id="a60b4-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="a60b4-204">Эти методы предоставляют стандартные блоки, необходимые для запуска, отката и фиксации транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="a60b4-205">Они помечены `Public`, позволяя использовать изнутри `ProductsTableAdapter`от другого класса в DAL и из другой уровень в архитектуре, такие как слой бизнес-ЛОГИКИ.</span><span class="sxs-lookup"><span data-stu-id="a60b4-205">They are marked `Public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="a60b4-206">`BeginTransaction` Открывает внутренний адаптер таблицы s `SqlConnection` (при необходимости), начинает транзакцию и присваивает его `Transaction` свойство и прикрепляет транзакцию к внутреннему `SqlDataAdapter` s `SqlCommand` объектов.</span><span class="sxs-lookup"><span data-stu-id="a60b4-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="a60b4-207">`CommitTransaction` и `RollbackTransaction` вызвать `Transaction` объект s `Commit` и `Rollback` методы, соответственно, перед тем как закрыть внутренний `Connection` объекта.</span><span class="sxs-lookup"><span data-stu-id="a60b4-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="a60b4-208">Шаг 3. Добавление методов для обновления и удаления данных в рамках транзакции</span><span class="sxs-lookup"><span data-stu-id="a60b4-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="a60b4-209">С помощью этих методов завершения, мы повторно Готово для добавления методов для `ProductsDataTable` или BLL, выполнить ряд команд в рамках транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="a60b4-210">Следующий метод использует шаблон пакетного обновления для обновления `ProductsDataTable` экземпляра с помощью транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="a60b4-211">Он запускает транзакцию путем вызова `BeginTransaction` метод, а затем используется `Try...Catch` блок для выдачи инструкции изменения данных.</span><span class="sxs-lookup"><span data-stu-id="a60b4-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `Try...Catch` block to issue the data modification statements.</span></span> <span data-ttu-id="a60b4-212">Если вызов `Adapter` объект s `Update` метода приводят к возникновению исключения будут перенесены выполнения `catch` блока, где будет выполнен откат транзакции и исключение создается повторно.</span><span class="sxs-lookup"><span data-stu-id="a60b4-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="a60b4-213">Помните, что `Update` метод реализует шаблон пакетного обновления путем перечисления строк, предоставленного `ProductsDataTable` и выполнение необходимого `InsertCommand`, `UpdateCommand`, и `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="a60b4-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="a60b4-214">Если любой из этих команд приведет к ошибке, транзакция откатывается, Отмена предыдущего изменения, внесенные во время существования транзакции s.</span><span class="sxs-lookup"><span data-stu-id="a60b4-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="a60b4-215">Следует `Update` инструкции завершаются без ошибки, транзакция фиксируется в полном объеме.</span><span class="sxs-lookup"><span data-stu-id="a60b4-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample4.vb)]

<span data-ttu-id="a60b4-216">Добавить `UpdateWithTransaction` метод `ProductsTableAdapter` класса через разделяемый класс в `ProductsTableAdapter.TransactionSupport.vb`.</span><span class="sxs-lookup"><span data-stu-id="a60b4-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.vb`.</span></span> <span data-ttu-id="a60b4-217">Кроме того, этот метод может быть добавлен к s уровня бизнес-логики `ProductsBLL` класса несколько незначительных синтаксических изменений.</span><span class="sxs-lookup"><span data-stu-id="a60b4-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="a60b4-218">А именно, keyword `Me` в `Me.BeginTransaction()`, `Me.CommitTransaction()`, и `Me.RollbackTransaction()` потребуется заменить `Adapter` (Помните, что `Adapter` — это имя свойства в `ProductsBLL` типа `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="a60b4-218">Namely, the keyword `Me` in `Me.BeginTransaction()`, `Me.CommitTransaction()`, and `Me.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="a60b4-219">`UpdateWithTransaction` Метод использует шаблон пакетного обновления, но ряд вызовов непосредственные методы DB также может использоваться в пределах области транзакции, как показано в следующем метод.</span><span class="sxs-lookup"><span data-stu-id="a60b4-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="a60b4-220">`DeleteProductsWithTransaction` Метод принимает в качестве входных данных `List(Of T)` типа `Integer`, которые являются `ProductID` удаляемых.</span><span class="sxs-lookup"><span data-stu-id="a60b4-220">The `DeleteProductsWithTransaction` method accepts as input a `List(Of T)` of type `Integer`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="a60b4-221">Запускает транзакцию путем вызова, метод `BeginTransaction` и затем в `Try` block, выполняет итерацию предоставленного списка вызова непосредственного шаблона DB `Delete` метод для каждого `ProductID` значение.</span><span class="sxs-lookup"><span data-stu-id="a60b4-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `Try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="a60b4-222">Если какие-либо вызовы `Delete` завершается ошибкой, управление передается `Catch` блока, где откат транзакции и исключение создается повторно.</span><span class="sxs-lookup"><span data-stu-id="a60b4-222">If any of the calls to `Delete` fails, control is transferred to the `Catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="a60b4-223">Если во всех вызовах `Delete` выполниться успешно, а затем транзакция фиксируется.</span><span class="sxs-lookup"><span data-stu-id="a60b4-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="a60b4-224">Добавьте следующий метод для `ProductsBLL` класса.</span><span class="sxs-lookup"><span data-stu-id="a60b4-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample5.vb)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="a60b4-225">Применение транзакций через несколько адаптеров таблиц</span><span class="sxs-lookup"><span data-stu-id="a60b4-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="a60b4-226">Код, связанные с транзакциями, рассмотренный позволяет несколько инструкций на `ProductsTableAdapter` следует рассматривать как атомарную операцию.</span><span class="sxs-lookup"><span data-stu-id="a60b4-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="a60b4-227">Но что делать, если несколько изменений в разных таблицах базы данных должны выполняться атомарным образом?</span><span class="sxs-lookup"><span data-stu-id="a60b4-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="a60b4-228">Например при удалении категории, мы может сначала необходимо переназначить его текущие продукты, для некоторых других категорий.</span><span class="sxs-lookup"><span data-stu-id="a60b4-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="a60b4-229">Эти два шага, переназначение продукты и удаление категории должен быть выполнен в виде атомарной операции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="a60b4-230">Но `ProductsTableAdapter` включает в себя только методы изменения `Products` таблицы и `CategoriesTableAdapter` включает в себя только методы изменения `Categories` таблицы.</span><span class="sxs-lookup"><span data-stu-id="a60b4-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="a60b4-231">Так как транзакция может охватывать обоих адаптеров таблиц</span><span class="sxs-lookup"><span data-stu-id="a60b4-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="a60b4-232">Один из вариантов — Добавление метода для `CategoriesTableAdapter` с именем `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` и у этого метода вызовите хранимую процедуру, которая связывает продукты и удаляет категорию в пределах транзакции, определенной в хранимой процедуре.</span><span class="sxs-lookup"><span data-stu-id="a60b4-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="a60b4-233">Мы рассмотрим как начало, фиксация и откат транзакции в хранимых процедурах в дальнейших учебных курсах.</span><span class="sxs-lookup"><span data-stu-id="a60b4-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="a60b4-234">Другой вариант — Создание вспомогательного класса в слое DAL, содержащий `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` метод.</span><span class="sxs-lookup"><span data-stu-id="a60b4-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="a60b4-235">Этот метод создаст экземпляр `CategoriesTableAdapter` и `ProductsTableAdapter` и затем задать два TableAdapters `Connection` свойства на тот же `SqlConnection` экземпляра.</span><span class="sxs-lookup"><span data-stu-id="a60b4-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="a60b4-236">AT этой точки, либо один из двух адаптеров таблиц TableAdapter будет инициировать транзакцию с помощью вызова `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="a60b4-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="a60b4-237">Методы адаптеров таблиц для переназначения продукты и удаление категории будет вызываться в `Try...Catch` блок с транзакция фиксируется или откатывается назад при необходимости.</span><span class="sxs-lookup"><span data-stu-id="a60b4-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `Try...Catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="a60b4-238">Шаг 4. Добавление`UpdateWithTransaction`метод уровня бизнес-логики</span><span class="sxs-lookup"><span data-stu-id="a60b4-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="a60b4-239">На шаге 3 мы добавили `UpdateWithTransaction` метод `ProductsTableAdapter` в слое DAL.</span><span class="sxs-lookup"><span data-stu-id="a60b4-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="a60b4-240">Мы следует добавить соответствующий метод BLL.</span><span class="sxs-lookup"><span data-stu-id="a60b4-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="a60b4-241">Хотя уровень представления данных может вызвать напрямую к DAL для вызова `UpdateWithTransaction` метод, strived этих учебников для определения многоуровневой архитектуры, которая изолирует DAL от слоя представления.</span><span class="sxs-lookup"><span data-stu-id="a60b4-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="a60b4-242">Таким образом он behooves нам по-прежнему этот подход.</span><span class="sxs-lookup"><span data-stu-id="a60b4-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="a60b4-243">Откройте `ProductsBLL` и добавьте метод с именем `UpdateWithTransaction` который просто вызывает вниз, чтобы соответствующий метод DAL.</span><span class="sxs-lookup"><span data-stu-id="a60b4-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="a60b4-244">Теперь должно существовать два новых метода в `ProductsBLL`: `UpdateWithTransaction`, который вы только что добавили, и `DeleteProductsWithTransaction`, который был добавлен на шаге 3.</span><span class="sxs-lookup"><span data-stu-id="a60b4-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample6.vb)]

> [!NOTE]
> <span data-ttu-id="a60b4-245">Эти методы не включают `DataObjectMethodAttribute` атрибут, назначенный большинство методов в `ProductsBLL` класса потому, что мы будем вызывает эти методы непосредственно из кода классов страницы ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="a60b4-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="a60b4-246">Помните, что `DataObjectMethodAttribute` используется для пометки, какие методы должны отображаться в ObjectDataSource s Настройка источника данных, мастера и какие вкладке (SELECT, UPDATE, INSERT или DELETE).</span><span class="sxs-lookup"><span data-stu-id="a60b4-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="a60b4-247">Так как GridView не имеет встроенной возможности пакетной службы, изменение или удаление, необходимо программным способом вызова этих методов вместо того, чтобы использовать без кода декларативный подход.</span><span class="sxs-lookup"><span data-stu-id="a60b4-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="a60b4-248">Шаг 5. Атомарным образом обновление баз данных от слоя представления</span><span class="sxs-lookup"><span data-stu-id="a60b4-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="a60b4-249">Чтобы проиллюстрировать влияние транзакции при обновлении пакета записей, позволяют s создания пользовательского интерфейса, представлены все продукты в элементе управления GridView, а также веб-сайт кнопки элемента управления, который, при нажатии переназначает продукты `CategoryID` значения.</span><span class="sxs-lookup"><span data-stu-id="a60b4-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="a60b4-250">В частности, развивается переназначение категории, чтобы несколько первых продуктов назначаются является допустимым `CategoryID` несуществующий присвоено значение, а другие — намеренно `CategoryID` значение.</span><span class="sxs-lookup"><span data-stu-id="a60b4-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="a60b4-251">Если мы попытаемся обновить базу данных с продуктом, `CategoryID` не соответствует существующей категории s `CategoryID`, произойдет нарушение ограничения внешнего ключа, и возникает исключение.</span><span class="sxs-lookup"><span data-stu-id="a60b4-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="a60b4-252">Что мы увидим в этом примере, что, при использовании транзакций исключением, вызванным из нарушение ограничения внешнего ключа приведет к предыдущей допустимым `CategoryID` изменения к откату.</span><span class="sxs-lookup"><span data-stu-id="a60b4-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="a60b4-253">Без использования транзакции, однако останется изменения начальной категорий.</span><span class="sxs-lookup"><span data-stu-id="a60b4-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="a60b4-254">Сначала откройте `Transactions.aspx` странице в `BatchData` папки и перетащите элемент управления GridView с панели инструментов в конструктор.</span><span class="sxs-lookup"><span data-stu-id="a60b4-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="a60b4-255">Задайте его `ID` для `Products` и его смарт-теге, привязать его к элементу управления ObjectDataSource с именем `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="a60b4-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="a60b4-256">Настройте элемент ObjectDataSource для извлечения данных из `ProductsBLL` класс s `GetProducts` метод.</span><span class="sxs-lookup"><span data-stu-id="a60b4-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="a60b4-257">Это GridView только для чтения, поэтому устанавливается раскрывающиеся списки в UPDATE, INSERT и удаление вкладок (нет) и нажмите кнопку Готово.</span><span class="sxs-lookup"><span data-stu-id="a60b4-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="a60b4-258">[![Настройка ObjectDataSource на использование метода GetProducts класса ProductsBLL s](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="a60b4-258">[![Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span></span>

<span data-ttu-id="a60b4-259">**Рис. 5**: Настройка ObjectDataSource для использования `ProductsBLL` класс s `GetProducts` метод ([Просмотр полноразмерного изображения](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="a60b4-259">**Figure 5**: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span></span>


<span data-ttu-id="a60b4-260">[![Установите раскрывающиеся списки в UPDATE, INSERT и удаление вкладок (нет)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="a60b4-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span></span>

<span data-ttu-id="a60b4-261">**Рис. 6**: Задайте раскрывающиеся списки в UPDATE, INSERT и удаление вкладок (нет) ([Просмотр полноразмерного изображения](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="a60b4-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span></span>


<span data-ttu-id="a60b4-262">После завершения работы мастера настройки источников данных Visual Studio создаст поля BoundFields и CheckBoxField для полей данных продукта.</span><span class="sxs-lookup"><span data-stu-id="a60b4-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="a60b4-263">Удалить все эти поля, за исключением `ProductID`, `ProductName`, `CategoryID`, и `CategoryName` и переименуйте `ProductName` и `CategoryName` поля BoundField, кроме `HeaderText` свойства Product и Category, соответственно.</span><span class="sxs-lookup"><span data-stu-id="a60b4-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="a60b4-264">В смарт-теге флажок Enable Paging.</span><span class="sxs-lookup"><span data-stu-id="a60b4-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="a60b4-265">После внесения этих изменений, GridView и ObjectDataSource s декларативная разметка должна выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="a60b4-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample7.aspx)]

<span data-ttu-id="a60b4-266">Добавьте три элемента управления кнопки Web над элементом управления GridView.</span><span class="sxs-lookup"><span data-stu-id="a60b4-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="a60b4-267">Значение первой кнопки s свойство Text для обновления сетки, второй s, чтобы изменить категории (с помощью ТРАНЗАКЦИЙ) и третьим s, чтобы изменить категории (без ТРАНЗАКЦИИ).</span><span class="sxs-lookup"><span data-stu-id="a60b4-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample8.aspx)]

<span data-ttu-id="a60b4-268">На этом этапе конструктор в Visual Studio должен выглядеть снимок экрана, показанный на рис. 7.</span><span class="sxs-lookup"><span data-stu-id="a60b4-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="a60b4-269">[![Страница содержит GridView и три кнопки веб-элементов управления](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="a60b4-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span></span>

<span data-ttu-id="a60b4-270">**Рис. 7**: Страница содержит GridView и три кнопки веб-элементов управления ([Просмотр полноразмерного изображения](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="a60b4-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span></span>


<span data-ttu-id="a60b4-271">Создание обработчиков событий для каждого из трех кнопки s `Click` события и используйте следующий код:</span><span class="sxs-lookup"><span data-stu-id="a60b4-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample9.vb)]

<span data-ttu-id="a60b4-272">Обновление кнопку s `Click` обработчик события просто выполняет повторную привязку данных к GridView, вызвав `Products` GridView s `DataBind` метод.</span><span class="sxs-lookup"><span data-stu-id="a60b4-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="a60b4-273">Второй обработчик событий переназначает продукты `CategoryID` s и использует новый метод транзакции из BLL производительности базы данных обновляет в рамках транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="a60b4-274">Обратите внимание, что каждый продукт s `CategoryID` произвольно присваивается то же значение, что его `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="a60b4-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="a60b4-275">Это подойдет для первого несколько продуктов, так как эти продукты имеют `ProductID` значения, которые происходят для сопоставления с допустимым `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="a60b4-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="a60b4-276">Но раз `ProductID` начало s, слишком большим, такое случайными пересечение `ProductID` s и `CategoryID` s больше не применяется.</span><span class="sxs-lookup"><span data-stu-id="a60b4-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="a60b4-277">Третий `Click` обработчик событий обновляет продукты `CategoryID` s таким же образом, но отправляет обновление базы данных с помощью `ProductsTableAdapter` по умолчанию s `Update` метод.</span><span class="sxs-lookup"><span data-stu-id="a60b4-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="a60b4-278">Это `Update` метод не переносится ряда команд в рамках транзакции, поэтому эти изменения будут сделаны перед первой ошибки Нарушение обнаружено ограничение внешнего ключа будет сохраняться.</span><span class="sxs-lookup"><span data-stu-id="a60b4-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="a60b4-279">Чтобы продемонстрировать это, посетите эту страницу через обозреватель.</span><span class="sxs-lookup"><span data-stu-id="a60b4-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="a60b4-280">Изначально вы увидите на первой странице данных, как показано на рис. 8.</span><span class="sxs-lookup"><span data-stu-id="a60b4-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="a60b4-281">Затем щелкните кнопку Изменить категории (с помощью ТРАНЗАКЦИЙ).</span><span class="sxs-lookup"><span data-stu-id="a60b4-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="a60b4-282">Это вызывает обратную передачу и пытаться обновить все продукты `CategoryID` значений, но приведет к нарушению ограничения внешнего ключа (см. рис. 9).</span><span class="sxs-lookup"><span data-stu-id="a60b4-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="a60b4-283">[![Товары показываются в GridView с возможностью разбивки на страницы](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="a60b4-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span></span>

<span data-ttu-id="a60b4-284">**Рис. 8**: Товары показываются в GridView с возможностью разбивки на страницы ([Просмотр полноразмерного изображения](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="a60b4-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span></span>


<span data-ttu-id="a60b4-285">[![Переназначение категорий приводит к нарушению ограничения внешнего ключа](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="a60b4-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span></span>

<span data-ttu-id="a60b4-286">**Рис. 9**: Переназначение категорий приводит нарушение ограничения внешнего ключа ([Просмотр полноразмерного изображения](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="a60b4-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span></span>


<span data-ttu-id="a60b4-287">Теперь нажмите кнопку "Назад" в браузере s и затем нажмите кнопку Обновить сетку.</span><span class="sxs-lookup"><span data-stu-id="a60b4-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="a60b4-288">При обновлении данных точно такие же выходные данные должны увидеть, как показано на рис. 8.</span><span class="sxs-lookup"><span data-stu-id="a60b4-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="a60b4-289">То есть, даже если некоторые из продуктов `CategoryID` s было изменено на допустимые значения и обновлен в базе данных, они откатывались обратно в том случае, когда произошло нарушение ограничения внешнего ключа.</span><span class="sxs-lookup"><span data-stu-id="a60b4-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="a60b4-290">Теперь попробуйте нажать кнопку Изменить категории (без ТРАНЗАКЦИИ).</span><span class="sxs-lookup"><span data-stu-id="a60b4-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="a60b4-291">Это приведет к та же ошибка нарушения ограничения внешнего ключа (см. рис. 9), но в этот раз те продукты, `CategoryID` значения были изменены для юридических значение не будет выполнен откат.</span><span class="sxs-lookup"><span data-stu-id="a60b4-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="a60b4-292">Нажмите кнопку "Назад" в браузере s и нажмите кнопку Обновить сетку.</span><span class="sxs-lookup"><span data-stu-id="a60b4-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="a60b4-293">Как показано на рис. 10, `CategoryID` назначили s первые восемь продуктов.</span><span class="sxs-lookup"><span data-stu-id="a60b4-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="a60b4-294">Например, на рис. 8 Chang было `CategoryID` 1, но в рис 10 ИТ s была переназначена на 2.</span><span class="sxs-lookup"><span data-stu-id="a60b4-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="a60b4-295">[![Некоторые значения CategoryID продуктов не обновлены во время другие были](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="a60b4-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span></span>

<span data-ttu-id="a60b4-296">**Рис. 10**: Некоторые продукты `CategoryID` значения были обновлены во время другие были не ([Просмотр полноразмерного изображения](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="a60b4-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="a60b4-297">Сводка</span><span class="sxs-lookup"><span data-stu-id="a60b4-297">Summary</span></span>

<span data-ttu-id="a60b4-298">По умолчанию методы TableAdapter s не заключайте инструкции выполненного базы данных в пределах транзакции, но немного поработав мы добавим методы, которые создают, commit и rollback транзакции.</span><span class="sxs-lookup"><span data-stu-id="a60b4-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="a60b4-299">В этом руководстве мы создали три такие методы в `ProductsTableAdapter` класса: `BeginTransaction`, `CommitTransaction`, и `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="a60b4-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="a60b4-300">Мы узнали, как использовать эти методы вместе с `Try...Catch` блок, чтобы сделать атомарным ряд инструкций, изменяющих данные.</span><span class="sxs-lookup"><span data-stu-id="a60b4-300">We saw how to use these methods along with a `Try...Catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="a60b4-301">В частности, мы создали `UpdateWithTransaction` метод в `ProductsTableAdapter`, который использует шаблон пакетного обновления выполнить необходимые изменения в строки, передаваемой `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="a60b4-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="a60b4-302">Мы также добавили `DeleteProductsWithTransaction` метод `ProductsBLL` классов в BLL, который принимает `List` из `ProductID` значения в качестве входных данных и вызывает метод шаблон непосредственные методы DB `Delete` для каждого `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="a60b4-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="a60b4-303">Оба метода для начала создания транзакции и последующего выполнения инструкции изменения данных в пределах `Try...Catch` блока.</span><span class="sxs-lookup"><span data-stu-id="a60b4-303">Both methods start by creating a transaction and then executing the data modification statements within a `Try...Catch` block.</span></span> <span data-ttu-id="a60b4-304">Если возникает исключение, транзакция откатывается, в противном случае он фиксируется.</span><span class="sxs-lookup"><span data-stu-id="a60b4-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="a60b4-305">Шаг 5 показано влияние транзакций пакетных обновлений и пакетов обновлений, которые не использовать транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a60b4-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="a60b4-306">В трех следующих руководствах мы будет основываться на фундаменте, заложенном в этом руководстве и создавать пользовательские интерфейсы для выполнения пакетной вставки, удаления и вставки.</span><span class="sxs-lookup"><span data-stu-id="a60b4-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="a60b4-307">Счастливого вам программирования!</span><span class="sxs-lookup"><span data-stu-id="a60b4-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="a60b4-308">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="a60b4-308">Further Reading</span></span>

<span data-ttu-id="a60b4-309">Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:</span><span class="sxs-lookup"><span data-stu-id="a60b4-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="a60b4-310">Поддержание согласованности базы данных с транзакциями</span><span class="sxs-lookup"><span data-stu-id="a60b4-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="a60b4-311">Управление транзакциями в SQL Server хранимых процедур</span><span class="sxs-lookup"><span data-stu-id="a60b4-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="a60b4-312">Транзакции, стало проще: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="a60b4-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="a60b4-313">Класс TransactionScope и адаптеров обработки данных</span><span class="sxs-lookup"><span data-stu-id="a60b4-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="a60b4-314">Использование транзакций базы данных Oracle в .NET</span><span class="sxs-lookup"><span data-stu-id="a60b4-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="a60b4-315">Об авторе</span><span class="sxs-lookup"><span data-stu-id="a60b4-315">About the Author</span></span>

<span data-ttu-id="a60b4-316">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP.NET и основатель веб- [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Microsoft с 1998 года.</span><span class="sxs-lookup"><span data-stu-id="a60b4-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="a60b4-317">Скотт — независимый консультант, преподаватель и автор.</span><span class="sxs-lookup"><span data-stu-id="a60b4-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="a60b4-318">Его последняя книга — [ *Sams Teach ASP.NET 2.0 in 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="a60b4-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="a60b4-319">Ним можно связаться по адресу [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="a60b4-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="a60b4-320">или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="a60b4-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="a60b4-321">Особая благодарность</span><span class="sxs-lookup"><span data-stu-id="a60b4-321">Special Thanks To</span></span>

<span data-ttu-id="a60b4-322">В этой серии руководств пособий рецензировалась многими компетентными редакторами.</span><span class="sxs-lookup"><span data-stu-id="a60b4-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="a60b4-323">Дейв Gardner (Hilton giesenow) и Терезой Мерфи, стали Лиз Шалок в этом руководстве.</span><span class="sxs-lookup"><span data-stu-id="a60b4-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="a60b4-324">Хотите поработать с моих последующих статей для MSDN?</span><span class="sxs-lookup"><span data-stu-id="a60b4-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="a60b4-325">Если Да, напишите мне [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="a60b4-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="a60b4-326">[Назад](batch-inserting-cs.md)
> [Вперед](batch-updating-vb.md)</span><span class="sxs-lookup"><span data-stu-id="a60b4-326">[Previous](batch-inserting-cs.md)
[Next](batch-updating-vb.md)</span></span>
