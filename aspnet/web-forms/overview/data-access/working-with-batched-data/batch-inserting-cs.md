---
uid: web-forms/overview/data-access/working-with-batched-data/batch-inserting-cs
title: Пакет, вставка (C#) | Документация Майкрософт
author: rick-anderson
description: Узнайте, как вставить несколько записей в базе данных в рамках одной операции. В слой пользовательского интерфейса мы расширим GridView, чтобы разрешить пользователю вводить несколько n...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: cf025e08-48fc-4385-b176-8610aa7b5565
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/batch-inserting-cs
msc.type: authoredcontent
ms.openlocfilehash: 561acc9b473bac7d39e7ed4d511d8b979657131d
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57035751"
---
<a name="batch-inserting-c"></a>Пакетная вставка (C#)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_66_CS.zip) или [скачать PDF](batch-inserting-cs/_static/datatutorial66cs1.pdf)

> Узнайте, как вставить несколько записей в базе данных в рамках одной операции. В слой пользовательского интерфейса мы расширим GridView, чтобы разрешить пользователю вводить несколько новых записей. В уровень доступа к данным мы Подведем краткие несколько операций вставки в рамках транзакции, чтобы убедиться, что успешного выполнения всех операций вставки, или выполнен откат всех операций вставки.


## <a name="introduction"></a>Вступление

В [обновление пакета](batch-updating-cs.md) учебном курсе было рассмаотрено Настройка элемента управления GridView для представления интерфейса, где несколько записей были редактируемой. Посещающий страницу пользователь может внести ряд изменений и выполните с одним нажатием кнопки, пакетного обновления. В ситуациях, где пользователи часто обновлять многие записи за одно действие, такой интерфейс можно сохранить бесчисленное количество щелчков, а также переключение контекста клавиатуры для мыши по сравнению с по умолчанию построчные функций редактирования, которые сначала были изучены обратно в [ Общие сведения о вставке, обновление и удаление данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) руководства.

Эта концепция также может применяться при добавлении записей. Представим, что здесь в компании Northwind Traders мы часто получают поставки от поставщиков, которые содержат ряд продуктов для определенной категории. Например мы получаем партию шесть разных чая или кофе продуктов, от Tokyo Traders. Если пользователь вводит шесть одного продукта одновременно, используя элемент DetailsView, их нужно снова и снова выберите многие из одинаковые значения: им необходимо будет выбрать одной категории (Напитки), одного поставщика (Tokyo Traders), это значение (более не поддерживается Значение false) и тем же количеством единиц на порядковый номер (0). Эта запись повторяющихся данных не только много времени, но может привести к ошибкам.

Немного поработав, мы можем создать пакет Вставка интерфейс, позволяющий пользователю выбрать поставщика и категории один раз, введите ряд названий продуктов и цен за штуку и нажмите кнопку для добавления новых продуктов в базу данных (см. рис. 1). При добавлении каждого продукта, его `ProductName` и `UnitPrice` полей данных присваиваются значения, введенные в текстовые поля, хотя его `CategoryID` и `SupplierID` значения присваиваются значения из элементов управления DropDownList в верхнем fo формы. `Discontinued` И `UnitsOnOrder` значения устанавливаются в значения жестко `false` и 0 соответственно.


[![Интерфейс вставки пакетной службы](batch-inserting-cs/_static/image2.png)](batch-inserting-cs/_static/image1.png)

**Рис. 1**: Интерфейс вставки пакета ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image3.png))


В этом руководстве мы создадим страницу, которая реализует пакетной службы, вставка интерфейс, показанный на рис. 1. Как с помощью двух предыдущих учебных мы будет служить оболочкой операций вставки в пределах области транзакции для обеспечения атомарности. Позвольте s приступить к работе!

## <a name="step-1-creating-the-display-interface"></a>Шаг 1. Создание интерфейса отображения

Этот учебник будет состоять из одной страницы, разделенное на две области: область отображения и область вставки. Интерфейс отображения, который мы создадим в этом шаге, показаны продукты в элементе управления GridView и содержит кнопку под названием процесса поставки продукта. При нажатии этой кнопки, интерфейс отображения заменяется интерфейса вставки, как показано на рис. 1. Интерфейс отображения возвращает после добавить продукты из отгрузки или нажатии кнопки "Отмена". Мы создадим интерфейс вставки на шаге 2.

При создании страницы, который имеет два интерфейса, одновременно только один из которых является видимым, каждый интерфейс обычно размещается в [веб-панель управления](http://www.w3schools.com/aspnet/control_panel.asp), который служит контейнером для других элементов управления. Таким образом нашу страницу будет иметь два элемента управления панели один для каждого интерфейса.

Сначала откройте `BatchInsert.aspx` странице в `BatchData` папки и перетащите панель из панели элементов в конструктор (см. рис. 2). Задайте для свойства панели s `ID` свойства `DisplayInterface`. При добавлении панели в конструкторе, его `Height` и `Width` свойствам присваивается 50px и 125px, соответственно. Очистите значения этих свойств в окне свойств.


[![Перетащите панель из панели элементов в конструктор](batch-inserting-cs/_static/image5.png)](batch-inserting-cs/_static/image4.png)

**Рис. 2**: Перетащите панель из панели элементов в конструктор ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image6.png))


Затем перетащите элемент управления кнопки и GridView в панель. Назначьте свойству s `ID` свойства `ProcessShipment` и его `Text` свойства процесса поставки продукта. Набор GridView s `ID` свойства `ProductsGrid` и его смарт-теге, привязать его к элементу управления ObjectDataSource с именем `ProductsDataSource`. Настройте элемент ObjectDataSource для извлечения данных из `ProductsBLL` класс s `GetProducts` метод. Так как этот GridView используется только для отображения данных, установите раскрывающиеся списки в UPDATE, INSERT и удаление вкладок (нет). Нажмите кнопку Готово для завершения работы мастера настройки источника данных.


[![Просмотреть данные, возвращаемые из метода GetProducts класса ProductsBLL s](batch-inserting-cs/_static/image8.png)](batch-inserting-cs/_static/image7.png)

**Рис. 3**: Отобразить данные, возвращенные из `ProductsBLL` класс s `GetProducts` метод ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image9.png))


[![Установите раскрывающиеся списки в UPDATE, INSERT и удаление вкладок (нет)](batch-inserting-cs/_static/image11.png)](batch-inserting-cs/_static/image10.png)

**Рис. 4**: Задайте раскрывающиеся списки в UPDATE, INSERT и удаление вкладок (нет) ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image12.png))


После завершения работы мастера ObjectDataSource Visual Studio будут добавлены поля BoundFields и CheckBoxField для полей данных продукта. Удалите все, кроме `ProductName`, `CategoryName`, `SupplierName`, `UnitPrice`, и `Discontinued` поля. Вы можете внести любые изменения внешнего вида. Я решил форматирования `UnitPrice` поля в виде значения валюты, перед началом записи поля и переименовать несколько полей, `HeaderText` значения. Кроме того, настройте GridView, чтобы включить разбиение по страницам и обеспечения поддержки сортировки, установив флажки включить разбиение по страницам и включить сортировку в смарт-теге GridView s.

После добавления элементов управления панели, кнопки, GridView и элемент управления ObjectDataSource и настройка полей s GridView, декларативной разметке страницы s должен выглядеть следующим образом:


[!code-aspx[Main](batch-inserting-cs/samples/sample1.aspx)]

Обратите внимание, что разметка для кнопки и GridView отображаются между открывающим и закрывающим `<asp:Panel>` теги. Так как эти элементы управления находятся в пределах `DisplayInterface` панели мы их можно скрыть, просто задав панели s `Visible` свойства `false`. Шаг 3 рассматривает программного изменения на панели s `Visible` свойство в ответ на нажатие кнопки щелкните, чтобы показать один интерфейс, скрывая другой.

Отвлекитесь и просмотрите ход работы через браузер. Как показано на рис. 5, вы должны увидеть процесс поставки продукта кнопки выше элемент GridView со списком продуктов десять одновременно.


[![GridView перечисляет продукты и предлагает сортировки и разбиения по страницам](batch-inserting-cs/_static/image14.png)](batch-inserting-cs/_static/image13.png)

**Рис. 5**: GridView перечисляет продукты и обеспечивает сортировку и разбиение по страницам возможности ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image15.png))


## <a name="step-2-creating-the-inserting-interface"></a>Шаг 2. Создание интерфейса вставки

С помощью отображения интерфейса полный, мы будет готов для создания интерфейса вставки. Для этого руководства позволяют создать интерфейс для вставки, запрашивает одно значение поставщика и категории, а затем позволяет пользователю ввести до пяти названия продуктов и значения цены единицы s. С этим интерфейсом пользователь может добавлять новые продукты от одного до пяти все же категорию и поставщика, которые имеют уникальные продукты названия и цены.

Start, перетащив панели из инструментария в конструктор, поместив его под существующий `DisplayInterface` панели. Задайте `ID` свойства данного объекта новые добавленные панели `InsertingInterface` и задайте его `Visible` свойства `false`. Мы добавим код, который задает `InsertingInterface` панели s `Visible` свойства `true` на шаге 3. Также очистить панель s `Height` и `Width` значения свойств.

Далее нам нужно создать интерфейс вставки, было показано на рис. 1. Этот интерфейс может создаваться с помощью разных методов HTML, но мы будем использовать ее довольно проста: таблица с четырьмя столбцами и семь строк.

> [!NOTE]
> При вводе разметки HTML `<table>` элементов, я предпочитаю использовать представление источника. Хотя Visual Studio имеет средства для добавления `<table>` элементов с помощью конструктора, конструкторе кажется, что все слишком хочу внедрить незапрошенный для `style` параметры в разметку. Когда я созданы `<table>` разметки, я обычно вернитесь в конструктор для добавления веб-элементов управления и задавать их свойства. При создании таблиц с предварительно определенный столбцами и строками я предпочитаю использовать статический HTML, а не [таблицы веб-элемента управления](https://msdn.microsoft.com/library/system.web.ui.webcontrols.table.aspx) так, как веб-элементы управления, помещены в элемент управления веб-таблица может осуществляться только с помощью `FindControl("controlID")` шаблон. Тем не менее, я использовать элементы управления веб-таблица для динамически размера таблиц (из них, строк или столбцов на основе некоторые базы данных или указанных пользователем критериев), с момента веб-таблица, элемент управления может быть создан программным способом.


Введите следующую разметку внутри тегов `<asp:Panel>` тегами `InsertingInterface` панели:


[!code-html[Main](batch-inserting-cs/samples/sample2.html)]

Это `<table>` разметки не включает любые веб-элементы управления, но мы добавим их моментально. Обратите внимание, что каждый `<tr>` элемент содержит конкретное значение класс CSS: `BatchInsertHeaderRow` для строки заголовка, которому будет переходить поставщика и категории элементов управления DropDownList; `BatchInsertFooterRow` для строки нижнего колонтитула, которому будет переходить добавить продукты Shipment и Отмена кнопки; и чередующихся `BatchInsertRow` и `BatchInsertAlternatingRow` значения для строк, которые будут содержать продукта и единицы измерения Цена элемента управления TextBox. Я ve создан соответствующие классы CSS в `Styles.css` файл для предоставления интерфейса вставки интерфейсом, аналогичным интерфейсу GridView и DetailsView, управляет мы ve, используемый в данных учебных курсах. Ниже приведены эти классы CSS.


[!code-css[Main](batch-inserting-cs/samples/sample3.css)]

С этой разметкой ввода вернитесь в режим конструктора. Это `<table>` должно отображаться как таблицу семь строк и четырех столбцов, в конструкторе, как показано на рис. 6.


[![Интерфейс вставки состоит из четырех столбцов, таблица семь строк](batch-inserting-cs/_static/image17.png)](batch-inserting-cs/_static/image16.png)

**Рис. 6**: Интерфейс вставки состоит из четырех столбцов, таблица семь строк ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image18.png))


Мы повторно теперь готов для добавления веб-элементов управления в интерфейсе правки. Перетащите двух элементов управления DropDownList с панели инструментов в соответствующие ячейки таблицы в таблице одного поставщика и категории.

Задать поставщик DropDownList s `ID` свойства `Suppliers` и привязать его к элементу управления ObjectDataSource с именем `SuppliersDataSource`. Настройте новый элемент ObjectDataSource для извлечения данных из `SuppliersBLL` класс s `GetSuppliers` метода и обновление набора вкладке s с раскрывающимся списком (нет). Нажмите кнопку Готово, чтобы завершить работу мастера.


[![Настройка ObjectDataSource на использование метода Getsuppliers() класса s GetSuppliers метод](batch-inserting-cs/_static/image20.png)](batch-inserting-cs/_static/image19.png)

**Рис. 7**: Настройка ObjectDataSource для использования `SuppliersBLL` класс s `GetSuppliers` метод ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image21.png))


У `Suppliers` элемент управления DropDownList отображает `CompanyName` поля данных и использование `SupplierID` поле данных в качестве его `ListItem` s значений.


[![Отображения поля данных CompanyName и SupplierID использовать в качестве значения](batch-inserting-cs/_static/image23.png)](batch-inserting-cs/_static/image22.png)

**Рис. 8**: Отображение `CompanyName` поля данных и использование `SupplierID` как значение ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image24.png))


Имя второго элемента управления DropDownList `Categories` и привязать его к элементу управления ObjectDataSource с именем `CategoriesDataSource`. Настройка `CategoriesDataSource` ObjectDataSource на использование `CategoriesBLL` класс s `GetCategories` метод; набор, перечислены в раскрывающемся списке вкладки UPDATE и DELETE (нет) и нажмите кнопку "Готово" для завершения работы мастера. Наконец, иметь элемент управления DropDownList отображает `CategoryName` поля данных и использование `CategoryID` как значение.

После этих двух элементов управления DropDownList добавлены и привязаны к соответствующим образом настроенных элементов управления ObjectDataSource, экран должен выглядеть аналогично рис. 9.


[![Теперь содержит строки заголовка «поставщики» и «элементов управления DropDownList категории](batch-inserting-cs/_static/image26.png)](batch-inserting-cs/_static/image25.png)

**Рис. 9**: Строка заголовка теперь содержит `Suppliers` и `Categories` элементов управления DropDownList ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image27.png))


Теперь нам нужно создать текстовые поля для сбора, название и цену для каждого нового продукта. Перетащите элемент управления TextBox с панели инструментов в конструктор для каждой строки название и цену продукта пять. Задайте `ID` свойства из текстовых полей для `ProductName1`, `UnitPrice1`, `ProductName2`, `UnitPrice2`, `ProductName3`, `UnitPrice3`, и т. д.

Добавьте элемент управления CompareValidator после каждого цены за единицу текстовые поля, установка `ControlToValidate` свойство в соответствующий `ID`. Также задайте `Operator` свойства `GreaterThanEqual`, `ValueToCompare` 0, и `Type` для `Currency`. Эти параметры указать CompareValidator для обеспечения цену, если указано, значение валют, больше или равно нулю. Задайте `Text` свойства \*, и `ErrorMessage` цену должен быть больше или равно нулю. Кроме того можно опустите любых символов валют.

> [!NOTE]
> Интерфейс вставки не включает все элементы управления RequiredFieldValidator, даже если `ProductName` в `Products` таблицы базы данных не допускает `NULL` значения. Это потому, что мы хотим сообщить пользователю ввести до пяти продуктов. Например если пользователь должен был предоставить продукта имя и цену за единицу для первых трех строк, если оставить пустым, последних двух строк мы d просто добавьте три новых продуктов в систему. Так как `ProductName` — требуется, однако нам потребуется программно проверять, чтобы убедиться, что если цена за единицу вводится, предоставляется соответствующее значение имени продукта. Это будет рассмотрено эта проверка на шаге 4.


При проверке входных данных пользователя s, CompareValidator сообщает недопустимые данные, если значение содержит символ валюты. Добавьте $ перед каждым из текстовых полей, который будет служить визуальным средством, которое указывает пользователю пропустить символ валюты при вводе цены цена за единицу.

Наконец, добавьте элемент управления ValidationSummary в `InsertingInterface` панели параметров его `ShowMessageBox` свойства `true` и его `ShowSummary` свойства `false`. С этими параметрами Если пользователь вводит значение Недопустимая единица измерения цены, звездочка будет отображаться рядом с нарушением. элементы управления TextBox и ValidationSummary отображает messagebox клиентской стороны, отобразится сообщение об ошибке, которую мы указали ранее.

На этом этапе экран должен выглядеть аналогично рис. 10.


[![Интерфейс вставки теперь включает текстовые поля для продуктов, названия и цены](batch-inserting-cs/_static/image29.png)](batch-inserting-cs/_static/image28.png)

**Рис. 10**: Вставка интерфейса теперь включает текстовые поля для названия продуктов и цены ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image30.png))


Далее нам нужно добавить новый товар из кнопок отгрузки» и «Отмена строки нижнего колонтитула. Перетащите два кнопочные элементы управления из области элементов в нижнем колонтитуле интерфейсе вставки параметра кнопок `ID` свойства `AddProducts` и `CancelButton` и `Text` свойства, чтобы добавить продукты из поставки "и" Отмена ", соответственно. Кроме того, задайте `CancelButton` управления s `CausesValidation` свойства `false`.

Наконец необходимо добавить элемент управления Label Web, который будет отображать сообщения о состоянии для двух интерфейсов. Например когда пользователь успешно добавляет новая партия продуктов, мы хотим вернуться к интерфейсу отображения и отображать сообщение с подтверждением. Если, однако пользователь предоставляет цену для нового продукта, но оставляет off название продукта, нам нужно отображать предупреждающее сообщение с момента `ProductName` поле является обязательным. Поскольку нам требуется это сообщение, отображаемое для обоих интерфейсов, поместите его в верхней части страницы за пределами панели.

Перетащите элемент управления Label Web с панели инструментов в верхней части страницы в конструкторе. Задайте `ID` свойства `StatusLabel`снимите out `Text` и установите `Visible` и `EnableViewState` свойства `false`. Как мы уже видели в предыдущих учебных курсах, установка `EnableViewState` свойства `false` позволяет программно изменять значения свойств метки s и их автоматически восстановить значения по умолчанию при последующих обратной передаче. Это упрощает код для отображения сообщения о состоянии в ответ на некоторое действие пользователя, которая исчезает при последующем обратном вызове. Наконец, установите `StatusLabel` управления s `CssClass` свойства на "Предупреждение", представляющее собой имя класса CSS, определенного в `Styles.css` в больших, курсив, шрифт, который отображает текст.

Рис. 11 показан конструктор Visual Studio после метки был добавлен и настроен.


[![Поместите элемент управления StatusLabel над двумя Панельными элементами управления](batch-inserting-cs/_static/image32.png)](batch-inserting-cs/_static/image31.png)

**Рис. 11**: Место `StatusLabel` контроля над двумя Панельными элементами управления ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image33.png))


## <a name="step-3-switching-between-the-display-and-inserting-interfaces"></a>Шаг 3. Переключение между отображением и вставка интерфейсов

На этом этапе мы завершили разметку для наших отображения и вставка интерфейсов, но мы повторно по-прежнему остается две задачи:

- Переключение между отображением и вставка интерфейсов
- Добавление продуктов в в комплект поставки в базу данных

В настоящее время отображения интерфейса отображается, но интерфейс вставки скрыт. Это обусловлено `DisplayInterface` панели s `Visible` свойству `true` (значение по умолчанию), хотя `InsertingInterface` панели s `Visible` свойство имеет значение `false`. Для переключения между двумя интерфейсами, нам просто нужно переключить каждого элемента управления s `Visible` значение свойства.

Мы хотим переместить из интерфейса отображения интерфейса вставки при нажатии кнопки процесса поставки продукта. Таким образом, создайте обработчик событий для данной кнопки s `Click` событие, содержащее следующий код:


[!code-csharp[Main](batch-inserting-cs/samples/sample4.cs)]

Этот код просто скрывает `DisplayInterface` панели и показывает `InsertingInterface` панели.

Создайте обработчики событий для продуктов добавьте из элементов управления отгрузки и кнопку отмены в интерфейсе правки. При щелчке любой из этих кнопок, нам нужно вернуться к отображения интерфейса. Создание `Click` обработчики событий для обоих кнопочные элементы управления, таким образом, чтобы они вызывают `ReturnToDisplayInterface`, метод, мы добавим моментально. В дополнение к скрытие `InsertingInterface` панели и отображение `DisplayInterface` панели `ReturnToDisplayInterface` метод должен возвращать веб-элементов управления в их состояние до редактирования. Это включает в себя установку элементов управления DropDownList `SelectedIndex` равными 0 и очищая `Text` свойства элементов управления TextBox.

> [!NOTE]
> Рассмотрим, что может произойти, если мы t возвращать элементы управления в их состояние до редактирования перед возвратом к интерфейсу отображения. Пользователь может поставки продукта процесса нажмите кнопку, введите продукты из отгрузки и нажмите кнопку Добавить продукты из отгрузки. Это бы добавить продукты и возвращают данные о пользователе для отображения интерфейса. На этом этапе пользователь может потребоваться добавить другой посылке. После нажатия кнопки поставки продукта процесс кнопкой, к которой будет возвращена к интерфейсу вставки, но DropDownList выбранные параметры и значения в текстовое поле по-прежнему содержались бы свои прежние значения.


[!code-csharp[Main](batch-inserting-cs/samples/sample5.cs)]

Оба `Click` обработчики событий, просто вызовите `ReturnToDisplayInterface` метод, несмотря на то, что мы вернемся к добавить продукты из поставки `Click` обработчик событий в шаге 4 и добавьте код для сохранения продукты. `ReturnToDisplayInterface` Запускает, возвращая `Suppliers` и `Categories` элементов управления DropDownList для их сначала параметров. Две константы `firstControlID` и `lastControlID` пометить начальное и конечное значения индекса элемента управления, используемое для именования продукта имя и цену за единицу текстовые поля в Вставка интерфейса и используются в границы `for` цикл, который задает `Text`свойства элементов управления TextBox обратно в пустую строку. Наконец, панелей `Visible` свойства сбрасываются, таким образом, чтобы интерфейс вставки скрыт и отображения интерфейса показано.

Отвлекитесь и проверьте страницу в браузере. При первом просмотре странице вы увидите интерфейс отображения, как было показано на рис. 5. Нажмите кнопку процесса поставки продукта. Будет обратной передачи страницы, и теперь вы увидите интерфейс вставки как показано на рис. 12. Щелкнув либо добавить продукты из отгрузки или «Отмена» снова отображения интерфейса.

> [!NOTE]
> При просмотре интерфейса вставки, Отвлекитесь и проверьте его CompareValidators на цену единицы текстовые поля. Вы должны увидеть окно messagebox клиентские предупреждение при нажатии кнопки Добавить продукты из кнопки отгрузки с недопустимым денежных значений или цены с значение меньше нуля.


[![Интерфейс вставки отображается после нажатия кнопки «обработать» поставки продукта](batch-inserting-cs/_static/image35.png)](batch-inserting-cs/_static/image34.png)

**Рис. 12**: Интерфейс вставки отображается после нажатия кнопки «обработать» поставки продукта ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image36.png))


## <a name="step-4-adding-the-products"></a>Шаг 4. Добавление продуктов

Это руководство представляет собой для сохранения продукты в базу данных в новый товар из s отгрузки кнопка остается `Click` обработчик событий. Это можно сделать, создав `ProductsDataTable` и добавление `ProductsRow` экземпляра для каждого из названий продуктов, которые предоставлены. Один раз они `ProductsRow` , которые были добавлены будет сделан вызов `ProductsBLL` класс s `UpdateWithTransaction` метод передавая `ProductsDataTable`. Помните, что `UpdateWithTransaction` метод, который был создан в [перенос изменений базы данных в транзакции](wrapping-database-modifications-within-a-transaction-cs.md) учебника, передает `ProductsDataTable` для `ProductsTableAdapter` s `UpdateWithTransaction` метод. После этого запускается транзакции ADO.NET и проблемы TableAdatper `INSERT` инструкции в базу данных для каждого добавленного `ProductsRow` в объекте DataTable. Предположим, что все продукты добавляются без ошибок, транзакция фиксируется, в противном случае она откатывается.

Код для добавить продукты из s кнопку отгрузки `Click` обработчик событий также требуется выполнить проверку ошибок. Так как не RequiredFieldValidators, используемый в интерфейсе правки, пользователь может ввести цену для продукта опустив его имя. Так как имя продукта s является обязательным, если такое состояние развертывания мы должны предупредить пользователя и не выполняйте операции вставки. Полный `Click` соответствует код обработчика событий:


[!code-csharp[Main](batch-inserting-cs/samples/sample6.cs)]

Обработчик событий начинается с обеспечения `Page.IsValid` свойство возвращает значение `true`. Если он возвращает `false`это означает, что один или несколько CompareValidators сообщаете недопустимые данные; в этом случае мы не хотим попытка вставить введенный продуктов и нажмите мы получим исключение при попытке назначить цена за единицу, введенный пользователем значение `ProductsRow` s `UnitPrice` свойство.

Далее, новый `ProductsDataTable` создается экземпляр (`products`). Объект `for` цикла используется для итерации по продукту имя и цену за единицу текстовые поля и `Text` свойства считываются в локальные переменные `productName` и `unitPrice`. Если пользователь ввел значение цены за единицу, но не имя соответствующего продукта `StatusLabel` отображает сообщение, если указать цену единицы, вы должны также включать имя продукта и выходе из обработчика событий.

Если указано имя продукта, новый `ProductsRow` создается экземпляр с помощью `ProductsDataTable` s `NewProductsRow` метод. Этот новый `ProductsRow` экземпляра s `ProductName` свойству текущего продукта имя текстового поля при `SupplierID` и `CategoryID` которых присвоены `SelectedValue` свойства элементов управления DropDownList в заголовке вставки интерфейса s. Если пользователь ввел значение цены продукта s, она назначается `ProductsRow` экземпляра s `UnitPrice` свойство; в противном случае свойство является слева без конкретного указания, что приведет к `NULL` значение `UnitPrice` в базе данных. Наконец `Discontinued` и `UnitsOnOrder` которых присвоены значения жестко `false` и 0 соответственно.

После свойства, назначенные `ProductsRow` он добавляется в экземпляр `ProductsDataTable`.

По завершении `for` цикла, мы проверяем, были ли добавлены все продукты. Пользователь может в конце концов, щелкнул добавить продукты из отгрузки перед вводом все названия продуктов или цены. Если имеется хотя бы один продукт в `ProductsDataTable`, `ProductsBLL` класс s `UpdateWithTransaction` вызывается метод. Далее, привязываются к `ProductsGrid` GridView так, чтобы отображались новые продукты в интерфейсе отображения. `StatusLabel` Обновляется и отображает сообщение с подтверждением и `ReturnToDisplayInterface` вызывается, скрытие интерфейсу правки и отображения отображения интерфейса.

Если продукты не были введены, но продукты не были добавлены сообщение отображается интерфейс вставки. Введите названия продуктов и отображается цены в текстовых полях.

S рис 13, 14 и 15 Показать вставку и отображать интерфейсы в действии. На рис. 13 что пользователь ввел значение цены единицы без соответствующего имени продукта. Рис. 14 показаны отображения интерфейса после трех новых продуктов были успешно добавлены, а рис. 15 двух продуктов, добавленный в GridView (третье — на предыдущей странице).


[![Название продукта — требуется при вводе цена за единицу](batch-inserting-cs/_static/image38.png)](batch-inserting-cs/_static/image37.png)

**Рис. 13**: Название продукта — требуется при вводе цена за единицу ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image39.png))


[![Для поставщика были добавлены три новые Veggies Mayumi s](batch-inserting-cs/_static/image41.png)](batch-inserting-cs/_static/image40.png)

**Рис. 14**: Три новых Veggies были добавлены для поставщика Mayumi s ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image42.png))


[![Новые продукты можно найти на последней странице элемента управления GridView](batch-inserting-cs/_static/image44.png)](batch-inserting-cs/_static/image43.png)

**Рис. 15**: Новые продукты можно найти на последней странице элемента управления GridView ([Просмотр полноразмерного изображения](batch-inserting-cs/_static/image45.png))


> [!NOTE]
> Вставка логики, используемой в этом руководстве пакета является оболочкой для операции вставки в пределах области транзакции. Чтобы проверить это, намеренно вызвать ошибку на уровне базы данных. Например, вместо того чтобы назначение нового `ProductsRow` экземпляра s `CategoryID` свойство для значения, выбранного в `Categories` DropDownList, назначить его значение, например `i * 5`. Здесь `i` является индексатором цикла и содержит значения в диапазоне от 1 до 5. Таким образом, при добавлении двух или более продуктов в пакетной службе вставьте первый продукт будет иметь допустимое `CategoryID` будет иметь значение (5), но последующие продуктов `CategoryID` значения, которые не соответствуют до `CategoryID` значения в `Categories` таблицы. В итоге получается, во время первого `INSERT` будет выполнена успешно, последующие завершится ошибкой с нарушением ограничения внешнего ключа. Так как Пакетная вставка является атомарной, первый `INSERT` будет выполнен откат, возврат базы данных в его состояние до пакетной вставки процесс начался.


## <a name="summary"></a>Сводка

В этом и предыдущем два учебника мы создали, позволяющих обновление, удаление, и вставка пакеты данных, которые использовать поддержку транзакций, мы добавили уровень доступа к данным в [перенос изменений базы данных в рамках транзакции](wrapping-database-modifications-within-a-transaction-cs.md) руководства. Для некоторых сценариев, такие интерфейсы пользователя пакетной обработки значительно повышают эффективность работы конечного пользователя сокращая вниз на количество щелчков, обратных вызовов и переключений контекста клавиатуры для мыши, одновременно сохраняя целостность базовых данных.

Этот учебник завершает наш взгляд на работа с пакетными данными. Следующий набор учебных курсов исследует различных сложных сценариях уровня доступа к данным, включая использование хранимых процедур в s методов класса TableAdapter, настройки уровня подключения и команды в DAL, шифрования строк подключения и многое другое!

Счастливого вам программирования!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP.NET и основатель веб- [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга — [ *Sams Teach ASP.NET 2.0 in 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Ним можно связаться по адресу [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Привести рецензентов в этом руководстве, были (Hilton giesenow) и S ren Алексей Lauritsen. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](batch-deleting-cs.md)
> [Вперед](wrapping-database-modifications-within-a-transaction-vb.md)
