---
uid: web-forms/overview/data-access/working-with-batched-data/batch-inserting-cs
title: Пакетная вставкаC#() | Документация Майкрософт
author: rick-anderson
description: Сведения о вставке нескольких записей базы данных в одну операцию. На уровне пользовательского интерфейса можно расширить GridView, чтобы пользователь вводил несколько n...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: cf025e08-48fc-4385-b176-8610aa7b5565
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/batch-inserting-cs
msc.type: authoredcontent
ms.openlocfilehash: 5dc4d0b6ac9bf3aa2baa54fe9f5d4149494e47d2
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78501450"
---
# <a name="batch-inserting-c"></a>Пакетная вставка (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_66_CS.zip) или [скачать PDF](batch-inserting-cs/_static/datatutorial66cs1.pdf)

> Сведения о вставке нескольких записей базы данных в одну операцию. На уровне пользовательского интерфейса можно расширить GridView, чтобы пользователь вводил несколько новых записей. На уровне доступа к данным мы заключим несколько операций вставки в транзакцию, чтобы гарантировать успешность всех вставок или отката всех вставок.

## <a name="introduction"></a>Введение

В руководстве по [пакетному обновлению](batch-updating-cs.md) мы рассматривали настройку элемента управления GridView для предоставления интерфейса, в котором несколько записей были изменены. Пользователь, посещающий страницу, может внести ряд изменений, а затем, нажав одну кнопку, выполнить пакетное обновление. В ситуациях, когда пользователи часто обновляют много записей в одном пути, такой интерфейс может сохранять бесчисленные щелчки и переключения контекста мыши по сравнению с функциями редактирования по умолчанию для отдельных строк, которые были впервые рассмотрены в [обзоре руководства по вставке, обновлению и удалению данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) .

Эта концепция также может применяться при добавлении записей. Представьте, что в компании Northwind мы обычно получаем поставки от поставщиков, которые содержат ряд продуктов для определенной категории. Например, мы можем получить отправку шести различных продуктов для чай и кофе от Токио. Если пользователь вводит шесть продуктов по одному за раз с помощью элемента управления DetailsView, ему нужно будет выбрать один и тот же параметр в одном и обратном порядке: им нужно будет выбрать одну и ту же категорию (напитки), одного и того же поставщика (Токио) и то же неподдерживаемое значение ( False) и те же единицы в значении заказа (0). Этот повторяющийся ввод данных не только занимает много времени, но и может привести к ошибкам.

С небольшой поработкой можно создать пакетный интерфейс вставки, позволяющий пользователю выбрать поставщика и категорию один раз, ввести ряд названий продуктов и цен на единицы, а затем нажать кнопку, чтобы добавить новые продукты в базу данных (см. рис. 1). По мере добавления каждого продукта его `ProductName` и `UnitPrice` полям данных присваиваются значения, введенные в текстовые поля, тогда как значения `CategoryID` и `SupplierID` присваиваются значения из элементов управления DropDownList в верхней части формы. Значения `Discontinued` и `UnitsOnOrder` задаются жестко запрограммированными значениями `false` и 0 соответственно.

[![интерфейса вставки пакетной службы](batch-inserting-cs/_static/image2.png)](batch-inserting-cs/_static/image1.png)

**Рис. 1**. интерфейс вставки пакетов ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image3.png))

В этом учебнике мы создадим страницу, которая реализует интерфейс вставки пакетной службы, показанный на рис. 1. Как и в предыдущих двух руководствах, мы будем переносить вставки внутри области транзакции, чтобы обеспечить атомарность. Давайте приступим к работе!

## <a name="step-1-creating-the-display-interface"></a>Шаг 1. Создание интерфейса дисплея

В этом учебнике будет состоять одна страница, разделенная на два региона: область экрана и область вставки. Интерфейс отображения, который мы создадим на этом шаге, отображает продукты в элементе управления GridView и включает кнопку «Обработка поставки продукта». При нажатии этой кнопки интерфейс отображения заменяется интерфейсом вставки, который показан на рис. 1. Интерфейс дисплея возвращается после нажатия кнопки Добавить продукты из отгрузки или отмены. Мы создадим интерфейс вставки на шаге 2.

При создании страницы с двумя интерфейсами, каждый из которых является видимым за раз, каждый интерфейс обычно помещается в [веб-элемент управления Panel](http://www.w3schools.com/aspnet/control_panel.asp), который служит контейнером для других элементов управления. Таким образом, на нашей странице будут два элемента управления Panel по одному для каждого интерфейса.

Для начала откройте страницу `BatchInsert.aspx` в папке `BatchData` и перетащите панель из панели элементов в конструктор (см. рис. 2). Задайте для свойства Panel `ID` значение `DisplayInterface`. При добавлении панели в конструктор его свойства `Height` и `Width` устанавливаются в 50px и 125px соответственно. Удалите эти значения свойств из окно свойств.

[![перетащить панель из панели элементов в конструктор](batch-inserting-cs/_static/image5.png)](batch-inserting-cs/_static/image4.png)

**Рис. 2**. Перетаскивание панели из панели элементов в конструктор ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image6.png))

Затем перетащите кнопку и элемент управления GridView на панель. Задайте для свойства Button `ID` значение `ProcessShipment` и его свойство `Text` для обработки отгрузки продукта. Задайте для свойства `ID` GridView s значение `ProductsGrid` и из его смарт-тега привяжите его к новому ObjectDataSource с именем `ProductsDataSource`. Настройте ObjectDataSource для извлечения данных из `GetProducts` метода `ProductsBLL` классов. Поскольку этот элемент GridView используется только для вывода данных, установите в раскрывающихся списках на вкладках обновление, вставка и удаление значение (нет). Нажмите кнопку Готово, чтобы завершить работу мастера настройки источника данных.

[![отобразить данные, возвращаемые методом ProductsBLL класса s](batch-inserting-cs/_static/image8.png)](batch-inserting-cs/_static/image7.png)

**Рис. 3**. Отображение данных, возвращаемых методом `GetProducts` `ProductsBLL` классов ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image9.png))

[![установить в раскрывающихся списках на вкладках обновления, вставки и удаления значение (нет)](batch-inserting-cs/_static/image11.png)](batch-inserting-cs/_static/image10.png)

**Рис. 4**. Установка раскрывающихся списков на вкладках обновления, вставки и удаления в (нет) ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image12.png))

После завершения работы мастера ObjectDataSource Visual Studio добавит BoundFields и CheckBoxField для полей данных продукта. Удалите все поля, кроме `ProductName`, `CategoryName`, `SupplierName`, `UnitPrice`и `Discontinued`. Вы можете делать любые настройки Aesthetic. Я решил отформатировать поле `UnitPrice` как денежное значение, переупорядочивая поля и переименовать несколько полей `HeaderText` значений. Также настройте GridView для включения поддержки разбиения по страницам и сортировки, установив флажки Включить разбиение по страницам и включить сортировку в смарт-теге GridView s.

После добавления элементов управления "панель", "Кнопка", "GridView" и "ObjectDataSource" и настройки полей "GridView s" декларативная разметка страницы должна выглядеть следующим образом:

[!code-aspx[Main](batch-inserting-cs/samples/sample1.aspx)]

Обратите внимание, что разметка для кнопки и GridView отображается в открывающих и закрывающих тегах `<asp:Panel>`. Так как эти элементы управления находятся на панели `DisplayInterface`, их можно скрыть, просто установив для свойства Panel `Visible` значение `false`. На шаге 3 рассматривается программное изменение свойства Panel `Visible` в ответ на нажатие кнопки для отображения одного интерфейса при скрытии другого.

Уделите время для просмотра хода выполнения в браузере. Как показано на рис. 5, вы увидите кнопку обработать отгрузку продукта над элементом GridView, который содержит десять продуктов за раз.

[![GridView перечисляет продукты и предлагает возможности сортировки и разбиения на страницы.](batch-inserting-cs/_static/image14.png)](batch-inserting-cs/_static/image13.png)

**Рис. 5**. элемент управления GridView перечисляет продукты и предлагает возможности сортировки и разбиения на страницы ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image15.png)).

## <a name="step-2-creating-the-inserting-interface"></a>Шаг 2. Создание интерфейса вставки

Теперь, когда интерфейс интерфейса дисплея завершен, мы повторно готовы к созданию интерфейса вставки. В этом руководстве мы создадим интерфейс вставки, запрашивающий одного поставщика и значения категории, а затем позволяющий пользователю ввести до пяти названий продуктов и значений цены за единицу. С помощью этого интерфейса пользователь может добавить до пяти новых продуктов, имеющих одну и ту же категорию и поставщика, но уникальные названия продуктов и цены.

Начните с перетаскивания панели из панели элементов в конструктор, разместив ее под существующей панелью `DisplayInterface`. Задайте для свойства `ID` этой вновь добавленной панели значение `InsertingInterface` и задайте для свойства `Visible` значение `false`. Мы добавим код, который задает для свойства Panel `InsertingInterface` `Visible` значение `true` на шаге 3. Также снимите флажки с `Height` и `Width` значений свойств на панели.

Далее необходимо создать интерфейс вставки, показанный на рис. 1. Этот интерфейс можно создать с помощью различных методов HTML, но мы будем использовать довольно простую таблицу: четыре столбца и семь строк.

> [!NOTE]
> При вводе разметки для HTML-элементов `<table>` я предпочитаю использовать представление исходного кода. Хотя в Visual Studio есть средства для добавления элементов `<table>` через конструктор, конструктор кажется, что он слишком готов к внедрению незапрашиваемых параметров `style` в разметку. После создания разметки `<table>` обычно возвращается в конструктор, чтобы добавить веб-элементы управления и задать их свойства. При создании таблиц с заранее определенными столбцами и строками я предпочитаю использовать статический HTML, а не [веб-элемент управления Table](https://msdn.microsoft.com/library/system.web.ui.webcontrols.table.aspx) , так как доступ к веб-элементам управления, размещенным в веб-элементе управления Table, возможен только с помощью шаблона `FindControl("controlID")`. Однако я использую табличные веб-элементы управления для динамически изменяемых таблиц (строк или столбцов, которые основываются на определенных базах данных или определенных пользователем условиях), так как веб-элемент управления Table может быть создан программным способом.

Введите следующую разметку в теги `<asp:Panel>` панели `InsertingInterface`:

[!code-html[Main](batch-inserting-cs/samples/sample2.html)]

Эта `<table>`ная разметка еще не содержит никаких веб-элементов управления, мы добавим их мгновенно. Обратите внимание, что каждый элемент `<tr>` содержит определенный параметр класса CSS: `BatchInsertHeaderRow` для строки заголовка, куда будут элементов управления DropDownList поставщик и Категория. `BatchInsertFooterRow` для строки нижнего колонтитула, куда переходят кнопки Добавить продукты из отгрузки и отмены. и чередование значений `BatchInsertRow` и `BatchInsertAlternatingRow` для строк, которые будут содержать элементы управления TextBox Product и Price. Я создал соответствующие классы CSS в файле `Styles.css`, чтобы обеспечить внешний вид интерфейса вставки, похожий на элементы управления GridView и DetailsView, которые использовались в этих руководствах. Ниже приведены эти классы CSS.

[!code-css[Main](batch-inserting-cs/samples/sample3.css)]

После введения этой разметки вернитесь к представление конструирования. Эта `<table>` должна отображаться в виде таблицы из четырех столбцов и семи строк в конструкторе, как показано на рис. 6.

[![интерфейс вставки состоит из таблицы из четырех столбцов и семи строк](batch-inserting-cs/_static/image17.png)](batch-inserting-cs/_static/image16.png)

**Рис. 6**. интерфейс вставки состоит из таблицы из четырех столбцов и семи строк ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image18.png)).

Теперь мы готовы к добавлению веб-элементов управления в интерфейс вставки. Перетащите два элементов управления DropDownList из области элементов в соответствующие ячейки таблицы, одну для поставщика, и одну для категории.

Задайте для свойства `ID` в DropDownList поставщика значение `Suppliers` и привяжите его к новому ObjectDataSource с именем `SuppliersDataSource`. Настройте новый элемент ObjectDataSource для получения данных из метода `SuppliersBLL` Class s `GetSuppliers` и установите в раскрывающемся списке вкладку обновления значение (нет). Нажмите кнопку Готово, чтобы завершить работу с мастером.

[![настроить ObjectDataSource для использования метода Супплиерсблл класса s](batch-inserting-cs/_static/image20.png)](batch-inserting-cs/_static/image19.png)

**Рис. 7**. Настройка ObjectDataSource для использования метода `GetSuppliers` `SuppliersBLL` классов ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image21.png))

По`Suppliers` DropDownList отображать поле данных `CompanyName` и использовать `SupplierID` поле данных в качестве значений `ListItem` s.

[![отобразить поле данных CompanyName и использовать значение КодПоставщика в качестве значения](batch-inserting-cs/_static/image23.png)](batch-inserting-cs/_static/image22.png)

**Рис. 8**. Отображение поля данных `CompanyName` и использование `SupplierID` в качестве значения ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image24.png))

Назовите второй элемент управления DropDownList `Categories` и привяжите его к новому ObjectDataSource с именем `CategoriesDataSource`. Настройте `CategoriesDataSource` ObjectDataSource для использования метода `CategoriesBLL` класса s `GetCategories`. Задайте для раскрывающихся списков на вкладках обновление и удаление значение (нет) и нажмите кнопку Готово, чтобы завершить работу мастера. Наконец, отобразите в DropDownList поле данных `CategoryName` и используйте в качестве значения `CategoryID`.

После добавления этих двух элементов управления DropDownList и их привязки к соответствующим настройкам ObjectDataSource экран должен выглядеть примерно так, как показано на рис. 9.

[![строка заголовка теперь содержит поставщики и категории элементов управления DropDownList](batch-inserting-cs/_static/image26.png)](batch-inserting-cs/_static/image25.png)

**Рис. 9**. Теперь строка заголовка содержит `Suppliers` и `Categories` элементов управления DropDownList ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image27.png))

Теперь необходимо создать текстовые поля для получения имени и цены для каждого нового продукта. Перетащите элемент управления TextBox из области элементов в конструктор для каждого из пяти строк «название продукта» и «цена». Задайте для свойств `ID` текстовых полей значение `ProductName1`, `UnitPrice1`, `ProductName2`, `UnitPrice2`, `ProductName3`, `UnitPrice3`и т. д.

Добавьте объект CompareValidator после каждого текстового поля Цена единицы, установив для свойства `ControlToValidate` соответствующее `ID`. Также задайте для свойства `Operator` значение `GreaterThanEqual`, `ValueToCompare` 0, а `Type` — `Currency`. Эти параметры указывают объекту CompareValidator убедиться, что цена, если она указана, является допустимым значением валюты, которое больше или равно нулю. Задайте для свойства `Text` значение \*, а `ErrorMessage` цена должна быть больше или равна нулю. Кроме того, не указывайте символы валют.

> [!NOTE]
> Интерфейс вставки не включает элементы управления RequiredFieldValidator, несмотря на то, что поле `ProductName` в таблице `Products` базы данных не допускает `NULL` значений. Это связано с тем, что мы хотим позволить пользователю ввести до пяти продуктов. Например, если пользователю было необходимо предоставить название продукта и цену за единицу для первых трех строк, в результате чего две последние строки будут пустыми, d просто добавит в систему три новых продукта. Поскольку требуется `ProductName`, необходимо программно проверить, чтобы убедиться, что если введена Цена за единицу, что указано соответствующее значение названия продукта. Мы рассмотрим эту проверку в шаге 4.

При проверке входных данных пользователя объект CompareValidator сообщает недопустимые данные, если значение содержит символ валюты. Добавьте «$» перед каждым текстовым полем «Цена», чтобы служить визуальной подсказкой, которая указывает пользователю опустить символ валюты при вводе цены.

Наконец, добавьте элемент управления ValidationSummary на панели `InsertingInterface`, применяет его свойство `ShowMessageBox` к `true` и его `ShowSummary` свойству значение `false`. С помощью этих параметров, если пользователь вводит недопустимое значение цены за единицу, рядом с элементами управления TextBox, вызвавшими ошибку, появится звездочка, и в ValidationSummary отобразится окно MessageBox на стороне клиента, в котором отображается сообщение об ошибке, указанное ранее.

На этом этапе экран должен выглядеть примерно так, как показано на рис. 10.

[![интерфейс вставки теперь включает текстовые поля для имен и цен продуктов.](batch-inserting-cs/_static/image29.png)](batch-inserting-cs/_static/image28.png)

**Рис. 10**. Теперь интерфейс вставки содержит текстовые поля для имен и цен продуктов ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image30.png)).

Далее необходимо добавить кнопки Добавить продукты из отгрузки и Отмена в строку нижнего колонтитула. Перетащите два элемента управления "Кнопка" из области элементов в нижний колонтитул интерфейса вставки, установив кнопки `ID` свойства для `AddProducts` и `CancelButton` и `Text` свойства, чтобы добавить продукты из отгрузки и отмены соответственно. Кроме того, задайте для свойства `CausesValidation` `CancelButton` управления значение `false`.

Наконец, необходимо добавить веб-элемент управления Label, который будет отображать сообщения о состоянии для двух интерфейсов. Например, когда пользователь успешно добавляет новую отгрузку продуктов, мы хотим вернуться к интерфейсу отображения и отобразить сообщение с подтверждением. Тем не менее, если пользователь предоставляет цену на новый продукт, но не содержит название продукта, необходимо отобразить предупреждение, так как поле `ProductName` является обязательным. Так как это сообщение необходимо отобразить для обоих интерфейсов, поместите его в верхнюю часть страницы за пределами панелей.

Перетащите элемент Web Control Label с панели элементов в верхнюю часть страницы в конструкторе. Задайте для свойства `ID` значение `StatusLabel`, очистите свойство `Text` и задайте для свойств `Visible` и `EnableViewState` значение `false`. Как мы видели в предыдущих учебных курсах, установка свойства `EnableViewState` в `false` позволяет программно изменять значения свойств метки s и автоматически возвратиться к параметрам по умолчанию при последующей обратной передаче. Это упрощает код для отображения сообщения о состоянии в ответ на некоторое действие пользователя, которое исчезает при последующей обратной передаче. Наконец, задайте для свойства `CssClass` `StatusLabel` управления значение Warning, которое представляет собой имя класса CSS, определенного в `Styles.css`, который отображает текст крупным курсивом, полужирным шрифтом красного цвета.

На рис. 11 показан конструктор Visual Studio после добавления и настройки метки.

[![поместить элемент управления значение statuslabel как над двумя элементами управления Panel](batch-inserting-cs/_static/image32.png)](batch-inserting-cs/_static/image31.png)

**Рис. 11**. размещение элемента управления `StatusLabel` над двумя элементами управления Panel ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image33.png))

## <a name="step-3-switching-between-the-display-and-inserting-interfaces"></a>Шаг 3. Переключение между интерфейсами дисплея и вставки

На этом этапе мы завершили разметку для наших интерфейсов вывода и вставки, но по-прежнему осталось выполнить две задачи:

- Переключение между интерфейсами дисплея и вставки
- Добавление продуктов в отгрузку в базу данных

В настоящее время интерфейс отображения является видимым, но интерфейс вставки скрыт. Это связано с тем, что свойство `Visible` панели `DisplayInterface` имеет значение `true` (значение по умолчанию), а свойство Panel `InsertingInterface` `Visible` имеет значение `false`. Для переключения между двумя интерфейсами необходимо просто переключить каждый элемент управления `Visible` значение свойства.

Мы хотим перейти от интерфейса к интерфейсу вставки при нажатии кнопки обработать отгрузку продукта. Поэтому создайте обработчик событий для этой кнопки `Click` событие, которое содержит следующий код:

[!code-csharp[Main](batch-inserting-cs/samples/sample4.cs)]

Этот код просто скрывает панель `DisplayInterface` и отображает панель `InsertingInterface`.

Затем создайте обработчики событий для элементов управления "добавить продукты из отгрузки" и "Отмена" в интерфейсе вставки. При нажатии любой из этих кнопок необходимо вернуться к интерфейсу интерфейса дисплея. Создайте `Click` обработчики событий для обоих элементов управления "Кнопка", чтобы они вызывали `ReturnToDisplayInterface`, метод, который мы будем добавлять мгновенно. Помимо скрытия панели `InsertingInterface` и отображения панели `DisplayInterface`, метод `ReturnToDisplayInterface` должен вернуть веб-элементы управления в состояние предварительного редактирования. Для этого необходимо задать для свойств элементов управления DropDownList `SelectedIndex` значение 0 и очистить свойства `Text` элементов управления TextBox.

> [!NOTE]
> Рассмотрим, что может произойти, если мы не возвращали элементы управления в состояние предварительного редактирования перед возвратом в интерфейс отображения. Пользователь может нажать кнопку обработать отгрузку продукта, ввести продукты из отгрузки, а затем щелкнуть Добавить продукты из отгрузки. Это приведет к добавлению продуктов и возврату пользователя интерфейсу отображения. На этом этапе пользователю может потребоваться добавить еще одну отгрузку. При нажатии кнопки обработать отгрузку продукта они возвращались к интерфейсу вставки, но значения выбора DropDownList и текстового поля по-прежнему будут заполнены предыдущими значениями.

[!code-csharp[Main](batch-inserting-cs/samples/sample5.cs)]

Оба `Click` обработчики событий просто вызывают метод `ReturnToDisplayInterface`, хотя мы вернемся к обработчику событий Add Products from поставка `Click` на шаге 4 и добавим код для сохранения продуктов. `ReturnToDisplayInterface` начинается с возврата `Suppliers` и `Categories` элементов управления DropDownList к их первым параметрам. Две константы `firstControlID` и `lastControlID` помечают начальные и конечные значения индекса управления, используемые при именовании текстовых полей Имя продукта и цена единицы в интерфейсе вставки и используемые в границах цикла `for`, который устанавливает свойства `Text` элементов управления TextBox обратно в пустую строку. Наконец, `Visible` свойства панели сбрасываются, чтобы интерфейс вставки был скрыт и отображался интерфейс отображения.

Уделите время для проверки этой страницы в браузере. При первом посещении страницы должен отобразиться интерфейс отображения, как показано на рис. 5. Нажмите кнопку обработать отгрузку продукта. Страница выполнит обратную передачу, и теперь вы увидите интерфейс вставки, как показано на рис. 12. Нажатие кнопки Добавить продукты из отгрузки или отмена возвращает вас в интерфейс дисплея.

> [!NOTE]
> При просмотре интерфейса вставки необходимо протестировать Компаревалидаторс в текстовых полях цены единицы. При нажатии кнопки Add Products from поставка с недопустимыми значениями денежной единицы или ценой со значением меньше нуля, отображается предупреждение MessageBox на стороне клиента.

[![интерфейс вставки отображается после нажатия кнопки обработать отгрузку продукта.](batch-inserting-cs/_static/image35.png)](batch-inserting-cs/_static/image34.png)

**Рис. 12**. интерфейс вставки отображается после нажатия кнопки обработать отгрузку продукта ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image36.png)).

## <a name="step-4-adding-the-products"></a>Шаг 4. Добавление продуктов

Все, что осталось для работы с этим руководством, — сохранить продукты в базе данных на кнопке Add Products from поставка `Click` обработчике событий. Это можно сделать, создав `ProductsDataTable` и добавив `ProductsRow` экземпляр для каждого из предоставленных названий продуктов. После добавления этих `ProductsRow`ов мы создадим метод `ProductsBLL` класса s `UpdateWithTransaction` метода, передавая `ProductsDataTable`. Помните, что метод `UpdateWithTransaction`, который был создан в процессе [переноса изменений базы данных в рамках руководства по транзакциям](wrapping-database-modifications-within-a-transaction-cs.md) , передает `ProductsDataTable` методу `ProductsTableAdapter` s `UpdateWithTransaction`. После этого запускается транзакция ADO.NET, и адаптер TableAdapter выдает в базу данных инструкцию `INSERT` для каждого добавленного `ProductsRow` в DataTable. При условии, что все продукты добавляются без ошибок, транзакция фиксируется, в противном случае выполняется ее откат.

Код для кнопки Add Products from поставка `Click` обработчику событий также должен выполнить несколько проверок ошибок. Так как в интерфейсе вставки не используется Рекуиредфиелдвалидаторс, пользователь может ввести цену на продукт, не пропуская его имя. Поскольку имя продукта является обязательным, если такое условие отменяется, необходимо предупредить пользователя и не продолжить вставку. Полный `Click` код обработчика событий выглядит следующим образом:

[!code-csharp[Main](batch-inserting-cs/samples/sample6.cs)]

Обработчик событий начинает работу, гарантируя, что свойство `Page.IsValid` возвращает значение `true`. Если он возвращает `false`, то это означает, что один или несколько Компаревалидаторс сообщают о недопустимых данных. в этом случае мы не хотим попытаться вставить введенные продукты, или мы получаем исключение при попытке присвоить введенное пользователем значение цены единицы свойству `ProductsRow` s `UnitPrice`.

Затем создается новый экземпляр `ProductsDataTable` (`products`). Цикл `for` используется для итерации текстовых полей Product Name и Price Unit, а свойства `Text` считываются в локальные переменные `productName` и `unitPrice`. Если пользователь вводит значение для цены за единицу, но не для соответствующего названия продукта, `StatusLabel` отображает сообщение, если вы указали цену за единицу, необходимо также включить имя продукта и обработчик событий.

Если указано имя продукта, создается новый экземпляр `ProductsRow` с помощью метода `ProductsDataTable` s `NewProductsRow`. В этом новом `ProductsRow` экземпляра `ProductName` свойству присваивается имя текущего продукта, а свойства `SupplierID` и `CategoryID` присваиваются свойствам `SelectedValue` элементов управления DropDownList в заголовке Interface s. Если пользователь указал значение цены продукта, он назначается свойству `ProductsRow` instance s `UnitPrice`. в противном случае свойство остается неназначенным, что приведет к появлению `NULL` значения для `UnitPrice` в базе данных. Наконец, свойства `Discontinued` и `UnitsOnOrder` присваиваются жестко закодированным значениям `false` и 0 соответственно.

После назначения свойств экземпляру `ProductsRow` он добавляется в `ProductsDataTable`.

По завершении цикла `for` мы проверяем, были ли добавлены какие либо продукты. Пользователь, в конце концов, щелкнул Добавление продуктов из отгрузки перед вводом названий продуктов или цен. Если в `ProductsDataTable`есть хотя бы один продукт, вызывается метод `ProductsBLL` класса s `UpdateWithTransaction`. Затем данные повторно привязываются к `ProductsGrid` GridView, чтобы новые добавленные продукты отображались в интерфейсе отображения. `StatusLabel` обновляется для отображения сообщения с подтверждением и вызова `ReturnToDisplayInterface`, скрытия интерфейса вставки и отображения интерфейса дисплея.

Если продукты не были введены, интерфейс вставки остается отображенным, но сообщение не было добавлено. Введите названия продуктов и цены единиц в текстовые поля.

На рис. 13, 14 и 15 показаны интерфейсы вставки и отображения в действии. На рис. 13 пользователь указал значение цены единицы без соответствующего названия продукта. На рис. 14 показан интерфейс отображения после успешного добавления трех новых продуктов, на рис. 15 показаны два недавно добавленных продукта в GridView (третья — на предыдущей странице).

[![имя продукта является обязательным при вводе цены за единицу](batch-inserting-cs/_static/image38.png)](batch-inserting-cs/_static/image37.png)

**Рис. 13**. имя продукта требуется при вводе цены за единицу ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image39.png))

[![добавлены три новых Веггиес для поставщика Mayumi's s](batch-inserting-cs/_static/image41.png)](batch-inserting-cs/_static/image40.png)

**Рис. 14**. добавлены три новых Веггиес для поставщика mayumi's s ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image42.png))

[![новые продукты можно найти на последней странице GridView.](batch-inserting-cs/_static/image44.png)](batch-inserting-cs/_static/image43.png)

**Рис. 15**. новые продукты можно найти на последней странице GridView ([щелкните, чтобы просмотреть изображение с полным размером](batch-inserting-cs/_static/image45.png)).

> [!NOTE]
> Логика вставки пакетной службы, используемая в этом руководстве, заключает операции вставки в область транзакции. Чтобы проверить это, намеренно ввести ошибку уровня базы данных. Например, вместо присвоения новому свойству `ProductsRow` экземпляра `CategoryID` выбранному значению в DropDownList `Categories` присвойте ему значение, например `i * 5`. Здесь `i` является индексатором цикла и имеет значения от 1 до 5. Поэтому при добавлении двух или более продуктов в пакетной вставке первый продукт будет иметь допустимое `CategoryID` значение (5), но последующие продукты будут иметь `CategoryID` значения, не соответствующие `CategoryID` значениям в таблице `Categories`. В итоге, в то время как первый `INSERT` будет успешным, последующие произойдет сбой с нарушением ограничения внешнего ключа. Поскольку Пакетная вставка является атомарной, выполняется откат первой `INSERT` и возвращение базы данных в ее состояние до начала процесса вставки пакета.

## <a name="summary"></a>Сводка

В этом и предыдущих двух учебных курсах мы создали интерфейсы, которые позволяют обновлять, удалять и вставлять пакеты данных, каждая из которых использовала поддержку транзакций, добавленную к слою доступа к данным в рамках руководства по [транзакциям изменения базы данных](wrapping-database-modifications-within-a-transaction-cs.md) . В некоторых случаях такие пользовательские интерфейсы пакетной обработки значительно улучшают эффективность работы конечных пользователей, выполняя количество щелчков, обратных передач и переключения контекста мыши, а также сохраняя целостность базовых данных.

В этом руководстве мы рассмотрим работу с пакетными данными. В следующем наборе руководств рассматриваются разнообразные сценарии расширенного доступа к данным, в том числе использование хранимых процедур в методах TableAdapter, Настройка параметров соединения и уровня команд в DAL, шифрование строк подключения и многое другое.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Ведущими рецензентами для этого учебника были Хилтон Гизнау и S REN Джейкоб Лауритсен. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](batch-deleting-cs.md)
> [Вперед](wrapping-database-modifications-within-a-transaction-vb.md)
