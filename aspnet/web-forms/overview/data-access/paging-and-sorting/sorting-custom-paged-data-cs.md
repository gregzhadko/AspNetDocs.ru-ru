---
uid: web-forms/overview/data-access/paging-and-sorting/sorting-custom-paged-data-cs
title: Сортировка настраиваемых данных на страницеC#() | Документация Майкрософт
author: rick-anderson
description: В предыдущем учебном курсе мы узнали, как реализовать пользовательское разбиение по страницам при представлении данных на веб-странице. В этом учебнике мы посмотрим, как расширить предыдущий...
ms.author: riande
ms.date: 08/15/2006
ms.assetid: 778baa4e-4af8-4665-947e-7a01d1a4dff2
msc.legacyurl: /web-forms/overview/data-access/paging-and-sorting/sorting-custom-paged-data-cs
msc.type: authoredcontent
ms.openlocfilehash: e55ed9b92814753e95bdfdf26c2f051df6f2630d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78476826"
---
# <a name="sorting-custom-paged-data-c"></a><span data-ttu-id="742c2-104">Упорядочение нестандартно разбитых по страницам данных (C#)</span><span class="sxs-lookup"><span data-stu-id="742c2-104">Sorting Custom Paged Data (C#)</span></span>

<span data-ttu-id="742c2-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="742c2-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="742c2-106">[Скачивание примера приложения](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_26_CS.exe) или [Загрузка PDF-файла](sorting-custom-paged-data-cs/_static/datatutorial26cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="742c2-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_26_CS.exe) or [Download PDF](sorting-custom-paged-data-cs/_static/datatutorial26cs1.pdf)</span></span>

> <span data-ttu-id="742c2-107">В предыдущем учебном курсе мы узнали, как реализовать пользовательское разбиение по страницам при представлении данных на веб-странице.</span><span class="sxs-lookup"><span data-stu-id="742c2-107">In the previous tutorial we learned how to implement custom paging when presenting data on a web page.</span></span> <span data-ttu-id="742c2-108">В этом учебнике мы видим, как расширить предыдущий пример, включив поддержку сортировки пользовательского разбиения по страницам.</span><span class="sxs-lookup"><span data-stu-id="742c2-108">In this tutorial we see how to extend the preceding example to include support for sorting custom paging.</span></span>

## <a name="introduction"></a><span data-ttu-id="742c2-109">Введение</span><span class="sxs-lookup"><span data-stu-id="742c2-109">Introduction</span></span>

<span data-ttu-id="742c2-110">По сравнению с разбиением по страницам по умолчанию, пользовательское разбиение по страницам может повысить производительность разбиения данных по нескольким порядковым показателям, делая пользовательский разбиение по страницам де-факто при разбиении больших объемов данных.</span><span class="sxs-lookup"><span data-stu-id="742c2-110">Compared to default paging, custom paging can improve the performance of paging through data by several orders of magnitude, making custom paging the de facto paging implementation choice when paging through large amounts of data.</span></span> <span data-ttu-id="742c2-111">Реализация пользовательского разбиения по страницам является более сложной, чем реализация разбиения по страницам по умолчанию, особенно при добавлении сортировки к набору.</span><span class="sxs-lookup"><span data-stu-id="742c2-111">Implementing custom paging is more involved than implementing default paging, however, especially when adding sorting to the mix.</span></span> <span data-ttu-id="742c2-112">В этом учебнике мы добавим пример из предыдущего, чтобы включить поддержку сортировки *и* пользовательского разбиения на страницы.</span><span class="sxs-lookup"><span data-stu-id="742c2-112">In this tutorial we'll extend the example from the preceding one to include support for sorting *and* custom paging.</span></span>

> [!NOTE]
> <span data-ttu-id="742c2-113">Поскольку этот учебник построен на предыдущем этапе, прежде чем начать создание декларативного синтаксиса в элементе `<asp:Content>` из предыдущей веб-страницы Tutorial (`EfficientPaging.aspx`) и вставить его между элементом `<asp:Content>` на странице `SortParameter.aspx`.</span><span class="sxs-lookup"><span data-stu-id="742c2-113">Since this tutorial builds upon the preceding one, before beginning take a moment to copy the declarative syntax within the `<asp:Content>` element from the preceding tutorial s web page (`EfficientPaging.aspx`) and paste it between the `<asp:Content>` element in the `SortParameter.aspx` page.</span></span> <span data-ttu-id="742c2-114">Дополнительные сведения о репликации функций одной ASP.NET страницы на другую см. в статье [Добавление элементов управления проверки в учебник по интерфейсам правки и вставки](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="742c2-114">Refer back to Step 1 of the [Adding Validation Controls to the Editing and Inserting Interfaces](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md) tutorial for a more detailed discussion on replicating the functionality of one ASP.NET page to another.</span></span>

## <a name="step-1-reexamining-the-custom-paging-technique"></a><span data-ttu-id="742c2-115">Шаг 1. Проверка пользовательского метода разбиения на страницы</span><span class="sxs-lookup"><span data-stu-id="742c2-115">Step 1: Reexamining the Custom Paging Technique</span></span>

<span data-ttu-id="742c2-116">Для правильной работы пользовательского разбиения по страницам необходимо реализовать некоторый метод, который может эффективно извлечь определенное подмножество записей, учитывая параметры "Индекс начальной строки" и "максимальное число строк".</span><span class="sxs-lookup"><span data-stu-id="742c2-116">For custom paging to work properly, we must implement some technique that can efficiently grab a particular subset of records given the Start Row Index and Maximum Rows parameters.</span></span> <span data-ttu-id="742c2-117">Для достижения этой цели можно использовать несколько методов.</span><span class="sxs-lookup"><span data-stu-id="742c2-117">There are a handful of techniques that can be used to achieve this aim.</span></span> <span data-ttu-id="742c2-118">В предыдущем учебном курсе мы рассматривали эту задачу с помощью Microsoft SQL Server 2005 s New `ROW_NUMBER()` ранжирующие функция.</span><span class="sxs-lookup"><span data-stu-id="742c2-118">In the preceding tutorial we looked at accomplishing this using Microsoft SQL Server 2005 s new `ROW_NUMBER()` ranking function.</span></span> <span data-ttu-id="742c2-119">Вкратце, функция ранжирования `ROW_NUMBER()` назначает номер строки каждой строке, возвращаемой запросом, который ранжирован по указанному порядку сортировки.</span><span class="sxs-lookup"><span data-stu-id="742c2-119">In short, the `ROW_NUMBER()` ranking function assigns a row number to each row returned by a query that is ranked by a specified sort order.</span></span> <span data-ttu-id="742c2-120">Затем нужно получить соответствующее подмножество записей, возвращая определенный раздел нумерованных результатов.</span><span class="sxs-lookup"><span data-stu-id="742c2-120">The appropriate subset of records is then obtained by returning a particular section of the numbered results.</span></span> <span data-ttu-id="742c2-121">В следующем запросе показано, как использовать этот метод для возврата продуктов с номерами от 11 до 20 при ранжировании результатов, упорядоченных в алфавитном порядке по `ProductName`:</span><span class="sxs-lookup"><span data-stu-id="742c2-121">The following query illustrates how to use this technique to return those products numbered 11 through 20 when ranking the results ordered alphabetically by the `ProductName`:</span></span>

[!code-sql[Main](sorting-custom-paged-data-cs/samples/sample1.sql)]

<span data-ttu-id="742c2-122">Этот метод хорошо подходит для разбиения на страницы с использованием определенного порядка сортировки (в данном случае`ProductName` сортируются в алфавитном порядке), но запрос необходимо изменить, чтобы отобразить результаты, отсортированные по другому выражению сортировки.</span><span class="sxs-lookup"><span data-stu-id="742c2-122">This technique works well for paging using a specific sort order (`ProductName` sorted alphabetically, in this case), but the query needs to be modified to show the results sorted by a different sort expression.</span></span> <span data-ttu-id="742c2-123">В идеале приведенный выше запрос может быть переписан для использования параметра в предложении `OVER` следующим образом:</span><span class="sxs-lookup"><span data-stu-id="742c2-123">Ideally, the above query could be rewritten to use a parameter in the `OVER` clause, like so:</span></span>

[!code-sql[Main](sorting-custom-paged-data-cs/samples/sample2.sql)]

<span data-ttu-id="742c2-124">К сожалению, параметризованные `ORDER BY` предложения не допускаются.</span><span class="sxs-lookup"><span data-stu-id="742c2-124">Unfortunately, parameterized `ORDER BY` clauses are not allowed.</span></span> <span data-ttu-id="742c2-125">Вместо этого необходимо создать хранимую процедуру, которая принимает входной параметр `@sortExpression`, но использует одно из следующих решений.</span><span class="sxs-lookup"><span data-stu-id="742c2-125">Instead, we must create a stored procedure that accepts a `@sortExpression` input parameter, but uses one of the following workarounds:</span></span>

- <span data-ttu-id="742c2-126">Напишите жестко запрограммированные запросы для каждого выражения сортировки, которое может использоваться; затем используйте `IF/ELSE` инструкции T-SQL, чтобы определить, какой запрос следует выполнить.</span><span class="sxs-lookup"><span data-stu-id="742c2-126">Write hard-coded queries for each of the sort expressions that may be used; then, use `IF/ELSE` T-SQL statements to determine which query to execute.</span></span>
- <span data-ttu-id="742c2-127">Используйте оператор `CASE` для предоставления динамических `ORDER BY` выражений на основе входного параметра `@sortExpressio` n; Дополнительные сведения см. в разделе Использование для динамической сортировки результатов запроса статьи [инструкции SQL `CASE`](http://www.4guysfromrolla.com/webtech/102704-1.shtml) .</span><span class="sxs-lookup"><span data-stu-id="742c2-127">Use a `CASE` statement to provide dynamic `ORDER BY` expressions based on the `@sortExpressio` n input parameter; see the Used to Dynamically Sort Query Results section in [The Power of SQL `CASE` Statements](http://www.4guysfromrolla.com/webtech/102704-1.shtml) for more information.</span></span>
- <span data-ttu-id="742c2-128">Создание соответствующего запроса в виде строки в хранимой процедуре, а затем использование [`sp_executesql` системной хранимой процедуры](https://msdn.microsoft.com/library/ms188001.aspx) для выполнения динамического запроса.</span><span class="sxs-lookup"><span data-stu-id="742c2-128">Craft the appropriate query as a string in the stored procedure and then use [the `sp_executesql` system stored procedure](https://msdn.microsoft.com/library/ms188001.aspx) to execute the dynamic query.</span></span>

<span data-ttu-id="742c2-129">Каждое из этих решений имеет определенные недостатки.</span><span class="sxs-lookup"><span data-stu-id="742c2-129">Each of these workarounds has some drawbacks.</span></span> <span data-ttu-id="742c2-130">Первый вариант не так, как и другие два, так как он требует создания запроса для каждого возможного выражения сортировки.</span><span class="sxs-lookup"><span data-stu-id="742c2-130">The first option is not as maintainable as the other two as it requires that you create a query for each possible sort expression.</span></span> <span data-ttu-id="742c2-131">Таким образом, если позже вы решили добавить в GridView новые поля с возможностью сортировки, потребуется вернуться и обновить хранимую процедуру.</span><span class="sxs-lookup"><span data-stu-id="742c2-131">Therefore, if later you decide to add new, sortable fields to the GridView you will also need to go back and update the stored procedure.</span></span> <span data-ttu-id="742c2-132">Второй подход имеет некоторые тонкости, которые приводят к снижению производительности при сортировке по столбцам нестроковой базы данных, и при этом возникают те же проблемы, что и в первом случае.</span><span class="sxs-lookup"><span data-stu-id="742c2-132">The second approach has some subtleties that introduce performance concerns when sorting by non-string database columns and also suffers from the same maintainability issues as the first.</span></span> <span data-ttu-id="742c2-133">Третий вариант, в котором используется динамический SQL, представляет риск для атаки путем внедрения кода SQL, если злоумышленник может выполнить хранимую процедуру, передав значения входных параметров по своему выбору.</span><span class="sxs-lookup"><span data-stu-id="742c2-133">And the third choice, which uses dynamic SQL, introduces the risk for a SQL injection attack if an attacker is able to execute the stored procedure passing in the input parameter values of their choosing.</span></span>

<span data-ttu-id="742c2-134">Хотя ни один из этих подходов не является идеальным, я думаю, что третий вариант является лучшим из трех.</span><span class="sxs-lookup"><span data-stu-id="742c2-134">While none of these approaches is perfect, I think the third option is the best of the three.</span></span> <span data-ttu-id="742c2-135">Благодаря использованию динамического SQL он предлагает уровень гибкости, отличный от двух других.</span><span class="sxs-lookup"><span data-stu-id="742c2-135">With its use of dynamic SQL, it offers a level of flexibility the other two do not.</span></span> <span data-ttu-id="742c2-136">Более того, атака путем внедрения кода SQL может быть использована только в том случае, если злоумышленник сможет выполнить хранимую процедуру, передав входные параметры по своему усмотрению.</span><span class="sxs-lookup"><span data-stu-id="742c2-136">Furthermore, a SQL injection attack can only be exploited if an attacker is able to execute the stored procedure passing in the input parameters of his choice.</span></span> <span data-ttu-id="742c2-137">Поскольку DAL использует параметризованные запросы, ADO.NET будет защищать эти параметры, которые отправляются в базу данных через архитектуру, что означает, что уязвимость атаки путем внедрения кода SQL существует только в том случае, если злоумышленник может напрямую выполнить хранимую процедуру.</span><span class="sxs-lookup"><span data-stu-id="742c2-137">Since the DAL uses parameterized queries, ADO.NET will protect those parameters that are sent to the database through the architecture, meaning that the SQL injection attack vulnerability only exists if the attacker can directly execute the stored procedure.</span></span>

<span data-ttu-id="742c2-138">Чтобы реализовать эту функцию, создайте новую хранимую процедуру в базе данных Northwind с именем `GetProductsPagedAndSorted`.</span><span class="sxs-lookup"><span data-stu-id="742c2-138">To implement this functionality, create a new stored procedure in the Northwind database named `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="742c2-139">Эта хранимая процедура должна принимать три входных параметра: `@sortExpression`, входной параметр типа `nvarchar(100`), который указывает, как результаты должны быть отсортированы и добавлены непосредственно после текста `ORDER BY` в предложении `OVER`. и `@startRowIndex` и `@maximumRows`те же два целочисленных входных параметра из `GetProductsPaged` хранимой процедуры, проверенных в предыдущем руководстве.</span><span class="sxs-lookup"><span data-stu-id="742c2-139">This stored procedure should accept three input parameters: `@sortExpression`, an input parameter of type `nvarchar(100`) that specifies how the results should be sorted and is injected directly after the `ORDER BY` text in the `OVER` clause; and `@startRowIndex` and `@maximumRows`, the same two integer input parameters from the `GetProductsPaged` stored procedure examined in the preceding tutorial.</span></span> <span data-ttu-id="742c2-140">Создайте `GetProductsPagedAndSorted` хранимую процедуру, используя следующий скрипт:</span><span class="sxs-lookup"><span data-stu-id="742c2-140">Create the `GetProductsPagedAndSorted` stored procedure using the following script:</span></span>

[!code-sql[Main](sorting-custom-paged-data-cs/samples/sample3.sql)]

<span data-ttu-id="742c2-141">Хранимая процедура начинается с того, что указано значение параметра `@sortExpression`.</span><span class="sxs-lookup"><span data-stu-id="742c2-141">The stored procedure starts by ensuring that a value for the `@sortExpression` parameter has been specified.</span></span> <span data-ttu-id="742c2-142">Если он отсутствует, результаты ранжированы по `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="742c2-142">If it is missing, the results are ranked by `ProductID`.</span></span> <span data-ttu-id="742c2-143">Далее создается динамический запрос SQL.</span><span class="sxs-lookup"><span data-stu-id="742c2-143">Next, the dynamic SQL query is constructed.</span></span> <span data-ttu-id="742c2-144">Обратите внимание, что динамический запрос SQL немного отличается от предыдущих запросов, использовавшихся для получения всех строк из таблицы Products.</span><span class="sxs-lookup"><span data-stu-id="742c2-144">Note that the dynamic SQL query here differs slightly from our previous queries used to retrieve all rows from the Products table.</span></span> <span data-ttu-id="742c2-145">В предыдущих примерах мы получили для каждого продукта связанные категории и имена поставщиков с помощью вложенного запроса.</span><span class="sxs-lookup"><span data-stu-id="742c2-145">In prior examples, we obtained each product s associated category s and supplier s names using a subquery.</span></span> <span data-ttu-id="742c2-146">Это решение было принято в учебнике [Создание уровня доступа к данным](../introduction/creating-a-data-access-layer-cs.md) и было сделано вместо использования `JOIN` s, так как TableAdapter не может автоматически создавать связанные методы вставки, обновления и удаления для таких запросов.</span><span class="sxs-lookup"><span data-stu-id="742c2-146">This decision was made back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) tutorial and was done in lieu of using `JOIN` s because the TableAdapter cannot automatically create the associated insert, update, and delete methods for such queries.</span></span> <span data-ttu-id="742c2-147">Однако `GetProductsPagedAndSorted` хранимая процедура должна использовать `JOIN` s, чтобы результаты упорядочивались по именам категорий или поставщиков.</span><span class="sxs-lookup"><span data-stu-id="742c2-147">The `GetProductsPagedAndSorted` stored procedure, however, must use `JOIN` s for the results to be ordered by the category or supplier names.</span></span>

<span data-ttu-id="742c2-148">Этот динамический запрос строится путем сцепления статических частей запроса и параметров `@sortExpression`, `@startRowIndex`и `@maximumRows`.</span><span class="sxs-lookup"><span data-stu-id="742c2-148">This dynamic query is built up by concatenating the static query portions and the `@sortExpression`, `@startRowIndex`, and `@maximumRows` parameters.</span></span> <span data-ttu-id="742c2-149">Поскольку `@startRowIndex` и `@maximumRows` являются целочисленными параметрами, они должны быть преобразованы в nvarchar для правильного сцепления.</span><span class="sxs-lookup"><span data-stu-id="742c2-149">Since `@startRowIndex` and `@maximumRows` are integer parameters, they must be converted into nvarchars in order to be correctly concatenated.</span></span> <span data-ttu-id="742c2-150">После создания динамического SQL-запроса он выполняется с помощью `sp_executesql`.</span><span class="sxs-lookup"><span data-stu-id="742c2-150">Once this dynamic SQL query has been constructed, it is executed via `sp_executesql`.</span></span>

<span data-ttu-id="742c2-151">Уделите несколько минут тестированию этой хранимой процедуры с различными значениями параметров `@sortExpression`, `@startRowIndex`и `@maximumRows`.</span><span class="sxs-lookup"><span data-stu-id="742c2-151">Take a moment to test this stored procedure with different values for the `@sortExpression`, `@startRowIndex`, and `@maximumRows` parameters.</span></span> <span data-ttu-id="742c2-152">В обозреватель сервера щелкните правой кнопкой мыши имя хранимой процедуры и выберите команду выполнить.</span><span class="sxs-lookup"><span data-stu-id="742c2-152">From the Server Explorer, right-click on the stored procedure name and choose Execute.</span></span> <span data-ttu-id="742c2-153">Откроется диалоговое окно Запуск хранимой процедуры, в котором можно ввести входные параметры (см. рис. 1).</span><span class="sxs-lookup"><span data-stu-id="742c2-153">This will bring up the Run Stored Procedure dialog box into which you can enter the input parameters (see Figure 1).</span></span> <span data-ttu-id="742c2-154">Чтобы отсортировать результаты по имени категории, используйте категорию CategoryName для значения параметра `@sortExpression`. для сортировки по названию компании поставщика используйте CompanyName.</span><span class="sxs-lookup"><span data-stu-id="742c2-154">To sort the results by the category name, use CategoryName for the `@sortExpression` parameter value; to sort by the supplier s company name, use CompanyName.</span></span> <span data-ttu-id="742c2-155">Указав значения параметров, нажмите кнопку ОК.</span><span class="sxs-lookup"><span data-stu-id="742c2-155">After providing the parameters values, click OK.</span></span> <span data-ttu-id="742c2-156">Результаты отображаются в окне Вывод.</span><span class="sxs-lookup"><span data-stu-id="742c2-156">The results are displayed in the Output window.</span></span> <span data-ttu-id="742c2-157">На рис. 2 показаны результаты при возврате продуктов с рангами от 11 до 20 при упорядочении по `UnitPrice` в порядке убывания.</span><span class="sxs-lookup"><span data-stu-id="742c2-157">Figure 2 shows the results when returning products ranked 11 through 20 when ordering by the `UnitPrice` in descending order.</span></span>

![Попробуйте использовать другие значения для хранимой процедуры с тремя входными параметрами](sorting-custom-paged-data-cs/_static/image1.png)

<span data-ttu-id="742c2-159">**Рис. 1**. Попробуйте использовать другие значения для хранимой процедуры с тремя входными параметрами</span><span class="sxs-lookup"><span data-stu-id="742c2-159">**Figure 1**: Try Different Values for the Stored Procedure s Three Input Parameters</span></span>

<span data-ttu-id="742c2-160">[![результаты хранимых процедур отображаются в окно вывода](sorting-custom-paged-data-cs/_static/image3.png)](sorting-custom-paged-data-cs/_static/image2.png)</span><span class="sxs-lookup"><span data-stu-id="742c2-160">[![The Stored Procedure s Results are Shown in the Output Window](sorting-custom-paged-data-cs/_static/image3.png)](sorting-custom-paged-data-cs/_static/image2.png)</span></span>

<span data-ttu-id="742c2-161">**Рис. 2**. Результаты хранимых процедур отображаются в окно вывода ([щелкните, чтобы просмотреть изображение с полным размером](sorting-custom-paged-data-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="742c2-161">**Figure 2**: The Stored Procedure s Results are Shown in the Output Window ([Click to view full-size image](sorting-custom-paged-data-cs/_static/image4.png))</span></span>

> [!NOTE]
> <span data-ttu-id="742c2-162">При ранжировании результатов по указанному столбцу `ORDER BY` в предложении `OVER` SQL Server необходимо отсортировать результаты.</span><span class="sxs-lookup"><span data-stu-id="742c2-162">When ranking the results by the specified `ORDER BY` column in the `OVER` clause, SQL Server must sort the results.</span></span> <span data-ttu-id="742c2-163">Это быстрая операция, если имеется кластеризованный индекс по столбцам, в котором упорядочиваются результаты, или если имеется индекс покрытия, но в противном случае он может оказаться более дорогостоящим.</span><span class="sxs-lookup"><span data-stu-id="742c2-163">This is a quick operation if there is a clustered index over the column(s) the results are being ordered by or if there is a covering index, but can be more costly otherwise.</span></span> <span data-ttu-id="742c2-164">Чтобы повысить производительность для достаточно больших запросов, рассмотрите возможность добавления некластеризованного индекса для столбца, по которому упорядочиваются результаты.</span><span class="sxs-lookup"><span data-stu-id="742c2-164">To improve performance for sufficiently large queries, consider adding a non-clustered index for the column by which the results are ordered by.</span></span> <span data-ttu-id="742c2-165">Дополнительные сведения см. в разделе [ранжирующие функции и производительность в SQL Server 2005](http://www.sql-server-performance.com/ak_ranking_functions.asp) .</span><span class="sxs-lookup"><span data-stu-id="742c2-165">Refer to [Ranking Functions and Performance in SQL Server 2005](http://www.sql-server-performance.com/ak_ranking_functions.asp) for more details.</span></span>

## <a name="step-2-augmenting-the-data-access-and-business-logic-layers"></a><span data-ttu-id="742c2-166">Шаг 2. дополнение уровней доступа к данным и бизнес-логики</span><span class="sxs-lookup"><span data-stu-id="742c2-166">Step 2: Augmenting the Data Access and Business Logic Layers</span></span>

<span data-ttu-id="742c2-167">После создания `GetProductsPagedAndSorted` хранимой процедуры наш следующий шаг заключается в предоставлении средств для выполнения этой хранимой процедуры через нашу архитектуру приложения.</span><span class="sxs-lookup"><span data-stu-id="742c2-167">With the `GetProductsPagedAndSorted` stored procedure created, our next step is to provide a means to execute that stored procedure through our application architecture.</span></span> <span data-ttu-id="742c2-168">Это влечет за собой добавление соответствующего метода в DAL и BLL.</span><span class="sxs-lookup"><span data-stu-id="742c2-168">This entails adding an appropriate method to both the DAL and BLL.</span></span> <span data-ttu-id="742c2-169">Начнем с добавления метода в DAL.</span><span class="sxs-lookup"><span data-stu-id="742c2-169">Let s start by adding a method to the DAL.</span></span> <span data-ttu-id="742c2-170">Откройте `Northwind.xsd` типизированный набор данных, щелкните правой кнопкой мыши `ProductsTableAdapter`и выберите пункт Добавить запрос в контекстном меню.</span><span class="sxs-lookup"><span data-stu-id="742c2-170">Open the `Northwind.xsd` Typed DataSet, right-click on the `ProductsTableAdapter`, and choose the Add Query option from the context menu.</span></span> <span data-ttu-id="742c2-171">Как мы делали в предыдущем учебном курсе, мы хотим настроить этот новый метод DAL для использования существующей хранимой процедуры, `GetProductsPagedAndSorted`в данном случае.</span><span class="sxs-lookup"><span data-stu-id="742c2-171">As we did in the preceding tutorial, we want to configure this new DAL method to use an existing stored procedure - `GetProductsPagedAndSorted`, in this case.</span></span> <span data-ttu-id="742c2-172">Начните с указания того, что новый метод TableAdapter должен использовать существующую хранимую процедуру.</span><span class="sxs-lookup"><span data-stu-id="742c2-172">Start by indicating that you want the new TableAdapter method to use an existing stored procedure.</span></span>

![Выберите использование существующей хранимой процедуры](sorting-custom-paged-data-cs/_static/image5.png)

<span data-ttu-id="742c2-174">**Рис. 3**. Выбор использования существующей хранимой процедуры</span><span class="sxs-lookup"><span data-stu-id="742c2-174">**Figure 3**: Choose to Use an Existing Stored Procedure</span></span>

<span data-ttu-id="742c2-175">Чтобы указать используемую хранимую процедуру, выберите `GetProductsPagedAndSorted` хранимая процедура из раскрывающегося списка на следующем экране.</span><span class="sxs-lookup"><span data-stu-id="742c2-175">To specify the stored procedure to use, select the `GetProductsPagedAndSorted` stored procedure from the drop-down list in the next screen.</span></span>

![Использование хранимой процедуры Жетпродуктспажедандсортед](sorting-custom-paged-data-cs/_static/image6.png)

<span data-ttu-id="742c2-177">**Рис. 4**. использование хранимой процедуры жетпродуктспажедандсортед</span><span class="sxs-lookup"><span data-stu-id="742c2-177">**Figure 4**: Use the GetProductsPagedAndSorted Stored Procedure</span></span>

<span data-ttu-id="742c2-178">Эта хранимая процедура возвращает набор записей в виде результатов, поэтому на следующем экране указывается, что он возвращает табличные данные.</span><span class="sxs-lookup"><span data-stu-id="742c2-178">This stored procedure returns a set of records as its results so, in the next screen, indicate that it returns tabular data.</span></span>

![Указывает, что хранимая процедура возвращает табличные данные](sorting-custom-paged-data-cs/_static/image7.png)

<span data-ttu-id="742c2-180">**Рис. 5**. Указание того, что хранимая процедура возвращает табличные данные</span><span class="sxs-lookup"><span data-stu-id="742c2-180">**Figure 5**: Indicate that the Stored Procedure Returns Tabular Data</span></span>

<span data-ttu-id="742c2-181">Наконец, создайте методы DAL, которые используют и заполнение таблицы DataTable, и возвращают шаблоны DataTable, имена методов `FillPagedAndSorted` и `GetProductsPagedAndSorted`соответственно.</span><span class="sxs-lookup"><span data-stu-id="742c2-181">Finally, create DAL methods that use both the Fill a DataTable and Return a DataTable patterns, naming the methods `FillPagedAndSorted` and `GetProductsPagedAndSorted`, respectively.</span></span>

![Выбор имен методов](sorting-custom-paged-data-cs/_static/image8.png)

<span data-ttu-id="742c2-183">**Рис. 6**. Выбор имен методов</span><span class="sxs-lookup"><span data-stu-id="742c2-183">**Figure 6**: Choose the Methods Names</span></span>

<span data-ttu-id="742c2-184">Теперь, когда мы расширили DAL, мы повторно готовы к переходу на слой BLL.</span><span class="sxs-lookup"><span data-stu-id="742c2-184">Now that we ve extended the DAL, we re ready to turn to the BLL.</span></span> <span data-ttu-id="742c2-185">Откройте файл `ProductsBLL` класса и добавьте новый метод `GetProductsPagedAndSorted`.</span><span class="sxs-lookup"><span data-stu-id="742c2-185">Open the `ProductsBLL` class file and add a new method, `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="742c2-186">Этот метод должен принимать три входных параметра `sortExpression`, `startRowIndex`и `maximumRows` и следует просто вызвать метод DAL s `GetProductsPagedAndSorted` следующим образом:</span><span class="sxs-lookup"><span data-stu-id="742c2-186">This method needs to accept three input parameters `sortExpression`, `startRowIndex`, and `maximumRows` and should simply call down into the DAL s `GetProductsPagedAndSorted` method, like so:</span></span>

[!code-csharp[Main](sorting-custom-paged-data-cs/samples/sample4.cs)]

## <a name="step-3-configuring-the-objectdatasource-to-pass-in-the-sortexpression-parameter"></a><span data-ttu-id="742c2-187">Шаг 3. Настройка элемента ObjectDataSource для передачи в параметр SortExpression</span><span class="sxs-lookup"><span data-stu-id="742c2-187">Step 3: Configuring the ObjectDataSource to Pass in the SortExpression Parameter</span></span>

<span data-ttu-id="742c2-188">Добавив DAL и BLL для включения методов, использующих хранимую процедуру `GetProductsPagedAndSorted`, остается только настроить ObjectDataSource на странице `SortParameter.aspx`, чтобы использовать новый метод BLL и передать параметр `SortExpression` на основе столбца, который пользователь запросил для сортировки результатов.</span><span class="sxs-lookup"><span data-stu-id="742c2-188">Having augmented the DAL and BLL to include methods that utilize the `GetProductsPagedAndSorted` stored procedure, all that remains is to configure the ObjectDataSource in the `SortParameter.aspx` page to use the new BLL method and to pass in the `SortExpression` parameter based on the column that the user has requested to sort the results by.</span></span>

<span data-ttu-id="742c2-189">Начните с изменения `SelectMethod` ObjectDataSource s с `GetProductsPaged` на `GetProductsPagedAndSorted`.</span><span class="sxs-lookup"><span data-stu-id="742c2-189">Start by changing the ObjectDataSource s `SelectMethod` from `GetProductsPaged` to `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="742c2-190">Это можно сделать с помощью мастера настройки источника данных, из окно свойств или непосредственно с помощью декларативного синтаксиса.</span><span class="sxs-lookup"><span data-stu-id="742c2-190">This can be done through the Configure Data Source wizard, from the Properties window, or directly through the declarative syntax.</span></span> <span data-ttu-id="742c2-191">Далее необходимо предоставить значение для [Свойства ObjectDataSource`SortParameterName`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sortparametername.aspx).</span><span class="sxs-lookup"><span data-stu-id="742c2-191">Next, we need to provide a value for the ObjectDataSource s [`SortParameterName` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sortparametername.aspx).</span></span> <span data-ttu-id="742c2-192">Если это свойство задано, ObjectDataSource пытается передать в `SelectMethod`свойство `SortExpression` GridView s.</span><span class="sxs-lookup"><span data-stu-id="742c2-192">If this property is set, the ObjectDataSource attempts to pass in the GridView s `SortExpression` property to the `SelectMethod`.</span></span> <span data-ttu-id="742c2-193">В частности, ObjectDataSource ищет входной параметр, имя которого равно значению свойства `SortParameterName`.</span><span class="sxs-lookup"><span data-stu-id="742c2-193">In particular, the ObjectDataSource looks for an input parameter whose name is equal to the value of the `SortParameterName` property.</span></span> <span data-ttu-id="742c2-194">Так как метод BLL `GetProductsPagedAndSorted` имеет входной параметр Expression сортировки с именем `sortExpression`, задайте для свойства ObjectDataSource `SortExpression` значение sortExpression.</span><span class="sxs-lookup"><span data-stu-id="742c2-194">Since the BLL s `GetProductsPagedAndSorted` method has the sort expression input parameter named `sortExpression`, set the ObjectDataSource s `SortExpression` property to sortExpression .</span></span>

<span data-ttu-id="742c2-195">После внесения этих двух изменений декларативный синтаксис ObjectDataSource s должен выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="742c2-195">After making these two changes, the ObjectDataSource s declarative syntax should look similar to the following:</span></span>

[!code-aspx[Main](sorting-custom-paged-data-cs/samples/sample5.aspx)]

> [!NOTE]
> <span data-ttu-id="742c2-196">Как и в предыдущем руководстве, убедитесь, что ObjectDataSource не *включает* входные параметры SortExpression, StartRowIndex или maximumRows в коллекцию SelectParameters.</span><span class="sxs-lookup"><span data-stu-id="742c2-196">As with the preceding tutorial, ensure that the ObjectDataSource does *not* include the sortExpression, startRowIndex, or maximumRows input parameters in its SelectParameters collection.</span></span>

<span data-ttu-id="742c2-197">Чтобы включить сортировку в GridView, просто установите флажок Enable Sort (включить сортировку) в смарт-теге GridView s, который задает для свойства `AllowSorting` GridView s значение `true` и вызывает визуализацию текста заголовка для каждого столбца в виде элемента управления LinkButton.</span><span class="sxs-lookup"><span data-stu-id="742c2-197">To enable sorting in the GridView, simply check the Enable Sorting checkbox in the GridView s smart tag, which sets the GridView s `AllowSorting` property to `true` and causing the header text for each column to be rendered as a LinkButton.</span></span> <span data-ttu-id="742c2-198">Когда пользователь щелкает одну из заголовков LinkButton, происходит обратная передача и выполняются следующие действия:</span><span class="sxs-lookup"><span data-stu-id="742c2-198">When the end user clicks on one of the header LinkButtons, a postback ensues and the following steps transpire:</span></span>

1. <span data-ttu-id="742c2-199">GridView обновляет [свойство`SortExpression`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.sortexpression.aspx) на значение `SortExpression` поля, для которого была нажата ссылка заголовка</span><span class="sxs-lookup"><span data-stu-id="742c2-199">The GridView updates its [`SortExpression` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.sortexpression.aspx) to the value of the `SortExpression` of the field whose header link was clicked</span></span>
2. <span data-ttu-id="742c2-200">ObjectDataSource вызывает метод `GetProductsPagedAndSorted` BLL, передавая свойство GridView s `SortExpression` в качестве значения для метода s `sortExpression` входного параметра (вместе с соответствующими значениями входных параметров `startRowIndex` и `maximumRows`).</span><span class="sxs-lookup"><span data-stu-id="742c2-200">The ObjectDataSource invokes the BLL s `GetProductsPagedAndSorted` method, passing in the GridView s `SortExpression` property as the value for the method s `sortExpression` input parameter (along with the appropriate `startRowIndex` and `maximumRows` input parameter values)</span></span>
3. <span data-ttu-id="742c2-201">BLL вызывает метод DAL `GetProductsPagedAndSorted`</span><span class="sxs-lookup"><span data-stu-id="742c2-201">The BLL invokes the DAL s `GetProductsPagedAndSorted` method</span></span>
4. <span data-ttu-id="742c2-202">DAL выполняет `GetProductsPagedAndSorted` хранимую процедуру, передавая параметр `@sortExpression` (вместе со значениями входных параметров `@startRowIndex` и `@maximumRows`).</span><span class="sxs-lookup"><span data-stu-id="742c2-202">The DAL executes the `GetProductsPagedAndSorted` stored procedure, passing in the `@sortExpression` parameter (along with the `@startRowIndex` and `@maximumRows` input parameter values)</span></span>
5. <span data-ttu-id="742c2-203">Хранимая процедура возвращает соответствующее подмножество данных BLL, который возвращает его в ObjectDataSource; Затем эти данные привязываются к GridView, подготавливаются к просмотру в формате HTML и отправляются конечному пользователю.</span><span class="sxs-lookup"><span data-stu-id="742c2-203">The stored procedure returns the appropriate subset of data to the BLL, which returns it to the ObjectDataSource; this data is then bound to the GridView, rendered into HTML, and sent down to the end user</span></span>

<span data-ttu-id="742c2-204">На рис. 7 показана первая страница результатов при сортировке по `UnitPrice` в возрастающем порядке.</span><span class="sxs-lookup"><span data-stu-id="742c2-204">Figure 7 shows the first page of results when sorted by the `UnitPrice` in ascending order.</span></span>

<span data-ttu-id="742c2-205">[![результаты сортируются по UnitPrice](sorting-custom-paged-data-cs/_static/image10.png)](sorting-custom-paged-data-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="742c2-205">[![The Results are Sorted by the UnitPrice](sorting-custom-paged-data-cs/_static/image10.png)](sorting-custom-paged-data-cs/_static/image9.png)</span></span>

<span data-ttu-id="742c2-206">**Рис. 7**. Результаты сортируются по UnitPrice ([щелкните, чтобы просмотреть изображение с полным размером](sorting-custom-paged-data-cs/_static/image11.png))</span><span class="sxs-lookup"><span data-stu-id="742c2-206">**Figure 7**: The Results are Sorted by the UnitPrice ([Click to view full-size image](sorting-custom-paged-data-cs/_static/image11.png))</span></span>

<span data-ttu-id="742c2-207">Хотя текущая реализация может правильно отсортировать результаты по названию продукта, имени категории, количеству на единицу и цене за единицу, попытка упорядочить результаты по имени поставщика приводит к возникновению исключения времени выполнения (см. рис. 8).</span><span class="sxs-lookup"><span data-stu-id="742c2-207">While the current implementation can correctly sort the results by product name, category name, quantity per unit, and unit price, attempting to order the results by the supplier name results in a runtime exception (see Figure 8).</span></span>

![Попытка отсортировать результаты по поставщику приводит к возникновению следующего исключения среды выполнения](sorting-custom-paged-data-cs/_static/image12.png)

<span data-ttu-id="742c2-209">**Рис. 8**. попытка отсортировать результаты по поставщику приводит к возникновению следующего исключения среды выполнения</span><span class="sxs-lookup"><span data-stu-id="742c2-209">**Figure 8**: Attempting to Sort the Results by the Supplier Results in the Following Runtime Exception</span></span>

<span data-ttu-id="742c2-210">Это исключение возникает, поскольку `SortExpression` GridView s `SupplierName` BoundField имеет значение `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="742c2-210">This exception occurs because the `SortExpression` of the GridView s `SupplierName` BoundField is set to `SupplierName`.</span></span> <span data-ttu-id="742c2-211">Однако имя поставщика в таблице `Suppliers` на самом деле называется `CompanyName` мы назвали имя этого столбца как `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="742c2-211">However, the supplier s name in the `Suppliers` table is actually called `CompanyName` we have been aliased this column name as `SupplierName`.</span></span> <span data-ttu-id="742c2-212">Однако предложение `OVER`, используемое функцией `ROW_NUMBER()`, не может использовать псевдоним и должно использовать фактическое имя столбца.</span><span class="sxs-lookup"><span data-stu-id="742c2-212">However, the `OVER` clause used by the `ROW_NUMBER()` function cannot use the alias and must use the actual column name.</span></span> <span data-ttu-id="742c2-213">Поэтому измените `SupplierName` BoundField s `SortExpression` SupplierName на CompanyName (см. рис. 9).</span><span class="sxs-lookup"><span data-stu-id="742c2-213">Therefore, change the `SupplierName` BoundField s `SortExpression` from SupplierName to CompanyName (see Figure 9).</span></span> <span data-ttu-id="742c2-214">Как показано на рис. 10, после этого изменения результаты могут быть отсортированы по поставщику.</span><span class="sxs-lookup"><span data-stu-id="742c2-214">As Figure 10 shows, after this change the results can be sorted by the supplier.</span></span>

![Измените SortExpression SupplierName BoundField s на CompanyName.](sorting-custom-paged-data-cs/_static/image13.png)

<span data-ttu-id="742c2-216">**Рис. 9**. изменение SupplierName BoundField s SortExpression на CompanyName</span><span class="sxs-lookup"><span data-stu-id="742c2-216">**Figure 9**: Change the SupplierName BoundField s SortExpression to CompanyName</span></span>

<span data-ttu-id="742c2-217">[![теперь результаты можно отсортировать по поставщику](sorting-custom-paged-data-cs/_static/image15.png)](sorting-custom-paged-data-cs/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="742c2-217">[![The Results Can Now Be Sorted by Supplier](sorting-custom-paged-data-cs/_static/image15.png)](sorting-custom-paged-data-cs/_static/image14.png)</span></span>

<span data-ttu-id="742c2-218">**Рис. 10**. Теперь результаты можно сортировать по поставщикам ([щелкните, чтобы просмотреть изображение с полным размером](sorting-custom-paged-data-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="742c2-218">**Figure 10**: The Results Can Now Be Sorted by Supplier ([Click to view full-size image](sorting-custom-paged-data-cs/_static/image16.png))</span></span>

## <a name="summary"></a><span data-ttu-id="742c2-219">Сводка</span><span class="sxs-lookup"><span data-stu-id="742c2-219">Summary</span></span>

<span data-ttu-id="742c2-220">Реализация пользовательского разбиения по страницам, которую мы рассматривали в предыдущем руководстве, требовала, чтобы порядок сортировки результатов был указан во время разработки.</span><span class="sxs-lookup"><span data-stu-id="742c2-220">The custom paging implementation we examined in the preceding tutorial required that the order by which the results were to be sorted be specified at design time.</span></span> <span data-ttu-id="742c2-221">Вкратце, это означало, что реализация пользовательского разбиения по страницам, которую мы реализовали, не может в то же время предоставить возможности сортировки.</span><span class="sxs-lookup"><span data-stu-id="742c2-221">In short, this meant that the custom paging implementation we implemented could not, at the same time, provide sorting capabilities.</span></span> <span data-ttu-id="742c2-222">В этом учебнике мы преодолел все испытания это ограничение, расширив хранимую процедуру из первого, чтобы включить входной параметр `@sortExpression`, по которому можно сортировать результаты.</span><span class="sxs-lookup"><span data-stu-id="742c2-222">In this tutorial we overcame this limitation by extending the stored procedure from the first to include a `@sortExpression` input parameter by which the results could be sorted.</span></span>

<span data-ttu-id="742c2-223">После создания этой хранимой процедуры и создания новых методов в слоях DAL и BLL мы смогли реализовать GridView, которое предлагает как сортировку, так и настраиваемое разбиение на страницы, настроив ObjectDataSource для передачи свойства Current `SortExpression` в GridView s в `SelectMethod`BLL.</span><span class="sxs-lookup"><span data-stu-id="742c2-223">After creating this stored procedure and creating new methods in the DAL and BLL, we were able to implement a GridView that offered both sorting and custom paging by configuring the ObjectDataSource to pass in the GridView s current `SortExpression` property to the BLL `SelectMethod`.</span></span>

<span data-ttu-id="742c2-224">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="742c2-224">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="742c2-225">Об авторе</span><span class="sxs-lookup"><span data-stu-id="742c2-225">About the Author</span></span>

<span data-ttu-id="742c2-226">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998.</span><span class="sxs-lookup"><span data-stu-id="742c2-226">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="742c2-227">Скотт работает как независимый консультант, преподаватель и модуль записи.</span><span class="sxs-lookup"><span data-stu-id="742c2-227">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="742c2-228">Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="742c2-228">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="742c2-229">Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="742c2-229">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="742c2-230">или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="742c2-230">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="742c2-231">Специальная благодарность</span><span class="sxs-lookup"><span data-stu-id="742c2-231">Special Thanks To</span></span>

<span data-ttu-id="742c2-232">Эта серия руководств была рассмотрена многими полезными рецензентами.</span><span class="sxs-lookup"><span data-stu-id="742c2-232">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="742c2-233">Специалист по интересу для этого руководства был Карлос Сантос.</span><span class="sxs-lookup"><span data-stu-id="742c2-233">Lead reviewer for this tutorial was Carlos Santos.</span></span> <span data-ttu-id="742c2-234">Хотите ознакомиться с моими будущими статьями MSDN?</span><span class="sxs-lookup"><span data-stu-id="742c2-234">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="742c2-235">Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="742c2-235">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="742c2-236">[Назад](efficiently-paging-through-large-amounts-of-data-cs.md)
> [Вперед](creating-a-customized-sorting-user-interface-cs.md)</span><span class="sxs-lookup"><span data-stu-id="742c2-236">[Previous](efficiently-paging-through-large-amounts-of-data-cs.md)
[Next](creating-a-customized-sorting-user-interface-cs.md)</span></span>
