---
uid: web-forms/overview/data-access/paging-and-sorting/paging-and-sorting-report-data-cs
title: Разбиение на страницы и сортировкаC#данных отчета () | Документация Майкрософт
author: rick-anderson
description: Разбиение на страницы и сортировка — две очень распространенные функции при отображении данных в интерактивном приложении. В этом учебнике мы рассмотрим добавление сортировки и...
ms.author: riande
ms.date: 08/15/2006
ms.assetid: 811a6ef2-ec66-4c8e-a089-6f795056e288
msc.legacyurl: /web-forms/overview/data-access/paging-and-sorting/paging-and-sorting-report-data-cs
msc.type: authoredcontent
ms.openlocfilehash: 2f77040316dadc218b8183e52628dc0cfe3b35a1
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74587012"
---
# <a name="paging-and-sorting-report-data-c"></a>Разбиение по страницам и упорядочение данных отчета (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_24_CS.exe) или [Загрузка PDF-файла](paging-and-sorting-report-data-cs/_static/datatutorial24cs1.pdf)

> Разбиение на страницы и сортировка — две очень распространенные функции при отображении данных в интерактивном приложении. В этом учебнике мы рассмотрим добавление сортировки и разбиения по страницам к нашим отчетам, которые затем будут создаваться на следующих учебных курсах.

## <a name="introduction"></a>Введение

Разбиение на страницы и сортировка — две очень распространенные функции при отображении данных в интерактивном приложении. Например, при поиске книг ASP.NET в книжном магазине могут содержаться сотни таких книг, но в отчете, в котором отображаются результаты поиска, отображается только десять соответствий на страницу. Кроме того, результаты можно отсортировать по заголовку, цене, количеству страниц, имени автора и т. д. Хотя последние 23 учебников проверили, как создавать разнообразные отчеты, включая интерфейсы, позволяющие добавлять, изменять и удалять данные, мы не рассматривали, как сортировать данные, и только те примеры разбиения на страницы были просмотрены с помощью DetailsView и FormView элементы управления.

В этом учебнике мы посмотрим, как добавить в наши отчеты сортировку и разбиение по страницам, что можно сделать, просто установив несколько флажков. К сожалению, Эта упрощенная реализация имеет свои недостатки, поэтому интерфейс сортировки остается нежелательным, а подпрограммы разбиения по страницам не предназначены для эффективного разбиения по большим результирующим наборам. В следующих учебных курсах будет рассказано, как преодолеть ограничения готовых решений по разбиению на страницы и упорядочения.

## <a name="step-1-adding-the-paging-and-sorting-tutorial-web-pages"></a>Шаг 1. Добавление веб-страниц учебника по разбиению по страницам и сортировке

Прежде чем приступить к работе с этим руководством, давайте сначала добавим страницы ASP.NET, которые понадобятся для работы с этим руководством и следующих трех. Начните с создания новой папки в проекте с именем `PagingAndSorting`. Затем добавьте в эту папку следующие пять страниц ASP.NET, чтобы все они были настроены для использования главной страницы `Site.master`:

- `Default.aspx`
- `SimplePagingSorting.aspx`
- `EfficientPaging.aspx`
- `SortParameter.aspx`
- `CustomSortingUI.aspx`

![Создание папки PagingAndSorting и добавление страниц Tutorial ASP.NET](paging-and-sorting-report-data-cs/_static/image1.png)

**Рис. 1**. Создание папки PagingAndSorting и добавление страниц Tutorial ASP.NET

Затем откройте страницу `Default.aspx` и перетащите `SectionLevelTutorialListing.ascx` пользовательский элемент управления из папки `UserControls` в область конструктора. Этот пользовательский элемент управления, созданный при работе с [главными страницами и](../introduction/master-pages-and-site-navigation-cs.md) руководством по навигации по сайту, перечисляет карту узла и отображает эти руководства в текущем разделе в маркированном списке.

![Добавление пользовательского элемента управления SectionLevelTutorialListing. ascx в Default. aspx](paging-and-sorting-report-data-cs/_static/image2.png)

**Рис. 2**. Добавление пользовательского элемента управления SectionLevelTutorialListing. ascx в Default. aspx

Чтобы в маркированном списке отображались учебники по разбиению на страницы и сортировка, которые будут созданы, необходимо добавить их на карту узла. Откройте файл `Web.sitemap` и добавьте следующую разметку после разметки узла "изменение", "Вставка" и "удаление".

[!code-xml[Main](paging-and-sorting-report-data-cs/samples/sample1.xml)]

![Обновление схемы узла для включения новых страниц ASP.NET](paging-and-sorting-report-data-cs/_static/image3.png)

**Рис. 3**. обновление схемы узла для включения новых страниц ASP.NET

## <a name="step-2-displaying-product-information-in-a-gridview"></a>Шаг 2. Отображение сведений о продукте в элементе управления GridView

Прежде чем реализовать возможности разбиения по страницам и сортировки, давайте сначала создадим Стандартный несортируемый, нестраничный элемент управления GridView, содержащий сведения о продукте. Это задача, которую мы много раз сделали в рамках этой серии руководств, поэтому эти действия должны быть знакомы. Для начала откройте страницу `SimplePagingSorting.aspx` и перетащите элемент управления GridView с панели инструментов в конструктор, установив для свойства `ID` значение `Products`. Затем создайте новый элемент ObjectDataSource, использующий метод `GetProducts()` класса ProductsBLL для возврата всей информации о продукте.

![Получение сведений обо всех продуктах с помощью метода Products ()](paging-and-sorting-report-data-cs/_static/image4.png)

**Рис. 4**. Получение сведений обо всех продуктах с помощью метода Products ()

Так как отчет является отчетом только для чтения, нет необходимости сопоставлять методы `Insert()`, `Update()`или `Delete()` с соответствующими методами `ProductsBLL`. Поэтому выберите (нет) в раскрывающемся списке для вкладок обновления, вставки и удаления.

![Выберите параметр (нет) в раскрывающемся списке на вкладках обновить, вставить и удалить.](paging-and-sorting-report-data-cs/_static/image5.png)

**Рис. 5**. Выбор параметра (нет) в раскрывающемся списке на вкладках «обновить», «вставить» и «удалить»

Теперь давайте настроим поля GridView s таким образом, чтобы отображались только названия продуктов, поставщики, категории, цены и неподдерживаемые состояния. Более того, вы можете изменять форматирование на уровне полей, например настраивать свойства `HeaderText` или форматировать цену как валюту. После этих изменений декларативная разметка GridView s должна выглядеть следующим образом:

[!code-aspx[Main](paging-and-sorting-report-data-cs/samples/sample2.aspx)]

На рис. 6 показан ход работы в браузере. Обратите внимание, что на странице перечислены все продукты на одном экране, в которых отображаются названия, категории, поставщики, цены и состояние "снято с производства".

[![все продукты перечислены](paging-and-sorting-report-data-cs/_static/image7.png)](paging-and-sorting-report-data-cs/_static/image6.png)

**Рис. 6**. список всех продуктов ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image8.png))

## <a name="step-3-adding-paging-support"></a>Шаг 3. Добавление поддержки разбиения по страницам

Список *всех* продуктов на одном экране может привести к перегрузке информации для пользователя, который извлечет данные. Чтобы сделать результаты более управляемыми, можно разбить данные на меньшие страницы данных и позволить пользователю пошаговое выполнение данных по одной странице за раз. Для этого просто установите флажок Включить разбиение по страницам из смарт-тега GridView s (при этом [свойству`AllowPaging`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.allowpaging.aspx) GridView s задается значение `true`).

[![установите флажок Включить разбиение по страницам, чтобы добавить поддержку разбиения по страницам](paging-and-sorting-report-data-cs/_static/image10.png)](paging-and-sorting-report-data-cs/_static/image9.png)

**Рис. 7**. Установка флажка "включить разбиение на страницы" для добавления поддержки разбиения по страницам ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image11.png))

Включение разбиения на страницы ограничивает количество записей, отображаемых на странице, и добавляет *интерфейс разбиения по страницам* в GridView. Интерфейс разбиения по страницам по умолчанию, показанный на рис. 7, — это серия номеров страниц, позволяющая пользователю быстро переходить с одной страницы данных на другую. Этот интерфейс разбиения по страницам должен быть знакомым, так как мы видели его при добавлении поддержки разбиения по страницам к элементам управления DetailsView и FormView в прошлых учебных курсах.

Элементы управления DetailsView и FormView отображают только одну запись на страницу. Однако GridView обращается к своему [свойству`PageSize`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.pagesize.aspx) , чтобы определить количество записей, отображаемых на странице (по умолчанию это свойство имеет значение 10).

Этот интерфейс разбиения по страницам GridView, DetailsView и FormView можно настроить с помощью следующих свойств:

- `PagerStyle` указывает сведения о стиле для интерфейса разбиения на страницы; можно указать такие параметры, как `BackColor`, `ForeColor`, `CssClass`, `HorizontalAlign`и т. д.
- `PagerSettings` содержит множество свойств, которые могут настраивать функциональность интерфейса разбиения по страницам. `PageButtonCount` указывает максимальное число номеров страниц, отображаемых в интерфейсе разбиения на страницы (по умолчанию — 10); [свойство`Mode`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.pagersettings.mode.aspx) указывает, как работает интерфейс разбиения по страницам и может принимать следующие значения: 

    - `NextPrevious` показаны кнопки «Далее» и «назад», позволяющие пользователю переходить вперед или назад на одну страницу за раз.
    - `NextPreviousFirstLast` в дополнение к кнопкам "Далее" и "назад", также включены первая и Последняя кнопки, что позволяет пользователю быстро перейти на первую или последнюю страницу данных.
    - `Numeric` показывает ряд номеров страниц, позволяя пользователю сразу перейти к любой странице.
    - `NumericFirstLast` в дополнение к номерам страниц, включает в себя первую и последнюю кнопки, позволяя пользователю быстро перейти на первую или последнюю страницу данных; кнопки Первая и последняя отображаются только в том случае, если не удается уместить все числовые номера страниц

Более того, GridView, DetailsView и FormView предлагают свойства `PageIndex` и `PageCount`, которые указывают текущую просматриваемую страницу и общее количество страниц данных соответственно. Свойство `PageIndex` индексируется начиная с 0, что означает, что при просмотре первой страницы данных `PageIndex` будет равно 0. `PageCount`, с другой стороны, начинает подсчитать 1, что означает, что `PageIndex` ограничены значениями от 0 до `PageCount - 1`.

Подождите немного, чтобы улучшить внешний вид интерфейса разбиения по страницам GridView s. В частности, добавим интерфейс разбиения по страницам вправо с помощью светло-серого фона. Вместо того, чтобы задавать эти свойства напрямую через свойство `PagerStyle` GridView s, давайте создадим класс CSS в `Styles.css` с именем `PagerRowStyle`, а затем присвоить свойство `CssClass` `PagerStyle` с помощью нашей темы. Сначала откройте `Styles.css` и добавьте следующее определение класса CSS:

[!code-css[Main](paging-and-sorting-report-data-cs/samples/sample3.css)]

Затем откройте файл `GridView.skin` в папке `DataWebControls` в папке `App_Themes`. Как мы обсуждали в учебнике « *главные страницы и Навигация по узлу* », файлы обложки можно использовать для указания значений свойств по умолчанию для веб-элемента управления. Таким образом, дополните существующие параметры, дополняя установку свойства `PagerStyle` s `CssClass` в значение `PagerRowStyle`. Кроме того, давайте настроим интерфейс разбиения на страницы, чтобы отображать не более пяти кнопок с числовыми страницами, используя интерфейс разбиения по страницам `NumericFirstLast`.

[!code-aspx[Main](paging-and-sorting-report-data-cs/samples/sample4.aspx)]

## <a name="the-paging-user-experience"></a>Пользовательский интерфейс разбиения по страницам

На рис. 8 показана веб-страница при посещении через браузер после установки флажка "включить разбиение по страницам в GridView s" и настройки `PagerStyle` и `PagerSettings` в `GridView.skin`ном файле. Обратите внимание, что отображается только десять записей, а интерфейс разбиения по страницам указывает, что мы просматриваем первую страницу данных.

[![с включенным разбиением на страницы в каждый момент времени отображается только подмножество записей.](paging-and-sorting-report-data-cs/_static/image13.png)](paging-and-sorting-report-data-cs/_static/image12.png)

**Рис. 8**. при включенном разбиении по страницам в каждый момент времени отображается только подмножество записей ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image14.png))

Когда пользователь щелкает один из номеров страниц в интерфейсе разбиения по страницам, выполняется обратная передача, и страница перегружается, отображая запрошенные записи. На рис. 9 показаны результаты после продолжений для просмотра последней страницы данных. Обратите внимание, что последняя страница содержит только одну запись; Это связано с тем, что в итоге имеется 81 записей, что приводит к восьми страницам из 10 записей на страницу и одной странице с отдельной записью.

[![щелчком номера страницы вызывается обратная передача и отображается соответствующее подмножество записей.](paging-and-sorting-report-data-cs/_static/image16.png)](paging-and-sorting-report-data-cs/_static/image15.png)

**Рис. 9**. щелчок номера страницы вызывает обратную передачу и отображает соответствующее подмножество записей ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image17.png))

## <a name="paging-s-server-side-workflow"></a>Рабочий процесс на стороне сервера с разбивкой на страницы

Когда пользователь нажимает кнопку в интерфейсе разбиения по страницам, происходит обратная передача, и начинается следующий рабочий процесс на стороне сервера:

1. Вызывается событие `PageIndexChanging` GridView s (или DetailsView или FormView)
2. ObjectDataSource повторно запрашивает *все* данные из BLL; значения свойств `PageIndex` и `PageSize` GridView используются для определения того, какие записи, возвращаемые BLL, должны отображаться в GridView.
3. Вызывается событие `PageIndexChanged` GridView s

На шаге 2 элемент управления ObjectDataSource повторно запрашивает все данные из источника данных. Этот стиль разбиения на страницы обычно называется *разбиением по страницам по умолчанию*, так как он используется по умолчанию при установке свойства `AllowPaging` в значение `true`. При использовании разбиения по страницам по умолчанию веб-элемент управления данными упрощает получение всех записей для каждой страницы данных, несмотря на то, что только подмножество записей фактически подготавливается к просмотру в формате HTML, отправленном в браузер. Если данные базы данных не кэшируются в BLL или ObjectDataSource, разбиение по страницам по умолчанию неработоспособно для достаточно больших наборов результатов или для веб-приложений с большим числом параллельных пользователей.

В следующем учебном курсе мы рассмотрим, как реализовать *пользовательское разбиение по страницам*. С помощью пользовательского разбиения по страницам можно указать, что ObjectDataSource получает только точный набор записей, необходимых для запрошенной страницы данных. Как можно себе представить, пользовательское разбиение по страницам значительно повышает эффективность разбиения на страницы больших результирующих наборов.

> [!NOTE]
> Хотя разбиение по страницам по умолчанию не подходит при подсчете достаточно большого количества результирующих наборов или для сайтов с множеством одновременных пользователей, следует понимать, что для пользовательского разбиения на страницы требуется больше изменений и усилий для реализации и не так просто установить флажок (как по умолчанию разбиение на страницы). Таким образом, подкачка по умолчанию может быть идеальным выбором для небольших веб-сайтов с низким трафиком или при разбиении по страницам относительно небольших результирующих наборов, так как она намного проще и быстрее реализуется.

Например, если мы уверены, что в нашей базе данных не будет более 100 продуктов, минимальный выигрыш в производительности, получаемый с помощью пользовательского разбиения по страницам, скорее всего, будет смещен на усилия, необходимые для его реализации. Но если, однако, у нас может быть тысячи или десятков тысяч продуктов, *не* реализация пользовательского разбиения по страницам будет существенно препятствовать масштабируемости нашего приложения.

## <a name="step-4-customizing-the-paging-experience"></a>Шаг 4. Настройка интерфейса разбиения по страницам

Веб-элементы управления данными предоставляют ряд свойств, которые можно использовать для повышения удобства работы с разбиением на страницы пользователя. Например, свойство `PageCount` указывает, сколько всего страниц имеется, а свойство `PageIndex` указывает на текущую просматриваемую страницу и может быть настроено для быстрого перемещения пользователя на определенную страницу. Чтобы продемонстрировать, как использовать эти свойства для улучшения процесса разбиения по страницам пользователей, добавим к нашей странице веб-элемент управления Label, который информирует пользователя о том, какую страницу в данный момент посещает, а также элемент управления DropDownList, позволяющий быстро перейти к любой странице. .

Сначала добавьте на страницу веб-элемент управления Label, задайте для его свойства `ID` значение `PagingInformation`и удалите свойство `Text`. Затем создайте обработчик событий для события `DataBound` GridView s и добавьте следующий код:

[!code-csharp[Main](paging-and-sorting-report-data-cs/samples/sample5.cs)]

Этот обработчик событий назначает свойству `PagingInformation` Label `Text` сообщение, информирующее пользователя о том, что на данный момент находится страница, на которой он находится, `Products.PageIndex + 1` о том, сколько всего страниц `Products.PageCount` (мы добавили 1 к свойству `Products.PageIndex`, так как `PageIndex` индексируется, начиная с 0). В отличие от обработчика событий `PageIndexChanged` я выбрал свойство назначить эту метку s `Text` в обработчике событий `DataBound`, так как событие `DataBound` срабатывает каждый раз, когда данные привязаны к GridView, а обработчик событий `PageIndexChanged` срабатывает только при изменении индекса страницы. Когда элемент управления GridView изначально привязан к данным на первом посещении страницы, `PageIndexChanging` событие не срабатывает (в то время как `DataBound` событие).

Благодаря этому пользователю отображается сообщение, показывающее, на какой странице они находятся, и сколько всего страниц данных.

[![отображаются номер текущей страницы и общее количество страниц.](paging-and-sorting-report-data-cs/_static/image19.png)](paging-and-sorting-report-data-cs/_static/image18.png)

**Рис. 10**. Отображение номера текущей страницы и общего числа страниц ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image20.png))

Кроме элемента управления Label, добавим элемент управления DropDownList, который перечисляет номера страниц в GridView с выбранной просматриваемой страницей. Идея в том, что пользователь может быстро перейти с текущей страницы на другую, просто выбрав новый индекс страницы из DropDownList. Для начала добавьте элемент DropDownList в конструктор, задав для его свойства `ID` значение `PageList` и установив флажок Включить автообратную передачу из своего смарт-тега.

Затем вернитесь к обработчику событий `DataBound` и добавьте следующий код:

[!code-csharp[Main](paging-and-sorting-report-data-cs/samples/sample6.cs)]

Этот код начинается с очистки элементов в элементе DropDownList `PageList`. Это может показаться излишним, поскольку в одном из них не должно быть изменено число страниц, но другие пользователи могут одновременно использовать систему, добавляя или удаляя записи из таблицы `Products`. Такие операции вставки или удаления могут изменить количество страниц данных.

Затем необходимо еще раз создать номера страниц и сопоставить его с текущим `PageIndex` GridView, выбранном по умолчанию. Это достигается с помощью цикла от 0 до `PageCount - 1`, добавления нового `ListItem` в каждой итерации и присвоения свойству `Selected` значения true, если текущий индекс итерации равен свойству `PageIndex` GridView s.

Наконец, необходимо создать обработчик событий для события DropDownList `SelectedIndexChanged`, которое срабатывает каждый раз, когда пользователь выбирает другой элемент из списка. Чтобы создать этот обработчик событий, просто дважды щелкните элемент DropDownList в конструкторе, а затем добавьте следующий код:

[!code-csharp[Main](paging-and-sorting-report-data-cs/samples/sample7.cs)]

Как показано на рис. 11, простое изменение свойства `PageIndex` GridView s приводит к повторной привязке данных к GridView. В обработчике событий `DataBound` GridView s выбрано соответствующее `ListItem` DropDownList.

[![пользователь автоматически переводится на шестую страницу при выборе элемента раскрывающегося списка Page 6.](paging-and-sorting-report-data-cs/_static/image22.png)](paging-and-sorting-report-data-cs/_static/image21.png)

**Рис. 11**. пользователь автоматически переводится на шестую страницу при выборе элемента в раскрывающемся списке Page 6 ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image23.png)).

## <a name="step-5-adding-bi-directional-sorting-support"></a>Шаг 5. Добавление поддержки двунаправленной сортировки

Добавление поддержки двунаправленной сортировки так же просто, как и Добавление поддержки разбиения по страницам, достаточно проверить параметр Включить сортировку из смарт-тега GridView s (который задает для [свойства`AllowSorting`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.allowsorting.aspx) GridView s значение `true`). При этом каждый из заголовков полей GridView s подготавливается к просмотру, что при щелчке вызывает обратную передачу и возвращает данные, отсортированные по выбранному столбцу в возрастающем порядке. Повторное нажатие одной и той же заголовка LinkButton приводит к тому, что данные сортируются в убывающем порядке.

> [!NOTE]
> Если используется пользовательский уровень доступа к данным, а не типизированный набор данных, то в смарт-теге GridView s может не быть параметра Включить сортировку. Этот флажок доступен только для элементов управления GridView, привязанных к источникам данных, которые изначально поддерживают сортировку. Типизированный набор данных обеспечивает встроенную поддержку сортировки, так как ADO.NET DataTable предоставляет метод `Sort`, который при вызове сортирует таблицы DataTables с использованием заданного критерия.

Если DAL не возвращает объекты, которые изначально поддерживают сортировку, необходимо настроить ObjectDataSource для передачи сведений о сортировке на уровень бизнес-логики, который может либо отсортировать данные, либо иметь данные, отсортированные по DAL. В следующем учебном курсе мы расскажем, как сортировать данные на уровнях бизнес-логики и доступа к данным.

Элементы LinkButton, выполняющие сортировку, подготавливаются к просмотру как гиперссылки HTML, текущие цвета (синие для непосещенных ссылок и темно-красный для посещенной ссылки) конфликтуют с цветом фона строки заголовка. Вместо этого пусть все ссылки на строки заголовков отображаются белым цветом, независимо от того, были ли они просмотрены или нет. Это можно сделать, добавив следующий элемент в класс `Styles.css`:

[!code-css[Main](paging-and-sorting-report-data-cs/samples/sample8.css)]

Этот синтаксис указывает, что при отображении гиперссылок внутри элемента, использующего класс Хеадерстиле, используется белый текст.

После этого добавления CSS при посещении страницы в браузере экран должен выглядеть примерно так, как показано на рис. 12. В частности, на рис. 12 показаны результаты после нажатия ссылки заголовка поля цены.

[![результаты отсортированы по UnitPrice в возрастающем порядке](paging-and-sorting-report-data-cs/_static/image25.png)](paging-and-sorting-report-data-cs/_static/image24.png)

**Рис. 12**. результаты отсортированы по UnitPrice в возрастающем порядке ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image26.png))

## <a name="examining-the-sorting-workflow"></a>Проверка рабочего процесса сортировки

Все поля GridView для BoundField, CheckBoxField, TemplateField и т. д. имеют свойство `SortExpression`, которое указывает выражение, которое должно использоваться для сортировки данных при щелчке ссылки заголовка поля сортировки. GridView также имеет свойство `SortExpression`. Когда вы щелкнули заголовок элемента управления LinkButton, GridView присваивает этому полю `SortExpression` значение свойству `SortExpression`. Затем данные повторно извлекаются из ObjectDataSource и сортируются в соответствии со свойством `SortExpression` GridView s. В следующем списке подробно описана последовательность действий, которые выполняются при сортировке пользователем данных в элементе управления GridView.

1. [Событие сортировки](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.sorting(VS.80).aspx) GridView s срабатывает
2. [Свойство`SortExpression`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.sortexpression.aspx) GridView s установлено в `SortExpression` поля, для которого была нажата заголовком LinkButton.
3. ObjectDataSource повторно извлекает все данные из слоя BLL, а затем сортирует данные с помощью элемента GridView s `SortExpression`
4. Свойство `PageIndex` GridView s сбрасывается в 0, что означает, что при сортировке пользователя на первую страницу данных (предполагается, что была реализована поддержка разбиения по страницам)
5. Вызывается [событие`Sorted`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.sorted(VS.80).aspx) GridView s

Как и при использовании разбиения по страницам по умолчанию, параметр сортировки по умолчанию повторно извлекает *все* записи из слоя BLL. При использовании сортировки без разбиения на страницы или при использовании разбиения по страницам по умолчанию не существует способа обойти это снижение производительности (чем больше кэширования данных базы данных). Однако, как мы увидим в следующем учебном курсе, можно эффективно сортировать данные при использовании пользовательского разбиения по страницам.

При привязке ObjectDataSource к GridView с помощью раскрывающегося списка в смарт-теге GridView s каждое поле GridView автоматически имеет свойство `SortExpression`, присвоенное имени поля данных в классе `ProductsRow`. Например, `ProductName` BoundField s `SortExpression` имеет значение `ProductName`, как показано в следующей декларативной разметке:

[!code-aspx[Main](paging-and-sorting-report-data-cs/samples/sample9.aspx)]

Поле можно настроить таким образом, чтобы оно не было упорядочено путем очистки свойства `SortExpression` (присвоение его пустой строке). Чтобы проиллюстрировать это, представьте, что мы не хотим, чтобы наши клиенты могли сортировать наши продукты по цене. Свойство `UnitPrice` BoundField s `SortExpression` может быть удалено из декларативной разметки или в диалоговом окне поля (доступ к которому можно получить, щелкнув ссылку изменить столбцы в смарт-теге GridView).

![Результаты отсортированы по UnitPrice в возрастающем порядке.](paging-and-sorting-report-data-cs/_static/image27.png)

**Рис. 13**. результаты отсортированы по UnitPrice в возрастающем порядке

После удаления свойства `SortExpression` для `UnitPrice` BoundField заголовок подготавливается к просмотру как текст, а не как связь, тем самым запрещая пользователям сортировать данные по цене.

[![, удалив свойство SortExpression, пользователи больше не смогут Сортировать продукты по цене](paging-and-sorting-report-data-cs/_static/image29.png)](paging-and-sorting-report-data-cs/_static/image28.png)

**Рис. 14**. Если удалить свойство SortExpression, пользователи больше не смогут Сортировать продукты по цене ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image30.png))

## <a name="programmatically-sorting-the-gridview"></a>Программная сортировка GridView

Можно также отсортировать содержимое элемента управления GridView программным способом с помощью [`Sort`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.sort.aspx)GridView s. Просто передайте значение `SortExpression`, чтобы выполнить сортировку вместе с [`SortDirection`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sortdirection.aspx) (`Ascending` или `Descending`), и данные GridView s будут повторно отсортированы.

Предположим, причина, по которой мы отключили сортировку `UnitPrice`, была обусловлена тем, что наши клиенты были бы просто покупать только продукты с самой низкой ценой. Тем не менее мы хотим предоставить им возможность покупать самые ресурсоемкие продукты, поэтому мы можем отсортировать продукты по цене, но только начиная с самой дорогостоящей цены.

Для этого добавьте к странице веб-элемент управления Button, задайте для свойства `ID` значение `SortPriceDescending`, а для свойства `Text` — Сортировать по цене. Затем создайте обработчик событий для кнопки `Click` событие, дважды щелкнув элемент управления "Кнопка" в конструкторе. Добавьте следующий код в этот обработчик событий:

[!code-csharp[Main](paging-and-sorting-report-data-cs/samples/sample10.cs)]

При нажатии этой кнопки пользователь возвращается к первой странице с продуктами, отсортированными по цене, от наиболее дорогих и наименее дорогих (см. рис. 15).

[![нажатии кнопки упорядочивает продукты от наиболее дорогих до наименее](paging-and-sorting-report-data-cs/_static/image32.png)](paging-and-sorting-report-data-cs/_static/image31.png)

**Рис. 15**. нажатие кнопки упорядочивает продукты от наиболее дорогих к наименьшему ([щелкните, чтобы просмотреть изображение с полным размером](paging-and-sorting-report-data-cs/_static/image33.png)).

## <a name="summary"></a>Сводка

В этом учебнике мы рассмотрели, как реализовать возможности разбиения по страницам и сортировки по умолчанию, которые были так же просты, как проверка флажка. Когда пользователь сортирует или выполняет сортировку по данным, аналогичный рабочий процесс разбирается так:

1. Обратная передача
2. Срабатывает событие предварительного уровня веб-элемента управления данными (`PageIndexChanging` или `Sorting`)
3. Элемент ObjectDataSource повторно извлекает все данные
4. Срабатывает событие последующей загрузки веб-элемента управления данными (`PageIndexChanged` или `Sorted`)

Несмотря на то, что реализация базового разбиения по страницам и упорядочения является очень простой, для использования более эффективного пользовательского разбиения на страницы или дальнейшего улучшения интерфейса разбиения по страницам или сортировки требуется больше усилий. В следующих руководствах будут рассмотрены эти темы.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

> [!div class="step-by-step"]
> [Вперед](efficiently-paging-through-large-amounts-of-data-cs.md)
