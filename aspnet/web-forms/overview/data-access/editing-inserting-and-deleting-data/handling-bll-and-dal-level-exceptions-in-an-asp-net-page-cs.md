---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs
title: Обработка исключений уровня BLL и DAL на странице ASP.NET (C#) | Документация Майкрософт
author: rick-anderson
description: В этом учебнике будет показано, как отобразить понятное информативное сообщение об ошибке, которое должно быть вызвано исключением во время операции вставки, обновления или удаления...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 49d8a66c-3ea8-4087-839f-179d1d94512a
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs
msc.type: authoredcontent
ms.openlocfilehash: 2b9cdb5af6f33171b191d5a80473c7796eb098d9
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74589320"
---
# <a name="handling-bll--and-dal-level-exceptions-in-an-aspnet-page-c"></a><span data-ttu-id="b0d14-103">Обработка исключений уровней BLL и DAL на странице ASP.NET(C#)</span><span class="sxs-lookup"><span data-stu-id="b0d14-103">Handling BLL- and DAL-Level Exceptions in an ASP.NET Page (C#)</span></span>

<span data-ttu-id="b0d14-104">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="b0d14-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="b0d14-105">[Скачивание примера приложения](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_CS.exe) или [Загрузка PDF-файла](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/datatutorial18cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="b0d14-105">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_CS.exe) or [Download PDF](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/datatutorial18cs1.pdf)</span></span>

> <span data-ttu-id="b0d14-106">В этом учебнике будет показано, как отобразить понятное информативное сообщение об ошибке, которое должно быть вызвано исключением во время операции вставки, обновления или удаления веб-элемента управления данными ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="b0d14-106">In this tutorial we will see how to display a friendly, informative error message should an exception occur during an insert, update, or delete operation of an ASP.NET data Web control.</span></span>

## <a name="introduction"></a><span data-ttu-id="b0d14-107">Введение</span><span class="sxs-lookup"><span data-stu-id="b0d14-107">Introduction</span></span>

<span data-ttu-id="b0d14-108">Работа с данными из веб-приложения ASP.NET с использованием многоуровневой архитектуры приложения включает следующие три основных действия.</span><span class="sxs-lookup"><span data-stu-id="b0d14-108">Working with data from an ASP.NET web application using a tiered application architecture involves the following three general steps:</span></span>

1. <span data-ttu-id="b0d14-109">Определите, какой метод уровня бизнес-логики необходимо вызвать и какие значения параметров передать.</span><span class="sxs-lookup"><span data-stu-id="b0d14-109">Determine what method of the Business Logic Layer needs to be invoked and what parameter values to pass it.</span></span> <span data-ttu-id="b0d14-110">Значения параметров могут быть жестко запрограммированными, назначенными программно или вводимыми пользователем.</span><span class="sxs-lookup"><span data-stu-id="b0d14-110">The parameter values can be hard coded, programmatically-assigned, or inputs entered by the user.</span></span>
2. <span data-ttu-id="b0d14-111">Вызовите метод.</span><span class="sxs-lookup"><span data-stu-id="b0d14-111">Invoke the method.</span></span>
3. <span data-ttu-id="b0d14-112">Обработка результатов.</span><span class="sxs-lookup"><span data-stu-id="b0d14-112">Process the results.</span></span> <span data-ttu-id="b0d14-113">При вызове метода BLL, возвращающего данные, это может привести к привязке данных к веб-элементу управления данными.</span><span class="sxs-lookup"><span data-stu-id="b0d14-113">When calling a BLL method that returns data, this may involve binding the data to a data Web control.</span></span> <span data-ttu-id="b0d14-114">Для методов BLL, изменяющих данные, это может включать выполнение некоторых действий на основе возвращаемого значения или аккуратной обработки любого исключения, возник на шаге 2.</span><span class="sxs-lookup"><span data-stu-id="b0d14-114">For BLL methods that modify data, this may include performing some action based on a return value or gracefully handling any exception that arose in Step 2.</span></span>

<span data-ttu-id="b0d14-115">Как было показано в [предыдущем руководстве](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md), элементы управления ObjectDataSource и Data Web предоставляют точки расширения для шагов 1 и 3.</span><span class="sxs-lookup"><span data-stu-id="b0d14-115">As we saw in the [previous tutorial](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md), both the ObjectDataSource and the data Web controls provide extensibility points for Steps 1 and 3.</span></span> <span data-ttu-id="b0d14-116">Например, GridView вызывает событие `RowUpdating`, прежде чем присвоить его значения полей коллекции `UpdateParameters` элемента ObjectDataSource. его `RowUpdated` событие возникает после завершения операции ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="b0d14-116">The GridView, for example, fires its `RowUpdating` event prior to assigning its field values to its ObjectDataSource's `UpdateParameters` collection; its `RowUpdated` event is raised after the ObjectDataSource has completed the operation.</span></span>

<span data-ttu-id="b0d14-117">Мы уже рассматривали события, которые возникают на шаге 1, и увидели, как их можно использовать для настройки входных параметров или отмены операции.</span><span class="sxs-lookup"><span data-stu-id="b0d14-117">We've already examined the events that fire during Step 1 and have seen how they can be used to customize the input parameters or cancel the operation.</span></span> <span data-ttu-id="b0d14-118">В этом учебнике мы вернем внимание к событиям, которые срабатывают после завершения операции.</span><span class="sxs-lookup"><span data-stu-id="b0d14-118">In this tutorial we'll turn our attention to the events that fire after the operation has completed.</span></span> <span data-ttu-id="b0d14-119">С этими обработчиками событий последующей проверки мы можем, помимо прочего, определить, произошло ли исключение во время операции, и правильно обработать его, отображая понятное информативное сообщение об ошибке на экране, а не стандартный ASP.NET страница исключения.</span><span class="sxs-lookup"><span data-stu-id="b0d14-119">With these post-level event handlers we can, among other things, determine if an exception occurred during the operation and handle it gracefully, displaying a friendly, informative error message on the screen rather than defaulting to the standard ASP.NET exception page.</span></span>

<span data-ttu-id="b0d14-120">Чтобы продемонстрировать работу с этими событиями уровня поста, давайте создадим страницу, в которой перечислены продукты в редактируемом элементе управления GridView.</span><span class="sxs-lookup"><span data-stu-id="b0d14-120">To illustrate working with these post-level events, let's create a page that lists the products in an editable GridView.</span></span> <span data-ttu-id="b0d14-121">При обновлении продукта при возникновении исключения на странице ASP.NET будет отображаться короткое сообщение над GridView, объясняющее, что возникла проблема.</span><span class="sxs-lookup"><span data-stu-id="b0d14-121">When updating a product, if an exception is raised our ASP.NET page will display a short message above the GridView explaining that a problem has occurred.</span></span> <span data-ttu-id="b0d14-122">Приступим к работе!</span><span class="sxs-lookup"><span data-stu-id="b0d14-122">Let's get started!</span></span>

## <a name="step-1-creating-an-editable-gridview-of-products"></a><span data-ttu-id="b0d14-123">Шаг 1. Создание редактируемого элемента управления GridView для продуктов</span><span class="sxs-lookup"><span data-stu-id="b0d14-123">Step 1: Creating an Editable GridView of Products</span></span>

<span data-ttu-id="b0d14-124">В предыдущем учебном курсе мы создали редактируемый элемент управления GridView с двумя полями, `ProductName` и `UnitPrice`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-124">In the previous tutorial we created an editable GridView with just two fields, `ProductName` and `UnitPrice`.</span></span> <span data-ttu-id="b0d14-125">Это требовало создания дополнительной перегрузки для метода `UpdateProduct` класса `ProductsBLL`, который принимает только три входных параметра (название продукта, Цена за единицу и идентификатор), а не параметр для каждого поля продукта.</span><span class="sxs-lookup"><span data-stu-id="b0d14-125">This required creating an additional overload for the `ProductsBLL` class's `UpdateProduct` method, one that only accepted three input parameters (the product's name, unit price, and ID) as opposed a parameter for each product field.</span></span> <span data-ttu-id="b0d14-126">В рамках этого руководства мы еще рекомендуем использовать этот метод, создав редактируемый элемент управления GridView, в котором отображается название продукта, количество на единицу, Цена за единицу и единицы склада, но только имя, Цена за единицу и единицы склада, которые должны быть изменены.</span><span class="sxs-lookup"><span data-stu-id="b0d14-126">For this tutorial, let's practice this technique again, creating an editable GridView that displays the product's name, quantity per unit, unit price, and units in stock, but only allows the name, unit price, and units in stock to be edited.</span></span>

<span data-ttu-id="b0d14-127">Для реализации этого сценария требуется еще одна перегрузка метода `UpdateProduct`, принимающая четыре параметра: название продукта, Цена за единицу, единицы в запасах и идентификатор.</span><span class="sxs-lookup"><span data-stu-id="b0d14-127">To accommodate this scenario we'll need another overload of the `UpdateProduct` method, one that accepts four parameters: the product's name, unit price, units in stock, and ID.</span></span> <span data-ttu-id="b0d14-128">Добавьте следующий метод в класс `ProductsBLL`:</span><span class="sxs-lookup"><span data-stu-id="b0d14-128">Add the following method to the `ProductsBLL` class:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample1.cs)]

<span data-ttu-id="b0d14-129">После завершения этого метода мы готовы к созданию страницы ASP.NET, позволяющей редактировать эти четыре поля продукта.</span><span class="sxs-lookup"><span data-stu-id="b0d14-129">With this method complete, we're ready to create the ASP.NET page that allows for editing these four particular product fields.</span></span> <span data-ttu-id="b0d14-130">Откройте страницу `ErrorHandling.aspx` в папке `EditInsertDelete` и добавьте GridView на страницу через конструктор.</span><span class="sxs-lookup"><span data-stu-id="b0d14-130">Open the `ErrorHandling.aspx` page in the `EditInsertDelete` folder and add a GridView to the page through the Designer.</span></span> <span data-ttu-id="b0d14-131">Привяжите GridView к новому элементу ObjectDataSource, сопоставлению метода `Select()` с методом `GetProducts()` класса `ProductsBLL` и методом `Update()` в только что созданную перегрузку `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-131">Bind the GridView to a new ObjectDataSource, mapping the `Select()` method to the `ProductsBLL` class's `GetProducts()` method and the `Update()` method to the `UpdateProduct` overload just created.</span></span>

<span data-ttu-id="b0d14-132">[![использовать перегрузку метода UpdateProduct, которая принимает четыре входных параметра](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-132">[![Use the UpdateProduct Method Overload That Accepts Four Input Parameters](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image1.png)</span></span>

<span data-ttu-id="b0d14-133">**Рис. 1**. использование перегрузки метода `UpdateProduct`, принимающей четыре входных параметра ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="b0d14-133">**Figure 1**: Use the `UpdateProduct` Method Overload That Accepts Four Input Parameters ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image3.png))</span></span>

<span data-ttu-id="b0d14-134">Это приведет к созданию элемента управления ObjectDataSource с коллекцией `UpdateParameters` с четырьмя параметрами и элементом управления GridView с полем для каждого поля продукта.</span><span class="sxs-lookup"><span data-stu-id="b0d14-134">This will create an ObjectDataSource with an `UpdateParameters` collection with four parameters and a GridView with a field for each of the product fields.</span></span> <span data-ttu-id="b0d14-135">Декларативная разметка ObjectDataSource присваивает свойству `OldValuesParameterFormatString` значение `original_{0}`, что вызовет исключение, так как наш класс BLL не ждет передачи входного параметра с именем `original_productID`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-135">The ObjectDataSource's declarative markup assigns the `OldValuesParameterFormatString` property the value `original_{0}`, which will cause an exception since our BLL class's don't expect an input parameter named `original_productID` to be passed in.</span></span> <span data-ttu-id="b0d14-136">Не забудьте полностью удалить этот параметр из декларативного синтаксиса (или задайте для него значение по умолчанию `{0}`).</span><span class="sxs-lookup"><span data-stu-id="b0d14-136">Don't forget to remove this setting altogether from the declarative syntax (or set it to the default value, `{0}`).</span></span>

<span data-ttu-id="b0d14-137">Затем немного очистить GridView, чтобы включить только `ProductName`, `QuantityPerUnit`, `UnitPrice`и `UnitsInStock` BoundFields.</span><span class="sxs-lookup"><span data-stu-id="b0d14-137">Next, pare down the GridView to include only the `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` BoundFields.</span></span> <span data-ttu-id="b0d14-138">Кроме того, вы можете применить любое необходимое форматирование на уровне полей (например, изменить свойства `HeaderText`).</span><span class="sxs-lookup"><span data-stu-id="b0d14-138">Also feel free to apply any field-level formatting you deem necessary (such as changing the `HeaderText` properties).</span></span>

<span data-ttu-id="b0d14-139">В предыдущем учебном курсе мы рассматривали форматирование `UnitPrice` BoundField как денежную единицу как в режиме только для чтения, так и в режиме редактирования.</span><span class="sxs-lookup"><span data-stu-id="b0d14-139">In the previous tutorial we looked at how to format the `UnitPrice` BoundField as a currency both in read-only mode and edit mode.</span></span> <span data-ttu-id="b0d14-140">Давайте сделаем то же самое.</span><span class="sxs-lookup"><span data-stu-id="b0d14-140">Let's do the same here.</span></span> <span data-ttu-id="b0d14-141">Помните, что при этом необходимо задать для свойства `DataFormatString` BoundField значение `{0:c}`, его свойство `HtmlEncode` `false`, а `ApplyFormatInEditMode` — `true`, как показано на рис. 2.</span><span class="sxs-lookup"><span data-stu-id="b0d14-141">Recall that this required setting the BoundField's `DataFormatString` property to `{0:c}`, its `HtmlEncode` property to `false`, and its `ApplyFormatInEditMode` to `true`, as shown in Figure 2.</span></span>

<span data-ttu-id="b0d14-142">[![настроить BoundField UnitPrice для вывода в виде валюты](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-142">[![Configure the UnitPrice BoundField to Display as a Currency](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image4.png)</span></span>

<span data-ttu-id="b0d14-143">**Рис. 2**. Настройка `UnitPrice` BoundField для отображения в виде валюты ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="b0d14-143">**Figure 2**: Configure the `UnitPrice` BoundField to Display as a Currency ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image6.png))</span></span>

<span data-ttu-id="b0d14-144">Для форматирования `UnitPrice` в качестве валюты в интерфейсе редактирования требуется создать обработчик событий для события `RowUpdating` GridView, которое анализирует строку в формате валюты в `decimal` значение.</span><span class="sxs-lookup"><span data-stu-id="b0d14-144">Formatting the `UnitPrice` as a currency in the editing interface requires creating an event handler for the GridView's `RowUpdating` event that parses the currency-formatted string into a `decimal` value.</span></span> <span data-ttu-id="b0d14-145">Вспомним, что обработчик событий `RowUpdating` из последнего учебника также проверил, чтобы убедиться, что пользователь предоставил значение `UnitPrice`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-145">Recall that the `RowUpdating` event handler from the last tutorial also checked to ensure that the user provided a `UnitPrice` value.</span></span> <span data-ttu-id="b0d14-146">Однако для этого учебника можно разрешить пользователю опустить цену.</span><span class="sxs-lookup"><span data-stu-id="b0d14-146">However, for this tutorial let's allow the user to omit the price.</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample2.cs)]

<span data-ttu-id="b0d14-147">Наш GridView включает `QuantityPerUnit` BoundField, но этот BoundField должен быть только для отображаемых целей и не должен быть доступен для редактирования пользователем.</span><span class="sxs-lookup"><span data-stu-id="b0d14-147">Our GridView includes a `QuantityPerUnit` BoundField, but this BoundField should be only for display purposes and should not be editable by the user.</span></span> <span data-ttu-id="b0d14-148">Для этого просто задайте для свойства BoundFields "`ReadOnly` значение `true`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-148">To arrange this, simply set the BoundFields' `ReadOnly` property to `true`.</span></span>

<span data-ttu-id="b0d14-149">[![сделать QuantityPerUnit BoundField только для чтения](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-149">[![Make the QuantityPerUnit BoundField Read-Only](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image7.png)</span></span>

<span data-ttu-id="b0d14-150">**Рис. 3**. Сделайте `QuantityPerUnit` BoundField только для чтения ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="b0d14-150">**Figure 3**: Make the `QuantityPerUnit` BoundField Read-Only ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image9.png))</span></span>

<span data-ttu-id="b0d14-151">Наконец, установите флажок Включить изменение в смарт-теге GridView.</span><span class="sxs-lookup"><span data-stu-id="b0d14-151">Finally, check the Enable Editing checkbox from the GridView's smart tag.</span></span> <span data-ttu-id="b0d14-152">После выполнения этих действий конструктор `ErrorHandling.aspx` страницы должен выглядеть примерно так, как показано на рис. 4.</span><span class="sxs-lookup"><span data-stu-id="b0d14-152">After completing these steps the `ErrorHandling.aspx` page's Designer should look similar to Figure 4.</span></span>

<span data-ttu-id="b0d14-153">[![удалить все необходимые BoundFields и установите флажок Enable Edit (включить редактирование).](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-153">[![Remove All But the Needed BoundFields and Check the Enable Editing Checkbox](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image10.png)</span></span>

<span data-ttu-id="b0d14-154">**Рис. 4**. Удаление всех необходимых BoundFields и установка флажка Enable Edit ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="b0d14-154">**Figure 4**: Remove All But the Needed BoundFields and Check the Enable Editing Checkbox ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image12.png))</span></span>

<span data-ttu-id="b0d14-155">На этом этапе у нас есть список всех полей продуктов `ProductName`, `QuantityPerUnit`, `UnitPrice`и `UnitsInStock`. Однако можно изменять только поля `ProductName`, `UnitPrice`и `UnitsInStock`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-155">At this point we have a list of all of the products' `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` fields; however, only the `ProductName`, `UnitPrice`, and `UnitsInStock` fields can be edited.</span></span>

<span data-ttu-id="b0d14-156">[![пользователи теперь могут легко изменять названия, цены и единицы товара в полях акций.](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-156">[![Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image13.png)</span></span>

<span data-ttu-id="b0d14-157">**Рис. 5**. Теперь пользователи могут легко изменять названия, цены и единицы товара в полях акций ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image15.png)).</span><span class="sxs-lookup"><span data-stu-id="b0d14-157">**Figure 5**: Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image15.png))</span></span>

## <a name="step-2-gracefully-handling-dal-level-exceptions"></a><span data-ttu-id="b0d14-158">Шаг 2. корректное обработка исключений уровня DAL</span><span class="sxs-lookup"><span data-stu-id="b0d14-158">Step 2: Gracefully Handling DAL-Level Exceptions</span></span>

<span data-ttu-id="b0d14-159">Хотя наш редактируемый элемент управления GridView прекрасно работает, когда пользователь вводит юридические значения для измененного названия продукта, цены и количества единиц в запасе, при вводе недопустимых значений возникает исключение.</span><span class="sxs-lookup"><span data-stu-id="b0d14-159">While our editable GridView works wonderfully when users enter legal values for the edited product's name, price, and units in stock, entering illegal values results in an exception.</span></span> <span data-ttu-id="b0d14-160">Например, пропуск значения `ProductName` вызывает исключение [нонуллалловедексцептион](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp) , так как свойство `ProductName` в классе `ProductsRow` имеет свойство `AllowDBNull` со значением `false`. Если база данных не работает, TableAdapter порождает `SqlException` при попытке подключиться к базе данных.</span><span class="sxs-lookup"><span data-stu-id="b0d14-160">For example, omitting the `ProductName` value causes a [NoNullAllowedException](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp) to be thrown since the `ProductName` property in the `ProductsRow` class has its `AllowDBNull` property set to `false`; if the database is down, a `SqlException` will be thrown by the TableAdapter when attempting to connect to the database.</span></span> <span data-ttu-id="b0d14-161">Без каких-либо действий эти исключения поднимаются от уровня доступа к данным на уровень бизнес-логики, затем на страницу ASP.NET и, наконец, в среду выполнения ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="b0d14-161">Without taking any action, these exceptions bubble up from the Data Access Layer to the Business Logic Layer, then to the ASP.NET page, and finally to the ASP.NET runtime.</span></span>

<span data-ttu-id="b0d14-162">В зависимости от того, как настроено веб-приложение и не посещает ли приложение `localhost`, необработанное исключение может привести к появлению общей страницы ошибок сервера, подробного отчета об ошибке или удобной веб-страницы.</span><span class="sxs-lookup"><span data-stu-id="b0d14-162">Depending on how your web application is configured and whether or not you're visiting the application from `localhost`, an unhandled exception can result in either a generic server-error page, a detailed error report, or a user-friendly web page.</span></span> <span data-ttu-id="b0d14-163">Дополнительные сведения о том, как среда выполнения ASP.NET реагирует на неперехваченное исключение, см. [в разделе Обработка ошибок веб-приложения в ASP.NET](http://www.15seconds.com/issue/030102.htm) и [элемент customErrors](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx) .</span><span class="sxs-lookup"><span data-stu-id="b0d14-163">See [Web Application Error Handling in ASP.NET](http://www.15seconds.com/issue/030102.htm) and the [customErrors Element](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx) for more information on how the ASP.NET runtime responds to an uncaught exception.</span></span>

<span data-ttu-id="b0d14-164">На рис. 6 показан экран, возникающий при попытке обновить продукт без указания значения `ProductName`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-164">Figure 6 shows the screen encountered when attempting to update a product without specifying the `ProductName` value.</span></span> <span data-ttu-id="b0d14-165">Это подробный отчет об ошибках по умолчанию, отображаемый при переходе на `localhost`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-165">This is the default detailed error report displayed when coming through `localhost`.</span></span>

<span data-ttu-id="b0d14-166">[![пропуск названия продукта будет отображать сведения об исключении](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-166">[![Omitting the Product's Name Will Display Exception Details](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image16.png)</span></span>

<span data-ttu-id="b0d14-167">**Рис. 6**. при пропуске названия продукта отображаются сведения об исключении ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image18.png)).</span><span class="sxs-lookup"><span data-stu-id="b0d14-167">**Figure 6**: Omitting the Product's Name Will Display Exception Details ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image18.png))</span></span>

<span data-ttu-id="b0d14-168">Хотя такие сведения об исключении полезны при тестировании приложения, представление конечного пользователя с таким экраном в случае исключения является менее идеальным.</span><span class="sxs-lookup"><span data-stu-id="b0d14-168">While such exception details are helpful when testing an application, presenting an end user with such a screen in the face of an exception is less than ideal.</span></span> <span data-ttu-id="b0d14-169">Конечный пользователь, вероятно, не знает, что такое `NoNullAllowedException` или почему оно вызвано.</span><span class="sxs-lookup"><span data-stu-id="b0d14-169">An end user likely doesn't know what a `NoNullAllowedException` is or why it was caused.</span></span> <span data-ttu-id="b0d14-170">Лучший подход — предоставить пользователю более удобное сообщение, объясняющее, что возникли проблемы при попытке обновления продукта.</span><span class="sxs-lookup"><span data-stu-id="b0d14-170">A better approach is to present the user with a more user-friendly message explaining that there were problems attempting to update the product.</span></span>

<span data-ttu-id="b0d14-171">Если при выполнении операции возникает исключение, то события последующей проверки как в элементе управления ObjectDataSource, так и в веб-элементах данных предоставляют средства для обнаружения и отмены исключения из восходящей среды в среду выполнения ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="b0d14-171">If an exception occurs when performing the operation, the post-level events in both the ObjectDataSource and the data Web control provide a means to detect it and cancel the exception from bubbling up to the ASP.NET runtime.</span></span> <span data-ttu-id="b0d14-172">В нашем примере создадим обработчик событий для события `RowUpdated` GridView, которое определяет, было ли вызвано исключение, и, если да, отображает сведения об исключении в веб-элементе управления Label.</span><span class="sxs-lookup"><span data-stu-id="b0d14-172">For our example, let's create an event handler for the GridView's `RowUpdated` event that determines if an exception has fired and, if so, displays the exception details in a Label Web control.</span></span>

<span data-ttu-id="b0d14-173">Начните с добавления метки на страницу ASP.NET, задав для свойства `ID` значение `ExceptionDetails` и сняв свойство `Text`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-173">Start by adding a Label to the ASP.NET page, setting its `ID` property to `ExceptionDetails` and clearing out its `Text` property.</span></span> <span data-ttu-id="b0d14-174">Чтобы привлечь внимание пользователя к этому сообщению, присвойте свойству `CssClass` значение `Warning`, которое является классом CSS, добавленным в файл `Styles.css` в предыдущем руководстве.</span><span class="sxs-lookup"><span data-stu-id="b0d14-174">In order to draw the user's eye to this message, set its `CssClass` property to `Warning`, which is a CSS class we added to the `Styles.css` file in the previous tutorial.</span></span> <span data-ttu-id="b0d14-175">Вспомним, что этот класс CSS приводит к тому, что текст метки отображается красным, курсивным шрифтом, очень большим шрифтом.</span><span class="sxs-lookup"><span data-stu-id="b0d14-175">Recall that this CSS class causes the Label's text to be displayed in a red, italic, bold, extra large font.</span></span>

<span data-ttu-id="b0d14-176">[![добавить на страницу веб-элемент управления Label](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-176">[![Add a Label Web Control to the Page](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image19.png)</span></span>

<span data-ttu-id="b0d14-177">**Рис. 7**. Добавление на страницу веб-элемента управления Label ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="b0d14-177">**Figure 7**: Add a Label Web Control to the Page ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image21.png))</span></span>

<span data-ttu-id="b0d14-178">Поскольку веб-элемент управления "метка" должен быть видимым только сразу после возникновения исключения, присвойте свойству `Visible` значение false в обработчике событий `Page_Load`:</span><span class="sxs-lookup"><span data-stu-id="b0d14-178">Since we want this Label Web control to be visible only immediately after an exception has occurred, set its `Visible` property to false in the `Page_Load` event handler:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample3.cs)]

<span data-ttu-id="b0d14-179">В этом коде при первом посещении страницы и последующих обратных передачах элементу управления `ExceptionDetails` будет присвоено `Visible` свойство `false`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-179">With this code, on the first page visit and subsequent postbacks the `ExceptionDetails` control will have its `Visible` property set to `false`.</span></span> <span data-ttu-id="b0d14-180">В случае исключения уровня DAL или BLL, которое мы можем обнаружить в обработчике событий `RowUpdated` GridView, мы устанавливаем свойству `Visible` элемента управления `ExceptionDetails` значение true.</span><span class="sxs-lookup"><span data-stu-id="b0d14-180">In the face of a DAL- or BLL-level exception, which we can detect in the GridView's `RowUpdated` event handler, we will set the `ExceptionDetails` control's `Visible` property to true.</span></span> <span data-ttu-id="b0d14-181">Так как обработчики событий веб-элемента управления происходят после обработчика событий `Page_Load` в жизненном цикле страницы, метка будет отображаться.</span><span class="sxs-lookup"><span data-stu-id="b0d14-181">Since Web control event handlers occur after the `Page_Load` event handler in the page lifecycle, the Label will be shown.</span></span> <span data-ttu-id="b0d14-182">Однако при следующей обратной передаче обработчик событий `Page_Load` вернет свойство `Visible` обратно в `false`, скрывая его из представления.</span><span class="sxs-lookup"><span data-stu-id="b0d14-182">However, on the next postback, the `Page_Load` event handler will revert the `Visible` property back to `false`, hiding it from view again.</span></span>

> [!NOTE]
> <span data-ttu-id="b0d14-183">Кроме того, можно удалить необходимость установки свойства `Visible` элемента управления `ExceptionDetails` в `Page_Load`, назначив `false` свойства `Visible` в декларативном синтаксисе и отключив его состояние просмотра (установив для свойства `EnableViewState` значение `false`).</span><span class="sxs-lookup"><span data-stu-id="b0d14-183">Alternatively, we could remove the necessity for setting the `ExceptionDetails` control's `Visible` property in `Page_Load` by assigning its `Visible` property `false` in the declarative syntax and disabling its view state (setting its `EnableViewState` property to `false`).</span></span> <span data-ttu-id="b0d14-184">В следующем учебном курсе мы будем использовать этот альтернативный подход.</span><span class="sxs-lookup"><span data-stu-id="b0d14-184">We'll use this alternative approach in a future tutorial.</span></span>

<span data-ttu-id="b0d14-185">После добавления элемента управления Label следующим шагом является создание обработчика событий для `RowUpdated` события GridView.</span><span class="sxs-lookup"><span data-stu-id="b0d14-185">With the Label control added, our next step is to create the event handler for the GridView's `RowUpdated` event.</span></span> <span data-ttu-id="b0d14-186">Выберите элемент GridView в конструкторе, перейдите к окно свойств и щелкните значок с молнией, в котором перечислены события GridView.</span><span class="sxs-lookup"><span data-stu-id="b0d14-186">Select the GridView in the Designer, go to the Properties window, and click the lightning bolt icon, listing the GridView's events.</span></span> <span data-ttu-id="b0d14-187">Уже должна быть запись для события `RowUpdating` GridView, так как мы создали обработчик событий для этого события ранее в этом руководстве.</span><span class="sxs-lookup"><span data-stu-id="b0d14-187">There should already be an entry there for the GridView's `RowUpdating` event, as we created an event handler for this event earlier in this tutorial.</span></span> <span data-ttu-id="b0d14-188">Создайте обработчик событий для `RowUpdated` события.</span><span class="sxs-lookup"><span data-stu-id="b0d14-188">Create an event handler for the `RowUpdated` event as well.</span></span>

![Создание обработчика событий для события RowUpdated элемента управления GridView](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image22.png)

<span data-ttu-id="b0d14-190">**Рис. 8**. Создание обработчика событий для `RowUpdated` события GridView</span><span class="sxs-lookup"><span data-stu-id="b0d14-190">**Figure 8**: Create an Event Handler for the GridView's `RowUpdated` Event</span></span>

> [!NOTE]
> <span data-ttu-id="b0d14-191">Обработчик событий также можно создать с помощью раскрывающихся списков в верхней части файла класса кода программной части.</span><span class="sxs-lookup"><span data-stu-id="b0d14-191">You can also create the event handler through the drop-down lists at the top of the code-behind class file.</span></span> <span data-ttu-id="b0d14-192">Выберите элемент GridView из раскрывающегося списка слева и событие `RowUpdated` из справа.</span><span class="sxs-lookup"><span data-stu-id="b0d14-192">Select the GridView from the drop-down list on the left and the `RowUpdated` event from the one on the right.</span></span>

<span data-ttu-id="b0d14-193">При создании этого обработчика событий в класс кода программной части страницы ASP.NET будет добавлен следующий код:</span><span class="sxs-lookup"><span data-stu-id="b0d14-193">Creating this event handler will add the following code to the ASP.NET page's code-behind class:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample4.cs)]

<span data-ttu-id="b0d14-194">Второй входной параметр этого обработчика событий является объектом типа [гридвиевупдатедевентаргс](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx), который имеет три свойства, представляющие интерес для обработки исключений:</span><span class="sxs-lookup"><span data-stu-id="b0d14-194">This event handler's second input parameter is an object of type [GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx), which has three properties of interest for handling exceptions:</span></span>

- <span data-ttu-id="b0d14-195">`Exception` ссылку на созданное исключение; Если исключение не было создано, это свойство будет иметь значение `null`</span><span class="sxs-lookup"><span data-stu-id="b0d14-195">`Exception` a reference to the thrown exception; if no exception has been thrown, this property will have a value of `null`</span></span>
- <span data-ttu-id="b0d14-196">`ExceptionHandled` логическое значение, указывающее, было ли исключение обработано в обработчике событий `RowUpdated`. Если `false` (значение по умолчанию), исключение создается повторно, распространялась до среды выполнения ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="b0d14-196">`ExceptionHandled` a Boolean value that indicates whether or not the exception was handled in the `RowUpdated` event handler; if `false` (the default), the exception is re-thrown, percolating up to the ASP.NET runtime</span></span>
- <span data-ttu-id="b0d14-197">`KeepInEditMode` Если задано значение `true` измененная строка GridView остается в режиме редактирования; Если `false` (значение по умолчанию), строка GridView возвращается к режиму только для чтения.</span><span class="sxs-lookup"><span data-stu-id="b0d14-197">`KeepInEditMode` if set to `true` the edited GridView row remains in edit mode; if `false` (the default), the GridView row reverts back to its read-only mode</span></span>

<span data-ttu-id="b0d14-198">Затем наш код должен проверить, не `null`ли `Exception`, что означает, что при выполнении операции было вызвано исключение.</span><span class="sxs-lookup"><span data-stu-id="b0d14-198">Our code, then, should check to see if `Exception` is not `null`, meaning that an exception was raised while performing the operation.</span></span> <span data-ttu-id="b0d14-199">Если это так, мы хотим:</span><span class="sxs-lookup"><span data-stu-id="b0d14-199">If this is the case, we want to:</span></span>

- <span data-ttu-id="b0d14-200">Отображение сообщения, понятного пользователю, в метке `ExceptionDetails`</span><span class="sxs-lookup"><span data-stu-id="b0d14-200">Display a user-friendly message in the `ExceptionDetails` Label</span></span>
- <span data-ttu-id="b0d14-201">Укажите, что исключение обработано</span><span class="sxs-lookup"><span data-stu-id="b0d14-201">Indicate that the exception was handled</span></span>
- <span data-ttu-id="b0d14-202">Не отключайте строку GridView в режиме редактирования</span><span class="sxs-lookup"><span data-stu-id="b0d14-202">Keep the GridView row in edit mode</span></span>

<span data-ttu-id="b0d14-203">В следующем коде выполняются следующие задачи:</span><span class="sxs-lookup"><span data-stu-id="b0d14-203">This following code accomplishes these objectives:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample5.cs)]

<span data-ttu-id="b0d14-204">Этот обработчик событий начинает с проверки того, `null`ли `e.Exception`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-204">This event handler begins by checking to see if `e.Exception` is `null`.</span></span> <span data-ttu-id="b0d14-205">Если это не так, свойство `Visible` `ExceptionDetails` метки имеет значение `true`, а свойству `Text` — "при обновлении продукта возникла проблема".</span><span class="sxs-lookup"><span data-stu-id="b0d14-205">If it's not, the `ExceptionDetails` Label's `Visible` property is set to `true` and its `Text` property to "There was a problem updating the product."</span></span> <span data-ttu-id="b0d14-206">Сведения о фактическом вызываемом исключении находятся в свойстве `InnerException` объекта `e.Exception`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-206">The details of the actual exception that was thrown reside in the `e.Exception` object's `InnerException` property.</span></span> <span data-ttu-id="b0d14-207">Это внутреннее исключение проверяется и, если оно относится к конкретному типу, к свойству `Text` метки `ExceptionDetails` добавляется дополнительное, полезное сообщение.</span><span class="sxs-lookup"><span data-stu-id="b0d14-207">This inner exception is examined and, if it is of a particular type, an additional, helpful message is appended to the `ExceptionDetails` Label's `Text` property.</span></span> <span data-ttu-id="b0d14-208">Наконец, свойствам `ExceptionHandled` и `KeepInEditMode` присваивается значение `true`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-208">Lastly, the `ExceptionHandled` and `KeepInEditMode` properties are both set to `true`.</span></span>

<span data-ttu-id="b0d14-209">На рис. 9 показан снимок экрана этой страницы при пропуске имени продукта; На рис. 10 показаны результаты при вводе недопустимого `UnitPrice` значения (-50).</span><span class="sxs-lookup"><span data-stu-id="b0d14-209">Figure 9 shows a screen shot of this page when omitting the name of the product; Figure 10 shows the results when entering an illegal `UnitPrice` value (-50).</span></span>

<span data-ttu-id="b0d14-210">[![поле ProductName BoundField должно содержать значение](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-210">[![The ProductName BoundField Must Contain a Value](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image23.png)</span></span>

<span data-ttu-id="b0d14-211">**Рис. 9**. `ProductName` BoundField должен содержать значение ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image25.png))</span><span class="sxs-lookup"><span data-stu-id="b0d14-211">**Figure 9**: The `ProductName` BoundField Must Contain a Value ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image25.png))</span></span>

<span data-ttu-id="b0d14-212">[![отрицательные значения UnitPrice не допускаются](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-212">[![Negative UnitPrice Values are Not Allowed](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image26.png)</span></span>

<span data-ttu-id="b0d14-213">**Рис. 10**. отрицательные значения `UnitPrice` недопустимы ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image28.png))</span><span class="sxs-lookup"><span data-stu-id="b0d14-213">**Figure 10**: Negative `UnitPrice` Values are Not Allowed ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image28.png))</span></span>

<span data-ttu-id="b0d14-214">Установив для свойства `e.ExceptionHandled` значение `true`, обработчик событий `RowUpdated` указал, что он обработал исключение.</span><span class="sxs-lookup"><span data-stu-id="b0d14-214">By setting the `e.ExceptionHandled` property to `true`, the `RowUpdated` event handler has indicated that it has handled the exception.</span></span> <span data-ttu-id="b0d14-215">Таким образом, исключение не распространяется на среду выполнения ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="b0d14-215">Therefore, the exception won't propagate up to the ASP.NET runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="b0d14-216">На рисунках 9 и 10 показан корректный способ обработать исключения, вызванные недопустимым вводом данных пользователем.</span><span class="sxs-lookup"><span data-stu-id="b0d14-216">Figures 9 and 10 show a graceful way to handle exceptions raised due to invalid user input.</span></span> <span data-ttu-id="b0d14-217">Однако в идеале такие недопустимые входные данные никогда не будут обращаться к уровню бизнес-логики в первую очередь, так как страница ASP.NET должна обеспечить допустимость входных данных пользователя перед вызовом метода `UpdateProduct` класса `ProductsBLL`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-217">Ideally, though, such invalid input will never reach the Business Logic Layer in the first place, as the ASP.NET page should ensure that the user's inputs are valid before invoking the `ProductsBLL` class's `UpdateProduct` method.</span></span> <span data-ttu-id="b0d14-218">В следующем учебном курсе мы покажем, как добавить элементы управления проверки в интерфейсы правки и вставки, чтобы гарантировать, что данные, передаваемые на слой бизнес-логики, соответствует бизнес-правилам.</span><span class="sxs-lookup"><span data-stu-id="b0d14-218">In our next tutorial we'll see how to add validation controls to the editing and inserting interfaces to ensure that the data submitted to the Business Logic Layer conforms to the business rules.</span></span> <span data-ttu-id="b0d14-219">Проверяющие элементы управления не только предотвращают вызов метода `UpdateProduct` до тех пор, пока предоставленные пользователем данные являются допустимыми, но также предоставляют более информативный пользовательский интерфейс для выявления проблем ввода данных.</span><span class="sxs-lookup"><span data-stu-id="b0d14-219">The validation controls not only prevent the invocation of the `UpdateProduct` method until the user-supplied data is valid, but also provide a more informative user experience for identifying data entry problems.</span></span>

## <a name="step-3-gracefully-handling-bll-level-exceptions"></a><span data-ttu-id="b0d14-220">Шаг 3. корректное управление исключениями уровня BLL</span><span class="sxs-lookup"><span data-stu-id="b0d14-220">Step 3: Gracefully Handling BLL-Level Exceptions</span></span>

<span data-ttu-id="b0d14-221">При вставке, обновлении или удалении данных уровень доступа к данным может вызвать исключение на стороне ошибки, связанной с данными.</span><span class="sxs-lookup"><span data-stu-id="b0d14-221">When inserting, updating, or deleting data, the Data Access Layer may throw an exception in the face of a data-related error.</span></span> <span data-ttu-id="b0d14-222">Возможно, база данных находится в режиме «вне сети», в обязательном столбце таблицы базы данных может не быть указано значение или было нарушено ограничение на уровне таблицы.</span><span class="sxs-lookup"><span data-stu-id="b0d14-222">The database may be offline, a required database table column might not have had a value specified, or a table-level constraint may have been violated.</span></span> <span data-ttu-id="b0d14-223">В дополнение к строгим исключениям, связанным с данными, уровень бизнес-логики может использовать исключения, чтобы указать, когда нарушены бизнес-правила.</span><span class="sxs-lookup"><span data-stu-id="b0d14-223">In addition to strictly data-related exceptions, the Business Logic Layer can use exceptions to indicate when business rules have been violated.</span></span> <span data-ttu-id="b0d14-224">Например, в учебнике [Создание уровня бизнес-логики](../introduction/creating-a-business-logic-layer-cs.md) мы добавили проверку бизнес-правила в исходную перегрузку `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-224">In the [Creating a Business Logic Layer](../introduction/creating-a-business-logic-layer-cs.md) tutorial, for example, we added a business rule check to the original `UpdateProduct` overload.</span></span> <span data-ttu-id="b0d14-225">В частности, если пользователь пометил продукт как снятый с производства, нам требовалось, чтобы продукт был не единственным, предоставленным поставщиком.</span><span class="sxs-lookup"><span data-stu-id="b0d14-225">Specifically, if the user was marking a product as discontinued, we required that the product not be the only one provided by its supplier.</span></span> <span data-ttu-id="b0d14-226">Если это условие нарушено, выдается `ApplicationException`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-226">If this condition was violated, an `ApplicationException` was thrown.</span></span>

<span data-ttu-id="b0d14-227">Для перегрузки `UpdateProduct`, созданной в этом руководстве, мы добавим бизнес-правило, запрещающее присвоить `UnitPrice`ному полю новое значение, которое больше, чем в два раза больше исходного значения `UnitPrice`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-227">For the `UpdateProduct` overload created in this tutorial, let's add a business rule that prohibits the `UnitPrice` field from being set to a new value that's more than twice the original `UnitPrice` value.</span></span> <span data-ttu-id="b0d14-228">Для этого измените перегрузку `UpdateProduct`, чтобы она выполняла эту проверку и выдает исключение `ApplicationException` при нарушении правила.</span><span class="sxs-lookup"><span data-stu-id="b0d14-228">To accomplish this, adjust the `UpdateProduct` overload so that it performs this check and throws an `ApplicationException` if the rule is violated.</span></span> <span data-ttu-id="b0d14-229">Обновленный метод выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="b0d14-229">The updated method follows:</span></span>

[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample6.cs)]

<span data-ttu-id="b0d14-230">При таком изменении любое обновление цен, которое больше чем в два раза превышает существующую цену, приведет к появлению `ApplicationException`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-230">With this change, any price update that is more than twice the existing price will cause an `ApplicationException` to be thrown.</span></span> <span data-ttu-id="b0d14-231">Как и в случае с исключением, вызванным DAL, этот `ApplicationException`, создаваемый BLL, может быть обнаружен и обработан в обработчике событий `RowUpdated` GridView.</span><span class="sxs-lookup"><span data-stu-id="b0d14-231">Just like the exception raised from the DAL, this BLL-raised `ApplicationException` can be detected and handled in the GridView's `RowUpdated` event handler.</span></span> <span data-ttu-id="b0d14-232">На самом деле, код обработчика событий `RowUpdated`, как написано, будет правильно обнаруживать это исключение и отображать значение свойства `Message` `ApplicationException`.</span><span class="sxs-lookup"><span data-stu-id="b0d14-232">In fact, the `RowUpdated` event handler's code, as written, will correctly detect this exception and display the `ApplicationException`'s `Message` property value.</span></span> <span data-ttu-id="b0d14-233">На рис. 11 показан снимок экрана, когда пользователь пытается обновить цену Chai до $50,00, что превышает его текущую цену $19,95.</span><span class="sxs-lookup"><span data-stu-id="b0d14-233">Figure 11 shows a screen shot when a user attempts to update the price of Chai to $50.00, which is more than double its current price of $19.95.</span></span>

<span data-ttu-id="b0d14-234">[![бизнес-правила не допускать увеличения цены, чем удвоение цены продукта](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="b0d14-234">[![The Business Rules Disallow Price Increases That More Than Double a Product's Price](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image29.png)</span></span>

<span data-ttu-id="b0d14-235">**Рис. 11**. бизнес-правила не позволяют увеличить цену, превышающую цену продукта в два раза ([щелкните, чтобы просмотреть изображение с полным размером](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image31.png)).</span><span class="sxs-lookup"><span data-stu-id="b0d14-235">**Figure 11**: The Business Rules Disallow Price Increases That More Than Double a Product's Price ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image31.png))</span></span>

> [!NOTE]
> <span data-ttu-id="b0d14-236">В идеале наши правила бизнес-логики будут выделяться из `UpdateProduct` перегрузок методов и в общий метод.</span><span class="sxs-lookup"><span data-stu-id="b0d14-236">Ideally our business logic rules would be refactored out of the `UpdateProduct` method overloads and into a common method.</span></span> <span data-ttu-id="b0d14-237">Это осталось в качестве упражнения для читателя.</span><span class="sxs-lookup"><span data-stu-id="b0d14-237">This is left as an exercise for the reader.</span></span>

## <a name="summary"></a><span data-ttu-id="b0d14-238">Сводка</span><span class="sxs-lookup"><span data-stu-id="b0d14-238">Summary</span></span>

<span data-ttu-id="b0d14-239">Во время операций вставки, обновления и удаления веб-элемент управления данными и ObjectDataSource вызывают события до и после уровня, Букенд фактическую операцию.</span><span class="sxs-lookup"><span data-stu-id="b0d14-239">During inserting, updating, and deleting operations, both the data Web control and the ObjectDataSource involved fire pre- and post-level events that bookend the actual operation.</span></span> <span data-ttu-id="b0d14-240">Как было показано в этом руководстве и предыдущем, при работе с редактируемым элементом управления GridView срабатывает событие `RowUpdating` GridView, за которым следует событие `Updating` ObjectDataSource, после чего выполняется команда обновления для базового объекта ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="b0d14-240">As we saw in this tutorial and the preceding one, when working with an editable GridView the GridView's `RowUpdating` event fires, followed by the ObjectDataSource's `Updating` event, at which point the update command is made to the ObjectDataSource's underlying object.</span></span> <span data-ttu-id="b0d14-241">После завершения операции срабатывает событие `Updated` ObjectDataSource, за которым следует событие `RowUpdated` GridView.</span><span class="sxs-lookup"><span data-stu-id="b0d14-241">After the operation has completed, the ObjectDataSource's `Updated` event fires, followed by the GridView's `RowUpdated` event.</span></span>

<span data-ttu-id="b0d14-242">Мы можем создавать обработчики событий для событий предварительного уровня, чтобы настроить входные параметры или события последующей проверки, чтобы проверять результаты операции и реагировать на них.</span><span class="sxs-lookup"><span data-stu-id="b0d14-242">We can create event handlers for the pre-level events in order to customize the input parameters or for the post-level events in order to inspect and respond to the operation's results.</span></span> <span data-ttu-id="b0d14-243">Обработчики событий последующей проверки чаще всего используются для определения того, произошло ли исключение во время операции.</span><span class="sxs-lookup"><span data-stu-id="b0d14-243">Post-level event handlers are most commonly used to detect whether an exception occurred during the operation.</span></span> <span data-ttu-id="b0d14-244">В случае исключения эти обработчики событий последующей операции могут дополнительно обрабатывали исключение.</span><span class="sxs-lookup"><span data-stu-id="b0d14-244">In the face of an exception, these post-level event handlers can optionally handle the exception on their own.</span></span> <span data-ttu-id="b0d14-245">В этом учебнике мы увидели, как справиться с таким исключением, отображая понятное сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="b0d14-245">In this tutorial we saw how to handle such an exception by displaying a friendly error message.</span></span>

<span data-ttu-id="b0d14-246">В следующем учебном курсе мы рассмотрим, как уменьшить вероятность исключений, возникающих из-за проблем форматирования данных (например, при вводе отрицательного `UnitPrice`).</span><span class="sxs-lookup"><span data-stu-id="b0d14-246">In the next tutorial we'll see how to lessen the likelihood of exceptions arising from data formatting issues (such as entering a negative `UnitPrice`).</span></span> <span data-ttu-id="b0d14-247">В частности, мы рассмотрим добавление элементов управления проверки в интерфейсы правки и вставки.</span><span class="sxs-lookup"><span data-stu-id="b0d14-247">Specifically, we'll look at how to add validation controls to the editing and inserting interfaces.</span></span>

<span data-ttu-id="b0d14-248">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="b0d14-248">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="b0d14-249">Об авторе</span><span class="sxs-lookup"><span data-stu-id="b0d14-249">About the Author</span></span>

<span data-ttu-id="b0d14-250">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998.</span><span class="sxs-lookup"><span data-stu-id="b0d14-250">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="b0d14-251">Скотт работает как независимый консультант, преподаватель и модуль записи.</span><span class="sxs-lookup"><span data-stu-id="b0d14-251">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="b0d14-252">Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="b0d14-252">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="b0d14-253">Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="b0d14-253">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="b0d14-254">или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="b0d14-254">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="b0d14-255">Специальная благодарность</span><span class="sxs-lookup"><span data-stu-id="b0d14-255">Special Thanks To</span></span>

<span data-ttu-id="b0d14-256">Эта серия руководств была рассмотрена многими полезными рецензентами.</span><span class="sxs-lookup"><span data-stu-id="b0d14-256">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="b0d14-257">Специалист по интересу для этого руководства был основными рецензентами.</span><span class="sxs-lookup"><span data-stu-id="b0d14-257">Lead reviewer for this tutorial was Liz Shulok.</span></span> <span data-ttu-id="b0d14-258">Хотите ознакомиться с моими будущими статьями MSDN?</span><span class="sxs-lookup"><span data-stu-id="b0d14-258">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="b0d14-259">Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="b0d14-259">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="b0d14-260">[Назад](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md)
> [Вперед](adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md)</span><span class="sxs-lookup"><span data-stu-id="b0d14-260">[Previous](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md)
[Next](adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md)</span></span>
