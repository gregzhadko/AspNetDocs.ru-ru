---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs
title: Реализация оптимистичного параллелизма (C#) | Документация Майкрософт
author: rick-anderson
description: Для веб-приложения, которое позволяет нескольким пользователям изменять данные, существует риск того, что два пользователя могут одновременно изменять одни и те же данные. В этом тутори...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 56e15b33-93b8-43ad-8e19-44c6647ea05c
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs
msc.type: authoredcontent
ms.openlocfilehash: 3cddb0efd28249ffc5708ece39c80581d078a5a2
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74617516"
---
# <a name="implementing-optimistic-concurrency-c"></a><span data-ttu-id="2d0eb-104">Реализация оптимистичного параллелизма (C#)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-104">Implementing Optimistic Concurrency (C#)</span></span>

<span data-ttu-id="2d0eb-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="2d0eb-106">[Скачивание примера приложения](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_CS.exe) или [Загрузка PDF-файла](implementing-optimistic-concurrency-cs/_static/datatutorial21cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_CS.exe) or [Download PDF](implementing-optimistic-concurrency-cs/_static/datatutorial21cs1.pdf)</span></span>

> <span data-ttu-id="2d0eb-107">Для веб-приложения, которое позволяет нескольким пользователям изменять данные, существует риск того, что два пользователя могут одновременно изменять одни и те же данные.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-107">For a web application that allows multiple users to edit data, there is the risk that two users may be editing the same data at the same time.</span></span> <span data-ttu-id="2d0eb-108">В этом учебнике мы реализуем управление оптимистичным параллелизмом для обработки этого риска.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-108">In this tutorial we'll implement optimistic concurrency control to handle this risk.</span></span>

## <a name="introduction"></a><span data-ttu-id="2d0eb-109">Введение</span><span class="sxs-lookup"><span data-stu-id="2d0eb-109">Introduction</span></span>

<span data-ttu-id="2d0eb-110">Для веб-приложений, которые позволяют пользователям только просматривать данные, или только те, которые содержат только одного пользователя, который может изменять данные, не существует угрозы случайной перезаписи изменений одним из двух одновременно работающих пользователей.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-110">For web applications that only allow users to view data, or for those that include only a single user who can modify data, there's no threat of two concurrent users accidentally overwriting one another's changes.</span></span> <span data-ttu-id="2d0eb-111">Однако для веб-приложений, позволяющих нескольким пользователям обновлять или удалять данные, существует возможность конфликта изменений одного пользователя с другим одновременно выполняющимся пользователем.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-111">For web applications that allow multiple users to update or delete data, however, there's the potential for one user's modifications to clash with another concurrent user's.</span></span> <span data-ttu-id="2d0eb-112">Без политики параллелизма, когда два пользователя одновременно редактируют одну запись, пользователь, который зафиксирует свои изменения, переопределит изменения, внесенные первым.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-112">Without any concurrency policy in place, when two users are simultaneously editing a single record, the user who commits her changes last will override the changes made by the first.</span></span>

<span data-ttu-id="2d0eb-113">Например, предположим, что два пользователя, Цзисунь и SAM, посещали страницу в нашем приложении, которая позволяла посетителям обновлять и удалять продукты с помощью элемента управления GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-113">For example, imagine that two users, Jisun and Sam, were both visiting a page in our application that allowed visitors to update and delete the products through a GridView control.</span></span> <span data-ttu-id="2d0eb-114">Одновременно нажмите кнопку изменить в элементе управления GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-114">Both click the Edit button in the GridView around the same time.</span></span> <span data-ttu-id="2d0eb-115">Цзисунь изменяет название продукта на «чай Chai» и нажимает кнопку «Обновить».</span><span class="sxs-lookup"><span data-stu-id="2d0eb-115">Jisun changes the product name to "Chai Tea" and clicks the Update button.</span></span> <span data-ttu-id="2d0eb-116">Результатом является `UPDATE`ная инструкция, которая отправляется в базу данных, которая задает *все* обновляемые поля продукта (несмотря на то, что цзисунь только обновил одно поле, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-116">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product's updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="2d0eb-117">На данный момент база данных имеет значения «Чай Chai», «напитки категории», «поставщик Exotic Liquids» и т. д. для этого конкретного продукта.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-117">At this point in time, the database has the values "Chai Tea," the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="2d0eb-118">Однако на экране GridView в SAM по-прежнему отображается название продукта в редактируемой строке GridView в виде "Chai".</span><span class="sxs-lookup"><span data-stu-id="2d0eb-118">However, the GridView on Sam's screen still shows the product name in the editable GridView row as "Chai".</span></span> <span data-ttu-id="2d0eb-119">Через несколько секунд после фиксации изменений Цзисунь SAM обновляет категорию до «специи» и нажимает кнопку Обновить.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-119">A few seconds after Jisun's changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="2d0eb-120">В результате инструкция `UPDATE` отправляется в базу данных, которая задает имя продукта «Chai», `CategoryID` с соответствующим ИДЕНТИФИКАТОРом категории «напитки» и т. д.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-120">This results in an `UPDATE` statement sent to the database that sets the product name to "Chai," the `CategoryID` to the corresponding Beverages category ID, and so on.</span></span> <span data-ttu-id="2d0eb-121">Изменения в имени продукта цзисунь были перезаписаны.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-121">Jisun's changes to the product name have been overwritten.</span></span> <span data-ttu-id="2d0eb-122">На рис. 1 изображена эта серия событий.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-122">Figure 1 graphically depicts this series of events.</span></span>

<span data-ttu-id="2d0eb-123">[![, когда два пользователя одновременно обновляют запись a, существует вероятность того, что один пользователь s может перезаписать другие](implementing-optimistic-concurrency-cs/_static/image2.png)](implementing-optimistic-concurrency-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-123">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-cs/_static/image2.png)](implementing-optimistic-concurrency-cs/_static/image1.png)</span></span>

<span data-ttu-id="2d0eb-124">**Рис. 1**. когда два пользователя одновременно обновляют запись a, существует вероятность того, что один пользователь s может перезаписать другие ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image3.png)).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-124">**Figure 1**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image3.png))</span></span>

<span data-ttu-id="2d0eb-125">Аналогично, когда два пользователя посещает страницу, один пользователь может находиться в процессе обновления записи, когда он удаляется другим пользователем.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-125">Similarly, when two users are visiting a page, one user might be in the midst of updating a record when it is deleted by another user.</span></span> <span data-ttu-id="2d0eb-126">Или, если пользователь загружает страницу и при нажатии кнопки удалить другой пользователь мог изменить содержимое этой записи.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-126">Or, between when a user loads a page and when they click the Delete button, another user may have modified the contents of that record.</span></span>

<span data-ttu-id="2d0eb-127">Доступны три стратегии [управления параллелизмом](http://en.wikipedia.org/wiki/Concurrency_control) :</span><span class="sxs-lookup"><span data-stu-id="2d0eb-127">There are three [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) strategies available:</span></span>

- <span data-ttu-id="2d0eb-128">**Не предпринимать никаких действий** . Если одновременные пользователи изменяют одну и ту же запись, давайте выберем последнюю фиксацию (поведение по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-128">**Do Nothing** -if concurrent users are modifying the same record, let the last commit win (the default behavior)</span></span>
- <span data-ttu-id="2d0eb-129">[**Оптимистическая блокировка**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) — предполагается, что несмотря на то, что на каждый момент могут возникать конфликты параллелизма, большинство времени таких конфликтов не возникает. Таким образом, если возникает конфликт, просто сообщите пользователю, что изменения невозможно сохранить, так как другой пользователь изменил те же данные.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-129">[**Optimistic Concurrency**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) - assume that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise; therefore, if a conflict does arise, simply inform the user that their changes can't be saved because another user has modified the same data</span></span>
- <span data-ttu-id="2d0eb-130">**Пессимистичный параллелизм** — предполагается, что конфликты параллелизма являются распространенными, и пользователи не смогут сообщить о том, что изменения не были сохранены из-за одновременных действий другого пользователя. Таким образом, когда один пользователь начинает обновлять запись, блокирует его, тем самым запрещая другим пользователям изменять или удалять эту запись до тех пор, пока пользователь не зафиксирует свои изменения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-130">**Pessimistic Concurrency** - assume that concurrency conflicts are commonplace and that users won't tolerate being told their changes weren't saved due to another user's concurrent activity; therefore, when one user starts updating a record, lock it, thereby preventing any other users from editing or deleting that record until the user commits their modifications</span></span>

<span data-ttu-id="2d0eb-131">Все наши учебники, таким способом, использовали стратегию разрешения параллелизма по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-131">All of our tutorials thus far have used the default concurrency resolution strategy - namely, we've let the last write win.</span></span> <span data-ttu-id="2d0eb-132">В этом учебнике рассматривается реализация управления оптимистичным параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-132">In this tutorial we'll examine how to implement optimistic concurrency control.</span></span>

> [!NOTE]
> <span data-ttu-id="2d0eb-133">Мы не будем рассматривать примеры пессимистического параллелизма в этой серии руководств.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-133">We won't look at pessimistic concurrency examples in this tutorial series.</span></span> <span data-ttu-id="2d0eb-134">Пессимистичный параллелизм редко используется, так как такие блокировки, если они не были правильно использованы, могут препятствовать обновлению данных другими пользователями.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-134">Pessimistic concurrency is rarely used because such locks, if not properly relinquished, can prevent other users from updating data.</span></span> <span data-ttu-id="2d0eb-135">Например, если пользователь блокирует запись для редактирования, а затем остается в течение дня перед разблокировкой, другой пользователь не сможет обновить эту запись до тех пор, пока исходный пользователь не вернет и не завершит свое обновление.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-135">For example, if a user locks a record for editing and then leaves for the day before unlocking it, no other user will be able to update that record until the original user returns and completes his update.</span></span> <span data-ttu-id="2d0eb-136">Поэтому в ситуациях, когда используется пессимистичный параллелизм, обычно возникает время ожидания, при достижении которого блокировка отменяется.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-136">Therefore, in situations where pessimistic concurrency is used, there's typically a timeout that, if reached, cancels the lock.</span></span> <span data-ttu-id="2d0eb-137">Веб-сайты для продаж билетов, которые заблокируют определенное место в течение короткого периода времени, когда пользователь завершает процесс заказа, является примером управления пессимистичным параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-137">Ticket sales websites, which lock a particular seating location for short period while the user completes the order process, is an example of pessimistic concurrency control.</span></span>

## <a name="step-1-looking-at-how-optimistic-concurrency-is-implemented"></a><span data-ttu-id="2d0eb-138">Шаг 1. Просмотр реализации оптимистичного параллелизма</span><span class="sxs-lookup"><span data-stu-id="2d0eb-138">Step 1: Looking at How Optimistic Concurrency is Implemented</span></span>

<span data-ttu-id="2d0eb-139">Управление оптимистичным параллелизмом работает, гарантируя, что обновляемая или Удаляемая запись имеет те же значения, что и при запуске процесса обновления или удаления.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-139">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="2d0eb-140">Например, при нажатии кнопки изменить в редактируемом элементе GridView значения записи считываются из базы данных и отображаются в текстовых полях и других веб-элементах управления.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-140">For example, when clicking the Edit button in an editable GridView, the record's values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="2d0eb-141">Эти исходные значения сохраняются в GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-141">These original values are saved by the GridView.</span></span> <span data-ttu-id="2d0eb-142">Позже, после того, как пользователь вносит изменения и нажимает кнопку обновить, исходные значения и новые значения отправляются на уровень бизнес-логики, а затем на уровень доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-142">Later, after the user makes her changes and clicks the Update button, the original values plus the new values are sent to the Business Logic Layer, and then down to the Data Access Layer.</span></span> <span data-ttu-id="2d0eb-143">Уровень доступа к данным должен выдать инструкцию SQL, которая будет обновлять запись только в том случае, если исходные значения, которые пользователь запустил редактирование, идентичны значениям в базе данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-143">The Data Access Layer must issue a SQL statement that will only update the record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="2d0eb-144">На рис. 2 показана эта последовательность событий.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-144">Figure 2 depicts this sequence of events.</span></span>

<span data-ttu-id="2d0eb-145">[![для успешности обновления или удаления исходные значения должны быть равны текущим значениям базы данных.](implementing-optimistic-concurrency-cs/_static/image5.png)](implementing-optimistic-concurrency-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-145">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-cs/_static/image5.png)](implementing-optimistic-concurrency-cs/_static/image4.png)</span></span>

<span data-ttu-id="2d0eb-146">**Рис. 2**. для успешности обновления или удаления исходные значения должны быть равны текущим значениям базы данных ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image6.png)).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-146">**Figure 2**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image6.png))</span></span>

<span data-ttu-id="2d0eb-147">Существует множество подходов к реализации оптимистичного параллелизма (см. [Питер. статье](http://peterbromberg.net/) [логику обновления оптимистичного параллелизма](http://www.eggheadcafe.com/articles/20050719.asp) для краткого взгляда на ряд параметров).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-147">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="2d0eb-148">Типизированный набор данных ADO.NET предоставляет одну реализацию, которая может быть настроена только с тактом флажка.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-148">The ADO.NET Typed DataSet provides one implementation that can be configured with just the tick of a checkbox.</span></span> <span data-ttu-id="2d0eb-149">Включение оптимистичного параллелизма для TableAdapter в типизированном наборе данных дополняет операторы `UPDATE` и `DELETE` TableAdapter для включения сравнения всех исходных значений в предложении `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-149">Enabling optimistic concurrency for a TableAdapter in the Typed DataSet augments the TableAdapter's `UPDATE` and `DELETE` statements to include a comparison of all of the original values in the `WHERE` clause.</span></span> <span data-ttu-id="2d0eb-150">Следующая инструкция `UPDATE`, например, обновляет имя и цену продукта, только если значения текущей базы данных равны значениям, первоначально полученным при обновлении записи в GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-150">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="2d0eb-151">Параметры `@ProductName` и `@UnitPrice` содержат новые значения, введенные пользователем, тогда как `@original_ProductName` и `@original_UnitPrice` содержат значения, которые были первоначально загружены в GridView при нажатии кнопки "Изменить":</span><span class="sxs-lookup"><span data-stu-id="2d0eb-151">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-cs/samples/sample1.sql)]

> [!NOTE]
> <span data-ttu-id="2d0eb-152">Эта `UPDATE`ная инструкция была упрощена для удобочитаемости.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-152">This `UPDATE` statement has been simplified for readability.</span></span> <span data-ttu-id="2d0eb-153">На практике `UnitPrice`ная проверка в предложении `WHERE` будет более сложной, поскольку `UnitPrice` может содержать `NULL` и проверять, всегда возвращает ли `NULL = NULL` значение false (вместо этого необходимо использовать `IS NULL`).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-153">In practice, the `UnitPrice` check in the `WHERE` clause would be more involved since `UnitPrice` can contain `NULL` s and checking if `NULL = NULL` always returns False (instead you must use `IS NULL`).</span></span>

<span data-ttu-id="2d0eb-154">Помимо использования другой базовой инструкции `UPDATE`, Настройка TableAdapter для использования оптимистичного параллелизма также изменяет сигнатуру своих прямых методов базы данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-154">In addition to using a different underlying `UPDATE` statement, configuring a TableAdapter to use optimistic concurrency also modifies the signature of its DB direct methods.</span></span> <span data-ttu-id="2d0eb-155">Взпомним из нашего первого руководства, [*создания уровня доступа к данным*](../introduction/creating-a-data-access-layer-cs.md), что прямые методы базы данных принимают в качестве входных параметров список скалярных значений (а не строго типизированный экземпляр DataRow или DataTable).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-155">Recall from our first tutorial, [*Creating a Data Access Layer*](../introduction/creating-a-data-access-layer-cs.md), that DB direct methods were those that accepts a list of scalar values as input parameters (rather than a strongly-typed DataRow or DataTable instance).</span></span> <span data-ttu-id="2d0eb-156">При использовании оптимистичного параллелизма прямые `Update()` и `Delete()` методы базы данных включают также входные параметры для исходных значений.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-156">When using optimistic concurrency, the DB direct `Update()` and `Delete()` methods include input parameters for the original values as well.</span></span> <span data-ttu-id="2d0eb-157">Более того, код в BLL для использования шаблона пакетного обновления (`Update()` перегрузки методов, которые принимают строки данных и DataTable, а не скалярные значения), также должны быть изменены.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-157">Moreover, the code in the BLL for using the batch update pattern (the `Update()` method overloads that accept DataRows and DataTables rather than scalar values) must be changed as well.</span></span>

<span data-ttu-id="2d0eb-158">Вместо того чтобы расширять существующие адаптеры DAL для использования оптимистичного параллелизма (что требовало бы изменения слоя BLL для размещения), создадим новый типизированный набор данных с именем `NorthwindOptimisticConcurrency`, к которому мы добавим `Products` TableAdapter, использующий оптимистичный параллелизм.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-158">Rather than extend our existing DAL's TableAdapters to use optimistic concurrency (which would necessitate changing the BLL to accommodate), let's instead create a new Typed DataSet named `NorthwindOptimisticConcurrency`, to which we'll add a `Products` TableAdapter that uses optimistic concurrency.</span></span> <span data-ttu-id="2d0eb-159">Далее мы создадим `ProductsOptimisticConcurrencyBLL` класс уровня бизнес-логики, который содержит соответствующие изменения для поддержки DAL с оптимистичным параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-159">Following that, we'll create a `ProductsOptimisticConcurrencyBLL` Business Logic Layer class that has the appropriate modifications to support the optimistic concurrency DAL.</span></span> <span data-ttu-id="2d0eb-160">После размещения этого фундамента мы будем готовы к созданию страницы ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-160">Once this groundwork has been laid, we'll be ready to create the ASP.NET page.</span></span>

## <a name="step-2-creating-a-data-access-layer-that-supports-optimistic-concurrency"></a><span data-ttu-id="2d0eb-161">Шаг 2. Создание уровня доступа к данным, поддерживающего оптимистичный параллелизм</span><span class="sxs-lookup"><span data-stu-id="2d0eb-161">Step 2: Creating a Data Access Layer That Supports Optimistic Concurrency</span></span>

<span data-ttu-id="2d0eb-162">Чтобы создать новый типизированный набор данных, щелкните правой кнопкой мыши папку `DAL` в папке `App_Code` и добавьте новый набор данных с именем `NorthwindOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-162">To create a new Typed DataSet, right-click on the `DAL` folder within the `App_Code` folder and add a new DataSet named `NorthwindOptimisticConcurrency`.</span></span> <span data-ttu-id="2d0eb-163">Как мы видели в первом учебном курсе, это приведет к добавлению нового TableAdapter в типизированный набор данных, автоматически запуская мастер настройки адаптера таблицы.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-163">As we saw in the first tutorial, doing so will add a new TableAdapter to the Typed DataSet, automatically launching the TableAdapter Configuration Wizard.</span></span> <span data-ttu-id="2d0eb-164">На первом экране будет предложено указать базу данных для подключения, чтобы подключиться к той же базе данных Northwind, используя параметр `NORTHWNDConnectionString` из `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-164">In the first screen, we're prompted to specify the database to connect to - connect to the same Northwind database using the `NORTHWNDConnectionString` setting from `Web.config`.</span></span>

<span data-ttu-id="2d0eb-165">[![подключиться к той же базе данных Northwind](implementing-optimistic-concurrency-cs/_static/image8.png)](implementing-optimistic-concurrency-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-165">[![Connect to the Same Northwind Database](implementing-optimistic-concurrency-cs/_static/image8.png)](implementing-optimistic-concurrency-cs/_static/image7.png)</span></span>

<span data-ttu-id="2d0eb-166">**Рис. 3**. подключение к той же базе данных Northwind ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-166">**Figure 3**: Connect to the Same Northwind Database ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image9.png))</span></span>

<span data-ttu-id="2d0eb-167">Далее будет предложено запросить данные: с помощью специального оператора SQL, новой хранимой процедуры или существующей хранимой процедуры.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-167">Next, we are prompted as to how to query the data: through an ad-hoc SQL statement, a new stored procedure, or an existing stored procedure.</span></span> <span data-ttu-id="2d0eb-168">Так как мы использовали регламентированные запросы SQL в исходном DAL, используйте этот вариант.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-168">Since we used ad-hoc SQL queries in our original DAL, use this option here as well.</span></span>

<span data-ttu-id="2d0eb-169">[![указать данные для получения с помощью специального оператора SQL](implementing-optimistic-concurrency-cs/_static/image11.png)](implementing-optimistic-concurrency-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-169">[![Specify the Data to Retrieve Using an Ad-Hoc SQL Statement](implementing-optimistic-concurrency-cs/_static/image11.png)](implementing-optimistic-concurrency-cs/_static/image10.png)</span></span>

<span data-ttu-id="2d0eb-170">**Рис. 4**. Указание данных для получения с помощью специального оператора SQL ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-170">**Figure 4**: Specify the Data to Retrieve Using an Ad-Hoc SQL Statement ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image12.png))</span></span>

<span data-ttu-id="2d0eb-171">На следующем экране введите запрос SQL, который будет использоваться для получения сведений о продукте.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-171">On the following screen, enter the SQL query to use to retrieve the product information.</span></span> <span data-ttu-id="2d0eb-172">Давайте воспользуемся тем же запросом SQL, который используется для `Products` TableAdapter из оригинального DAL, который возвращает все `Product` столбцы вместе с названиями поставщика и категории продукта:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-172">Let's use the exact same SQL query used for the `Products` TableAdapter from our original DAL, which returns all of the `Product` columns along with the product's supplier and category names:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-cs/samples/sample2.sql)]

<span data-ttu-id="2d0eb-173">[![использовать тот же запрос SQL из TableAdapter Products в исходном DAL](implementing-optimistic-concurrency-cs/_static/image14.png)](implementing-optimistic-concurrency-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-173">[![Use the Same SQL Query from the Products TableAdapter in the Original DAL](implementing-optimistic-concurrency-cs/_static/image14.png)](implementing-optimistic-concurrency-cs/_static/image13.png)</span></span>

<span data-ttu-id="2d0eb-174">**Рис. 5**. использование того же SQL-запроса из `Products` TableAdapter в исходном DAL ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-174">**Figure 5**: Use the Same SQL Query from the `Products` TableAdapter in the Original DAL ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image15.png))</span></span>

<span data-ttu-id="2d0eb-175">Перед переходом к следующему экрану нажмите кнопку Дополнительные параметры.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-175">Before moving onto the next screen, click the Advanced Options button.</span></span> <span data-ttu-id="2d0eb-176">Чтобы этот адаптер таблицы применял управление оптимистичным параллелизмом, просто установите флажок "использовать оптимистичный параллелизм".</span><span class="sxs-lookup"><span data-stu-id="2d0eb-176">To have this TableAdapter employ optimistic concurrency control, simply check the "Use optimistic concurrency" checkbox.</span></span>

<span data-ttu-id="2d0eb-177">[![включить управление оптимистичным параллелизмом, установив флажок &quot;использовать оптимистичный параллелизм&quot;](implementing-optimistic-concurrency-cs/_static/image17.png)](implementing-optimistic-concurrency-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-177">[![Enable Optimistic Concurrency Control by Checking the &quot;Use optimistic concurrency&quot; CheckBox](implementing-optimistic-concurrency-cs/_static/image17.png)](implementing-optimistic-concurrency-cs/_static/image16.png)</span></span>

<span data-ttu-id="2d0eb-178">**Рис. 6**. Включение управления оптимистичным параллелизмом путем установки флажка "использовать оптимистичный параллелизм" ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-178">**Figure 6**: Enable Optimistic Concurrency Control by Checking the "Use optimistic concurrency" CheckBox ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image18.png))</span></span>

<span data-ttu-id="2d0eb-179">Наконец, укажите, что TableAdapter должен использовать шаблоны доступа к данным, заполняющие DataTable и возвращающие DataTable. также укажите, что необходимо создать прямые методы базы данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-179">Lastly, indicate that the TableAdapter should use the data access patterns that both fill a DataTable and return a DataTable; also indicate that the DB direct methods should be created.</span></span> <span data-ttu-id="2d0eb-180">Измените имя метода для возврата шаблона DataTable с GetData на Products, чтобы зеркально отобразить соглашения об именовании, использованные в исходном DAL.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-180">Change the method name for the Return a DataTable pattern from GetData to GetProducts, so as to mirror the naming conventions we used in our original DAL.</span></span>

<span data-ttu-id="2d0eb-181">[![, что TableAdapter использует все шаблоны доступа к данным](implementing-optimistic-concurrency-cs/_static/image20.png)](implementing-optimistic-concurrency-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-181">[![Have the TableAdapter Utilize All Data Access Patterns](implementing-optimistic-concurrency-cs/_static/image20.png)](implementing-optimistic-concurrency-cs/_static/image19.png)</span></span>

<span data-ttu-id="2d0eb-182">**Рис. 7**. использование всех шаблонов доступа к данным в TableAdapter ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-182">**Figure 7**: Have the TableAdapter Utilize All Data Access Patterns ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image21.png))</span></span>

<span data-ttu-id="2d0eb-183">После завершения работы мастера конструктор наборов данных будет включать в себя строго типизированный `Products` DataTable и TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-183">After completing the wizard, the DataSet Designer will include a strongly-typed `Products` DataTable and TableAdapter.</span></span> <span data-ttu-id="2d0eb-184">Уделите время переименованию таблицы данных из `Products` в `ProductsOptimisticConcurrency`, которую можно сделать, щелкнув правой кнопкой мыши заголовок DataTable и выбрав пункт Переименовать в контекстном меню.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-184">Take a moment to rename the DataTable from `Products` to `ProductsOptimisticConcurrency`, which you can do by right-clicking on the DataTable's title bar and choosing Rename from the context menu.</span></span>

<span data-ttu-id="2d0eb-185">[![DataTable и TableAdapter добавлены в типизированный набор данных](implementing-optimistic-concurrency-cs/_static/image23.png)](implementing-optimistic-concurrency-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-185">[![A DataTable and TableAdapter Have Been Added to the Typed DataSet](implementing-optimistic-concurrency-cs/_static/image23.png)](implementing-optimistic-concurrency-cs/_static/image22.png)</span></span>

<span data-ttu-id="2d0eb-186">**Рис. 8**. таблицы данных и TableAdapter были добавлены в типизированный набор данных ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-186">**Figure 8**: A DataTable and TableAdapter Have Been Added to the Typed DataSet ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image24.png))</span></span>

<span data-ttu-id="2d0eb-187">Чтобы увидеть различия между запросами `UPDATE` и `DELETE` между `ProductsOptimisticConcurrency` TableAdapter (который использует оптимистичный параллелизм) и TableAdapter Products (который не), щелкните TableAdapter и перейдите к окно свойств.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-187">To see the differences between the `UPDATE` and `DELETE` queries between the `ProductsOptimisticConcurrency` TableAdapter (which uses optimistic concurrency) and the Products TableAdapter (which doesn't), click on the TableAdapter and go to the Properties window.</span></span> <span data-ttu-id="2d0eb-188">В подсвойствах `DeleteCommand` и `UpdateCommand` свойства "`CommandText` можно увидеть фактический синтаксис SQL, который отправляется в базу данных при вызове методов DAL, связанных с обновлением или удалением.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-188">In the `DeleteCommand` and `UpdateCommand` properties' `CommandText` subproperties you can see the actual SQL syntax that is sent to the database when the DAL's update or delete-related methods are invoked.</span></span> <span data-ttu-id="2d0eb-189">Для `ProductsOptimisticConcurrency` TableAdapter используется инструкция `DELETE`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-189">For the `ProductsOptimisticConcurrency` TableAdapter the `DELETE` statement used is:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-cs/samples/sample3.sql)]

<span data-ttu-id="2d0eb-190">В то время как оператор `DELETE` для TableAdapter продукта в нашем исходном DAL гораздо проще:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-190">Whereas the `DELETE` statement for the Product TableAdapter in our original DAL is the much simpler:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-cs/samples/sample4.sql)]

<span data-ttu-id="2d0eb-191">Как видите, предложение `WHERE` в инструкции `DELETE` для TableAdapter, использующего оптимистичный параллелизм, включает сравнение значений существующих столбцов `Product` таблицы и исходных значений во время последнего заполнения элемента управления GridView (или DetailsView или FormView).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-191">As you can see, the `WHERE` clause in the `DELETE` statement for the TableAdapter that uses optimistic concurrency includes a comparison between each of the `Product` table's existing column values and the original values at the time the GridView (or DetailsView or FormView) was last populated.</span></span> <span data-ttu-id="2d0eb-192">Так как все поля, кроме `ProductID`, `ProductName`и `Discontinued`, могут иметь `NULL` значения, дополнительные параметры и проверки включены для правильного сравнения значений `NULL` в предложении `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-192">Since all fields other than `ProductID`, `ProductName`, and `Discontinued` can have `NULL` values, additional parameters and checks are included to correctly compare `NULL` values in the `WHERE` clause.</span></span>

<span data-ttu-id="2d0eb-193">Мы не будем добавлять дополнительные таблицы DataTable в набор данных с поддержкой оптимистичного параллелизма для этого руководства, так как наша страница ASP.NET предоставит только обновление и удаление сведений о продукте.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-193">We won't be adding any additional DataTables to the optimistic concurrency-enabled DataSet for this tutorial, as our ASP.NET page will only provide updating and deleting product information.</span></span> <span data-ttu-id="2d0eb-194">Однако нам по-прежнему нужно добавить метод `GetProductByProductID(productID)` в `ProductsOptimisticConcurrency` TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-194">However, we do still need to add the `GetProductByProductID(productID)` method to the `ProductsOptimisticConcurrency` TableAdapter.</span></span>

<span data-ttu-id="2d0eb-195">Для этого щелкните правой кнопкой мыши заголовок TableAdapter (область справа над `Fill` и `GetProducts` имен методов) и выберите в контекстном меню команду Добавить запрос.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-195">To accomplish this, right-click on the TableAdapter's title bar (the area right above the `Fill` and `GetProducts` method names) and choose Add Query from the context menu.</span></span> <span data-ttu-id="2d0eb-196">Запустится мастер настройки запросов адаптера таблицы.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-196">This will launch the TableAdapter Query Configuration Wizard.</span></span> <span data-ttu-id="2d0eb-197">Как и в случае начальной настройки TableAdapter, необходимо создать `GetProductByProductID(productID)` метод с помощью специального оператора SQL (см. рис. 4).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-197">As with our TableAdapter's initial configuration, opt to create the `GetProductByProductID(productID)` method using an ad-hoc SQL statement (see Figure 4).</span></span> <span data-ttu-id="2d0eb-198">Поскольку метод `GetProductByProductID(productID)` возвращает сведения о конкретном продукте, укажите, что этот запрос является `SELECT` типом запроса, возвращающим строки.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-198">Since the `GetProductByProductID(productID)` method returns information about a particular product, indicate that this query is a `SELECT` query type that returns rows.</span></span>

<span data-ttu-id="2d0eb-199">[![отметить тип запроса &quot;SELECT, который возвращает строки&quot;](implementing-optimistic-concurrency-cs/_static/image26.png)](implementing-optimistic-concurrency-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-199">[![Mark the Query Type as a &quot;SELECT which returns rows&quot;](implementing-optimistic-concurrency-cs/_static/image26.png)](implementing-optimistic-concurrency-cs/_static/image25.png)</span></span>

<span data-ttu-id="2d0eb-200">**Рис. 9**. Пометка типа запроса как «`SELECT` который возвращает строки» ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-200">**Figure 9**: Mark the Query Type as a "`SELECT` which returns rows" ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image27.png))</span></span>

<span data-ttu-id="2d0eb-201">На следующем экране будет предложено использовать SQL-запрос с предварительной загрузкой запроса TableAdapter по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-201">On the next screen we're prompted for the SQL query to use, with the TableAdapter's default query pre-loaded.</span></span> <span data-ttu-id="2d0eb-202">Дополните существующий запрос, включив в него предложение `WHERE ProductID = @ProductID`, как показано на рис. 10.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-202">Augment the existing query to include the clause `WHERE ProductID = @ProductID`, as shown in Figure 10.</span></span>

<span data-ttu-id="2d0eb-203">[![добавить предложение WHERE в предварительно загруженный запрос для возврата конкретной записи продукта](implementing-optimistic-concurrency-cs/_static/image29.png)](implementing-optimistic-concurrency-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-203">[![Add a WHERE Clause to the Pre-Loaded Query to Return a Specific Product Record](implementing-optimistic-concurrency-cs/_static/image29.png)](implementing-optimistic-concurrency-cs/_static/image28.png)</span></span>

<span data-ttu-id="2d0eb-204">**Рис. 10**. добавление предложения `WHERE` в предварительно загруженный запрос для возврата определенной записи продукта ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-204">**Figure 10**: Add a `WHERE` Clause to the Pre-Loaded Query to Return a Specific Product Record ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image30.png))</span></span>

<span data-ttu-id="2d0eb-205">Наконец, измените имена созданных методов на `FillByProductID` и `GetProductByProductID`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-205">Finally, change the generated method names to `FillByProductID` and `GetProductByProductID`.</span></span>

<span data-ttu-id="2d0eb-206">[![переименование методов в Филлбипродуктид и Жетпродуктбипродуктид](implementing-optimistic-concurrency-cs/_static/image32.png)](implementing-optimistic-concurrency-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-206">[![Rename the Methods to FillByProductID and GetProductByProductID](implementing-optimistic-concurrency-cs/_static/image32.png)](implementing-optimistic-concurrency-cs/_static/image31.png)</span></span>

<span data-ttu-id="2d0eb-207">**Рис. 11**. Переименование методов в `FillByProductID` и `GetProductByProductID` ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-207">**Figure 11**: Rename the Methods to `FillByProductID` and `GetProductByProductID` ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image33.png))</span></span>

<span data-ttu-id="2d0eb-208">После завершения работы мастера TableAdapter теперь содержит два метода получения данных: `GetProducts()`, который возвращает *все* продукты. и `GetProductByProductID(productID)`, которые возвращают указанный продукт.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-208">With this wizard complete, the TableAdapter now contains two methods for retrieving data: `GetProducts()`, which returns *all* products; and `GetProductByProductID(productID)`, which returns the specified product.</span></span>

## <a name="step-3-creating-a-business-logic-layer-for-the-optimistic-concurrency-enabled-dal"></a><span data-ttu-id="2d0eb-209">Шаг 3. Создание уровня бизнес-логики для DAL с поддержкой оптимистичного параллелизма</span><span class="sxs-lookup"><span data-stu-id="2d0eb-209">Step 3: Creating a Business Logic Layer for the Optimistic Concurrency-Enabled DAL</span></span>

<span data-ttu-id="2d0eb-210">Наш существующий класс `ProductsBLL` содержит примеры использования как пакетного обновления, так и непосредственного шаблона базы данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-210">Our existing `ProductsBLL` class has examples of using both the batch update and DB direct patterns.</span></span> <span data-ttu-id="2d0eb-211">Метод `AddProduct` и `UpdateProduct` перегрузки используют шаблон пакетного обновления, передавая экземпляр `ProductRow` в метод Update метода TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-211">The `AddProduct` method and `UpdateProduct` overloads both use the batch update pattern, passing in a `ProductRow` instance to the TableAdapter's Update method.</span></span> <span data-ttu-id="2d0eb-212">Метод `DeleteProduct`, с другой стороны, использует прямой шаблон базы данных, вызывая метод `Delete(productID)` TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-212">The `DeleteProduct` method, on the other hand, uses the DB direct pattern, calling the TableAdapter's `Delete(productID)` method.</span></span>

<span data-ttu-id="2d0eb-213">При использовании нового `ProductsOptimisticConcurrency` TableAdapter прямые методы базы данных теперь потребовали передачи исходных значений.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-213">With the new `ProductsOptimisticConcurrency` TableAdapter, the DB direct methods now require that the original values also be passed in.</span></span> <span data-ttu-id="2d0eb-214">Например, метод `Delete` теперь ожидает десять входных параметров: исходные `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`и `Discontinued`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-214">For example, the `Delete` method now expects ten input parameters: the original `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, and `Discontinued`.</span></span> <span data-ttu-id="2d0eb-215">Он использует эти дополнительные значения входных параметров в предложении `WHERE` инструкции `DELETE`, отправляемой в базу данных, и удаляет только указанную запись, если текущие значения базы данных соответствуют исходным.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-215">It uses these additional input parameters' values in `WHERE` clause of the `DELETE` statement sent to the database, only deleting the specified record if the database's current values map up to the original ones.</span></span>

<span data-ttu-id="2d0eb-216">Хотя сигнатура метода для метода `Update` TableAdapter, используемого в шаблоне пакетного обновления, не изменилась, код, необходимый для записи исходного и нового значений, имеет значение.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-216">While the method signature for the TableAdapter's `Update` method used in the batch update pattern hasn't changed, the code needed to record the original and new values has.</span></span> <span data-ttu-id="2d0eb-217">Таким образом, вместо того, чтобы пытаться использовать DAL с поддержкой оптимистичного параллелизма с нашим существующим классом `ProductsBLL`, создадим новый класс уровня бизнес-логики для работы с нашим новым DAL.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-217">Therefore, rather than attempt to use the optimistic concurrency-enabled DAL with our existing `ProductsBLL` class, let's create a new Business Logic Layer class for working with our new DAL.</span></span>

<span data-ttu-id="2d0eb-218">Добавьте класс с именем `ProductsOptimisticConcurrencyBLL` в папку `BLL` в папке `App_Code`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-218">Add a class named `ProductsOptimisticConcurrencyBLL` to the `BLL` folder within the `App_Code` folder.</span></span>

![Добавление класса ProductsOptimisticConcurrencyBLL в папку BLL](implementing-optimistic-concurrency-cs/_static/image34.png)

<span data-ttu-id="2d0eb-220">**Рис. 12**. добавление класса `ProductsOptimisticConcurrencyBLL` в папку BLL</span><span class="sxs-lookup"><span data-stu-id="2d0eb-220">**Figure 12**: Add the `ProductsOptimisticConcurrencyBLL` Class to the BLL Folder</span></span>

<span data-ttu-id="2d0eb-221">Затем добавьте следующий код в класс `ProductsOptimisticConcurrencyBLL`:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-221">Next, add the following code to the `ProductsOptimisticConcurrencyBLL` class:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample5.cs)]

<span data-ttu-id="2d0eb-222">Обратите внимание на оператор using `NorthwindOptimisticConcurrencyTableAdapters` над началом объявления класса.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-222">Note the using `NorthwindOptimisticConcurrencyTableAdapters` statement above the start of the class declaration.</span></span> <span data-ttu-id="2d0eb-223">Пространство имен `NorthwindOptimisticConcurrencyTableAdapters` содержит класс `ProductsOptimisticConcurrencyTableAdapter`, который предоставляет методы DAL.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-223">The `NorthwindOptimisticConcurrencyTableAdapters` namespace contains the `ProductsOptimisticConcurrencyTableAdapter` class, which provides the DAL's methods.</span></span> <span data-ttu-id="2d0eb-224">Кроме того, перед объявлением класса вы найдете атрибут `System.ComponentModel.DataObject`, который указывает Visual Studio включить этот класс в раскрывающийся список мастера ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-224">Also before the class declaration you'll find the `System.ComponentModel.DataObject` attribute, which instructs Visual Studio to include this class in the ObjectDataSource wizard's drop-down list.</span></span>

<span data-ttu-id="2d0eb-225">Свойство `Adapter` `ProductsOptimisticConcurrencyBLL`обеспечивает быстрый доступ к экземпляру класса `ProductsOptimisticConcurrencyTableAdapter` и соответствует шаблону, используемому в исходных классах BLL (`ProductsBLL`, `CategoriesBLL`и т. д.).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-225">The `ProductsOptimisticConcurrencyBLL`'s `Adapter` property provides quick access to an instance of the `ProductsOptimisticConcurrencyTableAdapter` class, and follows the pattern used in our original BLL classes (`ProductsBLL`, `CategoriesBLL`, and so on).</span></span> <span data-ttu-id="2d0eb-226">Наконец, метод `GetProducts()` просто вызывает метод `GetProducts()` DAL и возвращает объект `ProductsOptimisticConcurrencyDataTable`, заполненный экземпляром `ProductsOptimisticConcurrencyRow` для каждой записи продукта в базе данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-226">Finally, the `GetProducts()` method simply calls down into the DAL's `GetProducts()` method and returns a `ProductsOptimisticConcurrencyDataTable` object populated with a `ProductsOptimisticConcurrencyRow` instance for each product record in the database.</span></span>

## <a name="deleting-a-product-using-the-db-direct-pattern-with-optimistic-concurrency"></a><span data-ttu-id="2d0eb-227">Удаление продукта с помощью прямого шаблона базы данных с оптимистичным параллелизмом</span><span class="sxs-lookup"><span data-stu-id="2d0eb-227">Deleting a Product Using the DB Direct Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="2d0eb-228">При использовании прямого шаблона базы данных для DAL, использующего оптимистичный параллелизм, методам должны быть переданы новые и исходные значения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-228">When using the DB direct pattern against a DAL that uses optimistic concurrency, the methods must be passed the new and original values.</span></span> <span data-ttu-id="2d0eb-229">Для удаления нет новых значений, поэтому необходимо передать только исходные значения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-229">For deleting, there are no new values, so only the original values need be passed in.</span></span> <span data-ttu-id="2d0eb-230">В нашем BLL мы должны принять все исходные параметры в качестве входных параметров.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-230">In our BLL, then, we must accept all of the original parameters as input parameters.</span></span> <span data-ttu-id="2d0eb-231">Давайте разберем метод `DeleteProduct` в классе `ProductsOptimisticConcurrencyBLL`, используя прямой метод DB.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-231">Let's have the `DeleteProduct` method in the `ProductsOptimisticConcurrencyBLL` class use the DB direct method.</span></span> <span data-ttu-id="2d0eb-232">Это означает, что этот метод должен взять все десять полей данных продукта в качестве входных параметров и передать их в DAL, как показано в следующем коде:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-232">This means that this method needs to take in all ten product data fields as input parameters, and pass these to the DAL, as shown in the following code:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample6.cs)]

<span data-ttu-id="2d0eb-233">Если исходные значения — эти значения, которые были последний раз загружены в GridView (или DetailsView или FormView), отличаются от значений в базе данных, когда пользователь нажимает кнопку "Удалить", предложение `WHERE` не будет соответствовать ни одной записи базы данных, а записи не будут затронуты.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-233">If the original values - those values that were last loaded into the GridView (or DetailsView or FormView) - differ from the values in the database when the user clicks the Delete button the `WHERE` clause won't match up with any database record and no records will be affected.</span></span> <span data-ttu-id="2d0eb-234">Таким образом, метод `Delete` TableAdapter вернет `0`, а метод `DeleteProduct` BLL возвратит `false`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-234">Hence, the TableAdapter's `Delete` method will return `0` and the BLL's `DeleteProduct` method will return `false`.</span></span>

## <a name="updating-a-product-using-the-batch-update-pattern-with-optimistic-concurrency"></a><span data-ttu-id="2d0eb-235">Обновление продукта с помощью шаблона пакетного обновления с оптимистичным параллелизмом</span><span class="sxs-lookup"><span data-stu-id="2d0eb-235">Updating a Product Using the Batch Update Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="2d0eb-236">Как отмечалось ранее, метод `Update` TableAdapter для шаблона пакетного обновления имеет одинаковую сигнатуру метода независимо от того, используется ли оптимистичный параллелизм или нет.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-236">As noted earlier, the TableAdapter's `Update` method for the batch update pattern has the same method signature regardless of whether or not optimistic concurrency is employed.</span></span> <span data-ttu-id="2d0eb-237">А именно, метод `Update` ждет DataRow, массив строк, объект DataTable или типизированный набор данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-237">Namely, the `Update` method expects a DataRow, an array of DataRows, a DataTable, or a Typed DataSet.</span></span> <span data-ttu-id="2d0eb-238">Отсутствуют дополнительные входные параметры для указания исходных значений.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-238">There are no additional input parameters for specifying the original values.</span></span> <span data-ttu-id="2d0eb-239">Это возможно, поскольку объект DataTable отслеживает исходные и измененные значения для объектов DataRow.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-239">This is possible because the DataTable keeps track of the original and modified values for its DataRow(s).</span></span> <span data-ttu-id="2d0eb-240">Когда DAL выдает инструкцию `UPDATE`, параметры `@original_ColumnName` заполняются исходными значениями DataRow, в то время как параметры `@ColumnName` заполняются измененными значениями DataRow.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-240">When the DAL issues its `UPDATE` statement, the `@original_ColumnName` parameters are populated with the DataRow's original values, whereas the `@ColumnName` parameters are populated with the DataRow's modified values.</span></span>

<span data-ttu-id="2d0eb-241">В классе `ProductsBLL` (который использует наш первоначальный DAL, не поддерживающий оптимистичный параллелизм) при использовании шаблона пакетного обновления для обновления сведений о продукте наш код выполняет следующую последовательность событий:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-241">In the `ProductsBLL` class (which uses our original, non-optimistic concurrency DAL), when using the batch update pattern to update product information our code performs the following sequence of events:</span></span>

1. <span data-ttu-id="2d0eb-242">Чтение текущей информации о продукте базы данных в экземпляре `ProductRow` с помощью метода `GetProductByProductID(productID)` TableAdapter</span><span class="sxs-lookup"><span data-stu-id="2d0eb-242">Read the current database product information into a `ProductRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="2d0eb-243">Назначьте новые значения экземпляру `ProductRow` из шага 1.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-243">Assign the new values to the `ProductRow` instance from Step 1</span></span>
3. <span data-ttu-id="2d0eb-244">Вызовите метод `Update` TableAdapter, передав экземпляр `ProductRow`</span><span class="sxs-lookup"><span data-stu-id="2d0eb-244">Call the TableAdapter's `Update` method, passing in the `ProductRow` instance</span></span>

<span data-ttu-id="2d0eb-245">Однако эта последовательность шагов не будет правильно поддерживать оптимистичный параллелизм, поскольку `ProductRow`, заполненные на шаге 1, заполняются непосредственно из базы данных. Это означает, что исходные значения, используемые DataRow, являются теми, которые в настоящее время существуют в базе данных, а не привязаны к GridView в начале процесса редактирования.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-245">This sequence of steps, however, won't correctly support optimistic concurrency because the `ProductRow` populated in Step 1 is populated directly from the database, meaning that the original values used by the DataRow are those that currently exist in the database, and not those that were bound to the GridView at the start of the editing process.</span></span> <span data-ttu-id="2d0eb-246">Вместо этого при использовании DAL с поддержкой оптимистичного параллелизма необходимо изменить `UpdateProduct` перегрузки метода, чтобы выполнить следующие действия.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-246">Instead, when using an optimistic concurrency-enabled DAL, we need to alter the `UpdateProduct` method overloads to use the following steps:</span></span>

1. <span data-ttu-id="2d0eb-247">Чтение текущей информации о продукте базы данных в экземпляре `ProductsOptimisticConcurrencyRow` с помощью метода `GetProductByProductID(productID)` TableAdapter</span><span class="sxs-lookup"><span data-stu-id="2d0eb-247">Read the current database product information into a `ProductsOptimisticConcurrencyRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="2d0eb-248">Присвойте *исходные* значения экземпляру `ProductsOptimisticConcurrencyRow` из шага 1.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-248">Assign the *original* values to the `ProductsOptimisticConcurrencyRow` instance from Step 1</span></span>
3. <span data-ttu-id="2d0eb-249">Вызовите метод `AcceptChanges()` экземпляра `ProductsOptimisticConcurrencyRow`, который указывает DataRow, что его текущие значения являются "исходными".</span><span class="sxs-lookup"><span data-stu-id="2d0eb-249">Call the `ProductsOptimisticConcurrencyRow` instance's `AcceptChanges()` method, which instructs the DataRow that its current values are the "original" ones</span></span>
4. <span data-ttu-id="2d0eb-250">Присвоить *новые* значения экземпляру `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="2d0eb-250">Assign the *new* values to the `ProductsOptimisticConcurrencyRow` instance</span></span>
5. <span data-ttu-id="2d0eb-251">Вызовите метод `Update` TableAdapter, передав экземпляр `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="2d0eb-251">Call the TableAdapter's `Update` method, passing in the `ProductsOptimisticConcurrencyRow` instance</span></span>

<span data-ttu-id="2d0eb-252">Шаг 1 считывает все значения текущей базы данных для указанной записи продукта.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-252">Step 1 reads in all of the current database values for the specified product record.</span></span> <span data-ttu-id="2d0eb-253">Этот шаг является избыточным в перегрузке `UpdateProduct`, которая обновляет *все* столбцы продукта (так как эти значения перезаписываются на шаге 2), но это важно для этих перегрузок, где только подмножество значений столбца передается в качестве входных параметров.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-253">This step is superfluous in the `UpdateProduct` overload that updates *all* of the product columns (as these values are overwritten in Step 2), but is essential for those overloads where only a subset of the column values are passed in as input parameters.</span></span> <span data-ttu-id="2d0eb-254">После назначения исходных значений экземпляру `ProductsOptimisticConcurrencyRow` вызывается метод `AcceptChanges()`, который помечает текущие значения DataRow как исходные значения, которые будут использоваться в параметрах `@original_ColumnName` в инструкции `UPDATE`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-254">Once the original values have been assigned to the `ProductsOptimisticConcurrencyRow` instance, the `AcceptChanges()` method is called, which marks the current DataRow values as the original values to be used in the `@original_ColumnName` parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="2d0eb-255">Затем новые значения параметров присваиваются `ProductsOptimisticConcurrencyRow` и, наконец, вызывается метод `Update`, передающий DataRow.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-255">Next, the new parameter values are assigned to the `ProductsOptimisticConcurrencyRow` and, finally, the `Update` method is invoked, passing in the DataRow.</span></span>

<span data-ttu-id="2d0eb-256">В следующем коде показана перегрузка `UpdateProduct`, принимающая все поля данных продукта в качестве входных параметров.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-256">The following code shows the `UpdateProduct` overload that accepts all product data fields as input parameters.</span></span> <span data-ttu-id="2d0eb-257">Хотя это и не показано здесь, `ProductsOptimisticConcurrencyBLL` класс, входящий в загрузку для этого учебника, также содержит перегрузку `UpdateProduct`, которая принимает только имя и цену продукта в качестве входных параметров.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-257">While not shown here, the `ProductsOptimisticConcurrencyBLL` class included in the download for this tutorial also contains an `UpdateProduct` overload that accepts just the product's name and price as input parameters.</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample7.cs)]

## <a name="step-4-passing-the-original-and-new-values-from-the-aspnet-page-to-the-bll-methods"></a><span data-ttu-id="2d0eb-258">Шаг 4. передача исходного и нового значений со страницы ASP.NET в методы BLL</span><span class="sxs-lookup"><span data-stu-id="2d0eb-258">Step 4: Passing the Original and New Values From the ASP.NET Page to the BLL Methods</span></span>

<span data-ttu-id="2d0eb-259">После выполнения DAL и BLL остается только создать страницу ASP.NET, которая может использовать логику оптимистичного параллелизма, встроенную в систему.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-259">With the DAL and BLL complete, all that remains is to create an ASP.NET page that can utilize the optimistic concurrency logic built in to the system.</span></span> <span data-ttu-id="2d0eb-260">В частности, веб-элемент управления данными (GridView, DetailsView или FormView) должен запомнить свои исходные значения, и ObjectDataSource должен передать оба набора значений на уровень бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-260">Specifically, the data Web control (the GridView, DetailsView, or FormView) must remember its original values and the ObjectDataSource must pass both sets of values to the Business Logic Layer.</span></span> <span data-ttu-id="2d0eb-261">Более того, страница ASP.NET должна быть настроена для корректной обработки нарушений параллелизма.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-261">Furthermore, the ASP.NET page must be configured to gracefully handle concurrency violations.</span></span>

<span data-ttu-id="2d0eb-262">Для начала откройте страницу `OptimisticConcurrency.aspx` в папке `EditInsertDelete` и добавьте GridView в конструктор, установив для свойства `ID` значение `ProductsGrid`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-262">Start by opening the `OptimisticConcurrency.aspx` page in the `EditInsertDelete` folder and adding a GridView to the Designer, setting its `ID` property to `ProductsGrid`.</span></span> <span data-ttu-id="2d0eb-263">В смарт-теге GridView выберите создать новый элемент управления ObjectDataSource с именем `ProductsOptimisticConcurrencyDataSource`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-263">From the GridView's smart tag, opt to create a new ObjectDataSource named `ProductsOptimisticConcurrencyDataSource`.</span></span> <span data-ttu-id="2d0eb-264">Поскольку нам требуется, чтобы этот элемент управления ObjectDataSource использовал DAL, поддерживающий оптимистичный параллелизм, настройте его для использования объекта `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-264">Since we want this ObjectDataSource to use the DAL that supports optimistic concurrency, configure it to use the `ProductsOptimisticConcurrencyBLL` object.</span></span>

<span data-ttu-id="2d0eb-265">[![, что ObjectDataSource использует объект ProductsOptimisticConcurrencyBLL](implementing-optimistic-concurrency-cs/_static/image36.png)](implementing-optimistic-concurrency-cs/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-265">[![Have the ObjectDataSource Use the ProductsOptimisticConcurrencyBLL Object](implementing-optimistic-concurrency-cs/_static/image36.png)](implementing-optimistic-concurrency-cs/_static/image35.png)</span></span>

<span data-ttu-id="2d0eb-266">**Рис. 13**. Использование ObjectDataSource для объекта `ProductsOptimisticConcurrencyBLL` ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-266">**Figure 13**: Have the ObjectDataSource Use the `ProductsOptimisticConcurrencyBLL` Object ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image37.png))</span></span>

<span data-ttu-id="2d0eb-267">В раскрывающихся списках мастера выберите `GetProducts`, `UpdateProduct`и `DeleteProduct` методы.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-267">Choose the `GetProducts`, `UpdateProduct`, and `DeleteProduct` methods from drop-down lists in the wizard.</span></span> <span data-ttu-id="2d0eb-268">Для метода UpdateProduct используйте перегрузку, которая принимает все поля данных продукта.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-268">For the UpdateProduct method, use the overload that accepts all of the product's data fields.</span></span>

## <a name="configuring-the-objectdatasource-controls-properties"></a><span data-ttu-id="2d0eb-269">Настройка свойств элемента управления ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="2d0eb-269">Configuring the ObjectDataSource Control's Properties</span></span>

<span data-ttu-id="2d0eb-270">После завершения работы мастера декларативная разметка ObjectDataSource должна выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-270">After completing the wizard, the ObjectDataSource's declarative markup should look like the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample8.aspx)]

<span data-ttu-id="2d0eb-271">Как видите, коллекция `DeleteParameters` содержит экземпляр `Parameter` для каждого из десяти входных параметров в методе `DeleteProduct` класса `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-271">As you can see, the `DeleteParameters` collection contains a `Parameter` instance for each of the ten input parameters in the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method.</span></span> <span data-ttu-id="2d0eb-272">Аналогичным образом коллекция `UpdateParameters` содержит экземпляр `Parameter` для каждого входного параметра в `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-272">Likewise, the `UpdateParameters` collection contains a `Parameter` instance for each of the input parameters in `UpdateProduct`.</span></span>

<span data-ttu-id="2d0eb-273">В предыдущих руководствах, в которых было внесено изменение данных, мы удалим свойство `OldValuesParameterFormatString` ObjectDataSource на этом этапе, так как это свойство указывает, что метод BLL ожидает передачи старых (или исходных) значений, а также новых значений.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-273">For those previous tutorials that involved data modification, we'd remove the ObjectDataSource's `OldValuesParameterFormatString` property at this point, since this property indicates that the BLL method expects the old (or original) values to be passed in as well as the new values.</span></span> <span data-ttu-id="2d0eb-274">Кроме того, это значение свойства указывает имена входных параметров для исходных значений.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-274">Furthermore, this property value indicates the input parameter names for the original values.</span></span> <span data-ttu-id="2d0eb-275">Так как мы передаем исходные значения в BLL, *не удаляйте* это свойство.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-275">Since we are passing in the original values into the BLL, do *not* remove this property.</span></span>

> [!NOTE]
> <span data-ttu-id="2d0eb-276">Значение свойства `OldValuesParameterFormatString` должно сопоставляться с именами входных параметров в BLL, которые предполагают исходные значения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-276">The value of the `OldValuesParameterFormatString` property must map to the input parameter names in the BLL that expect the original values.</span></span> <span data-ttu-id="2d0eb-277">Так как мы назвали эти параметры `original_productName`, `original_supplierID`и т. д., можно оставить значение свойства `OldValuesParameterFormatString` как `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-277">Since we named these parameters `original_productName`, `original_supplierID`, and so on, you can leave the `OldValuesParameterFormatString` property value as `original_{0}`.</span></span> <span data-ttu-id="2d0eb-278">Однако если входные параметры методов BLL имеют такие имена, как `old_productName`, `old_supplierID`и т. д., необходимо обновить свойство `OldValuesParameterFormatString` для `old_{0}`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-278">If, however, the BLL methods' input parameters had names like `old_productName`, `old_supplierID`, and so on, you'd need to update the `OldValuesParameterFormatString` property to `old_{0}`.</span></span>

<span data-ttu-id="2d0eb-279">Для того чтобы ObjectDataSource правильно передавал исходные значения методам BLL, необходимо установить один последний параметр свойства.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-279">There's one final property setting that needs to be made in order for the ObjectDataSource to correctly pass the original values to the BLL methods.</span></span> <span data-ttu-id="2d0eb-280">У ObjectDataSource есть [свойство конфликтдетектион](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) , которое может быть присвоено [одному из двух значений](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span><span class="sxs-lookup"><span data-stu-id="2d0eb-280">The ObjectDataSource has a [ConflictDetection property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) that can be assigned to [one of two values](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span></span>

- <span data-ttu-id="2d0eb-281">`OverwriteChanges` — значение по умолчанию; не отправляет исходные значения в исходные входные параметры методов BLL</span><span class="sxs-lookup"><span data-stu-id="2d0eb-281">`OverwriteChanges` - the default value; does not send the original values to the BLL methods' original input parameters</span></span>
- <span data-ttu-id="2d0eb-282">`CompareAllValues` — отправляет исходные значения в методы BLL; Выберите этот параметр при использовании оптимистичного параллелизма</span><span class="sxs-lookup"><span data-stu-id="2d0eb-282">`CompareAllValues` - does send the original values to the BLL methods; choose this option when using optimistic concurrency</span></span>

<span data-ttu-id="2d0eb-283">Уделите время, чтобы задать для свойства `ConflictDetection` значение `CompareAllValues`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-283">Take a moment to set the `ConflictDetection` property to `CompareAllValues`.</span></span>

## <a name="configuring-the-gridviews-properties-and-fields"></a><span data-ttu-id="2d0eb-284">Настройка свойств и полей элемента управления GridView</span><span class="sxs-lookup"><span data-stu-id="2d0eb-284">Configuring the GridView's Properties and Fields</span></span>

<span data-ttu-id="2d0eb-285">Правильно настроив свойства ObjectDataSource, давайте вернем внимание к настройке GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-285">With the ObjectDataSource's properties properly configured, let's turn our attention to setting up the GridView.</span></span> <span data-ttu-id="2d0eb-286">Во-первых, так как мы хотим, чтобы GridView поддерживало редактирование и удаление, установите флажки Включить редактирование и включить удаление из интеллектуального тега GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-286">First, since we want the GridView to support editing and deleting, click the Enable Editing and Enable Deleting checkboxes from the GridView's smart tag.</span></span> <span data-ttu-id="2d0eb-287">В результате будет добавлена CommandField, для `ShowEditButton` и `ShowDeleteButton` заданы значения `true`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-287">This will add a CommandField whose `ShowEditButton` and `ShowDeleteButton` are both set to `true`.</span></span>

<span data-ttu-id="2d0eb-288">При привязке к `ProductsOptimisticConcurrencyDataSource` ObjectDataSource элемент GridView содержит поле для каждого поля данных продукта.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-288">When bound to the `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, the GridView contains a field for each of the product's data fields.</span></span> <span data-ttu-id="2d0eb-289">Хотя такой элемент управления GridView можно редактировать, взаимодействие с пользователем является любым, но приемлемым.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-289">While such a GridView can be edited, the user experience is anything but acceptable.</span></span> <span data-ttu-id="2d0eb-290">`CategoryID` и `SupplierID` BoundFields будут отображаться как текстовые поля, что позволит пользователю ввести соответствующую категорию и поставщика в качестве ИДЕНТИФИКАЦИОНных номеров.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-290">The `CategoryID` and `SupplierID` BoundFields will render as TextBoxes, requiring the user to enter the appropriate category and supplier as ID numbers.</span></span> <span data-ttu-id="2d0eb-291">Для числовых полей и элементов управления проверки не будет выполнено форматирование, чтобы гарантировать, что название продукта было предоставлено, а цена за единицу, количество единиц на складе, количество единиц по заказу и значение уровня переупорядочения являются правильными числовыми значениями и больше или равны. равным нулю.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-291">There will be no formatting for the numeric fields and no validation controls to ensure that the product's name has been supplied and that the unit price, units in stock, units on order, and reorder level values are both proper numeric values and are greater than or equal to zero.</span></span>

<span data-ttu-id="2d0eb-292">Как мы обсуждали при *добавлении элементов управления проверки в интерфейсы правки и вставки* и настройке учебников по *интерфейсу изменения данных* , Пользовательский интерфейс можно настроить, заменив BoundFields на полей TemplateField.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-292">As we discussed in the *Adding Validation Controls to the Editing and Inserting Interfaces* and *Customizing the Data Modification Interface* tutorials, the user interface can be customized by replacing the BoundFields with TemplateFields.</span></span> <span data-ttu-id="2d0eb-293">Я изменил этот элемент GridView и его интерфейс редактирования следующими способами:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-293">I've modified this GridView and its editing interface in the following ways:</span></span>

- <span data-ttu-id="2d0eb-294">Удалены `ProductID`, `SupplierName`и `CategoryName` BoundFields</span><span class="sxs-lookup"><span data-stu-id="2d0eb-294">Removed the `ProductID`, `SupplierName`, and `CategoryName` BoundFields</span></span>
- <span data-ttu-id="2d0eb-295">Преобразование `ProductName` BoundField в TemplateField и Добавление элемента управления Рекуиредфиелдвалидатион.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-295">Converted the `ProductName` BoundField to a TemplateField and added a RequiredFieldValidation control.</span></span>
- <span data-ttu-id="2d0eb-296">Преобразовал `CategoryID` и `SupplierID` BoundFields в полей TemplateField и настроил интерфейс редактирования на использование элементов управления DropDownList, а не текстовых полей.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-296">Converted the `CategoryID` and `SupplierID` BoundFields to TemplateFields, and adjusted the editing interface to use DropDownLists rather than TextBoxes.</span></span> <span data-ttu-id="2d0eb-297">В этих полей TemplateField "`ItemTemplates`отображаются поля данных `CategoryName` и `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-297">In these TemplateFields' `ItemTemplates`, the `CategoryName` and `SupplierName` data fields are displayed.</span></span>
- <span data-ttu-id="2d0eb-298">Преобразованы `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`и `ReorderLevel` BoundFields в полей TemplateField и добавлены элементы управления CompareValidator.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-298">Converted the `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, and `ReorderLevel` BoundFields to TemplateFields and added CompareValidator controls.</span></span>

<span data-ttu-id="2d0eb-299">Так как мы уже рассматривали, как выполнять эти задачи в предыдущих руководствах, я просто перечислю итоговый декларативный синтаксис и оставлю реализацию в качестве практического занятия.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-299">Since we've already examined how to accomplish these tasks in previous tutorials, I'll just list the final declarative syntax here and leave the implementation as practice.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample9.aspx)]

<span data-ttu-id="2d0eb-300">Мы очень близки к полному рабочему примеру.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-300">We're very close to having a fully-working example.</span></span> <span data-ttu-id="2d0eb-301">Однако существует несколько тонкостей, которые будут вынимать проблемы и привести к проблемам с нами.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-301">However, there are a few subtleties that will creep up and cause us problems.</span></span> <span data-ttu-id="2d0eb-302">Кроме того, нам по-прежнему нужен интерфейс, который предупреждает пользователя при возникновении одновременного нарушения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-302">Additionally, we still need some interface that alerts the user when a concurrency violation has occurred.</span></span>

> [!NOTE]
> <span data-ttu-id="2d0eb-303">Чтобы веб-элемент управления данными правильно передал исходные значения элементу ObjectDataSource (который затем передается BLL), крайне важно, чтобы свойство `EnableViewState` GridView было установлено в `true` (значение по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-303">In order for a data Web control to correctly pass the original values to the ObjectDataSource (which are then passed to the BLL), it's vital that the GridView's `EnableViewState` property is set to `true` (the default).</span></span> <span data-ttu-id="2d0eb-304">При отключении состояния представления исходные значения теряются при обратной передаче.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-304">If you disable view state, the original values are lost on postback.</span></span>

## <a name="passing-the-correct-original-values-to-the-objectdatasource"></a><span data-ttu-id="2d0eb-305">Передача правильных исходных значений в ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="2d0eb-305">Passing the Correct Original Values to the ObjectDataSource</span></span>

<span data-ttu-id="2d0eb-306">Существует несколько проблем, связанных с тем, как был настроен элемент управления GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-306">There are a couple of problems with the way the GridView has been configured.</span></span> <span data-ttu-id="2d0eb-307">Если свойство `ConflictDetection` ObjectDataSource имеет значение `CompareAllValues` (как и в нашей ситуации), то, когда методы `Update()` или `Delete()` ObjectDataSource вызываются элементом GridView (или DetailsView или FormView), ObjectDataSource пытается скопировать исходные значения GridView в соответствующие `Parameter` экземпляры.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-307">If the ObjectDataSource's `ConflictDetection` property is set to `CompareAllValues` (as is ours), when the ObjectDataSource's `Update()` or `Delete()` methods are invoked by the GridView (or DetailsView or FormView), the ObjectDataSource attempts to copy the GridView's original values into its appropriate `Parameter` instances.</span></span> <span data-ttu-id="2d0eb-308">Графическое представление этого процесса приведено на рис. 2.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-308">Refer back to Figure 2 for a graphical representation of this process.</span></span>

<span data-ttu-id="2d0eb-309">В частности, исходным значениям GridView присваиваются значения в операторах двухсторонней привязки данных каждый раз, когда данные привязаны к GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-309">Specifically, the GridView's original values are assigned the values in the two-way databinding statements each time the data is bound to the GridView.</span></span> <span data-ttu-id="2d0eb-310">Поэтому важно, чтобы все необходимые исходные значения были захвачены с помощью двухсторонней привязки данных и были предоставлены в преобразуемом формате.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-310">Therefore, it's essential that the required original values all are captured via two-way databinding and that they are provided in a convertible format.</span></span>

<span data-ttu-id="2d0eb-311">Чтобы узнать, почему это важно, уделите время посещения страницы в браузере.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-311">To see why this is important, take a moment to visit our page in a browser.</span></span> <span data-ttu-id="2d0eb-312">Как и ожидалось, GridView перечисляет каждый продукт с помощью кнопки Изменить и удалить в крайнем левом столбце.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-312">As expected, the GridView lists each product with an Edit and Delete button in the leftmost column.</span></span>

<span data-ttu-id="2d0eb-313">[![продукты перечислены в элементе управления GridView](implementing-optimistic-concurrency-cs/_static/image39.png)](implementing-optimistic-concurrency-cs/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-313">[![The Products are Listed in a GridView](implementing-optimistic-concurrency-cs/_static/image39.png)](implementing-optimistic-concurrency-cs/_static/image38.png)</span></span>

<span data-ttu-id="2d0eb-314">**Рис. 14**. продукты перечислены в элементе управления GridView ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-314">**Figure 14**: The Products are Listed in a GridView ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image40.png))</span></span>

<span data-ttu-id="2d0eb-315">Если нажать кнопку Удалить для любого продукта, выдается `FormatException`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-315">If you click the Delete button for any product, a `FormatException` is thrown.</span></span>

<span data-ttu-id="2d0eb-316">[![попытке удалить все результаты продукта в FormatException](implementing-optimistic-concurrency-cs/_static/image42.png)](implementing-optimistic-concurrency-cs/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-316">[![Attempting to Delete Any Product Results in a FormatException](implementing-optimistic-concurrency-cs/_static/image42.png)](implementing-optimistic-concurrency-cs/_static/image41.png)</span></span>

<span data-ttu-id="2d0eb-317">**Рис. 15**. попытка удалить все результаты продукта в `FormatException` ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-317">**Figure 15**: Attempting to Delete Any Product Results in a `FormatException` ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image43.png))</span></span>

<span data-ttu-id="2d0eb-318">`FormatException` возникает, когда ObjectDataSource пытается прочитать исходное значение `UnitPrice`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-318">The `FormatException` is raised when the ObjectDataSource attempts to read in the original `UnitPrice` value.</span></span> <span data-ttu-id="2d0eb-319">Поскольку `ItemTemplate` имеет `UnitPrice` в формате денежной единицы (`<%# Bind("UnitPrice", "{0:C}") %>`), она включает символ валюты, например $19,95.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-319">Since the `ItemTemplate` has the `UnitPrice` formatted as a currency (`<%# Bind("UnitPrice", "{0:C}") %>`), it includes a currency symbol, like $19.95.</span></span> <span data-ttu-id="2d0eb-320">`FormatException` возникает, когда ObjectDataSource пытается преобразовать эту строку в `decimal`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-320">The `FormatException` occurs as the ObjectDataSource attempts to convert this string into a `decimal`.</span></span> <span data-ttu-id="2d0eb-321">Чтобы обойти эту проблему, у нас есть ряд возможностей:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-321">To circumvent this problem, we have a number of options:</span></span>

- <span data-ttu-id="2d0eb-322">Удалите форматирование валюты из `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-322">Remove the currency formatting from the `ItemTemplate`.</span></span> <span data-ttu-id="2d0eb-323">То есть вместо использования `<%# Bind("UnitPrice", "{0:C}") %>`просто используйте `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-323">That is, instead of using `<%# Bind("UnitPrice", "{0:C}") %>`, simply use `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="2d0eb-324">Недостаток этого заключается в том, что цена больше не форматируется.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-324">The downside of this is that the price is no longer formatted.</span></span>
- <span data-ttu-id="2d0eb-325">Отображение `UnitPrice` в формате валюты в `ItemTemplate`, но для этого используется ключевое слово `Eval`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-325">Display the `UnitPrice` formatted as a currency in the `ItemTemplate`, but use the `Eval` keyword to accomplish this.</span></span> <span data-ttu-id="2d0eb-326">Помните, что `Eval` выполняет однонаправленную привязку данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-326">Recall that `Eval` performs one-way databinding.</span></span> <span data-ttu-id="2d0eb-327">Нам по-прежнему нужно предоставить `UnitPrice` значение для исходных значений, поэтому нам по-прежнему потребуется инструкция двухсторонней привязки данных в `ItemTemplate`, но ее можно поместить в элемент управления Label, свойство `Visible` которого имеет значение `false`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-327">We still need to provide the `UnitPrice` value for the original values, so we'll still need a two-way databinding statement in the `ItemTemplate`, but this can be placed in a Label Web control whose `Visible` property is set to `false`.</span></span> <span data-ttu-id="2d0eb-328">В ItemTemplate можно использовать следующую разметку:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-328">We could use the following markup in the ItemTemplate:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample10.aspx)]

- <span data-ttu-id="2d0eb-329">Удалите форматирование валюты из `ItemTemplate`с помощью `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-329">Remove the currency formatting from the `ItemTemplate`, using `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="2d0eb-330">В обработчике событий `RowDataBound` GridView программный доступ к веб-элементу управления Label, в котором отображается значение `UnitPrice`, и присвойте его свойству `Text` форматированную версию.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-330">In the GridView's `RowDataBound` event handler, programmatically access the Label Web control within which the `UnitPrice` value is displayed and set its `Text` property to the formatted version.</span></span>
- <span data-ttu-id="2d0eb-331">Оставьте `UnitPrice` в формате денежной единицы.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-331">Leave the `UnitPrice` formatted as a currency.</span></span> <span data-ttu-id="2d0eb-332">В обработчике событий `RowDeleting` GridView замените существующее исходное значение `UnitPrice` ($19,95) фактическим десятичным значением с помощью `Decimal.Parse`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-332">In the GridView's `RowDeleting` event handler, replace the existing original `UnitPrice` value ($19.95) with an actual decimal value using `Decimal.Parse`.</span></span> <span data-ttu-id="2d0eb-333">Мы увидели, как выполнить что-то подобное в обработчике событий `RowUpdating` в учебнике [*обработка исключений BLL и DAL на странице ASP.NET*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="2d0eb-333">We saw how to accomplish something similar in the `RowUpdating` event handler in the [*Handling BLL- and DAL-Level Exceptions in an ASP.NET Page*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial.</span></span>

<span data-ttu-id="2d0eb-334">В нашем примере я решил второй подход, добавив скрытый веб-элемент управления Label, свойство `Text` которого является двусторонними данными, привязанными к неформатированному `UnitPrice`ому значению.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-334">For my example I chose to go with the second approach, adding a hidden Label Web control whose `Text` property is two-way data bound to the unformatted `UnitPrice` value.</span></span>

<span data-ttu-id="2d0eb-335">После решения этой проблемы попробуйте снова нажать кнопку Удалить для любого продукта.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-335">After solving this problem, try clicking the Delete button for any product again.</span></span> <span data-ttu-id="2d0eb-336">На этот раз вы получите `InvalidOperationException`, когда ObjectDataSource попытается вызвать метод `UpdateProduct` BLL.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-336">This time you'll get an `InvalidOperationException` when the ObjectDataSource attempts to invoke the BLL's `UpdateProduct` method.</span></span>

<span data-ttu-id="2d0eb-337">[![ObjectDataSource не удается найти метод с входными параметрами, которые требуется отправить](implementing-optimistic-concurrency-cs/_static/image45.png)](implementing-optimistic-concurrency-cs/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-337">[![The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send](implementing-optimistic-concurrency-cs/_static/image45.png)](implementing-optimistic-concurrency-cs/_static/image44.png)</span></span>

<span data-ttu-id="2d0eb-338">**Рис. 16**. ObjectDataSource не может найти метод с входными параметрами, которые требуется отправить ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-338">**Figure 16**: The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image46.png))</span></span>

<span data-ttu-id="2d0eb-339">Глядя на сообщение об исключении, ясно, что ObjectDataSource хочет вызвать метод BLL `DeleteProduct`, включающий `original_CategoryName` и `original_SupplierName` входные параметры.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-339">Looking at the exception's message, it's clear that the ObjectDataSource wants to invoke a BLL `DeleteProduct` method that includes `original_CategoryName` and `original_SupplierName` input parameters.</span></span> <span data-ttu-id="2d0eb-340">Это происходит потому, что `ItemTemplate` s для `CategoryID` и `SupplierID` полей TemplateField в настоящее время содержат двусторонние инструкции BIND с полями данных `CategoryName` и `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-340">This is because the `ItemTemplate` s for the `CategoryID` and `SupplierID` TemplateFields currently contain two-way Bind statements with the `CategoryName` and `SupplierName` data fields.</span></span> <span data-ttu-id="2d0eb-341">Вместо этого необходимо включить `Bind`ные инструкции с полями данных `CategoryID` и `SupplierID`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-341">Instead, we need to include `Bind` statements with the `CategoryID` and `SupplierID` data fields.</span></span> <span data-ttu-id="2d0eb-342">Для этого замените существующие инструкции BIND инструкциями `Eval`, а затем добавьте скрытые элементы управления Label, свойства `Text` которых привязаны к полям данных `CategoryID` и `SupplierID`, используя двустороннюю привязку данных, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-342">To accomplish this, replace the existing Bind statements with `Eval` statements, and then add hidden Label controls whose `Text` properties are bound to the `CategoryID` and `SupplierID` data fields using two-way databinding, as shown below:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample11.aspx)]

<span data-ttu-id="2d0eb-343">После внесения этих изменений теперь можно успешно удалить и изменить сведения о продукте!</span><span class="sxs-lookup"><span data-stu-id="2d0eb-343">With these changes, we are now able to successfully delete and edit product information!</span></span> <span data-ttu-id="2d0eb-344">На этапе 5 мы рассмотрим, как убедиться в том, что обнаруживаются одновременные нарушения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-344">In Step 5 we'll look at how to verify that concurrency violations are being detected.</span></span> <span data-ttu-id="2d0eb-345">Но в настоящее время уделите несколько минут попытаться обновить и удалить несколько записей, чтобы гарантировать, что обновление и удаление одного пользователя работают должным образом.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-345">But for now, take a few minutes to try updating and deleting a few records to ensure that updating and deleting for a single user works as expected.</span></span>

## <a name="step-5-testing-the-optimistic-concurrency-support"></a><span data-ttu-id="2d0eb-346">Шаг 5. Тестирование поддержки оптимистичного параллелизма</span><span class="sxs-lookup"><span data-stu-id="2d0eb-346">Step 5: Testing the Optimistic Concurrency Support</span></span>

<span data-ttu-id="2d0eb-347">Чтобы убедиться в том, что обнаруживаются нарушения параллелизма (вместо того, чтобы данные были скрыты с потерей данных), необходимо открыть на этой странице два окна браузера.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-347">In order to verify that concurrency violations are being detected (rather than resulting in data being blindly overwritten), we need to open two browser windows to this page.</span></span> <span data-ttu-id="2d0eb-348">В обоих экземплярах браузера нажмите кнопку изменить для Chai.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-348">In both browser instances, click on the Edit button for Chai.</span></span> <span data-ttu-id="2d0eb-349">Затем в одном из браузеров измените имя на «чай Chai» и нажмите кнопку Обновить.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-349">Then, in just one of the browsers, change the name to "Chai Tea" and click Update.</span></span> <span data-ttu-id="2d0eb-350">Обновление должно выполняться, и возврат GridView к состоянию предварительного редактирования с именем "Чай Chai" в качестве нового названия продукта.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-350">The update should succeed and return the GridView to its pre-editing state, with "Chai Tea" as the new product name.</span></span>

<span data-ttu-id="2d0eb-351">Однако в другом экземпляре окна браузера в текстовом поле Product Name по-прежнему отображается «Chai».</span><span class="sxs-lookup"><span data-stu-id="2d0eb-351">In the other browser window instance, however, the product name TextBox still shows "Chai".</span></span> <span data-ttu-id="2d0eb-352">В этом втором окне браузера обновите `UnitPrice` для `25.00`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-352">In this second browser window, update the `UnitPrice` to `25.00`.</span></span> <span data-ttu-id="2d0eb-353">Без поддержки оптимистичного параллелизма при нажатии кнопки Обновить во втором экземпляре браузера будет изменено имя продукта на «Chai», что приведет к перезаписи изменений, внесенных первым экземпляром браузера.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-353">Without optimistic concurrency support, clicking update in the second browser instance would change the product name back to "Chai", thereby overwriting the changes made by the first browser instance.</span></span> <span data-ttu-id="2d0eb-354">Однако при использовании оптимистичного параллелизма нажатие кнопки Обновить во втором экземпляре браузера приводит к [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-354">With optimistic concurrency employed, however, clicking the Update button in the second browser instance results in a [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span></span>

<span data-ttu-id="2d0eb-355">[![при обнаружении одновременных нарушений возникает исключение DBConcurrencyException](implementing-optimistic-concurrency-cs/_static/image48.png)](implementing-optimistic-concurrency-cs/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-355">[![When a Concurrency Violation is Detected, a DBConcurrencyException is Thrown](implementing-optimistic-concurrency-cs/_static/image48.png)](implementing-optimistic-concurrency-cs/_static/image47.png)</span></span>

<span data-ttu-id="2d0eb-356">**Рис. 17**. при обнаружении одновременного нарушения возникает исключение `DBConcurrencyException` ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-356">**Figure 17**: When a Concurrency Violation is Detected, a `DBConcurrencyException` is Thrown ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image49.png))</span></span>

<span data-ttu-id="2d0eb-357">`DBConcurrencyException` возникает только при использовании шаблона пакетного обновления DAL.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-357">The `DBConcurrencyException` is only thrown when the DAL's batch update pattern is utilized.</span></span> <span data-ttu-id="2d0eb-358">Непосредственный шаблон базы данных не создает исключение, а просто указывает, что ни одна строка не затронула.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-358">The DB direct pattern does not raise an exception, it merely indicates that no rows were affected.</span></span> <span data-ttu-id="2d0eb-359">Чтобы проиллюстрировать это, возвратите в состояние предварительного редактирования элемент управления GridView для экземпляров браузера.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-359">To illustrate this, return both browser instances' GridView to their pre-editing state.</span></span> <span data-ttu-id="2d0eb-360">Затем в первом экземпляре браузера нажмите кнопку "Изменить" и измените название продукта с "Чай Chai" на "Chai" и нажмите кнопку "Обновить".</span><span class="sxs-lookup"><span data-stu-id="2d0eb-360">Next, in the first browser instance, click the Edit button and change the product name from "Chai Tea" back to "Chai" and click Update.</span></span> <span data-ttu-id="2d0eb-361">Во втором окне браузера нажмите кнопку Удалить для Chai.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-361">In the second browser window, click the Delete button for Chai.</span></span>

<span data-ttu-id="2d0eb-362">После нажатия кнопки удалить страница выполняет обратную передачу, GridView вызывает метод `Delete()` ObjectDataSource, а ObjectDataSource вызывает метод `DeleteProduct` класса `ProductsOptimisticConcurrencyBLL`, передавая исходные значения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-362">Upon clicking Delete, the page posts back, the GridView invokes the ObjectDataSource's `Delete()` method, and the ObjectDataSource calls down into the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method, passing along the original values.</span></span> <span data-ttu-id="2d0eb-363">Исходное значение `ProductName` для второго экземпляра браузера — «Чай Chai», не совпадающее с текущим значением `ProductName` в базе данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-363">The original `ProductName` value for the second browser instance is "Chai Tea", which doesn't match up with the current `ProductName` value in the database.</span></span> <span data-ttu-id="2d0eb-364">Поэтому инструкция `DELETE`, выданная базе данных, влияет на нулевые строки, так как в базе данных нет записей, удовлетворяющих предложению `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-364">Therefore the `DELETE` statement issued to the database affects zero rows since there's no record in the database that the `WHERE` clause satisfies.</span></span> <span data-ttu-id="2d0eb-365">Метод `DeleteProduct` возвращает `false` и данные ObjectDataSource повторно привязаны к GridView.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-365">The `DeleteProduct` method returns `false` and the ObjectDataSource's data is rebound to the GridView.</span></span>

<span data-ttu-id="2d0eb-366">С точки зрения конечного пользователя, нажатие кнопки Удалить для Чай Chai во втором окне браузера привело к мгновенному переходу экрана, и, при появлении обратно, продукт останется там, хотя теперь он указан как "Chai" (изменение названия продукта, внесенное первым браузером). экземпляр).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-366">From the end user's perspective, clicking on the Delete button for Chai Tea in the second browser window caused the screen to flash and, upon coming back, the product is still there, although now it's listed as "Chai" (the product name change made by the first browser instance).</span></span> <span data-ttu-id="2d0eb-367">Если пользователь снова нажмет кнопку "Удалить", удаление будет завершено, так как исходное значение `ProductName` GridView ("Chai") теперь совпадает со значением в базе данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-367">If the user clicks the Delete button again, the Delete will succeed, as the GridView's original `ProductName` value ("Chai") now matches up with the value in the database.</span></span>

<span data-ttu-id="2d0eb-368">В обоих случаях взаимодействие с пользователем далеко от идеала.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-368">In both of these cases, the user experience is far from ideal.</span></span> <span data-ttu-id="2d0eb-369">Мы явно не хотим показывать пользователю сведения о деталях-переменчивый исключения `DBConcurrencyException` при использовании шаблона пакетного обновления.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-369">We clearly don't want to show the user the nitty-gritty details of the `DBConcurrencyException` exception when using the batch update pattern.</span></span> <span data-ttu-id="2d0eb-370">И поведение при использовании прямого шаблона базы данных несколько запутанно, так как команда Users завершилась ошибкой, но точное указание причины не было.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-370">And the behavior when using the DB direct pattern is somewhat confusing as the users command failed, but there was no precise indication of why.</span></span>

<span data-ttu-id="2d0eb-371">Чтобы устранить эти две проблемы, можно создать веб-элементы управления Label на странице, которые содержат пояснения к неудачному завершению обновления или удаления.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-371">To remedy these two issues, we can create Label Web controls on the page that provide an explanation to why an update or delete failed.</span></span> <span data-ttu-id="2d0eb-372">Для шаблона пакетного обновления можно определить, возникло ли исключение `DBConcurrencyException` в обработчике события последующей операции GridView, отображая метку предупреждения по мере необходимости.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-372">For the batch update pattern, we can determine whether or not a `DBConcurrencyException` exception occurred in the GridView's post-level event handler, displaying the warning label as needed.</span></span> <span data-ttu-id="2d0eb-373">Для прямого метода базы данных можно проверить возвращаемое значение метода BLL (`true`, если затронула одна строка, `false` в противном случае) и при необходимости отобразить информационное сообщение.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-373">For the DB direct method, we can examine the return value of the BLL method (which is `true` if one row was affected, `false` otherwise) and display an informational message as needed.</span></span>

## <a name="step-6-adding-informational-messages-and-displaying-them-in-the-face-of-a-concurrency-violation"></a><span data-ttu-id="2d0eb-374">Шаг 6. добавление информационных сообщений и их отображение на стороне нарушения параллелизма</span><span class="sxs-lookup"><span data-stu-id="2d0eb-374">Step 6: Adding Informational Messages and Displaying Them in the Face of a Concurrency Violation</span></span>

<span data-ttu-id="2d0eb-375">При возникновении одновременного нарушения поведение зависит от того, использовалось ли пакетное обновление DAL или непосредственный шаблон базы данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-375">When a concurrency violation occurs, the behavior exhibited depends on whether the DAL's batch update or DB direct pattern was used.</span></span> <span data-ttu-id="2d0eb-376">В этом учебнике используются оба шаблона с шаблоном пакетного обновления, который используется для обновления, и непосредственный шаблон базы данных, используемый для удаления.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-376">Our tutorial uses both patterns, with the batch update pattern being used for updating and the DB direct pattern used for deleting.</span></span> <span data-ttu-id="2d0eb-377">Чтобы приступить к работе, давайте добавим на нашу страницу две веб-элемента управления Label, объясняющие, что произошло нарушение параллелизма при попытке удаления или обновления данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-377">To get started, let's add two Label Web controls to our page that explain that a concurrency violation occurred when attempting to delete or update data.</span></span> <span data-ttu-id="2d0eb-378">Задайте для свойств `Visible` и `EnableViewState` элемента управления Label значение `false`; Это приведет к тому, что они будут скрыты на каждом посещении страницы, за исключением конкретных посещений страниц, в которых для свойства `Visible` программно задано значение `true`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-378">Set the Label control's `Visible` and `EnableViewState` properties to `false`; this will cause them to be hidden on each page visit except for those particular page visits where their `Visible` property is programmatically set to `true`.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-cs/samples/sample12.aspx)]

<span data-ttu-id="2d0eb-379">Помимо установки свойств `Visible`, `EnabledViewState`и `Text`, я также установил для свойства `CssClass` значение `Warning`, в результате чего метка будет отображаться в большом, красном, курсивном полужирном шрифте.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-379">In addition to setting their `Visible`, `EnabledViewState`, and `Text` properties, I've also set the `CssClass` property to `Warning`, which causes the Label's to be displayed in a large, red, italic, bold font.</span></span> <span data-ttu-id="2d0eb-380">Этот класс CSS `Warning` был определен и добавлен в Styles. CSS обратно в ходе *изучения событий, связанных с учебником по вставке, обновлению и удалению* .</span><span class="sxs-lookup"><span data-stu-id="2d0eb-380">This CSS `Warning` class was defined and added to Styles.css back in the *Examining the Events Associated with Inserting, Updating, and Deleting* tutorial.</span></span>

<span data-ttu-id="2d0eb-381">После добавления этих меток конструктор в Visual Studio должен выглядеть примерно так, как показано на рис. 18.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-381">After adding these Labels, the Designer in Visual Studio should look similar to Figure 18.</span></span>

<span data-ttu-id="2d0eb-382">[![на страницу были добавлены два элемента управления Label](implementing-optimistic-concurrency-cs/_static/image51.png)](implementing-optimistic-concurrency-cs/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-382">[![Two Label Controls Have Been Added to the Page](implementing-optimistic-concurrency-cs/_static/image51.png)](implementing-optimistic-concurrency-cs/_static/image50.png)</span></span>

<span data-ttu-id="2d0eb-383">**Рис. 18**. Добавление на страницу двух элементов управления Label ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-383">**Figure 18**: Two Label Controls Have Been Added to the Page ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image52.png))</span></span>

<span data-ttu-id="2d0eb-384">С помощью этих веб-элементов управления Label мы готовы исследовать, как определить, когда произошло нарушение параллелизма, после чего можно задать для соответствующей свойства метки `Visible` значение `true`, отображая информационное сообщение.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-384">With these Label Web controls in place, we're ready to examine how to determine when a concurrency violation has occurred, at which point the appropriate Label's `Visible` property can be set to `true`, displaying the informational message.</span></span>

## <a name="handling-concurrency-violations-when-updating"></a><span data-ttu-id="2d0eb-385">Обработка нарушений параллелизма при обновлении</span><span class="sxs-lookup"><span data-stu-id="2d0eb-385">Handling Concurrency Violations When Updating</span></span>

<span data-ttu-id="2d0eb-386">Давайте сначала посмотрим, как обрабатывались нарушения параллелизма при использовании шаблона пакетного обновления.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-386">Let's first look at how to handle concurrency violations when using the batch update pattern.</span></span> <span data-ttu-id="2d0eb-387">Так как такие нарушения в шаблоне пакетного обновления вызывают исключение `DBConcurrencyException`, нам нужно добавить код на страницу ASP.NET, чтобы определить, возникло ли во время процесса обновления исключение `DBConcurrencyException`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-387">Since such violations with the batch update pattern cause a `DBConcurrencyException` exception to be thrown, we need to add code to our ASP.NET page to determine whether a `DBConcurrencyException` exception occurred during the update process.</span></span> <span data-ttu-id="2d0eb-388">Если да, то следует отобразить пользователю сообщение, объясняющее, что изменения не были сохранены, так как другой пользователь изменил те же данные между моментом, когда они начали изменять запись, и при нажатии кнопки Обновить.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-388">If so, we should display a message to the user explaining that their changes were not saved because another user had modified the same data between when they started editing the record and when they clicked the Update button.</span></span>

<span data-ttu-id="2d0eb-389">Как мы видели при *обработке исключений уровня BLL и DAL в учебнике по страницам ASP.NET* , такие исключения могут быть обнаружены и подавлены в обработчиках событий постороннего уровня веб-элемента управления данными.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-389">As we saw in the *Handling BLL- and DAL-Level Exceptions in an ASP.NET Page* tutorial, such exceptions can be detected and suppressed in the data Web control's post-level event handlers.</span></span> <span data-ttu-id="2d0eb-390">Поэтому необходимо создать обработчик событий для события `RowUpdated` GridView, которое проверяет, вызвано ли исключение `DBConcurrencyException`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-390">Therefore, we need to create an event handler for the GridView's `RowUpdated` event that checks if a `DBConcurrencyException` exception has been thrown.</span></span> <span data-ttu-id="2d0eb-391">Этот обработчик событий передает ссылку на любое исключение, которое было вызвано в процессе обновления, как показано в приведенном ниже коде обработчика событий:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-391">This event handler is passed a reference to any exception that was raised during the updating process, as shown in the event handler code below:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample13.cs)]

<span data-ttu-id="2d0eb-392">В случае исключения `DBConcurrencyException` этот обработчик событий отображает элемент управления Label `UpdateConflictMessage` и указывает, что исключение было обработано.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-392">In the face of a `DBConcurrencyException` exception, this event handler displays the `UpdateConflictMessage` Label control and indicates that the exception has been handled.</span></span> <span data-ttu-id="2d0eb-393">При использовании этого кода при возникновении одновременного нарушения при обновлении записи изменения пользователя теряются, так как они будут перезаписаны изменения другого пользователя одновременно.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-393">With this code in place, when a concurrency violation occurs when updating a record, the user's changes are lost, since they would have overwritten another user's modifications at the same time.</span></span> <span data-ttu-id="2d0eb-394">В частности, GridView возвращается в состояние предварительного редактирования и привязывается к текущим данным базы данных.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-394">In particular, the GridView is returned to its pre-editing state and bound to the current database data.</span></span> <span data-ttu-id="2d0eb-395">Это приведет к обновлению строки GridView другими изменениями другого пользователя, которые ранее не были видны.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-395">This will update the GridView row with the other user's changes, which were previously not visible.</span></span> <span data-ttu-id="2d0eb-396">Кроме того, элемент управления "метка" `UpdateConflictMessage` поясняет, что именно произошло.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-396">Additionally, the `UpdateConflictMessage` Label control will explain to the user what just happened.</span></span> <span data-ttu-id="2d0eb-397">Эта последовательность событий подробно описана на рис. 19.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-397">This sequence of events is detailed in Figure 19.</span></span>

<span data-ttu-id="2d0eb-398">[![, что обновления пользователей теряются в случае одновременного нарушения](implementing-optimistic-concurrency-cs/_static/image54.png)](implementing-optimistic-concurrency-cs/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-398">[![A User s Updates are Lost in the Face of a Concurrency Violation](implementing-optimistic-concurrency-cs/_static/image54.png)](implementing-optimistic-concurrency-cs/_static/image53.png)</span></span>

<span data-ttu-id="2d0eb-399">**Рис. 19**. обновления пользователей теряются в случае одновременного нарушения ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-399">**Figure 19**: A User s Updates are Lost in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image55.png))</span></span>

> [!NOTE]
> <span data-ttu-id="2d0eb-400">Кроме того, вместо возврата GridView к состоянию перед редактированием можно оставить GridView в своем состоянии редактирования, установив для свойства `KeepInEditMode` переданного объекта `GridViewUpdatedEventArgs` значение true.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-400">Alternatively, rather than returning the GridView to the pre-editing state, we could leave the GridView in its editing state by setting the `KeepInEditMode` property of the passed-in `GridViewUpdatedEventArgs` object to true.</span></span> <span data-ttu-id="2d0eb-401">Тем не менее, если принять такой подход, то необходимо будет повторно привязать данные к GridView (путем вызова метода `DataBind()`), чтобы значения другого пользователя загружались в интерфейс редактирования.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-401">If you take this approach, however, be certain to rebind the data to the GridView (by invoking its `DataBind()` method) so that the other user's values are loaded into the editing interface.</span></span> <span data-ttu-id="2d0eb-402">Код, доступный для загрузки в этом учебнике, содержит две строки кода в обработчике событий `RowUpdated` с комментариями. Просто раскомментируйте эти строки кода, чтобы элемент управления GridView оставался в режиме редактирования после одновременного нарушения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-402">The code available for download with this tutorial has these two lines of code in the `RowUpdated` event handler commented out; simply uncomment these lines of code to have the GridView remain in edit mode after a concurrency violation.</span></span>

## <a name="responding-to-concurrency-violations-when-deleting"></a><span data-ttu-id="2d0eb-403">Реагирование на нарушения параллелизма при удалении</span><span class="sxs-lookup"><span data-stu-id="2d0eb-403">Responding to Concurrency Violations When Deleting</span></span>

<span data-ttu-id="2d0eb-404">В случае с прямым шаблоном базы данных исключение не возникает при одновременном нарушении параллелизма.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-404">With the DB direct pattern, there is no exception raised in the face of a concurrency violation.</span></span> <span data-ttu-id="2d0eb-405">Вместо этого инструкция базы данных просто не влияет на записи, так как предложение WHERE не соответствует ни одной записи.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-405">Instead, the database statement simply affects no records, as the WHERE clause does not match with any record.</span></span> <span data-ttu-id="2d0eb-406">Все методы изменения данных, созданные в BLL, были спроектированы таким образом, что они возвращают логическое значение, указывающее, затронули ли они ровно одну запись.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-406">All of the data modification methods created in the BLL have been designed such that they return a Boolean value indicating whether or not they affected precisely one record.</span></span> <span data-ttu-id="2d0eb-407">Таким образом, чтобы определить, произошло ли нарушение параллелизма при удалении записи, можно проверить возвращаемое значение метода `DeleteProduct` BLL.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-407">Therefore, to determine if a concurrency violation occurred when deleting a record, we can examine the return value of the BLL's `DeleteProduct` method.</span></span>

<span data-ttu-id="2d0eb-408">Возвращаемое значение для метода BLL можно проверить в обработчиках событий последующей операции на уровне ObjectDataSource с помощью свойства `ReturnValue` объекта `ObjectDataSourceStatusEventArgs`, переданного в обработчик событий.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-408">The return value for a BLL method can be examined in the ObjectDataSource's post-level event handlers through the `ReturnValue` property of the `ObjectDataSourceStatusEventArgs` object passed into the event handler.</span></span> <span data-ttu-id="2d0eb-409">Поскольку мы заинтересованы в определении возвращаемого значения метода `DeleteProduct`, необходимо создать обработчик событий для события `Deleted` ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-409">Since we are interested in determining the return value from the `DeleteProduct` method, we need to create an event handler for the ObjectDataSource's `Deleted` event.</span></span> <span data-ttu-id="2d0eb-410">Свойство `ReturnValue` имеет тип `object` и может быть `null`, если было вызвано исключение и метод был прерван до того, как он мог вернуть значение.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-410">The `ReturnValue` property is of type `object` and can be `null` if an exception was raised and the method was interrupted before it could return a value.</span></span> <span data-ttu-id="2d0eb-411">Поэтому сначала следует убедиться, что свойство `ReturnValue` не `null` и является логическим значением.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-411">Therefore, we should first ensure that the `ReturnValue` property is not `null` and is a Boolean value.</span></span> <span data-ttu-id="2d0eb-412">Предполагая, что эта проверка пройдена, элемент управления `DeleteConflictMessage` меток отображается, если `ReturnValue` `false`.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-412">Assuming this check passes, we show the `DeleteConflictMessage` Label control if the `ReturnValue` is `false`.</span></span> <span data-ttu-id="2d0eb-413">Это можно сделать с помощью следующего кода:</span><span class="sxs-lookup"><span data-stu-id="2d0eb-413">This can be accomplished by using the following code:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-cs/samples/sample14.cs)]

<span data-ttu-id="2d0eb-414">В случае одновременного нарушения запрос на удаление пользователя отменяется.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-414">In the face of a concurrency violation, the user's delete request is canceled.</span></span> <span data-ttu-id="2d0eb-415">Элемент управления GridView обновляется, отображая изменения, произошедшие для этой записи, между моментом загрузки пользователем страницы и нажатием кнопки Удалить.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-415">The GridView is refreshed, showing the changes that occurred for that record between the time the user loaded the page and when he clicked the Delete button.</span></span> <span data-ttu-id="2d0eb-416">Когда происходит такое нарушение, отображается метка `DeleteConflictMessage`, объясняющая, что произошло (см. рис. 20).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-416">When such a violation transpires, the `DeleteConflictMessage` Label is shown, explaining what just happened (see Figure 20).</span></span>

<span data-ttu-id="2d0eb-417">[![Отмена удаления пользователя в случае одновременного нарушения](implementing-optimistic-concurrency-cs/_static/image57.png)](implementing-optimistic-concurrency-cs/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-417">[![A User s Delete is Canceled in the Face of a Concurrency Violation](implementing-optimistic-concurrency-cs/_static/image57.png)](implementing-optimistic-concurrency-cs/_static/image56.png)</span></span>

<span data-ttu-id="2d0eb-418">**Рис. 20**. Отмена удаления пользователя в случае одновременного нарушения ([щелкните, чтобы просмотреть изображение с полным размером](implementing-optimistic-concurrency-cs/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="2d0eb-418">**Figure 20**: A User s Delete is Canceled in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-cs/_static/image58.png))</span></span>

## <a name="summary"></a><span data-ttu-id="2d0eb-419">Сводка</span><span class="sxs-lookup"><span data-stu-id="2d0eb-419">Summary</span></span>

<span data-ttu-id="2d0eb-420">Возможности для одновременных нарушений существуют в каждом приложении, позволяющем нескольким пользователям одновременно обновлять или удалять данные.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-420">Opportunities for concurrency violations exist in every application that allows multiple, concurrent users to update or delete data.</span></span> <span data-ttu-id="2d0eb-421">Если такие нарушения не подписываются в, то когда два пользователя одновременно обновляют одни и те же данные в последней записи «WINS», перезаписывая изменения другого пользователя.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-421">If such violations are not accounted for, when two users simultaneously update the same data whoever gets in the last write "wins," overwriting the other user's changes changes.</span></span> <span data-ttu-id="2d0eb-422">Кроме того, разработчики могут реализовать оптимистичный или пессимистичный контроль параллелизма.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-422">Alternatively, developers can implement either optimistic or pessimistic concurrency control.</span></span> <span data-ttu-id="2d0eb-423">Управление оптимистичным параллелизмом предполагает, что нарушения параллелизма происходят редко, и просто запрещает команду обновления или удаления, которая может составлять нарушение параллелизма.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-423">Optimistic concurrency control assumes that concurrency violations are infrequent and simply disallows an update or delete command that would constitute a concurrency violation.</span></span> <span data-ttu-id="2d0eb-424">Управление пессимистичным параллелизмом предполагает, что одновременные нарушения являются частыми и простое отклонение команды на обновление или удаление одного пользователя не допускается.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-424">Pessimistic concurrency control assumes that concurrency violations are frequent and simply rejecting one user's update or delete command is not acceptable.</span></span> <span data-ttu-id="2d0eb-425">При управлении пессимистичным параллелизмом обновление записи включает в себя ее блокировку, тем самым запрещая другим пользователям изменять или удалять записи, пока она заблокирована.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-425">With pessimistic concurrency control, updating a record involves locking it, thereby preventing any other users from modifying or deleting the record while it is locked.</span></span>

<span data-ttu-id="2d0eb-426">Типизированный набор данных в .NET предоставляет функциональные возможности для поддержки управления оптимистичным параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-426">The Typed DataSet in .NET provides functionality for supporting optimistic concurrency control.</span></span> <span data-ttu-id="2d0eb-427">В частности, инструкции `UPDATE` и `DELETE`, выданные в базу данных, включают все столбцы таблицы, тем самым гарантируя, что обновление или удаление произойдет, только если текущие данные записи соответствуют исходным данным, которые пользователь имел при выполнении обновления или удаления.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-427">In particular, the `UPDATE` and `DELETE` statements issued to the database include all of the table's columns, thereby ensuring that the update or delete will only occur if the record's current data matches with the original data the user had when performing their update or delete.</span></span> <span data-ttu-id="2d0eb-428">После настройки DAL для поддержки оптимистичного параллелизма необходимо обновить методы BLL.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-428">Once the DAL has been configured to support optimistic concurrency, the BLL methods need to be updated.</span></span> <span data-ttu-id="2d0eb-429">Кроме того, страница ASP.NET, которая вызывает BLL, должна быть настроена таким, что ObjectDataSource Извлекает исходные значения из веб-элемента управления данными и передает их в слой BLL.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-429">Additionally, the ASP.NET page that calls down into the BLL must be configured such that the ObjectDataSource retrieves the original values from its data Web control and passes them down into the BLL.</span></span>

<span data-ttu-id="2d0eb-430">Как было показано в этом руководстве, реализация управления оптимистичным параллелизмом в веб-приложении ASP.NET включает обновление DAL и BLL и Добавление поддержки на странице ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-430">As we saw in this tutorial, implementing optimistic concurrency control in an ASP.NET web application involves updating the DAL and BLL and adding support in the ASP.NET page.</span></span> <span data-ttu-id="2d0eb-431">Является ли эта дополнительная работа разумной вложенностью вашего времени и усилий зависит от вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-431">Whether or not this added work is a wise investment of your time and effort depends on your application.</span></span> <span data-ttu-id="2d0eb-432">Если вы редко обновляете данные параллельно с другими пользователями или данные, которые они обновляют, отличаются друг от друга, управление параллелизмом не является ключевой проблемой.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-432">If you infrequently have concurrent users updating data, or the data they are updating is different from one another, then concurrency control is not a key issue.</span></span> <span data-ttu-id="2d0eb-433">Тем не менее, если на вашем сайте часто работают несколько пользователей с одними и теми же данными, управление параллелизмом может помочь предотвратить непреднамеренное перезапись изменений одного или нескольких пользователей.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-433">If, however, you routinely have multiple users on your site working with the same data, concurrency control can help prevent one user's updates or deletes from unwittingly overwriting another's.</span></span>

<span data-ttu-id="2d0eb-434">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="2d0eb-434">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="2d0eb-435">Об авторе</span><span class="sxs-lookup"><span data-stu-id="2d0eb-435">About the Author</span></span>

<span data-ttu-id="2d0eb-436">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="2d0eb-437">Скотт работает как независимый консультант, преподаватель и модуль записи.</span><span class="sxs-lookup"><span data-stu-id="2d0eb-437">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="2d0eb-438">Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-438">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="2d0eb-439">Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-439">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="2d0eb-440">или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="2d0eb-440">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="2d0eb-441">[Назад](customizing-the-data-modification-interface-cs.md)
> [Вперед](adding-client-side-confirmation-when-deleting-cs.md)</span><span class="sxs-lookup"><span data-stu-id="2d0eb-441">[Previous](customizing-the-data-modification-interface-cs.md)
[Next](adding-client-side-confirmation-when-deleting-cs.md)</span></span>
