---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/adding-client-side-confirmation-when-deleting-cs
title: Добавление подтверждения на стороне клиента при удалении (C#) | Документация Майкрософт
author: rick-anderson
description: В созданных ранее интерфейсах пользователь может случайно удалить данные, нажав кнопку Удалить, когда они намерены нажать кнопку Изменить. В этом t...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: f6e2a12a-2b5e-48fd-8db3-1e94a500c19a
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/adding-client-side-confirmation-when-deleting-cs
msc.type: authoredcontent
ms.openlocfilehash: e7d53bc65fdbbfa9ce9bfa5fbdbfa0dea598eebe
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78479820"
---
# <a name="adding-client-side-confirmation-when-deleting-c"></a>Добавление клиентского подтверждения при удалении (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_22_CS.exe) или [Загрузка PDF-файла](adding-client-side-confirmation-when-deleting-cs/_static/datatutorial22cs1.pdf)

> В созданных ранее интерфейсах пользователь может случайно удалить данные, нажав кнопку Удалить, когда они намерены нажать кнопку Изменить. В этом учебнике мы добавим диалоговое окно подтверждения на стороне клиента, которое появляется при нажатии кнопки Удалить.

## <a name="introduction"></a>Введение

В нескольких прошлых учебных курсах мы видели, как использовать нашу архитектуру приложения, ObjectDataSource и веб-элементы управления данными, чтобы обеспечить возможности вставки, редактирования и удаления. Интерфейсы удаления, которые мы Просмотрели ранее, состояли из кнопки Delete, которая при нажатии вызывает обратную передачу и вызывает метод ObjectDataSource `Delete()`. Затем метод `Delete()` вызывает настроенный метод из уровня бизнес-логики, который распространяет вызов на уровень доступа к данным, выдавая фактическую инструкцию `DELETE` в базу данных.

Хотя этот пользовательский интерфейс позволяет посетителям удалять записи с помощью элементов управления GridView, DetailsView или FormView, он не имеет какого-либо подтверждения, когда пользователь нажимает кнопку "Удалить". Если пользователь нажал кнопку "Удалить", когда он нажимает кнопку "Изменить", то запись, которую они хотели обновить, будет удалена. Чтобы помочь предотвратить это, в этом учебнике мы добавим диалоговое окно подтверждения на стороне клиента, которое появляется при нажатии кнопки Удалить.

Функция JavaScript `confirm(string)` выводит свой Строковый входной параметр как текст внутри модального диалогового окна, который оснащен двумя кнопками — ОК и Отмена (см. рис. 1). Функция `confirm(string)` возвращает логическое значение в зависимости от того, какая кнопка нажата (`true`, если пользователь нажимает кнопку ОК, и `false` при нажатии кнопки Отмена).

![Метод Confirm (строка) JavaScript отображает модальное окно MessageBox на стороне клиента.](adding-client-side-confirmation-when-deleting-cs/_static/image1.png)

**Рис. 1**. метод JavaScript `confirm(string)` отображает модальное окно MessageBox на стороне клиента

Если при отправке формы значение `false` возвращается из обработчика событий на стороне клиента, отправка формы отменяется. С помощью этой функции можно использовать обработчик событий `onclick` на стороне клиента, чтобы получить значение вызова `confirm("Are you sure you want to delete this product?")`. Если пользователь нажмет кнопку "Отмена", `confirm(string)` возвратит значение false, что приведет к отмене отправки формы. Если не выполнить обратную передачу, то продукт, кнопка удаления которого была нажата, не будет удален. Однако если пользователь нажмет кнопку ОК в диалоговом окне подтверждения, обратная передача будет продолжена продолжится и продукт будет удален. Дополнительные сведения об этом методе см. в статье [использование метода JavaScript `confirm()` для управления отправкой формы](http://www.webreference.com/programming/javascript/confirm/) .

Добавление необходимого клиентского скрипта незначительно различается при использовании шаблонов, чем при использовании CommandField. Поэтому в этом учебнике мы рассмотрим пример FormView и GridView.

> [!NOTE]
> Используя приемы подтверждения на стороне клиента, как описано в этом руководстве, предполагается, что пользователи посещались в браузерах, поддерживающих JavaScript, и что в них включен JavaScript. Если какое-либо из этих предположений не является верным для конкретного пользователя, нажатие кнопки удалить немедленно вызовет обратную передачу (не отображая окно подтверждения MessageBox).

## <a name="step-1-creating-a-formview-that-supports-deletion"></a>Шаг 1. Создание элемента FormView, поддерживающего удаление

Начните с добавления FormView на страницу `ConfirmationOnDelete.aspx` в папке `EditInsertDelete`, привязывая ее к новому элементу ObjectDataSource, который извлекает сведения о продукте через метод `ProductsBLL` класса s `GetProducts()`. Также настройте ObjectDataSource таким образом, чтобы метод `ProductsBLL` классов `DeleteProduct(productID)` был сопоставлен с методом `Delete()` ObjectDataSource. Убедитесь, что в раскрывающихся списках INSERT и UPDATE задано значение (нет). Наконец, установите флажок Включить разбиение по страницам в смарт-теге FormView.

После выполнения этих действий Новая декларативная разметка ObjectDataSource s будет выглядеть следующим образом:

[!code-aspx[Main](adding-client-side-confirmation-when-deleting-cs/samples/sample1.aspx)]

Как и в наших прошлых примерах, не использующих оптимистичный параллелизм, необходимо очистить свойство `OldValuesParameterFormatString` ObjectDataSource.

Поскольку она привязана к элементу управления ObjectDataSource, который поддерживает только удаление, `ItemTemplate` FormView содержит только кнопку Удалить, в которой отсутствуют кнопки New и Update. Однако декларативная разметка FormView содержит лишние `EditItemTemplate` и `InsertItemTemplate`, которые можно удалить. Настройте `ItemTemplate` таким образом, чтобы в нем было видно только подмножество полей данных продукта. Я настроил, чтобы отображать название продукта в заголовке `<h3>` над именами поставщиков и категорий (вместе с кнопкой Удалить).

[!code-aspx[Main](adding-client-side-confirmation-when-deleting-cs/samples/sample2.aspx)]

С учетом этих изменений у нас есть полнофункциональная веб-страница, позволяющая пользователю последовательно переключаться по продуктам с возможностью удалить продукт, просто нажав кнопку Удалить. На рис. 2 показан снимок экрана с ходом выполнения, который был на данный момент просмотрен в браузере.

[![FormView отображает сведения об одном продукте](adding-client-side-confirmation-when-deleting-cs/_static/image3.png)](adding-client-side-confirmation-when-deleting-cs/_static/image2.png)

**Рис. 2**. элемент FormView отображает сведения об одном продукте ([щелкните, чтобы просмотреть изображение с полным размером](adding-client-side-confirmation-when-deleting-cs/_static/image4.png))

## <a name="step-2-calling-the-confirmstring-function-from-the-delete-buttons-client-side-onclick-event"></a>Шаг 2. вызов функции Confirm (String) из события нажатия кнопки Delete на стороне клиента

После создания FormView необходимо настроить кнопку Delete таким, что при щелчке посетителем вызывается функция JavaScript `confirm(string)`. Добавление клиентского скрипта к кнопке, `onclick` LinkButton или ImageButton на стороне клиента можно выполнить с помощью `OnClientClick property`, который является новым для ASP.NET 2,0. Так как нам нужно возвращать значение функции `confirm(string)`, просто установите это свойство равным: `return confirm('Are you certain that you want to delete this product?');`

После этого изменения декларативный синтаксис инструкции DELETE LinkButton должен выглядеть примерно так:

[!code-aspx[Main](adding-client-side-confirmation-when-deleting-cs/samples/sample3.aspx)]

Вот и все! На рис. 3 показан снимок экрана этого подтверждения в действии. При нажатии кнопки "Удалить" открывается диалоговое окно подтверждения. Если пользователь нажмет кнопку Отмена, обратная передача отменяется и продукт не удаляется. Однако если пользователь нажмет кнопку ОК, обратная передача продолжится и вызывается метод ObjectDataSource `Delete()`, улучшалась в удаляемой записи базы данных.

> [!NOTE]
> Строка, передаваемая в `confirm(string)` функцию JavaScript, отделяется апострофами (а не кавычками). В JavaScript строки можно разделять с помощью любого символа. Здесь мы будем использовать апострофы, чтобы разделители для строки, передаваемой в `confirm(string)`, не выдавали неоднозначность с разделителями, используемыми для значения свойства `OnClientClick`.

[![появится подтверждение при нажатии кнопки "Удалить"](adding-client-side-confirmation-when-deleting-cs/_static/image6.png)](adding-client-side-confirmation-when-deleting-cs/_static/image5.png)

**Рис. 3**. Теперь при нажатии кнопки "Удалить" отображается подтверждение ([щелкните, чтобы просмотреть изображение с полным размером](adding-client-side-confirmation-when-deleting-cs/_static/image7.png))

## <a name="step-3-configuring-the-onclientclick-property-for-the-delete-button-in-a-commandfield"></a>Шаг 3. Настройка свойства OnClientClick для кнопки "Удалить" в CommandField

При работе с кнопкой, LinkButton или ImageButton непосредственно в шаблоне можно связать с ним диалоговое окно подтверждения, просто настроив его свойство `OnClientClick` для возврата результатов функции `confirm(string)` JavaScript. Однако CommandField, который добавляет поле кнопок удаления в GridView или DetailsView, не имеет свойства `OnClientClick`, которое может быть задано декларативно. Вместо этого необходимо программно ссылаться на кнопку Delete в соответствующем `DataBound` обработчике событий GridView или DetailsView, а затем установить его свойство `OnClientClick`.

> [!NOTE]
> При установке свойства `OnClientClick` кнопки "Удалить" в соответствующем `DataBound` обработчике событий у нас есть доступ к данным, привязанным к текущей записи. Это означает, что мы можем расширить сообщение с подтверждением, включив в него подробные сведения о конкретной записи, например: "вы действительно хотите удалить продукт Chai?" Такая настройка также возможна в шаблонах, использующих синтаксис привязки данных.

Чтобы попрактиковаться в установке свойства `OnClientClick` для кнопок удаления в CommandField, добавим GridView к странице. Настройте этот элемент GridView для использования того же элемента управления ObjectDataSource, который используется FormView. Также Ограничьте BoundFields GridView s, включив только название продукта, категорию и поставщика. Наконец, установите флажок Включить удаление из смарт-тега GridView s. Это приведет к добавлению CommandField в коллекцию GridView s `Columns` со свойством `ShowDeleteButton`, для которого задано значение `true`.

После внесения этих изменений декларативная разметка GridView s должна выглядеть следующим образом:

[!code-aspx[Main](adding-client-side-confirmation-when-deleting-cs/samples/sample4.aspx)]

CommandField содержит единственный экземпляр delete LinkButton, доступ к которому можно получить программно из обработчика событий GridView `RowDataBound`. После указания ссылки можно задать соответствующее свойство `OnClientClick`. Создайте обработчик событий для `RowDataBound` события, используя следующий код:

[!code-csharp[Main](adding-client-side-confirmation-when-deleting-cs/samples/sample5.cs)]

Этот обработчик событий работает со строками данных (которые будут иметь кнопку «Удалить») и начинается с программной ссылки на кнопку «Удалить». В общем случае используйте следующий шаблон:

[!code-csharp[Main](adding-client-side-confirmation-when-deleting-cs/samples/sample6.cs)]

*ButtonType* — это тип кнопки, используемой CommandField-Button, LinkButton или ImageButton. По умолчанию CommandField использует элементы LinkButton, но это можно настроить с помощью CommandField `ButtonType property`. *Коммандфиелдиндекс* — это порядковый индекс CommandField в коллекции GridView `Columns`, а *контролиндекс* — индекс кнопки Delete в `Controls` коллекции CommandField. Значение *контролиндекс* зависит от положения кнопок относительно других кнопок в CommandField. Например, если единственной кнопкой, отображаемой в CommandField, является кнопка Удалить, используйте индекс 0. Однако если есть кнопка Изменить, предшествующая кнопке Удалить, используйте индекс 2. Причина использования индекса 2 заключается в том, что CommandField добавляет два элемента управления перед кнопкой "Удалить": кнопка "Изменить" и Литералконтрол, которые использовались для добавления пробела между кнопками "Изменить" и "Удалить".

В нашем конкретном примере CommandField использует LinkButton и, является самым левым полем, имеет *коммандфиелдиндекс* 0. Поскольку нет других кнопок, но в CommandField используется кнопка Удалить, мы используем *контролиндекс* 0.

После того как вы ссылаетесь на кнопку Delete (удалить) в CommandField, мы следующим заносим сведения о продукте, привязанном к текущей строке GridView. Наконец, мы присвоим свойству `OnClientClick` "Удалить" соответствующий код JavaScript, который включает название продукта. Так как строка JavaScript, передаваемая в функцию `confirm(string)`, отделяется с помощью апострофов, необходимо экранировать все апострофы, которые появляются в названии продукта. В частности, любые апострофы в названии продукта преобразуются в escape-символы с помощью "`\'`".

После завершения этих изменений при нажатии кнопки Удалить в элементе GridView отображается настроенное диалоговое окно подтверждения (см. рис. 4). Как и в случае с подтверждением MessageBox из FormView, если пользователь нажимает кнопку Отменить, то отмена обратной передачи отменяется, тем самым предотвращая ее удаление.

> [!NOTE]
> Этот метод также можно использовать для программного доступа к кнопке Delete в CommandField в элементе DetailsView. Однако для элемента DetailsView вы создаете обработчик события `DataBound`, так как элемент DetailsView не имеет события `RowDataBound`.

[![нажатии кнопки GridView s удалить отображается настроенное диалоговое окно подтверждения](adding-client-side-confirmation-when-deleting-cs/_static/image9.png)](adding-client-side-confirmation-when-deleting-cs/_static/image8.png)

**Рис. 4**. при нажатии кнопки GridView s Delete отображается настроенное диалоговое окно подтверждения ([щелкните, чтобы просмотреть изображение с полным размером](adding-client-side-confirmation-when-deleting-cs/_static/image10.png)).

## <a name="using-templatefields"></a>Использование полей TemplateField

Одним из недостатков CommandField является то, что его кнопки должны быть доступны через индексирование и что полученный объект должен быть приведен к соответствующему типу кнопки (Button, LinkButton или ImageButton). Использование "магическых номеров" и жестко запрограммированных типов приглашает к проблемам, которые не удается обнаружить до выполнения. Например, если вы или другой разработчик добавляете новые кнопки к CommandField в какой-либо момент в будущем (например, кнопку "Изменить") или изменяете свойство `ButtonType`, существующий код по-прежнему будет компилироваться без ошибок, но посещение страницы может вызвать исключение или непредвиденное поведение в зависимости от того, как был написан код и какие изменения были внесены.

Альтернативный подход заключается в преобразовании GridView и DetailsView s Коммандфиелдс в полей TemplateField. Это приведет к формированию TemplateField с `ItemTemplate` с LinkButton (или кнопкой или ImageButton) для каждой кнопки в CommandField. Эти кнопки `OnClientClick` свойства могут быть назначены декларативно, как мы видели в FormView, или могут быть программно доступны в соответствующем `DataBound` обработчике событий, используя следующий шаблон:

[!code-csharp[Main](adding-client-side-confirmation-when-deleting-cs/samples/sample7.cs)]

Где *ControlID* — это значение свойства `ID` Button. Хотя этому шаблону по-прежнему требуется жестко заданный тип для приведения, он устраняет необходимость в индексировании, позволяя изменять макет, не выполняя ошибку во время выполнения.

## <a name="summary"></a>Сводка

Функция JavaScript `confirm(string)` — широко распространенный способ управления рабочим процессом отправки формы. При выполнении функции отображается модальное диалоговое окно на стороне клиента, содержащее две кнопки: ОК и Отмена. Если пользователь нажмет кнопку ОК, функция `confirm(string)` возвращает `true`; При нажатии кнопки Отмена возвращаются `false`. Эта функция в сочетании с поведением браузера для отмены отправки формы, если обработчик событий во время отправки возвращает `false`, может использоваться для вывода сообщения о подтверждении при удалении записи.

Функция `confirm(string)` может быть связана с обработчиком событий веб-элемента управления "Кнопка" на стороне клиента `onclick` с помощью свойства `OnClientClick` управления. При работе с кнопкой Удалить в шаблоне — либо в одном из шаблонов FormView, либо в TemplateField в элементе управления DetailsView или GridView. это свойство можно установить либо декларативно, либо программно, как было показано в этом руководстве.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

> [!div class="step-by-step"]
> [Назад](implementing-optimistic-concurrency-cs.md)
> [Вперед](limiting-data-modification-functionality-based-on-the-user-cs.md)
