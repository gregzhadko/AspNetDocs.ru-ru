---
uid: web-forms/overview/data-access/caching-data/caching-data-in-the-architecture-cs
title: Кэширование данных в архитектуреC#() | Документация Майкрософт
author: rick-anderson
description: В предыдущем учебном курсе мы узнали, как применять кэширование на уровне представления. В этом учебнике мы рассмотрите, как воспользоваться преимуществами нашего многоуровневого арчитекту...
ms.author: riande
ms.date: 05/30/2007
ms.assetid: d29a7c41-0628-4a23-9dfc-bfea9c6c1054
msc.legacyurl: /web-forms/overview/data-access/caching-data/caching-data-in-the-architecture-cs
msc.type: authoredcontent
ms.openlocfilehash: 192cadb8e2f862ac2a97a36b375e247b281ece93
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74600823"
---
# <a name="caching-data-in-the-architecture-c"></a><span data-ttu-id="72ff2-104">Кэширование данных в архитектуре (C#)</span><span class="sxs-lookup"><span data-stu-id="72ff2-104">Caching Data in the Architecture (C#)</span></span>

<span data-ttu-id="72ff2-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="72ff2-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="72ff2-106">[Скачивание примера приложения](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_59_CS.exe) или [Загрузка PDF-файла](caching-data-in-the-architecture-cs/_static/datatutorial59cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="72ff2-106">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_59_CS.exe) or [Download PDF](caching-data-in-the-architecture-cs/_static/datatutorial59cs1.pdf)</span></span>

> <span data-ttu-id="72ff2-107">В предыдущем учебном курсе мы узнали, как применять кэширование на уровне представления.</span><span class="sxs-lookup"><span data-stu-id="72ff2-107">In the previous tutorial we learned how to apply caching at the Presentation Layer.</span></span> <span data-ttu-id="72ff2-108">В этом учебнике мы рассмотрите, как использовать преимущества нашей многоуровневой архитектуры для кэширования данных на уровне бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="72ff2-108">In this tutorial we learn how to take advantage of our layered architecture to cache data at the Business Logic Layer.</span></span> <span data-ttu-id="72ff2-109">Это делается путем расширения архитектуры для включения слоя кэширования.</span><span class="sxs-lookup"><span data-stu-id="72ff2-109">We do this by extending the architecture to include a Caching Layer.</span></span>

## <a name="introduction"></a><span data-ttu-id="72ff2-110">Введение</span><span class="sxs-lookup"><span data-stu-id="72ff2-110">Introduction</span></span>

<span data-ttu-id="72ff2-111">Как было показано в предыдущем руководстве, кэширование данных ObjectDataSource не так просто, как установка нескольких свойств.</span><span class="sxs-lookup"><span data-stu-id="72ff2-111">As we saw in the preceding tutorial, caching the ObjectDataSource s data is as simple as setting a couple of properties.</span></span> <span data-ttu-id="72ff2-112">К сожалению, элемент управления ObjectDataSource применяет кэширование на уровне представления, что тесно прикрепляет политики кэширования со страницей ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="72ff2-112">Unfortunately, the ObjectDataSource applies caching at the Presentation Layer, which tightly couples the caching policies with the ASP.NET page.</span></span> <span data-ttu-id="72ff2-113">Одна из причин создания многоуровневой архитектуры заключается в том, чтобы обеспечить разрыв таких взаимосвязей.</span><span class="sxs-lookup"><span data-stu-id="72ff2-113">One of the reasons for creating a layered architecture is to allow such couplings to be broken.</span></span> <span data-ttu-id="72ff2-114">Уровень бизнес-логики, например, разделяет бизнес-логику со страниц ASP.NET, а уровень доступа к данным разделяет сведения о доступе к данным.</span><span class="sxs-lookup"><span data-stu-id="72ff2-114">The Business Logic Layer, for instance, decouples the business logic from the ASP.NET pages, while the Data Access Layer decouples the data access details.</span></span> <span data-ttu-id="72ff2-115">Такое разделение бизнес-логики и сведений о доступе к данным является предпочтительным, в части, поскольку оно делает систему более удобочитаемой, более удобной для сопровождения и более гибкой.</span><span class="sxs-lookup"><span data-stu-id="72ff2-115">This decoupling of business logic and data access details is preferred, in part, because it makes the system more readable, more maintainable, and more flexible to change.</span></span> <span data-ttu-id="72ff2-116">Кроме того, это позволяет разработчикам, работающим на уровне представления, получить знания о предметной области и отделить данные, которые не должны быть знакомы с подробными сведениями о базе данных, чтобы выполнить свою работу.</span><span class="sxs-lookup"><span data-stu-id="72ff2-116">It also allows for domain knowledge and division of labor a developer working on the Presentation Layer doesn t need to be familiar with the database s details in order to do her job.</span></span> <span data-ttu-id="72ff2-117">Отделение политики кэширования от уровня представления презентаций обеспечивает аналогичные преимущества.</span><span class="sxs-lookup"><span data-stu-id="72ff2-117">Decoupling the caching policy from the Presentation Layer offers similar benefits.</span></span>

<span data-ttu-id="72ff2-118">В этом учебнике мы дополнять нашу архитектуру, включив в нее *слой кэширования* (или CL для краткого), в котором применяется наша политика кэширования.</span><span class="sxs-lookup"><span data-stu-id="72ff2-118">In this tutorial we will augment our architecture to include a *Caching Layer* (or CL for short) that employs our caching policy.</span></span> <span data-ttu-id="72ff2-119">Уровень кэширования будет включать класс `ProductsCL`, который предоставляет доступ к сведениям о продукте с помощью таких методов, как `GetProducts()`, `GetProductsByCategoryID(categoryID)`и т. д., которые при вызове будут сначала пытаться получить данные из кэша.</span><span class="sxs-lookup"><span data-stu-id="72ff2-119">The Caching Layer will include a `ProductsCL` class that provides access to product information with methods like `GetProducts()`, `GetProductsByCategoryID(categoryID)`, and so forth, that, when invoked, will first attempt to retrieve the data from the cache.</span></span> <span data-ttu-id="72ff2-120">Если кэш пуст, эти методы вызывают соответствующий метод `ProductsBLL` в BLL, который, в свою очередь, получит данные из DAL.</span><span class="sxs-lookup"><span data-stu-id="72ff2-120">If the cache is empty, these methods will invoke the appropriate `ProductsBLL` method in the BLL, which would in turn get the data from the DAL.</span></span> <span data-ttu-id="72ff2-121">Методы `ProductsCL` кэшируют данные, полученные из BLL, перед их возвратом.</span><span class="sxs-lookup"><span data-stu-id="72ff2-121">The `ProductsCL` methods cache the data retrieved from the BLL before returning it.</span></span>

<span data-ttu-id="72ff2-122">Как показано на рис. 1, среда CL находится между уровнями представления и бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="72ff2-122">As Figure 1 shows, the CL resides between the Presentation and Business Logic Layers.</span></span>

![Уровень кэширования (CL) — это еще один уровень в нашей архитектуре](caching-data-in-the-architecture-cs/_static/image1.png)

<span data-ttu-id="72ff2-124">**Рис. 1**. слой кэширования (CL) — это еще один уровень в нашей архитектуре</span><span class="sxs-lookup"><span data-stu-id="72ff2-124">**Figure 1**: The Caching Layer (CL) is Another Layer in Our Architecture</span></span>

## <a name="step-1-creating-the-caching-layer-classes"></a><span data-ttu-id="72ff2-125">Шаг 1. Создание классов уровня кэширования</span><span class="sxs-lookup"><span data-stu-id="72ff2-125">Step 1: Creating the Caching Layer Classes</span></span>

<span data-ttu-id="72ff2-126">В этом учебнике мы создадим очень простую версию CL с одним классом `ProductsCL`, который содержит всего несколько методов.</span><span class="sxs-lookup"><span data-stu-id="72ff2-126">In this tutorial we will create a very simple CL with a single class `ProductsCL` that has only a handful of methods.</span></span> <span data-ttu-id="72ff2-127">Создание полного слоя кэширования для всего приложения потребует создания классов `CategoriesCL`, `EmployeesCL`и `SuppliersCL` и предоставления метода в этих классах уровней кэширования для каждого метода доступа к данным или изменения в BLL.</span><span class="sxs-lookup"><span data-stu-id="72ff2-127">Building a complete Caching Layer for the entire application would require creating `CategoriesCL`, `EmployeesCL`, and `SuppliersCL` classes, and providing a method in these Caching Layer classes for each data access or modification method in the BLL.</span></span> <span data-ttu-id="72ff2-128">Как и в случае с BLL и DAL, уровень кэширования в идеале должен быть реализован как отдельный проект библиотеки классов. Однако мы будем реализовывать его как класс в папке `App_Code`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-128">As with the BLL and DAL, the Caching Layer should ideally be implemented as a separate Class Library project; however, we will implement it as a class in the `App_Code` folder.</span></span>

<span data-ttu-id="72ff2-129">Чтобы более четко отделить классы CL от классов DAL и BLL, давайте создадим новую вложенную папку в папке `App_Code`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-129">To more cleanly separate the CL classes from the DAL and BLL classes, let s create a new subfolder in the `App_Code` folder.</span></span> <span data-ttu-id="72ff2-130">Щелкните правой кнопкой мыши папку `App_Code` в обозреватель решений, выберите пункт Создать папку и назовите новую папку `CL`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-130">Right-click on the `App_Code` folder in the Solution Explorer, choose New Folder, and name the new folder `CL`.</span></span> <span data-ttu-id="72ff2-131">После создания этой папки добавьте в нее новый класс с именем `ProductsCL.cs`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-131">After creating this folder, add to it a new class named `ProductsCL.cs`.</span></span>

![Добавьте новую папку с именем CL и класс с именем ProductsCL.cs.](caching-data-in-the-architecture-cs/_static/image2.png)

<span data-ttu-id="72ff2-133">**Рис. 2**. Добавление новой папки с именем `CL` и класса с именем `ProductsCL.cs`</span><span class="sxs-lookup"><span data-stu-id="72ff2-133">**Figure 2**: Add a New Folder Named `CL` and a Class Named `ProductsCL.cs`</span></span>

<span data-ttu-id="72ff2-134">Класс `ProductsCL` должен включать тот же набор методов доступа к данным и изменения, что и в соответствующем классе уровня бизнес-логики (`ProductsBLL`).</span><span class="sxs-lookup"><span data-stu-id="72ff2-134">The `ProductsCL` class should include the same set of data access and modification methods as found in its corresponding Business Logic Layer class (`ProductsBLL`).</span></span> <span data-ttu-id="72ff2-135">Вместо того, чтобы создавать все эти методы, давайте просто создадим пару, чтобы получить представление о шаблонах, используемых в CL.</span><span class="sxs-lookup"><span data-stu-id="72ff2-135">Rather than creating all of these methods, let s just build a couple here to get a feel for the patterns used by the CL.</span></span> <span data-ttu-id="72ff2-136">В частности, мы добавим методы `GetProducts()` и `GetProductsByCategoryID(categoryID)` на шаге 3 и `UpdateProduct`ую перегрузку на шаге 4.</span><span class="sxs-lookup"><span data-stu-id="72ff2-136">In particular, we'll add the `GetProducts()` and `GetProductsByCategoryID(categoryID)` methods in Step 3 and an `UpdateProduct` overload in Step 4.</span></span> <span data-ttu-id="72ff2-137">В свободное время можно добавить оставшиеся методы `ProductsCL` и классы `CategoriesCL`, `EmployeesCL`и `SuppliersCL`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-137">You can add the remaining `ProductsCL` methods and `CategoriesCL`, `EmployeesCL`, and `SuppliersCL` classes at your leisure.</span></span>

## <a name="step-2-reading-and-writing-to-the-data-cache"></a><span data-ttu-id="72ff2-138">Шаг 2. чтение и запись в кэш данных</span><span class="sxs-lookup"><span data-stu-id="72ff2-138">Step 2: Reading and Writing to the Data Cache</span></span>

<span data-ttu-id="72ff2-139">Функция кэширования ObjectDataSource, рассмотренная в предыдущем руководстве, внутренне использует кэш данных ASP.NET для хранения данных, полученных из BLL.</span><span class="sxs-lookup"><span data-stu-id="72ff2-139">The ObjectDataSource caching feature explored in the preceding tutorial internally uses the ASP.NET data cache to store the data retrieved from the BLL.</span></span> <span data-ttu-id="72ff2-140">Доступ к кэшу данных также можно получить программным путем из классов ASP.NET страниц кода программной части или из классов в архитектуре веб-приложений.</span><span class="sxs-lookup"><span data-stu-id="72ff2-140">The data cache can also be accessed programmatically from ASP.NET pages code-behind classes or from the classes in the web application s architecture.</span></span> <span data-ttu-id="72ff2-141">Для чтения и записи в кэш данных из класса кода программной части ASP.NET страницы используйте следующий шаблон:</span><span class="sxs-lookup"><span data-stu-id="72ff2-141">To read and write to the data cache from an ASP.NET page s code-behind class, use the following pattern:</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample1.cs)]

<span data-ttu-id="72ff2-142">Метод [`Cache` классов](https://msdn.microsoft.com/library/system.web.caching.cache.aspx) [`Insert`](https://msdn.microsoft.com/library/system.web.caching.cache.insert.aspx) имеет ряд перегрузок.</span><span class="sxs-lookup"><span data-stu-id="72ff2-142">The [`Cache` class](https://msdn.microsoft.com/library/system.web.caching.cache.aspx) s [`Insert` method](https://msdn.microsoft.com/library/system.web.caching.cache.insert.aspx) has a number of overloads.</span></span> <span data-ttu-id="72ff2-143">`Cache["key"] = value` и `Cache.Insert(key, value)` являются синонимами и добавляют элемент в кэш с помощью указанного ключа без определенного срока действия.</span><span class="sxs-lookup"><span data-stu-id="72ff2-143">`Cache["key"] = value` and `Cache.Insert(key, value)` are synonymous and both add an item to the cache using the specified key without a defined expiry.</span></span> <span data-ttu-id="72ff2-144">Как правило, мы хотим указать срок действия при добавлении элемента в кэш либо в качестве зависимости, истечения срока действия на основе времени, либо в обоих случаях.</span><span class="sxs-lookup"><span data-stu-id="72ff2-144">Typically, we want to specify an expiry when adding an item to the cache, either as a dependency, a time-based expiry, or both.</span></span> <span data-ttu-id="72ff2-145">Используйте один из других перегрузок метода `Insert`, чтобы предоставить сведения об истечении срока действия зависимости или времени.</span><span class="sxs-lookup"><span data-stu-id="72ff2-145">Use one of the other `Insert` method s overloads to provide dependency- or time-based expiry information.</span></span>

<span data-ttu-id="72ff2-146">Методы уровня кэширования должны сначала проверить, находятся ли запрошенные данные в кэше, и, если да, вернуть их отсюда.</span><span class="sxs-lookup"><span data-stu-id="72ff2-146">The Caching Layer s methods need to first check if the requested data is in the cache and, if so, return it from there.</span></span> <span data-ttu-id="72ff2-147">Если запрошенные данные отсутствуют в кэше, необходимо вызвать соответствующий метод BLL.</span><span class="sxs-lookup"><span data-stu-id="72ff2-147">If the requested data is not in the cache, the appropriate BLL method needs to be invoked.</span></span> <span data-ttu-id="72ff2-148">Возвращаемое значение должно кэшироваться, а затем возвращаться, как показано на следующей схеме последовательностей.</span><span class="sxs-lookup"><span data-stu-id="72ff2-148">Its return value should be cached and then returned, as the following sequence diagram illustrates.</span></span>

![Методы уровня кэширования возвращают данные из кэша, если они доступны](caching-data-in-the-architecture-cs/_static/image3.png)

<span data-ttu-id="72ff2-150">**Рис. 3**. методы уровня кэширования возвращают данные из кэша, если они доступны</span><span class="sxs-lookup"><span data-stu-id="72ff2-150">**Figure 3**: The Caching Layer s Methods Return Data from the Cache if it s Available</span></span>

<span data-ttu-id="72ff2-151">Последовательность, показанная на рис. 3, реализована в классах CL в следующем формате:</span><span class="sxs-lookup"><span data-stu-id="72ff2-151">The sequence depicted in Figure 3 is accomplished in the CL classes using the following pattern:</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample2.cs)]

<span data-ttu-id="72ff2-152">Здесь *Type* — это тип данных, хранящихся в кэше `Northwind.ProductsDataTable`, например, если *ключ* — это ключ, однозначно определяющий элемент кэша.</span><span class="sxs-lookup"><span data-stu-id="72ff2-152">Here, *Type* is the type of data being stored in the cache `Northwind.ProductsDataTable`, for example while *key* is the key that uniquely identifies the cache item.</span></span> <span data-ttu-id="72ff2-153">Если элемент с указанным *ключом* отсутствует в кэше, то *экземпляр* будет `null`, а данные будут получены из соответствующего метода BLL и добавлены в кэш.</span><span class="sxs-lookup"><span data-stu-id="72ff2-153">If the item with the specified *key* is not in the cache, then *instance* will be `null` and the data will be retrieved from the appropriate BLL method and added to the cache.</span></span> <span data-ttu-id="72ff2-154">По достижении времени `return instance` *экземпляр* содержит ссылку на данные из кэша или из слоя BLL.</span><span class="sxs-lookup"><span data-stu-id="72ff2-154">By the time `return instance` is reached, *instance* contains a reference to the data, either from the cache or pulled from the BLL.</span></span>

<span data-ttu-id="72ff2-155">При доступе к данным из кэша обязательно используйте приведенный выше шаблон.</span><span class="sxs-lookup"><span data-stu-id="72ff2-155">Be sure to use the above pattern when accessing data from the cache.</span></span> <span data-ttu-id="72ff2-156">Следующий шаблон, на первый взгляд, выглядит эквивалентным, содержит незаметное различие, которое порождает состояние гонки.</span><span class="sxs-lookup"><span data-stu-id="72ff2-156">The following pattern, which, at first glance, looks equivalent, contains a subtle difference that introduces a race condition.</span></span> <span data-ttu-id="72ff2-157">Трудно выполнить отладку, так как они раскрывают их случайным путем и трудно воспроизвести.</span><span class="sxs-lookup"><span data-stu-id="72ff2-157">Race conditions are difficult to debug because they reveal themselves sporadically and are difficult to reproduce.</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample3.cs)]

<span data-ttu-id="72ff2-158">Разница во втором, неверный фрагмент кода заключается в том, что вместо сохранения ссылки на кэшированный элемент в локальной переменной доступ к кэшу данных осуществляется непосредственно в условном операторе *и* в `return`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-158">The difference in this second, incorrect code snippet is that rather than storing a reference to the cached item in a local variable, the data cache is accessed directly in the conditional statement *and* in the `return`.</span></span> <span data-ttu-id="72ff2-159">Представьте, что при достижении этого кода `Cache["key"]` не является`null`, но перед тем, как будет достигнута инструкция `return`, система происключает *ключ* из кэша.</span><span class="sxs-lookup"><span data-stu-id="72ff2-159">Imagine that when this code is reached, `Cache["key"]` is non-`null`, but before the `return` statement is reached, the system evicts *key* from the cache.</span></span> <span data-ttu-id="72ff2-160">В этом редких случаях код возвратит `null` значение, а не объект ожидаемого типа.</span><span class="sxs-lookup"><span data-stu-id="72ff2-160">In this rare case, the code will return a `null` value rather than an object of the expected type.</span></span>

> [!NOTE]
> <span data-ttu-id="72ff2-161">Кэш данных является потокобезопасным, поэтому вам не нужно синхронизировать доступ к потоку для простого чтения или записи.</span><span class="sxs-lookup"><span data-stu-id="72ff2-161">The data cache is thread-safe, so you don t need to synchronize thread access for simple reads or writes.</span></span> <span data-ttu-id="72ff2-162">Однако, если необходимо выполнить несколько операций с данными в кэше, которые должны быть атомарными, вы несете ответственность за реализацию блокировки или какого-либо другого механизма обеспечения безопасности потоков.</span><span class="sxs-lookup"><span data-stu-id="72ff2-162">However, if you need to perform multiple operations on data in the cache that need to be atomic, you are responsible for implementing a lock or some other mechanism to ensure thread safety.</span></span> <span data-ttu-id="72ff2-163">Дополнительные сведения см. в разделе [синхронизация доступа к кэшу ASP.NET](http://www.ddj.com/184406369) .</span><span class="sxs-lookup"><span data-stu-id="72ff2-163">See [Synchronizing Access to the ASP.NET Cache](http://www.ddj.com/184406369) for more information.</span></span>

<span data-ttu-id="72ff2-164">Элемент можно программно удалить из кэша данных с помощью [метода`Remove`](https://msdn.microsoft.com/library/system.web.caching.cache.remove.aspx) следующим образом:</span><span class="sxs-lookup"><span data-stu-id="72ff2-164">An item can be programmatically evicted from the data cache using the [`Remove` method](https://msdn.microsoft.com/library/system.web.caching.cache.remove.aspx) like so:</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample4.cs)]

## <a name="step-3-returning-product-information-from-theproductsclclass"></a><span data-ttu-id="72ff2-165">Шаг 3. Возврат сведений о продукте из класса`ProductsCL`</span><span class="sxs-lookup"><span data-stu-id="72ff2-165">Step 3: Returning Product Information from the`ProductsCL`Class</span></span>

<span data-ttu-id="72ff2-166">В этом руководстве мы рассмотрим реализацию двух методов возврата сведений о продукте из класса `ProductsCL`: `GetProducts()` и `GetProductsByCategoryID(categoryID)`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-166">For this tutorial let s implement two methods for returning product information from the `ProductsCL` class: `GetProducts()` and `GetProductsByCategoryID(categoryID)`.</span></span> <span data-ttu-id="72ff2-167">Как и в случае с классом `ProductsBL` на уровне бизнес-логики, метод `GetProducts()` в CL возвращает сведения обо всех продуктах как объект `Northwind.ProductsDataTable`, а `GetProductsByCategoryID(categoryID)` возвращает все продукты из указанной категории.</span><span class="sxs-lookup"><span data-stu-id="72ff2-167">Like with the `ProductsBL` class in the Business Logic Layer, the `GetProducts()` method in the CL returns information about all of the products as a `Northwind.ProductsDataTable` object, while `GetProductsByCategoryID(categoryID)` returns all of the products from a specified category.</span></span>

<span data-ttu-id="72ff2-168">В следующем коде показана часть методов класса `ProductsCL`:</span><span class="sxs-lookup"><span data-stu-id="72ff2-168">The following code shows a portion of the methods in the `ProductsCL` class:</span></span>

[!code-vb[Main](caching-data-in-the-architecture-cs/samples/sample5.vb)]

<span data-ttu-id="72ff2-169">Сначала обратите внимание на атрибуты `DataObject` и `DataObjectMethodAttribute`, применяемые к классу и методам.</span><span class="sxs-lookup"><span data-stu-id="72ff2-169">First, note the `DataObject` and `DataObjectMethodAttribute` attributes applied to the class and methods.</span></span> <span data-ttu-id="72ff2-170">Эти атрибуты предоставляют сведения в мастере ObjectDataSource s, указывающие, какие классы и методы должны отображаться в шагах мастера.</span><span class="sxs-lookup"><span data-stu-id="72ff2-170">These attributes provide information to the ObjectDataSource s wizard, indicating what classes and methods should appear in the wizard s steps.</span></span> <span data-ttu-id="72ff2-171">Поскольку доступ к классам и методам CL осуществляется из элемента управления ObjectDataSource на уровне представления, я добавил эти атрибуты для улучшения работы во время разработки.</span><span class="sxs-lookup"><span data-stu-id="72ff2-171">Since the CL classes and methods will be accessed from an ObjectDataSource in the Presentation Layer, I added these attributes to enhance the design-time experience.</span></span> <span data-ttu-id="72ff2-172">См. Руководство по [созданию уровня бизнес-логики](../introduction/creating-a-business-logic-layer-cs.md) для более подробного описания этих атрибутов и их последствий.</span><span class="sxs-lookup"><span data-stu-id="72ff2-172">Refer back to the [Creating a Business Logic Layer](../introduction/creating-a-business-logic-layer-cs.md) tutorial for a more thorough description on these attributes and their effects.</span></span>

<span data-ttu-id="72ff2-173">В методах `GetProducts()` и `GetProductsByCategoryID(categoryID)` данные, возвращаемые методом `GetCacheItem(key)`, назначаются локальной переменной.</span><span class="sxs-lookup"><span data-stu-id="72ff2-173">In the `GetProducts()` and `GetProductsByCategoryID(categoryID)` methods, the data returned from the `GetCacheItem(key)` method is assigned to a local variable.</span></span> <span data-ttu-id="72ff2-174">Метод `GetCacheItem(key)`, который мы рассмотрим вскоре, возвращает определенный элемент из кэша на основе указанного *ключа*.</span><span class="sxs-lookup"><span data-stu-id="72ff2-174">The `GetCacheItem(key)` method, which we'll examine shortly, returns a particular item from the cache based on the specified *key*.</span></span> <span data-ttu-id="72ff2-175">Если такие данные не найдены в кэше, они извлекаются из соответствующего метода `ProductsBLL` класса, а затем добавляются в кэш с помощью метода `AddCacheItem(key, value)`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-175">If no such data is found in cache, it is retrieved from the corresponding `ProductsBLL` class method and then added to the cache using the `AddCacheItem(key, value)` method.</span></span>

<span data-ttu-id="72ff2-176">Методы `GetCacheItem(key)` и `AddCacheItem(key, value)` интерфейсом с кэшем данных, считывающими и записывающими значения соответственно.</span><span class="sxs-lookup"><span data-stu-id="72ff2-176">The `GetCacheItem(key)` and `AddCacheItem(key, value)` methods interface with the data cache, reading and writing values, respectively.</span></span> <span data-ttu-id="72ff2-177">Метод `GetCacheItem(key)` является более простым из двух.</span><span class="sxs-lookup"><span data-stu-id="72ff2-177">The `GetCacheItem(key)` method is the simpler of the two.</span></span> <span data-ttu-id="72ff2-178">Он просто возвращает значение из класса Cache, используя переданный *ключ*:</span><span class="sxs-lookup"><span data-stu-id="72ff2-178">It simply returns the value from the Cache class using the passed-in *key*:</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample6.cs)]

<span data-ttu-id="72ff2-179">`GetCacheItem(key)` не использует значение *ключа* , как указано, а вызывает метод `GetCacheKey(key)`, который возвращает *ключ* , добавленный в начале продуктскаче-.</span><span class="sxs-lookup"><span data-stu-id="72ff2-179">`GetCacheItem(key)` does not use *key* value as supplied, but instead calls the `GetCacheKey(key)` method, which returns the *key* prepended with ProductsCache-.</span></span> <span data-ttu-id="72ff2-180">`MasterCacheKeyArray`, содержащий строку Продуктскаче, также используется методом `AddCacheItem(key, value)`, как будет видно мгновенно.</span><span class="sxs-lookup"><span data-stu-id="72ff2-180">The `MasterCacheKeyArray`, which holds the string ProductsCache, is also used by the `AddCacheItem(key, value)` method, as we'll see momentarily.</span></span>

<span data-ttu-id="72ff2-181">Из класса кода программной части ASP.NET Page можно получить доступ к кэшу данных с помощью свойства `Page` класса [`Cache`](https://msdn.microsoft.com/library/system.web.ui.page.cache.aspx)и допустить синтаксис, подобный `Cache["key"] = value`, как описано на шаге 2.</span><span class="sxs-lookup"><span data-stu-id="72ff2-181">From an ASP.NET page s code-behind class, the data cache can be accessed using the `Page` class s [`Cache` property](https://msdn.microsoft.com/library/system.web.ui.page.cache.aspx), and allows for syntax like `Cache["key"] = value`, as discussed in Step 2.</span></span> <span data-ttu-id="72ff2-182">Из класса в архитектуре доступ к кэшу данных можно получить с помощью `HttpRuntime.Cache` или `HttpContext.Current.Cache`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-182">From a class within the architecture, the data cache can be accessed using either `HttpRuntime.Cache` or `HttpContext.Current.Cache`.</span></span> <span data-ttu-id="72ff2-183">Запись блога [Питер Джонсон](https://weblogs.asp.net/pjohnson/default.aspx) [httpRuntime. Cache и HttpContext. Current. Cache](https://weblogs.asp.net/pjohnson/httpruntime-cache-vs-httpcontext-current-cache) замещает небольшое преимущество в производительности при использовании `HttpRuntime` вместо `HttpContext.Current`; Следовательно, `ProductsCL` использует `HttpRuntime`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-183">[Peter Johnson](https://weblogs.asp.net/pjohnson/default.aspx)'s blog entry [HttpRuntime.Cache vs. HttpContext.Current.Cache](https://weblogs.asp.net/pjohnson/httpruntime-cache-vs-httpcontext-current-cache) notes the slight performance advantage in using `HttpRuntime` instead of `HttpContext.Current`; consequently, `ProductsCL` uses `HttpRuntime`.</span></span>

> [!NOTE]
> <span data-ttu-id="72ff2-184">Если архитектура реализуется с помощью проектов библиотеки классов, необходимо добавить ссылку на `System.Web` сборку, чтобы использовать классы [httpRuntime](https://msdn.microsoft.com/library/system.web.httpruntime.aspx) и [HttpContext](https://msdn.microsoft.com/library/system.web.httpcontext.aspx) .</span><span class="sxs-lookup"><span data-stu-id="72ff2-184">If your architecture is implemented using Class Library projects then you will need to add a reference to the `System.Web` assembly in order to use the [HttpRuntime](https://msdn.microsoft.com/library/system.web.httpruntime.aspx) and [HttpContext](https://msdn.microsoft.com/library/system.web.httpcontext.aspx) classes.</span></span>

<span data-ttu-id="72ff2-185">Если элемент не найден в кэше, методы `ProductsCL` класса s получают данные из слоя BLL и добавляют их в кэш с помощью метода `AddCacheItem(key, value)`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-185">If the item is not found in the cache, the `ProductsCL` class s methods get the data from the BLL and add it to the cache using the `AddCacheItem(key, value)` method.</span></span> <span data-ttu-id="72ff2-186">Чтобы добавить *значение* в кэш, можно использовать следующий код, который использует время истечения 60 секунды.</span><span class="sxs-lookup"><span data-stu-id="72ff2-186">To add *value* to the cache we could use the following code, which uses a 60 second time expiry:</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample7.cs)]

<span data-ttu-id="72ff2-187">`DateTime.Now.AddSeconds(CacheDuration)` указывает время истечения срока действия в 60 секунд в будущем, в то время как [`System.Web.Caching.Cache.NoSlidingExpiration`](https://msdn.microsoft.com/library/system.web.caching.cache.noslidingexpiration(vs.80).aspx) указывает на отсутствие скользящего срока действия.</span><span class="sxs-lookup"><span data-stu-id="72ff2-187">`DateTime.Now.AddSeconds(CacheDuration)` specifies the time-based expiry 60 seconds in the future while [`System.Web.Caching.Cache.NoSlidingExpiration`](https://msdn.microsoft.com/library/system.web.caching.cache.noslidingexpiration(vs.80).aspx) indicates that there s no sliding expiration.</span></span> <span data-ttu-id="72ff2-188">Хотя эта перегрузка метода `Insert` имеет входные параметры как для абсолютного, так и для скользящего срока действия, можно предоставить только одно из двух.</span><span class="sxs-lookup"><span data-stu-id="72ff2-188">While this `Insert` method overload has input parameters for both an absolute and sliding expiry, you can only provide one of the two.</span></span> <span data-ttu-id="72ff2-189">При попытке указать и абсолютное время, и интервал времени метод `Insert` вызовет исключение `ArgumentException`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-189">If you attempt to specify both an absolute time and a time span, the `Insert` method will throw an `ArgumentException` exception.</span></span>

> [!NOTE]
> <span data-ttu-id="72ff2-190">Эта реализация метода `AddCacheItem(key, value)` в настоящее время имеет несколько недостатков.</span><span class="sxs-lookup"><span data-stu-id="72ff2-190">This implementation of the `AddCacheItem(key, value)` method currently has some shortcomings.</span></span> <span data-ttu-id="72ff2-191">Мы будем решать и преодолеть эти проблемы на шаге 4.</span><span class="sxs-lookup"><span data-stu-id="72ff2-191">We'll address and overcome these issues in Step 4.</span></span>

## <a name="step-4-invalidating-the-cache-when-the-data-is-modified-through-the-architecture"></a><span data-ttu-id="72ff2-192">Шаг 4. непроверяемый кэш при изменении данных с помощью архитектуры</span><span class="sxs-lookup"><span data-stu-id="72ff2-192">Step 4: Invalidating the Cache When the Data is Modified Through the Architecture</span></span>

<span data-ttu-id="72ff2-193">Наряду с методами получения данных, уровень кэширования должен предоставлять те же методы, что и BLL для вставки, обновления и удаления данных.</span><span class="sxs-lookup"><span data-stu-id="72ff2-193">Along with data retrieval methods, the Caching Layer needs to provide the same methods as the BLL for inserting, updating, and deleting data.</span></span> <span data-ttu-id="72ff2-194">Методы изменения данных в CL s не изменяют кэшированные данные, а вызывают соответствующий метод изменения данных BLL, а затем делают кэш недействительным.</span><span class="sxs-lookup"><span data-stu-id="72ff2-194">The CL s data modification methods do not modify the cached data, but rather call the BLL s corresponding data modification method and then invalidate the cache.</span></span> <span data-ttu-id="72ff2-195">Как было показано в предыдущем учебном курсе, это то же поведение, которое элемент ObjectDataSource применяет при включении функций кэширования, а также при вызове методов `Insert`, `Update`или `Delete`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-195">As we saw in the preceding tutorial, this is the same behavior that the ObjectDataSource applies when its caching features are enabled and its `Insert`, `Update`, or `Delete` methods are invoked.</span></span>

<span data-ttu-id="72ff2-196">Следующая перегрузка `UpdateProduct` показывает, как реализовать методы изменения данных в CL:</span><span class="sxs-lookup"><span data-stu-id="72ff2-196">The following `UpdateProduct` overload illustrates how to implement the data modification methods in the CL:</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample8.cs)]

<span data-ttu-id="72ff2-197">Вызывается соответствующий метод уровня бизнес-логики модификации данных, но до возврата ответа необходимо сделать кэш недействительным.</span><span class="sxs-lookup"><span data-stu-id="72ff2-197">The appropriate data modification Business Logic Layer method is invoked, but before its response is returned we need to invalidate the cache.</span></span> <span data-ttu-id="72ff2-198">К сожалению, аннулирование кэша не является простым, поскольку `ProductsCL` классов `GetProducts()` и методы `GetProductsByCategoryID(categoryID)` каждый из них добавляют элементы в кэш с разными ключами, а метод `GetProductsByCategoryID(categoryID)` добавляет отдельный элемент кэша для каждого уникального *CategoryID*.</span><span class="sxs-lookup"><span data-stu-id="72ff2-198">Unfortunately, invalidating the cache is not straightforward because the `ProductsCL` class s `GetProducts()` and `GetProductsByCategoryID(categoryID)` methods each add items to the cache with different keys, and the `GetProductsByCategoryID(categoryID)` method adds a different cache item for each unique *categoryID*.</span></span>

<span data-ttu-id="72ff2-199">При непроверке кэша необходимо удалить *все* элементы, которые могли быть добавлены классом `ProductsCL`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-199">When invalidating the cache, we need to remove *all* of the items that may have been added by the `ProductsCL` class.</span></span> <span data-ttu-id="72ff2-200">Это можно сделать, связав *зависимость кэша* с каждым элементом, добавленным в кэш в методе `AddCacheItem(key, value)`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-200">This can be accomplished by associating a *cache dependency* with the each item added to the cache in the `AddCacheItem(key, value)` method.</span></span> <span data-ttu-id="72ff2-201">Как правило, зависимость кэша может быть другим элементом в кэше, файлом в файловой системе или данными из базы данных Microsoft SQL Server.</span><span class="sxs-lookup"><span data-stu-id="72ff2-201">In general, a cache dependency can be another item in the cache, a file on the file system, or data from a Microsoft SQL Server database.</span></span> <span data-ttu-id="72ff2-202">При изменении или удалении зависимости из кэша элементы кэша, с которыми он связан, автоматически удаляются из кэша.</span><span class="sxs-lookup"><span data-stu-id="72ff2-202">When the dependency changes or is removed from the cache, the cache items it is associated with are automatically evicted from the cache.</span></span> <span data-ttu-id="72ff2-203">В этом руководстве мы хотим создать дополнительный элемент в кэше, который служит зависимостью кэша для всех элементов, добавленных с помощью класса `ProductsCL`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-203">For this tutorial, we want to create an additional item in the cache that serves as a cache dependency for all items added through the `ProductsCL` class.</span></span> <span data-ttu-id="72ff2-204">Таким образом, все эти элементы можно удалить из кэша, просто удалив зависимость кэша.</span><span class="sxs-lookup"><span data-stu-id="72ff2-204">That way, all of these items can be removed from the cache by simply removing the cache dependency.</span></span>

<span data-ttu-id="72ff2-205">Добавим метод `AddCacheItem(key, value)`, чтобы каждый элемент, добавленный в кэш с помощью этого метода, был связан с единственной зависимостью кэша:</span><span class="sxs-lookup"><span data-stu-id="72ff2-205">Let s update the `AddCacheItem(key, value)` method so that each item added to the cache through this method is associated with a single cache dependency:</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample9.cs)]

<span data-ttu-id="72ff2-206">`MasterCacheKeyArray` — это массив строк, содержащий одно значение Продуктскаче.</span><span class="sxs-lookup"><span data-stu-id="72ff2-206">`MasterCacheKeyArray` is a string array that holds a single value, ProductsCache.</span></span> <span data-ttu-id="72ff2-207">Сначала элемент кэша добавляется в кэш и ему присваивается текущая дата и время.</span><span class="sxs-lookup"><span data-stu-id="72ff2-207">First, a cache item is added to the cache and assigned the current date and time.</span></span> <span data-ttu-id="72ff2-208">Если элемент кэша уже существует, он обновляется.</span><span class="sxs-lookup"><span data-stu-id="72ff2-208">If the cache item already exists, it is updated.</span></span> <span data-ttu-id="72ff2-209">Далее создается зависимость кэша.</span><span class="sxs-lookup"><span data-stu-id="72ff2-209">Next, a cache dependency is created.</span></span> <span data-ttu-id="72ff2-210">Конструктор [`CacheDependency` класса](https://msdn.microsoft.com/library/system.web.caching.cachedependency(VS.80).aspx) s имеет ряд перегрузок, но в нем используется два входных массива `string`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-210">The [`CacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.cachedependency(VS.80).aspx) s constructor has a number of overloads, but the one being used in here expects two `string` array inputs.</span></span> <span data-ttu-id="72ff2-211">Первый указывает набор файлов, которые будут использоваться в качестве зависимостей.</span><span class="sxs-lookup"><span data-stu-id="72ff2-211">The first one specifies the set of files to be used as dependencies.</span></span> <span data-ttu-id="72ff2-212">Поскольку мы не будем использовать зависимости на основе файлов, для первого входного параметра используется значение `null`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-212">Since we don t want to use any file-based dependencies, a value of `null` is used for the first input parameter.</span></span> <span data-ttu-id="72ff2-213">Второй входной параметр задает набор ключей кэша для использования в качестве зависимостей.</span><span class="sxs-lookup"><span data-stu-id="72ff2-213">The second input parameter specifies the set of cache keys to use as dependencies.</span></span> <span data-ttu-id="72ff2-214">Здесь мы указываем одну зависимость, `MasterCacheKeyArray`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-214">Here we specify our single dependency, `MasterCacheKeyArray`.</span></span> <span data-ttu-id="72ff2-215">Затем `CacheDependency` передается в метод `Insert`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-215">The `CacheDependency` is then passed into the `Insert` method.</span></span>

<span data-ttu-id="72ff2-216">С этим изменением в `AddCacheItem(key, value)`недействительность кэша сводится к удалению зависимости.</span><span class="sxs-lookup"><span data-stu-id="72ff2-216">With this modification to `AddCacheItem(key, value)`, invaliding the cache is as simple as removing the dependency.</span></span>

[!code-csharp[Main](caching-data-in-the-architecture-cs/samples/sample10.cs)]

## <a name="step-5-calling-the-caching-layer-from-the-presentation-layer"></a><span data-ttu-id="72ff2-217">Шаг 5. вызов слоя кэширования из уровня представления</span><span class="sxs-lookup"><span data-stu-id="72ff2-217">Step 5: Calling the Caching Layer from the Presentation Layer</span></span>

<span data-ttu-id="72ff2-218">Классы и методы уровня кэширования можно использовать для работы с данными с помощью методов, которые мы проверили в рамках этих руководств.</span><span class="sxs-lookup"><span data-stu-id="72ff2-218">The Caching Layer s classes and methods can be used to work with data using the techniques we ve examined throughout these tutorials.</span></span> <span data-ttu-id="72ff2-219">Чтобы продемонстрировать работу с кэшированными данными, сохраните изменения в классе `ProductsCL`, а затем откройте страницу `FromTheArchitecture.aspx` в папке `Caching` и добавьте GridView.</span><span class="sxs-lookup"><span data-stu-id="72ff2-219">To illustrate working with cached data, save your changes to the `ProductsCL` class and then open the `FromTheArchitecture.aspx` page in the `Caching` folder and add a GridView.</span></span> <span data-ttu-id="72ff2-220">Из смарт-тега GridView s создайте новый элемент ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="72ff2-220">From the GridView s smart tag, create a new ObjectDataSource.</span></span> <span data-ttu-id="72ff2-221">В первом шаге мастера вы увидите класс `ProductsCL` в качестве одного из вариантов из раскрывающегося списка.</span><span class="sxs-lookup"><span data-stu-id="72ff2-221">In the wizard s first step you should see the `ProductsCL` class as one of the options from the drop-down list.</span></span>

<span data-ttu-id="72ff2-222">[![класс Продуктскл включен в раскрывающийся список бизнес-объектов](caching-data-in-the-architecture-cs/_static/image5.png)](caching-data-in-the-architecture-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="72ff2-222">[![The ProductsCL Class is Included in the Business Object Drop-Down List](caching-data-in-the-architecture-cs/_static/image5.png)](caching-data-in-the-architecture-cs/_static/image4.png)</span></span>

<span data-ttu-id="72ff2-223">**Рис. 4**. класс `ProductsCL` входит в раскрывающийся список бизнес-объектов ([щелкните, чтобы просмотреть изображение с полным размером](caching-data-in-the-architecture-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="72ff2-223">**Figure 4**: The `ProductsCL` Class is Included in the Business Object Drop-Down List ([Click to view full-size image](caching-data-in-the-architecture-cs/_static/image6.png))</span></span>

<span data-ttu-id="72ff2-224">После выбора `ProductsCL`нажмите кнопку Далее.</span><span class="sxs-lookup"><span data-stu-id="72ff2-224">After selecting `ProductsCL`, click Next.</span></span> <span data-ttu-id="72ff2-225">Раскрывающийся список на вкладке Выбор содержит два элемента: `GetProducts()` и `GetProductsByCategoryID(categoryID)`, а вкладка обновление имеет единственную `UpdateProduct` перегрузку.</span><span class="sxs-lookup"><span data-stu-id="72ff2-225">The drop-down list in the SELECT tab has two items - `GetProducts()` and `GetProductsByCategoryID(categoryID)` and the UPDATE tab has the sole `UpdateProduct` overload.</span></span> <span data-ttu-id="72ff2-226">Выберите метод `GetProducts()` на вкладке "выбор" и метод `UpdateProducts` на вкладке "обновление" и нажмите кнопку "Готово".</span><span class="sxs-lookup"><span data-stu-id="72ff2-226">Choose the `GetProducts()` method from the SELECT tab and the `UpdateProducts` method from the UPDATE tab and click Finish.</span></span>

<span data-ttu-id="72ff2-227">[![методы класса Продуктскл перечислены в раскрывающихся списках.](caching-data-in-the-architecture-cs/_static/image8.png)](caching-data-in-the-architecture-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="72ff2-227">[![The ProductsCL Class s Methods are Listed in the Drop-Down Lists](caching-data-in-the-architecture-cs/_static/image8.png)](caching-data-in-the-architecture-cs/_static/image7.png)</span></span>

<span data-ttu-id="72ff2-228">**Рис. 5**. методы `ProductsCL` классов перечислены в раскрывающихся списках ([щелкните, чтобы просмотреть изображение с полным размером](caching-data-in-the-architecture-cs/_static/image9.png)).</span><span class="sxs-lookup"><span data-stu-id="72ff2-228">**Figure 5**: The `ProductsCL` Class s Methods are Listed in the Drop-Down Lists ([Click to view full-size image](caching-data-in-the-architecture-cs/_static/image9.png))</span></span>

<span data-ttu-id="72ff2-229">После завершения работы мастера Visual Studio задаст свойству `OldValuesParameterFormatString` ObjectDataSource s значение `original_{0}` и добавить соответствующие поля в GridView.</span><span class="sxs-lookup"><span data-stu-id="72ff2-229">After completing the wizard, Visual Studio will set the ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}` and add the appropriate fields to the GridView.</span></span> <span data-ttu-id="72ff2-230">Снова задайте для свойства `OldValuesParameterFormatString` значение по умолчанию, `{0}`и настройте GridView для поддержки разбиения по страницам, сортировки и редактирования.</span><span class="sxs-lookup"><span data-stu-id="72ff2-230">Change the `OldValuesParameterFormatString` property back to its default value, `{0}`, and configure the GridView to support paging, sorting, and editing.</span></span> <span data-ttu-id="72ff2-231">Поскольку перегрузка `UploadProducts`, используемая модулем CL, принимает только измененное имя и цену продукта, ограничьте GridView таким образом, чтобы только эти поля были доступны для изменения.</span><span class="sxs-lookup"><span data-stu-id="72ff2-231">Since the `UploadProducts` overload used by the CL accepts only the edited product s name and price, limit the GridView so that only these fields are editable.</span></span>

<span data-ttu-id="72ff2-232">В предыдущем учебном курсе мы определили GridView для включения полей `ProductName`, `CategoryName`и `UnitPrice` полей.</span><span class="sxs-lookup"><span data-stu-id="72ff2-232">In the preceding tutorial we defined a GridView to include fields for the `ProductName`, `CategoryName`, and `UnitPrice` fields.</span></span> <span data-ttu-id="72ff2-233">Вы можете реплицировать форматирование и структуру. в этом случае декларативная разметка GridView и ObjectDataSource s должна выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="72ff2-233">Feel free to replicate this formatting and structure, in which case your GridView and ObjectDataSource s declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](caching-data-in-the-architecture-cs/samples/sample11.aspx)]

<span data-ttu-id="72ff2-234">На этом этапе у нас есть страница, использующая уровень кэширования.</span><span class="sxs-lookup"><span data-stu-id="72ff2-234">At this point we have a page that uses the Caching Layer.</span></span> <span data-ttu-id="72ff2-235">Чтобы увидеть, как выполняется кэширование, установите точки останова в `ProductsCL` классов `GetProducts()` и методах `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="72ff2-235">To see the cache in action, set breakpoints in the `ProductsCL` class s `GetProducts()` and `UpdateProduct` methods.</span></span> <span data-ttu-id="72ff2-236">Откройте страницу в браузере и пошаговым кодом при сортировке и разбиении на страницы, чтобы просмотреть данные, извлеченные из кэша.</span><span class="sxs-lookup"><span data-stu-id="72ff2-236">Visit the page in a browser and step through the code when sorting and paging in order to see the data pulled from the cache.</span></span> <span data-ttu-id="72ff2-237">Затем обновите запись и обратите внимание, что кэш становится недействительным и, следовательно, извлекается из BLL при повторной привязке данных к GridView.</span><span class="sxs-lookup"><span data-stu-id="72ff2-237">Then update a record and note that the cache is invalidated and, consequently, it is retrieved from the BLL when the data is rebound to the GridView.</span></span>

> [!NOTE]
> <span data-ttu-id="72ff2-238">Уровень кэширования, указанный в загружаемом файле, прилагаемом к этой статье, не является полным.</span><span class="sxs-lookup"><span data-stu-id="72ff2-238">The Caching Layer provided in the download accompanying this article is not complete.</span></span> <span data-ttu-id="72ff2-239">Он содержит только один класс, `ProductsCL`, который всего лишь несколько методов.</span><span class="sxs-lookup"><span data-stu-id="72ff2-239">It contains only one class, `ProductsCL`, which only sports a handful of methods.</span></span> <span data-ttu-id="72ff2-240">Более того, только одна страница ASP.NET использует CL (`~/Caching/FromTheArchitecture.aspx`) все остальные по-прежнему ссылаются на BLL напрямую.</span><span class="sxs-lookup"><span data-stu-id="72ff2-240">Moreover, only a single ASP.NET page uses the CL (`~/Caching/FromTheArchitecture.aspx`) all others still reference the BLL directly.</span></span> <span data-ttu-id="72ff2-241">Если вы планируете использовать в приложении CL-компилятор, все вызовы из уровня представления должны переключиться на CL, что потребует, чтобы классы и методы CL-компилятора сосмотрели эти классы и методы в BLL, который в настоящее время используется уровнем представления данных.</span><span class="sxs-lookup"><span data-stu-id="72ff2-241">If you plan on using a CL in your application, all calls from the Presentation Layer should go to the CL, which would require that the CL s classes and methods covered those classes and methods in the BLL currently used by the Presentation Layer.</span></span>

## <a name="summary"></a><span data-ttu-id="72ff2-242">Сводка</span><span class="sxs-lookup"><span data-stu-id="72ff2-242">Summary</span></span>

<span data-ttu-id="72ff2-243">Хотя кэширование можно применять на уровне представления с ASP.NET 2,0 s SqlDataSource и элементами управления ObjectDataSource, в идеале обязанности кэширования будут делегированы на отдельный слой в архитектуре.</span><span class="sxs-lookup"><span data-stu-id="72ff2-243">While caching can be applied at the Presentation Layer with ASP.NET 2.0 s SqlDataSource and ObjectDataSource controls, ideally caching responsibilities would be delegated to a separate layer in the architecture.</span></span> <span data-ttu-id="72ff2-244">В этом руководстве мы создали слой кэширования, который находится между уровнем представления и уровнем бизнес-логики.</span><span class="sxs-lookup"><span data-stu-id="72ff2-244">In this tutorial we created a Caching Layer that resides between the Presentation Layer and the Business Logic Layer.</span></span> <span data-ttu-id="72ff2-245">Уровень кэширования должен предоставлять тот же набор классов и методов, которые существуют в BLL и вызываются из уровня представления данных.</span><span class="sxs-lookup"><span data-stu-id="72ff2-245">The Caching Layer needs to provide the same set of classes and methods that exist in the BLL and are called from the Presentation Layer.</span></span>

<span data-ttu-id="72ff2-246">Примеры уровней кэширования, рассмотренные в этом и предыдущих руководствах, демонстрирующие *перезагрузку*.</span><span class="sxs-lookup"><span data-stu-id="72ff2-246">The Caching Layer examples we explored in this and the preceding tutorials exhibited *reactive loading*.</span></span> <span data-ttu-id="72ff2-247">При использовании реактивной загрузки данные загружаются в кэш только при запросе данных и отсутствии данных в кэше.</span><span class="sxs-lookup"><span data-stu-id="72ff2-247">With reactive loading, the data is loaded into the cache only when a request for the data is made and that data is missing from the cache.</span></span> <span data-ttu-id="72ff2-248">Данные также можно *заранее загрузить* в кэш — метод, который загружает данные в кэш до того, как он действительно нужен.</span><span class="sxs-lookup"><span data-stu-id="72ff2-248">Data can also be *proactively loaded* into the cache, a technique that loads the data into the cache before it is actually needed.</span></span> <span data-ttu-id="72ff2-249">В следующем учебном курсе мы рассмотрим пример упреждающего загрузки, когда мы рассмотрим, как хранить статические значения в кэше при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="72ff2-249">In the next tutorial we'll see an example of proactive loading when we look at how to store static values into the cache at application startup.</span></span>

<span data-ttu-id="72ff2-250">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="72ff2-250">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="72ff2-251">Об авторе</span><span class="sxs-lookup"><span data-stu-id="72ff2-251">About the Author</span></span>

<span data-ttu-id="72ff2-252">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998.</span><span class="sxs-lookup"><span data-stu-id="72ff2-252">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="72ff2-253">Скотт работает как независимый консультант, преподаватель и модуль записи.</span><span class="sxs-lookup"><span data-stu-id="72ff2-253">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="72ff2-254">Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="72ff2-254">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="72ff2-255">Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="72ff2-255">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="72ff2-256">или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="72ff2-256">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="72ff2-257">Специальная благодарность</span><span class="sxs-lookup"><span data-stu-id="72ff2-257">Special Thanks To</span></span>

<span data-ttu-id="72ff2-258">Эта серия руководств была рассмотрена многими полезными рецензентами.</span><span class="sxs-lookup"><span data-stu-id="72ff2-258">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="72ff2-259">Специалист по интересу для этого руководства был Терезой Мурф.</span><span class="sxs-lookup"><span data-stu-id="72ff2-259">Lead reviewer for this tutorial was Teresa Murph.</span></span> <span data-ttu-id="72ff2-260">Хотите ознакомиться с моими будущими статьями MSDN?</span><span class="sxs-lookup"><span data-stu-id="72ff2-260">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="72ff2-261">Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="72ff2-261">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="72ff2-262">[Назад](caching-data-with-the-objectdatasource-cs.md)
> [Вперед](caching-data-at-application-startup-cs.md)</span><span class="sxs-lookup"><span data-stu-id="72ff2-262">[Previous](caching-data-with-the-objectdatasource-cs.md)
[Next](caching-data-at-application-startup-cs.md)</span></span>
