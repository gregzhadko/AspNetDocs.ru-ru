---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
title: Использование зависимостей кэша SQL (C#) | Документация Майкрософт
author: rick-anderson
description: Простейшая стратегия кэширования заключается в том, чтобы разрешить срок действия кэшированных данных по истечении указанного периода времени. Но такой простой подход означает, что кэшированные данные маинтаи...
ms.author: riande
ms.date: 05/30/2007
ms.assetid: 0e91842c-7f10-4aed-8c23-4ee3e2774014
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
msc.type: authoredcontent
ms.openlocfilehash: 5bc27a08e39606c25b8f99d6ea057d2a853f08a6
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74611959"
---
# <a name="using-sql-cache-dependencies-c"></a>Использование зависимостей кэша SQL (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip) или [скачать PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)

> Простейшая стратегия кэширования заключается в том, чтобы разрешить срок действия кэшированных данных по истечении указанного периода времени. Но такой простой подход означает, что кэшированные данные не поддерживают связь с базовым источником данных, что приведет к нехватке слишком длинных данных или текущих данных, срок действия которых истечет слишком долго. Лучшим подходом является использование класса SqlCacheDependency, чтобы данные оставались в кэше до тех пор, пока их базовые данные не будут изменены в базе данных SQL. В этом руководстве показано, как это делать.

## <a name="introduction"></a>Введение

Методы кэширования, проверенные в [данных кэширования с помощью ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) и [кэширование данных в учебниках по архитектуре](caching-data-in-the-architecture-cs.md) использовали время истечения срока действия для исключения данных из кэша за указанный период. Этот подход является самым простым способом сбалансировать рост производительности при кэшировании относительно устаревания данных. Если выбрать срок действия, равный *x* секундам, то разработчик страницы попытается воспользоваться преимуществами производительности кэширования только для *x* секунд, но может легко работать, чтобы его данные никогда не устаревают дольше, чем максимум *x* секунд. Разумеется, для статических данных *x* можно расширить до времени существования веб-приложения, как было описано в руководстве по [кэшированию данных при запуске приложения](caching-data-at-application-startup-cs.md) .

При кэшировании данных базы данных часто выбирается срок действия, основанный на времени, но зачастую это недостаточное решение. В идеале данные базы данных останутся в кэше до тех пор, пока базовые данные не будут изменены в базе данных. только после этого кэш будет удален. Такой подход позволяет повысить производительность кэширования и снизит продолжительность устаревших данных. Однако, чтобы воспользоваться этими преимуществами, необходимо иметь некоторую систему, которая знает, когда изменяются данные базовой базы данных, и удаляет соответствующие элементы из кэша. До ASP.NET 2,0 разработчики страниц отвечали за реализацию этой системы.

ASP.NET 2,0 предоставляет [класс`SqlCacheDependency`](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) и необходимую инфраструктуру, чтобы определить, когда в базе данных произошло изменение, чтобы можно было удалить соответствующие кэшированные элементы. Существует два способа определения факта изменения базовых данных: уведомления и опроса. После рассмотрения различий между уведомлениями и опросами мы создадим инфраструктуру, необходимую для поддержки опросов, а затем покажем, как использовать класс `SqlCacheDependency` в декларативных и программных сценариях.

## <a name="understanding-notification-and-polling"></a>Общие сведения о уведомлениях и опросах

Существует два способа, с помощью которых можно определить, когда изменились данные в базе данных: уведомление и опрос. При использовании уведомления база данных автоматически оповещает среду выполнения ASP.NET о том, что результаты определенного запроса были изменены с момента последнего выполнения запроса, после чего кэшированные элементы, связанные с запросом, будут вытеснены. При опросе сервер базы данных хранит сведения о времени последнего обновления определенных таблиц. Среда выполнения ASP.NET периодически опрашивает базу данных, чтобы проверить, какие таблицы изменились со времени их входа в кэш. Эти таблицы, данные которых были изменены, были исключены из связанных элементов кэша.

Параметр уведомления требует меньшей настройки, чем опрос, и более детализирован, так как он отслеживает изменения на уровне запроса, а не на уровне таблицы. К сожалению, уведомления доступны только в полных выпусках Microsoft SQL Server 2005 (т. е. выпусков, отличных от Express). Однако параметр опроса можно использовать для всех версий Microsoft SQL Server от 7,0 до 2005. Поскольку в этих учебниках используется выпуск Express SQL Server 2005, мы рассмотрим настройку и использование параметра опроса. Дополнительные сведения о возможностях уведомления SQL Server 2005 s см. в разделе, посвященном дальнейшим материалам в конце этого руководства.

При опросе база данных должна быть настроена для включения таблицы с именем `AspNet_SqlCacheTablesForChangeNotification` с тремя столбцами — `tableName`, `notificationCreated`и `changeId`. Эта таблица содержит по одной строке для каждой таблицы, содержащей данные, которые могут потребоваться для использования в зависимости от кэша SQL в веб-приложении. Столбец `tableName` указывает имя таблицы, а `notificationCreated` указывает дату и время добавления строки в таблицу. Столбец `changeId` имеет тип `int` и начальное значение 0. Его значение увеличивается при каждом изменении таблицы.

Помимо таблицы `AspNet_SqlCacheTablesForChangeNotification`, база данных также должна включать триггеры в каждую из таблиц, которые могут появиться в зависимости кэша SQL. Эти триггеры выполняются при каждой вставке, обновлении или удалении строки, а также при увеличении `changeId` значения таблицы в `AspNet_SqlCacheTablesForChangeNotification`.

Среда выполнения ASP.NET отслеживает текущую `changeId` для таблицы при кэшировании данных с помощью объекта `SqlCacheDependency`. База данных периодически проверяется, и все объекты `SqlCacheDependency`, чьи `changeId` отличается от значения в базе данных, удаляются, так как разное значение `changeId` указывает на то, что в таблицу внесено изменение, так как данные были кэшированы.

## <a name="step-1-exploring-theaspnet_regsqlexecommand-line-program"></a>Шаг 1. изучение программы командной строки`aspnet_regsql.exe`

При подходе опроса база данных должна быть настроена для хранения описанной выше инфраструктуры: Предопределенная таблица (`AspNet_SqlCacheTablesForChangeNotification`), несколько хранимых процедур и триггеров в каждой из таблиц, которые могут использоваться в зависимостях кэша SQL в веб-приложении. Эти таблицы, хранимые процедуры и триггеры можно создавать с помощью программы командной строки `aspnet_regsql.exe`, которая находится в папке `$WINDOWS$\Microsoft.NET\Framework\version`. Чтобы создать таблицу `AspNet_SqlCacheTablesForChangeNotification` и связанные с ней хранимые процедуры, выполните в командной строке следующую команду:

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample1.cmd)]

> [!NOTE]
> Для выполнения этих команд указанное имя входа базы данных должно входить в роли [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) и [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) . Чтобы изучить T-SQL, отправленный в базу данных с помощью программы командной строки `aspnet_regsql.exe`, обратитесь к [этой записи блога](http://scottonwriting.net/sowblog/posts/10709.aspx).

Например, чтобы добавить инфраструктуру для опроса в базу данных Microsoft SQL Server с именем `pubs` на сервере базы данных с именем `ScottsServer` с использованием проверки подлинности Windows, перейдите в соответствующий каталог и в командной строке введите:

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample2.cmd)]

После добавления инфраструктуры уровня базы данных необходимо добавить триггеры в таблицы, которые будут использоваться в зависимостях кэша SQL. Снова используйте `aspnet_regsql.exe` программу командной строки, но укажите имя таблицы с помощью параметра `-t` и вместо использования параметра `-ed` используйте `-et`, например так:

[!code-html[Main](using-sql-cache-dependencies-cs/samples/sample3.html)]

Чтобы добавить триггеры в `authors` и `titles` таблицы в базе данных `pubs` на `ScottsServer`, используйте:

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample4.cmd)]

В рамках этого руководства добавьте триггеры в таблицы `Products`, `Categories`и `Suppliers`. Мы рассмотрим определенный синтаксис командной строки на шаге 3.

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inapp_data"></a>Шаг 2. Создание ссылки на базу данных Microsoft SQL Server 2005 Express Edition в`App_Data`

Программе командной строки `aspnet_regsql.exe` требуется имя базы данных и сервера, чтобы добавить необходимую инфраструктуру опроса. Но что такое имя базы данных и сервера для базы данных Microsoft SQL Server 2005 Express, расположенной в папке `App_Data`? Вместо того, чтобы обнаруживать имена баз данных и серверов, я нашел, что самый простой подход заключается в присоединении базы данных к экземпляру базы данных `localhost\SQLExpress` и переименовании данных с помощью [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx). Если на вашем компьютере установлена одна из полных версий SQL Server 2005, вероятно, на компьютере уже установлены SQL Server Management Studio. Если у вас только Экспресс выпуски, можно скачать бесплатную [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).

Для начала Закройте Visual Studio. Затем откройте SQL Server Management Studio и выберите подключение к серверу `localhost\SQLExpress` с помощью проверки подлинности Windows.

![Присоединение к серверу Локалхост\склекспресс](using-sql-cache-dependencies-cs/_static/image1.gif)

**Рис. 1**. подключение к серверу `localhost\SQLExpress`

После подключения к серверу Management Studio покажет сервер и получит вложенные папки для баз данных, безопасности и т. д. Щелкните правой кнопкой мыши папку базы данных и выберите пункт Присоединить. Откроется диалоговое окно Присоединение баз данных (см. рис. 2). Нажмите кнопку Добавить и выберите папку базы данных `NORTHWND.MDF` в папке `App_Data` веб-приложения.

[![присоединить НОРСВНД. База данных MDF из папки App_Data](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)

**Рис. 2**. Подключение базы данных `NORTHWND.MDF` из папки `App_Data` ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image2.png))

Это приведет к добавлению базы данных в папку Databases. Имя базы данных может быть полным путем к файлу базы данных или полным путем в начале [идентификатора GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier). Чтобы не вводить это длинное имя базы данных при использовании программы командной строки ASPNET\_регскл. exe, переименуйте базу данных в более удобное имя, щелкнув правой кнопкой мыши только что подключенную базу данных и выбрав команду Переименовать. Я переименовал мою базу данных в учебные пособия.

![Переименование присоединенной базы данных на более удобное имя](using-sql-cache-dependencies-cs/_static/image3.gif)

**Рис. 3**. Переименование присоединенной базы данных на более удобное для человека имя

## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a>Шаг 3. Добавление инфраструктуры опроса в базу данных Northwind

Теперь, когда вы присоединяете базу данных `NORTHWND.MDF` из папки `App_Data`, мы повторно готовы добавить инфраструктуру опроса. Если база данных была переименована в учебные пособия, выполните следующие четыре команды:

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample5.cmd)]

После выполнения этих четырех команд щелкните правой кнопкой мыши имя базы данных в Management Studio, перейдите в подменю задачи и выберите Отсоединить. Затем закройте Management Studio и снова откройте Visual Studio.

После повторного открытия Visual Studio выполните детализацию базы данных с помощью обозреватель сервера. Обратите внимание на новую таблицу (`AspNet_SqlCacheTablesForChangeNotification`), новые хранимые процедуры и триггеры в таблицах `Products`, `Categories`и `Suppliers`.

![Теперь база данных включает необходимую инфраструктуру опроса](using-sql-cache-dependencies-cs/_static/image4.gif)

**Рис. 4**. Теперь база данных включает необходимую инфраструктуру опроса

## <a name="step-4-configuring-the-polling-service"></a>Шаг 4. Настройка службы опроса

После создания необходимых таблиц, триггеров и хранимых процедур в базе данных последним шагом является настройка службы опроса, которая выполняется с помощью `Web.config` путем указания используемых баз данных и частоты опроса в миллисекундах. Следующая разметка опрашивает базу данных Northwind каждую секунду.

[!code-xml[Main](using-sql-cache-dependencies-cs/samples/sample6.xml)]

Значение `name` в элементе `<add>` (Норсвинддб) связывает понятное имя с определенной базой данных. При работе с зависимостями кэша SQL необходимо ссылаться на имя базы данных, определенную здесь, а также на таблицу, на которой основаны кэшированные данные. Мы посмотрим, как использовать класс `SqlCacheDependency` для программного связывания зависимостей кэша SQL с кэшированными данными на шаге 6.

После установки зависимости кэша SQL система опроса будет подключаться к базам данных, определенным в `<databases>` элементов, каждые `pollTime` миллисекунд и выполняя `AspNet_SqlCachePollingStoredProcedure` хранимую процедуру. Эта хранимая процедура, добавленная на шаге 3 с помощью средства командной строки `aspnet_regsql.exe`, возвращает `tableName` и `changeId` значения для каждой записи в `AspNet_SqlCacheTablesForChangeNotification`. Устаревшие зависимости кэша SQL исключены из кэша.

Параметр `pollTime` представляет компромисс между производительностью и устареваниями данных. Небольшое `pollTime` значение увеличивает количество запросов к базе данных, но быстрее удаляет устаревшие данные из кэша. Большее `pollTime` значение сокращает количество запросов к базе данных, но увеличивает задержку между изменением серверных данных и моментом удаления связанных элементов кэша. К счастью, запрос к базе данных исполняет простую хранимую процедуру, которая возвращает всего несколько строк из простой, облегченной таблицы. Но экспериментируйте с различными `pollTime`ными значениями, чтобы найти идеальный баланс между доступом к базе данных и устаревания данных для приложения. Наименьшее допустимое значение `pollTime` — 500.

> [!NOTE]
> Приведенный выше пример предоставляет одно `pollTime`ое значение в элементе `<sqlCacheDependency>`, но при необходимости можно указать `pollTime` значение в элементе `<add>`. Это полезно, если указано несколько баз данных и требуется настроить частоту опроса для каждой базы данных.

## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a>Шаг 5. декларативная работа с зависимостями кэша SQL

В шагах с 1 по 4 мы рассматривали настройку необходимой инфраструктуры базы данных и настройку системы опроса. После этой инфраструктуры мы можем добавлять элементы в кэш данных с помощью связанной с ним зависимости кэша SQL, используя программные или декларативные методы. На этом этапе мы рассмотрим декларативную работу с зависимостями кэша SQL. На шаге 6 мы рассмотрим программный подход.

[Данные кэширования с руководством по ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) изучили возможности декларативного кэширования элемента управления ObjectDataSource. Просто присвоив свойству `EnableCaching` значение `true` а свойству `CacheDuration` — некоторый интервал времени, элемент управления ObjectDataSource автоматически кэширует данные, возвращенные из его базового объекта за указанный интервал. ObjectDataSource также может использовать одну или несколько зависимостей кэша SQL.

Чтобы продемонстрировать использование зависимостей кэша SQL декларативно, откройте страницу `SqlCacheDependencies.aspx` в папке `Caching` и перетащите элемент управления GridView с панели инструментов в конструктор. Установите `ID` GridView s `ProductsDeclarative` и, выбрав его смарт-тег, привяжите его к новому ObjectDataSource с именем `ProductsDataSourceDeclarative`.

[![создать новый элемент управления ObjectDataSource с именем Продуктсдатасаурцедекларативе](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)

**Рис. 5**. Создание нового элемента управления ObjectDataSource с именем `ProductsDataSourceDeclarative` ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image4.png))

Настройте ObjectDataSource для использования класса `ProductsBLL` и задайте для раскрывающегося списка на вкладке Выбор значение `GetProducts()`. На вкладке обновление выберите перегрузку `UpdateProduct` с тремя входными параметрами: `productName`, `unitPrice`и `productID`. Установите в раскрывающихся списках значение (нет) на вкладках Вставка и удаление.

[![использовать перегрузку UpdateProduct с тремя входными параметрами](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)

**Рис. 6**. использование перегрузки UpdateProduct с тремя входными параметрами ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image6.png))

[![установить в раскрывающемся списке значение (нет) для вкладок вставки и удаления](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)

**Рис. 7**. Установка в раскрывающемся списке значения (нет) для вкладок вставки и удаления ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image8.png))

После завершения работы мастера настройки источника данных Visual Studio создаст BoundFields и Чеккбоксфиелдс в GridView для каждого поля данных. Удалите все поля, но `ProductName`, `CategoryName`и `UnitPrice`и отформатируйте эти поля по своему усмотрению. В смарт-теге GridView s установите флажки Включить постраничный просмотр, включить сортировку и включить редактирование. Visual Studio задаст свойству `OldValuesParameterFormatString` ObjectDataSource s значение `original_{0}`. Чтобы функция редактирования GridView s работала правильно, либо удалите это свойство из декларативного синтаксиса, либо присвойте ему значение по умолчанию `{0}`.

Наконец, добавьте веб-элемент управления Label над элементом GridView и задайте для его свойства `ID` значение `ODSEvents` а свойству `EnableViewState` — значение `false`. После внесения этих изменений декларативная разметка страницы должна выглядеть следующим образом. Обратите внимание, что я внес ряд настроек Aesthetic в поля GridView, которые не требуются для демонстрации функций зависимости кэша SQL.

[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample7.aspx)]

Затем создайте обработчик событий для события `Selecting` ObjectDataSource s и добавьте в него следующий код:

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample8.cs)]

Помните, что событие ObjectDataSource `Selecting` срабатывает только при извлечении данных из базового объекта. Если элемент управления ObjectDataSource обращается к данным из своего кэша, это событие не срабатывает.

Теперь посетите эту страницу в браузере. Так как мы еще не работаем над реализацией любого кэширования, каждый раз при отправке страницы, сортировке или изменении сетки страница должна отображать текст, выбрав событие запущено, как показано на рис. 8.

[![событие выбора ObjectDataSource, которое срабатывает при каждом постраничном, измененном или упорядоченном элементе управления GridView](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)

**Рис. 8**. событие ObjectDataSource `Selecting` возникает каждый раз при просмотре, изменении или сортировке элемента управления GridView ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image10.png))

Как было показано в статье [кэширование данных с помощью элемента управления ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) , установка свойства `EnableCaching` в значение `true` приводит к кэшированию данных ObjectDataSource в течение времени, указанного свойством `CacheDuration`. ObjectDataSource также имеет [свойство`SqlCacheDependency`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), которое добавляет один или несколько зависимостей кэша SQL в кэшированные данные с помощью шаблона:

[!code-css[Main](using-sql-cache-dependencies-cs/samples/sample9.css)]

Где *DatabaseName* — это имя базы данных, указанное в атрибуте `name` элемента `<add>` в `Web.config`, а *TableName* — это имя таблицы базы данных. Например, чтобы создать элемент управления ObjectDataSource, который кэширует данные на неопределенное время на основе зависимости кэша SQL от `Products` таблицы Northwind s, установите свойство ObjectDataSource `EnableCaching` в значение `true`, а его свойство `SqlCacheDependency` — в Норсвинддб: Products.

> [!NOTE]
> Можно использовать зависимость кэша SQL *и* срок действия, основанный на времени, установив для параметра `EnableCaching` значение `true`, `CacheDuration` интервал времени и `SqlCacheDependency` в базу данных и имена таблиц. Элемент управления ObjectDataSource будет исключать свои данные по истечении времени окончания срока действия или когда система опроса запишет, что изменились данные базовой базы данных, в зависимости от того, что произойдет раньше.

GridView в `SqlCacheDependencies.aspx` отображает данные из двух таблиц — `Products` и `Categories` (поле Product `CategoryName` извлекается через `JOIN` `Categories`). Поэтому мы хотим указать две зависимости кэша SQL: Норсвинддб: Products; Норсвинддб: категории.

[![настроить ObjectDataSource для поддержки кэширования с использованием зависимостей кэша SQL для продуктов и категорий](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)

**Рис. 9**. Настройка ObjectDataSource для поддержки кэширования с использованием зависимостей кэша SQL для `Products` и `Categories` ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image12.png))

После настройки ObjectDataSource для поддержки кэширования перейдите на страницу через браузер. Опять же, событие, выбранное при нажатии клавиши, должно появиться на первой странице, но при разбиении на страницы, сортировке или нажатии кнопки Правка или Отмена. Это происходит потому, что после загрузки данных в кэш ObjectDataSource s он остается там до тех пор, пока не изменяются `Products` или `Categories` таблицы или не обновляются данные с помощью GridView.

После разбивки по сетке и указания на отсутствие текста, выданного при выборе события, откройте новое окно браузера и перейдите к учебнику основные сведения в разделе Редактирование, вставка и удаление (`~/EditInsertDelete/Basics.aspx`). Обновите имя или цену продукта. Затем в первом окне браузера просмотрите другую страницу данных, отсортируйте сетку или нажмите кнопку изменить строку. На этот раз при изменении данных базовой базы данных (см. рис. 10) должно отобразиться событие выбора. Если текст не отображается, подождите несколько секунд и повторите попытку. Помните, что служба опроса проверяет наличие изменений в таблице `Products` каждые `pollTime` миллисекунд, поэтому между обновлением базовых данных и временем удаления кэшированных данных возникает задержка.

[![изменении таблицы Products исключает кэшированные данные о продуктах](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)

**Рис. 10**. изменение таблицы "продукты" исключает кэшированные данные продукта ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image14.png))

## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a>Шаг 6. Программная работа с классом`SqlCacheDependency`

[Сведения о кэшировании в руководстве по архитектуре](caching-data-in-the-architecture-cs.md) рассмотрели преимущества использования отдельного слоя кэширования в архитектуре, в отличие от тесного связывания кэширования с ObjectDataSource. В этом учебнике мы создали класс `ProductsCL`, чтобы продемонстрировать программную работу с кэшем данных. Чтобы использовать зависимости кэша SQL на уровне кэширования, используйте класс `SqlCacheDependency`.

В системе опроса объект `SqlCacheDependency` должен быть связан с определенной базой данных и парой таблиц. Следующий код, например, создает объект `SqlCacheDependency`, основанный на `Products` таблице базы данных Northwind:

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample10.cs)]

Два входных параметра для конструктора `SqlCacheDependency` s — это имена базы данных и таблицы соответственно. Как и при использовании свойства ObjectDataSource `SqlCacheDependency`, имя базы данных совпадает со значением, указанным в атрибуте `name` элемента `<add>` в `Web.config`. Имя таблицы — это фактическое имя таблицы базы данных.

Чтобы связать `SqlCacheDependency` с элементом, добавленным в кэш данных, используйте одну из перегрузок метода `Insert`, которая принимает зависимость. Следующий код добавляет *значение* в кэш данных в течение неопределенной длительности, но связывает его с `SqlCacheDependency`ом в таблице `Products`. Вкратце, *значение* останется в кэше до тех пор, пока оно не будет исключено из-за ограничений памяти или если система опроса обнаружила, что `Products` таблица изменилась с момента кэширования.

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample11.cs)]

В настоящее время класс `ProductsCL` уровня кэширования кэширует данные из `Products` таблицы, используя срок действия в 60 секунд, основанный на времени. Разрешите обновить этот класс, чтобы вместо него использовать зависимости кэша SQL. Метод `ProductsCL` классов `AddCacheItem`, который отвечает за добавление данных в кэш, в настоящее время содержит следующий код:

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample12.cs)]

Обновите этот код, чтобы использовать `SqlCacheDependency` объект вместо зависимости кэша `MasterCacheKeyArray`:

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample13.cs)]

Чтобы протестировать эту функцию, добавьте GridView на страницу под существующим `ProductsDeclarative` GridView. Установите этот новый `ID` GridView s в `ProductsProgrammatic` и, через свой смарт-тег, привяжите его к новому ObjectDataSource с именем `ProductsDataSourceProgrammatic`. Настройте ObjectDataSource для использования класса `ProductsCL`, установив раскрывающиеся списки на вкладках выбор и обновление для `GetProducts` и `UpdateProduct`соответственно.

[![настроить ObjectDataSource для использования класса Продуктскл](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)

**Рис. 11**. Настройка ObjectDataSource для использования класса `ProductsCL` ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image16.png))

[![выбрать метод Products из раскрывающегося списка SELECT Tab s](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)

**Рис. 12**. выбор метода `GetProducts` из раскрывающегося списка SELECT Tab ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image18.png))

[![выберите метод UpdateProduct из раскрывающегося списка вкладка обновления.](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)

**Рис. 13**. Выбор метода UpdateProduct из раскрывающегося списка вкладок обновления ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image20.png))

После завершения работы мастера настройки источника данных Visual Studio создаст BoundFields и Чеккбоксфиелдс в GridView для каждого поля данных. Как и в первом элементе GridView, добавленном на эту страницу, удалите все поля, но `ProductName`, `CategoryName`и `UnitPrice`и отформатируйте эти поля по своему усмотрению. В смарт-теге GridView s установите флажки Включить постраничный просмотр, включить сортировку и включить редактирование. Как и в случае с `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio задаст свойству `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` значение `original_{0}`. Чтобы функция редактирования GridView s работала правильно, присвойте этому свойству значение `{0}` (или полностью удалите из декларативного синтаксиса назначение свойства).

После выполнения этих задач результирующая декларативная разметка GridView и ObjectDataSource должна выглядеть следующим образом:

[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample14.aspx)]

Чтобы проверить зависимость кэша SQL в слое кэширования, установите точку останова в методе `ProductCL` Class s `AddCacheItem` и запустите отладку. При первом посещении `SqlCacheDependencies.aspx`точка останова должна быть достигнута, так как данные запрашиваются в первый раз и помещаются в кэш. Затем перейдите на другую страницу в GridView или отсортируйте один из столбцов. Это приводит к тому, что GridView записывает свои данные, но данные должны быть найдены в кэше, так как таблица базы данных `Products` не была изменена. Если данные в кэше постоянно не найдены, убедитесь, что на компьютере достаточно памяти, и повторите попытку.

После разбиения по страницам на нескольких страницах GridView откройте второе окно браузера и перейдите к руководству по основам в разделе Редактирование, вставка и удаление (`~/EditInsertDelete/Basics.aspx`). Обновите запись из таблицы Products, а затем в первом окне браузера просмотрите новую страницу или щелкните одну из заголовков сортировки.

В этом сценарии вы увидите одно из двух действий: будет достигнута точка останова, указывающая, что кэшированные данные были исключены из-за изменения в базе данных. или точка останова не будет нажата, а это означает, что в `SqlCacheDependencies.aspx` теперь отображаются устаревшие данные. Если точка останова не достигается, вероятно, это вызвано тем, что служба опроса еще не активировалась с момента изменения данных. Помните, что служба опроса проверяет наличие изменений в таблице `Products` каждые `pollTime` миллисекунд, поэтому между обновлением базовых данных и временем удаления кэшированных данных возникает задержка.

> [!NOTE]
> Эта задержка больше всего появляется при редактировании одного из продуктов с помощью GridView в `SqlCacheDependencies.aspx`. В ходе [кэширования данных в руководстве по архитектуре](caching-data-in-the-architecture-cs.md) мы добавили зависимость кэша `MasterCacheKeyArray`, чтобы убедиться, что данные, изменяемые с помощью метода `ProductsCL` класса `UpdateProduct`, были исключены из кэша. Однако мы заменили эту зависимость кэша при изменении метода `AddCacheItem` ранее в этом шаге, и поэтому класс `ProductsCL` будет по прежнему отображать кэшированные данные до тех пор, пока система опроса не запишет изменения в таблицу `Products`. Мы посмотрим, как повторно ввести зависимость кэша `MasterCacheKeyArray` на шаге 7.

## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a>Шаг 7. Связывание нескольких зависимостей с кэшированным элементом

Помните, что зависимость кэша `MasterCacheKeyArray` используется, чтобы гарантировать, что *все* связанные с продуктом данные будут исключены из кэша при обновлении одного элемента, связанного в нем. Например, метод `GetProductsByCategoryID(categoryID)` кэширует `ProductsDataTables` экземпляры для каждого уникального значения *CategoryID* . Если один из этих объектов исключен, то зависимость кэша `MasterCacheKeyArray` гарантирует, что другие также будут удалены. Без этой зависимости кэша при изменении кэшированных данных возможна вероятность того, что другие кэшированные данные продукта могут устареть. Следовательно, важно поддерживать зависимость кэша `MasterCacheKeyArray` при использовании зависимостей кэша SQL. Однако метод `Insert` кэша данных поддерживает только один объект зависимости.

Кроме того, при работе с зависимостями кэша SQL может потребоваться связать несколько таблиц базы данных как зависимости. Например, `ProductsDataTable`, кэшированные в классе `ProductsCL`, содержат имена категорий и поставщиков для каждого продукта, но метод `AddCacheItem` использует только зависимость от `Products`. В этом случае, если пользователь обновляет имя категории или поставщика, кэшированные данные продукта будут оставаться в кэше и устареть. Поэтому мы хотим, чтобы кэшированные данные продуктов зависели не только от `Products` таблицы, но и `Categories` и `Suppliers`ных таблиц.

[Класс`AggregateCacheDependency`](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) предоставляет средства для связывания нескольких зависимостей с элементом кэша. Начните с создания экземпляра `AggregateCacheDependency`. Затем добавьте набор зависимостей с помощью метода `Add` `AggregateCacheDependency` s. После этого при вставке элемента в кэш данных передается экземпляр `AggregateCacheDependency`. При изменении зависимостей *любого* `AggregateCacheDependency` экземпляра кэшированный элемент будет удален.

Ниже показан обновленный код для метода `AddCacheItem` `ProductsCL` класса. Метод создает зависимость кэша `MasterCacheKeyArray` вместе с объектами `SqlCacheDependency` для таблиц `Products`, `Categories`и `Suppliers`. Все они объединены в один объект `AggregateCacheDependency` с именем `aggregateDependencies`, который затем передается в метод `Insert`.

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample15.cs)]

Протестируйте этот новый код. Теперь изменения в таблицах `Products`, `Categories`или `Suppliers` приводят к удалению кэшированных данных. Более того, метод `ProductsCL` классов `UpdateProduct`, который вызывается при редактировании продукта через GridView, удаляет зависимость кэша `MasterCacheKeyArray`, что приводит к удалению кэшированных `ProductsDataTable` и повторному получению данных при следующем запросе.

> [!NOTE]
> Зависимости кэша SQL также можно использовать с [кэшированием выходных данных](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx). Демонстрацию этой функции см. в разделе [Использование кэширования вывода ASP.NET с SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).

## <a name="summary"></a>Сводка

При кэшировании данных базы данных оптимальные данные остаются в кэше до тех пор, пока они не будут изменены в базе данных. С помощью ASP.NET 2,0 зависимости кэша SQL можно создавать и использовать как в декларативных, так и в программных сценариях. Одна из проблем с этим подходом заключается в обнаружении изменений данных. Полные версии Microsoft SQL Server 2005 предоставляют возможности уведомлений, которые могут оповещать приложение при изменении результата запроса. Для выпуска Express версии SQL Server 2005 и более ранних версий SQL Server вместо нее следует использовать систему опроса. К счастью, Настройка необходимой инфраструктуры опроса довольно проста.

Поздравляем с программированием!

## <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Использование уведомлений о запросах в Microsoft SQL Server 2005](https://msdn.microsoft.com/library/ms175110.aspx)
- [Создание уведомления о запросе](https://msdn.microsoft.com/library/ms188669.aspx)
- [Кэширование в ASP.NET с помощью класса `SqlCacheDependency`](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)
- [Средство регистрации SQL Server ASP.NET (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)
- [Общие сведения о `SqlCacheDependency`](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого руководства: Марко Ranges, Терезой Мерфи и Хилтон Гизнау. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](caching-data-at-application-startup-cs.md)
> [Вперед](caching-data-with-the-objectdatasource-vb.md)
