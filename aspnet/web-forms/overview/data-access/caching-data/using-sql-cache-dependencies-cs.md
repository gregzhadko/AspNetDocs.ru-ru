---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
title: Использование зависимостей кэша SQL (C#) | Документация Майкрософт
author: rick-anderson
description: Простейшая стратегия кэширования заключается в том, чтобы разрешить срок действия кэшированных данных по истечении указанного периода времени. Но такой простой подход означает, что кэшированные данные маинтаи...
ms.author: riande
ms.date: 05/30/2007
ms.assetid: 0e91842c-7f10-4aed-8c23-4ee3e2774014
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
msc.type: authoredcontent
ms.openlocfilehash: 6a039cdfb1da294744b92648386468f69193ae6b
ms.sourcegitcommit: 4e6d586faadbe4d9ef27122f86335ec9385134af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2020
ms.locfileid: "89045264"
---
# <a name="using-sql-cache-dependencies-c"></a>Использование зависимостей кэша SQL (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip) или [скачать PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)

> Простейшая стратегия кэширования заключается в том, чтобы разрешить срок действия кэшированных данных по истечении указанного периода времени. Но такой простой подход означает, что кэшированные данные не поддерживают связь с базовым источником данных, что приведет к нехватке слишком длинных данных или текущих данных, срок действия которых истечет слишком долго. Лучшим подходом является использование класса SqlCacheDependency, чтобы данные оставались в кэше до тех пор, пока их базовые данные не будут изменены в базе данных SQL. В этом руководстве показано, как это делать.

## <a name="introduction"></a>Введение

Методы кэширования, проверенные в [данных кэширования с помощью ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) и [кэширование данных в учебниках по архитектуре](caching-data-in-the-architecture-cs.md) использовали время истечения срока действия для исключения данных из кэша за указанный период. Этот подход является самым простым способом сбалансировать рост производительности при кэшировании относительно устаревания данных. Если выбрать срок действия, равный *x* секундам, то разработчик страницы попытается воспользоваться преимуществами производительности кэширования только для *x* секунд, но может легко работать, чтобы его данные никогда не устаревают дольше, чем максимум *x* секунд. Разумеется, для статических данных *x* можно расширить до времени существования веб-приложения, как было описано в руководстве по [кэшированию данных при запуске приложения](caching-data-at-application-startup-cs.md) .

При кэшировании данных базы данных часто выбирается срок действия, основанный на времени, но зачастую это недостаточное решение. В идеале данные базы данных останутся в кэше до тех пор, пока базовые данные не будут изменены в базе данных. только после этого кэш будет удален. Такой подход позволяет повысить производительность кэширования и снизит продолжительность устаревших данных. Однако, чтобы воспользоваться этими преимуществами, необходимо иметь некоторую систему, которая знает, когда изменяются данные базовой базы данных, и удаляет соответствующие элементы из кэша. До ASP.NET 2,0 разработчики страниц отвечали за реализацию этой системы.

ASP.NET 2,0 предоставляет [ `SqlCacheDependency` класс](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) и необходимую инфраструктуру, позволяющую определить, когда в базе данных произошло изменение, чтобы можно было удалить соответствующие кэшированные элементы. Существует два способа определения факта изменения базовых данных: уведомления и опроса. После обсуждения различий между уведомлениями и опросами мы создадим инфраструктуру, необходимую для поддержки опросов, а затем рассмотрим использование `SqlCacheDependency` класса в декларативных и программных сценариях.

## <a name="understanding-notification-and-polling"></a>Общие сведения о уведомлениях и опросах

Существует два способа, с помощью которых можно определить, когда изменились данные в базе данных: уведомление и опрос. При использовании уведомления база данных автоматически оповещает среду выполнения ASP.NET о том, что результаты определенного запроса были изменены с момента последнего выполнения запроса, после чего кэшированные элементы, связанные с запросом, будут вытеснены. При опросе сервер базы данных хранит сведения о времени последнего обновления определенных таблиц. Среда выполнения ASP.NET периодически опрашивает базу данных, чтобы проверить, какие таблицы изменились со времени их входа в кэш. Эти таблицы, данные которых были изменены, были исключены из связанных элементов кэша.

Параметр уведомления требует меньшей настройки, чем опрос, и более детализирован, так как он отслеживает изменения на уровне запроса, а не на уровне таблицы. К сожалению, уведомления доступны только в полных выпусках Microsoft SQL Server 2005 (т. е. выпусков, отличных от Express). Однако параметр опроса можно использовать для всех версий Microsoft SQL Server от 7,0 до 2005. Поскольку в этих учебниках используется выпуск Express SQL Server 2005, мы рассмотрим настройку и использование параметра опроса. Дополнительные сведения о возможностях уведомления SQL Server 2005 s см. в разделе, посвященном дальнейшим материалам в конце этого руководства.

При опросе база данных должна быть настроена для включения таблицы с именем, `AspNet_SqlCacheTablesForChangeNotification` которая имеет три столбца: `tableName` , `notificationCreated` и `changeId` . Эта таблица содержит по одной строке для каждой таблицы, содержащей данные, которые могут потребоваться для использования в зависимости от кэша SQL в веб-приложении. `tableName`Столбец указывает имя таблицы, а `notificationCreated` указывает дату и время добавления строки в таблицу. `changeId`Столбец имеет тип `int` и имеет начальное значение 0. Его значение увеличивается при каждом изменении таблицы.

Кроме `AspNet_SqlCacheTablesForChangeNotification` таблицы, база данных также должна включать триггеры в каждую из таблиц, которые могут появиться в зависимости кэша SQL. Эти триггеры выполняются при каждой вставке, обновлении или удалении строки и увеличивают значение таблицы s `changeId` в `AspNet_SqlCacheTablesForChangeNotification` .

Среда выполнения ASP.NET отслеживает текущий `changeId` объект для таблицы при кэшировании данных с помощью `SqlCacheDependency` объекта. База данных периодически проверяется, и все `SqlCacheDependency` объекты, `changeId` отличающиеся от значения в базе данных, удаляются, так как Разное `changeId` значение указывает на изменение таблицы с момента кэширования данных.

## <a name="step-1-exploring-theaspnet_regsqlexecommand-line-program"></a>Шаг 1. изучение `aspnet_regsql.exe` программы командной строки

При подходе опроса база данных должна быть настроена для хранения описанной выше инфраструктуры: Предопределенная таблица ( `AspNet_SqlCacheTablesForChangeNotification` ), несколько хранимых процедур и триггеров в каждой из таблиц, которые могут использоваться в зависимостях кэша SQL в веб-приложении. Эти таблицы, хранимые процедуры и триггеры можно создавать с помощью программы командной строки `aspnet_regsql.exe` , которая находится в `$WINDOWS$\Microsoft.NET\Framework\version` папке. Чтобы создать `AspNet_SqlCacheTablesForChangeNotification` таблицу и связанные с ней хранимые процедуры, выполните в командной строке следующую команду:

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample1.cmd)]

> [!NOTE]
> Для выполнения этих команд указанное имя входа базы данных должно находиться в [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) ролях и. Сведения о проверке T-SQL, отправленной в базу данных `aspnet_regsql.exe` программой командной строки, см. в [этой записи блога](http://scottonwriting.net/sowblog/posts/10709.aspx).

Например, чтобы добавить инфраструктуру для опроса в Microsoft SQL Server базу данных `pubs` на сервере базы данных с именем `ScottsServer` с помощью проверки подлинности Windows, перейдите в соответствующий каталог и в командной строке введите:

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample2.cmd)]

После добавления инфраструктуры уровня базы данных необходимо добавить триггеры в таблицы, которые будут использоваться в зависимостях кэша SQL. Снова используйте `aspnet_regsql.exe` программу командной строки, но укажите имя таблицы с помощью `-t` параметра и вместо использования `-ed` параметра используйте `-et` , например:

[!code-html[Main](using-sql-cache-dependencies-cs/samples/sample3.html)]

Чтобы добавить триггеры в `authors` таблицы и `titles` в `pubs` базе данных в `ScottsServer` , используйте:

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample4.cmd)]

В рамках этого руководства добавьте триггеры в `Products` `Categories` таблицы, и `Suppliers` . Мы рассмотрим определенный синтаксис командной строки на шаге 3.

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inapp_data"></a>Шаг 2. ссылка на базу данных Microsoft SQL Server 2005 Express Edition в`App_Data`

`aspnet_regsql.exe`Программе командной строки требуется имя базы данных и сервера, чтобы добавить необходимую инфраструктуру опроса. Но что такое имя базы данных и сервера для базы данных Microsoft SQL Server 2005 Express, расположенной в `App_Data` папке? Вместо того, чтобы обнаруживать имена баз данных и серверов, я нашел, что самый простой подход заключается в присоединении базы данных к `localhost\SQLExpress` экземпляру базы данных и переименовании данных с помощью [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx). Если на вашем компьютере установлена одна из полных версий SQL Server 2005, вероятно, на компьютере уже установлены SQL Server Management Studio. Если у вас только Экспресс выпуски, можно скачать бесплатную [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).

Для начала Закройте Visual Studio. Затем откройте SQL Server Management Studio и выберите подключение к `localhost\SQLExpress` серверу с помощью проверки подлинности Windows.

![Присоединение к серверу Локалхост\склекспресс](using-sql-cache-dependencies-cs/_static/image1.gif)

**Рис. 1**. присоединение к `localhost\SQLExpress` серверу

После подключения к серверу Management Studio покажет сервер и получит вложенные папки для баз данных, безопасности и т. д. Щелкните правой кнопкой мыши папку базы данных и выберите пункт Присоединить. Откроется диалоговое окно Присоединение баз данных (см. рис. 2). Нажмите кнопку Добавить и выберите `NORTHWND.MDF` папку базы данных в папке веб-приложения `App_Data` .

[![Присоедините НОРСВНД. База данных MDF из папки App_Data](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)

**Рис. 2**. присоединение `NORTHWND.MDF` базы данных из `App_Data` папки ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image2.png))

Это приведет к добавлению базы данных в папку Databases. Имя базы данных может быть полным путем к файлу базы данных или полным путем в начале [идентификатора GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier). Чтобы не вводить это длинное имя базы данных при использовании \_ программы командной строки aspnetregsql.exe, переименуйте базу данных в более удобное имя, щелкнув правой кнопкой мыши только что подключенную базу данных и выбрав Переименовать. Я переименовал мою базу данных в учебные пособия.

![Переименование присоединенной базы данных на более удобное имя](using-sql-cache-dependencies-cs/_static/image3.gif)

**Рис. 3**. Переименование присоединенной базы данных на более удобное для человека имя

## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a>Шаг 3. Добавление инфраструктуры опроса в базу данных Northwind

Теперь, когда база данных присоединяется `NORTHWND.MDF` из `App_Data` папки, мы повторно готовы к добавлению инфраструктуры опроса. Если база данных была переименована в учебные пособия, выполните следующие четыре команды:

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample5.cmd)]

После выполнения этих четырех команд щелкните правой кнопкой мыши имя базы данных в Management Studio, перейдите в подменю задачи и выберите Отсоединить. Затем закройте Management Studio и снова откройте Visual Studio.

После повторного открытия Visual Studio выполните детализацию базы данных с помощью обозреватель сервера. Обратите внимание на новую таблицу ( `AspNet_SqlCacheTablesForChangeNotification` ), новые хранимые процедуры и триггеры в `Products` `Categories` `Suppliers` таблицах, и.

![Теперь база данных включает необходимую инфраструктуру опроса](using-sql-cache-dependencies-cs/_static/image4.gif)

**Рис. 4**. Теперь база данных включает необходимую инфраструктуру опроса

## <a name="step-4-configuring-the-polling-service"></a>Шаг 4. Настройка службы опроса

После создания необходимых таблиц, триггеров и хранимых процедур в базе данных последним шагом является настройка службы опроса, которая выполняется `Web.config` путем указания используемых баз данных и частоты опроса в миллисекундах. Следующая разметка опрашивает базу данных Northwind каждую секунду.

[!code-xml[Main](using-sql-cache-dependencies-cs/samples/sample6.xml)]

`name`Значение `<add>` элемента (норсвинддб) связывает понятное имя с определенной базой данных. При работе с зависимостями кэша SQL необходимо ссылаться на имя базы данных, определенную здесь, а также на таблицу, на которой основаны кэшированные данные. Мы посмотрим, как использовать `SqlCacheDependency` класс для программного связывания зависимостей кэша SQL с кэшированными данными на шаге 6.

После установки зависимости кэша SQL система опроса будет подключаться к базам данных, определенным в `<databases>` элементах каждую `pollTime` миллисекунду, и выполнять `AspNet_SqlCachePollingStoredProcedure` хранимую процедуру. Эта хранимая процедура, добавленная на шаге 3 с помощью `aspnet_regsql.exe` программы командной строки, возвращает `tableName` `changeId` значения и для каждой записи в `AspNet_SqlCacheTablesForChangeNotification` . Устаревшие зависимости кэша SQL исключены из кэша.

Этот `pollTime` параметр обеспечивает компромисс между производительностью и устареваниями данных. Небольшое `pollTime` значение увеличивает количество запросов к базе данных, но быстрее удаляет устаревшие данные из кэша. Большее `pollTime` значение сокращает количество запросов к базе данных, но увеличивает задержку между изменением серверных данных и моментом удаления связанных элементов кэша. К счастью, запрос к базе данных исполняет простую хранимую процедуру, которая возвращает всего несколько строк из простой, облегченной таблицы. Но экспериментируйте с различными `pollTime` значениями, чтобы найти идеальный баланс между доступом к базе данных и устаревания данных для приложения. Наименьшее `pollTime` допустимое значение — 500.

> [!NOTE]
> Приведенный выше пример предоставляет единственное `pollTime` значение в `<sqlCacheDependency>` элементе, но при необходимости можно указать `pollTime` значение в `<add>` элементе. Это полезно, если указано несколько баз данных и требуется настроить частоту опроса для каждой базы данных.

## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a>Шаг 5. декларативная работа с зависимостями кэша SQL

В шагах с 1 по 4 мы рассматривали настройку необходимой инфраструктуры базы данных и настройку системы опроса. После этой инфраструктуры мы можем добавлять элементы в кэш данных с помощью связанной с ним зависимости кэша SQL, используя программные или декларативные методы. На этом этапе мы рассмотрим декларативную работу с зависимостями кэша SQL. На шаге 6 мы рассмотрим программный подход.

[Данные кэширования с руководством по ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) изучили возможности декларативного кэширования элемента управления ObjectDataSource. Просто присвоив `EnableCaching` свойству значение `true` , а `CacheDuration` свойству — некоторый интервал времени, ObjectDataSource автоматически кэширует данные, возвращенные из его базового объекта за указанный интервал. ObjectDataSource также может использовать одну или несколько зависимостей кэша SQL.

Чтобы продемонстрировать использование зависимостей кэша SQL декларативно, откройте `SqlCacheDependencies.aspx` страницу в `Caching` папке и перетащите элемент управления GridView с панели инструментов в конструктор. Установите для GridView s `ID` значение `ProductsDeclarative` и, выбрав его смарт-тег, чтобы привязать его к новому ObjectDataSource с `ProductsDataSourceDeclarative` именем.

[![Создание нового ObjectDataSource с именем Продуктсдатасаурцедекларативе](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)

**Рис. 5**. Создание нового элемента ObjectDataSource с именем `ProductsDataSourceDeclarative` ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image4.png))

Настройте ObjectDataSource для использования `ProductsBLL` класса и задайте раскрывающийся список на вкладке Выбор `GetProducts()` . На вкладке обновление выберите `UpdateProduct` перегрузку с тремя входными параметрами — `productName` , `unitPrice` и `productID` . Установите в раскрывающихся списках значение (нет) на вкладках Вставка и удаление.

[![Использование перегрузки UpdateProduct с тремя входными параметрами](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)

**Рис. 6**. использование перегрузки UpdateProduct с тремя входными параметрами ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image6.png))

[![Установите для раскрывающегося списка значение (нет) для вкладок Вставка и удаление.](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)

**Рис. 7**. Установка в раскрывающемся списке значения (нет) для вкладок вставки и удаления ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image8.png))

После завершения работы мастера настройки источника данных Visual Studio создаст BoundFields и Чеккбоксфиелдс в GridView для каждого поля данных. Удалите все поля `ProductName` , кроме, и `CategoryName` `UnitPrice` , и отформатируйте эти поля по своему усмотрению. В смарт-теге GridView s установите флажки Включить постраничный просмотр, включить сортировку и включить редактирование. Visual Studio установит для свойства ObjectDataSource s значение `OldValuesParameterFormatString` `original_{0}` . Чтобы функция редактирования GridView s работала правильно, удалите это свойство из декларативного синтаксиса или снова установите его значение по умолчанию `{0}` .

Наконец, добавьте элемент управления Label над элементом GridView и установите для его `ID` свойства значение `ODSEvents` , а `EnableViewState` свойству — значение `false` . После внесения этих изменений декларативная разметка страницы должна выглядеть следующим образом. Обратите внимание, что я внес ряд настроек Aesthetic в поля GridView, которые не требуются для демонстрации функций зависимости кэша SQL.

[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample7.aspx)]

Затем создайте обработчик событий для события ObjectDataSource s `Selecting` и добавьте в него следующий код:

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample8.cs)]

Помните, что событие ObjectDataSource s `Selecting` срабатывает только при извлечении данных из базового объекта. Если элемент управления ObjectDataSource обращается к данным из своего кэша, это событие не срабатывает.

Теперь посетите эту страницу в браузере. Так как мы работаем над реализацией любого кэширования, каждый раз при отправке страницы, сортировке или изменении сетки страница должна отображать текст, "выбранное событие будет выводиться, как показано на рис. 8.

[![Событие выбора ObjectDataSource вызывается каждый раз, когда GridView размещается, редактируется или сортируется.](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)

**Рис. 8**. событие ObjectDataSource `Selecting` вызывается при каждом страничном, измененном или упорядоченном элементе управления GridView ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image10.png))

Как мы видели в статье [кэширование данных с помощью элемента управления ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) , установка `EnableCaching` свойства равным `true` приводит к кэшированию данных ObjectDataSource в течение времени, заданного `CacheDuration` свойством. ObjectDataSource также имеет [ `SqlCacheDependency` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), добавляющее одну или несколько зависимостей кэша SQL в кэшированные данные с помощью шаблона:

[!code-css[Main](using-sql-cache-dependencies-cs/samples/sample9.css)]

Где *DatabaseName* — это имя базы данных, указанное в `name` атрибуте `<add>` элемента в `Web.config` , а *TableName* — имя таблицы базы данных. Например, чтобы создать объект ObjectDataSource, который кэширует данные на неопределенное время в зависимости от зависимости кэша SQL от таблицы Northwind s `Products` , установите для свойства ObjectDataSource s значение `EnableCaching` `true` и его `SqlCacheDependency` свойство в норсвинддб: Products.

> [!NOTE]
> Можно использовать зависимость кэша SQL *и* срок действия, основанный на времени, задав `EnableCaching` для значение `true` , `CacheDuration` интервал времени и `SqlCacheDependency` имя базы данных и таблицы. Элемент управления ObjectDataSource будет исключать свои данные по истечении времени окончания срока действия или когда система опроса запишет, что изменились данные базовой базы данных, в зависимости от того, что произойдет раньше.

GridView в `SqlCacheDependencies.aspx` отображает данные из двух таблиц — `Products` и `Categories` (поле Products извлекается с помощью `CategoryName` `JOIN` On `Categories` ). Поэтому мы хотим указать две зависимости кэша SQL: Норсвинддб: Products; Норсвинддб: категории.

[![Настройка ObjectDataSource для поддержки кэширования с использованием зависимостей кэша SQL для продуктов и категорий](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)

**Рис. 9**. Настройка ObjectDataSource для поддержки кэширования с использованием зависимостей кэша SQL в `Products` и `Categories` ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image12.png))

После настройки ObjectDataSource для поддержки кэширования перейдите на страницу через браузер. Опять же, порожденное событие «текст» должно появиться на первой странице, но при разбиении на страницы, сортировке или нажатии кнопки «изменить» или «отмена» она должна исчезнуть. Это происходит потому, что после загрузки данных в кэш ObjectDataSource s они остаются там, пока `Products` таблицы или не `Categories` изменяются или данные не обновляются с помощью GridView.

После разбиения по страницам в сетке и указания на отсутствие «выданного» события «Selected Event» откройте новое окно браузера и перейдите к руководству по основам в разделе Редактирование, вставка и удаление ( `~/EditInsertDelete/Basics.aspx` ). Обновите имя или цену продукта. Затем в первом окне браузера просмотрите другую страницу данных, отсортируйте сетку или нажмите кнопку изменить строку. На этот раз событие "Выбор события" должно появиться снова, так как данные базовой базы данных были изменены (см. рис. 10). Если текст не отображается, подождите несколько секунд и повторите попытку. Помните, что служба опроса проверяет наличие изменений в `Products` таблице каждую `pollTime` миллисекунду, поэтому существует задержка между обновлением базовых данных и моментом удаления кэшированных данных.

[![Изменение таблицы Products исключает кэшированные данные о продуктах](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)

**Рис. 10**. изменение таблицы "продукты" исключает кэшированные данные продукта ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image14.png))

## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a>Шаг 6. Программная работа с `SqlCacheDependency` классом

[Сведения о кэшировании в руководстве по архитектуре](caching-data-in-the-architecture-cs.md) рассмотрели преимущества использования отдельного слоя кэширования в архитектуре, в отличие от тесного связывания кэширования с ObjectDataSource. В этом учебнике мы создали `ProductsCL` класс для демонстрации работы с кэшем данных программными средствами. Чтобы использовать зависимости кэша SQL на уровне кэширования, используйте `SqlCacheDependency` класс.

При использовании системы опроса `SqlCacheDependency` объект должен быть связан с определенной базой данных и парой таблиц. Следующий код, например, создает `SqlCacheDependency` объект на основе таблицы базы данных Northwind `Products` :

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample10.cs)]

Два входных параметра `SqlCacheDependency` конструктора s — это имена базы данных и таблицы соответственно. Как и в случае со `SqlCacheDependency` свойством ObjectDataSource s, используемое имя базы данных совпадает со значением, указанным в `name` атрибуте `<add>` элемента в `Web.config` . Имя таблицы — это фактическое имя таблицы базы данных.

Чтобы связать объект `SqlCacheDependency` с элементом, добавленным в кэш данных, используйте одну из `Insert` перегрузок метода, которая принимает зависимость. Следующий код добавляет *значение* в кэш данных в течение неопределенной длительности, но связывает его с a `SqlCacheDependency` в `Products` таблице. Вкратце, *значение* останется в кэше до тех пор, пока оно не будет исключено из-за ограничений памяти или если система опроса обнаружила, что `Products` Таблица изменилась с момента кэширования.

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample11.cs)]

В настоящее время класс уровня кэширования `ProductsCL` кэширует данные из `Products` таблицы, используя срок действия, основанный на времени (60 с). Разрешите обновить этот класс, чтобы вместо него использовать зависимости кэша SQL. `ProductsCL`Метод класса s `AddCacheItem` , отвечающий за добавление данных в кэш, в настоящее время содержит следующий код:

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample12.cs)]

Обновите этот код, чтобы использовать `SqlCacheDependency` объект вместо `MasterCacheKeyArray` зависимости кэша:

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample13.cs)]

Чтобы протестировать эту функцию, добавьте GridView на страницу под существующим элементом управления `ProductsDeclarative` GridView. Задайте для этого нового GridView s `ID` значение `ProductsProgrammatic` и, используя смарт-тег, привяжите его к новому ObjectDataSource с именем `ProductsDataSourceProgrammatic` . Настройте ObjectDataSource для использования `ProductsCL` класса, установив раскрывающиеся списки на вкладках SELECT и Update равными `GetProducts` и `UpdateProduct` соответственно.

[![Настройка ObjectDataSource для использования класса Продуктскл](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)

**Рис. 11**. Настройка ObjectDataSource для использования `ProductsCL` класса ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image16.png))

[![Выберите метод "продукты" из раскрывающегося списка SELECT Tab s (выбор вкладок).](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)

**Рис. 12**. Выбор `GetProducts` метода из раскрывающегося списка Выбор вкладок ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image18.png))

[![Выберите метод UpdateProduct в раскрывающемся списке вкладки обновления s](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)

**Рис. 13**. Выбор метода UpdateProduct из раскрывающегося списка вкладок обновления ([щелкните, чтобы просмотреть изображение с полным размером](using-sql-cache-dependencies-cs/_static/image20.png))

После завершения работы мастера настройки источника данных Visual Studio создаст BoundFields и Чеккбоксфиелдс в GridView для каждого поля данных. Как и в первом элементе GridView, добавленном на эту страницу, удалите все поля, кроме `ProductName` , и `CategoryName` `UnitPrice` , и отформатируйте эти поля по своему усмотрению. В смарт-теге GridView s установите флажки Включить постраничный просмотр, включить сортировку и включить редактирование. Как и в `ProductsDataSourceDeclarative` случае с ObjectDataSource, Visual Studio задаст `ProductsDataSourceProgrammatic` свойству ObjectDataSource s значение `OldValuesParameterFormatString` `original_{0}` . Чтобы функция редактирования GridView s работала правильно, присвойте этому свойству значение `{0}` (или удалите назначение свойства из декларативного синтаксиса).

После выполнения этих задач результирующая декларативная разметка GridView и ObjectDataSource должна выглядеть следующим образом:

[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample14.aspx)]

Чтобы протестировать зависимость кэша SQL в слое кэширования, установите точку останова в `ProductCL` `AddCacheItem` методе Class s, а затем начните отладку. При первом посещении `SqlCacheDependencies.aspx` точка останова должна быть достигнута, так как данные запрашиваются в первый раз и помещаются в кэш. Затем перейдите на другую страницу в GridView или отсортируйте один из столбцов. Это приводит к тому, что GridView выполняет запрос данных, но данные должны быть найдены в кэше, так как `Products` таблица базы данных не была изменена. Если данные в кэше постоянно не найдены, убедитесь, что на компьютере достаточно памяти, и повторите попытку.

После разбиения по страницам в GridView откройте второе окно браузера и перейдите к учебнику основные сведения в разделе Редактирование, вставка и удаление ( `~/EditInsertDelete/Basics.aspx` ). Обновите запись из таблицы Products, а затем в первом окне браузера просмотрите новую страницу или щелкните одну из заголовков сортировки.

В этом сценарии вы увидите одно из двух действий: будет достигнута точка останова, указывающая, что кэшированные данные были исключены из-за изменения в базе данных. или точка останова не будет нажата, а это означает, что `SqlCacheDependencies.aspx` теперь отображаются устаревшие данные. Если точка останова не достигается, вероятно, это вызвано тем, что служба опроса еще не активировалась с момента изменения данных. Помните, что служба опроса проверяет наличие изменений в `Products` таблице каждую `pollTime` миллисекунду, поэтому существует задержка между обновлением базовых данных и моментом удаления кэшированных данных.

> [!NOTE]
> Эта задержка чаще всего возникает при редактировании одного из продуктов с помощью GridView в `SqlCacheDependencies.aspx` . В ходе [кэширования данных в руководстве по архитектуре](caching-data-in-the-architecture-cs.md) мы добавили `MasterCacheKeyArray` зависимость кэша, чтобы убедиться, что данные, изменяемые с помощью `ProductsCL` метода класса s, `UpdateProduct` были исключены из кэша. Однако мы заменили эту зависимость кэша при изменении `AddCacheItem` метода ранее на этом шаге, и поэтому `ProductsCL` класс продолжит отображать кэшированные данные до тех пор, пока система опроса не запишет изменения в `Products` таблице. Мы посмотрим, как повторно ввести `MasterCacheKeyArray` зависимость кэша на шаге 7.

## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a>Шаг 7. Связывание нескольких зависимостей с кэшированным элементом

Помните, что `MasterCacheKeyArray` зависимость кэша используется для того, чтобы гарантировать, что *все* связанные с продуктом данные будут исключены из кэша при обновлении одного элемента, связанного в нем. Например, `GetProductsByCategoryID(categoryID)` метод кэширует `ProductsDataTables` экземпляры для каждого уникального значения *CategoryID* . Если один из этих объектов удален, `MasterCacheKeyArray` зависимость кэша гарантирует, что другие также будут удалены. Без этой зависимости кэша при изменении кэшированных данных возможна вероятность того, что другие кэшированные данные продукта могут устареть. Следовательно, важно поддерживать `MasterCacheKeyArray` зависимость кэша при использовании зависимостей кэша SQL. Однако метод кэширования данных s `Insert` позволяет только один объект зависимости.

Кроме того, при работе с зависимостями кэша SQL может потребоваться связать несколько таблиц базы данных как зависимости. Например, `ProductsDataTable` кэширование в `ProductsCL` классе содержит имена категорий и поставщиков для каждого продукта, но `AddCacheItem` метод использует только зависимость от `Products` . В этом случае, если пользователь обновляет имя категории или поставщика, кэшированные данные продукта будут оставаться в кэше и устареть. Поэтому мы хотим, чтобы кэшированные данные продуктов зависели не только от `Products` таблицы, но и в `Categories` `Suppliers` таблицах и.

[ `AggregateCacheDependency` Класс](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) предоставляет средства для связывания нескольких зависимостей с элементом кэша. Начните с создания `AggregateCacheDependency` экземпляра. Затем добавьте набор зависимостей с помощью `AggregateCacheDependency` `Add` метода s. После этого при вставке элемента в кэш данных передается `AggregateCacheDependency` экземпляр. При *any* `AggregateCacheDependency` изменении зависимостей любого экземпляра кэшированный элемент будет удален.

Ниже показан обновленный код для `ProductsCL` метода класса s `AddCacheItem` . Метод создает `MasterCacheKeyArray` зависимость кэша вместе с `SqlCacheDependency` объектами для `Products` `Categories` таблиц, и `Suppliers` . Все они объединены в один `AggregateCacheDependency` объект с именем `aggregateDependencies` , который затем передается в `Insert` метод.

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample15.cs)]

Протестируйте этот новый код. Теперь изменения в `Products` `Categories` таблицах, или `Suppliers` приводят к удалению кэшированных данных. Более того, `ProductsCL` метод класса s `UpdateProduct` , который вызывается при редактировании продукта через GridView, удаляет `MasterCacheKeyArray` зависимость кэша, что приводит к удалению кэширования `ProductsDataTable` и данных, которые должны быть повторно получены при следующем запросе.

> [!NOTE]
> Зависимости кэша SQL также можно использовать с [кэшированием выходных данных](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx). Демонстрацию этой функции см. в разделе [Использование кэширования вывода ASP.NET с SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).

## <a name="summary"></a>Сводка

При кэшировании данных базы данных оптимальные данные остаются в кэше до тех пор, пока они не будут изменены в базе данных. С помощью ASP.NET 2,0 зависимости кэша SQL можно создавать и использовать как в декларативных, так и в программных сценариях. Одна из проблем с этим подходом заключается в обнаружении изменений данных. Полные версии Microsoft SQL Server 2005 предоставляют возможности уведомлений, которые могут оповещать приложение при изменении результата запроса. Для выпуска Express версии SQL Server 2005 и более ранних версий SQL Server вместо нее следует использовать систему опроса. К счастью, Настройка необходимой инфраструктуры опроса довольно проста.

Поздравляем с программированием!

## <a name="further-reading"></a>Дополнительные материалы

Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:

- [Использование уведомлений о запросах в Microsoft SQL Server 2005](https://msdn.microsoft.com/library/ms175110.aspx)
- [Создание уведомления о запросе](https://msdn.microsoft.com/library/ms188669.aspx)
- [Кэширование в ASP.NET с помощью `SqlCacheDependency` класса](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)
- [Средство регистрации SQL Server ASP.NET ( `aspnet_regsql.exe` )](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)
- [Общие сведения о `SqlCacheDependency`](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [ mitchell@4GuysFromRolla.com .](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET) .

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого руководства: Марко Ranges, Терезой Мерфи и Хилтон Гизнау. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, удалите строку в [ mitchell@4GuysFromRolla.com .](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](caching-data-at-application-startup-cs.md)
> [Вперед](caching-data-with-the-objectdatasource-vb.md)
