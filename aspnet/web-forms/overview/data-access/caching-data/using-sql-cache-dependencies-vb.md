---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-vb
title: Использование зависимостей кэша SQL (Visual Basic) | Документация Майкрософт
author: rick-anderson
description: Самый простой стратегии кэширования является предоставление кэшированных данных по истечении указанного периода времени. Но этот простой подход означает, что maintai кэшированных данных...
ms.author: riande
ms.date: 05/30/2007
ms.assetid: bd347d93-4251-4532-801c-a36f2dfa7f96
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-vb
msc.type: authoredcontent
ms.openlocfilehash: be88d4928091cbe3010d6ef7e343de3517bf8211
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65132184"
---
# <a name="using-sql-cache-dependencies-vb"></a>Использование зависимостей кэша SQL (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачать код](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_VB.zip) или [скачать PDF](using-sql-cache-dependencies-vb/_static/datatutorial61vb1.pdf)

> Самый простой стратегии кэширования является предоставление кэшированных данных по истечении указанного периода времени. Но этот простой подход означает, что кэшированные данные поддерживает сходство с ее базового источника данных, приведет к устаревшие данные, хранящиеся слишком длинный или текущие данные, истек срок действия слишком рано. Лучшим подходом является использование класса SqlCacheDependency таким образом, чтобы данных будет храниться в кэше до базовых данных был изменен в базе данных SQL. Этот учебник демонстрирует этот процесс.

## <a name="introduction"></a>Вступление

Методы кэширования проверяются в [кэширование данных с помощью ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) и [кэширование данных в архитектуре](caching-data-in-the-architecture-vb.md) руководства позволяет исключить данные из кэша после указанного по времени окончания срока действия период. Этот подход является самым простым способом сбалансировать производительность кэширования с ограниченным устареванием данных. Выбрав срока истечения времени *x* секунд, разработчик concedes пользоваться преимуществами производительности кэширования для *x* секунд, но наведите просто что ей данные никогда не будут устаревших больше, чем максимум из *x* секунд. Конечно, для статических данных *x* может распространяться на время существования веб-приложения, как было изучить в [кэширование данных при запуске приложения](caching-data-at-application-startup-vb.md) руководства.

При кэшировании данных базы данных, по времени окончания срока действия часто будет автоматически выбран его простоту использования, но часто — это решение, недостаточно. В идеальном случае базы данных будет оставаться в кэше до базовых данных был изменен в базе данных; только после этого будет могут быть вытеснены кэшем. Такой подход повышает преимущества от кэширования и сводит к минимуму продолжительность устаревшие данные. Тем не менее чтобы получить такие преимущества существует, должен быть некоторые системы, которая знает, когда основной базы данных была изменена и исключает соответствующие элементы из кэша. До версии ASP.NET 2.0 разработчикам страниц было самостоятельно реализовать эту систему.

ASP.NET 2.0 предоставляет [ `SqlCacheDependency` класс](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) и необходимую инфраструктуру, чтобы определить, когда произошло изменение в базе данных, чтобы соответствующий кэшированных элементов может быть освобождена. Существует два способа для определения того, при изменении базовых данных: уведомление и опроса. После обсуждения различия между уведомлений и опроса, мы создадим инфраструктуру для поддержки опроса и исследуйте способы использования `SqlCacheDependency` класса в декларативной и программно сценариев.

## <a name="understanding-notification-and-polling"></a>Основные сведения о уведомлений и опроса

Существует два метода, которые могут использоваться для определения, когда был изменен в базе данных: уведомление и опроса. С помощью уведомлений базы данных автоматически оповещает среда выполнения ASP.NET, когда результаты определенного запроса были изменены с момента последнего выполнения запроса, после чего вытесняются кэшированные элементы, связанные с запросом. С помощью опроса, сервер базы данных сохраняет сведения о конкретные таблицы при последней были обновлены. Среда выполнения ASP.NET периодически опрашивает базу данных для проверки таблицы, которые были изменены так, как они были введены в кэш. Эти таблицы, данные которого был изменен имеют свои исключенных связанный кэш.

Параметр уведомлений требуется настройка, меньше чем опроса и становится более детализированным, так как он отслеживает изменения на уровне запроса, а не на уровне таблицы. К сожалению уведомления доступны только в полных выпусках Microsoft SQL Server 2005 (т. е. выпуски не Express). Тем не менее параметр опроса можно использовать для всех версий Microsoft SQL Server 7.0 до 2005. Так как в этих учебниках используется экспресс-выпуске SQL Server 2005, основное внимание уделено настройке и использовании параметр опроса. См. в разделе дальнейшего чтения в конце этого руководства для дальнейшего ресурсы на возможности уведомления SQL Server 2005 s.

С помощью опроса, базы данных должен быть настроен для включения таблицы с именем `AspNet_SqlCacheTablesForChangeNotification` с тремя столбцами: `tableName`, `notificationCreated`, и `changeId`. Эта таблица содержит по строке для каждой таблицы, в котором находятся данные, могут потребоваться для использования в зависимость кэша SQL в веб-приложения. `tableName` Столбец указывает имя таблицы во время `notificationCreated` указывает дату и время, строка была добавлена в таблицу. `changeId` Столбец имеет тип `int` и начальное значение 0. Его значение увеличивается при каждой модификации в таблицу.

В дополнение к `AspNet_SqlCacheTablesForChangeNotification` таблицы, базы данных также должен включать триггеры для каждой таблицы, которые могут появиться в зависимость кэша SQL. Эти триггеры выполняются каждый раз, когда вставки, обновления или удаления строки и увеличивайте Таблица s `changeId` значение в `AspNet_SqlCacheTablesForChangeNotification`.

Среда выполнения ASP.NET отслеживает текущий `changeId` для таблицы при кэшировании данных с помощью `SqlCacheDependency` объекта. Базы данных периодически проверяется, а также `SqlCacheDependency` объектов, `changeId` отличается от значения в базе данных вытесняются с момента отличающийся `changeId` значение указывает, что было изменение в таблицу с момента кэширования данных.

## <a name="step-1-exploring-theaspnetregsqlexecommand-line-program"></a>Шаг 1. Изучение`aspnet_regsql.exe`программы командной строки

При подходе опроса базы данных должен быть программу установки, чтобы содержать инфраструктуры, описанные выше: стандартные таблицы (`AspNet_SqlCacheTablesForChangeNotification`), небольшое число хранимых процедур и триггеров в каждой из таблиц, которые могут использоваться в зависимости кэша SQL в веб- приложение. Эти таблицы, хранимые процедуры и триггеры могут создаваться с помощью программы командной строки `aspnet_regsql.exe`, который можно найти в `$WINDOWS$\Microsoft.NET\Framework\version` папку. Чтобы создать `AspNet_SqlCacheTablesForChangeNotification` таблицы и связанных хранимых процедур, выполните следующую команду из командной строки:

[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample1.cmd)]

> [!NOTE]
> Чтобы выполнить эти команды, указанной базы данных имя входа должно быть в [ `db_securityadmin` ](https://msdn.microsoft.com/library/ms188685.aspx) и [ `db_ddladmin` ](https://msdn.microsoft.com/library/ms190667.aspx) ролей. Изучаемый T-SQL, отправляемые из базы данных, `aspnet_regsql.exe` командной строки программы, обратитесь к [этой записи блога](http://scottonwriting.net/sowblog/posts/10709.aspx).

Например, чтобы добавить инфраструктуру для опроса базы данных Microsoft SQL Server с именем `pubs` на сервере базы данных с именем `ScottsServer` с использованием проверки подлинности Windows, перейдите в соответствующий каталог и, в командной строке введите:

[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample2.cmd)]

После добавления инфраструктуры на уровне базы данных, необходимо добавить триггеры к этим таблицам, которые будут использоваться в зависимости кэша SQL. Используйте `aspnet_regsql.exe` командной строки программу снова, но укажите имя таблицы с помощью `-t` переключения и вместо использования `-ed` переключения используйте `-et`, следующим образом:

[!code-html[Main](using-sql-cache-dependencies-vb/samples/sample3.html)]

Чтобы добавить триггеры в `authors` и `titles` таблицы на `pubs` базы данных на `ScottsServer`, используйте:

[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample4.cmd)]

В этом руководстве добавить триггеры в `Products`, `Categories`, и `Suppliers` таблицы. Мы рассмотрим синтаксис командной строки, определенный на шаге 3.

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inappdata"></a>Шаг 2. Ссылки на Microsoft SQL Server 2005, экспресс-выпуск базы данных в`App_Data`

`aspnet_regsql.exe` Программы командной строки необходимо указать имя базы данных и сервера, чтобы добавить необходимые опроса инфраструктуры. Однако имя базы данных и сервера для базы данных Microsoft SQL Server 2005 Express, который находится в `App_Data` папку? Вместо того, чтобы узнать, что являются имена базы данных и сервера, я считаю, что самым простым подходом является присоединить базу данных для `localhost\SQLExpress` экземпляр СУБД и переименование данных с помощью [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx). Если один из полные версии SQL Server 2005 на компьютер, затем уже есть SQL Server Management Studio, установленной на компьютере. При наличии только выпуск Express, вы можете скачать бесплатный [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).

Сначала необходимо закрыть Visual Studio. Далее, откройте SQL Server Management Studio и подключиться к `localhost\SQLExpress` сервера с помощью проверки подлинности Windows.

![Присоединение к localhost\SQLExpress сервера](using-sql-cache-dependencies-vb/_static/image1.gif)

**Рис. 1**: Присоединение к `localhost\SQLExpress` сервера

После подключения к серверу Management Studio Показать сервера и иметь вложенные папки для баз данных, безопасности и т. д. Щелкните правой кнопкой мыши на папку базы данных и выберите параметр присоединения. Это приведет к появлению диалогового окна присоединение баз данных (см. рис. 2). Нажмите кнопку "Добавить" и выберите `NORTHWND.MDF` папки базы данных в вашей s приложения web `App_Data` папки.

[![Подключите NORTHWND. MDF-ФАЙЛОМ базы данных из папки App_Data](using-sql-cache-dependencies-vb/_static/image2.gif)](using-sql-cache-dependencies-vb/_static/image1.png)

**Рис. 2**: Присоединение `NORTHWND.MDF` из базы данных `App_Data` папку ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image2.png))

Это добавит базы данных в папку базы данных. Имя базы данных может содержать полный путь к файлу базы данных или полный путь с префиксом [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier). Чтобы избежать необходимости вводить имя этой длительной базы данных при использовании aspnet\_regsql.exe средство командной строки, переименовать, присоединить базу данных более понятном имени, просто щелкнув базы данных и выбрав переименование. Я ve Моя база данных переименована в DataTutorials.

![Переименуйте присоединенную базу данных в более понятном имени](using-sql-cache-dependencies-vb/_static/image3.gif)

**Рис. 3**: Переименуйте присоединенную базу данных в более понятном имени

## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a>Шаг 3. Добавить инфраструктуру опроса базы данных "Борей"

Теперь, когда мы были присоединены `NORTHWND.MDF` из базы данных `App_Data` папки, мы будет готов для добавления инфраструктуры опроса. Предположим, что вы ve переименованной базы данных к DataTutorials, выполните следующие четыре команды:

[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample5.cmd)]

После выполнения этих четырех команд, щелкните правой кнопкой мыши имя базы данных в среде Management Studio и перейдите в меню задач выберите отсоединения. Затем закройте среду Management Studio и снова откройте Visual Studio.

Как только при повторном открытии Visual Studio углубиться в базе данных с помощью обозревателя серверов. Обратите внимание, новая таблица (`AspNet_SqlCacheTablesForChangeNotification`), новые хранимые процедуры и триггеры на `Products`, `Categories`, и `Suppliers` таблицы.

![Базы данных теперь включает в себя инфраструктуру необходимые опроса](using-sql-cache-dependencies-vb/_static/image4.gif)

**Рис. 4**: Базы данных теперь включает в себя инфраструктуру необходимые опроса

## <a name="step-4-configuring-the-polling-service"></a>Шаг 4. Настройка службы опроса

После создания необходимых таблиц, триггеров и хранимых процедур в базе данных, последним шагом является настройка службы опроса, который выполняется с помощью `Web.config` путем указания баз данных и частоты опроса в миллисекундах. Следующая разметка опрашивает базу данных "Борей" раз в секунду.

[!code-xml[Main](using-sql-cache-dependencies-vb/samples/sample6.xml)]

`name` Значение в `<add>` элемент (NorthwindDB) связывает понятное имя с определенной базы данных. При работе с зависимостей кэша SQL, необходимо ссылаться на имя базы данных, заданные здесь, а также в таблице, на основе кэшированных данных. Узнаете, как использовать `SqlCacheDependency` класс для программной связи зависимости кэша SQL с помощью кэшированных данных в шаге 6.

После установления зависимости кэша SQL опроса компьютер подключается к базам данных, определенных в `<databases>` элементы каждого `pollTime` миллисекунд и выполнение `AspNet_SqlCachePollingStoredProcedure` хранимой процедуры. Эта хранимая процедура - добавленный обратно в шаге 3, используя `aspnet_regsql.exe` средство командной строки — возвращает `tableName` и `changeId` значения для каждой записи в `AspNet_SqlCacheTablesForChangeNotification`. Устаревшие зависимостей кэша SQL вытесняются из кэша.

`pollTime` Параметр представляет компромисс между производительностью и устаревание данных. Небольшой `pollTime` значение увеличивает количество запросов к базе данных, но более быстро вытесняет устаревшие данные из кэша. Увеличить размер `pollTime` значение уменьшает количество запросов к базе данных, но увеличивает задержку между при изменении данных серверной части и когда вытесняются связанные элементы. К счастью запрос базы данных выполняется простой хранимой процедуры возврат только несколько строк из таблицы упрощенный s. Но поэкспериментировать с различными `pollTime` значения, чтобы найти идеальный баланс между базы данных устаревания доступа и данные для вашего приложения. Наименьшее `pollTime` допустимое значение равно 500.

> [!NOTE]
> Приведенный выше пример предоставляет один `pollTime` значение в `<sqlCacheDependency>` элемент, но при необходимости можно указать `pollTime` значение в `<add>` элемент. Это полезно в том случае, если указано несколько баз данных и для настройки частоты опроса, каждой базы данных.

## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a>Шаг 5. Декларативно работа с зависимости кэша SQL

В шаги с 1 по 4 мы рассмотрели способы установки инфраструктуры необходимые базы данных и настроить систему опроса. С этой инфраструктуры на месте мы теперь можно добавить элементы в кэш данных связанные зависимости кэша SQL, используя декларативный или программный методы. На этом шаге мы рассмотрим, как декларативно работать с зависимостей кэша SQL. На шаге 6 мы рассмотрим программный подход.

[Кэширование данных с помощью ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) руководстве рассмотрены декларативных возможностей кэширования ObjectDataSource. Путем простого указания `EnableCaching` свойства `True` и `CacheDuration` свойство некоторые интервал времени, элемент управления ObjectDataSource будет автоматически кэшировать данные, возвращенные из базового объекта в течение указанного интервала. Элемент управления ObjectDataSource можно также использовать одну или несколько зависимостей кэша SQL.

Чтобы продемонстрировать использование зависимостей кэша SQL декларативно, откройте `SqlCacheDependencies.aspx` странице в `Caching` папки и перетащите элемент управления GridView с панели инструментов в конструктор. Набор GridView s `ID` для `ProductsDeclarative` и в его смарт-тега выберите, чтобы привязать его к элементу управления ObjectDataSource с именем `ProductsDataSourceDeclarative`.

[![Создайте новый ObjectDataSource, именуемый ProductsDataSourceDeclarative](using-sql-cache-dependencies-vb/_static/image5.gif)](using-sql-cache-dependencies-vb/_static/image3.png)

**Рис. 5**: Создайте новый ObjectDataSource с именем `ProductsDataSourceDeclarative` ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image4.png))

Настройка ObjectDataSource на использование `ProductsBLL` и присвоить стрелку раскрывающегося списка на вкладке ВЫБЕРИТЕ `GetProducts()`. На вкладке "обновления" выберите `UpdateProduct` перегрузка с три входных параметра - `productName`, `unitPrice`, и `productID`. Задайте раскрывающихся списков (нет) на вкладках INSERT и DELETE.

[![Используйте перегрузки UpdateProduct с тремя входными параметрами](using-sql-cache-dependencies-vb/_static/image6.gif)](using-sql-cache-dependencies-vb/_static/image5.png)

**Рис. 6**: Используйте перегрузки UpdateProduct с тремя параметрами для входных данных ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image6.png))

[![Задайте стрелку раскрывающегося списка (нет) для вставки и удаления вкладок](using-sql-cache-dependencies-vb/_static/image7.gif)](using-sql-cache-dependencies-vb/_static/image7.png)

**Рис. 7**: Задайте стрелку раскрывающегося списка (нет) для вставки и удаления вкладок ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image8.png))

После завершения работы мастера настройки источников данных Visual Studio создаст поля BoundFields и CheckBoxFields в GridView для каждого поля данных. Удалите все поля, но `ProductName`, `CategoryName`, и `UnitPrice`и отформатируйте их по своему усмотрению. Смарт-теге GridView s установите флажки включить разбиение по страницам, включить сортировку и разрешить редактирование. Visual Studio установит ObjectDataSource s `OldValuesParameterFormatString` свойства `original_{0}`. Чтобы для правильной работы средства редактирования s GridView, либо удалите это свойство из декларативного синтаксиса или верните значение значением по умолчанию `{0}`.

Наконец, добавьте элемент управления Label Web над GridView и набор его `ID` свойства `ODSEvents` и его `EnableViewState` свойства `False`. После внесения этих изменений, декларативная разметка s страницы должен выглядеть следующим образом. Обратите внимание, ve внесли ряд эстетически настройки поля GridView, которые не требуются для демонстрации его функциональных зависимостей кэша SQL.

[!code-aspx[Main](using-sql-cache-dependencies-vb/samples/sample7.aspx)]

Создайте обработчик событий для ObjectDataSource s `Selecting` событий в его и добавьте следующий код:

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample8.vb)]

Помните, что элемент управления ObjectDataSource s `Selecting` событие срабатывает, только в том случае, если получение данных из базового объекта. Если элемент управления ObjectDataSource обращается к данным с собственным кэшем, это событие не вызывается.

Теперь посетите эту страницу через обозреватель. Так как мы ve еще выполнить кэширование, каждый раз, страницы, сортировку или отредактировать сетку страницы должен отображаться текст, выбрав вариант событие, запускаемое, как показано на рис. 8.

[![ObjectDataSource s события Selecting срабатывает каждый GridView разбивается на страницы, изменять, времени или Sorted](using-sql-cache-dependencies-vb/_static/image8.gif)](using-sql-cache-dependencies-vb/_static/image9.png)

**Рис. 8**: Элемент управления ObjectDataSource s `Selecting` Each время события активируется разбивается на страницы GridView, измененный или Sorted ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image10.png))

Как мы видели в [кэширование данных с помощью ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) учебник, установка `EnableCaching` свойства `True` заставляет элемент управления ObjectDataSource для кэширования данных в течение заданного по его `CacheDuration` свойство. Элемент управления ObjectDataSource также имеет [ `SqlCacheDependency` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), который добавляет одну или несколько зависимостей кэша SQL к кэшированным данным, используя шаблон:

[!code-css[Main](using-sql-cache-dependencies-vb/samples/sample9.css)]

Где *databaseName* — это имя базы данных, как указано в `name` атрибут `<add>` элемент в `Web.config`, и *tableName* имя таблицы базы данных. Например, создание нового ObjectDataSource, который кэширует данные неограниченное время на основании зависимость кэша SQL от Northwind s `Products` таблицы, задайте ObjectDataSource s `EnableCaching` свойства `True` и его `SqlCacheDependency` свойства NorthwindDB:Products.

> [!NOTE]
> Можно использовать зависимость кэша SQL *и* по времени окончания срока действия, задав `EnableCaching` для `True`, `CacheDuration` для интервала времени и `SqlCacheDependency` к имена базы данных и таблицы. Элемент управления ObjectDataSource исключим его данные при достижении окончания срока действия по времени или когда система опроса сообщает, что основной базы данных был изменен, какое событие произойдет раньше.

GridView в `SqlCacheDependencies.aspx` отображает данные из двух таблиц - `Products` и `Categories` (продукт s `CategoryName` поля извлекается с помощью метода `JOIN` на `Categories`). Таким образом нам нужно указать две зависимости кэша SQL: NorthwindDB:Products; NorthwindDB:Categories.

[![Настройте элемент ObjectDataSource для поддержки кэширования использование зависимостей кэша SQL на продукты и категории](using-sql-cache-dependencies-vb/_static/image9.gif)](using-sql-cache-dependencies-vb/_static/image11.png)

**Рис. 9**: Настройка ObjectDataSource для поддержки кэширования с помощью зависимостей кэша SQL на `Products` и `Categories` ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image12.png))

После настройки ObjectDataSource для поддержки кэширования, вернемся к странице через браузер. Опять же инициируется событие Selecting текста должна отображаться при первом посещении страницы, но должна исчезнуть при разбиение по страницам, сортировки или кнопки Edit или "Отмена". Это обусловлено после загрузки данных в кэше s ObjectDataSource, остается там до `Products` или `Categories` изменяются таблицах или обновлять данные с помощью GridView.

AFTER, срабатывающим разбиение по страницам сетки и отметив отсутствие события Selecting текст, откройте новое окно браузера и перейдите к руководству основы в редактирование, вставка и удаление раздела (`~/EditInsertDelete/Basics.aspx`). Обновление имени и цену продукта. Затем из в первой окно браузера, просмотрите на другую страницу данных, сортировки сетки или нажмите кнопку редактирования строк. В данном случае событие Selecting должно появиться снова, как в основной базе данных, данные были изменены (см. рис. 10). Если текст не отображается, подождите немного и повторите попытку. Помните, что служба опроса проверяет, чтобы изменения вступили в `Products` таблицы каждый `pollTime` миллисекунд, поэтому возникает задержка между при обновлении базовых данных и когда удаляется кэшированных данных.

[![Изменение таблицы Products исключает кэшированные данные](using-sql-cache-dependencies-vb/_static/image10.gif)](using-sql-cache-dependencies-vb/_static/image13.png)

**Рис. 10**: Изменение таблицы Products исключает кэшированных данных продукта ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image14.png))

## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a>Шаг 6. Программным способом работы с`SqlCacheDependency`класса

[Кэширование данных в архитектуре](caching-data-in-the-architecture-vb.md) руководстве рассмотрены преимущества использования отдельном слое кэширования в архитектуре, в отличие от тесной взаимозависимости между кэширования с помощью ObjectDataSource. В этом учебнике мы создали `ProductsCL` для демонстрации программно работать с кэшем данных. Чтобы использовать зависимости кэша SQL на уровне кэширования, `SqlCacheDependency` класса.

В системе опроса `SqlCacheDependency` объект должен быть связан с парой конкретной базы данных и таблицы. Например, следующий код, создает `SqlCacheDependency` основанный на базе данных "Борей" s `Products` таблицы:

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample10.vb)]

Две входные параметры `SqlCacheDependency` конструктор s — имена базы данных и таблицы, соответственно. Как с помощью ObjectDataSource s `SqlCacheDependency` свойство, имя базы данных, используемое является таким же, как указано в этом параметре `name` атрибут `<add>` элемент в `Web.config`. Имя таблицы — это фактическое имя этой таблицы базы данных.

Чтобы связать `SqlCacheDependency` с элемент, добавляемый в кэш данных, используйте один из `Insert` перегрузки метода, которые принимает зависимость. Следующий код добавляет *значение* в кэш данных неопределенное время, но связывает его с `SqlCacheDependency` на `Products` таблицы. Короче говоря *значение* будет оставаться в кэше, пока он удаляется из-за нехватки памяти или из-за опроса система обнаружила, что `Products` таблица была изменена, так как он был кэширован.

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample11.vb)]

Кэширование слоя s `ProductsCL` класса сейчас кэширует данные из `Products` таблицу с помощью по времени окончания срока действия 60 секунд. Позвольте s обновить этот класс, чтобы вместо этого он использует зависимостей кэша SQL. `ProductsCL` Класс s `AddCacheItem` метод, который отвечает за добавление данных в кэш, в настоящее время содержит следующий код:

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample12.vb)]

Обновить этот код для использования `SqlCacheDependency` вместо объекта `MasterCacheKeyArray` зависимости кэша:

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample13.vb)]

Чтобы протестировать эту функцию, добавьте элемент управления GridView странице под списком существующий `ProductsDeclarative` GridView. Задайте этот новый s GridView `ID` для `ProductsProgrammatic` и через его смарт-тег, привязать его к элементу управления ObjectDataSource с именем `ProductsDataSourceProgrammatic`. Настройка ObjectDataSource на использование `ProductsCL` классе и задайте раскрывающиеся списки в SELECT и UPDATE вкладок, чтобы `GetProducts` и `UpdateProduct`, соответственно.

[![Настройка ObjectDataSource на использование класса ProductsCL](using-sql-cache-dependencies-vb/_static/image11.gif)](using-sql-cache-dependencies-vb/_static/image15.png)

**Рис. 11**: Настройка ObjectDataSource для использования `ProductsCL` класс ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image16.png))

[![Выберите метод GetProducts из раскрывающегося списка ВЫБЕРИТЕ вкладку s](using-sql-cache-dependencies-vb/_static/image12.gif)](using-sql-cache-dependencies-vb/_static/image17.png)

**Рис. 12**: Выберите `GetProducts` метод из раскрывающегося списка ВЫБЕРИТЕ вкладку s ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image18.png))

[![Выберите метод UpdateProduct в списке обновления s вкладка раскрывающегося списка](using-sql-cache-dependencies-vb/_static/image13.gif)](using-sql-cache-dependencies-vb/_static/image19.png)

**Рис. 13**: Выберите из раскрывающегося списка s вкладку обновление методу UpdateProduct ([Просмотр полноразмерного изображения](using-sql-cache-dependencies-vb/_static/image20.png))

После завершения работы мастера настройки источников данных Visual Studio создаст поля BoundFields и CheckBoxFields в GridView для каждого поля данных. Как с помощью первого GridView, добавляемые на эту страницу, удалите все поля, но `ProductName`, `CategoryName`, и `UnitPrice`и отформатируйте их по своему усмотрению. Смарт-теге GridView s установите флажки включить разбиение по страницам, включить сортировку и разрешить редактирование. Как и в `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio установит `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` свойства `original_{0}`. Функции редактирования s GridView для правильной работы, присвойте этому свойству обратно в `{0}` (или полностью удалить назначение свойства из декларативного синтаксиса).

После выполнения этих задач, полученный GridView и ObjectDataSource декларативная разметка должна выглядеть следующим образом:

[!code-aspx[Main](using-sql-cache-dependencies-vb/samples/sample14.aspx)]

Для проверки SQL зависимость кэша на уровне кэширования установите точку останова в `ProductCL` класс s `AddCacheItem` метод и затем запустить отладку. При первом посещении `SqlCacheDependencies.aspx`, должна быть достигнута точка останова, как данные запрашиваются в первый раз и помещенных в кэш. Затем перехода на другую страницу в GridView, или один из столбцов сортировки. Это приводит к GridView для запроса данных, но данные должны находиться в кэше с момента `Products` таблицы базы данных не был изменен. Если данные повторно не найден в кэше, убедитесь, что имеется достаточный объем памяти доступен на компьютере и повторите попытку.

После разбиения на страницы через несколько страниц элемента управления GridView, откройте второе окно браузера и перейдите к руководству основы в редактирование, вставка и удаление раздела (`~/EditInsertDelete/Basics.aspx`). Обновить запись из таблицы Products и просмотрите новую страницу в первом окне браузера или щелкните один из заголовков сортировки.

В этом сценарии вы увидите одно из следующих действий: либо будут иметь точки останова, указывающее, что кэшированные данные было прекращено из-за изменения в базе данных; или, точка останова не сработают, это означает, что `SqlCacheDependencies.aspx` теперь находится в состоянии устаревшие данные. Если точка останова не достигается, вполне вероятно, так как службы опроса с не еще момента эти данные были изменены. Помните, что служба опроса проверяет, чтобы изменения вступили в `Products` таблицы каждый `pollTime` миллисекунд, поэтому возникает задержка между при обновлении базовых данных и когда удаляется кэшированных данных.

> [!NOTE]
> Эта задержка, скорее всего, отображаться при редактировании одного из продуктов через GridView в `SqlCacheDependencies.aspx`. В [кэширование данных в архитектуре](caching-data-in-the-architecture-vb.md) руководстве, мы добавили `MasterCacheKeyArray` зависимости, чтобы убедиться, что данные редактируемого через кэша `ProductsCL` класс s `UpdateProduct` метод был исключен из кэша. Тем не менее, мы заменили Эта зависимость кэша при изменении `AddCacheItem` метод ранее на этом шаге и, следовательно, `ProductsCL` класса будут отображать кэшированных данных, пока система опроса сообщает, чтобы изменения `Products` таблицы. Будет рассмотрена тем `MasterCacheKeyArray` кэшировать зависимостей на шаге 7.

## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a>Шаг 7. Связывание несколько зависимостей с помощью кэшированного элемента

Помните, что `MasterCacheKeyArray` зависимость кэша используется, чтобы убедиться, что *все* данным о продуктах удаляется из кэша при обновлении любого один элемент, связанный внутри него. Например `GetProductsByCategoryID(categoryID)` кэши метод `ProductsDataTables` экземпляров для каждого уникального *categoryID* значение. Если один из этих объектов ее вытеснения `MasterCacheKeyArray` зависимость кэша гарантирует, что другие будут также удалены. Без этой зависимости кэша при изменении кэшированных данных существует возможность, что других продуктов, кэшированные данные могут быть устаревшими. Следовательно, он s, важно, что мы поддерживаем `MasterCacheKeyArray` зависимости кэша при использовании зависимостей кэша SQL. Тем не менее, данные кэша s `Insert` метод разрешает только для объекта одной зависимости.

Кроме того при работе с зависимостей кэша SQL мы может потребоваться связать с несколькими таблицами базы данных в качестве зависимостей. Например `ProductsDataTable` кэшируются `ProductsCL` класс содержит категорию и поставщика имена для каждого продукта, но `AddCacheItem` метод использует только зависимости на `Products`. В этом случае если пользователь обновляет имя категории или поставщику, кэшированные данные будут оставаться в кэше и устареть. Таким образом, мы хотим сделать зависимым от кэшированные данные не только `Products` таблицы, но на `Categories` и `Suppliers` таблицы.

[ `AggregateCacheDependency` Класс](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) предоставляет средства для связывания несколько зависимостей с элементом кэша. Начните с создания `AggregateCacheDependency` экземпляра. Добавьте набор зависимостей с помощью `AggregateCacheDependency` s `Add` метод. При вставке элемента в кэше данных после этого, передайте `AggregateCacheDependency` экземпляра. Когда *любой* из `AggregateCacheDependency` изменить экземпляр s зависимости, удаления кэшированного элемента.

Ниже приведен обновленный код для `ProductsCL` класс s `AddCacheItem` метод. Этот метод создает `MasterCacheKeyArray` кэшировать зависимостей вместе с `SqlCacheDependency` объектов для `Products`, `Categories`, и `Suppliers` таблицы. Они будут объединены в один `AggregateCacheDependency` объект с именем `aggregateDependencies`, который затем передается в `Insert` метод.

[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample15.vb)]

Проверьте новый код out. Теперь изменился на `Products`, `Categories`, или `Suppliers` таблицы вызывают кэшированных данных для удаления. Кроме того `ProductsCL` класс s `UpdateProduct` метод, который вызывается при правке продукта через GridView, исключает `MasterCacheKeyArray` кэшировать зависимостей, в результате чего кэшированные `ProductsDataTable` к исключению и извлекаемых данных повторно при следующем запрос.

> [!NOTE]
> Зависимости кэша SQL также может использоваться с [кэширование вывода](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx). Демонстрацию этой функции см. в разделе: [С помощью ASP.NET кэширования выходных данных с SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).

## <a name="summary"></a>Сводка

При кэшировании данных базы данных, данные будут оставаться в кэше, в идеале до его изменения в базе данных. С помощью ASP.NET 2.0 можно создать и использовать в сценариях декларативные и программные зависимости кэша SQL. Одна из сложностей при таком подходе выполняется обнаружение при изменении данных. Полные версии Microsoft SQL Server 2005 предоставляют возможности уведомления, информирующие приложения при изменении результатов запроса. Express Edition SQL Server 2005 и более ранних версиях SQL Server необходимо использовать систему опроса. К счастью Настройка инфраструктуры, необходимые опроса, достаточно просто.

Счастливого вам программирования!

## <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, обсуждавшимся в этом руководстве см. в следующих ресурсах:

- [Использование уведомлений о запросах в Microsoft SQL Server 2005](https://msdn.microsoft.com/library/ms175110.aspx)
- [Создание уведомления о запросе](https://msdn.microsoft.com/library/ms188669.aspx)
- [Кэширование в ASP.NET с помощью `SqlCacheDependency` класса](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)
- [Средство регистрации ASP.NET SQL Server (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)
- [Общие сведения о `SqlCacheDependency`](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP.NET и основатель веб- [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга — [ *Sams Teach ASP.NET 2.0 in 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Ним можно связаться по адресу [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Marko Rangel Терезой Мерфи и (Hilton giesenow), стали Лиз Шалок в этом руководстве. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](caching-data-at-application-startup-vb.md)
