---
uid: web-forms/overview/data-access/working-with-binary-files/updating-and-deleting-existing-binary-data-vb
title: Обновление и удаление существующих двоичных данных (VB) | Документация Майкрософт
author: rick-anderson
description: В предыдущих учебных курсах мы увидели, как элемент управления GridView упрощает редактирование и удаление текстовых данных. В этом учебнике мы видим, как элемент управления GridView также делает...
ms.author: riande
ms.date: 03/27/2007
ms.assetid: 3a052ced-9cf5-47b8-a400-934f0b687c26
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/updating-and-deleting-existing-binary-data-vb
msc.type: authoredcontent
ms.openlocfilehash: 27ff6941008b4e7bf6d632e4c248fd1d35fb3589
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78475014"
---
# <a name="updating-and-deleting-existing-binary-data-vb"></a>Обновление и удаление существующих двоичных данных (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_57_VB.exe) или [Загрузка PDF-файла](updating-and-deleting-existing-binary-data-vb/_static/datatutorial57vb1.pdf)

> В предыдущих учебных курсах мы увидели, как элемент управления GridView упрощает редактирование и удаление текстовых данных. В этом учебнике показано, как элемент управления GridView также позволяет изменять и удалять двоичные данные независимо от того, сохраняются ли эти двоичные данные в базе данных или хранятся в файловой системе.

## <a name="introduction"></a>Введение

За последние три руководства мы добавили довольно много функций для работы с двоичными данными. Мы начали с добавления столбца `BrochurePath` в таблицу `Categories` и соответствующим образом обновили архитектуру. Мы также добавили уровень доступа к данным и методы уровня бизнес-логики для работы с `Picture` столбцом Categories, который содержит двоичное содержимое файла изображения. Мы создали веб-страницы для представления двоичных данных в элементе управления GridView ссылкой для скачивания буклета, где изображение категорий отображается в элементе `<img>` и добавило элемент DetailsView, чтобы пользователи могли добавлять новые категории и отправлять данные из брошюры и изображений.

Все, что остается реализованным, — это возможность изменять и удалять существующие категории, которые мы будем выполнять в этом руководстве, используя встроенные функции редактирования и удаления в GridView. При редактировании категории пользователь может при необходимости передать новую картинку или продолжить использовать существующую. Для буклета они могут либо использовать существующую буклет, либо отправить новую буклет, либо указать, что в категорию больше не связан буклет. Давайте приступим к работе!

## <a name="step-1-updating-the-data-access-layer"></a>Шаг 1. обновление уровня доступа к данным

DAL содержит автоматически созданные методы `Insert`, `Update`и `Delete`, но эти методы были созданы на основе основного запроса `CategoriesTableAdapter` s, который не включает столбец `Picture`. Таким образом, методы `Insert` и `Update` не включают параметры для указания двоичных данных для изображения категории s. Как и в [предыдущем учебном курсе](including-a-file-upload-option-when-adding-a-new-record-vb.md), нам нужно создать новый метод TableAdapter для обновления таблицы `Categories` при указании двоичных данных.

Откройте типизированный набор данных и в конструкторе щелкните правой кнопкой мыши заголовок `CategoriesTableAdapter` s и выберите в контекстном меню команду Добавить запрос, чтобы запустить мастер настройки запроса адаптера таблицы. Этот мастер запустится с просьбой получить доступ к базе данных с помощью запроса адаптера таблицы. Выберите использовать инструкции SQL и нажмите кнопку Далее. На следующем шаге запрашивается тип создаваемого запроса. Так как мы повторно создаем запрос для добавления новой записи в `Categories` таблицу, выберите Обновить и нажмите кнопку Далее.

[![выбрать параметр обновления](updating-and-deleting-existing-binary-data-vb/_static/image2.png)](updating-and-deleting-existing-binary-data-vb/_static/image1.png)

**Рис. 1**. Выбор параметра обновления ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image3.png))

Теперь необходимо указать инструкцию SQL `UPDATE`. Мастер автоматически предложит инструкцию `UPDATE`, соответствующую основному запросу TableAdapter (один из которых обновляет значения `CategoryName`, `Description`и `BrochurePath`). Измените инструкцию таким образом, чтобы столбец `Picture` был включен вместе с параметром `@Picture`, например следующим образом:

[!code-sql[Main](updating-and-deleting-existing-binary-data-vb/samples/sample1.sql)]

На последнем экране мастера запрашивается имя нового метода TableAdapter. Введите `UpdateWithPicture` и нажмите кнопку Готово.

[![назовите новый метод TableAdapter Упдатевиспиктуре](updating-and-deleting-existing-binary-data-vb/_static/image5.png)](updating-and-deleting-existing-binary-data-vb/_static/image4.png)

**Рис. 2**. Именование нового метода адаптера таблицы `UpdateWithPicture` ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image6.png))

## <a name="step-2-adding-the-business-logic-layer-methods"></a>Шаг 2. Добавление методов уровня бизнес-логики

В дополнение к обновлению DAL необходимо обновить слой BLL, чтобы включить методы для обновления и удаления категорий. Это методы, которые будут вызываться из уровня представления данных.

Для удаления категории можно использовать автоматически созданный метод `CategoriesTableAdapter` s `Delete`. Добавьте в класс `CategoriesBLL` следующий метод:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample2.vb)]

В этом руководстве мы создадим два метода для обновления категории — один, который ожидает двоичные данные изображения и вызывает метод `UpdateWithPicture`, который был только что добавлен в `CategoriesTableAdapter` и другой, который принимает только значения `CategoryName`, `Description`и `BrochurePath` и использует `CategoriesTableAdapter` Class s автоматически созданная инструкция `Update`. Смысл использования двух методов заключается в том, что в некоторых обстоятельствах пользователю может потребоваться обновить изображение категорий вместе с другими полями, в этом случае пользователю нужно будет загрузить новую картинку. Затем в инструкции `UPDATE` можно использовать отправленные двоичные данные изображения s. В других случаях пользователь может заинтересовать только обновление, скажем, имя и описание. Но если инструкция `UPDATE` ожидает для столбца `Picture` двоичные данные, то нам также нужно предоставить эту информацию. Это потребует дополнительного обращения к базе данных, чтобы вернуть данные изображения для редактируемой записи. Поэтому нам нужны два метода `UPDATE`. Уровень бизнес-логики определяет, какой из них будет использоваться в зависимости от того, предоставляются ли данные изображения при обновлении категории.

Чтобы упростить это, добавьте два метода в класс `CategoriesBLL`, с именем `UpdateCategory`. Первый из них должен принимать три `String` s, массив `Byte` и `Integer` как входные параметры; второй, только три `String` s и `Integer`. Входные параметры `String` предназначены для имени категории, описания и пути к файлу брошюры, `Byte` массив предназначен для двоичного содержимого изображения категории s, а `Integer` определяет `CategoryID` обновляемой записи. Обратите внимание, что первая перегрузка вызывает вторую, если переданный `Byte` массив `Nothing`:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample3.vb)]

## <a name="step-3-copying-over-the-insert-and-view-functionality"></a>Шаг 3. копирование функций вставки и просмотра

В [предыдущем учебном курсе](including-a-file-upload-option-when-adding-a-new-record-vb.md) мы создали страницу с именем `UploadInDetailsView.aspx`, в которой перечислены все категории в GridView и предоставлена DetailsView для добавления новых категорий в систему. В этом учебнике мы будем расширять GridView, чтобы включить поддержку редактирования и удаления. Вместо того, чтобы продолжать работу с `UploadInDetailsView.aspx`, давайте поместим в этом руководстве изменения на `UpdatingAndDeleting.aspx` странице из той же папки, `~/BinaryData`. Скопируйте и вставьте декларативную разметку и код из `UploadInDetailsView.aspx` в `UpdatingAndDeleting.aspx`.

Для начала откройте страницу `UploadInDetailsView.aspx`. Скопируйте весь декларативный синтаксис в элемент `<asp:Content>`, как показано на рис. 3. Затем откройте `UpdatingAndDeleting.aspx` и вставьте эту разметку в элемент `<asp:Content>`. Аналогичным образом скопируйте код из класса кода программной части `UploadInDetailsView.aspx` Page s в `UpdatingAndDeleting.aspx`.

[![скопировать декларативную разметку из Уплоадиндетаилсвиев. aspx](updating-and-deleting-existing-binary-data-vb/_static/image8.png)](updating-and-deleting-existing-binary-data-vb/_static/image7.png)

**Рис. 3**. копирование декларативной разметки из `UploadInDetailsView.aspx` ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image9.png))

После копирования декларативной разметки и кода перейдите на `UpdatingAndDeleting.aspx`. Вы увидите те же выходные данные и получите те же результаты, что и на `UploadInDetailsView.aspx` странице из предыдущего руководства.

## <a name="step-4-adding-deleting-support-to-the-objectdatasource-and-gridview"></a>Шаг 4. Добавление поддержки удаления в элемент управления ObjectDataSource и GridView

Как мы обсуждали в [обзоре руководства по вставке, обновлению и удалению данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) , GridView предоставляет встроенные возможности удаления, и эти возможности можно включить в такте флажка, если базовый источник данных Grid поддерживает удаление. В настоящее время элемент управления ObjectDataSource, к которому привязан элемент управления GridView (`CategoriesDataSource`), не поддерживает удаление.

Чтобы устранить эту проблему, щелкните параметр настроить источник данных из смарт-тега ObjectDataSource s, чтобы запустить мастер. На первом экране показано, что ObjectDataSource настроен для работы с классом `CategoriesBLL`. Нажмите кнопку "Далее". В настоящее время указаны только свойства ObjectDataSource `InsertMethod` и `SelectMethod`. Тем не менее мастер автоматически заполняет раскрывающиеся списки на вкладках UPDATE и DELETE с помощью методов `UpdateCategory` и `DeleteCategory` соответственно. Это связано с тем, что в классе `CategoriesBLL` мы отметили эти методы, используя `DataObjectMethodAttribute` как методы по умолчанию для обновления и удаления.

Пока установите в раскрывающемся списке вкладки обновления значение (нет), а в раскрывающемся списке DELETE Tab s — `DeleteCategory`. Мы вернемся к этому мастеру на шаге 6, чтобы добавить поддержку обновления.

[![настроить ObjectDataSource для использования метода Делетекатегори](updating-and-deleting-existing-binary-data-vb/_static/image11.png)](updating-and-deleting-existing-binary-data-vb/_static/image10.png)

**Рис. 4**. Настройка ObjectDataSource для использования метода `DeleteCategory` ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image12.png))

> [!NOTE]
> После завершения работы мастера Visual Studio может запросить обновление полей и ключей, что приведет к повторному формированию полей веб-элементов управления данными. Выберите Нет, так как при нажатии кнопки Да будут перезаписаны все сделанные настройки полей.

Теперь ObjectDataSource будет включать значение свойства `DeleteMethod`, а также `DeleteParameter`. Помните, что при использовании мастера для указания методов, Visual Studio устанавливает свойство ObjectDataSource `OldValuesParameterFormatString` в значение `original_{0}`, что вызывает проблемы с вызовами методов Update и DELETE. Поэтому либо очистите это свойство полностью, либо сбросьте его до значения по умолчанию `{0}`. Если вам нужно обновить память в этом свойстве ObjectDataSource, ознакомьтесь с обзором учебника по [вставке, обновлению и удалению данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) .

После завершения работы мастера и исправления `OldValuesParameterFormatString`декларативная разметка ObjectDataSource s должна выглядеть примерно так, как показано ниже:

[!code-aspx[Main](updating-and-deleting-existing-binary-data-vb/samples/sample4.aspx)]

После настройки элемента управления ObjectDataSource добавьте возможности удаления в GridView, установив флажок Включить удаление из смарт-тега GridView s. Это приведет к добавлению CommandField в GridView, свойство `ShowDeleteButton` которого имеет значение `True`.

[![включить поддержку удаления в GridView](updating-and-deleting-existing-binary-data-vb/_static/image14.png)](updating-and-deleting-existing-binary-data-vb/_static/image13.png)

**Рис. 5**. Включение поддержки удаления в GridView ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image15.png))

Уделите несколько минут тестированию функции удаления. Существует внешний ключ между `Products` таблицей `CategoryID` и `Categories` таблицей `CategoryID`, поэтому при попытке удалить одну из первых восьми категорий возникнет исключение нарушения ограничения внешнего ключа. Чтобы протестировать эту функциональность, добавьте новую категорию, предоставляя как буклет, так и рисунок. Моя Категория тестирования, показанная на рис. 6, содержит тестовый файл буклета с именем `Test.pdf` и тестовый рисунок. На рис. 7 показан элемент управления GridView после добавления категории теста.

[![Добавление категории тестов с помощью буклета и изображения](updating-and-deleting-existing-binary-data-vb/_static/image17.png)](updating-and-deleting-existing-binary-data-vb/_static/image16.png)

**Рис. 6**. Добавление категории тестов с помощью буклета и изображения ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image18.png))

[![после вставки категории тестов он отображается в GridView](updating-and-deleting-existing-binary-data-vb/_static/image20.png)](updating-and-deleting-existing-binary-data-vb/_static/image19.png)

**Рис. 7**. После вставки категории тестов она отображается в GridView ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image21.png))

В Visual Studio Обновите обозреватель решений. Теперь в папке `~/Brochures` должен отобразиться новый файл `Test.pdf` (см. рис. 8).

Затем щелкните ссылку удалить в строке Категория теста, чтобы вызвать обратную передачу страницы и метод `CategoriesBLL` класса `DeleteCategory`. Это вызовет метод DAL `Delete`, который вызывает отправку соответствующей инструкции `DELETE` в базу данных. Затем данные повторно привязываются к GridView, а разметка отправляется обратно клиенту с категорией тестов, которая больше не существует.

Хотя рабочий процесс удаления успешно удалил запись категории теста из таблицы `Categories`, файл брошюры не был удален из файловой системы веб-сервера. Обновите обозреватель решений, и вы увидите, что `Test.pdf` по-прежнему находится в папке `~/Brochures`.

![Файл Test. PDF не был удален из файловой системы веб-сервера](updating-and-deleting-existing-binary-data-vb/_static/image1.gif)

**Рис. 8**. файл `Test.pdf` не был удален из файловой системы веб-сервера

## <a name="step-5-removing-the-deleted-category-s-brochure-file"></a>Шаг 5. Удаление файла брошюры удаленной категории

Одним из недостатков хранения двоичных данных, внешних в базе данных, является необходимость выполнения дополнительных действий для очистки этих файлов при удалении связанной записи базы данных. GridView и ObjectDataSource предоставляют события, которые срабатывают как до, так и после выполнения команды DELETE. Нам действительно нужно создать обработчики событий для событий, выполняемых до и после действия. Перед удалением записи `Categories` необходимо определить путь к PDF-файлу, но мы не хотим удалять PDF-файл перед удалением категории в случае, если есть исключение и категория не удалена.

[Событие`RowDeleting`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleting.aspx) GridView s срабатывает до вызова команды ObjectDataSource s DELETE, в то время как [событие`RowDeleted`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleted.aspx) срабатывает после. Создайте обработчики событий для этих двух событий, используя следующий код:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample5.vb)]

В обработчике событий `RowDeleting` `CategoryID` удаляемой строки извлечена из коллекции GridView s `DataKeys`, которую можно получить в этом обработчике событий через коллекцию `e.Keys`. Затем вызывается `GetCategoryByCategoryID(categoryID)` класса `CategoriesBLL`, чтобы получить сведения об удаляемой записи. Если возвращаемый объект `CategoriesDataRow` имеет значение, отличное от`NULL``BrochurePath`, то оно сохраняется в переменной страницы `deletedCategorysPdfPath`, чтобы файл можно было удалить в обработчике событий `RowDeleted`.

> [!NOTE]
> Вместо того чтобы получать сведения о `BrochurePath` для записи `Categories`, удаляемой в обработчике событий `RowDeleting`, можно было бы добавить `BrochurePath` в свойство GridView s `DataKeyNames` и получить доступ к значению записи s через коллекцию `e.Keys`. Это приведет к незначительному увеличению размера представления GridView s, но уменьшит объем необходимого кода и сохранит поездку в базе данных.

После вызова базовой команды удаления ObjectDataSource s вызывается обработчик событий `RowDeleted` GridView s. Если при удалении данных нет исключений и имеется значение для `deletedCategorysPdfPath`, то PDF-файл будет удален из файловой системы. Обратите внимание, что этот дополнительный код не требуется для очистки двоичных данных категории s, связанных со своим изображением. Так как данные изображения хранятся непосредственно в базе данных, удаление `Categories` строки также приводит к удалению данных из этой категории.

После добавления двух обработчиков событий запустите этот тестовый случай еще раз. При удалении категории также удаляется связанный с ней PDF-файл.

Обновление существующих двоичных данных, связанных с существующими записями, предоставляет некоторые интересные трудности. Оставшаяся часть этого руководства посвящена добавлению возможностей обновления в буклет и фотографию. На шаге 6 рассматриваются методы обновления сведений буклета, а на шаге 7 рассматривается обновление изображения.

## <a name="step-6-updating-a-category-s-brochure"></a>Шаг 6. обновление буклета категории

Как обсуждалось в обзоре руководства по вставке, обновлению и удалению данных, GridView предлагает встроенную поддержку редактирования на уровне строк, которая может быть реализована в такте флажка, если его базовый источник данных настроен соответствующим образом. В настоящее время `CategoriesDataSource` ObjectDataSource еще не настроен на включение поддержки обновления, поэтому добавим его в.

Щелкните ссылку Настроить источник данных в мастере ObjectDataSource s и перейдите к второму шагу. Из-за `DataObjectMethodAttribute`, используемых в `CategoriesBLL`, раскрывающийся список обновлений должен автоматически заполняться перегрузкой `UpdateCategory`, которая принимает четыре входных параметра (для всех столбцов, но `Picture`). Измените этот параметр, чтобы использовать перегрузку с пятью параметрами.

[![настроить ObjectDataSource для использования метода Упдатекатегори, который включает параметр для изображения](updating-and-deleting-existing-binary-data-vb/_static/image23.png)](updating-and-deleting-existing-binary-data-vb/_static/image22.png)

**Рис. 9**. Настройка ObjectDataSource для использования метода `UpdateCategory`, который включает параметр для `Picture` ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image24.png))

Теперь ObjectDataSource будет включать значение свойства `UpdateMethod`, а также соответствующие `UpdateParameter` s. Как указано на шаге 4, Visual Studio устанавливает свойство `OldValuesParameterFormatString` ObjectDataSource s в значение `original_{0}` при использовании мастера настройки источника данных. Это вызовет проблемы с вызовами методов Update и DELETE. Поэтому либо очистите это свойство полностью, либо сбросьте его до значения по умолчанию `{0}`.

После завершения работы мастера и исправления `OldValuesParameterFormatString`декларативная разметка ObjectDataSource s должна выглядеть следующим образом:

[!code-aspx[Main](updating-and-deleting-existing-binary-data-vb/samples/sample6.aspx)]

Чтобы включить встроенные функции редактирования GridView s, установите флажок Включить правку в смарт-теге GridView s. При этом для свойства CommandField `ShowEditButton` s устанавливается значение `True`, что приводит к добавлению кнопки изменить (и кнопкам обновления и отмены для редактируемой строки).

[![настроить GridView для поддержки редактирования](updating-and-deleting-existing-binary-data-vb/_static/image26.png)](updating-and-deleting-existing-binary-data-vb/_static/image25.png)

**Рис. 10**. Настройка элемента управления GridView для поддержки редактирования ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image27.png))

Откройте страницу в браузере и щелкните одну из кнопок редактирования строки. `CategoryName` и `Description` BoundFields подготавливаются как текстовые поля. `BrochurePath` TemplateField не имеет `EditItemTemplate`, поэтому он по-своему `ItemTemplate` ссылку на буклет. `Picture` Имажефиелд готовится к просмотру как текстовое поле, `Text` свойству присваивается значение `DataImageUrlField` Имажефиелд s, в данном случае `CategoryID`.

[![GridView не имеет интерфейса редактирования для Брочурепас](updating-and-deleting-existing-binary-data-vb/_static/image29.png)](updating-and-deleting-existing-binary-data-vb/_static/image28.png)

**Рис. 11**. в GridView отсутствует интерфейс редактирования для `BrochurePath` ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image30.png))

## <a name="customizing-thebrochurepaths-editing-interface"></a>Настройка интерфейса редактирования`BrochurePath`s

Необходимо создать интерфейс редактирования для `BrochurePath` TemplateField, который позволяет пользователю:

- Оставьте буклет категории "как есть",
- Обновление буклета Category с помощью отправки новой брошюры или
- Полностью удалите буклет Category (категория) (в случае, если категория больше не имеет связанной брошюры).

Также необходимо обновить интерфейс редактирования `Picture` Имажефиелд s, но мы покажем это на шаге 7.

Из смарт-тега GridView s щелкните ссылку Edit Templates (изменить шаблоны) и выберите `BrochurePath` TemplateField s `EditItemTemplate` из раскрывающегося списка. Добавьте в этот шаблон веб-элемент управления RadioButtonList, задав для его свойства `ID` значение `BrochureOptions` а свойству `AutoPostBack` — значение `True`. На окно свойств щелкните многоточие в свойстве `Items`, чтобы открыть редактор коллекции `ListItem`. Добавьте следующие три параметра с `Value` s 1, 2 и 3 соответственно:

- Использовать текущий буклет
- Удалить текущую буклет
- Отправить новую брошюру

Задайте для свойства First `ListItem` s `Selected` значение `True`.

![Добавление трех ListItem в RadioButtonList](updating-and-deleting-existing-binary-data-vb/_static/image2.gif)

**Рис. 12**. добавление трех `ListItem` s в RadioButtonList

Под названием RadioButtonList добавьте элемент управления FileUpload с именем `BrochureUpload`. Задайте для свойства `Visible` значение `False`.

[![добавить элемент управления RadioButtonList и FileUpload в EditItemTemplate](updating-and-deleting-existing-binary-data-vb/_static/image32.png)](updating-and-deleting-existing-binary-data-vb/_static/image31.png)

**Рис. 13**. Добавление элемента управления RadioButtonList и FileUpload в `EditItemTemplate` ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image33.png))

Этот RadioButtonList предоставляет три варианта для пользователя. Идея состоит в том, что элемент управления FileUpload будет отображаться только в том случае, если выбран последний параметр Отправить новую брошюру. Для этого создайте обработчик событий для события `SelectedIndexChanged` RadioButtonList s и добавьте следующий код:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample7.vb)]

Поскольку элементы управления RadioButtonList и FileUpload находятся в шаблоне, нам нужно написать немного кода для программного доступа к этим элементам управления. Обработчику `SelectedIndexChanged` событий передается ссылка на RadioButtonList в входном параметре `sender`. Чтобы получить элемент управления FileUpload, необходимо получить родительский элемент управления RadioButtonList s и использовать в нем метод `FindControl("controlID")`. После того как у нас есть ссылка на элементы управления RadioButtonList и FileUpload, свойство `Visible` элемента управления FileUpload имеет значение `True` только в том случае, если RadioButtonList s `SelectedValue` равно 3, то есть `Value` для нового буклета upload `ListItem`.

Используя этот код, уделите немного времени тестированию интерфейса правки. Нажмите кнопку изменить для строки. Изначально должен быть выбран параметр использовать текущий буклет. Изменение выбранного индекса вызывает обратную передачу. Если выбран третий параметр, элемент управления FileUpload отображается, в противном случае он является скрытым. На рис. 14 показан интерфейс правки при первом нажатии кнопки «изменить»; На рис. 15 показан интерфейс после выбора параметра отправить новый буклет.

[![изначально выбран параметр использовать текущую буклет.](updating-and-deleting-existing-binary-data-vb/_static/image35.png)](updating-and-deleting-existing-binary-data-vb/_static/image34.png)

**Рис. 14**. изначально выбран параметр использовать текущую буклет ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image36.png)).

[![выборе параметра Отправить новую брошюру отображается элемент управления FileUpload.](updating-and-deleting-existing-binary-data-vb/_static/image38.png)](updating-and-deleting-existing-binary-data-vb/_static/image37.png)

**Рис. 15**. при выборе параметра Отправить новую брошюру отображается элемент управления FileUpload ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image39.png))

## <a name="saving-the-brochure-file-and-updating-thebrochurepathcolumn"></a>Сохранение файла буклета и обновление столбца`BrochurePath`

При нажатии кнопки "Обновить" GridView s срабатывает `RowUpdating` событие. Вызовите команду ObjectDataSource s Update, после чего срабатывает событие `RowUpdated` GridView s. Как и при удалении рабочего процесса, необходимо создать обработчики событий для обоих этих событий. В обработчике событий `RowUpdating` необходимо определить, какое действие следует предпринять в зависимости от `SelectedValue` `BrochureOptions` RadioButtonList:

- Если `SelectedValue` равен 1, мы хотим использовать тот же параметр `BrochurePath`. Поэтому необходимо установить параметр `brochurePath` ObjectDataSource s в существующее `BrochurePath` значение обновляемой записи. Параметр `brochurePath` ObjectDataSource s можно задать с помощью `e.NewValues["brochurePath"] = value`.
- Если `SelectedValue` имеет значение 2, необходимо задать `BrochurePath` записи для значения `NULL`. Это можно сделать, присвоив параметру ObjectDataSource `brochurePath` значение `Nothing`, в результате чего `NULL` базы данных будет использоваться в инструкции `UPDATE`. Если удаляется существующий файл буклета, необходимо удалить существующий файл. Однако мы хотим сделать это только в том случае, если обновление завершается без возникновения исключения.
- Если `SelectedValue` равен 3, мы хотим убедиться, что пользователь передал PDF-файл, а затем сохранил его в файловой системе и изменил значение столбца записей `BrochurePath`. Более того, если имеется существующий файл буклета, который заменяется, необходимо удалить предыдущий файл. Однако мы хотим сделать это только в том случае, если обновление завершается без возникновения исключения.

Действия, которые необходимо выполнить, когда RadioButtonList s `SelectedValue` имеет значение 3, практически идентичны тем, которые используются обработчиком событий DetailsView s `ItemInserting`. Этот обработчик событий выполняется при добавлении новой записи категории из элемента управления DetailsView, добавленного в [предыдущем руководстве](including-a-file-upload-option-when-adding-a-new-record-vb.md). Таким образом, мы наполнения, что эти функции можно оптимизировать в отдельные методы. В частности, я переместил общую функциональность на два метода:

- `ProcessBrochureUpload(FileUpload, out bool)` принимает в качестве входных данных экземпляр элемента управления FileUpload и выходное логическое значение, которое указывает, следует ли продолжать операцию удаления или изменения или отменить ее из-за ошибки проверки. Этот метод возвращает путь к сохраненному файлу или `null`, если файл не был сохранен.
- `DeleteRememberedBrochurePath` удаляет файл, указанный в пути в переменной страницы, `deletedCategorysPdfPath` если `deletedCategorysPdfPath` не `null`.

Ниже приведен код для этих двух методов. Обратите внимание на сходство между `ProcessBrochureUpload` и обработчиком событий DetailsView s `ItemInserting` из предыдущего руководства. В этом руководстве я обновил обработчики событий DetailsView s для использования этих новых методов. Скачайте код, связанный с этим руководством, чтобы увидеть изменения в обработчиках событий DetailsView s.

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample8.vb)]

Обработчики событий GridView `RowUpdating` и `RowUpdated` используют методы `ProcessBrochureUpload` и `DeleteRememberedBrochurePath`, как показано в следующем коде:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample9.vb)]

Обратите внимание, что обработчик событий `RowUpdating` использует ряд условных операторов для выполнения соответствующего действия на основе значения свойства `BrochureOptions` RadioButtonList s `SelectedValue`.

Используя этот код, можно изменить категорию и использовать ее текущий буклет, не использовать буклет или передать новую. Попробуйте. Задайте точки останова в обработчиках событий `RowUpdating` и `RowUpdated`, чтобы получить представление о рабочем процессе.

## <a name="step-7-uploading-a-new-picture"></a>Шаг 7. Отправка нового изображения

Интерфейс редактирования `Picture` Имажефиелд s отображается как текстовое поле, заполненное значением из его свойства `DataImageUrlField`. Во время рабочего процесса редактирования GridView передает параметр ObjectDataSource с параметром s, а значение свойства `DataImageUrlField` Имажефиелд s и значением параметра s, которое было указано в текстовом поле в интерфейсе правки. Такое поведение подходит при сохранении образа в виде файла в файловой системе, а `DataImageUrlField` содержит полный URL-адрес изображения. В таких обстоятельствах интерфейс правки отображает URL-адрес изображения в текстовом поле, которое пользователь может изменить и сохранить обратно в базу данных. Разумеется, этот интерфейс по умолчанию не разрешает пользователю отправлять новый образ, но позволяет им изменять URL-адрес изображения с текущего на другое. Однако в этом руководстве интерфейс редактирования по умолчанию Имажефиелд s недостаточен, поскольку `Picture` двоичные данные хранятся непосредственно в базе данных, а свойство `DataImageUrlField` содержит только `CategoryID`.

Чтобы лучше понять, что происходит в нашем руководстве, когда пользователь редактирует строку с помощью Имажефиелд, рассмотрим следующий пример: пользователь редактирует строку с `CategoryID` 10, что приводит к отображению `Picture` Имажефиелд в виде текстового поля со значением 10. Представьте, что пользователь изменяет значение в этом текстовом поле на 50 и нажимает кнопку Обновить. Выполняется обратная передача, и GridView изначально создает параметр с именем `CategoryID` со значением 50. Однако прежде чем элемент управления GridView отправит этот параметр (и параметры `CategoryName` и `Description`), он добавляет значения из коллекции `DataKeys`. Таким образом, параметр `CategoryID` будет перезаписан с базовым `CategoryID`ом текущей строки, равном 10. Коротко говоря, интерфейс редактирования Имажефиелд s не влияет на рабочий процесс редактирования для этого руководства, так как имена Имажефиелд `DataImageUrlField` свойства, а `DataKey` Grid имеют одно и то же значение.

Хотя Имажефиелд упрощает отображение изображения на основе данных базы данных, нам не нужно предоставлять текстовое поле в интерфейсе редактирования. Вместо этого мы хотим предложить элемент управления FileUpload, который конечный пользователь может использовать для изменения изображения категории. В отличие от значения `BrochurePath`, в этих учебных курсах мы решили потребовать, чтобы каждая категория соимела изображение. Поэтому нам не нужно, чтобы пользователь указал, что отсутствует связанный рисунок пользователь может либо отправить новую картинку, либо оставить текущее изображение без изменений.

Чтобы настроить интерфейс редактирования Имажефиелд s, необходимо преобразовать его в TemplateField. Из смарт-тега GridView s щелкните ссылку Edit Columns (изменить столбцы), выберите Имажефиелд и щелкните преобразовать это поле в ссылку TemplateField.

![Преобразование Имажефиелд в TemplateField](updating-and-deleting-existing-binary-data-vb/_static/image3.gif)

**Рис. 16**. Преобразование Имажефиелд в TemplateField

Таким образом, преобразование Имажефиелд в TemplateField создает TemplateField с двумя шаблонами. Как показано в следующем декларативном синтаксисе, `ItemTemplate` содержит веб-элемент управления Image, свойство `ImageUrl` которого назначается с помощью синтаксиса DataBinding, основанного на свойствах `DataImageUrlField` и `DataImageUrlFormatString` Имажефиелд s. `EditItemTemplate` содержит текстовое поле, свойство `Text` которого привязано к значению, заданному свойством `DataImageUrlField`.

[!code-aspx[Main](updating-and-deleting-existing-binary-data-vb/samples/sample10.aspx)]

Чтобы использовать элемент управления FileUpload, необходимо обновить `EditItemTemplate`. Из смарт-тега GridView s щелкните ссылку Edit Templates (изменить шаблоны), а затем выберите `Picture` TemplateField s `EditItemTemplate` из раскрывающегося списка. В шаблоне вы увидите текстовое поле, чтобы удалить это окно. Затем перетащите элемент управления FileUpload из области элементов в шаблон, установив для его `ID` значение `PictureUpload`. Кроме того, добавьте текст для изменения рисунка категорий, указав новое изображение. Чтобы изображение категории s совпадало, оставьте поле пустым в шаблоне.

[![добавить элемент управления FileUpload в EditItemTemplate](updating-and-deleting-existing-binary-data-vb/_static/image41.png)](updating-and-deleting-existing-binary-data-vb/_static/image40.png)

**Рис. 17**. Добавление элемента управления FileUpload в `EditItemTemplate` ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image42.png))

После настройки интерфейса редактирования просматривайте ход выполнения в браузере. При просмотре строки в режиме "только чтение" изображение Category отображается, как и ранее, но нажатие кнопки "Изменить" приводит к отображению столбца "Рисунок" в виде текста с элементом управления FileUpload.

[![интерфейс редактирования содержит элемент управления FileUpload](updating-and-deleting-existing-binary-data-vb/_static/image44.png)](updating-and-deleting-existing-binary-data-vb/_static/image43.png)

**Рис. 18**. интерфейс правки содержит элемент управления FileUpload ([щелкните, чтобы просмотреть изображение с полным размером](updating-and-deleting-existing-binary-data-vb/_static/image45.png))

Вспомним, что ObjectDataSource настроен на вызов метода `CategoriesBLL` класса `UpdateCategory`, который принимает в качестве входных данных двоичные данные для изображения в виде массива `Byte`. Однако если этот массив имеет `Nothing`, вызывается альтернативная перегрузка `UpdateCategory`, которая выдает инструкцию `UPDATE` SQL, которая не изменяет столбец `Picture`, тем самым оставив текущее изображение категории s неизменным. Таким образом, в обработчике событий GridView s `RowUpdating` необходимо программно ссылаться на элемент управления `PictureUpload` FileUpload и определить, передан ли файл. Если он не был передан, мы *не* хотим указывать значение для параметра `picture`. С другой стороны, если файл был передан в элемент управления `PictureUpload` FileUpload, мы хотим убедиться, что это файл JPG. Если это так, мы можем отправить его двоичное содержимое в ObjectDataSource через параметр `picture`.

Как и в случае с кодом, используемым на шаге 6, часть кода, необходимая здесь, уже существует в обработчике событий DetailsView `ItemInserting`. Поэтому мы выполнили рефакторинг общих функций в новом методе, `ValidPictureUpload`и обновили обработчик событий `ItemInserting` для использования этого метода.

Добавьте следующий код в начало обработчика событий `RowUpdating` GridView s. Важно, чтобы этот код наступил перед кодом, который сохраняет файл буклета, так как мы не хотим сохранять буклет в файловой системе веб-сервера, если передан недопустимый файл изображения.

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample11.vb)]

Метод `ValidPictureUpload(FileUpload)` принимает в качестве единственного входного параметра элемент управления FileUpload и проверяет отправленное расширение файла, чтобы убедиться, что переданный файл является JPG; Он вызывается только при передаче файла изображения. Если файл не передается, параметр Picture не задается и, следовательно, использует значение по умолчанию `Nothing`. Если изображение было отправлено и `ValidPictureUpload` возвращает `True`, параметру `picture` присваивается двоичные данные отправленного изображения. Если метод возвращает `False`, Рабочий процесс обновления отменяется и обработчик событий завершает работу.

Код метода `ValidPictureUpload(FileUpload)`, который был рефакторингом из обработчика событий DetailsView s `ItemInserting`, выглядит следующим образом:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample12.vb)]

## <a name="step-8-replacing-the-original-categories-pictures-with-jpgs"></a>Шаг 8. замена исходных категорий рисунками Жпгс

Вспомним, что исходные восемь категорий — это файлы точечных рисунков, Упакованные в заголовок OLE. Теперь, когда мы добавили возможность изменения существующего изображения записи, уделите немного времени, чтобы заменить эти точечные рисунки на Жпгс. Если вы хотите продолжить использовать изображения текущей категории, их можно преобразовать в Жпгс, выполнив следующие действия:

1. Сохраните точечные рисунки на жестком диске. Перейдите на страницу `UpdatingAndDeleting.aspx` в браузере и для каждой из восьми категорий щелкните изображение правой кнопкой мыши и выберите сохранить изображение.
2. Откройте изображение в любом редакторе изображений. Например, можно использовать Microsoft Paint.
3. Сохраните точечный рисунок как изображение в формате JPG.
4. Обновите изображение категории с помощью интерфейса редактирования, используя файл JPG.

После изменения категории и передачи изображения JPG изображение не будет отображаться в браузере, так как `DisplayCategoryPicture.aspx` страница удаляет первые 78 байт из изображений первых восьми категорий. Исправьте это, удалив код, который выполняет отбрасывания заголовка OLE. После этого обработчик событий `DisplayCategoryPicture.aspx``Page_Load` должен иметь только следующий код:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample13.vb)]

> [!NOTE]
> Интерфейсы вставки и редактирования `UpdatingAndDeleting.aspx` страниц могут использовать немного больше работы. `CategoryName` и `Description` BoundFields в DetailsView и GridView должны быть преобразованы в полей TemplateField. Поскольку `CategoryName` не допускает `NULL` значений, необходимо добавить RequiredFieldValidator. И текстовое поле `Description`, возможно, будет преобразовано в многострочное текстовое поле. Я оставлю эти заключительные штрихи в качестве упражнения.

## <a name="summary"></a>Сводка

В этом руководстве мы рассмотрим работу с двоичными данными. В этом руководстве и предыдущих трех примерах мы увидели, как двоичные данные могут храниться в файловой системе или непосредственно в базе данных. Пользователь предоставляет системе двоичные данные, выбирая файл с жесткого диска и отгружая его на веб-сервер, где он может храниться в файловой системе или вставляться в базу данных. ASP.NET 2,0 включает элемент управления FileUpload, который предоставляет такой интерфейс простым перетаскиванием. Однако, как отмечалось в руководстве по [отправке файлов](uploading-files-vb.md) , элемент управления FileUpload хорошо подходит для относительно небольших отправок файлов, в идеале не превышающий мегабайт. Мы также изучили, как связать загруженные данные с базовой моделью данных, а также как изменять и удалять двоичные данные из существующих записей.

Следующий набор руководств посвящен различным методам кэширования. Кэширование предоставляет средства для повышения общей производительности приложения, получая результаты ресурсоемких операций и сохраняя их в расположении, доступном для быстрого доступа.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Специалист по интересу для этого руководства был Терезой Мерфи. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](including-a-file-upload-option-when-adding-a-new-record-vb.md)
