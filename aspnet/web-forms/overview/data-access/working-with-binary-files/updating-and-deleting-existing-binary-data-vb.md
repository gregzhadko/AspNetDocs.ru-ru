---
uid: web-forms/overview/data-access/working-with-binary-files/updating-and-deleting-existing-binary-data-vb
title: Обновление и удаление существующих двоичных данных (Visual Basic) | Документация Майкрософт
author: rick-anderson
description: В предыдущих учебных курсах мы видели, как элемент управления GridView позволяет легко изменять и удалять текстовые данные. В этом руководстве мы видим, как элемент управления GridView также, чтобы...
ms.author: riande
ms.date: 03/27/2007
ms.assetid: 3a052ced-9cf5-47b8-a400-934f0b687c26
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/updating-and-deleting-existing-binary-data-vb
msc.type: authoredcontent
ms.openlocfilehash: ac38123e1acb8188648019d67423bd6452690b6c
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65114788"
---
# <a name="updating-and-deleting-existing-binary-data-vb"></a>Обновление и удаление существующих двоичных данных (VB)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачайте пример приложения](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_57_VB.exe) или [скачать PDF](updating-and-deleting-existing-binary-data-vb/_static/datatutorial57vb1.pdf)

> В предыдущих учебных курсах мы видели, как элемент управления GridView позволяет легко изменять и удалять текстовые данные. В этом руководстве мы видим, как элемент управления GridView также делает возможным изменение и удаление двоичных данных, эти двоичные данные сохранены в базе данных, или хранящихся в файловой системе.

## <a name="introduction"></a>Вступление

На предыдущих трех учебных курсах мы добавили совсем немного функциональные возможности для работы с двоичными данными. Мы начали, добавив `BrochurePath` столбец `Categories` таблицы и соответствующим образом обновлено архитектуры. Мы также добавили уровня доступа к данным и бизнес-логики методы для работы с существующим категории таблицы s `Picture` столбец, который содержит двоичные s содержимого файла изображения. Мы разработали веб-страниц для представления двоичных данных в элементе управления GridView ссылку для скачивания для брошюры, показано на рисунке категории s `<img>` элемент и добавили в элементе управления DetailsView, чтобы пользователи могли добавить новую категорию и отправить свои данные брошюры и изображение.

Все, что реализовать остается возможность изменять и удалять существующие категории, которые мы займемся в этом руководстве с помощью GridView s встроенные редактирование и удаление компонентов. При изменении категории, пользователь будет возможность при необходимости Отправьте новое изображение или относятся к категории продолжать использовать существующий. Для брошюры либо можно использовать существующие брошюры, для передачи нового буклета или указать, что категории больше не имеет буклета, связанные с ней. Позвольте s приступить к работе!

## <a name="step-1-updating-the-data-access-layer"></a>Шаг 1. Обновление уровня доступа к данным

DAL создан `Insert`, `Update`, и `Delete` методы, но эти методы были созданы на основе `CategoriesTableAdapter` s основного запроса, который не содержит `Picture` столбца. Таким образом `Insert` и `Update` методы не используйте параметры для указания двоичные данные изображения категории s. Как это делалось [предыдущем учебном курсе](including-a-file-upload-option-when-adding-a-new-record-vb.md), нам необходимо создать новый метод TableAdapter для обновления `Categories` таблице при указании двоичных данных.

Откройте типизированный набор DataSet и в режиме конструктора щелкните правой кнопкой мыши `CategoriesTableAdapter` s заголовка и выберите Добавить запрос в контекстном меню, чтобы запустить мастер настройки запроса адаптера таблицы. Этот мастер начинается с вопросом, как запроса адаптера таблицы должен получить доступ к базе данных. Выберите использовать инструкции SQL и нажмите кнопку Далее. Следующий шаг загрузчика для типа запроса. Так как мы повторно создав запрос, чтобы добавить новую запись для `Categories` таблицы, выберите обновление и нажмите кнопку Далее.

[![Выберите параметр обновления](updating-and-deleting-existing-binary-data-vb/_static/image2.png)](updating-and-deleting-existing-binary-data-vb/_static/image1.png)

**Рис. 1**: Выберите параметр обновления ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image3.png))

Теперь нам нужно указать `UPDATE` инструкции SQL. Мастер установки автоматически предлагает `UPDATE` инструкции, соответствующий основного запроса адаптера таблицы s (тот, который обновляет `CategoryName`, `Description`, и `BrochurePath` значения). Измените инструкцию таким образом, чтобы `Picture` столбец входит в состав вдоль `@Picture` параметра, следующим образом:

[!code-sql[Main](updating-and-deleting-existing-binary-data-vb/samples/sample1.sql)]

На последнем экране мастера появляется запрос на имя нового метода адаптера таблицы. Введите `UpdateWithPicture` и нажмите кнопку Готово.

[![Имя нового UpdateWithPicture метод адаптера таблицы](updating-and-deleting-existing-binary-data-vb/_static/image5.png)](updating-and-deleting-existing-binary-data-vb/_static/image4.png)

**Рис. 2**: Назовите новый метод TableAdapter `UpdateWithPicture` ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image6.png))

## <a name="step-2-adding-the-business-logic-layer-methods"></a>Шаг 2. Добавление методов бизнес-логики слоя

Помимо обновления DAL, нам нужно обновить BLL для включения методов для обновления и удаления категории. Это методы, которые будут вызываться из слоя представления.

Для удаления категории, можно использовать `CategoriesTableAdapter` s автоматически генерируемым `Delete` метод. Добавьте следующий метод в `CategoriesBLL` класса:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample2.vb)]

Для этого руководства позволяют s создайте два метода для обновления категория - ожидает, что рисунок двоичных данных и вызывает `UpdateWithPicture` мы только что добавили в метод `CategoriesTableAdapter` и еще одно, которое принимает только `CategoryName`, `Description`и `BrochurePath`значения и использует `CategoriesTableAdapter` класс автоматически генерируемым s `Update` инструкции. Обоснование с помощью двух методов — это, в некоторых случаях пользователь может потребоваться обновление рисунка s категории вместе с его другие поля, в которых случае пользователь будет иметь для отправки нового изображения. Затем отправленный рисунок s двоичные данные можно использовать в `UPDATE` инструкции. В других случаях пользователь может быть заинтересован только в обновление, скажем, имя и описание. Но если `UPDATE` инструкция ожидает, что двоичные данные для `Picture` также столбец, а затем мы d необходимо предоставить подобных сведений. Это потребует дополнительный проход в базу данных, чтобы вернуть данные изображения для редактируемой записи. Таким образом, мы хотим два `UPDATE` методы. Уровня бизнес-логики определит, какой из них следует использовать основании предоставляется ли изображение данных при обновлении категории.

Для этого добавьте два метода в `CategoriesBLL` класса, оба с именем `UpdateCategory`. Первый из них должна принимать три `String` s, `Byte` массива и `Integer` в качестве входных данных параметров; второй, только три экземпляра `String` s и `Integer`. `String` Входные параметры являются имя категории s, описание и путь к файлу буклета, `Byte` массив предназначен для двоичного содержимого рисунка категории s и `Integer` идентифицирует `CategoryID` записи для обновления. Обратите внимание на то, что первая перегрузка вызывает секунды, если переданный `Byte` массив является `Nothing`:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample3.vb)]

## <a name="step-3-copying-over-the-insert-and-view-functionality"></a>Шаг 3. Копирование через вставки и функциональные возможности представления

В [предыдущем учебном курсе](including-a-file-upload-option-when-adding-a-new-record-vb.md) мы создали страницу с именем `UploadInDetailsView.aspx` , перечислены все категории в элементе управления GridView и предоставляемые DetailsView для добавления новых категорий в систему. В этом руководстве мы расширить GridView для включения поддержки правки и удаления. Вместо того чтобы продолжать работать с `UploadInDetailsView.aspx`, позволяют s вместо поместить этот учебник s изменения в `UpdatingAndDeleting.aspx` страницы из той же папки `~/BinaryData`. Скопируйте декларативную разметку и код из `UploadInDetailsView.aspx` для `UpdatingAndDeleting.aspx`.

Сначала откройте `UploadInDetailsView.aspx` страницы. Скопируйте все декларативный синтаксис внутри `<asp:Content>` элемента, как показано на рис. 3. Затем откройте `UpdatingAndDeleting.aspx` и вставьте эту разметку в его `<asp:Content>` элемент. Аналогичным образом, скопируйте код из `UploadInDetailsView.aspx` странице s вспомогательного класса для `UpdatingAndDeleting.aspx`.

[![Копирование из UploadInDetailsView.aspx декларативная разметка](updating-and-deleting-existing-binary-data-vb/_static/image8.png)](updating-and-deleting-existing-binary-data-vb/_static/image7.png)

**Рис. 3**: Скопируйте декларативную разметку из `UploadInDetailsView.aspx` ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image9.png))

После копирования декларативную разметку и код, посетите `UpdatingAndDeleting.aspx`. Вы увидите те же выходные данные и работать в аналогичном интерфейсе пользователя как в случае с `UploadInDetailsView.aspx` страницы из предыдущего учебника.

## <a name="step-4-adding-deleting-support-to-the-objectdatasource-and-gridview"></a>Шаг 4. Добавление, удаление поддержки, чтобы элемент управления ObjectDataSource и GridView

Как уже говорилось в [Обзор Вставка, обновление и удаление данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) руководстве элемент GridView предоставляет встроенные возможности удаления и эти возможности можно включить на такта флажок, если основной сетки s источник данных поддерживает удаление. В настоящее время элемент управления ObjectDataSource, с которым связан элемент GridView (`CategoriesDataSource`) не поддерживает удаление.

Чтобы исправить это, щелкните пункт Настройка источника данных в смарт-теге ObjectDataSource s, чтобы запустить мастер. Первая страница рассказывает, что элемент управления ObjectDataSource настроен для работы с `CategoriesBLL` класса. Нажмите "Далее". В настоящее время только ObjectDataSource s `InsertMethod` и `SelectMethod` указаны свойства. Тем не менее, мастер автоматически заполняемая раскрывающихся списках на вкладках UPDATE и DELETE с `UpdateCategory` и `DeleteCategory` методы, соответственно. Это обусловлено в `CategoriesBLL` класса, мы помеченного эти методы, с помощью `DataObjectMethodAttribute` как методы по умолчанию для обновления и удаления.

Пока задать раскрывающемся списке вкладки s обновления (нет), но оставьте раскрывающемся списке вкладки s DELETE, равным `DeleteCategory`. Мы вернемся к этот мастер на шаге 6, чтобы добавить поддержку обновления.

[![Настройка ObjectDataSource на использование метода DeleteCategory](updating-and-deleting-existing-binary-data-vb/_static/image11.png)](updating-and-deleting-existing-binary-data-vb/_static/image10.png)

**Рис. 4**: Настройка ObjectDataSource для использования `DeleteCategory` метод ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image12.png))

> [!NOTE]
> После завершения работы мастера, Visual Studio может потребоваться, если вы хотите обновить поля и ключи, что приведет к повторному созданию данных Web управляет поля. Выберите "Нет", поскольку Выбор Да перезапишет изменения поля, которые могли быть внесены.

Элемент управления ObjectDataSource теперь будет включать значение для его `DeleteMethod` свойства, а также `DeleteParameter`. Помните, что при использовании мастера для указания методов, Visual Studio задает ObjectDataSource s `OldValuesParameterFormatString` свойства `original_{0}`, которых вызывает проблемы с обновления и удаления вызовов методов. Таким образом, либо полностью очистить это свойство или выполнить его сброс до по умолчанию, `{0}`. Если вам нужно обновить свою память для этого свойства элемент управления ObjectDataSource, см. в разделе [Обзор Вставка, обновление и удаление данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) руководства.

После завершения работы мастера и исправления `OldValuesParameterFormatString`, декларативная разметка ObjectDataSource s должна выглядеть следующим образом:

[!code-aspx[Main](updating-and-deleting-existing-binary-data-vb/samples/sample4.aspx)]

После настройки ObjectDataSource, добавьте Удаление возможностей удаления к элементу GridView, установив флажок Разрешить удаление в смарт-теге GridView s. Это добавит поле CommandField к GridView, `ShowDeleteButton` свойству `True`.

[![Включить поддержку удаления в GridView](updating-and-deleting-existing-binary-data-vb/_static/image14.png)](updating-and-deleting-existing-binary-data-vb/_static/image13.png)

**Рис. 5**: Включите поддержку удаления в GridView ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image15.png))

Отвлекитесь и проверьте его функции удаления. Нет внешнего ключа между `Products` таблицы s `CategoryID` и `Categories` таблицы s `CategoryID`, поэтому вы получите исключение нарушения ограничения внешнего ключа, если вы попытаетесь удалить любую из первых восьми категорий. Чтобы протестировать эту функцию, out, добавьте новую категорию, предоставляя брошюры и изображение. Моя Категория теста показано на рис. 6 включает в себя буклет тестовый файл с именем `Test.pdf` и пробного рисунка. Рис. 7 показан элемент управления GridView после добавления категории теста.

[![Добавить категорию с брошюры и изображением](updating-and-deleting-existing-binary-data-vb/_static/image17.png)](updating-and-deleting-existing-binary-data-vb/_static/image16.png)

**Рис. 6**: Добавить категорию с брошюры и изображением ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image18.png))

[![После вставки категорию теста, она появится в GridView](updating-and-deleting-existing-binary-data-vb/_static/image20.png)](updating-and-deleting-existing-binary-data-vb/_static/image19.png)

**Рис. 7**: После вставки категорию теста, она появится в GridView ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image21.png))

В Visual Studio обновите в обозревателе решений. Теперь вы увидите новый файл в `~/Brochures` папке `Test.pdf` (см. рис. 8).

Затем щелкните ссылку «Удалить» в строке категории тестов обратной передачи страницы и `CategoriesBLL` класс s `DeleteCategory` метод срабатывание. Это вызовет DAL s `Delete` методом, выполняемым соответствующий `DELETE` инструкции, отправляемые в базу данных. Данных затем привязывается к GridView и разметку отправляется обратно клиенту с категорией теста больше нет.

Хотя рабочий процесс удаления успешно удалена запись категории тестов из `Categories` таблицы, не удалялись его буклет файл из файловой системы web server s. Обновите в обозревателе решений и вы увидите, что `Test.pdf` по-прежнему находится в `~/Brochures` папку.

![Файл Test.pdf не удален из файловой системы s Web Server](updating-and-deleting-existing-binary-data-vb/_static/image1.gif)

**Рис. 8**: `Test.pdf` Файл не был удален из файловой системы Web Server s

## <a name="step-5-removing-the-deleted-category-s-brochure-file"></a>Шаг 5. Удаление файла буклет удаленные категории s

Одним из недостатков хранения двоичных данных, внешних по отношению к базе данных является, что для очистки этих файлов при удалении записи связанной базы данных необходимо выполнить дополнительные шаги. GridView и ObjectDataSource предоставления событий, которые запускаются до и после выполнения команды delete. Фактически нам нужно создавать обработчики событий для события до и после действия. Прежде чем `Categories` удалении записи нужно определить пути к файлу s PDF-ФАЙЛ, но мы кое t, необходимо удалить в формате PDF, перед удалением категории в случае, если некоторые исключения и категории не удаляется.

GridView s [ `RowDeleting` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleting.aspx) активируется до команды delete s ObjectDataSource был вызван, пока его [ `RowDeleted` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.rowdeleted.aspx) срабатывает после. Создание обработчиков событий для этих двух событий, используя следующий код:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample5.vb)]

В `RowDeleting` обработчик событий `CategoryID` строки удаляется извлечен из GridView s `DataKeys` коллекции, к которому можно получить в этом обработчике событий через `e.Keys` коллекции. Далее, `CategoriesBLL` класс s `GetCategoryByCategoryID(categoryID)` вызывается для возвращения сведений о записи, удаляемой. Если возвращенный `CategoriesDataRow` объект имеет отличный от`NULL``BrochurePath` значение, а затем сохраняется в переменной страницы `deletedCategorysPdfPath` , чтобы можно было удалить файл в `RowDeleted` обработчик событий.

> [!NOTE]
> Вместо того чтобы получение `BrochurePath` подробные данные об `Categories` записи удаления в `RowDeleting` обработчик событий может также добавлена `BrochurePath` к GridView s `DataKeyNames` свойство доступ к ним значения записи s через `e.Keys` коллекции. Это будет немного увеличить размер состояния представления s GridView, но будет сократить код, необходимый и сохранить данные о поездке в базу данных.

После вызова базовой команды delete s ObjectDataSource GridView s `RowDeleted` срабатывает. Если не было исключений в удаления данных, а значение для `deletedCategorysPdfPath`, а затем PDF-ФАЙЛ удаляется из файловой системы. Обратите внимание на то, что этот дополнительный код не требуется для очистки категории s двоичные данные, связанные с свое изображение. S, так как данные изображения хранятся непосредственно в базе данных, поэтому удаление `Categories` строки также удаляет эти данные категории s рисунка.

Когда вы добавите два обработчика событий, снова запустите этот тестовый случай. При удалении категории, также удаляется его связанные PDF.

Обновление существующих двоичных данных записи, связанные предоставляет некоторые интересные задачи. Оставшейся части этого руководства углубляется в добавления возможностей обновления брошюры и изображение. Шаг 6 исследует способы обновления сведений о буклета, хотя рассматривает обновление рисунок шаг 7.

## <a name="step-6-updating-a-category-s-brochure"></a>Шаг 6. Обновление буклета категории s

Как описано в руководстве Обзор Вставка, обновление и удаление данных, GridView предоставляет встроенную поддержку редактирования на уровне строк, который может быть реализован такта флажок, если в источнике данных настроен соответствующим образом. В настоящее время `CategoriesDataSource` ObjectDataSource еще не настроен для включения обновление поддержки, поэтому s позволяют добавить в.

Щелкните ссылку Настройка источника данных с помощью мастера ObjectDataSource s и перейдите ко второму шагу. Из-за `DataObjectMethodAttribute` используется в `CategoriesBLL`, стрелку раскрывающегося списка обновления должны автоматически заполняться `UpdateCategory` перегрузку, которая принимает четыре входных параметра (для всех столбцов, но `Picture`). Это измените, чтобы он использовал перегрузки с пятью параметрами.

[![Настройка ObjectDataSource на использование UpdateCategory метод, который включает параметр для рисунка](updating-and-deleting-existing-binary-data-vb/_static/image23.png)](updating-and-deleting-existing-binary-data-vb/_static/image22.png)

**Рис. 9**: Настройка ObjectDataSource для использования `UpdateCategory` метод, который включает параметр для `Picture` ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image24.png))

Элемент управления ObjectDataSource теперь будет включать значение для его `UpdateMethod` свойства, а также соответствующий `UpdateParameter` s. Как указано на шаге 4, Visual Studio задает ObjectDataSource s `OldValuesParameterFormatString` свойства `original_{0}` при использовании мастера настройки источника данных. Это будет вызывать проблемы с обновлением и удалите вызовы методов. Таким образом, либо полностью очистить это свойство или выполнить его сброс до по умолчанию, `{0}`.

После завершения работы мастера и исправления `OldValuesParameterFormatString`, декларативная разметка ObjectDataSource s должен выглядеть следующим образом:

[!code-aspx[Main](updating-and-deleting-existing-binary-data-vb/samples/sample6.aspx)]

Чтобы включить GridView s встроенные возможности редактирования, установите флажок Enable Editing в смарт-теге GridView s. Это задаст CommandField s `ShowEditButton` свойства `True`, что может привести Добавление кнопки "Изменить" (и обновления "и" Отмена кнопки для редактируемой строки).

[![Настройка GridView для поддерживающих правку](updating-and-deleting-existing-binary-data-vb/_static/image26.png)](updating-and-deleting-existing-binary-data-vb/_static/image25.png)

**Рис. 10**: Настройка GridView для поддерживающих правку ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image27.png))

Посетите страницу через обозреватель и щелкните одну из строк s кнопки изменения. `CategoryName` И `Description` поля BoundField, кроме подготавливаются к просмотру как текстовые поля. `BrochurePath` Не хватает TemplateField `EditItemTemplate`, поэтому он продолжает показывать его `ItemTemplate` ссылку брошюры. `Picture` ImageField готовится к просмотру как элемент TextBox, `Text` присваивается значение ImageField s `DataImageUrlField` значение, в данном случае `CategoryID`.

[![GridView отсутствуют интерфейс редактирования для BrochurePath](updating-and-deleting-existing-binary-data-vb/_static/image29.png)](updating-and-deleting-existing-binary-data-vb/_static/image28.png)

**Рис. 11**: GridView не имеет интерфейс редактирования для `BrochurePath` ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image30.png))

## <a name="customizing-thebrochurepaths-editing-interface"></a>Настройка`BrochurePath`интерфейс правки s

Нам нужно создать интерфейс редактирования для `BrochurePath` TemplateField, который позволяет пользователю либо:

- Оставьте брошюры категории s как-,
- Обновить категории s брошюры, передав новый буклета, или
- Полностью удалите брошюры категории s (в случае, что категория больше не имеет связанного буклет).

Необходимо также обновить `Picture` интерфейс редактирования s ImageField, но мы вернемся к этому в шаге 7.

Смарт-теге GridView s, щелкните ссылку Изменить шаблоны, а затем выберите `BrochurePath` TemplateField s `EditItemTemplate` из раскрывающегося списка. Добавьте элемент управления RadioButtonList Web этот шаблон, установка его `ID` свойства `BrochureOptions` и его `AutoPostBack` свойства `True`. В окне «Свойства» щелкните эллипсы в `Items` свойство, которое приведет к появлению `ListItem` редактор коллекции. Добавьте следующие три варианта с `Value` s 1, 2 и 3, соответственно:

- Использовать текущий Буклет
- Удалить текущий Буклет
- Отправить новый Буклет

Задать первый `ListItem` s `Selected` свойства `True`.

![Добавьте три ListItems RadioButtonList](updating-and-deleting-existing-binary-data-vb/_static/image2.gif)

**Рис. 12**: Добавьте три `ListItem` s, чтобы RadioButtonList

Под RadioButtonList, добавьте элемент управления FileUpload `BrochureUpload`. Задайте его `Visible` свойства `False`.

[![Добавление EditItemTemplate RadioButtonList и элемента управления FileUpload](updating-and-deleting-existing-binary-data-vb/_static/image32.png)](updating-and-deleting-existing-binary-data-vb/_static/image31.png)

**Рис. 13**: Добавление RadioButtonList и элемента управления FileUpload для `EditItemTemplate` ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image33.png))

Этот RadioButtonList предоставляет три варианта для пользователя. Идея состоит в отображение элемента управления FileUpload только в том случае, если выбран последний вариант и отправка нового брошюр. Для этого необходимо создать обработчик событий для RadioButtonList s `SelectedIndexChanged` событий и добавьте следующий код:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample7.vb)]

Так как элементы управления RadioButtonList и FileUpload находятся внутри шаблона, нужно написать небольшой фрагмент кода для программного доступа к эти элементы управления. `SelectedIndexChanged` Обработчику события передаются ссылкой RadioButtonList в `sender` входного параметра. Для получения элемента управления FileUpload, нам нужно получить родительский s RadioButtonList, управления и использования `FindControl("controlID")` метод оттуда. Получив ссылку на элементы управления RadioButtonList и FileUpload FileUpload управления s `Visible` свойству `True` только если RadioButtonList s `SelectedValue` равно 3, который является `Value` для передачи нового брошюры `ListItem`.

Этот код в месте Отвлекитесь и проверьте его интерфейс редактирования. Нажмите кнопку "Изменить" для строки. Изначально используйте текущий параметр буклет должен быть выбран. Изменение выбранного индекса вызывает обратную передачу. Если третий параметр выбран, элемент FileUpload отображается; в противном случае он скрыт. Рис. 14 показана интерфейс правки, при первом нажатии "Изменить"; Рис. 15 показывает интерфейс, после выбора буклет параметр новой передачи.

[![Изначально текущего использования брошюры выбран параметр](updating-and-deleting-existing-binary-data-vb/_static/image35.png)](updating-and-deleting-existing-binary-data-vb/_static/image34.png)

**Рис. 14**: Изначально, используйте текущий брошюры параметр выбран ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image36.png))

[![Выбор нового брошюры передачи отображает параметр элемента управления FileUpload](updating-and-deleting-existing-binary-data-vb/_static/image38.png)](updating-and-deleting-existing-binary-data-vb/_static/image37.png)

**Рис. 15**: Выбор элемента управления FileUpload брошюры передачи новый параметр ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image39.png))

## <a name="saving-the-brochure-file-and-updating-thebrochurepathcolumn"></a>Сохранение брошюры файла и обновление`BrochurePath`столбца

При нажатии кнопки обновления s GridView, его `RowUpdating` вызывает событие. Элемент управления ObjectDataSource, вызывается команда update s, а затем GridView s `RowUpdated` вызывает событие. Как и с удаление рабочего процесса, необходимо создать обработчики событий для обоих из этих событий. В `RowUpdating` обработчик событий, нужно определить, какое действие следует предпринять на основе `SelectedValue` из `BrochureOptions` RadioButtonList:

- Если `SelectedValue` -1, нам нужно сохранить, используя те же `BrochurePath` параметр. Таким образом, нам нужно установить элемент управления ObjectDataSource s `brochurePath` параметр к существующему `BrochurePath` значение обновляемой записи. Элемент управления ObjectDataSource s `brochurePath` параметра можно задать с помощью `e.NewValues["brochurePath"] = value`.
- Если `SelectedValue` равно 2, а затем нам нужно выбрать запись s `BrochurePath` значение `NULL`. Это можно сделать, задав ObjectDataSource s `brochurePath` параметр `Nothing`, что приводит к базе данных `NULL` , используемых в `UPDATE` инструкции. Если имеется существующий файл Буклет, который удаляется, необходимо удалить существующий файл. Тем не менее нужны только в случае, если обновление завершается без генерации исключения.
- Если `SelectedValue` равно 3, а затем мы хотим убедиться, что пользователь разместил в PDF-файл, а затем сохраните его в файловую систему и обновить запись s `BrochurePath` значение столбца. Кроме того Если имеется существующий файл Буклет, который заменяется, нам нужно удалить предыдущий файл. Тем не менее нужны только в случае, если обновление завершается без генерации исключения.

Шаги, которые необходимы для завершения при RadioButtonList s `SelectedValue` — 3 практически идентичны используемым функцией DetailsView s `ItemInserting` обработчик событий. Этот обработчик событий выполняется при добавлении новой записи категории в элементе управления DetailsView, мы добавили в [предыдущем учебном курсе](including-a-file-upload-option-when-adding-a-new-record-vb.md). Таким образом он behooves нам выполнить рефакторинг эта функция out в отдельные методы. В частности я перемещения функциональные возможности на два метода:

- `ProcessBrochureUpload(FileUpload, out bool)` в качестве входных данных принимает экземпляр элемента управления FileUpload и выходное значение типа Boolean, указывает ли следует продолжить операцию удаления или редактирования или если она должна быть отменена из-за некоторые ошибки проверки. Этот метод возвращает путь в сохраненный файл или `null` Если файл не был сохранен.
- `DeleteRememberedBrochurePath` Удаляет файл, указанный в пути в переменную страницы `deletedCategorysPdfPath` Если `deletedCategorysPdfPath` не `null`.

Код для этих двух методов соответствует. Обратите внимание на сходство между `ProcessBrochureUpload` и DetailsView s `ItemInserting` обработчик событий из предыдущего руководства. В этом учебнике я обновили DetailsView s обработчики событий для использования этих новых методов. Скачайте код, связанный с этим руководством, чтобы увидеть изменения в обработчики событий s DetailsView.

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample8.vb)]

GridView s `RowUpdating` и `RowUpdated` обработчики событий используют `ProcessBrochureUpload` и `DeleteRememberedBrochurePath` методов, как показано в следующем коде:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample9.vb)]

Обратите внимание как `RowUpdating` обработчик событий использует ряд условных операторов, чтобы выполнить соответствующее действие на основе `BrochureOptions` RadioButtonList s `SelectedValue` значение свойства.

Этот код в месте можно изменить категорию и будет использовать его текущего буклета, использовать не буклет или закачивать его новую версию. Продолжим и Опробуйте в деле. Установите точки останова в `RowUpdating` и `RowUpdated` обработчики событий, чтобы получить представление рабочего процесса.

## <a name="step-7-uploading-a-new-picture"></a>Шаг 7. Загрузка нового изображения

`Picture` ImageField s редактирования интерфейса подготавливает к просмотру как текстовое поле заполняется значением из его `DataImageUrlField` свойство. В процессе редактирования GridView передает параметр ObjectDataSource с именем параметра s значение ImageField s `DataImageUrlField` свойство и параметр s значение значение, введенное в текстовое поле в существующем интерфейсе правки. Это подходит, когда изображение сохраняется как файл в файловой системе и `DataImageUrlField` содержит полный URL-адрес изображения. В такой ситуации интерфейс редактирования отображаются URL-адрес изображения s в текстовом поле которого пользователь, можно изменить и сохранили в базе данных. Разумеется, t по умолчанию интерфейс позволяет пользователю отправить новый образ, но она позволяет их изменять URL-адрес изображения из текущего значения к другому. Для этого руководства, однако по умолчанию s ImageField, интерфейс редактирования не достаточно поскольку `Picture` двоичных данных, хранятся непосредственно в базе данных и `DataImageUrlField` содержится в свойстве просто `CategoryID`.

Чтобы лучше понять, что происходит в нашем учебном курсе, когда пользователь редактирует строки с ImageField, рассмотрим следующий пример: пользователь редактирует строки с `CategoryID` 10, в результате чего `Picture` ImageField для подготовки к просмотру как текстовое поле со значением 10. Представьте себе, что пользователь изменяет значение в этом текстовом поле на 50 и щелкает кнопкой "Обновить". Происходит обратная передача и GridView изначально создает параметр с именем `CategoryID` с значение 50. Тем не менее прежде чем этот параметр отправляет GridView (и `CategoryName` и `Description` параметров), он добавляет в значения из `DataKeys` коллекции. Таким образом, она перезаписывает `CategoryID` параметр с текущей основной строки s `CategoryID` значение 10. Короче говоря, s ImageField, интерфейс редактирования не оказывает воздействия на рабочий процесс редактирования в этом руководстве так как имена ImageField s `DataImageUrlField` свойство и сетки s `DataKey` значение — это один в том же.

Хотя ImageField упрощает для отображения изображения на основе данных базы данных, мы кое t нужно использовать текстовое поле в существующем интерфейсе правки. Вместо этого мы хотим предложить элемента управления FileUpload, конечного пользователя можно использовать для изменения рисунка s категории. В отличие от `BrochurePath` значения этих руководствах мы решили хранить потребовать от каждой категории рисунка. Таким образом, мы кое нужно сообщить пользователю о том, что не связан рисунок пользователь может или загрузить новое изображение или оставить текущее изображение как t-является.

Для настройки интерфейса правки s ImageField, нам нужно преобразовать его в поле TemplateField. Смарт-теге GridView s щелкните ссылку Изменить столбцы, выберите ImageField и щелкните преобразовать это поле в TemplateField ссылку.

![Преобразовать ImageField в поле TemplateField](updating-and-deleting-existing-binary-data-vb/_static/image3.gif)

**Рис. 16**: Преобразовать ImageField в поле TemplateField

Преобразование ImageField в поле TemplateField таким образом создает TemplateField с двумя шаблонами. Как показано в следующем декларативном синтаксисе, `ItemTemplate` содержит изображение веб-элемент управления `ImageUrl` присваивается, используя синтаксис привязки данных, в зависимости от ImageField s `DataImageUrlField` и `DataImageUrlFormatString` свойства. `EditItemTemplate` Содержит текстовое поле, `Text` свойство привязано к значению, заданному в `DataImageUrlField` свойство.

[!code-aspx[Main](updating-and-deleting-existing-binary-data-vb/samples/sample10.aspx)]

Необходимо обновить `EditItemTemplate` использование элемента управления FileUpload. От s смарт-тегов щелкните Изменить шаблоны элемента GridView ссылку, а затем выберите `Picture` TemplateField s `EditItemTemplate` из раскрывающегося списка. В шаблоне вы увидите, удалите это текстовое поле. Затем перетащите элемент управления FileUpload из области элементов в шаблон, установка его `ID` для `PictureUpload`. Добавьте текст, чтобы изменить изображение категории s, укажите новый рисунок. Чтобы сохранит свою рисунка категории s, оставьте поле пустым в шаблон.

[![Добавление элемента управления FileUpload EditItemTemplate](updating-and-deleting-existing-binary-data-vb/_static/image41.png)](updating-and-deleting-existing-binary-data-vb/_static/image40.png)

**Рис. 17**: Добавление элемента управления FileUpload для `EditItemTemplate` ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image42.png))

После настройки интерфейса правки, просмотрите продвижении в браузере. При просмотре строки в режиме только для чтения, изображение категории s будет показано, как до, но, нажав кнопку "Изменить" отображает изображение столбца как текст с помощью элемента управления FileUpload.

[![Включает в себя интерфейс правки элемента управления FileUpload](updating-and-deleting-existing-binary-data-vb/_static/image44.png)](updating-and-deleting-existing-binary-data-vb/_static/image43.png)

**Рис. 18**: Включает в себя интерфейс редактирования элемента управления FileUpload ([Просмотр полноразмерного изображения](updating-and-deleting-existing-binary-data-vb/_static/image45.png))

Помните, что элемент управления ObjectDataSource настроен для вызова `CategoriesBLL` класс s `UpdateCategory` метод, который принимает в качестве входных данных двоичные данные для рисунок в качестве `Byte` массива. Если этот массив `Nothing`, но при этом альтернативного `UpdateCategory` перегрузка вызывается, какие проблемы `UPDATE` инструкцию SQL, которая не изменяет `Picture` столбца, благодаря чему категории s текущее изображение без изменений. Таким образом, в GridView s `RowUpdating` обработчик событий, нам нужно программно сослаться на `PictureUpload` FileUpload управления и определить, если файл был отправлен. Если один не был загружен, то мы делаем *не* необходимо указать значение для `picture` параметра. С другой стороны, если файл был отправлен в `PictureUpload` элемента управления FileUpload, необходимо убедиться, что это JPG-файла. Если он является, то мы можем отправить его двоичное содержимое элемента управления ObjectDataSource через `picture` параметра.

Как и с код, используемый на шаге 6, большая часть кода, как здесь требуется уже существует в DetailsView s `ItemInserting` обработчик событий. Таким образом, я ve рефакторинг общих функций в новый метод, `ValidPictureUpload`и обновить `ItemInserting` обработчик событий для использования этого метода.

Добавьте следующий код в начало GridView s `RowUpdating` обработчик событий. Он s, важно, что этот код предшествуют код, который сохраняет файл буклета, так как мы кое t будет сохранен в файловой системе web server s брошюры, при отправке файла Недопустимое изображение.

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample11.vb)]

`ValidPictureUpload(FileUpload)` Метод принимает в элементе управления FileUpload как единственный входной параметр и проверяет расширение отправленного файла s, убедитесь, что загруженный файл JPG-ФАЙЛ; он вызывается, только если передается файл рисунка. Если файл не передается, то изображение параметр не задан и поэтому используется значение по умолчанию `Nothing`. Если рисунок был отправлен и `ValidPictureUpload` возвращает `True`, `picture` назначен параметр двоичных данных переданного изображения; Если метод возвращает `False`, рабочий процесс обновления отменяется и выходе из обработчика событий.

`ValidPictureUpload(FileUpload)` Код метода, который был выполнен рефакторинг из DetailsView s `ItemInserting` обработчик событий:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample12.vb)]

## <a name="step-8-replacing-the-original-categories-pictures-with-jpgs"></a>Шаг 8. Заменив исходные изображения категорий JPGs

Помните, что исходные изображения восьми категорий являются файлы растровых изображений, заключенное в заголовок OLE. Теперь, когда мы добавили возможность изменить существующую запись s картинку, Отвлекитесь и замените JPGs эти точечные рисунки. Если вы хотите продолжать использовать текущий рисунки категории, их можно преобразовать в JPGs, выполнив следующие действия:

1. Сохранение растровых изображений на жесткий диск. Посетите `UpdatingAndDeleting.aspx` страниц в браузере и для каждой из первых восьми категорий, щелкните правой кнопкой мыши на изображение и сохраните его.
2. Откройте изображение в любой текстовый редактор изображений. Можно использовать Microsoft Paint, например.
3. Сохраните растровое изображение в качестве изображения в формате JPG.
4. Обновите изображение категории s через интерфейс редактирования, используя имя JPG-файла.

После изменения категории и отправке изображения JPG, изображение будет не визуализации в браузере, так как `DisplayCategoryPicture.aspx` страницы удаление первых 78 байтов из изображений из первых восьми категорий. Устранить эту проблему, удалив код, который выполняет удаление заголовка OLE. После этого следует `DisplayCategoryPicture.aspx``Page_Load` обработчик событий должен иметь только следующий код:

[!code-vb[Main](updating-and-deleting-existing-binary-data-vb/samples/sample13.vb)]

> [!NOTE]
> `UpdatingAndDeleting.aspx` Страницы s вставляете или изменяете интерфейсы использовать немного больше усилий. `CategoryName` И `Description` поля BoundFields в DetailsView и GridView, должны преобразовываться в поля TemplateField. Так как `CategoryName` не допускает `NULL` значения, должны быть добавлены RequiredFieldValidator. И `Description` TextBox, вероятно, должны быть преобразованы в многострочном текстовом поле. Я оставить эти последние штрихи в качестве упражнения для вас.

## <a name="summary"></a>Сводка

Этот учебник завершает наши принципы работы с двоичными данными. В этом руководстве и предыдущих трех, мы узнали, как двоичные данные могут храниться в файловой системе или непосредственно в базе данных. Пользователь предоставляет двоичные данные в систему, выбрав файл из них жесткий диск и передачи их на веб-сервер, где его можно хранить в файловой системе или вставляются в базу данных. ASP.NET 2.0 включает в себя элемент управления FileUpload, который делает, предоставляя такой интерфейс так же просто, как перетаскивание. Тем не менее, записанные в [загрузка файлов](uploading-files-vb.md) руководство, элемента управления FileUpload представляет собой только хорошо подходит для относительно небольшой файл загрузки, в идеале не превышает мегабайта. Мы также изучили, как связать загруженные данные с базовой моделью данных, а также изменение и удаление двоичных данных из существующих записей.

Наш следующий набор учебных курсов рассматриваются различные методы кэширования. Кэширование позволяет улучшить приложение s общую производительность извлечение результатов из ресурсоемкие операции и сохранив их в расположении, которое может осуществляться быстрее.

Счастливого вам программирования!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP.NET и основатель веб- [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Microsoft с 1998 года. Скотт — независимый консультант, преподаватель и автор. Его последняя книга — [ *Sams Teach ASP.NET 2.0 in 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Ним можно связаться по адресу [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Особая благодарность

В этой серии руководств пособий рецензировалась многими компетентными редакторами. Основной рецензент этого учебного был Мерфи Терезой. Хотите поработать с моих последующих статей для MSDN? Если Да, напишите мне [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](including-a-file-upload-option-when-adding-a-new-record-vb.md)
