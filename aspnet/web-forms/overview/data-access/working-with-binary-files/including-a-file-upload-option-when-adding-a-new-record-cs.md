---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
title: Включение параметра отправки файла при добавлении новой записи (C#) | Документация Майкрософт
author: rick-anderson
description: В этом учебнике показано, как создать веб-интерфейс, позволяющий пользователю вводить текстовые данные и отправлять двоичные файлы. Для иллюстрации доступных параметров t...
ms.author: riande
ms.date: 03/27/2007
ms.assetid: 362ade25-3965-4fb2-88d2-835c4786244f
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
msc.type: authoredcontent
ms.openlocfilehash: f1287e180151b3034a7b90ef4b3f1fbe68354a09
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78475542"
---
# <a name="including-a-file-upload-option-when-adding-a-new-record-c"></a>Включение параметра отправки файла при добавлении новой записи (C#)

по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Скачивание примера приложения](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_CS.exe) или [Загрузка PDF-файла](including-a-file-upload-option-when-adding-a-new-record-cs/_static/datatutorial56cs1.pdf)

> В этом учебнике показано, как создать веб-интерфейс, позволяющий пользователю вводить текстовые данные и отправлять двоичные файлы. Чтобы продемонстрировать параметры, доступные для хранения двоичных данных, один файл будет сохранен в базе данных, а другой — в файловой системе.

## <a name="introduction"></a>Введение

В предыдущих двух учебниках мы рассматривали методы хранения двоичных данных, связанных с моделью данных приложения, рассмотрели, как использовать элемент управления FileUpload для отправки файлов с клиента на веб-сервер, и увидеть, как представлять эти двоичные данные в данных элемент управления EB. Но мы еще не говорим о том, как связать загруженные данные с моделью данных.

В этом учебнике будет создана веб-страница для добавления новой категории. Помимо текстовых полей для имени и описания категории s, на этой странице необходимо включить два элемента управления FileUpload, один для изображения новой категории и один для буклета. Отправленная картинка будет сохранена непосредственно в новой записи `Picture` столбец, тогда как буклет будет сохранен в папке `~/Brochures` с путем к файлу, сохраненному в столбце новая запись s `BrochurePath`.

Перед созданием этой новой веб-страницы необходимо обновить архитектуру. Основной запрос `CategoriesTableAdapter` s не извлекает столбец `Picture`. Следовательно, автоматически созданный метод `Insert` содержит только входные данные для полей `CategoryName`, `Description`и `BrochurePath`. Поэтому нам нужно создать дополнительный метод в TableAdapter, который запрашивает все четыре поля `Categories`. Необходимо также обновить класс `CategoriesBLL` на уровне бизнес-логики.

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a>Шаг 1. Добавление метода`InsertWithPicture`в`CategoriesTableAdapter`

Когда мы создали `CategoriesTableAdapter` обратно в учебнике [Создание уровня доступа к данным](../introduction/creating-a-data-access-layer-cs.md) , мы настроили автоматическое создание `INSERT`, `UPDATE`и `DELETE` инструкций на основе основного запроса. Более того, мы предзадали TableAdapter инструкцию использовать прямой подход к базе данных, который создал методы `Insert`, `Update`и `Delete`. Эти методы выполняют автоматически созданные инструкции `INSERT`, `UPDATE`и `DELETE` и, соответственно, принимают входные параметры на основе столбцов, возвращаемых основным запросом. В руководстве по [отправке файлов](uploading-files-cs.md) мы дополнены основным запросом `CategoriesTableAdapter` s для использования `BrochurePath` столбца.

Так как основной запрос `CategoriesTableAdapter` s не ссылается на столбец `Picture`, мы не можем добавлять новую запись и обновлять существующую запись со значением столбца `Picture`. Чтобы записать эти сведения, можно создать в TableAdapter новый метод, который используется специально для вставки записи с двоичными данными, или можно настроить автоматически созданную инструкцию `INSERT`. Проблема, связанная с настройкой автоматически созданной инструкции `INSERT`, заключается в том, что наши настройки перезаписываются мастером. Например, предположим, что мы настроили инструкцию `INSERT` для включения использования столбца `Picture`. Это приведет к обновлению метода `Insert` TableAdapter, чтобы включить дополнительный входной параметр для двоичных данных категории s Picture. Затем можно создать метод на уровне бизнес-логики, чтобы использовать этот метод DAL и вызвать этот метод BLL через уровень представления, и все будет работать замечательно. То есть до следующего настройки TableAdapter с помощью мастера настройки TableAdapter. После завершения работы мастера наши настройки `INSERT`ной инструкции будут перезаписаны, метод `Insert` вернется к старой форме, а наш код больше не будет компилироваться!

> [!NOTE]
> Это неудобством не вызывает проблем при использовании хранимых процедур вместо специальных инструкций SQL. В следующем учебнике рассматривается использование хранимых процедур вместо специальных инструкций SQL на уровне доступа к данным.

Чтобы избежать такой потенциальной недостаточной проблемы, вместо настройки автоматически создаваемых инструкций SQL позвольте ей создать новый метод для TableAdapter. Этот метод с именем `InsertWithPicture`принимает значения для столбцов `CategoryName`, `Description`, `BrochurePath`и `Picture` и выполняет инструкцию `INSERT`, в которой хранятся все четыре значения в новой записи.

Откройте типизированный набор данных и в конструкторе щелкните правой кнопкой мыши заголовок `CategoriesTableAdapter` s и выберите в контекстном меню команду Добавить запрос. Запустится мастер настройки запросов TableAdapter, который начинает с того, как запрос TableAdapter должен получить доступ к базе данных. Выберите использовать инструкции SQL и нажмите кнопку Далее. На следующем шаге запрашивается тип создаваемого запроса. Так как мы повторно создаем запрос для добавления новой записи в `Categories` таблицу, выберите Вставить и нажмите кнопку Далее.

[![выбрать параметр вставки](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.png)

**Рисунок 1**. Выбор параметра вставки ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.png))

Теперь необходимо указать инструкцию SQL `INSERT`. Мастер автоматически предложит инструкцию `INSERT`, соответствующую основному запросу TableAdapter s. В данном случае это инструкция `INSERT`, которая вставляет значения `CategoryName`, `Description`и `BrochurePath`. Обновите инструкцию таким образом, чтобы столбец `Picture` был включен вместе с параметром `@Picture`, например следующим образом:

[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample1.sql)]

На последнем экране мастера запрашивается имя нового метода TableAdapter. Введите `InsertWithPicture` и нажмите кнопку Готово.

[![назовите новый метод TableAdapter Инсертвиспиктуре](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.png)

**Рис. 2**. Именование нового метода адаптера таблицы `InsertWithPicture` ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.png))

## <a name="step-2-updating-the-business-logic-layer"></a>Шаг 2. обновление уровня бизнес-логики

Поскольку уровень представления данных должен взаимодействовать только с уровнем бизнес-логики, а не обходить его непосредственно на уровне доступа к данным, необходимо создать метод BLL, который вызывает только что созданный метод DAL (`InsertWithPicture`). В рамках этого руководства создайте метод в классе `CategoriesBLL` с именем `InsertWithPicture`, который принимает в качестве входных данных три `string` s и массив `byte`. Входные параметры `string` предназначены для имени категории, описания и пути к файлу брошюры, а `byte` массив — для двоичного содержимого изображения категории s. Как показано в следующем коде, этот метод BLL вызывает соответствующий метод DAL:

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample2.cs)]

> [!NOTE]
> Убедитесь, что типизированный набор данных сохранен перед добавлением метода `InsertWithPicture` к BLL. Так как код класса `CategoriesTableAdapter` создается автоматически на основе типизированного набора данных, если не сохранить изменения в типизированном наборе DataSet, свойство `Adapter` не будет известно о методе `InsertWithPicture`.

## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a>Шаг 3. Перечисление существующих категорий и их двоичных данных

В этом учебнике мы создадим страницу, которая позволяет пользователю добавить новую категорию в систему, предоставив рисунок и буклет для новой категории. В [предыдущем учебном курсе](displaying-binary-data-in-the-data-web-controls-cs.md) мы использовали GridView с TemplateField и имажефиелд для вывода каждого названия категории, описания, изображения и ссылки для загрузки его буклета. Давайте выполним репликацию этой функции для этого руководства, создав страницу, в которой оба списка имеют все существующие категории, и допускают создание новых.

Для начала откройте страницу `DisplayOrDownload.aspx` из папки `BinaryData`. Перейдите в представление исходного кода и скопируйте декларативный синтаксис GridView и ObjectDataSource s, вставляя его в элемент `<asp:Content>` в `UploadInDetailsView.aspx`. Кроме того, не забывайте копировать метод `GenerateBrochureLink` из класса кода программной части `DisplayOrDownload.aspx` в `UploadInDetailsView.aspx`.

[![скопировать и вставить декларативный синтаксис из Дисплайордовнлоад. aspx в Уплоадиндетаилсвиев. aspx.](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.png)

**Рис. 3**. копирование и вставка декларативного синтаксиса из `DisplayOrDownload.aspx` в `UploadInDetailsView.aspx` ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.png))

После копирования декларативного синтаксиса и `GenerateBrochureLink` метода на страницу `UploadInDetailsView.aspx` просмотрите страницу в браузере, чтобы убедиться, что все скопировано правильно. Вы должны увидеть список из восьми категорий, содержащих ссылку для скачивания буклета, а также изображение категорий.

[![должны отобразиться все категории вместе с двоичными данными](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.png)

**Рис. 4**. Теперь вы увидите каждую категорию вместе с двоичными данными ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.png)).

## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a>Шаг 4. Настройка`CategoriesDataSource`для поддержки вставки

`CategoriesDataSource` ObjectDataSource, используемый `Categories` GridView, в настоящее время не предоставляет возможности вставки данных. Для поддержки вставки через этот элемент управления источниками данных необходимо соотнести его метод `Insert` с методом в его базовом объекте `CategoriesBLL`. В частности, мы хотим преобразовать его в метод `CategoriesBLL`, который мы добавили обратно на шаге 2, `InsertWithPicture`.

Для начала щелкните ссылку Настройка источника данных из смарт-тега ObjectDataSource s. На первом экране показан объект, для работы с которым настроен источник данных, `CategoriesBLL`. Оставьте этот параметр как есть и нажмите кнопку Далее, чтобы перейти к экрану определение методов обработки данных. Перейдите на вкладку Вставка и выберите метод `InsertWithPicture` из раскрывающегося списка. Нажмите кнопку Готово, чтобы завершить работу с мастером.

[![настроить ObjectDataSource для использования метода Инсертвиспиктуре](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.png)

**Рис. 5**. Настройка ObjectDataSource для использования метода `InsertWithPicture` ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.png))

> [!NOTE]
> После завершения работы мастера Visual Studio может запросить обновление полей и ключей, что приведет к повторному формированию полей веб-элементов управления данными. Выберите Нет, так как при нажатии кнопки Да будут перезаписаны все сделанные настройки полей.

После завершения работы мастера ObjectDataSource будет включать значение свойства `InsertMethod`, а также `InsertParameters` для четырех столбцов категории, как показано в следующей декларативной разметке:

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a>Шаг 5. Создание интерфейса вставки

Как было описано в [обзоре вставки, обновления и удаления данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md), элемент управления DetailsView предоставляет встроенный интерфейс вставки, который можно использовать при работе с элементом управления источниками данных, поддерживающим вставку. Добавим на эту страницу элемент управления DetailsView, расположенный над элементом GridView, который будет постоянно отображать свой интерфейс вставки, позволяя пользователю быстро добавить новую категорию. После добавления новой категории в DetailsView элемент управления GridView под ней автоматически обновит и отобразит новую категорию.

Начните с перетаскивания элемента управления DetailsView с панели элементов в конструктор над элементом управления GridView, устанавливая для его свойства `ID` значение `NewCategory` и очищаются значения свойств `Height` и `Width`. В смарт-теге DetailsView s привяжите его к существующему `CategoriesDataSource`, а затем установите флажок Enable INSERT (включить вставку).

[![привязать DetailsView к CategoriesDataSource и включить вставку](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.png)

**Рис. 6**. привязка элемента DetailsView к `CategoriesDataSource` и включение вставки ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image12.png))

Чтобы окончательно отобразить DetailsView в своем интерфейсе вставки, установите для свойства `DefaultMode` значение `Insert`.

Обратите внимание, что элемент DetailsView содержит пять BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`и `BrochurePath`, хотя `CategoryID` BoundField не отображается в интерфейсе вставки, так как его свойство `InsertVisible` имеет значение `false`. Эти BoundFields существуют, так как они являются столбцами, возвращаемыми методом `GetCategories()`, который вызывается ObjectDataSource для получения своих данных. Однако для вставки мы не хотим, чтобы пользователь указал значение для `NumberOfProducts`. Кроме того, необходимо разрешить им передавать изображение для новой категории, а также отправить PDF-файл для буклета.

Удалите `NumberOfProducts` BoundField из DetailsView, а затем обновите свойства `HeaderText` `CategoryName` и `BrochurePath` BoundFields на категорию и буклет соответственно. Затем преобразуйте `BrochurePath` BoundField в TemplateField и добавьте новый TemplateField для изображения, предоставляя этому новому TemplateField `HeaderText` значение Picture. Переместите `Picture` TemplateField, чтобы они находятся между `BrochurePath` TemplateField и CommandField.

![Привязка DetailsView к CategoriesDataSource и включение вставки](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.gif)

**Рис. 7**. привязка элемента DetailsView к `CategoriesDataSource` и включение вставки

Если вы преобразовали `BrochurePath` BoundField в TemplateField в диалоговом окне Изменение полей, TemplateField включает `ItemTemplate`, `EditItemTemplate`и `InsertItemTemplate`. Однако требуется только `InsertItemTemplate`, поэтому вы можете удалить два других шаблона. На этом этапе декларативный синтаксис DetailsView s должен выглядеть следующим образом:

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a>Добавление элементов управления FileUpload для буклетов и полей рисунков

В настоящее время `BrochurePath` TemplateField s `InsertItemTemplate` содержит текстовое поле, а `Picture` TemplateField не содержит шаблонов. Чтобы использовать элементы управления FileUpload, необходимо обновить эти две TemplateField `InsertItemTemplate` s.

В смарт-теге DetailsView s выберите пункт изменить шаблоны, а затем выберите `BrochurePath` TemplateField s `InsertItemTemplate` из раскрывающегося списка. Удалите текстовое поле и перетащите элемент управления FileUpload из панели элементов в шаблон. Задайте для элемента управления FileUpload `ID` `BrochureUpload`. Аналогичным образом добавьте элемент управления FileUpload в `Picture` TemplateField s `InsertItemTemplate`. Задайте для этого элемента управления FileUpload `ID` `PictureUpload`.

[![добавить элемент управления FileUpload в InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image13.png)

**Рис. 8**. Добавление элемента управления FileUpload в `InsertItemTemplate` ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image14.png))

После внесения этих дополнений декларативный синтаксис TemplateField s будет следующим:

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample5.aspx)]

Когда пользователь добавляет новую категорию, мы хотим убедиться, что буклет и рисунок имеют правильный тип файла. Для буклета пользователь должен предоставить PDF-файл. Для изображения необходимо передать файл изображения, но разрешить *любой* файл изображения или только файлы изображений определенного типа, например GIF или жпгс? Чтобы разрешить различные типы файлов, нам нужно расширить схему `Categories`, включив в нее столбец, который захватывает тип файла, чтобы этот тип можно было отправить клиенту с помощью `Response.ContentType` в `DisplayCategoryPicture.aspx`. Так как у нас нет такого столбца, было бы разумно ограничить доступ пользователей, предоставив только конкретный тип файла изображения. `Categories` таблица s — это точечные рисунки, но для изображений, обслуживаемых через Интернет, Жпгс имеет более подходящий формат файлов.

Если пользователь передает неверный тип файла, необходимо отменить вставку и отобразить сообщение, указывающее на проблему. Добавьте веб-элемент управления Label под элементом DetailsView. Присвойте свойству `ID` значение `UploadWarning`, удалите его свойство `Text`, задайте для свойства `CssClass` значение Warning, а для `Visible` `EnableViewState` и `false`свойства. Класс `Warning` CSS определен в `Styles.css` и отображает текст в большом, красно-курсивном полужирном шрифте.

> [!NOTE]
> В идеале `CategoryName` и `Description` BoundFields будут преобразованы в полей TemplateField, а их интерфейсы вставки будут настроены. Например, интерфейс вставки `Description`, скорее всего, лучше подходит для многострочного текстового поля. А поскольку `CategoryName` столбец не принимает `NULL` значений, необходимо добавить RequiredFieldValidator, чтобы гарантировать, что пользователь предоставит значение для нового имени категории s. Эти шаги оставлены в качестве упражнения для читателя. Дополнительные сведения о дополнении интерфейсов изменения данных см. в статье о [настройке интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) .

## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a>Шаг 6. Сохранение отправленной брошюры в файловую систему веб-сервера

Когда пользователь вводит значения для новой категории и нажимает кнопку «Вставить», происходит обратная передача, а рабочий процесс вставки размещается. Во первых, срабатывает [событие`ItemInserting`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) DetailsView s. Затем вызывается метод ObjectDataSource `Insert()`, который приводит к добавлению новой записи в `Categories` таблицу. После этого срабатывает [событие`ItemInserted`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) DetailsView s.

Прежде чем вызывать метод `Insert()` ObjectDataSource s, необходимо убедиться, что пользователь передал соответствующие типы файлов, а затем сохранить файл брошюры PDF в файловой системе веб-сервера. Создайте обработчик событий для события `ItemInserting` DetailsView s и добавьте следующий код:

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample6.cs)]

Обработчик событий начинает с ссылки на элемент управления `BrochureUpload` FileUpload из шаблонов DetailsView s. Затем, если буклет был отправлен, проверяется расширение отправленных файлов. Если расширение не имеет значение. PDF, отображается предупреждение, вставка отменяется и выполнение обработчика событий завершается.

> [!NOTE]
> Использование расширения переданного файла не является самым гарантией того, что отправленный файл является документом в формате PDF. Пользователь может иметь допустимый PDF-документ с расширением `.Brochure`или мог взять документ в формате, отличном от PDF, и присвоить ему расширение `.pdf`. Для более окончательной проверки типа файла необходимо программно проверять двоичное содержимое файлов. Однако такие глубокие подходы часто являются избыточными; Проверка расширения достаточна для большинства сценариев.

Как обсуждалось в руководстве по [отправке файлов](uploading-files-cs.md) , необходимо соблюдать осторожность при сохранении файлов в файловой системе, чтобы одна пользовательская передача не перезаписала другой. В этом учебнике будет предпринята попытка использовать то же имя, что и у отправленного файла. Однако если в каталоге `~/Brochures` уже существует файл с таким же именем файла, мы добавим номер в конец, пока не будет найдено уникальное имя. Например, если пользователь отправляет файл буклета с именем `Meats.pdf`, но в папке `~/Brochures` уже есть файл с именем `Meats.pdf`, имя сохраненного файла будет изменено на `Meats-1.pdf`. Если он существует, мы попытаемся `Meats-2.pdf`и т. д., пока не будет найдено уникальное имя файла.

В следующем коде используется [метод`File.Exists(path)`](https://msdn.microsoft.com/library/system.io.file.exists.aspx) , чтобы определить, существует ли уже файл с указанным именем. В этом случае он будет пытаться использовать новые имена файлов для буклета, пока не будет найден конфликт.

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample7.cs)]

После обнаружения допустимого имени файла файл необходимо сохранить в файловой системе, а значение ObjectDataSource `brochurePath``InsertParameter` необходимо обновить, чтобы оно записывалось в базу данных. Как мы видели в руководстве по *отправке файлов* , файл можно сохранить с помощью метода управления FileUpload `SaveAs(path)`. Чтобы обновить параметр `brochurePath` ObjectDataSource, используйте коллекцию `e.Values`.

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample8.cs)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a>Шаг 7. Сохранение отправленной фотографии в базу данных

Чтобы сохранить отправленное изображение в новой записи `Categories`, необходимо назначить переданное двоичное содержимое параметру ObjectDataSource s `picture` в событии `ItemInserting` DetailsView s. Прежде чем приступать к этому назначению, необходимо сначала убедиться, что отправленный рисунок является JPG, а не другим типом изображения. Как и на шаге 6, для определения его типа можно использовать расширение переданного файла Picture s.

Хотя `Categories` таблица допускает `NULL` значений для столбца `Picture`, все категории в данный момент имеют рисунок. Пусть при добавлении новой категории с помощью этой страницы пользователь должен будет указать рисунок. Следующий код проверяет, чтобы убедиться, что изображение Отправлено и имеет соответствующее расширение.

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample9.cs)]

Этот код следует поместить *перед* кодом из шага 6, чтобы при возникновении проблемы с отправкой изображения обработчик событий завершит работу перед сохранением файла буклета в файловой системе.

При условии, что соответствующий файл был отправлен, назначьте переданное двоичное содержимое значению параметра Picture с помощью следующей строки кода:

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample10.cs)]

## <a name="the-completeiteminsertingevent-handler"></a>Полный обработчик событий`ItemInserting`

Для полноты здесь `ItemInserting` обработчик событий целиком:

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample11.cs)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a>Шаг 8. исправление страницы`DisplayCategoryPicture.aspx`

Подождите немного, чтобы протестировать интерфейс вставки и `ItemInserting` обработчика событий, который был создан за последние несколько шагов. Откройте страницу `UploadInDetailsView.aspx` в браузере и попытайтесь добавить категорию, но не пропустите рисунок или укажите изображение в формате, отличном от JPG, или буклет. В любом из этих случаев отобразится сообщение об ошибке, и рабочий процесс вставки будет отменен.

[![отображается предупреждающее сообщение, если передан недопустимый тип файла](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image15.png)

**Рис. 9**. Если передан недопустимый тип файла, отображается предупреждение ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image16.png))

Убедившись, что страница требует передачи изображения и не принимает файлы в формате, отличном от PDF или JPG, добавьте новую категорию с допустимым изображением JPG, оставьте поле буклета пустым. После нажатия кнопки "вставить" страница будет выполнять обратную передачу, и в таблицу `Categories` будет добавлена новая запись с сохраненным двоичным содержимым Image s, хранящимся непосредственно в базе данных. Элемент управления GridView обновляется и отображает строку только что добавленной категории, но, как показано на рис. 10, новая картинка категории не отображается правильно.

[![изображение новой категории не отображается](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image17.png)

**Рис. 10**. изображение новой категории не отображается ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image18.png))

Причина, по которой новое изображение не отображается, заключается в том, что страница `DisplayCategoryPicture.aspx`, которая возвращает определенную картинку категорий, настроена для обработки точечных рисунков, имеющих заголовок OLE. Этот заголовок 78 байта удаляется из двоичного содержимого столбца `Picture`, прежде чем они будут отправлены обратно клиенту. Но файл JPG, который был только что отправлен для новой категории, не имеет этого заголовка OLE. Таким образом, допустимые байты удаляются из двоичных данных образа.

Так как в таблице `Categories` есть оба точечных рисунка с заголовками OLE и Жпгс, необходимо обновить `DisplayCategoryPicture.aspx` таким образом, чтобы она выпускала заголовок OLE для исходных восьми категорий и обойти эту проблему для новых записей категорий. В следующем учебном курсе мы рассмотрим, как обновить существующий образ записи, и мы будем обновлять все старые рисунки категорий, чтобы они Жпгс. Но теперь используйте следующий код в `DisplayCategoryPicture.aspx` для чередования заголовков OLE только для тех исходных восьми категорий:

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample12.cs)]

После этого изменения изображение JPG теперь правильно отображается в GridView.

[![правильное отображение изображений JPG для новых категорий](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image19.png)

**Рис. 11**. изображения в формате JPG для новых категорий отображаются правильно ([щелкните, чтобы просмотреть изображение с полным размером](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image20.png))

## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a>Шаг 9. Удаление буклета на лицевой стороне исключения

Одной из трудностей при хранении двоичных данных в файловой системе веб-сервера является то, что она создает разрыв между моделью данных и ее двоичными данными. Таким образом, при каждом удалении записи соответствующие двоичные данные в файловой системе также должны быть удалены. Это может быть и при вставке. Рассмотрим следующий сценарий: пользователь добавляет новую категорию, указывая допустимую картинку и буклет. При нажатии кнопки "вставить" происходит обратная передача и срабатывает событие `ItemInserting` DetailsView s, сохранив буклет в файловой системе веб-сервера. Затем вызывается метод ObjectDataSource `Insert()`, который вызывает метод `CategoriesBLL` класса `InsertWithPicture`, который вызывает метод `CategoriesTableAdapter` s `InsertWithPicture`.

Что произойдет, если база данных находится в автономном режиме или если в инструкции SQL `INSERT` возникла ошибка? Очевидно, что вставка завершится ошибкой, поэтому новая строка категории не будет добавлена в базу данных. Но у нас по-прежнему есть отправленный файл буклета, расположенный в файловой системе Web Server s! Этот файл необходимо удалить в лицевой стороне исключения во время выполнения процесса вставки.

Как обсуждалось ранее в разделе [обработка исключений BLL и DAL в учебнике по страницам ASP.NET](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) , когда исключение создается из глубины архитектуры, она перемещается вверх по различным слоям. На уровне представления можно определить, возникло ли исключение из события `ItemInserted` DetailsView s. Этот обработчик событий также предоставляет значения `InsertParameters`ObjectDataSource. Таким образом, можно создать обработчик события `ItemInserted`, который проверяет, было ли исключение, и, если это так, удаляет файл, заданный параметром `brochurePath` ObjectDataSource:

[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample13.cs)]

## <a name="summary"></a>Сводка

Для предоставления веб-интерфейса для добавления записей, содержащих двоичные данные, необходимо выполнить ряд действий. Если двоичные данные хранятся непосредственно в базе данных, то, скорее всего, потребуется обновить архитектуру, добавив определенные методы для обработки случая, когда вставляются двоичные данные. После обновления архитектуры следующий шаг заключается в создании интерфейса вставки, который можно выполнить с помощью элемента управления DetailsView, который был настроен для включения в него элементов интерфейса FileUpload для каждого поля двоичных данных. Отправленные данные могут быть сохранены в файловой системе веб-сервера или назначены параметру источника данных в обработчике событий DetailsView s `ItemInserting`.

Сохранение двоичных данных в файловой системе требует больше планирования, чем сохранение данных непосредственно в базе данных. Необходимо выбрать схему именования, чтобы избежать перезаписи другой стороной с помощью другого пользователя. Кроме того, при сбое вставки базы данных необходимо выполнить дополнительные действия для удаления отправленного файла.

Теперь у нас есть возможность добавлять новые категории в систему с помощью буклета и картинки, но мы еще не можем узнать, как обновить существующие двоичные данные категории s или как правильно удалить двоичные данные для удаленной категории. Мы рассмотрим эти две темы в следующем руководстве.

Поздравляем с программированием!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998. Скотт работает как независимый консультант, преподаватель и модуль записи. Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Специальная благодарность

Эта серия руководств была рассмотрена многими полезными рецензентами. Потенциальные рецензенты для этого руководства: Дейв Гарднер, Терезой Мерфи и Бернадетте Леигх. Хотите ознакомиться с моими будущими статьями MSDN? Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](displaying-binary-data-in-the-data-web-controls-cs.md)
> [Вперед](updating-and-deleting-existing-binary-data-cs.md)
