---
uid: web-forms/overview/data-access/database-driven-site-maps/building-a-custom-database-driven-site-map-provider-cs
title: Создание пользовательского поставщика карт сайтов, управляемого базой данныхC#() | Документация Майкрософт
author: rick-anderson
description: Поставщик карт узла по умолчанию в ASP.NET 2,0 извлекает свои данные из статического XML-файла. Хотя поставщик на основе XML подходит для многих малых и средних СИЗ...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: 04b7591d-106f-4f05-87e9-d416cb65a8a6
msc.legacyurl: /web-forms/overview/data-access/database-driven-site-maps/building-a-custom-database-driven-site-map-provider-cs
msc.type: authoredcontent
ms.openlocfilehash: a3e27b37703b12c9796e8516f0d805aef1fdf8d8
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74636919"
---
# <a name="building-a-custom-database-driven-site-map-provider-c"></a><span data-ttu-id="f3b71-104">Создание пользовательского поставщика карт сайтов, управляемых базами данных (C#)</span><span class="sxs-lookup"><span data-stu-id="f3b71-104">Building a Custom Database-Driven Site Map Provider (C#)</span></span>

<span data-ttu-id="f3b71-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="f3b71-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="f3b71-106">[Скачать код](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_62_CS.zip) или [скачать PDF](building-a-custom-database-driven-site-map-provider-cs/_static/datatutorial62cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="f3b71-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_62_CS.zip) or [Download PDF](building-a-custom-database-driven-site-map-provider-cs/_static/datatutorial62cs1.pdf)</span></span>

> <span data-ttu-id="f3b71-107">Поставщик карт узла по умолчанию в ASP.NET 2,0 извлекает свои данные из статического XML-файла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-107">The default site map provider in ASP.NET 2.0 retrieves its data from a static XML file.</span></span> <span data-ttu-id="f3b71-108">Хотя поставщик на основе XML подходит для многих малых и средних веб-сайтов, для больших веб-приложений требуется более динамическая схема узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-108">While the XML-based provider is suitable to many small and medium-sized Web sites, larger Web applications require a more dynamic site map.</span></span> <span data-ttu-id="f3b71-109">В этом учебнике мы создадим пользовательский поставщик карт узла, который получает свои данные из уровня бизнес-логики, который, в свою очередь, извлекает данные из базы данных.</span><span class="sxs-lookup"><span data-stu-id="f3b71-109">In this tutorial we'll build a custom site map provider that retrieves its data from the Business Logic Layer, which in turn retrieves data from the database.</span></span>

## <a name="introduction"></a><span data-ttu-id="f3b71-110">Введение</span><span class="sxs-lookup"><span data-stu-id="f3b71-110">Introduction</span></span>

<span data-ttu-id="f3b71-111">Функция Map ASP.NET 2,0 s позволяет разработчику страниц определять карту веб-узла Web Application на некоторых постоянных носителях, например в XML-файле.</span><span class="sxs-lookup"><span data-stu-id="f3b71-111">ASP.NET 2.0 s site map feature enables a page developer to define a web application s site map in some persistent medium, such as in an XML file.</span></span> <span data-ttu-id="f3b71-112">После определения доступ к данным карт узла можно получить программно с помощью [класса`SiteMap`](https://msdn.microsoft.com/library/system.web.sitemap.aspx) в [пространстве имен`System.Web`](https://msdn.microsoft.com/library/system.web.aspx) или с помощью различных веб-элементов управления навигацией, таких как SiteMapPath, меню и элементы управления TreeView.</span><span class="sxs-lookup"><span data-stu-id="f3b71-112">Once defined, the site map data can be accessed programmatically through the [`SiteMap` class](https://msdn.microsoft.com/library/system.web.sitemap.aspx) in the [`System.Web` namespace](https://msdn.microsoft.com/library/system.web.aspx) or through a variety of navigation Web controls, such as the SiteMapPath, Menu, and TreeView controls.</span></span> <span data-ttu-id="f3b71-113">Система карт узла использует [модель поставщика](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx) , чтобы различные реализации сериализации карт веб-узла можно было создать и подключить к веб-приложению.</span><span class="sxs-lookup"><span data-stu-id="f3b71-113">The site map system uses the [provider model](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx) so that different site map serialization implementations can be created and plugged into a web application.</span></span> <span data-ttu-id="f3b71-114">Поставщик карт узла по умолчанию, который поставляется с ASP.NET 2,0, сохраняет структуру карт узла в XML-файле.</span><span class="sxs-lookup"><span data-stu-id="f3b71-114">The default site map provider that ships with ASP.NET 2.0 persists site map structure in an XML file.</span></span> <span data-ttu-id="f3b71-115">Вернувшись на [главные страницы и руководство по переходу на сайт](../introduction/master-pages-and-site-navigation-cs.md) , мы создали файл с именем `Web.sitemap`, содержащий эту структуру, и обновили его XML-код с помощью каждого нового раздела учебника.</span><span class="sxs-lookup"><span data-stu-id="f3b71-115">Back in the [Master Pages and Site Navigation](../introduction/master-pages-and-site-navigation-cs.md) tutorial we created a file named `Web.sitemap` that contained this structure and have been updating its XML with each new tutorial section.</span></span>

<span data-ttu-id="f3b71-116">Поставщик схемы сайта на основе XML по умолчанию работает правильно, если структура схемы узла является довольно статической, например для этих учебников.</span><span class="sxs-lookup"><span data-stu-id="f3b71-116">The default XML-based site map provider works well if the site map s structure is fairly static, such as for these tutorials.</span></span> <span data-ttu-id="f3b71-117">Однако во многих сценариях требуется более динамическая схема узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-117">In many scenarios, however, a more dynamic site map is needed.</span></span> <span data-ttu-id="f3b71-118">Рассмотрим карту узла, показанную на рис. 1, где каждая категория и продукт отображаются в виде разделов в структуре веб-сайта.</span><span class="sxs-lookup"><span data-stu-id="f3b71-118">Consider the site map shown in Figure 1, where each category and product appear as sections in the website s structure.</span></span> <span data-ttu-id="f3b71-119">При использовании этой схемы сайта на веб-странице, соответствующей корневому узлу, могут сопоставлены все категории, в то время как на веб-странице с определенной категорией указано, что товары категории и просмотр определенной веб-страницы продукта покажут сведения о продукте.</span><span class="sxs-lookup"><span data-stu-id="f3b71-119">With this site map, visiting the web page corresponding to the root node might list all of the categories, whereas visiting a particular category s web page would list that category s products and viewing a particular product s web page would show that product s details.</span></span>

<span data-ttu-id="f3b71-120">[![категорий и продуктов, описывающего структуру узла](building-a-custom-database-driven-site-map-provider-cs/_static/image1.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-120">[![The Categories and Products Makeup the Site Map s Structure](building-a-custom-database-driven-site-map-provider-cs/_static/image1.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image1.png)</span></span>

<span data-ttu-id="f3b71-121">**Рис. 1**. категории и продукты, описывающего структуру узла s ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-121">**Figure 1**: The Categories and Products Makeup the Site Map s Structure ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image2.png))</span></span>

<span data-ttu-id="f3b71-122">Хотя эта структура на основе категорий и продуктов может быть жестко запрограммирована в `Web.sitemap` файле, необходимо обновить файл при каждом добавлении, удалении или переименовании категории или продукта.</span><span class="sxs-lookup"><span data-stu-id="f3b71-122">While this category- and product-based structure could be hard-coded into the `Web.sitemap` file, the file would need to be updated each time a category or product was added, removed, or renamed.</span></span> <span data-ttu-id="f3b71-123">Следовательно, обслуживание карт узла было бы значительно упрощено, если его структура была получена из базы данных, или, в идеале, от уровня бизнес-логики архитектуры приложения.</span><span class="sxs-lookup"><span data-stu-id="f3b71-123">Consequently, the site map maintenance would be greatly simplified if its structure was retrieved from the database or, ideally, from the Business Logic Layer of the application s architecture.</span></span> <span data-ttu-id="f3b71-124">Таким образом, по мере добавления, переименования или удаления продуктов и категорий схема узла будет автоматически обновляться в соответствии с этими изменениями.</span><span class="sxs-lookup"><span data-stu-id="f3b71-124">That way, as products and categories were added, renamed, or deleted, the site map would automatically update to reflect these changes.</span></span>

<span data-ttu-id="f3b71-125">Так как сериализация карт узла ASP.NET 2,0 s основана на модели поставщика, мы можем создать собственный поставщик карт узла, который извлекает свои данные из альтернативного хранилища данных, такого как база данных или архитектура.</span><span class="sxs-lookup"><span data-stu-id="f3b71-125">Since ASP.NET 2.0 s site map serialization is built atop the provider model, we can create our own custom site map provider that grabs its data from an alternate data store, such as the database or architecture.</span></span> <span data-ttu-id="f3b71-126">В этом учебнике мы создадим настраиваемый поставщик, который извлекает свои данные из BLL.</span><span class="sxs-lookup"><span data-stu-id="f3b71-126">In this tutorial we'll build a custom provider that retrieves its data from the BLL.</span></span> <span data-ttu-id="f3b71-127">Давайте приступим к работе!</span><span class="sxs-lookup"><span data-stu-id="f3b71-127">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="f3b71-128">Пользовательский поставщик карт узла, созданный в этом руководстве, тесно связан с архитектурой приложения и моделью данных.</span><span class="sxs-lookup"><span data-stu-id="f3b71-128">The custom site map provider created in this tutorial is tightly coupled to the application s architecture and data model.</span></span> <span data-ttu-id="f3b71-129">Джефф Просайз [сохраняет карты сайтов в SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) и [поставщик карты узла SQL, который вы](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx) сохранили, ожидают, что статьи проверяют обобщенный подход к хранению данных карты узла в SQL Server.</span><span class="sxs-lookup"><span data-stu-id="f3b71-129">Jeff Prosise s [Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) and [The SQL Site Map Provider You ve Been Waiting For](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx) articles examine a generalized approach to storing site map data in SQL Server.</span></span>

## <a name="step-1-creating-the-custom-site-map-provider-web-pages"></a><span data-ttu-id="f3b71-130">Шаг 1. Создание пользовательских веб-страниц поставщика карт сайта</span><span class="sxs-lookup"><span data-stu-id="f3b71-130">Step 1: Creating the Custom Site Map Provider Web Pages</span></span>

<span data-ttu-id="f3b71-131">Прежде чем приступить к созданию пользовательского поставщика карт узла, давайте сначала добавим страницы ASP.NET, необходимые для работы с этим руководством.</span><span class="sxs-lookup"><span data-stu-id="f3b71-131">Before we start creating a custom site map provider, let s first add the ASP.NET pages we'll need for this tutorial.</span></span> <span data-ttu-id="f3b71-132">Для начала добавьте новую папку с именем `SiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-132">Start by adding a new folder named `SiteMapProvider`.</span></span> <span data-ttu-id="f3b71-133">Затем добавьте в эту папку следующие страницы ASP.NET, чтобы связать каждую страницу с главной страницей `Site.master`:</span><span class="sxs-lookup"><span data-stu-id="f3b71-133">Next, add the following ASP.NET pages to that folder, making sure to associate each page with the `Site.master` master page:</span></span>

- `Default.aspx`
- `ProductsByCategory.aspx`
- `ProductDetails.aspx`

<span data-ttu-id="f3b71-134">Также добавьте вложенную папку `CustomProviders` в папку `App_Code`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-134">Also add a `CustomProviders` subfolder to the `App_Code` folder.</span></span>

![Добавление страниц ASP.NET для руководств, связанных с поставщиками карт узла](building-a-custom-database-driven-site-map-provider-cs/_static/image2.gif)

<span data-ttu-id="f3b71-136">**Рис. 2**. добавление страниц ASP.NET для руководств, связанных с поставщиками карт узла</span><span class="sxs-lookup"><span data-stu-id="f3b71-136">**Figure 2**: Add the ASP.NET Pages for the Site Map Provider-Related Tutorials</span></span>

<span data-ttu-id="f3b71-137">Так как в этом разделе есть только один учебник, нам не нужно `Default.aspx`, чтобы перечислить учебники по разделам.</span><span class="sxs-lookup"><span data-stu-id="f3b71-137">Since there is only one tutorial for this section, we don t need `Default.aspx` to list the section s tutorials.</span></span> <span data-ttu-id="f3b71-138">Вместо этого `Default.aspx` будут отображать категории в элементе управления GridView.</span><span class="sxs-lookup"><span data-stu-id="f3b71-138">Instead, `Default.aspx` will display the categories in a GridView control.</span></span> <span data-ttu-id="f3b71-139">Мы обсудим это на шаге 2.</span><span class="sxs-lookup"><span data-stu-id="f3b71-139">We'll tackle this in Step 2.</span></span>

<span data-ttu-id="f3b71-140">Затем обновите `Web.sitemap`, чтобы включить ссылку на страницу `Default.aspx`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-140">Next, update `Web.sitemap` to include a reference to the `Default.aspx` page.</span></span> <span data-ttu-id="f3b71-141">В частности, добавьте следующую разметку после `<siteMapNode>`кэширования:</span><span class="sxs-lookup"><span data-stu-id="f3b71-141">Specifically, add the following markup after the Caching `<siteMapNode>`:</span></span>

[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample1.xml)]

<span data-ttu-id="f3b71-142">После обновления `Web.sitemap`просмотрите веб-сайт учебников в браузере.</span><span class="sxs-lookup"><span data-stu-id="f3b71-142">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="f3b71-143">В меню слева теперь содержится элемент для единственного учебника по поставщику карт узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-143">The menu on the left now includes an item for the sole site map provider tutorial.</span></span>

![Схема узла теперь включает в себя запись для учебника по поставщику карт узла.](building-a-custom-database-driven-site-map-provider-cs/_static/image3.gif)

<span data-ttu-id="f3b71-145">**Рис. 3**. схема узла теперь включает в себя запись для учебника по поставщику карт узла</span><span class="sxs-lookup"><span data-stu-id="f3b71-145">**Figure 3**: The Site Map Now Includes an Entry for the Site Map Provider Tutorial</span></span>

<span data-ttu-id="f3b71-146">В этом учебнике основное внимание уделяется созданию пользовательского поставщика карт узла и настройке веб-приложения для использования этого поставщика.</span><span class="sxs-lookup"><span data-stu-id="f3b71-146">This tutorial s main focus is to illustrate creating a custom site map provider and configuring a web application to use that provider.</span></span> <span data-ttu-id="f3b71-147">В частности, мы создадим поставщик, возвращающий карту узла, которая включает корневой узел и узел для каждой категории и продукта, как показано на рис. 1.</span><span class="sxs-lookup"><span data-stu-id="f3b71-147">In particular, we'll build a provider that returns a site map that includes a root node along with a node for each category and product, as depicted in Figure 1.</span></span> <span data-ttu-id="f3b71-148">Как правило, каждый узел в карте узла может указывать URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="f3b71-148">In general, each node in the site map may specify a URL.</span></span> <span data-ttu-id="f3b71-149">Для нашей схемы узла URL-адрес корневого узла s будет `~/SiteMapProvider/Default.aspx`, в котором будут перечислены все категории в базе данных.</span><span class="sxs-lookup"><span data-stu-id="f3b71-149">For our site map, the root node s URL will be `~/SiteMapProvider/Default.aspx`, which will list all of the categories in the database.</span></span> <span data-ttu-id="f3b71-150">Каждый узел категории на карте узла будет иметь URL-адрес, указывающий на `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID`, в котором будут перечислены все продукты указанного *CategoryID*.</span><span class="sxs-lookup"><span data-stu-id="f3b71-150">Each category node in the site map will have a URL that points to `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID`, which will list all of the products in the specified *categoryID*.</span></span> <span data-ttu-id="f3b71-151">Наконец, каждый узел схемы узла продукта будет указывать на `~/SiteMapProvider/ProductDetails.aspx?ProductID=productID`, в котором будут отображаться сведения о конкретном продукте.</span><span class="sxs-lookup"><span data-stu-id="f3b71-151">Finally, each product site map node will point to `~/SiteMapProvider/ProductDetails.aspx?ProductID=productID`, which will display the specific product s details.</span></span>

<span data-ttu-id="f3b71-152">Для начала необходимо создать `Default.aspx`, `ProductsByCategory.aspx`и `ProductDetails.aspx` страницы.</span><span class="sxs-lookup"><span data-stu-id="f3b71-152">To start we need to create the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages.</span></span> <span data-ttu-id="f3b71-153">Эти страницы выполняются в шагах 2, 3 и 4 соответственно.</span><span class="sxs-lookup"><span data-stu-id="f3b71-153">These pages are completed in Steps 2, 3, and 4, respectively.</span></span> <span data-ttu-id="f3b71-154">Так как креативность этого учебника посвящены поставщикам карт веб-узлов, и, поскольку в прошлых учебных курсах были рассмотрены создание таких видов многостраничных отчетов «основной/подробности», мы спешите с шагами 2 – 4.</span><span class="sxs-lookup"><span data-stu-id="f3b71-154">Since the thrust of this tutorial is on site map providers, and since past tutorials have covered creating these sorts of multi-page master/detail reports, we will hurry through Steps 2 through 4.</span></span> <span data-ttu-id="f3b71-155">Если вам требуется Обновитель для создания отчетов «основной/подробности», охватывающих несколько страниц, ознакомьтесь с руководством « [основной/подробности фильтрация на двух страницах](../masterdetail/master-detail-filtering-across-two-pages-cs.md) ».</span><span class="sxs-lookup"><span data-stu-id="f3b71-155">If you need a refresher on creating master/detail reports that span multiple pages, refer back to the [Master/Detail Filtering Across Two Pages](../masterdetail/master-detail-filtering-across-two-pages-cs.md) tutorial.</span></span>

## <a name="step-2-displaying-a-list-of-categories"></a><span data-ttu-id="f3b71-156">Шаг 2. Отображение списка категорий</span><span class="sxs-lookup"><span data-stu-id="f3b71-156">Step 2: Displaying a List of Categories</span></span>

<span data-ttu-id="f3b71-157">Откройте страницу `Default.aspx` в папке `SiteMapProvider` и перетащите элемент управления GridView с панели инструментов в конструктор, установив для его `ID` значение `Categories`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-157">Open the `Default.aspx` page in the `SiteMapProvider` folder and drag a GridView from the Toolbox onto the Designer, setting its `ID` to `Categories`.</span></span> <span data-ttu-id="f3b71-158">Из смарт-тега GridView s привяжите его к новому ObjectDataSource с именем `CategoriesDataSource` и настройте его таким образом, чтобы он получал свои данные с помощью метода `CategoriesBLL` класса s `GetCategories`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-158">From the GridView s smart tag, bind it to a new ObjectDataSource named `CategoriesDataSource` and configure it so that it retrieves its data using the `CategoriesBLL` class s `GetCategories` method.</span></span> <span data-ttu-id="f3b71-159">Поскольку в этом элементе управления GridView просто отображаются категории и не предусмотрены возможности изменения данных, установите в раскрывающихся списках на вкладках обновления, вставки и удаления значение (нет).</span><span class="sxs-lookup"><span data-stu-id="f3b71-159">Since this GridView just displays the categories and does not provide data modification capabilities, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) .</span></span>

<span data-ttu-id="f3b71-160">[![настроить ObjectDataSource для возврата категорий с помощью метода Categories](building-a-custom-database-driven-site-map-provider-cs/_static/image4.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-160">[![Configure the ObjectDataSource to Return Categories Using the GetCategories Method](building-a-custom-database-driven-site-map-provider-cs/_static/image4.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image3.png)</span></span>

<span data-ttu-id="f3b71-161">**Рис. 4**. Настройка элемента управления ObjectDataSource для возврата категорий с помощью метода `GetCategories` ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-161">**Figure 4**: Configure the ObjectDataSource to Return Categories Using the `GetCategories` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image4.png))</span></span>

<span data-ttu-id="f3b71-162">[![установить в раскрывающихся списках на вкладках обновления, вставки и удаления значение (нет)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-162">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.png)</span></span>

<span data-ttu-id="f3b71-163">**Рис. 5**. Установка раскрывающихся списков на вкладках обновления, вставки и удаления в (нет) ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-163">**Figure 5**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image6.png))</span></span>

<span data-ttu-id="f3b71-164">После завершения работы мастера настройки источника данных Visual Studio добавит BoundField для `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`и `BrochurePath`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-164">After completing the Configure Data Source wizard, Visual Studio will add a BoundField for `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath`.</span></span> <span data-ttu-id="f3b71-165">Измените элемент GridView таким образом, чтобы он содержал только `CategoryName` и `Description` BoundFields, и обновите свойство `HeaderText` `CategoryName` BoundField на Category.</span><span class="sxs-lookup"><span data-stu-id="f3b71-165">Edit the GridView so that it only contains the `CategoryName` and `Description` BoundFields and update the `CategoryName` BoundField s `HeaderText` property to Category .</span></span>

<span data-ttu-id="f3b71-166">Затем добавьте HyperLinkField и поместите его в крайнее левое поле.</span><span class="sxs-lookup"><span data-stu-id="f3b71-166">Next, add a HyperLinkField and position it so that it s the left-most field.</span></span> <span data-ttu-id="f3b71-167">Задайте для свойства `DataNavigateUrlFields` значение `CategoryID` а свойству `DataNavigateUrlFormatString` — значение `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID={0}`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-167">Set the `DataNavigateUrlFields` property to `CategoryID` and the `DataNavigateUrlFormatString` property to `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID={0}`.</span></span> <span data-ttu-id="f3b71-168">Задайте свойство `Text` для просмотра продуктов.</span><span class="sxs-lookup"><span data-stu-id="f3b71-168">Set the `Text` property to View Products .</span></span>

![Добавление HyperLinkField к категории GridView](building-a-custom-database-driven-site-map-provider-cs/_static/image6.gif)

<span data-ttu-id="f3b71-170">**Рис. 6**. Добавление HyperLinkField в `Categories` GridView</span><span class="sxs-lookup"><span data-stu-id="f3b71-170">**Figure 6**: Add a HyperLinkField to the `Categories` GridView</span></span>

<span data-ttu-id="f3b71-171">После создания ObjectDataSource и настройки полей GridView два элемента управления декларативная разметка будет выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="f3b71-171">After creating the ObjectDataSource and customizing the GridView s fields, the two controls declarative markup will look like the following:</span></span>

[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample2.aspx)]

<span data-ttu-id="f3b71-172">На рис. 7 показано, `Default.aspx` при просмотре в браузере.</span><span class="sxs-lookup"><span data-stu-id="f3b71-172">Figure 7 shows `Default.aspx` when viewed through a browser.</span></span> <span data-ttu-id="f3b71-173">Щелкнув ссылку категории s View Products, вы перейдете к `ProductsByCategory.aspx?CategoryID=categoryID`, которая будет построена на шаге 3.</span><span class="sxs-lookup"><span data-stu-id="f3b71-173">Clicking a category s View Products link takes you to `ProductsByCategory.aspx?CategoryID=categoryID`, which we will build in Step 3.</span></span>

<span data-ttu-id="f3b71-174">[![каждая категория указана вместе со ссылкой «Просмотр продуктов»](building-a-custom-database-driven-site-map-provider-cs/_static/image7.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-174">[![Each Category is Listed Along with a View Products Link](building-a-custom-database-driven-site-map-provider-cs/_static/image7.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image7.png)</span></span>

<span data-ttu-id="f3b71-175">**Рис. 7**. Каждая категория отображается вместе со ссылкой «Просмотр продуктов» ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image8.png)).</span><span class="sxs-lookup"><span data-stu-id="f3b71-175">**Figure 7**: Each Category is Listed Along with a View Products Link ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image8.png))</span></span>

## <a name="step-3-listing-the-selected-category-s-products"></a><span data-ttu-id="f3b71-176">Шаг 3. перечисление выбранных продуктов категории</span><span class="sxs-lookup"><span data-stu-id="f3b71-176">Step 3: Listing the Selected Category s Products</span></span>

<span data-ttu-id="f3b71-177">Откройте страницу `ProductsByCategory.aspx` и добавьте элемент GridView, назвав его `ProductsByCategory`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-177">Open the `ProductsByCategory.aspx` page and add a GridView, naming it `ProductsByCategory`.</span></span> <span data-ttu-id="f3b71-178">Из своего смарт-тега привяжите GridView к новому элементу ObjectDataSource с именем `ProductsByCategoryDataSource`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-178">From its smart tag, bind the GridView to a new ObjectDataSource named `ProductsByCategoryDataSource`.</span></span> <span data-ttu-id="f3b71-179">Настройте ObjectDataSource для использования метода `ProductsBLL` Class s `GetProductsByCategoryID(categoryID)` и задайте для раскрывающихся списков значение (нет) на вкладках обновление, вставка и удаление.</span><span class="sxs-lookup"><span data-stu-id="f3b71-179">Configure the ObjectDataSource to use the `ProductsBLL` class s `GetProductsByCategoryID(categoryID)` method and set the drop-down lists to (None) in the UPDATE, INSERT, and DELETE tabs.</span></span>

<span data-ttu-id="f3b71-180">[![использовать метод GetProductsByCategoryID класса ProductsBLL (categoryID)](building-a-custom-database-driven-site-map-provider-cs/_static/image8.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-180">[![Use the ProductsBLL Class s GetProductsByCategoryID(categoryID) Method](building-a-custom-database-driven-site-map-provider-cs/_static/image8.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image9.png)</span></span>

<span data-ttu-id="f3b71-181">**Рис. 8**. использование метода `GetProductsByCategoryID(categoryID)` `ProductsBLL` классов ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-181">**Figure 8**: Use the `ProductsBLL` Class s `GetProductsByCategoryID(categoryID)` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image10.png))</span></span>

<span data-ttu-id="f3b71-182">На последнем шаге мастера настройки источника данных запрашивается источник параметров для *CategoryID*.</span><span class="sxs-lookup"><span data-stu-id="f3b71-182">The final step in the Configure Data Source wizard prompts for a parameter source for *categoryID*.</span></span> <span data-ttu-id="f3b71-183">Так как эти сведения передаются через поле QueryString `CategoryID`, выберите строку запроса из раскрывающегося списка и введите CategoryID в текстовое поле QueryStringField, как показано на рис. 9.</span><span class="sxs-lookup"><span data-stu-id="f3b71-183">Since this information is passed through the querystring field `CategoryID`, select QueryString from the drop-down list and enter CategoryID in the QueryStringField textbox as shown in Figure 9.</span></span> <span data-ttu-id="f3b71-184">Чтобы завершить работу мастера, нажмите кнопку Готово.</span><span class="sxs-lookup"><span data-stu-id="f3b71-184">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="f3b71-185">[![использовать поле строки CategoryID для параметра categoryID](building-a-custom-database-driven-site-map-provider-cs/_static/image9.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-185">[![Use the CategoryID Querystring Field for the categoryID Parameter](building-a-custom-database-driven-site-map-provider-cs/_static/image9.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image11.png)</span></span>

<span data-ttu-id="f3b71-186">**Рис. 9**. Использование поля QueryString `CategoryID` для параметра *CategoryID* ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-186">**Figure 9**: Use the `CategoryID` Querystring Field for the *categoryID* Parameter ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image12.png))</span></span>

<span data-ttu-id="f3b71-187">После завершения работы мастера Visual Studio добавит соответствующие BoundFields и CheckBoxField в GridView для полей данных продукта.</span><span class="sxs-lookup"><span data-stu-id="f3b71-187">After completing the wizard, Visual Studio will add corresponding BoundFields and a CheckBoxField to the GridView for the product data fields.</span></span> <span data-ttu-id="f3b71-188">Удалите все, кроме `ProductName`, `UnitPrice`и `SupplierName` BoundFields.</span><span class="sxs-lookup"><span data-stu-id="f3b71-188">Remove all but the `ProductName`, `UnitPrice`, and `SupplierName` BoundFields.</span></span> <span data-ttu-id="f3b71-189">Настройте эти три свойства `HeaderText` BoundFields для чтения продукта, цены и поставщика соответственно.</span><span class="sxs-lookup"><span data-stu-id="f3b71-189">Customize these three BoundFields `HeaderText` properties to read Product, Price, and Supplier, respectively.</span></span> <span data-ttu-id="f3b71-190">Отформатируйте `UnitPrice` BoundField как валюту.</span><span class="sxs-lookup"><span data-stu-id="f3b71-190">Format the `UnitPrice` BoundField as a currency.</span></span>

<span data-ttu-id="f3b71-191">Затем добавьте HyperLinkField и переместите его в крайнее левое положение.</span><span class="sxs-lookup"><span data-stu-id="f3b71-191">Next, add a HyperLinkField and move it to the left-most position.</span></span> <span data-ttu-id="f3b71-192">Задайте для свойства `Text` значение, чтобы просмотреть сведения, свойство `DataNavigateUrlFields` для `ProductID`, а для свойства `DataNavigateUrlFormatString` — значение `~/SiteMapProvider/ProductDetails.aspx?ProductID={0}`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-192">Set its `Text` property to View Details, its `DataNavigateUrlFields` property to `ProductID`, and its `DataNavigateUrlFormatString` property to `~/SiteMapProvider/ProductDetails.aspx?ProductID={0}`.</span></span>

![Добавьте сведения о представлении HyperLinkField, указывающие на Продуктдетаилс. aspx](building-a-custom-database-driven-site-map-provider-cs/_static/image10.gif)

<span data-ttu-id="f3b71-194">**Рис. 10**. Добавление сведений о представлении HyperLinkField, указывающих на `ProductDetails.aspx`</span><span class="sxs-lookup"><span data-stu-id="f3b71-194">**Figure 10**: Add a View Details HyperLinkField that Points to `ProductDetails.aspx`</span></span>

<span data-ttu-id="f3b71-195">После выполнения этих настроек декларативная разметка GridView и ObjectDataSource должна выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="f3b71-195">After making these customizations, the GridView and ObjectDataSource s declarative markup should resemble the following:</span></span>

[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample3.aspx)]

<span data-ttu-id="f3b71-196">Вернитесь к просмотру `Default.aspx` через браузер и щелкните ссылку Просмотреть продукты для напитков.</span><span class="sxs-lookup"><span data-stu-id="f3b71-196">Return to viewing `Default.aspx` through a browser and click on the View Products link for Beverages.</span></span> <span data-ttu-id="f3b71-197">Это приведет к `ProductsByCategory.aspx?CategoryID=1`, отображению имен, цен и поставщиков продуктов в базе данных Northwind, принадлежащих категории «напитки» (см. рис. 11).</span><span class="sxs-lookup"><span data-stu-id="f3b71-197">This will take you to `ProductsByCategory.aspx?CategoryID=1`, displaying the names, prices, and suppliers of the products in the Northwind database that belong to the Beverages category (see Figure 11).</span></span> <span data-ttu-id="f3b71-198">Вы можете еще больше усовершенствовать эту страницу, включив ссылку для возврата пользователей на страницу со списком категорий (`Default.aspx`) и элемент управления DetailsView или FormView, отображающий выбранную категорию имя и описание.</span><span class="sxs-lookup"><span data-stu-id="f3b71-198">Feel free to further enhance this page to include a link to return users to the category listing page (`Default.aspx`) and a DetailsView or FormView control that displays the selected category s name and description.</span></span>

<span data-ttu-id="f3b71-199">[![отображаются названия напитков, цены и поставщики](building-a-custom-database-driven-site-map-provider-cs/_static/image11.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-199">[![The Beverages Names, Prices, and Suppliers are Displayed](building-a-custom-database-driven-site-map-provider-cs/_static/image11.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image13.png)</span></span>

<span data-ttu-id="f3b71-200">**Рис. 11**. Отображение названий напитков, цен и поставщиков ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-200">**Figure 11**: The Beverages Names, Prices, and Suppliers are Displayed ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image14.png))</span></span>

## <a name="step-4-showing-a-product-s-details"></a><span data-ttu-id="f3b71-201">Шаг 4. Отображение сведений о продукте</span><span class="sxs-lookup"><span data-stu-id="f3b71-201">Step 4: Showing a Product s Details</span></span>

<span data-ttu-id="f3b71-202">На последней странице `ProductDetails.aspx`отображаются сведения о выбранных продуктах.</span><span class="sxs-lookup"><span data-stu-id="f3b71-202">The final page, `ProductDetails.aspx`, displays the selected products details.</span></span> <span data-ttu-id="f3b71-203">Откройте `ProductDetails.aspx` и перетащите элемент DetailsView с панели элементов на конструктор.</span><span class="sxs-lookup"><span data-stu-id="f3b71-203">Open `ProductDetails.aspx` and drag a DetailsView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="f3b71-204">Задайте свойству `ID` DetailsView s значение `ProductInfo` и удалите значения свойств `Height` и `Width`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-204">Set the DetailsView s `ID` property to `ProductInfo` and clear out its `Height` and `Width` property values.</span></span> <span data-ttu-id="f3b71-205">Из своего смарт-тега свяжите DetailsView с новым ObjectDataSource с именем `ProductDataSource`, настроив ObjectDataSource на извлечение своих данных из `ProductsBLL` класса s `GetProductByProductID(productID)` метода.</span><span class="sxs-lookup"><span data-stu-id="f3b71-205">From its smart tag, bind the DetailsView to a new ObjectDataSource named `ProductDataSource`, configuring the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProductByProductID(productID)` method.</span></span> <span data-ttu-id="f3b71-206">Как и в предыдущих веб-страницах, созданных в шагах 2 и 3, установите раскрывающиеся списки на вкладках обновление, вставка и удаление в значение (нет).</span><span class="sxs-lookup"><span data-stu-id="f3b71-206">As with the previous web pages created in Steps 2 and 3, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) .</span></span>

<span data-ttu-id="f3b71-207">[![настроить ObjectDataSource для использования метода Жетпродуктбипродуктид (productID)](building-a-custom-database-driven-site-map-provider-cs/_static/image12.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-207">[![Configure the ObjectDataSource to Use the GetProductByProductID(productID) Method](building-a-custom-database-driven-site-map-provider-cs/_static/image12.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.png)</span></span>

<span data-ttu-id="f3b71-208">**Рис. 12**. Настройка ObjectDataSource для использования метода `GetProductByProductID(productID)` ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-208">**Figure 12**: Configure the ObjectDataSource to Use the `GetProductByProductID(productID)` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image16.png))</span></span>

<span data-ttu-id="f3b71-209">На последнем шаге мастера настройки источника данных запрашивается источник параметра *ProductID* .</span><span class="sxs-lookup"><span data-stu-id="f3b71-209">The last step of the Configure Data Source wizard prompts for the source of the *productID* parameter.</span></span> <span data-ttu-id="f3b71-210">Так как эти данные поступают через поле QueryString `ProductID`, задайте для раскрывающегося списка значение QueryString, а в текстовом поле QueryStringField — ProductID.</span><span class="sxs-lookup"><span data-stu-id="f3b71-210">Since this data comes through the querystring field `ProductID`, set the drop-down list to QueryString and the QueryStringField textbox to ProductID.</span></span> <span data-ttu-id="f3b71-211">Наконец, нажмите кнопку "Готово", чтобы завершить работу мастера.</span><span class="sxs-lookup"><span data-stu-id="f3b71-211">Finally, click the Finish button to complete the wizard.</span></span>

<span data-ttu-id="f3b71-212">[![настроить параметр productID для извлечения его значения из поля строки запроса ProductID](building-a-custom-database-driven-site-map-provider-cs/_static/image13.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-212">[![Configure the productID Parameter to Pull its Value from the ProductID Querystring Field](building-a-custom-database-driven-site-map-provider-cs/_static/image13.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image17.png)</span></span>

<span data-ttu-id="f3b71-213">**Рис. 13**. Настройка параметра *ProductID* для извлечения его значения из поля `ProductID` QueryString ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-213">**Figure 13**: Configure the *productID* Parameter to Pull its Value from the `ProductID` Querystring Field ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image18.png))</span></span>

<span data-ttu-id="f3b71-214">После завершения работы мастера настройки источника данных Visual Studio создаст соответствующие BoundFields и CheckBoxField в DetailsView для полей данных продукта.</span><span class="sxs-lookup"><span data-stu-id="f3b71-214">After completing the Configure Data Source wizard, Visual Studio will create corresponding BoundFields and a CheckBoxField in the DetailsView for the product data fields.</span></span> <span data-ttu-id="f3b71-215">Удалите `ProductID`, `SupplierID`и `CategoryID` BoundFields и настройте оставшиеся поля по своему усмотрению.</span><span class="sxs-lookup"><span data-stu-id="f3b71-215">Remove the `ProductID`, `SupplierID`, and `CategoryID` BoundFields and configure the remaining fields as you see fit.</span></span> <span data-ttu-id="f3b71-216">После нескольких конфигураций Aesthetic декларативная разметка DetailsView и ObjectDataSource выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="f3b71-216">After a handful of aesthetic configurations, my DetailsView and ObjectDataSource s declarative markup looked like the following:</span></span>

[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample4.aspx)]

<span data-ttu-id="f3b71-217">Чтобы протестировать эту страницу, вернитесь в `Default.aspx` и щелкните Просмотр продуктов для категории "напитки".</span><span class="sxs-lookup"><span data-stu-id="f3b71-217">To test this page, return to `Default.aspx` and click on View Products for the Beverages category.</span></span> <span data-ttu-id="f3b71-218">В списке продуктов напитков щелкните ссылку Просмотреть сведения для Чай Chai.</span><span class="sxs-lookup"><span data-stu-id="f3b71-218">From the listing of beverage products, click on the View Details link for Chai Tea.</span></span> <span data-ttu-id="f3b71-219">Откроется `ProductDetails.aspx?ProductID=1`, в котором отображаются сведения о Чай Chai (см. рис. 14).</span><span class="sxs-lookup"><span data-stu-id="f3b71-219">This will take you to `ProductDetails.aspx?ProductID=1`, which shows a Chai Tea s details (see Figure 14).</span></span>

<span data-ttu-id="f3b71-220">[Отображается ![поставщика Chai, категория, Цена и другие сведения.](building-a-custom-database-driven-site-map-provider-cs/_static/image14.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-220">[![Chai Tea s Supplier, Category, Price, and Other Information is Displayed](building-a-custom-database-driven-site-map-provider-cs/_static/image14.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image19.png)</span></span>

<span data-ttu-id="f3b71-221">**Рис. 14**. отображается поставщик, категория, Цена и другие сведения, отображаемые в списке Chai ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-221">**Figure 14**: Chai Tea s Supplier, Category, Price, and Other Information is Displayed ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image20.png))</span></span>

## <a name="step-5-understanding-the-inner-workings-of-a-site-map-provider"></a><span data-ttu-id="f3b71-222">Шаг 5. Основные сведения о внутренних принципах работы поставщика карт веб-сайтов</span><span class="sxs-lookup"><span data-stu-id="f3b71-222">Step 5: Understanding the Inner Workings of a Site Map Provider</span></span>

<span data-ttu-id="f3b71-223">Схема узла представлена в памяти веб-сервера как коллекция `SiteMapNode` экземпляров, образующих иерархию.</span><span class="sxs-lookup"><span data-stu-id="f3b71-223">The site map is represented in the web server s memory as a collection of `SiteMapNode` instances that form a hierarchy.</span></span> <span data-ttu-id="f3b71-224">Должно быть ровно один корень, все некорневые узлы должны иметь ровно один родительский узел, а все узлы могут иметь произвольное число дочерних элементов.</span><span class="sxs-lookup"><span data-stu-id="f3b71-224">There must be exactly one root, all non-root nodes must have exactly one parent node, and all nodes may have an arbitrary number of children.</span></span> <span data-ttu-id="f3b71-225">Каждый объект `SiteMapNode` представляет раздел в структуре веб-сайта. в этих разделах обычно есть соответствующая веб-страница.</span><span class="sxs-lookup"><span data-stu-id="f3b71-225">Each `SiteMapNode` object represents a section in the website s structure; these sections commonly have a corresponding web page.</span></span> <span data-ttu-id="f3b71-226">Следовательно, [класс`SiteMapNode`](https://msdn.microsoft.com/library/system.web.sitemapnode.aspx) имеет такие свойства, как `Title`, `Url`и `Description`, которые предоставляют сведения для раздела, который представляет `SiteMapNode`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-226">Consequently, the [`SiteMapNode` class](https://msdn.microsoft.com/library/system.web.sitemapnode.aspx) has properties like `Title`, `Url`, and `Description`, which provide information for the section the `SiteMapNode` represents.</span></span> <span data-ttu-id="f3b71-227">Существует также свойство `Key`, которое однозначно определяет каждую `SiteMapNode` в иерархии, а также свойства, используемые для создания иерархии `ChildNodes`, `ParentNode`, `NextSibling`, `PreviousSibling`и т. д.</span><span class="sxs-lookup"><span data-stu-id="f3b71-227">There is also a `Key` property that uniquely identifies each `SiteMapNode` in the hierarchy, as well as properties used to establish this hierarchy `ChildNodes`, `ParentNode`, `NextSibling`, `PreviousSibling`, and so forth.</span></span>

<span data-ttu-id="f3b71-228">На рис. 15 показана общая структура карт узла на рис. 1, но при этом детали реализации набросаны более подробно.</span><span class="sxs-lookup"><span data-stu-id="f3b71-228">Figure 15 shows the general site map structure from Figure 1, but with the implementation details sketched out in finer detail.</span></span>

<span data-ttu-id="f3b71-229">[![каждый SiteMapNode имеет такие свойства, как Title, URL-адрес, ключ и т. д.](building-a-custom-database-driven-site-map-provider-cs/_static/image16.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.gif)</span><span class="sxs-lookup"><span data-stu-id="f3b71-229">[![Each SiteMapNode has Properties Like Title, Url, Key, and So On](building-a-custom-database-driven-site-map-provider-cs/_static/image16.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.gif)</span></span>

<span data-ttu-id="f3b71-230">**Рис. 15**. Каждый `SiteMapNode` имеет такие свойства, как `Title`, `Url`, `Key`и т. д. ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image17.gif))</span><span class="sxs-lookup"><span data-stu-id="f3b71-230">**Figure 15**: Each `SiteMapNode` has Properties Like `Title`, `Url`, `Key`, and So On ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image17.gif))</span></span>

<span data-ttu-id="f3b71-231">Карту узла доступны через [класс`SiteMap`](https://msdn.microsoft.com/library/system.web.sitemap.aspx) в [пространстве имен`System.Web`](https://msdn.microsoft.com/library/system.web.aspx).</span><span class="sxs-lookup"><span data-stu-id="f3b71-231">The site map is accessible through the [`SiteMap` class](https://msdn.microsoft.com/library/system.web.sitemap.aspx) in the [`System.Web` namespace](https://msdn.microsoft.com/library/system.web.aspx).</span></span> <span data-ttu-id="f3b71-232">Это свойство `RootNode` классов возвращает корневой экземпляр `SiteMapNode` узла Map. `CurrentNode` возвращает `SiteMapNode`, свойство `Url` которого соответствует URL-адресу запрашиваемой в данный момент страницы.</span><span class="sxs-lookup"><span data-stu-id="f3b71-232">This class s `RootNode` property returns the site map s root `SiteMapNode` instance; `CurrentNode` returns the `SiteMapNode` whose `Url` property matches the URL of the currently requested page.</span></span> <span data-ttu-id="f3b71-233">Этот класс используется внутри веб-элементов управления навигации ASP.NET 2,0.</span><span class="sxs-lookup"><span data-stu-id="f3b71-233">This class is used internally by ASP.NET 2.0 s navigation Web controls.</span></span>

<span data-ttu-id="f3b71-234">При доступе к свойствам `SiteMap` классов необходимо сериализовать структуру карт узла из некоторого постоянного источника в память.</span><span class="sxs-lookup"><span data-stu-id="f3b71-234">When the `SiteMap` class s properties are accessed, it must serialize the site map structure from some persistent medium into memory.</span></span> <span data-ttu-id="f3b71-235">Однако логика сериализации карт узла не жестко кодируется в класс `SiteMap`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-235">However, the site map serialization logic is not hard coded into the `SiteMap` class.</span></span> <span data-ttu-id="f3b71-236">Вместо этого во время выполнения класс `SiteMap` определяет, какой *поставщик* карт узла следует использовать для сериализации.</span><span class="sxs-lookup"><span data-stu-id="f3b71-236">Instead, at runtime the `SiteMap` class determines which site map *provider* to use for serialization.</span></span> <span data-ttu-id="f3b71-237">По умолчанию используется [класс`XmlSiteMapProvider`](https://msdn.microsoft.com/library/system.web.xmlsitemapprovider.aspx) , который считывает структуру карт узла из правильно отформатированного XML-файла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-237">By default, the [`XmlSiteMapProvider` class](https://msdn.microsoft.com/library/system.web.xmlsitemapprovider.aspx) is used, which reads the site map s structure from a properly-formatted XML file.</span></span> <span data-ttu-id="f3b71-238">Однако с небольшой наработкой мы можем создать собственный пользовательский поставщик карт узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-238">However, with a little bit of work we can create our own custom site map provider.</span></span>

<span data-ttu-id="f3b71-239">Все поставщики карт веб-сайтов должны быть производными от [класса`SiteMapProvider`](https://msdn.microsoft.com/library/system.web.sitemapprovider.aspx), который включает в себя необходимые методы и свойства, необходимые для поставщиков карт сайта, но не содержит много деталей реализации.</span><span class="sxs-lookup"><span data-stu-id="f3b71-239">All site map providers must be derived from the [`SiteMapProvider` class](https://msdn.microsoft.com/library/system.web.sitemapprovider.aspx), which includes the essential methods and properties needed for site map providers, but omits many of the implementation details.</span></span> <span data-ttu-id="f3b71-240">Второй класс, [`StaticSiteMapProvider`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.aspx), расширяет класс `SiteMapProvider` и содержит более надежную реализацию необходимых функций.</span><span class="sxs-lookup"><span data-stu-id="f3b71-240">A second class, [`StaticSiteMapProvider`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.aspx), extends the `SiteMapProvider` class and contains a more robust implementation of the needed functionality.</span></span> <span data-ttu-id="f3b71-241">На внутреннем уровне `StaticSiteMapProvider` сохраняет экземпляры `SiteMapNode` карте узла в `Hashtable` и предоставляет такие методы, как `AddNode(child, parent)`, `RemoveNode(siteMapNode),` и `Clear()`, которые добавляют и удаляют `SiteMapNode` s во внутреннюю `Hashtable`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-241">Internally, the `StaticSiteMapProvider` stores the `SiteMapNode` instances of the site map in a `Hashtable` and provides methods like `AddNode(child, parent)`, `RemoveNode(siteMapNode),` and `Clear()` that add and remove `SiteMapNode` s to the internal `Hashtable`.</span></span> <span data-ttu-id="f3b71-242">Класс `XmlSiteMapProvider` является производным от `StaticSiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-242">`XmlSiteMapProvider` is derived from `StaticSiteMapProvider`.</span></span>

<span data-ttu-id="f3b71-243">При создании пользовательского поставщика карт узла, который расширяет `StaticSiteMapProvider`, необходимо переопределить два абстрактных метода: [`BuildSiteMap`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.buildsitemap.aspx) и [`GetRootNodeCore`](https://msdn.microsoft.com/library/system.web.sitemapprovider.getrootnodecore.aspx).</span><span class="sxs-lookup"><span data-stu-id="f3b71-243">When creating a custom site map provider that extends `StaticSiteMapProvider`, there are two abstract methods that must be overridden: [`BuildSiteMap`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.buildsitemap.aspx) and [`GetRootNodeCore`](https://msdn.microsoft.com/library/system.web.sitemapprovider.getrootnodecore.aspx).</span></span> <span data-ttu-id="f3b71-244">`BuildSiteMap`, как и предполагает его название, отвечает за загрузку структуры карт узла из постоянного хранилища и ее конструирования в памяти.</span><span class="sxs-lookup"><span data-stu-id="f3b71-244">`BuildSiteMap`, as its name implies, is responsible for loading the site map structure from persistent storage and constructing it in memory.</span></span> <span data-ttu-id="f3b71-245">`GetRootNodeCore` возвращает корневой узел в карте сайта.</span><span class="sxs-lookup"><span data-stu-id="f3b71-245">`GetRootNodeCore` returns the root node in the site map.</span></span>

<span data-ttu-id="f3b71-246">Прежде чем веб-приложение сможет использовать поставщик карт узла, его необходимо зарегистрировать в конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="f3b71-246">Before a web application can use a site map provider it must be registered in the application s configuration.</span></span> <span data-ttu-id="f3b71-247">По умолчанию класс `XmlSiteMapProvider` регистрируется с именем `AspNetXmlSiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-247">By default, the `XmlSiteMapProvider` class is registered using the name `AspNetXmlSiteMapProvider`.</span></span> <span data-ttu-id="f3b71-248">Чтобы зарегистрировать дополнительные поставщики карт веб-сайтов, добавьте следующую разметку в `Web.config`:</span><span class="sxs-lookup"><span data-stu-id="f3b71-248">To register additional site map providers, add the following markup to `Web.config`:</span></span>

[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample5.xml)]

<span data-ttu-id="f3b71-249">Значение *имени* присваивает поставщику понятное имя, а *тип* указывает полное имя типа для поставщика карт узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-249">The *name* value assigns a human-readable name to the provider while *type* specifies the fully-qualified type name of the site map provider.</span></span> <span data-ttu-id="f3b71-250">После создания пользовательского поставщика карт веб-узла мы рассмотрим конкретные значения для значений *имени* и *типа* на шаге 7.</span><span class="sxs-lookup"><span data-stu-id="f3b71-250">We'll explore concrete values for the *name* and *type* values in Step 7, after we ve created our custom site map provider.</span></span>

<span data-ttu-id="f3b71-251">Экземпляр класса поставщика карт узла создается при первом доступе из класса `SiteMap` и остается в памяти в течение времени существования веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="f3b71-251">The site map provider class is instantiated the first time it is accessed from the `SiteMap` class and remains in memory for the lifetime of the web application.</span></span> <span data-ttu-id="f3b71-252">Поскольку существует только один экземпляр поставщика карт узла, который может вызываться из нескольких одновременных посетителей веб-узла, крайне важно, чтобы методы поставщика были *потокобезопасными*.</span><span class="sxs-lookup"><span data-stu-id="f3b71-252">Since there is only one instance of the site map provider that may be invoked from multiple, concurrent web site visitors, it is imperative that the provider s methods be *thread-safe*.</span></span>

<span data-ttu-id="f3b71-253">В целях повышения производительности и масштабируемости важно, чтобы мы кэшировал структуру карт сайтов в памяти и возвращали эту кэшированную структуру, а не создавать ее каждый раз при вызове метода `BuildSiteMap`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-253">For performance and scalability reasons, it s important that we cache the in-memory site map structure and return this cached structure rather than recreating it every time the `BuildSiteMap` method is invoked.</span></span> <span data-ttu-id="f3b71-254">`BuildSiteMap` может вызываться несколько раз для каждого запроса страницы на каждого пользователя в зависимости от используемых элементов управления навигацией на странице и глубины структуры карт узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-254">`BuildSiteMap` may be called several times per page request per user, depending on the navigation controls in use on the page and the depth of the site map structure.</span></span> <span data-ttu-id="f3b71-255">В любом случае, если не кэшировать структуру карт узла в `BuildSiteMap` тогда при каждом вызове потребуется повторно извлечь сведения о продукте и категории из архитектуры (что приведет к получению запроса к базе данных).</span><span class="sxs-lookup"><span data-stu-id="f3b71-255">In any case, if we do not cache the site map structure in `BuildSiteMap` then each time it is invoked we would need to re-retrieve the product and category information from the architecture (which would result in a query to the database).</span></span> <span data-ttu-id="f3b71-256">Как обсуждалось в предыдущих руководствах по кэшированию, кэшированные данные могут устареть.</span><span class="sxs-lookup"><span data-stu-id="f3b71-256">As we discussed in the previous caching tutorials, cached data can become stale.</span></span> <span data-ttu-id="f3b71-257">Чтобы бороться с этим, можно использовать срок действия, основанный на зависимости времени или кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="f3b71-257">To combat this, we can use either time- or SQL cache dependency-based expiries.</span></span>

> [!NOTE]
> <span data-ttu-id="f3b71-258">Поставщик карт узла может дополнительно переопределить [метод`Initialize`](https://msdn.microsoft.com/library/system.web.sitemapprovider.initialize.aspx).</span><span class="sxs-lookup"><span data-stu-id="f3b71-258">A site map provider may optionally override the [`Initialize` method](https://msdn.microsoft.com/library/system.web.sitemapprovider.initialize.aspx).</span></span> <span data-ttu-id="f3b71-259">`Initialize` вызывается, когда сначала создается поставщик схемы узла и ему передаются пользовательские атрибуты, назначенные поставщику в `Web.config` элемента `<add>`, например: `<add name="name" type="type" customAttribute="value" />`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-259">`Initialize` is invoked when the site map provider is first instantiated and is passed any custom attributes assigned to the provider in `Web.config` in the `<add>` element like: `<add name="name" type="type" customAttribute="value" />`.</span></span> <span data-ttu-id="f3b71-260">Это полезно, если необходимо разрешить разработчику страниц указывать различные параметры, связанные с поставщиком карт узла, без необходимости изменять код поставщика.</span><span class="sxs-lookup"><span data-stu-id="f3b71-260">It is useful if you want to allow a page developer to specify various site map provider-related settings without having to modify the provider s code.</span></span> <span data-ttu-id="f3b71-261">Например, если мы прочитали данные категорий и продуктов непосредственно из базы данных, а не через архитектуру, мы, вероятно, хотели бы позволить разработчику страницы указать строку подключения к базе данных с помощью `Web.config` вместо использования жестко закодированного значения в коде поставщика s.</span><span class="sxs-lookup"><span data-stu-id="f3b71-261">For example, if we were reading the category and products data directly from the database as opposed to through the architecture, we d likely want to let the page developer specify the database connection string through `Web.config` rather than using a hard coded value in the provider s code.</span></span> <span data-ttu-id="f3b71-262">Пользовательский поставщик карт узла, который будет построен на шаге 6, не переопределяет этот метод `Initialize`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-262">The custom site map provider we'll build in Step 6 does not override this `Initialize` method.</span></span> <span data-ttu-id="f3b71-263">Пример использования метода `Initialize` см. в статье об источнике " [Джефф Просайз](http://www.wintellect.com/Weblogs/CategoryView,category,Jeff%20Prosise.aspx) s" по [хранению карт сайтов в SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) .</span><span class="sxs-lookup"><span data-stu-id="f3b71-263">For an example of using the `Initialize` method, refer to [Jeff Prosise](http://www.wintellect.com/Weblogs/CategoryView,category,Jeff%20Prosise.aspx) s [Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) article.</span></span>

## <a name="step-6-creating-the-custom-site-map-provider"></a><span data-ttu-id="f3b71-264">Шаг 6. Создание пользовательского поставщика карт узла</span><span class="sxs-lookup"><span data-stu-id="f3b71-264">Step 6: Creating the Custom Site Map Provider</span></span>

<span data-ttu-id="f3b71-265">Чтобы создать пользовательский поставщик карт узла, который строит карту узла из категорий и продуктов в базе данных Northwind, необходимо создать класс, расширяющий `StaticSiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-265">To create a custom site map provider that builds the site map from the categories and products in the Northwind database, we need to create a class that extends `StaticSiteMapProvider`.</span></span> <span data-ttu-id="f3b71-266">На шаге 1 я попросил добавить папку `CustomProviders` в папку `App_Code` — добавить новый класс в эту папку с именем `NorthwindSiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-266">In Step 1 I asked you to add a `CustomProviders` folder in the `App_Code` folder - add a new class to this folder named `NorthwindSiteMapProvider`.</span></span> <span data-ttu-id="f3b71-267">Добавьте следующий код в класс `NorthwindSiteMapProvider` :</span><span class="sxs-lookup"><span data-stu-id="f3b71-267">Add the following code to the `NorthwindSiteMapProvider` class:</span></span>

[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample6.cs)]

<span data-ttu-id="f3b71-268">Давайте начнем с изучения этого метода `BuildSiteMap` класса, который начинается с [оператора`lock`](https://msdn.microsoft.com/library/c5kehkcz.aspx).</span><span class="sxs-lookup"><span data-stu-id="f3b71-268">Let s start with exploring this class s `BuildSiteMap` method, which starts with a [`lock` statement](https://msdn.microsoft.com/library/c5kehkcz.aspx).</span></span> <span data-ttu-id="f3b71-269">Оператор `lock` допускает вход только по одному потоку. Таким образом, он сериализует доступ к своему коду и предотвращает пошаговое выполнение двух параллельных потоков на одном другом наступал.</span><span class="sxs-lookup"><span data-stu-id="f3b71-269">The `lock` statement only allows one thread at a time to enter, thereby serializing access to its code and preventing two concurrent threads from stepping on one another s toes.</span></span>

<span data-ttu-id="f3b71-270">Переменная `SiteMapNode` уровня класса `root` используется для кэширования структуры карт узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-270">The class-level `SiteMapNode` variable `root` is used to cache the site map structure.</span></span> <span data-ttu-id="f3b71-271">При создании схемы узла в первый раз или в первый раз после изменения базовых данных `root` будет `null` и структура схемы узла будет создана.</span><span class="sxs-lookup"><span data-stu-id="f3b71-271">When the site map is constructed for the first time, or for the first time after the underlying data has been modified, `root` will be `null` and the site map structure will be constructed.</span></span> <span data-ttu-id="f3b71-272">Корневой узел узла Map s назначается `root` в процессе создания, поэтому при следующем вызове этого метода `root` не будет `null`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-272">The site map s root node is assigned to `root` during the construction process so that the next time this method is called, `root` will not be `null`.</span></span> <span data-ttu-id="f3b71-273">Таким образом, пока `root` не `null` структура схемы узла будет возвращена вызывающему объекту без необходимости ее повторного создания.</span><span class="sxs-lookup"><span data-stu-id="f3b71-273">Consequently, so long as `root` is not `null` the site map structure will be returned to the caller without having to recreate it.</span></span>

<span data-ttu-id="f3b71-274">Если параметр root имеет значение `null`, структура схемы узла создается на основе сведений о продукте и категории.</span><span class="sxs-lookup"><span data-stu-id="f3b71-274">If root is `null`, the site map structure is created from the product and category information.</span></span> <span data-ttu-id="f3b71-275">Схема узла строится путем создания `SiteMapNode` экземпляров и последующего формирования иерархии с помощью вызовов метода `StaticSiteMapProvider` класса s `AddNode`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-275">The site map is built by creating the `SiteMapNode` instances and then forming the hierarchy through calls to the `StaticSiteMapProvider` class s `AddNode` method.</span></span> <span data-ttu-id="f3b71-276">`AddNode` выполняет внутренний бухгалтерский вход, сохраняя экземпляры `SiteMapNode` ассортимента в `Hashtable`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-276">`AddNode` performs the internal bookkeeping, storing the assorted `SiteMapNode` instances in a `Hashtable`.</span></span> <span data-ttu-id="f3b71-277">Прежде чем приступить к построению иерархии, начнем с вызова метода `Clear`, который удаляет элементы из внутреннего `Hashtable`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-277">Before we start constructing the hierarchy, we start by calling the `Clear` method, which clears out the elements from the internal `Hashtable`.</span></span> <span data-ttu-id="f3b71-278">Затем метод `ProductsBLL` классов `GetProducts` и итоговые `ProductsDataTable` хранятся в локальных переменных.</span><span class="sxs-lookup"><span data-stu-id="f3b71-278">Next, the `ProductsBLL` class s `GetProducts` method and the resulting `ProductsDataTable` are stored in local variables.</span></span>

<span data-ttu-id="f3b71-279">Конструкция узла Map начинается с создания корневого узла и назначения его `root`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-279">The site map s construction begins by creating the root node and assigning it to `root`.</span></span> <span data-ttu-id="f3b71-280">Для перегрузки [конструктора`SiteMapNode` s](https://msdn.microsoft.com/library/system.web.sitemapnode.sitemapnode.aspx) , используемого здесь и во всех остальных `BuildSiteMap`, передаются следующие сведения:</span><span class="sxs-lookup"><span data-stu-id="f3b71-280">The overload of the [`SiteMapNode` s constructor](https://msdn.microsoft.com/library/system.web.sitemapnode.sitemapnode.aspx) used here and throughout this `BuildSiteMap` is passed the following information:</span></span>

- <span data-ttu-id="f3b71-281">Ссылка на поставщик карт узла (`this`).</span><span class="sxs-lookup"><span data-stu-id="f3b71-281">A reference to the site map provider (`this`).</span></span>
- <span data-ttu-id="f3b71-282">`Key``SiteMapNode`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-282">The `SiteMapNode` s `Key`.</span></span> <span data-ttu-id="f3b71-283">Это обязательное значение должно быть уникальным для каждого `SiteMapNode`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-283">This required value must be unique for each `SiteMapNode`.</span></span>
- <span data-ttu-id="f3b71-284">`Url``SiteMapNode`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-284">The `SiteMapNode` s `Url`.</span></span> <span data-ttu-id="f3b71-285">`Url` является необязательным, но если он указан, каждое значение `Url` `SiteMapNode` s должно быть уникальным.</span><span class="sxs-lookup"><span data-stu-id="f3b71-285">`Url` is optional, but if provided, each `SiteMapNode` s `Url` value must be unique.</span></span>
- <span data-ttu-id="f3b71-286">`Title``SiteMapNode`, который является обязательным.</span><span class="sxs-lookup"><span data-stu-id="f3b71-286">The `SiteMapNode` s `Title`, which is required.</span></span>

<span data-ttu-id="f3b71-287">Вызов метода `AddNode(root)` добавляет `SiteMapNode` `root` в карту узла в качестве корневого каталога.</span><span class="sxs-lookup"><span data-stu-id="f3b71-287">The `AddNode(root)` method call adds the `SiteMapNode` `root` to the site map as the root.</span></span> <span data-ttu-id="f3b71-288">Далее перечисляются все `ProductRow` в `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-288">Next, each `ProductRow` in the `ProductsDataTable` is enumerated.</span></span> <span data-ttu-id="f3b71-289">Если уже существует `SiteMapNode` для текущей категории Products, ссылка на которую имеется.</span><span class="sxs-lookup"><span data-stu-id="f3b71-289">If there already exists a `SiteMapNode` for the current product s category, it is referenced.</span></span> <span data-ttu-id="f3b71-290">В противном случае создается новый `SiteMapNode` для категории и добавляется как дочерний элемент `SiteMapNode``root` через вызов метода `AddNode(categoryNode, root)`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-290">Otherwise, a new `SiteMapNode` for the category is created and added as a child of the `SiteMapNode``root` through the `AddNode(categoryNode, root)` method call.</span></span> <span data-ttu-id="f3b71-291">После того как найден или создан соответствующий узел категории `SiteMapNode`, создается `SiteMapNode` для текущего продукта и добавляется в качестве дочернего элемента категории `SiteMapNode` через `AddNode(productNode, categoryNode)`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-291">After the appropriate category `SiteMapNode` node has been found or created, a `SiteMapNode` is created for the current product and added as a child of the category `SiteMapNode` via `AddNode(productNode, categoryNode)`.</span></span> <span data-ttu-id="f3b71-292">Обратите внимание, что категория `SiteMapNode` s `Url` значение свойства `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID`, а свойство Product `SiteMapNode` s `Url` назначается `~/SiteMapNode/ProductDetails.aspx?ProductID=productID`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-292">Note that the category `SiteMapNode` s `Url` property value is `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID` while the product `SiteMapNode` s `Url` property is assigned `~/SiteMapNode/ProductDetails.aspx?ProductID=productID`.</span></span>

> [!NOTE]
> <span data-ttu-id="f3b71-293">Эти продукты, имеющие `NULL` базы данных для своих `CategoryID`, группируются в категории, `SiteMapNode` свойство `Title` которого имеет значение None и для свойства `Url` задано пустая строка.</span><span class="sxs-lookup"><span data-stu-id="f3b71-293">Those products that have a database `NULL` value for their `CategoryID` are grouped under a category `SiteMapNode` whose `Title` property is set to None and whose `Url` property is set to an empty string.</span></span> <span data-ttu-id="f3b71-294">Я решил присвоить `Url` пустой строке, так как метод `ProductBLL` класса s `GetProductsByCategory(categoryID)` в настоящее время не имеет возможности возвращать только те продукты, для которых `NULL` `CategoryID` значение.</span><span class="sxs-lookup"><span data-stu-id="f3b71-294">I decided to set `Url` to an empty string since the `ProductBLL` class s `GetProductsByCategory(categoryID)` method currently lacks the capability to return just those products with a `NULL` `CategoryID` value.</span></span> <span data-ttu-id="f3b71-295">Кроме того, я хотел продемонстрировать, как элементы управления навигацией визуализируют `SiteMapNode`, в которой отсутствует значение для свойства `Url`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-295">Also, I wanted to demonstrate how the navigation controls render a `SiteMapNode` that lacks a value for its `Url` property.</span></span> <span data-ttu-id="f3b71-296">Я рекомендую расширить этот учебник таким образом, чтобы свойство None `SiteMapNode` s `Url` не указывало на `ProductsByCategory.aspx`, но только отображает продукты с `NULL` `CategoryID` значений.</span><span class="sxs-lookup"><span data-stu-id="f3b71-296">I encourage you to extend this tutorial so that the None `SiteMapNode` s `Url` property points to `ProductsByCategory.aspx`, yet only displays the products with `NULL` `CategoryID` values.</span></span>

<span data-ttu-id="f3b71-297">После создания схемы узла произвольный объект добавляется в кэш данных с помощью зависимости кэша SQL для `Categories` и `Products` таблиц через объект `AggregateCacheDependency`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-297">After constructing the site map, an arbitrary object is added to the data cache using a SQL cache dependency on the `Categories` and `Products` tables through an `AggregateCacheDependency` object.</span></span> <span data-ttu-id="f3b71-298">Мы изучили использование зависимостей кэша SQL в предыдущем руководстве, *используя зависимости кэша SQL*.</span><span class="sxs-lookup"><span data-stu-id="f3b71-298">We explored using SQL cache dependencies in the preceding tutorial, *Using SQL Cache Dependencies*.</span></span> <span data-ttu-id="f3b71-299">Однако пользовательский поставщик карт узла использует перегрузку метода `Insert` кэша данных, который мы еще не просматривая.</span><span class="sxs-lookup"><span data-stu-id="f3b71-299">The custom site map provider, however, uses an overload of the data cache s `Insert` method that we ve yet to explore.</span></span> <span data-ttu-id="f3b71-300">Эта перегрузка принимает в качестве окончательного входного параметра делегат, который вызывается при удалении объекта из кэша.</span><span class="sxs-lookup"><span data-stu-id="f3b71-300">This overload accepts as its final input parameter a delegate that is called when the object is removed from the cache.</span></span> <span data-ttu-id="f3b71-301">В частности, мы передаем новый [делегат`CacheItemRemovedCallback`](https://msdn.microsoft.com/library/system.web.caching.cacheitemremovedcallback.aspx) , указывающий на метод `OnSiteMapChanged`, определенный далее в классе `NorthwindSiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-301">Specifically, we pass in a new [`CacheItemRemovedCallback` delegate](https://msdn.microsoft.com/library/system.web.caching.cacheitemremovedcallback.aspx) that points to the `OnSiteMapChanged` method defined further down in the `NorthwindSiteMapProvider` class.</span></span>

> [!NOTE]
> <span data-ttu-id="f3b71-302">Представление схемы узла в памяти кэшируется с помощью переменной уровня класса `root`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-302">The in-memory representation of the site map is cached through the class-level variable `root`.</span></span> <span data-ttu-id="f3b71-303">Так как существует только один экземпляр пользовательского класса поставщика карт узла, и поскольку этот экземпляр является общим для всех потоков в веб-приложении, эта переменная класса выступает в качестве кэша.</span><span class="sxs-lookup"><span data-stu-id="f3b71-303">Since there is only one instance of the custom site map provider class and since that instance is shared among all threads in the web application, this class variable serves as a cache.</span></span> <span data-ttu-id="f3b71-304">Метод `BuildSiteMap` также использует кэш данных, но только в качестве средства для получения уведомления при изменении данных базовой базы данных в `Categories` или в `Products` таблицах.</span><span class="sxs-lookup"><span data-stu-id="f3b71-304">The `BuildSiteMap` method also uses the data cache, but only as a means to receive notification when the underlying database data in the `Categories` or `Products` tables changes.</span></span> <span data-ttu-id="f3b71-305">Обратите внимание, что значение, помещаемое в кэш данных, — это только текущая дата и время.</span><span class="sxs-lookup"><span data-stu-id="f3b71-305">Note that the value put into the data cache is just the current date and time.</span></span> <span data-ttu-id="f3b71-306">Фактические данные схемы узла *не* помещаются в кэш данных.</span><span class="sxs-lookup"><span data-stu-id="f3b71-306">The actual site map data is *not* put in the data cache.</span></span>

<span data-ttu-id="f3b71-307">Метод `BuildSiteMap` завершается возвратом корневого узла схемы узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-307">The `BuildSiteMap` method completes by returning the root node of the site map.</span></span>

<span data-ttu-id="f3b71-308">Остальные методы довольно просты.</span><span class="sxs-lookup"><span data-stu-id="f3b71-308">The remaining methods are fairly straightforward.</span></span> <span data-ttu-id="f3b71-309">`GetRootNodeCore` отвечает за возврат корневого узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-309">`GetRootNodeCore` is responsible for returning the root node.</span></span> <span data-ttu-id="f3b71-310">Поскольку `BuildSiteMap` возвращает корень, `GetRootNodeCore` просто возвращает возвращаемое значение `BuildSiteMap` s.</span><span class="sxs-lookup"><span data-stu-id="f3b71-310">Since `BuildSiteMap` returns the root, `GetRootNodeCore` simply returns `BuildSiteMap` s return value.</span></span> <span data-ttu-id="f3b71-311">Метод `OnSiteMapChanged` задает `root` возвращаться к `null` при удалении элемента кэша.</span><span class="sxs-lookup"><span data-stu-id="f3b71-311">The `OnSiteMapChanged` method sets `root` back to `null` when the cache item is removed.</span></span> <span data-ttu-id="f3b71-312">Если для параметра root задано значение `null`, то при следующем вызове `BuildSiteMap` будет перестроена структура схемы узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-312">With root set back to `null`, the next time `BuildSiteMap` is invoked, the site map structure will be rebuilt.</span></span> <span data-ttu-id="f3b71-313">Наконец, свойство `CachedDate` возвращает значение даты и времени, хранящееся в кэше данных, если такое значение существует.</span><span class="sxs-lookup"><span data-stu-id="f3b71-313">Lastly, the `CachedDate` property returns the date and time value stored in the data cache, if such a value exists.</span></span> <span data-ttu-id="f3b71-314">Это свойство может использоваться разработчиком страницы для определения времени последнего кэширования данных карт узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-314">This property can be used by a page developer to determine when the site map data was last cached.</span></span>

## <a name="step-7-registering-thenorthwindsitemapprovider"></a><span data-ttu-id="f3b71-315">Шаг 7. Регистрация`NorthwindSiteMapProvider`</span><span class="sxs-lookup"><span data-stu-id="f3b71-315">Step 7: Registering the`NorthwindSiteMapProvider`</span></span>

<span data-ttu-id="f3b71-316">Чтобы веб-приложение использовало `NorthwindSiteMapProvider` поставщика карт узла, созданного на шаге 6, необходимо зарегистрировать его в разделе `<siteMap>` `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-316">In order for our web application to use the `NorthwindSiteMapProvider` site map provider created in Step 6, we need to register it in the `<siteMap>` section of `Web.config`.</span></span> <span data-ttu-id="f3b71-317">В частности, добавьте следующую разметку в элемент `<system.web>` в `Web.config`:</span><span class="sxs-lookup"><span data-stu-id="f3b71-317">Specifically, add the following markup within the `<system.web>` element in `Web.config`:</span></span>

[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample7.xml)]

<span data-ttu-id="f3b71-318">Эта разметка состоит из двух вещей: во-первых, это означает, что встроенная `AspNetXmlSiteMapProvider` является поставщиком схемы сайта по умолчанию. Во-вторых, он регистрирует пользовательский поставщик карт узла, созданный на шаге 6, с понятным именем Northwind.</span><span class="sxs-lookup"><span data-stu-id="f3b71-318">This markup does two things: first, it indicates that the built-in `AspNetXmlSiteMapProvider` is the default site map provider; second, it registers the custom site map provider created in Step 6 with the human-friendly name Northwind .</span></span>

> [!NOTE]
> <span data-ttu-id="f3b71-319">Для поставщиков карт веб-сайтов, расположенных в папке Application `App_Code`, значением атрибута `type` является просто имя класса.</span><span class="sxs-lookup"><span data-stu-id="f3b71-319">For site map providers located in the application s `App_Code` folder, the value of the `type` attribute is simply the class name.</span></span> <span data-ttu-id="f3b71-320">Кроме того, Пользовательский поставщик карт узла может быть создан в отдельном проекте библиотеки классов с скомпилированной сборкой, помещенной в каталог веб-приложений `/Bin` Directory.</span><span class="sxs-lookup"><span data-stu-id="f3b71-320">Alternatively, the custom site map provider could have been created in a separate Class Library project with the compiled assembly placed in the web application s `/Bin` directory.</span></span> <span data-ttu-id="f3b71-321">В этом случае значением атрибута `type` будет *пространство имен*. *ClassName*, *AssemblyName* .</span><span class="sxs-lookup"><span data-stu-id="f3b71-321">In that case, the `type` attribute value would be *Namespace*.*ClassName*, *AssemblyName* .</span></span>

<span data-ttu-id="f3b71-322">После обновления `Web.config`Потратьте некоторое время на просмотр любой страницы из учебников в браузере.</span><span class="sxs-lookup"><span data-stu-id="f3b71-322">After updating `Web.config`, take a moment to view any page from the tutorials in a browser.</span></span> <span data-ttu-id="f3b71-323">Обратите внимание, что в интерфейсе навигации слева по-прежнему отображаются разделы и учебники, определенные в `Web.sitemap`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-323">Note that the navigation interface on the left still shows the sections and tutorials defined in `Web.sitemap`.</span></span> <span data-ttu-id="f3b71-324">Это связано с тем, что мы оставили `AspNetXmlSiteMapProvider` как поставщик по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="f3b71-324">This is because we left `AspNetXmlSiteMapProvider` as the default provider.</span></span> <span data-ttu-id="f3b71-325">Чтобы создать элемент пользовательского интерфейса навигации, использующий `NorthwindSiteMapProvider`, необходимо явно указать, что должен использоваться поставщик карты сайта "Борей".</span><span class="sxs-lookup"><span data-stu-id="f3b71-325">In order to create a navigation user interface element that uses the `NorthwindSiteMapProvider`, we'll need to explicitly specify that the Northwind site map provider should be used.</span></span> <span data-ttu-id="f3b71-326">Мы посмотрим, как это сделать на шаге 8.</span><span class="sxs-lookup"><span data-stu-id="f3b71-326">We'll see how to accomplish this in Step 8.</span></span>

## <a name="step-8-displaying-site-map-information-using-the-custom-site-map-provider"></a><span data-ttu-id="f3b71-327">Шаг 8. Отображение сведений о карте сайта с помощью пользовательского поставщика карт веб-узла</span><span class="sxs-lookup"><span data-stu-id="f3b71-327">Step 8: Displaying Site Map Information Using the Custom Site Map Provider</span></span>

<span data-ttu-id="f3b71-328">С помощью пользовательского поставщика карт узла, созданного и зарегистрированного в `Web.config`, мы повторно готовы к добавлению элементов управления навигацией на `Default.aspx`, `ProductsByCategory.aspx`и `ProductDetails.aspx` страниц в папке `SiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-328">With the custom site map provider created and registered in `Web.config`, we re ready to add navigation controls to the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages in the `SiteMapProvider` folder.</span></span> <span data-ttu-id="f3b71-329">Для начала откройте страницу `Default.aspx` и перетащите `SiteMapPath` из области элементов в конструктор.</span><span class="sxs-lookup"><span data-stu-id="f3b71-329">Start by opening the `Default.aspx` page and drag a `SiteMapPath` from the Toolbox onto the Designer.</span></span> <span data-ttu-id="f3b71-330">Элемент управления SiteMapPath находится в разделе навигации панели элементов.</span><span class="sxs-lookup"><span data-stu-id="f3b71-330">The SiteMapPath control is located in the Navigation section of the Toolbox.</span></span>

<span data-ttu-id="f3b71-331">[![добавить SiteMapPath в Default. aspx](building-a-custom-database-driven-site-map-provider-cs/_static/image19.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image18.gif)</span><span class="sxs-lookup"><span data-stu-id="f3b71-331">[![Add a SiteMapPath to Default.aspx](building-a-custom-database-driven-site-map-provider-cs/_static/image19.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image18.gif)</span></span>

<span data-ttu-id="f3b71-332">**Рис. 16**. Добавление элемента SiteMapPath в `Default.aspx` ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image20.gif))</span><span class="sxs-lookup"><span data-stu-id="f3b71-332">**Figure 16**: Add a SiteMapPath to `Default.aspx` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image20.gif))</span></span>

<span data-ttu-id="f3b71-333">Элемент управления SiteMapPath отображает навигатор, указывающий расположение текущей страницы в карте узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-333">The SiteMapPath control displays a breadcrumb, indicating the current page s location within the site map.</span></span> <span data-ttu-id="f3b71-334">Мы добавили SiteMapPath в верхнюю часть главной страницы в учебнике « *главные страницы» и «Навигация по сайту* ».</span><span class="sxs-lookup"><span data-stu-id="f3b71-334">We added a SiteMapPath to the top of the master page back in the *Master Pages and Site Navigation* tutorial.</span></span>

<span data-ttu-id="f3b71-335">Уделите несколько минут для просмотра этой страницы в браузере.</span><span class="sxs-lookup"><span data-stu-id="f3b71-335">Take a moment to view this page through a browser.</span></span> <span data-ttu-id="f3b71-336">Для SiteMapPath, добавленной на рис. 16, используется поставщик карт сайта по умолчанию, который извлекает данные из `Web.sitemap`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-336">The SiteMapPath added in Figure 16 uses the default site map provider, pulling its data from `Web.sitemap`.</span></span> <span data-ttu-id="f3b71-337">Таким образом, Навигатор показывает домашнюю &gt; настроить карту узла, как в верхнем правом углу.</span><span class="sxs-lookup"><span data-stu-id="f3b71-337">Therefore, the breadcrumb shows Home &gt; Customizing the Site Map, just like the breadcrumb in the upper-right corner.</span></span>

<span data-ttu-id="f3b71-338">[![навигатор использует поставщик карт сайта по умолчанию](building-a-custom-database-driven-site-map-provider-cs/_static/image22.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.gif)</span><span class="sxs-lookup"><span data-stu-id="f3b71-338">[![The Breadcrumb Uses the Default Site Map Provider](building-a-custom-database-driven-site-map-provider-cs/_static/image22.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.gif)</span></span>

<span data-ttu-id="f3b71-339">**Рис. 17**. Навигатор использует поставщик карт сайта по умолчанию ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image23.gif))</span><span class="sxs-lookup"><span data-stu-id="f3b71-339">**Figure 17**: The Breadcrumb Uses the Default Site Map Provider ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image23.gif))</span></span>

<span data-ttu-id="f3b71-340">Чтобы добавить SiteMapPath на рис. 16, используйте настраиваемый поставщик карт узла, созданный на шаге 6, присвойте [свойству`SiteMapProvider`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sitemappath.sitemapprovider.aspx) значение Northwind, имя, которое мы присвоили `NorthwindSiteMapProvider` в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-340">To have the SiteMapPath added in Figure 16 use the custom site map provider we created in Step 6, set its [`SiteMapProvider` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sitemappath.sitemapprovider.aspx) to Northwind, the name we assigned to the `NorthwindSiteMapProvider` in `Web.config`.</span></span> <span data-ttu-id="f3b71-341">К сожалению, конструктор по умолчанию использует поставщик карт сайта, но если вы посещаете страницу через браузер после изменения этого свойства, вы увидите, что навигатор теперь использует пользовательский поставщик карт узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-341">Unfortunately, the Designer continues to use the default site map provider, but if you visit the page through a browser after making this property change you'll see that the breadcrumb now uses the custom site map provider.</span></span>

<span data-ttu-id="f3b71-342">[![навигатор теперь использует пользовательский поставщик карт веб-узла Норсвиндситемаппровидер](building-a-custom-database-driven-site-map-provider-cs/_static/image25.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image24.gif)</span><span class="sxs-lookup"><span data-stu-id="f3b71-342">[![The Breadcrumb Now Uses the Custom Site Map Provider NorthwindSiteMapProvider](building-a-custom-database-driven-site-map-provider-cs/_static/image25.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image24.gif)</span></span>

<span data-ttu-id="f3b71-343">**Рис. 18**. Теперь навигатор использует пользовательский поставщик карт веб-узла `NorthwindSiteMapProvider` ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image26.gif))</span><span class="sxs-lookup"><span data-stu-id="f3b71-343">**Figure 18**: The Breadcrumb Now Uses the Custom Site Map Provider `NorthwindSiteMapProvider` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image26.gif))</span></span>

<span data-ttu-id="f3b71-344">Элемент управления SiteMapPath отображает более функциональный пользовательский интерфейс на страницах `ProductsByCategory.aspx` и `ProductDetails.aspx`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-344">The SiteMapPath control displays a more functional user interface in the `ProductsByCategory.aspx` and `ProductDetails.aspx` pages.</span></span> <span data-ttu-id="f3b71-345">Добавьте к этим страницам элемент SiteMapPath, установив для свойства `SiteMapProvider` в значение Northwind.</span><span class="sxs-lookup"><span data-stu-id="f3b71-345">Add a SiteMapPath to these pages, setting the `SiteMapProvider` property in both to Northwind.</span></span> <span data-ttu-id="f3b71-346">В `Default.aspx` щелкните ссылку Просмотреть продукты для напитков, а затем щелкните ссылку Просмотреть сведения для Чай Chai.</span><span class="sxs-lookup"><span data-stu-id="f3b71-346">From `Default.aspx` click on the View Products link for Beverages, and then on the View Details link for Chai Tea.</span></span> <span data-ttu-id="f3b71-347">Как показано на рис. 19, Навигатор включает в себя текущий раздел схемы узла (Чай Chai) и его предков: напитки и все категории.</span><span class="sxs-lookup"><span data-stu-id="f3b71-347">As Figure 19 shows, the breadcrumb includes the current site map section ( Chai Tea ) and its ancestors: Beverages and All Categories .</span></span>

<span data-ttu-id="f3b71-348">[![навигатор теперь использует пользовательский поставщик карт веб-узла Норсвиндситемаппровидер](building-a-custom-database-driven-site-map-provider-cs/_static/image27.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="f3b71-348">[![The Breadcrumb Now Uses the Custom Site Map Provider NorthwindSiteMapProvider](building-a-custom-database-driven-site-map-provider-cs/_static/image27.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.png)</span></span>

<span data-ttu-id="f3b71-349">**Рис. 19**. Теперь навигатор использует пользовательский поставщик карт веб-узла `NorthwindSiteMapProvider` ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image22.png))</span><span class="sxs-lookup"><span data-stu-id="f3b71-349">**Figure 19**: The Breadcrumb Now Uses the Custom Site Map Provider `NorthwindSiteMapProvider` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image22.png))</span></span>

<span data-ttu-id="f3b71-350">Другие элементы пользовательского интерфейса навигации можно использовать в дополнение к SiteMapPath, например к элементам управления Menu и TreeView.</span><span class="sxs-lookup"><span data-stu-id="f3b71-350">Other navigation user interface elements can be used in addition to the SiteMapPath, such as the Menu and TreeView controls.</span></span> <span data-ttu-id="f3b71-351">Страницы `Default.aspx`, `ProductsByCategory.aspx`и `ProductDetails.aspx` в загружаемом руководстве, например все элементы управления меню (см. рис. 20).</span><span class="sxs-lookup"><span data-stu-id="f3b71-351">The `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages in the download for this tutorial, for example, all include Menu controls (see Figure 20).</span></span> <span data-ttu-id="f3b71-352">Более подробные сведения о элементах управления навигацией и системе карт узла в ASP.NET 2,0 см. в разделе [изучение функций навигации по сайту ASP.NET 2,0 s](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx) и раздела [Использование элементов управления навигацией по веб-сайту](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/navigation/sitenavcontrols.aspx) в [ASP.NET 2,0](https://quickstarts.asp.net/QuickStartv20/aspnet/) .</span><span class="sxs-lookup"><span data-stu-id="f3b71-352">See [Examining ASP.NET 2.0 s Site Navigation Features](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx) and the [Using Site Navigation Controls](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/navigation/sitenavcontrols.aspx) section of the [ASP.NET 2.0 QuickStarts](https://quickstarts.asp.net/QuickStartv20/aspnet/) for a more in-depth look at the navigation controls and site map system in ASP.NET 2.0.</span></span>

<span data-ttu-id="f3b71-353">[![элемент управления Menu содержит список категорий и продуктов](building-a-custom-database-driven-site-map-provider-cs/_static/image29.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image28.gif)</span><span class="sxs-lookup"><span data-stu-id="f3b71-353">[![The Menu Control Lists Each of the Categories and Products](building-a-custom-database-driven-site-map-provider-cs/_static/image29.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image28.gif)</span></span>

<span data-ttu-id="f3b71-354">**Рис. 20**. в элементе управления Menu перечислены категории и продукты ([щелкните, чтобы просмотреть изображение с полным размером](building-a-custom-database-driven-site-map-provider-cs/_static/image30.gif)).</span><span class="sxs-lookup"><span data-stu-id="f3b71-354">**Figure 20**: The Menu Control Lists Each of the Categories and Products ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image30.gif))</span></span>

<span data-ttu-id="f3b71-355">Как упоминалось ранее в этом руководстве, структуру схемы узла можно получить программно с помощью класса `SiteMap`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-355">As mentioned earlier in this tutorial, the site map structure can be accessed programmatically through the `SiteMap` class.</span></span> <span data-ttu-id="f3b71-356">Следующий код возвращает корневой `SiteMapNode` поставщика по умолчанию:</span><span class="sxs-lookup"><span data-stu-id="f3b71-356">The following code returns the root `SiteMapNode` of the default provider:</span></span>

[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample8.cs)]

<span data-ttu-id="f3b71-357">Поскольку `AspNetXmlSiteMapProvider` является поставщиком по умолчанию для нашего приложения, приведенный выше код возвращает корневой узел, определенный в `Web.sitemap`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-357">Since the `AspNetXmlSiteMapProvider` is the default provider for our application, the above code would return the root node defined in `Web.sitemap`.</span></span> <span data-ttu-id="f3b71-358">Для ссылки на поставщика карт узла, отличного от значения по умолчанию, используйте [свойство](https://msdn.microsoft.com/library/system.web.sitemap.providers.aspx) `SiteMap` классов`Providers` следующим образом:</span><span class="sxs-lookup"><span data-stu-id="f3b71-358">To reference a site map provider other than the default, use the `SiteMap` class s [`Providers` property](https://msdn.microsoft.com/library/system.web.sitemap.providers.aspx) like so:</span></span>

[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample9.cs)]

<span data-ttu-id="f3b71-359">Где *Name* — имя пользовательского поставщика карт узла (Northwind для нашего веб-приложения).</span><span class="sxs-lookup"><span data-stu-id="f3b71-359">Where *name* is the name of the custom site map provider ( Northwind, for our web application).</span></span>

<span data-ttu-id="f3b71-360">Чтобы получить доступ к элементу, характерному для поставщика карт узла, используйте `SiteMap.Providers["name"]`, чтобы получить экземпляр поставщика, а затем приведите его к соответствующему типу.</span><span class="sxs-lookup"><span data-stu-id="f3b71-360">To access a member specific to a site map provider, use `SiteMap.Providers["name"]` to retrieve the provider instance and then cast it to the appropriate type.</span></span> <span data-ttu-id="f3b71-361">Например, чтобы отобразить свойство `NorthwindSiteMapProvider` s `CachedDate` на странице ASP.NET, используйте следующий код:</span><span class="sxs-lookup"><span data-stu-id="f3b71-361">For example, to display the `NorthwindSiteMapProvider` s `CachedDate` property in an ASP.NET page, use the following code:</span></span>

[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample10.cs)]

> [!NOTE]
> <span data-ttu-id="f3b71-362">Обязательно протестируйте функцию зависимости кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="f3b71-362">Be sure to test out the SQL cache dependency feature.</span></span> <span data-ttu-id="f3b71-363">После посещения страниц `Default.aspx`, `ProductsByCategory.aspx`и `ProductDetails.aspx` перейдите к одному из руководств в разделе Редактирование, вставка и удаление и измените имя категории или продукта.</span><span class="sxs-lookup"><span data-stu-id="f3b71-363">After visiting the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages, go to one of the tutorials in the Editing, Inserting, and Deleting section and edit the name of a category or product.</span></span> <span data-ttu-id="f3b71-364">Затем вернитесь на одну из страниц в папке `SiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-364">Then return to one of the pages in the `SiteMapProvider` folder.</span></span> <span data-ttu-id="f3b71-365">Предполагая, что для механизма опроса было достаточно времени, чтобы отметить изменение базовой базы данных, необходимо обновить карту узла, чтобы отобразить имя нового продукта или категории.</span><span class="sxs-lookup"><span data-stu-id="f3b71-365">Assuming enough time has passed for the polling mechanism to note the change to the underlying database, the site map should be updated to show the new product or category name.</span></span>

## <a name="summary"></a><span data-ttu-id="f3b71-366">Сводка</span><span class="sxs-lookup"><span data-stu-id="f3b71-366">Summary</span></span>

<span data-ttu-id="f3b71-367">ASP.NET 2,0 s Map Features включает класс `SiteMap`, ряд встроенных веб-элементов управления навигацией и поставщик карт узла по умолчанию, который предполагает сохранение сведений о карте узла в XML-файле.</span><span class="sxs-lookup"><span data-stu-id="f3b71-367">ASP.NET 2.0 s site map features includes a `SiteMap` class, a number of built-in navigation Web controls, and a default site map provider that expects the site map information persisted to an XML file.</span></span> <span data-ttu-id="f3b71-368">Чтобы использовать сведения о карте узла из другого источника, например из базы данных, архитектуры приложения или удаленной веб-службы, необходимо создать пользовательский поставщик карт узла.</span><span class="sxs-lookup"><span data-stu-id="f3b71-368">In order to use site map information from some other source such as from a database, the application s architecture, or a remote Web service we need to create a custom site map provider.</span></span> <span data-ttu-id="f3b71-369">Это подразумевает создание класса, прямо или косвенно производного от класса `SiteMapProvider`.</span><span class="sxs-lookup"><span data-stu-id="f3b71-369">This involves creating a class that derives, directly or indirectly, from the `SiteMapProvider` class.</span></span>

<span data-ttu-id="f3b71-370">В этом учебнике мы рассмотрели создание пользовательского поставщика карт узла, который основывается на карте узла на продуктах и категориях, исключающих из архитектуры приложения.</span><span class="sxs-lookup"><span data-stu-id="f3b71-370">In this tutorial we saw how to create a custom site map provider that based the site map on the product and category information culled from the application architecture.</span></span> <span data-ttu-id="f3b71-371">Наш поставщик расширил класс `StaticSiteMapProvider` и, в своюмся, создает метод `BuildSiteMap`, который извлекает данные, разстроил иерархию карт узла и кэширует полученную структуру в переменной уровня класса.</span><span class="sxs-lookup"><span data-stu-id="f3b71-371">Our provider extended the `StaticSiteMapProvider` class and entailed creating a `BuildSiteMap` method that retrieved the data, constructed the site map hierarchy, and cached the resulting structure in a class-level variable.</span></span> <span data-ttu-id="f3b71-372">Мы использовали зависимость кэша SQL с функцией обратного вызова, чтобы сделать кэшированную структуру недействительной при изменении базовых `Categories` или `Products` данных.</span><span class="sxs-lookup"><span data-stu-id="f3b71-372">We used a SQL cache dependency with a callback function to invalidate the cached structure when the underlying `Categories` or `Products` data is modified.</span></span>

<span data-ttu-id="f3b71-373">Поздравляем с программированием!</span><span class="sxs-lookup"><span data-stu-id="f3b71-373">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="f3b71-374">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="f3b71-374">Further Reading</span></span>

<span data-ttu-id="f3b71-375">Дополнительные сведения о разделах, обсуждаемых в этом руководстве, см. в следующих ресурсах:</span><span class="sxs-lookup"><span data-stu-id="f3b71-375">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- <span data-ttu-id="f3b71-376">[Хранение карт сайтов в SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) и [поставщику карты узла SQL, который вы ожидаете](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx)</span><span class="sxs-lookup"><span data-stu-id="f3b71-376">[Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) and [The SQL Site Map Provider You ve Been Waiting For](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx)</span></span>
- [<span data-ttu-id="f3b71-377">Взгляд на модель поставщика ASP.NET 2,0 s</span><span class="sxs-lookup"><span data-stu-id="f3b71-377">A Look at ASP.NET 2.0 s Provider Model</span></span>](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx)
- [<span data-ttu-id="f3b71-378">Набор средств поставщика</span><span class="sxs-lookup"><span data-stu-id="f3b71-378">The Provider Toolkit</span></span>](https://msdn.microsoft.com/asp.net/aa336558.aspx)
- [<span data-ttu-id="f3b71-379">Изучение функций навигации по сайту ASP.NET 2,0 s</span><span class="sxs-lookup"><span data-stu-id="f3b71-379">Examining ASP.NET 2.0 s Site Navigation Features</span></span>](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx)

## <a name="about-the-author"></a><span data-ttu-id="f3b71-380">Об авторе</span><span class="sxs-lookup"><span data-stu-id="f3b71-380">About the Author</span></span>

<span data-ttu-id="f3b71-381">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи книг по ASP/ASP. NET и основатель [4GuysFromRolla.com](http://www.4guysfromrolla.com), работал с веб-технологиями Майкрософт с 1998.</span><span class="sxs-lookup"><span data-stu-id="f3b71-381">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="f3b71-382">Скотт работает как независимый консультант, преподаватель и модуль записи.</span><span class="sxs-lookup"><span data-stu-id="f3b71-382">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="f3b71-383">Его последняя книга — [*Sams обучать себя ASP.NET 2,0 за 24 часа*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="f3b71-383">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="f3b71-384">Он доступен по адресу [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f3b71-384">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="f3b71-385">или через его блог, который можно найти по адресу [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="f3b71-385">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="f3b71-386">Специальная благодарность</span><span class="sxs-lookup"><span data-stu-id="f3b71-386">Special Thanks To</span></span>

<span data-ttu-id="f3b71-387">Эта серия руководств была рассмотрена многими полезными рецензентами.</span><span class="sxs-lookup"><span data-stu-id="f3b71-387">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="f3b71-388">Потенциальные рецензенты для этого руководства: Дейв Гарднер, Зак Jones, Терезой Мерфи и Бернадетте Леигх.</span><span class="sxs-lookup"><span data-stu-id="f3b71-388">Lead reviewers for this tutorial were Dave Gardner, Zack Jones, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="f3b71-389">Хотите ознакомиться с моими будущими статьями MSDN?</span><span class="sxs-lookup"><span data-stu-id="f3b71-389">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="f3b71-390">Если это так, расположите строку в [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="f3b71-390">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="f3b71-391">Вперед</span><span class="sxs-lookup"><span data-stu-id="f3b71-391">Next</span></span>](building-a-custom-database-driven-site-map-provider-vb.md)
