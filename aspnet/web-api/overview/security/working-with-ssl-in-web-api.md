---
uid: web-api/overview/security/working-with-ssl-in-web-api
title: Работа с SSL в веб-API | Документация Майкрософт
author: MikeWasson
description: Показано, как использовать протокол SSL с веб-API ASP.NET, в том числе с использованием SSL-сертификатов клиента.
ms.author: riande
ms.date: 02/22/2019
ms.assetid: 97f6164f-59cf-45c0-b820-e4aa29b45396
msc.legacyurl: /web-api/overview/security/working-with-ssl-in-web-api
msc.type: authoredcontent
ms.openlocfilehash: 31589b3713b1f1a9b98d12906bfef81f8bf5e3f9
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59386161"
---
# <a name="working-with-ssl-in-web-api"></a>Работа с SSL в веб-API

по [Майк Уоссон](https://github.com/MikeWasson)

Несколько общих схем проверки подлинности не являются безопасными через простой HTTP. В частности Обычная проверка подлинности и проверки подлинности форм отправляют незашифрованные учетные данные. Для обеспечения безопасности, эти схемы проверки подлинности *необходимо* использование протокола SSL. Кроме того можно использовать SSL-сертификатов клиента для проверки подлинности клиентов.

## <a name="enabling-ssl-on-the-server"></a>Включение SSL на сервере

Настройка SSL в IIS 7 или более поздней версии:

- Создать или получить сертификат. Для тестирования, можно создать самозаверяющий сертификат.
- Добавьте привязку HTTPS.

Дополнительные сведения см. в разделе [как выполнить настройку SSL в службах IIS 7](https://www.iis.net/learn/manage/configuring-security/how-to-set-up-ssl-on-iis).

Для локального тестирования, вы можете включить SSL в IIS Express из Visual Studio. В окне «Свойства» задайте **протокол SSL включен** для **True**. Обратите внимание на значение **URL-адрес SSL**; используйте этот URL-адрес для тестирования подключения по протоколу HTTPS.

![](working-with-ssl-in-web-api/_static/image1.png)

### <a name="enforcing-ssl-in-a-web-api-controller"></a>Принудительное применение протокола SSL в контроллер веб-API

Если у вас есть привязку HTTP и HTTPS, клиенты могут использовать HTTP для доступа к сайту. Можно предоставить некоторые ресурсы, которые доступны через HTTP, а для других ресурсов требуется SSL. В этом случае используйте фильтр действий для требования SSL для защищенных ресурсов. В следующем коде показано фильтр проверки подлинности веб-API, которое проверяет наличие SSL:

[!code-csharp[Main](working-with-ssl-in-web-api/samples/sample1.cs)]

Добавьте этот фильтр ко всем действиям веб-API, для которых требуется SSL:

[!code-csharp[Main](working-with-ssl-in-web-api/samples/sample2.cs)]

## <a name="ssl-client-certificates"></a>SSL-сертификатов клиента

SSL обеспечивает проверку подлинности с помощью сертификатов инфраструктуры открытых ключей. Сервер должен предоставить сертификат, который проверяет подлинность сервера на клиент. Это менее типичный для клиента, чтобы предоставить сертификат на сервер, но это один из вариантов проверки подлинности клиентов. Чтобы использовать сертификаты клиента с помощью протокола SSL, необходимо способа распространения сертификаты для пользователей. Для многих типов приложений это не будет эффективное взаимодействие с пользователем, но в некоторых средах (например, enterprise) может быть нецелесообразно.

| Преимущества | Недостатки |
| --- | --- |
| — Учетные данные сертификат, надежнее, чем имя пользователя и пароль. -SSL предоставляет полный безопасный канал с проверкой подлинности, проверку целостности сообщений и шифрования сообщений. | -Необходимо получить и управление сертификатами PKI. -Клиентской платформы должен поддерживать SSL-сертификатов клиента. |

Чтобы настроить службы IIS, чтобы принимать сертификаты клиентов, откройте диспетчер IIS и выполните следующие действия:

1. Щелкните узел в представлении в виде дерева.
2. Дважды щелкните **параметры SSL** функцию в средней области.
3. В разделе **сертификаты клиента**, выберите один из следующих вариантов: 

    - **Принять**: IIS будет принимать сертификат клиента, но не требуются.
    - **Требовать**: Требуется сертификат клиента. (Чтобы включить этот параметр, необходимо также выбрать «Требовать SSL»)

Можно также задать эти параметры в файле ApplicationHost.config:

[!code-xml[Main](working-with-ssl-in-web-api/samples/sample3.xml)]

**SslNegotiateCert** флаг означает, что IIS будет принимать сертификат клиента, но не требуются (эквивалентно значению параметра «Принять» в диспетчере служб IIS). Чтобы требуется сертификат, установите **SslRequireCert** флаг. Для тестирования, можно также задать эти параметры в IIS Express, в локальный узел applicationhost. Файл конфигурации, расположенный в «Documents\IISExpress\config».

### <a name="creating-a-client-certificate-for-testing"></a>Создание сертификата клиента для тестирования

В целях тестирования можно использовать [MakeCert.exe](/windows/desktop/SecCrypto/makecert) для создания сертификата клиента. Во-первых создайте корневого центра тестирования:

[!code-console[Main](working-with-ssl-in-web-api/samples/sample4.cmd)]

Makecert предложит ввести пароль для закрытого ключа.

Добавьте сертификат в тест хранилища сервера «доверенные корневые центры сертификации», следующим образом:

1. Откройте консоль MMC.
2. В разделе **файл**выберите **Add/Remove Snap-In**.
3. Выберите **учетная запись компьютера**.
4. Выберите **локального компьютера** и завершите работу мастера.
5. В области навигации разверните узел «Доверенные корневые центры сертификации».
6. На **действие** последовательно выберите пункты **все задачи**, а затем нажмите кнопку **импорта** для запуска мастера импорта сертификатов.
7. Перейдите к файлу сертификата, TempCA.cer.
8. Нажмите кнопку **откройте**, затем нажмите кнопку **Далее** и завершите работу мастера. (Вам будет предложено повторно ввести пароль.)

Теперь создайте сертификат клиента, который подписывается первый сертификат:

[!code-console[Main](working-with-ssl-in-web-api/samples/sample5.cmd)]

### <a name="using-client-certificates-in-web-api"></a>С помощью сертификатов клиента в веб-API

На стороне сервера, можно получить сертификат клиента, вызвав [GetClientCertificate](https://msdn.microsoft.com/library/system.net.http.httprequestmessageextensions.getclientcertificate.aspx) в сообщении запроса. Метод возвращает значение null, если отсутствует сертификат клиента. В противном случае возвращается **X509Certificate2** экземпляра. Этот объект можно используйте для получения сведений из сертификата, например издателя и субъекта. Затем эти сведения можно использовать для проверки подлинности и/или авторизации.

[!code-csharp[Main](working-with-ssl-in-web-api/samples/sample6.cs)]
