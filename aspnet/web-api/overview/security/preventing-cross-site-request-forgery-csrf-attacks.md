---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Предотвращение атак с подделки запросов между сайтами (CSRF) в ASP.NET MVC
author: MikeWasson
description: В этой статье описывается атака с подделкой межсайтовых запросов (CSRF) и способы реализации мер защиты CSRF в ASP.NET Web MVC.
ms.author: riande
ms.date: 12/12/2012
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5fb0f8bcc9e587ba4fbbf2b857d3bf7adcaafb94
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78447114"
---
# <a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-mvc-application"></a>Предотвращение атак подделки межсайтовых запросов (CSRF) в приложении ASP.NET MVC

по [Майк Уоссон](https://github.com/MikeWasson)

Подделка межсайтовых запросов (CSRF) — это атака, при которой вредоносный сайт отправляет запрос на уязвимый сайт, на котором пользователь в данный момент вошел в систему.

Ниже приведен пример атаки CSRF.

1. Пользователь входит в `www.example.com` с использованием проверки подлинности с помощью форм.
2. Сервер проверяет подлинность пользователя. Ответ сервера включает файл cookie проверки подлинности.
3. Не выполняя выход, пользователь посещает вредоносный веб-узел. Этот вредоносный сайт содержит следующую HTML-форму: 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    Обратите внимание, что действие формы публикует сообщение на уязвимом сайте, а не на вредоносном сайте. Это часть CSRF, связанная с "межсайт".
4. Пользователь нажимает кнопку Submit (отправить). Браузер включает файл cookie проверки подлинности с запросом.
5. Запрос выполняется на сервере с контекстом проверки подлинности пользователя и может выполнять любые действия, разрешенные пользователям, прошедшим проверку подлинности.

Хотя в этом примере пользователь должен нажать кнопку формы, вредоносная страница может просто запустить сценарий, который автоматически отправляет форму. Более того, использование протокола SSL не мешает CSRF атаке, так как вредоносный сайт может отправить запрос "https://".

Как правило, атаки CSRF возможны для веб-сайтов, использующих файлы cookie для проверки подлинности, так как браузеры отправляют все соответствующие файлы cookie на целевой веб-сайт. Однако атаки CSRF не ограничиваются использованием файлов cookie. Например, также уязвимы обычная и краткая проверка подлинности. После входа пользователя в систему с базовой или дайджест-проверкой подлинности. браузер автоматически отправляет учетные данные, пока сеанс не завершится.

## <a name="anti-forgery-tokens"></a>Маркеры защиты от подделки

Чтобы помочь предотвратить атаки CSRF, ASP.NET MVC использует маркеры защиты от подделки, также называемые *маркерами проверки запросов*.

1. Клиент запрашивает HTML-страницу, содержащую форму.
2. Сервер содержит два токена в ответе. Один токен отправляется как файл cookie. Другой объект помещается в скрытое поле формы. Маркеры создаются случайным образом, чтобы злоумышленник не смог угадать значения.
3. Когда клиент отправляет форму, он должен отправить оба токена обратно на сервер. Клиент отправляет токен cookie как файл cookie и отправляет маркер формы внутри данных формы. (Клиент браузера автоматически делает это, когда пользователь отправляет форму.)
4. Если запрос не включает оба токена, сервер не разрешает запрос.

Ниже приведен пример HTML-формы с маркером скрытой формы.

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

Маркеры защиты от подделки работают, так как вредоносная страница не может читать маркеры пользователя из-за политик того же происхождения. ([Политики с одинаковыми источниками](http://www.w3.org/Security/wiki/Same_Origin_Policy) не позволяют документам, размещенным на двух разных сайтах, получать доступ к содержимому друг друга. Так что в предыдущем примере вредоносная страница может отправить запросы в example.com, но не может прочитать ответ.)

Чтобы предотвратить атаки CSRF, используйте маркеры защиты от подделки с любым протоколом проверки подлинности, когда браузер автоматически отправляет учетные данные после входа пользователя в систему. К ним относятся протоколы проверки подлинности на основе файлов cookie, такие как проверка подлинности с помощью форм, а также такие протоколы, как обычная и дайджест-проверка

Для ненадежных методов необходимо использовать маркеры защиты от подделки (POST, размещение, удаление). Кроме того, убедитесь, что надежные методы (GET, HEAD) не имеют никаких побочных эффектов. Более того, если включить междоменную поддержку, например CORS или JSONP, то даже защищенные методы, такие как GET, потенциально уязвимы для атак CSRF, что позволяет злоумышленнику читать потенциально конфиденциальные данные.

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a>Маркеры защиты от подделки в ASP.NET MVC

Чтобы добавить маркеры защиты от подделки на страницу Razor, используйте вспомогательный метод **HtmlHelper. AntiForgeryToken** :

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

Этот метод добавляет скрытое поле формы, а также задает токен файла cookie.

## <a name="anti-csrf-and-ajax"></a>Защита от CSRF и AJAX

Маркер формы может быть проблемой для запросов AJAX, так как запрос AJAX может отсылать данные JSON, а не данные HTML-форм. В этом случае можно отправлять токены в настраиваемый заголовок HTTP. Следующий код создает токены с использованием синтаксиса Razor, а затем добавляет их в запрос AJAX. Токены создаются на сервере путем вызова **подделки. токены**.

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

При обработке запроса извлеките токены из его заголовка. Затем вызовите метод защиты от **подделки. Validate** , чтобы проверить токены. Метод **Validate** создает исключение, если маркеры недопустимы.

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
