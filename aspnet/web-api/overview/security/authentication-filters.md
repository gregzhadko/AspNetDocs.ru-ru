---
uid: web-api/overview/security/authentication-filters
title: Фильтры проверки подлинности в веб-API ASP.NET 2 | Документация Майкрософт
author: MikeWasson
description: Фильтр проверки подлинности — это компонент, который проверяет подлинность HTTP-запроса. Веб-API 2 и MVC 5 поддерживают фильтры проверки подлинности, но они немного отличаются...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 2ef9e62a6c634237e920b6d7aba2127b835f959d
ms.sourcegitcommit: e365196c75ce93cd8967412b1cfdc27121816110
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2020
ms.locfileid: "77075077"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="b0c10-104">Фильтры проверки подлинности в веб-API ASP.NET 2</span><span class="sxs-lookup"><span data-stu-id="b0c10-104">Authentication Filters in ASP.NET Web API 2</span></span>

<span data-ttu-id="b0c10-105">по [Майк Уоссон](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="b0c10-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="b0c10-106">Фильтр проверки подлинности — это компонент, который проверяет подлинность HTTP-запроса.</span><span class="sxs-lookup"><span data-stu-id="b0c10-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="b0c10-107">Веб-API 2 и MVC 5 поддерживают фильтры проверки подлинности, но они немного отличаются, в основном в соглашениях об именовании для интерфейса фильтра.</span><span class="sxs-lookup"><span data-stu-id="b0c10-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="b0c10-108">В этом разделе описываются фильтры проверки подлинности веб-API.</span><span class="sxs-lookup"><span data-stu-id="b0c10-108">This topic describes Web API authentication filters.</span></span>

<span data-ttu-id="b0c10-109">Фильтры проверки подлинности позволяют задать схему проверки подлинности для отдельных контроллеров или действий.</span><span class="sxs-lookup"><span data-stu-id="b0c10-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="b0c10-110">Таким образом, приложение может поддерживать разные механизмы проверки подлинности для разных ресурсов HTTP.</span><span class="sxs-lookup"><span data-stu-id="b0c10-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="b0c10-111">В этой статье я покажу код из примера [обычной проверки подлинности](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) на [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span><span class="sxs-lookup"><span data-stu-id="b0c10-111">In this article, I'll show code from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample on [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span></span> <span data-ttu-id="b0c10-112">В примере показан фильтр проверки подлинности, реализующий схему проверки подлинности HTTP Basic Access (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="b0c10-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="b0c10-113">Фильтр реализуется в классе с именем `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="b0c10-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="b0c10-114">Я не буду показывать весь код из образца, а только части, иллюстрирующие написание фильтра проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="b0c10-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="b0c10-115">Настройка фильтра проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="b0c10-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="b0c10-116">Как и другие фильтры, фильтры проверки подлинности могут применяться для каждого контроллера, действия или глобально для всех контроллеров веб-API.</span><span class="sxs-lookup"><span data-stu-id="b0c10-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="b0c10-117">Чтобы применить фильтр проверки подлинности к контроллеру, добавьте класс контроллера с атрибутом Filter.</span><span class="sxs-lookup"><span data-stu-id="b0c10-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="b0c10-118">Следующий код задает фильтр `[IdentityBasicAuthentication]` для класса контроллера, который обеспечивает обычную проверку подлинности для всех действий контроллера.</span><span class="sxs-lookup"><span data-stu-id="b0c10-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="b0c10-119">Чтобы применить фильтр к одному действию, украшение действия с помощью фильтра.</span><span class="sxs-lookup"><span data-stu-id="b0c10-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="b0c10-120">Следующий код задает фильтр `[IdentityBasicAuthentication]` для метода `Post` контроллера.</span><span class="sxs-lookup"><span data-stu-id="b0c10-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="b0c10-121">Чтобы применить фильтр ко всем контроллерам веб-API, добавьте его в **глобалконфигуратион. Filters**.</span><span class="sxs-lookup"><span data-stu-id="b0c10-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="b0c10-122">Реализация фильтра проверки подлинности веб-API</span><span class="sxs-lookup"><span data-stu-id="b0c10-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="b0c10-123">В веб-API фильтры проверки подлинности реализуют интерфейс [System. Web. http. Filters. иаусентикатионфилтер](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) .</span><span class="sxs-lookup"><span data-stu-id="b0c10-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="b0c10-124">Они также должны наследовать от **System. Attribute**, чтобы применяться в качестве атрибутов.</span><span class="sxs-lookup"><span data-stu-id="b0c10-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="b0c10-125">Интерфейс **иаусентикатионфилтер** имеет два метода:</span><span class="sxs-lookup"><span data-stu-id="b0c10-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="b0c10-126">**AuthenticateAsync** проверяет подлинность запроса, проверяя учетные данные в запросе, если они есть.</span><span class="sxs-lookup"><span data-stu-id="b0c10-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="b0c10-127">При необходимости **чалленжеасинк** добавляет запрос проверки подлинности в ответ HTTP.</span><span class="sxs-lookup"><span data-stu-id="b0c10-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="b0c10-128">Эти методы соответствуют потоку проверки подлинности, определенному в [rfc 2612](http://tools.ietf.org/html/rfc2616) и [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="b0c10-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="b0c10-129">Клиент отправляет учетные данные в заголовке авторизации.</span><span class="sxs-lookup"><span data-stu-id="b0c10-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="b0c10-130">Обычно это происходит после того, как клиент получает от сервера ответ 401 (несанкционированный).</span><span class="sxs-lookup"><span data-stu-id="b0c10-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="b0c10-131">Однако клиент может отправить учетные данные с любым запросом, а не только после получения 401.</span><span class="sxs-lookup"><span data-stu-id="b0c10-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="b0c10-132">Если сервер не принимает учетные данные, он возвращает ответ 401 (несанкционированный).</span><span class="sxs-lookup"><span data-stu-id="b0c10-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="b0c10-133">Ответ включает заголовок WWW-Authenticate, который содержит одну или несколько проблем.</span><span class="sxs-lookup"><span data-stu-id="b0c10-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="b0c10-134">Каждый запрос указывает схему проверки подлинности, которую распознает сервер.</span><span class="sxs-lookup"><span data-stu-id="b0c10-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="b0c10-135">Сервер также может возвратить 401 из анонимного запроса.</span><span class="sxs-lookup"><span data-stu-id="b0c10-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="b0c10-136">Обычно процесс проверки подлинности инициируется следующим образом:</span><span class="sxs-lookup"><span data-stu-id="b0c10-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="b0c10-137">Клиент отправляет анонимный запрос.</span><span class="sxs-lookup"><span data-stu-id="b0c10-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="b0c10-138">Сервер возвращает 401.</span><span class="sxs-lookup"><span data-stu-id="b0c10-138">The server returns 401.</span></span>
3. <span data-ttu-id="b0c10-139">Клиенты повторно отправляют запрос с учетными данными.</span><span class="sxs-lookup"><span data-stu-id="b0c10-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="b0c10-140">Этот поток включает как *проверку подлинности* , так и действия по *авторизации* .</span><span class="sxs-lookup"><span data-stu-id="b0c10-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="b0c10-141">Проверка подлинности удостоверяет личность клиента.</span><span class="sxs-lookup"><span data-stu-id="b0c10-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="b0c10-142">Авторизация определяет, может ли клиент получить доступ к определенному ресурсу.</span><span class="sxs-lookup"><span data-stu-id="b0c10-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="b0c10-143">В веб-API фильтры аутентификации обрабатывали проверку подлинности, но не выполняют авторизацию.</span><span class="sxs-lookup"><span data-stu-id="b0c10-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="b0c10-144">Авторизация должна выполняться фильтром авторизации или внутри действия контроллера.</span><span class="sxs-lookup"><span data-stu-id="b0c10-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="b0c10-145">Ниже приведен поток в конвейере веб-API 2:</span><span class="sxs-lookup"><span data-stu-id="b0c10-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="b0c10-146">Перед вызовом действия веб-API создает список фильтров проверки подлинности для этого действия.</span><span class="sxs-lookup"><span data-stu-id="b0c10-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="b0c10-147">Сюда входят фильтры с областью действия, областью контроллера и глобальной областью.</span><span class="sxs-lookup"><span data-stu-id="b0c10-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="b0c10-148">Веб-API вызывает **AuthenticateAsync** для каждого фильтра в списке.</span><span class="sxs-lookup"><span data-stu-id="b0c10-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="b0c10-149">Каждый фильтр может проверять учетные данные в запросе.</span><span class="sxs-lookup"><span data-stu-id="b0c10-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="b0c10-150">Если любой фильтр успешно проверяет учетные данные, фильтр создает **IPrincipal** и прикрепляет его к запросу.</span><span class="sxs-lookup"><span data-stu-id="b0c10-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="b0c10-151">На этом этапе фильтр может также активировать ошибку.</span><span class="sxs-lookup"><span data-stu-id="b0c10-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="b0c10-152">Если да, остальная часть конвейера не выполняется.</span><span class="sxs-lookup"><span data-stu-id="b0c10-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="b0c10-153">Если нет ошибки, запрос проходит через остальную часть конвейера.</span><span class="sxs-lookup"><span data-stu-id="b0c10-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="b0c10-154">Наконец, веб-API вызывает метод **чалленжеасинк** каждого фильтра проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="b0c10-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="b0c10-155">Фильтры используют этот метод, чтобы при необходимости добавить запрос в ответ.</span><span class="sxs-lookup"><span data-stu-id="b0c10-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="b0c10-156">Обычно (но не всегда) это происходит в ответ на ошибку 401.</span><span class="sxs-lookup"><span data-stu-id="b0c10-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="b0c10-157">На следующих диаграммах показаны два возможных варианта.</span><span class="sxs-lookup"><span data-stu-id="b0c10-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="b0c10-158">В первом случае фильтр проверки подлинности успешно проверяет подлинность запроса, фильтр авторизации авторизует запрос, а действие контроллера возвращает значение 200 (ОК).</span><span class="sxs-lookup"><span data-stu-id="b0c10-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="b0c10-159">Во втором примере фильтр проверки подлинности проверяет подлинность запроса, но фильтр авторизации возвращает 401 (несанкционированный).</span><span class="sxs-lookup"><span data-stu-id="b0c10-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="b0c10-160">В этом случае действие контроллера не вызывается.</span><span class="sxs-lookup"><span data-stu-id="b0c10-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="b0c10-161">Фильтр проверки подлинности добавляет к ответу заголовок WWW-Authenticate.</span><span class="sxs-lookup"><span data-stu-id="b0c10-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="b0c10-162">Другие сочетания возможны&mdash;например, если действие контроллера допускает анонимные запросы, может существовать фильтр проверки подлинности, но не авторизация.</span><span class="sxs-lookup"><span data-stu-id="b0c10-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="b0c10-163">Реализация метода AuthenticateAsync</span><span class="sxs-lookup"><span data-stu-id="b0c10-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="b0c10-164">Метод **AuthenticateAsync** пытается проверить подлинность запроса.</span><span class="sxs-lookup"><span data-stu-id="b0c10-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="b0c10-165">Вот так выглядит подпись метода.</span><span class="sxs-lookup"><span data-stu-id="b0c10-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="b0c10-166">Метод **AuthenticateAsync** должен выполнять одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="b0c10-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="b0c10-167">Ничего (No-op).</span><span class="sxs-lookup"><span data-stu-id="b0c10-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="b0c10-168">Создайте **IPrincipal** и задайте его в запросе.</span><span class="sxs-lookup"><span data-stu-id="b0c10-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="b0c10-169">Задайте результат ошибки.</span><span class="sxs-lookup"><span data-stu-id="b0c10-169">Set an error result.</span></span>

<span data-ttu-id="b0c10-170">Параметр (1) означает, что запрос не имел учетных данных, распознаваемых фильтром.</span><span class="sxs-lookup"><span data-stu-id="b0c10-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="b0c10-171">Параметр (2) означает, что фильтр успешно прошел проверку подлинности запроса.</span><span class="sxs-lookup"><span data-stu-id="b0c10-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="b0c10-172">Параметр (3) означает, что запрос содержал недопустимые учетные данные (например, неправильный пароль), который запускает ответ об ошибке.</span><span class="sxs-lookup"><span data-stu-id="b0c10-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="b0c10-173">Ниже приведена общая структура реализации **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="b0c10-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="b0c10-174">Найдите в запросе учетные данные.</span><span class="sxs-lookup"><span data-stu-id="b0c10-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="b0c10-175">Если учетные данные отсутствуют, ничего не предпринимайте и не возвращайте (No-op).</span><span class="sxs-lookup"><span data-stu-id="b0c10-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="b0c10-176">Если имеются учетные данные, но фильтр не распознает схему проверки подлинности, ничего не предпринимайте и не возвращайте (No-op).</span><span class="sxs-lookup"><span data-stu-id="b0c10-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="b0c10-177">Другой фильтр в конвейере может понять схему.</span><span class="sxs-lookup"><span data-stu-id="b0c10-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="b0c10-178">Если имеются учетные данные, распознаваемые фильтром, попробуйте выполнить их проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="b0c10-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="b0c10-179">Если учетные данные неверны, возвращайте значение 401, установив `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="b0c10-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="b0c10-180">Если учетные данные действительны, создайте экземпляр **IPrincipal** и задайте `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="b0c10-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="b0c10-181">Следующий код демонстрирует метод **AuthenticateAsync** из примера [обычной проверки подлинности](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) .</span><span class="sxs-lookup"><span data-stu-id="b0c10-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample.</span></span> <span data-ttu-id="b0c10-182">Комментарии указывают на каждый шаг.</span><span class="sxs-lookup"><span data-stu-id="b0c10-182">The comments indicate each step.</span></span> <span data-ttu-id="b0c10-183">Код показывает несколько типов ошибок: заголовок Authorization без учетных данных, неправильно сформированные учетные данные и неверное имя пользователя и пароль.</span><span class="sxs-lookup"><span data-stu-id="b0c10-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="b0c10-184">Установка результата ошибки</span><span class="sxs-lookup"><span data-stu-id="b0c10-184">Setting an Error Result</span></span>

<span data-ttu-id="b0c10-185">Если учетные данные недопустимы, фильтр должен задать `context.ErrorResult` **ихттпактионресулт** , который создает ответ об ошибке.</span><span class="sxs-lookup"><span data-stu-id="b0c10-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="b0c10-186">Дополнительные сведения о **ихттпактионресулт**см. [в разделе результаты действия в веб-API 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="b0c10-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="b0c10-187">Пример обычной проверки подлинности включает класс `AuthenticationFailureResult`, который подходит для этой цели.</span><span class="sxs-lookup"><span data-stu-id="b0c10-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="b0c10-188">Реализация Чалленжеасинк</span><span class="sxs-lookup"><span data-stu-id="b0c10-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="b0c10-189">Назначение метода **чалленжеасинк** заключается в добавлении к ответу проблем проверки подлинности при необходимости.</span><span class="sxs-lookup"><span data-stu-id="b0c10-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="b0c10-190">Вот так выглядит подпись метода.</span><span class="sxs-lookup"><span data-stu-id="b0c10-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="b0c10-191">Метод вызывается для каждого фильтра проверки подлинности в конвейере запросов.</span><span class="sxs-lookup"><span data-stu-id="b0c10-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="b0c10-192">Важно понимать, что **чалленжеасинк** вызывается *до* создания HTTP-ответа и, возможно, даже перед запуском действия контроллера.</span><span class="sxs-lookup"><span data-stu-id="b0c10-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="b0c10-193">При вызове **чалленжеасинк** `context.Result` содержит **ихттпактионресулт**, который используется позже для создания HTTP-ответа.</span><span class="sxs-lookup"><span data-stu-id="b0c10-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="b0c10-194">Поэтому при вызове **чалленжеасинк** вы еще не знакомы с ответом HTTP.</span><span class="sxs-lookup"><span data-stu-id="b0c10-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="b0c10-195">Метод **чалленжеасинк** должен заменить исходное значение `context.Result` новым **ихттпактионресулт**.</span><span class="sxs-lookup"><span data-stu-id="b0c10-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="b0c10-196">Этот **ихттпактионресулт** должен переносить исходный `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="b0c10-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="b0c10-197">Я называю исходный **ихттпактионресулт** *внутренним результатом*, а новый **ихттпактионресулт** *внешний результат*.</span><span class="sxs-lookup"><span data-stu-id="b0c10-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="b0c10-198">Внешний результат должен выполнять следующие действия.</span><span class="sxs-lookup"><span data-stu-id="b0c10-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="b0c10-199">Вызов внутреннего результата для создания HTTP-ответа.</span><span class="sxs-lookup"><span data-stu-id="b0c10-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="b0c10-200">Проверьте ответ.</span><span class="sxs-lookup"><span data-stu-id="b0c10-200">Examine the response.</span></span>
3. <span data-ttu-id="b0c10-201">При необходимости добавьте запрос проверки подлинности в ответ.</span><span class="sxs-lookup"><span data-stu-id="b0c10-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="b0c10-202">Следующий пример взят из примера обычной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="b0c10-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="b0c10-203">Он определяет **ихттпактионресулт** для внешнего результата.</span><span class="sxs-lookup"><span data-stu-id="b0c10-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="b0c10-204">Свойство `InnerResult` содержит внутренний **ихттпактионресулт**.</span><span class="sxs-lookup"><span data-stu-id="b0c10-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="b0c10-205">Свойство `Challenge` представляет заголовок веб-аутентификации.</span><span class="sxs-lookup"><span data-stu-id="b0c10-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="b0c10-206">Обратите внимание, что **ExecuteAsync** first вызывает `InnerResult.ExecuteAsync` для создания HTTP-ответа, а затем при необходимости добавляет запрос.</span><span class="sxs-lookup"><span data-stu-id="b0c10-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="b0c10-207">Перед добавлением запроса проверьте код ответа.</span><span class="sxs-lookup"><span data-stu-id="b0c10-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="b0c10-208">Большинство схем проверки подлинности добавляют только запрос, если ответ равен 401, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="b0c10-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="b0c10-209">Однако некоторые схемы проверки подлинности добавляют запрос в ответ об успешном выполнении.</span><span class="sxs-lookup"><span data-stu-id="b0c10-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="b0c10-210">Например, см. раздел [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="b0c10-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="b0c10-211">При наличии класса `AddChallengeOnUnauthorizedResult` фактический код в **чалленжеасинк** является простым.</span><span class="sxs-lookup"><span data-stu-id="b0c10-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="b0c10-212">Вы просто создаете результат и подключаете его к `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="b0c10-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="b0c10-213">Примечание. пример обычной проверки подлинности абстрагирует эту логику, поместив ее в метод расширения.</span><span class="sxs-lookup"><span data-stu-id="b0c10-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="b0c10-214">Комбинирование фильтров проверки подлинности с проверкой подлинности на уровне узла</span><span class="sxs-lookup"><span data-stu-id="b0c10-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="b0c10-215">"Проверка подлинности на уровне узла" — это проверка подлинности, выполняемая узлом (например, IIS), прежде чем запрос достигнет платформы веб-API.</span><span class="sxs-lookup"><span data-stu-id="b0c10-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="b0c10-216">Часто может потребоваться включить проверку подлинности на уровне узла для остальной части приложения, но отключить его для контроллеров веб-API.</span><span class="sxs-lookup"><span data-stu-id="b0c10-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="b0c10-217">Например, типичный сценарий заключается в том, чтобы включить проверку подлинности на основе форм на уровне узла, но использовать проверку подлинности с помощью токенов для веб-API.</span><span class="sxs-lookup"><span data-stu-id="b0c10-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="b0c10-218">Чтобы отключить проверку подлинности на уровне узла в конвейере веб-API, вызовите `config.SuppressHostPrincipal()` в конфигурации.</span><span class="sxs-lookup"><span data-stu-id="b0c10-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="b0c10-219">Это приводит к тому, что веб-API удаляет интерфейс **IPrincipal** из любого запроса, который входит в конвейер веб-API.</span><span class="sxs-lookup"><span data-stu-id="b0c10-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="b0c10-220">Фактически, он &quot;отмену проверки подлинности&quot; запроса.</span><span class="sxs-lookup"><span data-stu-id="b0c10-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="b0c10-221">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="b0c10-221">Additional Resources</span></span>

<span data-ttu-id="b0c10-222">[Фильтры безопасности веб-API ASP.NET](https://msdn.microsoft.com/magazine/dn781361.aspx) (журнал MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="b0c10-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
