---
uid: web-api/overview/security/authentication-filters
title: Фильтры проверки подлинности в ASP.NET Web API 2 | Документация Майкрософт
author: MikeWasson
description: Фильтр проверки подлинности — это компонент, который выполняет проверку подлинности HTTP-запроса. Веб-API 2 и MVC 5 поддерживают фильтры проверки подлинности, но они несколько отличаются...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 15a343a061c61313141dcb69bd329e08aa902d98
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65126011"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a>Фильтры проверки подлинности в ASP.NET Web API 2

по [Майк Уоссон](https://github.com/MikeWasson)

> Фильтр проверки подлинности — это компонент, который выполняет проверку подлинности HTTP-запроса. Веб-API 2 и MVC 5 поддерживают фильтры проверки подлинности, но они немного отличаться, главным образом в соглашения об именовании для интерфейса фильтра. В этом разделе описаны фильтры проверки подлинности веб-API.

Фильтры проверки подлинности позволяют задать схему проверки подлинности для отдельных контроллеров или действий. Таким образом, ваше приложение может поддерживать различных механизмов проверки подлинности для разных ресурсов HTTP.

В этой статье я покажу код из [обычной проверки подлинности](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) пример [ http://aspnet.codeplex.com ](http://aspnet.codeplex.com). В примере показан фильтр проверки подлинности, где реализована схема обычной проверки подлинности доступа к HTTP (RFC 2617). Фильтр реализован в классе с именем `IdentityBasicAuthenticationAttribute`. Я не буду приводить весь код из примера, лишь те компоненты, которые показывают, как написать фильтр проверки подлинности.

## <a name="setting-an-authentication-filter"></a>Параметр фильтр проверки подлинности

Как и другие фильтры фильтры проверки подлинности может быть применен контроллера, за действие или глобально ко всем контроллерам веб-API.

Чтобы применить фильтр проверки подлинности к контроллеру, установите для класса контроллера атрибут фильтра. В следующем коде наборы `[IdentityBasicAuthentication]` фильтра на класс контроллера, который включает обычную проверку подлинности для каждого действия контроллера.

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

Чтобы применить фильтр к одно действие, Снабдите действие с фильтром. В следующем коде наборы `[IdentityBasicAuthentication]` фильтра на контроллере `Post` метод.

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

Чтобы применить фильтр ко всем контроллерам веб-API, добавьте его **GlobalConfiguration.Filters**.

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a>Реализация API проверки подлинности веб-фильтра

В веб-API проверки подлинности фильтры реализуют [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) интерфейс. Они также должны наследоваться от **System.Attribute**, чтобы применить в качестве атрибутов.

**IAuthenticationFilter** интерфейс содержит два метода:

- **AuthenticateAsync** проверяет подлинность запроса, проверяя учетные данные в запросе, если он имеется.
- **ChallengeAsync** добавляет запрос проверки подлинности для HTTP-ответа, при необходимости.

Эти методы соответствуют поток проверки подлинности, определенные в [RFC 2612](http://tools.ietf.org/html/rfc2616) и [RFC 2617](http://tools.ietf.org/html/rfc2617):

1. Клиент отправляет учетные данные в заголовке авторизации. Обычно это происходит после того как клиент получает ответ 401 (неавторизованный) с сервера. Тем не менее клиент может отправлять учетные данные с любым запросом, не только после получения 401.
2. Если сервер не принимает учетные данные, возвращается ответ 401 (неавторизованный). Ответ включает заголовок Www-Authenticate, который содержит один или несколько проблем. Каждый запрос указывает схему проверки подлинности, распознаваемой сервером.

Сервер также может возвратить 401 от анонимного запроса. На самом деле это обычно как инициируется процесс проверки подлинности:

1. Клиент отправляет анонимный запрос.
2. Сервер возвращает 401.
3. Клиенты послал серверу ответ с учетными данными.

Этот поток включает в себя *проверки подлинности* и *авторизации* действия.

- Проверка подлинности удостоверяет подлинность клиента.
- Авторизация определяет ли клиент обращаться к конкретному ресурсу.

В веб-API фильтры проверки подлинности обработки проверки подлинности, но не авторизации. Авторизации должно выполняться с фильтра авторизации или внутри действия контроллера.

Ниже приведена последовательность действий в конвейере веб-API 2:

1. Перед вызовом действия, веб-API создает список фильтров проверки подлинности для этого действия. Это включает в себя фильтры область действия, контроллера, область и глобальной области.
2. Веб-вызовы API **AuthenticateAsync** на каждый фильтр в списке. Каждый фильтр может проверить учетные данные, в запросе. Если любой фильтр успешно проверяет учетные данные, создает фильтр **IPrincipal** и присоединяет его к запросу. Фильтр также можно вызывать ошибку на этом этапе. Если Да, остальной части конвейера не выполняется.
3. Предположим, что ошибки отсутствуют, запрос проходит через оставшуюся часть конвейера.
4. Наконец, веб-API вызывает каждый фильтр проверки подлинности **ChallengeAsync** метод. Фильтры используют этот метод для добавления сложной задачей в ответ, при необходимости. Обычно (но не всегда), может произойти в ответ на сообщение об ошибке 401.

Ниже приведены два возможных варианта. В первом фильтр проверки подлинности успешно проверяет подлинность запроса, фильтра авторизации авторизует запрос, и действие контроллера возвращает код 200 (ОК).

![](authentication-filters/_static/image1.png)

Во втором примере фильтр проверки подлинности проверяет подлинность запроса, но фильтр авторизации возвращает 401 (не санкционировано). В этом случае действие контроллера не вызывается. Фильтр проверки подлинности добавляет в ответ заголовок Www-Authenticate.

![](authentication-filters/_static/image2.png)

Возможны и другие сочетания&mdash;к примеру, если действие контроллера поддерживает анонимные запросы, возможно, фильтр проверки подлинности, но без авторизации.

## <a name="implementing-the-authenticateasync-method"></a>Реализация метода AuthenticateAsync

**AuthenticateAsync** метод пытается выполнить проверку подлинности запроса. Ниже представлена подпись метода:

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

**AuthenticateAsync** метода необходимо выполнить одно из следующих:

1. Нет (no-op).
2. Создание **IPrincipal** и задайте его в запросе.
3. Задайте результат ошибки.

(1) означает, что запрос не содержал никаких учетных данных, которые понимает фильтр. (2) означает, что фильтр успешно прошел проверку подлинности запроса. (3) означает, что запрос было недопустимые учетные данные (например, неправильный пароль), которое инициирует сообщение об ошибке.

Вот общую структуру для реализации **AuthenticateAsync**.

1. Найдите учетные данные в запросе.
2. Если нет учетных данных, ничего не делать и возвращают (нет-op).
3. Если учетные данные, но фильтр не поддерживает схему проверки подлинности, ничего не делать и возвращают (нет-op). Еще один фильтр в конвейере может понять схему.
4. Если учетные данные, которые понимает фильтр, попробуйте проверку их подлинности.
5. Если указаны неверные учетные данные, возврата 401, задав `context.ErrorResult`.
6. Если учетные данные допустимы, создайте **IPrincipal** и задайте `context.Principal`.

В коде показано выполните **AuthenticateAsync** метода из [обычной проверки подлинности](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) образца. Комментарии указывают на каждом шаге. В коде показано несколько типов ошибок: Заголовок авторизации не учетные данные, имеет неправильный формат учетных данных и ввода неправильного имени пользователя и пароля.

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a>Параметр ошибки

Если учетные данные недействительны, необходимо задать фильтр `context.ErrorResult` для **IHttpActionResult** , создает сообщение об ошибке. Дополнительные сведения о **IHttpActionResult**, см. в разделе [результатов действий в веб-API 2](../getting-started-with-aspnet-web-api/action-results.md).

Пример обычной проверки подлинности включает в себя `AuthenticationFailureResult` класс, который подходит для этой цели.

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a>Реализация ChallengeAsync

Цель **ChallengeAsync** методом является добавления проблемы проверки подлинности в ответ, при необходимости. Ниже представлена подпись метода:

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

Метод вызывается на каждый фильтр проверки подлинности в конвейере запросов.

Важно понимать, что **ChallengeAsync** называется *перед* HTTP-ответе будет создана и возможно, даже до выполнения действия контроллера. При **ChallengeAsync** вызове `context.Result` содержит **IHttpActionResult**, который будет использоваться позднее для создания HTTP-ответа. Поэтому если **ChallengeAsync** является именем, ничего не известно об ответе HTTP еще. **ChallengeAsync** метод заменяют исходное значение `context.Result` с новым **IHttpActionResult**. Это **IHttpActionResult** нужно упаковать исходного `context.Result`.

![](authentication-filters/_static/image3.png)

Я назову исходного **IHttpActionResult** *внутренний результирующий*и новый **IHttpActionResult** *внешнего результата*. Внешнее результат, сделайте следующее:

1. Вызовите внутренний результирующий для создания HTTP-ответа.
2. Изучите ответ.
3. Добавьте запрос проверки подлинности в ответ, если это необходимо.

Следующий пример взят из примера обычной проверки подлинности. Он определяет **IHttpActionResult** для внешнего результата.

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

`InnerResult` Свойство содержит внутренний **IHttpActionResult**. `Challenge` Свойство представляет заголовок Www-Authentication. Обратите внимание, что **ExecuteAsync** сначала вызывает `InnerResult.ExecuteAsync` для создания HTTP-ответа, а затем добавляет проблема, при необходимости.

Проверьте код ответа перед добавлением на запрос. Большинство схем проверки подлинности добавьте только сложной задачей при ответе 401, как показано ниже. Тем не менее некоторые схемы проверки подлинности следует добавлять к предоставлен, ответ сложной задачей. Например, см. в разделе [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).

Учитывая `AddChallengeOnUnauthorizedResult` класса, фактический код в **ChallengeAsync** прост. Просто создать результат и присоединить его к `context.Result`.

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

Примечание. Пример обычной проверки подлинности абстрагирует эта логика немного, путем помещения его в метод расширения.

## <a name="combining-authentication-filters-with-host-level-authentication"></a>Объединение фильтры проверки подлинности с помощью проверки подлинности на уровне сервера

«Проверка подлинности на уровне сервера» предшествует framework достигает веб-API запрос проверки подлинности, выполняемая узлом (например, IIS).

Часто можно включить проверку подлинности на уровне сервера для остальной части приложения, но отключить контроллеры веб-API. Например типичный сценарий — включение форм проверки подлинности на уровне узла, но использовать проверку подлинности на основе маркеров для веб-API.

Чтобы отключить проверку подлинности на уровне сервера в рамках конвейера веб-API, вызовите `config.SuppressHostPrincipal()` в конфигурации. Это приводит к веб-API удалить **IPrincipal** из любой запрос, который входит в конвейер веб-API. Фактически, он &quot;un-проверяет подлинность&quot; запроса.

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a>Дополнительные ресурсы

[Фильтры безопасности ASP.NET Web API](https://msdn.microsoft.com/magazine/dn781361.aspx) (журнал MSDN)
