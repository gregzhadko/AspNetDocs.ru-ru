---
uid: web-api/overview/security/authentication-filters
title: Фильтры проверки подлинности в веб-API ASP.NET 2 | Документация Майкрософт
author: MikeWasson
description: Фильтр проверки подлинности — это компонент, который проверяет подлинность HTTP-запроса. Веб-API 2 и MVC 5 поддерживают фильтры проверки подлинности, но они немного отличаются...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: b6815baf05303d5f47a14ee5fe0fdfc2836c1868
ms.sourcegitcommit: 88fc80e3f65aebdf61ec9414810ddbc31c543f04
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2020
ms.locfileid: "76519379"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a>Фильтры проверки подлинности в веб-API ASP.NET 2

по [Майк Уоссон](https://github.com/MikeWasson)

> Фильтр проверки подлинности — это компонент, который проверяет подлинность HTTP-запроса. Веб-API 2 и MVC 5 поддерживают фильтры проверки подлинности, но они немного отличаются, в основном в соглашениях об именовании для интерфейса фильтра. В этом разделе описываются фильтры проверки подлинности веб-API.

Фильтры проверки подлинности позволяют задать схему проверки подлинности для отдельных контроллеров или действий. Таким образом, приложение может поддерживать разные механизмы проверки подлинности для разных ресурсов HTTP.

В этой статье я покажу код из примера [обычной проверки подлинности](http://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) на [https://github.com/aspnet/samples](https://github.com/aspnet/samples). В примере показан фильтр проверки подлинности, реализующий схему проверки подлинности HTTP Basic Access (RFC 2617). Фильтр реализуется в классе с именем `IdentityBasicAuthenticationAttribute`. Я не буду показывать весь код из образца, а только части, иллюстрирующие написание фильтра проверки подлинности.

## <a name="setting-an-authentication-filter"></a>Настройка фильтра проверки подлинности

Как и другие фильтры, фильтры проверки подлинности могут применяться для каждого контроллера, действия или глобально для всех контроллеров веб-API.

Чтобы применить фильтр проверки подлинности к контроллеру, добавьте класс контроллера с атрибутом Filter. Следующий код задает фильтр `[IdentityBasicAuthentication]` для класса контроллера, который обеспечивает обычную проверку подлинности для всех действий контроллера.

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

Чтобы применить фильтр к одному действию, украшение действия с помощью фильтра. Следующий код задает фильтр `[IdentityBasicAuthentication]` для метода `Post` контроллера.

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

Чтобы применить фильтр ко всем контроллерам веб-API, добавьте его в **глобалконфигуратион. Filters**.

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a>Реализация фильтра проверки подлинности веб-API

В веб-API фильтры проверки подлинности реализуют интерфейс [System. Web. http. Filters. иаусентикатионфилтер](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) . Они также должны наследовать от **System. Attribute**, чтобы применяться в качестве атрибутов.

Интерфейс **иаусентикатионфилтер** имеет два метода:

- **AuthenticateAsync** проверяет подлинность запроса, проверяя учетные данные в запросе, если они есть.
- При необходимости **чалленжеасинк** добавляет запрос проверки подлинности в ответ HTTP.

Эти методы соответствуют потоку проверки подлинности, определенному в [rfc 2612](http://tools.ietf.org/html/rfc2616) и [RFC 2617](http://tools.ietf.org/html/rfc2617):

1. Клиент отправляет учетные данные в заголовке авторизации. Обычно это происходит после того, как клиент получает от сервера ответ 401 (несанкционированный). Однако клиент может отправить учетные данные с любым запросом, а не только после получения 401.
2. Если сервер не принимает учетные данные, он возвращает ответ 401 (несанкционированный). Ответ включает заголовок WWW-Authenticate, который содержит одну или несколько проблем. Каждый запрос указывает схему проверки подлинности, которую распознает сервер.

Сервер также может возвратить 401 из анонимного запроса. Обычно процесс проверки подлинности инициируется следующим образом:

1. Клиент отправляет анонимный запрос.
2. Сервер возвращает 401.
3. Клиенты повторно отправляют запрос с учетными данными.

Этот поток включает как *проверку подлинности* , так и действия по *авторизации* .

- Проверка подлинности удостоверяет личность клиента.
- Авторизация определяет, может ли клиент получить доступ к определенному ресурсу.

В веб-API фильтры аутентификации обрабатывали проверку подлинности, но не выполняют авторизацию. Авторизация должна выполняться фильтром авторизации или внутри действия контроллера.

Ниже приведен поток в конвейере веб-API 2:

1. Перед вызовом действия веб-API создает список фильтров проверки подлинности для этого действия. Сюда входят фильтры с областью действия, областью контроллера и глобальной областью.
2. Веб-API вызывает **AuthenticateAsync** для каждого фильтра в списке. Каждый фильтр может проверять учетные данные в запросе. Если любой фильтр успешно проверяет учетные данные, фильтр создает **IPrincipal** и прикрепляет его к запросу. На этом этапе фильтр может также активировать ошибку. Если да, остальная часть конвейера не выполняется.
3. Если нет ошибки, запрос проходит через остальную часть конвейера.
4. Наконец, веб-API вызывает метод **чалленжеасинк** каждого фильтра проверки подлинности. Фильтры используют этот метод, чтобы при необходимости добавить запрос в ответ. Обычно (но не всегда) это происходит в ответ на ошибку 401.

На следующих диаграммах показаны два возможных варианта. В первом случае фильтр проверки подлинности успешно проверяет подлинность запроса, фильтр авторизации авторизует запрос, а действие контроллера возвращает значение 200 (ОК).

![](authentication-filters/_static/image1.png)

Во втором примере фильтр проверки подлинности проверяет подлинность запроса, но фильтр авторизации возвращает 401 (несанкционированный). В этом случае действие контроллера не вызывается. Фильтр проверки подлинности добавляет к ответу заголовок WWW-Authenticate.

![](authentication-filters/_static/image2.png)

Другие сочетания возможны&mdash;например, если действие контроллера допускает анонимные запросы, может существовать фильтр проверки подлинности, но не авторизация.

## <a name="implementing-the-authenticateasync-method"></a>Реализация метода AuthenticateAsync

Метод **AuthenticateAsync** пытается проверить подлинность запроса. Вот так выглядит подпись метода.

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

Метод **AuthenticateAsync** должен выполнять одно из следующих действий:

1. Ничего (No-op).
2. Создайте **IPrincipal** и задайте его в запросе.
3. Задайте результат ошибки.

Параметр (1) означает, что запрос не имел учетных данных, распознаваемых фильтром. Параметр (2) означает, что фильтр успешно прошел проверку подлинности запроса. Параметр (3) означает, что запрос содержал недопустимые учетные данные (например, неправильный пароль), который запускает ответ об ошибке.

Ниже приведена общая структура реализации **AuthenticateAsync**.

1. Найдите в запросе учетные данные.
2. Если учетные данные отсутствуют, ничего не предпринимайте и не возвращайте (No-op).
3. Если имеются учетные данные, но фильтр не распознает схему проверки подлинности, ничего не предпринимайте и не возвращайте (No-op). Другой фильтр в конвейере может понять схему.
4. Если имеются учетные данные, распознаваемые фильтром, попробуйте выполнить их проверку подлинности.
5. Если учетные данные неверны, возвращайте значение 401, установив `context.ErrorResult`.
6. Если учетные данные действительны, создайте экземпляр **IPrincipal** и задайте `context.Principal`.

Следующий код демонстрирует метод **AuthenticateAsync** из примера [обычной проверки подлинности](http://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) . Комментарии указывают на каждый шаг. Код показывает несколько типов ошибок: заголовок Authorization без учетных данных, неправильно сформированные учетные данные и неверное имя пользователя и пароль.

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a>Установка результата ошибки

Если учетные данные недопустимы, фильтр должен задать `context.ErrorResult` **ихттпактионресулт** , который создает ответ об ошибке. Дополнительные сведения о **ихттпактионресулт**см. [в разделе результаты действия в веб-API 2](../getting-started-with-aspnet-web-api/action-results.md).

Пример обычной проверки подлинности включает класс `AuthenticationFailureResult`, который подходит для этой цели.

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a>Реализация Чалленжеасинк

Назначение метода **чалленжеасинк** заключается в добавлении к ответу проблем проверки подлинности при необходимости. Вот так выглядит подпись метода.

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

Метод вызывается для каждого фильтра проверки подлинности в конвейере запросов.

Важно понимать, что **чалленжеасинк** вызывается *до* создания HTTP-ответа и, возможно, даже перед запуском действия контроллера. При вызове **чалленжеасинк** `context.Result` содержит **ихттпактионресулт**, который используется позже для создания HTTP-ответа. Поэтому при вызове **чалленжеасинк** вы еще не знакомы с ответом HTTP. Метод **чалленжеасинк** должен заменить исходное значение `context.Result` новым **ихттпактионресулт**. Этот **ихттпактионресулт** должен переносить исходный `context.Result`.

![](authentication-filters/_static/image3.png)

Я называю исходный **ихттпактионресулт** *внутренним результатом*, а новый **ихттпактионресулт** *внешний результат*. Внешний результат должен выполнять следующие действия.

1. Вызов внутреннего результата для создания HTTP-ответа.
2. Изучите ответ.
3. При необходимости добавьте запрос проверки подлинности в ответ.

Следующий пример взят из примера обычной проверки подлинности. Он определяет **ихттпактионресулт** для внешнего результата.

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

Свойство `InnerResult` содержит внутренний **ихттпактионресулт**. Свойство `Challenge` представляет заголовок веб-аутентификации. Обратите внимание, что **ExecuteAsync** first вызывает `InnerResult.ExecuteAsync` для создания HTTP-ответа, а затем при необходимости добавляет запрос.

Перед добавлением запроса проверьте код ответа. Большинство схем проверки подлинности добавляют только запрос, если ответ равен 401, как показано ниже. Однако некоторые схемы проверки подлинности добавляют запрос в ответ об успешном выполнении. Например, см. раздел [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).

При наличии класса `AddChallengeOnUnauthorizedResult` фактический код в **чалленжеасинк** является простым. Вы просто создаете результат и подключаете его к `context.Result`.

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

Примечание. пример обычной проверки подлинности абстрагирует эту логику, поместив ее в метод расширения.

## <a name="combining-authentication-filters-with-host-level-authentication"></a>Комбинирование фильтров проверки подлинности с проверкой подлинности на уровне узла

"Проверка подлинности на уровне узла" — это проверка подлинности, выполняемая узлом (например, IIS), прежде чем запрос достигнет платформы веб-API.

Часто может потребоваться включить проверку подлинности на уровне узла для остальной части приложения, но отключить его для контроллеров веб-API. Например, типичный сценарий заключается в том, чтобы включить проверку подлинности на основе форм на уровне узла, но использовать проверку подлинности с помощью токенов для веб-API.

Чтобы отключить проверку подлинности на уровне узла в конвейере веб-API, вызовите `config.SuppressHostPrincipal()` в конфигурации. Это приводит к тому, что веб-API удаляет интерфейс **IPrincipal** из любого запроса, который входит в конвейер веб-API. Фактически, он &quot;отмену проверки подлинности&quot; запроса.

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a>Дополнительные ресурсы

[Фильтры безопасности веб-API ASP.NET](https://msdn.microsoft.com/magazine/dn781361.aspx) (журнал MSDN Magazine)
