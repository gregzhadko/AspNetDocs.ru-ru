---
uid: web-api/overview/odata-support-in-aspnet-web-api/odata-routing-conventions
title: Соглашения о маршрутизации в веб-API ASP.NET 2 OData-ASP.NET 4. x
author: MikeWasson
description: Описывает соглашения о маршрутизации, используемые веб-API 2 в ASP.NET 4. x для конечных точек OData.
ms.author: riande
ms.date: 07/31/2013
ms.custom: seoapril2019
ms.assetid: adbc175a-14eb-4ab2-a441-d056ffa8266f
msc.legacyurl: /web-api/overview/odata-support-in-aspnet-web-api/odata-routing-conventions
msc.type: authoredcontent
ms.openlocfilehash: 63df4a82cd8df92631485b2544117844cfd0ca56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78498198"
---
# <a name="routing-conventions-in-aspnet-web-api-2-odata"></a>Соглашения о маршрутизации в веб-API ASP.NET 2 OData

по [Майк Уоссон](https://github.com/MikeWasson)

> В этой статье описываются соглашения о маршрутизации, используемые веб-API 2 в ASP.NET 4. x для конечных точек OData.

Когда веб-API получает запрос OData, он сопоставляет запрос с именем контроллера и именем действия. Сопоставление основано на методе HTTP и URI. Например, `GET /odata/Products(1)` сопоставляется с `ProductsController.GetProduct`.

В части 1 этой статьи я опишу встроенные соглашения о маршрутизации OData. Эти соглашения предназначены специально для конечных точек OData и заменяют систему маршрутизации веб-API по умолчанию. (Замена происходит при вызове **маподатарауте**.)

В части 2 я покажу, как добавить настраиваемые соглашения о маршрутизации. В настоящее время встроенные соглашения не охватывают весь диапазон URI OData, но их можно расширить для работы в других случаях.

- [Встроенные соглашения о маршрутизации](#conventions)
- [Соглашения о настраиваемой маршрутизации](#custom)

<a id="conventions"></a>
## <a name="built-in-routing-conventions"></a>Встроенные соглашения о маршрутизации

Прежде чем описывать соглашения о маршрутизации OData в веб-API, полезно разобраться с URI OData. [URI OData](http://www.odata.org/documentation/odata-v3-documentation/url-conventions/) состоит из следующих компонентов:

- Корень службы
- Путь к ресурсу
- Параметры запроса

![](odata-routing-conventions/_static/image1.png)

Для маршрутизации важной частью является путь к ресурсу. Путь к ресурсу делится на сегменты. Например, `/Products(1)/Supplier` имеет три сегмента:

- `Products` ссылается на набор сущностей с именем Products.
- `1` — это ключ сущности, который выбирает одну сущность из набора.
- `Supplier` — это свойство навигации, которое выбирает связанную сущность.

Поэтому этот путь выбирает поставщика продукта 1.

> [!NOTE]
> Сегменты пути OData не всегда соответствуют сегментам URI. Например, "1" считается сегментом пути.

**Имена контроллеров.** Имя контроллера всегда является производным от набора сущностей в корне пути к ресурсу. Например, если путь к ресурсу — `/Products(1)/Supplier`, веб-API ищет контроллер с именем `ProductsController`.

**Имена действий.** Имена действий являются производными от сегментов пути и модели EDM, как показано в следующих таблицах. В некоторых случаях у вас есть два варианта имени действия. Например, Get или &quot;Products&quot;.

**Запрос сущностей**

| Запрос | Пример URI | Название действия | Пример действия |
| --- | --- | --- | --- |
| ПОЛУЧИТЬ/ентитисет | /продуктс | EntitySet или Get | GetProducts |
| ПОЛУЧИТЬ/ентитисет (ключ) | /Продуктс (1) | EntityType или Get | Продукт |
| ПОЛУЧЕНИЕ/ентитисет (Key)/каст | /Продуктс (1)/Моделс.бук | EntityType или Get | Книга |

Дополнительные сведения см. [в разделе Создание конечной точки OData только для чтения](odata-v3/creating-an-odata-endpoint.md).

**Создание, обновление и удаление сущностей**

| Запрос | Пример URI | Название действия | Пример действия |
| --- | --- | --- | --- |
| ОПУБЛИКОВАТЬ/ентитисет | /продуктс | Тип EntityType или POST | Продукт |
| РАЗМЕСТИТЬ/ентитисет (ключ) | /Продуктс (1) | Путентититипе или размещение | путпродукт |
| РАЗМЕЩЕНИЕ/ентитисет (Key)/каст | /Продуктс (1)/Моделс.бук | Путентититипе или размещение | путбук |
| /Ентитисет ИСПРАВЛЕНИЙ (ключ) | /Продуктс (1) | Патчентититипе или patch | патчпродукт |
| PATCH/ентитисет (ключ)/каст | /Продуктс (1)/Моделс.бук | Патчентититипе или patch | патчбук |
| УДАЛИТЬ/ентитисет (ключ) | /Продуктс (1) | Делетинтититипе или DELETE | DeleteProduct |
| УДАЛИТЬ/ентитисет (ключ)/каст | /Продуктс (1)/Моделс.бук | Делетинтититипе или DELETE | делетебук |

**Запрос свойства навигации**

| Запрос | Пример URI | Название действия | Пример действия |
| --- | --- | --- | --- |
| ПОЛУЧЕНИЕ/ентитисет (Key)/навигатион | /Продуктс (1)/Супплиер | Жетнавигатионфроментититипе или Navigation | жетсупплиерфромпродукт |
| ПОЛУЧЕНИЕ/ентитисет (Key)/каст/навигатион | /Продуктс (1)/Моделс.Бук/аусор | Жетнавигатионфроментититипе или Navigation | жетаусорфромбук |

Дополнительные сведения см. в разделе [Работа с связями сущностей](odata-v3/working-with-entity-relations.md).

**Создание и удаление ссылок**

| Запрос | Пример URI | Название действия |
| --- | --- | --- |
| POST/ентитисет (ключ)/$links/навигатион | /Продуктс (1)/$links/Супплиер | креателинк |
| РАЗМЕЩЕНИЕ/ентитисет (Key)/$links/навигатион | /Продуктс (1)/$links/Супплиер | креателинк |
| DELETE/ентитисет (ключ)/$links/навигатион | /Продуктс (1)/$links/Супплиер | DeleteLink |
| DELETE/ентитисет (ключ)/$links/навигатион (Релатедкэй) | /Продуктс/(1)/$links/Супплиерс (1) | DeleteLink |

Дополнительные сведения см. в разделе [Работа с связями сущностей](odata-v3/working-with-entity-relations.md).

**Свойства**

*Требуется веб-API 2*

| Запрос | Пример URI | Название действия | Пример действия |
| --- | --- | --- | --- |
| ПОЛУЧИТЬ/ентитисет (ключ)/Property | /Продуктс (1)/Name | Жетпропертифроментититипе или Property | жетнамефромпродукт |
| ПОЛУЧЕНИЕ/ентитисет (Key)/каст/Проперти | /Продуктс (1)/Моделс.Бук/аусор | Жетпропертифроментититипе или Property | жеттитлефромбук |

**Действия**

| Запрос | Пример URI | Название действия | Пример действия |
| --- | --- | --- | --- |
| POST/ентитисет (ключ)/Action | /Продуктс (1)/Рате | Актионнамеонентититипе или ActionName | ратеонпродукт |
| POST/ентитисет (ключ)/каст/Актион | /Продуктс (1)/Моделс.Бук/чеккаут | Актионнамеонентититипе или ActionName | чеккаутонбук |

Дополнительные сведения см. в разделе [действия OData](odata-v3/odata-actions.md).

**Сигнатуры методов**

Ниже приведены некоторые правила для подписей методов.

- Если путь содержит ключ, действие должно иметь параметр с именем *Key*.
- Если путь содержит ключ в свойстве навигации, то действие должно иметь параметр с именем *релатедкэй*.
- Украшение параметров *ключа* и *релатедкэй* с помощью параметра **[фромодатаури]** .
- Запросы POST и постановки принимают параметр типа сущности.
- Запросы PATCH принимают параметр типа **Delta&lt;t&gt;** , где *t* — это тип сущности.

Для справки ниже приведен пример, в котором показаны сигнатуры методов для каждого встроенного соглашения о маршрутизации OData.

[!code-csharp[Main](odata-routing-conventions/samples/sample1.cs)]

<a id="custom"></a>
## <a name="custom-routing-conventions"></a>Соглашения о настраиваемой маршрутизации

В настоящее время встроенные соглашения не охватывают все возможные URI OData. Вы можете добавить новые соглашения, реализовав интерфейс **иодатараутингконвентион** . Этот интерфейс имеет два метода:

[!code-csharp[Main](odata-routing-conventions/samples/sample2.cs)]

- **Селектконтроллер** возвращает имя контроллера.
- **Селектактион** возвращает имя действия.

Для обоих методов, если соглашение не применяется к этому запросу, метод должен вернуть значение null.

Параметр **ODataPath** представляет проанализированный путь к ресурсу OData. Он содержит список экземпляров **[одатапассегмент](https://msdn.microsoft.com/library/system.web.http.odata.routing.odatapathsegment.aspx)** , по одному для каждого сегмента пути к ресурсу. **Одатапассегмент** является абстрактным классом; Каждый тип сегмента представлен классом, производным от **одатапассегмент**.

Свойство **ODataPath. TemplatePath** — это строка, представляющая объединение всех сегментов пути. Например, если универсальный код ресурса (URI) `/Products(1)/Supplier`, шаблон пути &quot;~/ентитисет/Кэй/навигатион&quot;. Обратите внимание, что сегменты не соответствуют сегментам URI напрямую. Например, ключ сущности (1) представлен как собственный **одатапассегмент**.

Как правило, реализация **иодатараутингконвентион** выполняет следующие действия:

1. Сравните шаблон пути, чтобы узнать, применимо ли это соглашение к текущему запросу. Если он не применяется, возвращается значение null.
2. Если соглашение применяется, используйте свойства экземпляров **одатапассегмент** для получения имен контроллеров и действий.
3. Для действий добавьте в словарь маршрутов любые значения, которые должны быть привязаны к параметрам действия (обычно это ключи сущностей).

Рассмотрим конкретный пример. Встроенные соглашения о маршрутизации не поддерживают индексирование в коллекции навигации. Иными словами, не существует соглашения для URI, как в следующем примере:

[!code-javascript[Main](odata-routing-conventions/samples/sample3.js)]

Ниже приведено настраиваемое соглашение о маршрутизации для выполнения запросов такого типа.

[!code-csharp[Main](odata-routing-conventions/samples/sample4.cs)]

Примечания.

1. Я наследует от **ентитисетраутингконвентион**, так как метод **селектконтроллер** в этом классе подходит для этого нового соглашения о маршрутизации. Это означает, что мне не нужно повторно реализовывать **селектконтроллер**.
2. Соглашение применяется только к запросам GET и только в том случае, если шаблон пути &quot;~/ентитисет/Кэй/навигатион/Кэй&quot;.
3. Имя действия — &quot;получить {EntityType}&quot;, где *{EntityType}* — это тип коллекции навигации. Например, &quot;&quot;поставщика. Вы можете использовать любое соглашение об именовании, &#8212; чтобы убедиться, что действия контроллера совпадают.
4. Действие принимает два параметра с именами *Key* и *релатедкэй*. (Список некоторых предварительно определенных имен параметров см. в разделе [одатараутеконстантс](https://msdn.microsoft.com/library/system.web.http.odata.routing.odatarouteconstants.aspx).)

Следующим шагом является добавление нового соглашения в список соглашений о маршрутизации. Это происходит во время настройки, как показано в следующем коде:

[!code-csharp[Main](odata-routing-conventions/samples/sample5.cs)]

Ниже приведены некоторые другие примеры соглашений о маршрутизации, которые полезны для изучения.

- [компоситекэйраутингконвентион](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/ODataCompositeKeySample/ODataCompositeKeySample/Extensions/CompositeKeyRoutingConvention.cs)
- [кустомнавигатионраутингконвентион](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/ODataServiceSample/ODataService/Extensions/CustomNavigationRoutingConvention.cs)
- [нонбиндаблеактионраутингконвентион](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/ODataActionsSample/ODataActionsSample/NonBindableActionRoutingConvention.cs)
- [одатаверсионраутеконстраинт](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/ODataVersioningSample/ODataVersioningSample/Extensions/ODataVersionRouteConstraint.cs)

И, само собой, веб-API является открытым-исходным, поэтому вы можете увидеть [Исходный код](http://aspnetwebstack.codeplex.com/) для встроенных соглашений о маршрутизации. Они определены в пространстве имен **System. Web. http. OData. Routing. Conventions** .
