---
uid: web-api/overview/odata-support-in-aspnet-web-api/supporting-odata-query-options
title: Поддержка параметров запроса OData в веб-API ASP.NET 2 — ASP.NET 4. x
author: MikeWasson
description: В статье Общие сведения о примерах кода показаны поддерживаемые параметры запроса OData в веб-API ASP.NET 2 для ASP.NET 4. x.
ms.author: riande
ms.date: 02/04/2013
ms.custom: seoapril2019
ms.assetid: 50e6e62b-e72e-4a29-8293-4b67377bd21f
msc.legacyurl: /web-api/overview/odata-support-in-aspnet-web-api/supporting-odata-query-options
msc.type: authoredcontent
ms.openlocfilehash: 96820fab7ac89885058962f44ded86cb0184ee97
ms.sourcegitcommit: ce28244209db8615bc9bdd576a2e2c88174d318d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2020
ms.locfileid: "86188641"
---
# <a name="supporting-odata-query-options-in-aspnet-web-api-2"></a>Поддержка параметров запроса OData в веб-API ASP.NET 2

по [Майк Уоссон](https://github.com/MikeWasson)

В этом обзоре с примерами кода демонстрируется поддержка параметров запроса OData в веб-API ASP.NET 2 для ASP.NET 4. x. 

OData определяет параметры, которые могут быть использованы для изменения запроса OData. Клиент отправляет эти параметры в строку запроса URI запроса. Например, чтобы отсортировать результаты, клиент использует параметр $orderby:

`http://localhost/Products?$orderby=Name`

Спецификация OData вызывает эти параметры *запроса*. Вы можете включить параметры запроса OData для любого контроллера веб-API в проекте &#8212; контроллер не должен быть конечной точкой OData. Это предоставляет удобный способ добавления таких функций, как фильтрация и сортировка, в любое приложение веб-API.

Перед включением параметров запроса ознакомьтесь с разделом [руководство по безопасности OData](odata-security-guidance.md).

- [Включение параметров запроса OData](#enable)
- [Примеры запросов](#examples)
- [Подкачка, управляемая сервером](#server-paging)
- [Ограничение параметров запроса](#limiting_query_options)
- [Прямой вызов параметров запроса](#ODataQueryOptions)
- [Проверка запроса](#query-validation)

<a id="enable"></a>
## <a name="enabling-odata-query-options"></a>Включение параметров запроса OData

Веб-API поддерживает следующие параметры запроса OData:

| Параметр | Описание |
| --- | --- |
| $expand | Разворачивает связанные сущности в строке. |
| $filter | Фильтрует результаты на основе логического условия. |
| $inlinecount | Указывает серверу включить общее число совпадающих сущностей в ответе. (Полезно для разбиения на страницы на стороне сервера.) |
| $orderby | Сортирует результаты. |
| $select | Выбирает свойства, включаемые в ответ. |
| $skip | Пропускает первые n результатов. |
| $top | Возвращает только первые n результатов. |

Чтобы использовать параметры запроса OData, их необходимо включить явным образом. Их можно включить глобально для всего приложения или включить для конкретных контроллеров или определенных действий.

Чтобы включить параметры запроса OData глобально, вызовите **енаблекуерисуппорт** для класса **HttpConfiguration** при запуске:

[!code-csharp[Main](supporting-odata-query-options/samples/sample1.cs)]

Метод **енаблекуерисуппорт** включает глобальные параметры запроса для любого действия контроллера, возвращающего тип **IQueryable** . Если вы не хотите, чтобы параметры запроса были включены для всего приложения, можно включить их для конкретных действий контроллера, добавив атрибут [с возможностью **запроса]** к методу действия.

[!code-csharp[Main](supporting-odata-query-options/samples/sample2.cs)]

<a id="examples"></a>
## <a name="example-queries"></a>Примеры запросов

В этом разделе показаны типы запросов, которые можно использовать с помощью параметров запроса OData. Конкретные сведения о параметрах запроса см. в документации OData по адресу [www.OData.org](http://www.odata.org/).

Сведения о $expand и $select см. [в разделе использование $SELECT, $Expand и $value в веб-API ASP.NET OData](using-select-expand-and-value.md).

**Подкачка, управляемая клиентом**

Для больших наборов сущностей клиенту может потребоваться ограничить количество результатов. Например, клиент может отображать 10 записей за раз, со ссылками "Далее" для получения следующей страницы результатов. Для этого клиент использует параметры $top и $skip.

`http://localhost/Products?$top=10&$skip=20`

Параметр $top задает максимальное число возвращаемых записей, а параметр $skip задает количество записей для пропуска. В предыдущем примере выдаются записи с 21 по 30.

**Фильтрация**

Параметр $filter позволяет клиенту фильтровать результаты, применяя логическое выражение. Выражения фильтра являются достаточно мощными; в их число входят логические и арифметические операторы, строковые функции и функции даты.

| Возврат всех продуктов с категорией, равным "Toys". | `http://localhost/Products?$filter=Category`EQ "Toys" |
| --- | --- |
| Возвращает все продукты с ценой меньше 10. | `http://localhost/Products?$filter=Price`lt 10 |
| Логические операторы. Возвращает все продукты, где Price >= 5 и Price <= 15. | `http://localhost/Products?$filter=Price`GE 5 и Price Le 15 |
| Строковые функции: возвращает все продукты с именем "ZZ" в имени. | `http://localhost/Products?$filter=substringof('zz',Name)` |
| Функции даты: возвращаются все продукты с ReleaseDate после 2005. | `http://localhost/Products?$filter=year(ReleaseDate)`gt 2005 |

**Сортировка**

Чтобы отсортировать результаты, используйте фильтр $orderby.

| Сортировка по цене. | `http://localhost/Products?$orderby=Price` |
| --- | --- |
| Сортировать по цене в убывающем порядке (от самого высокого до самого низкого). | `http://localhost/Products?$orderby=Price desc` |
| Сортировать по категории, а затем сортировать по цене в порядке убывания в категориях. | `http://localhost/odata/Products?$orderby=Category,Price desc` |

<a id="server-paging"></a>
## <a name="server-driven-paging"></a>Подкачка, управляемая сервером

Если база данных содержит миллионы записей, вы не хотите отсылать их в одной полезной нагрузке. Чтобы избежать этого, сервер может ограничить количество записей, отправляемых в одном ответе. Чтобы включить серверную подкачку, задайте свойство **pageSize** в атрибуте, который можно **запросить** . Значение — это максимальное число возвращаемых записей.

[!code-csharp[Main](supporting-odata-query-options/samples/sample3.cs)]

Если контроллер Возвращает формат OData, текст ответа будет содержать ссылку на следующую страницу данных:

[!code-json[Main](supporting-odata-query-options/samples/sample4.json?highlight=8)]

Клиент может использовать эту ссылку для выборки следующей страницы. Чтобы узнать общее число записей в результирующем наборе, клиент может установить параметр $inlinecount запроса со значением "allpages".

`http://localhost/Products?$inlinecount=allpages`

Значение "allpages" указывает серверу включить в ответ общее число:

[!code-json[Main](supporting-odata-query-options/samples/sample5.json?highlight=3)]

> [!NOTE]
> Ссылки на следующую страницу и встроенное число должны иметь формат OData. Причина заключается в том, что OData определяет специальные поля в тексте ответа для хранения ссылки и количества.

Для форматов, отличных от OData, по-прежнему поддерживается поддержка ссылок на следующую страницу и встроенного подсчета путем заключения результатов запроса в **объект &lt; пажересулт &gt; T** . Однако для этого требуется немного больше кода. Например:

[!code-csharp[Main](supporting-odata-query-options/samples/sample6.cs)]

Ниже приведен пример ответа JSON.

[!code-json[Main](supporting-odata-query-options/samples/sample7.json)]

<a id="limiting_query_options"></a>
## <a name="limiting-the-query-options"></a>Ограничение параметров запроса

Параметры запроса позволяют клиенту получить большой контроль над запросом, который выполняется на сервере. В некоторых случаях может потребоваться ограничить доступные варианты по соображениям безопасности или производительности. Атрибут **[с поддержкой запроса]** имеет некоторые встроенные свойства для этого. Рассмотрим некоторые примеры.

Разрешить только $skip и $top для поддержки разбиения на страницы и других действий:

[!code-csharp[Main](supporting-odata-query-options/samples/sample8.cs)]

Разрешить упорядочение только по определенным свойствам, чтобы предотвратить сортировку по свойствам, которые не индексируются в базе данных:

[!code-csharp[Main](supporting-odata-query-options/samples/sample9.cs)]

Разрешить логическую функцию "EQ", но не другие логические функции:

[!code-csharp[Main](supporting-odata-query-options/samples/sample10.cs)]

Не разрешать арифметические операторы:

[!code-csharp[Main](supporting-odata-query-options/samples/sample11.cs)]

Вы можете глобально ограничить параметры, создав экземпляр **куеряблеаттрибуте** и передав его в функцию **енаблекуерисуппорт** :

[!code-csharp[Main](supporting-odata-query-options/samples/sample12.cs)]

<a id="ODataQueryOptions"></a>
## <a name="invoking-query-options-directly"></a>Прямой вызов параметров запроса

Вместо использования атрибута [с поддержкой **запроса]** можно вызывать параметры запроса непосредственно в контроллере. Для этого добавьте параметр **одатакуерйоптионс** в метод контроллера. В этом случае атрибут [с поддержкой **запроса]** не требуется.

[!code-csharp[Main](supporting-odata-query-options/samples/sample13.cs)]

Веб-API заполняет **одатакуерйоптионс** из строки запроса URI. Чтобы применить запрос, передайте **IQueryable** методу **ApplyTo** . Метод возвращает другой **IQueryable**.

Для более сложных сценариев, если у вас нет поставщика запросов **IQueryable** , можно проверить **одатакуерйоптионс** и преобразовать параметры запроса в другую форму. (Например, см. запись блога Рагхурам Надиминти, посвященная [преобразованию запросов OData в HQL](https://blogs.msdn.com/b/webdev/archive/2013/02/25/translating-odata-queries-to-hql.aspx), в которую также входит [Пример](http://aspnet.codeplex.com/SourceControl/changeset/view/75a56ec99968#Samples/WebApi/NHibernateQueryableSample/Readme.txt).)

<a id="query-validation"></a>
## <a name="query-validation"></a>Проверка запроса

Атрибут **[с поддержкой запроса]** проверяет запрос перед его выполнением. Шаг проверки выполняется в методе **куеряблеаттрибуте. ValidateQuery** . Также можно настроить процесс проверки.

См. также [руководство по безопасности OData](odata-security-guidance.md).

Сначала Переопределите один из классов проверяющего элемента управления, определенный в пространстве имен **Web. http. OData. Query. проверяющих** . Например, следующий класс проверяющего элемента управления отключает параметр DESC для параметра $orderby.

[!code-csharp[Main](supporting-odata-query-options/samples/sample14.cs)]

Подклассировать атрибут **[Query]** , чтобы переопределить метод **ValidateQuery** .

[!code-csharp[Main](supporting-odata-query-options/samples/sample15.cs)]

Затем задайте настраиваемый атрибут глобально или на уровне каждого контроллера:

[!code-csharp[Main](supporting-odata-query-options/samples/sample16.cs)]

Если вы используете **одатакуерйоптионс** напрямую, задайте следующие параметры проверяющего элемента управления:

[!code-csharp[Main](supporting-odata-query-options/samples/sample17.cs)]
