---
uid: web-api/overview/odata-support-in-aspnet-web-api/odata-v3/odata-actions
title: Поддержка действий OData в веб-API ASP.NET 2 | Документация Майкрософт
author: MikeWasson
description: 'В OData действия — это способ добавления поведений на стороне сервера, которые не просто определяются как операции CRUD с сущностями. К некоторым действиям относятся: реализация...'
ms.author: riande
ms.date: 02/25/2014
ms.assetid: 2d7b3aa2-aa47-4e6e-b0ce-3d65a1c6fe02
msc.legacyurl: /web-api/overview/odata-support-in-aspnet-web-api/odata-v3/odata-actions
msc.type: authoredcontent
ms.openlocfilehash: ae8b23f0868f992cb2bbbf14ee3f7ac848501515
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74600348"
---
# <a name="supporting-odata-actions-in-aspnet-web-api-2"></a>Поддержка действий OData в веб-API ASP.NET 2

по [Майк Уоссон](https://github.com/MikeWasson)

[Скачать завершенный проект](https://code.msdn.microsoft.com/ASPNET-Web-API-OData-cecdb524)

> В OData *действия* — это способ добавления поведений на стороне сервера, которые не просто определяются как операции CRUD с сущностями. Ниже перечислены некоторые способы использования действий.
> 
> - Реализация сложных транзакций.
> - Одновременное управление несколькими сущностями.
> - Разрешение обновления только для определенных свойств сущности.
> - Отправка данных на сервер, не определенный в сущности.
> 
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемые в этом руководстве
> 
> 
> - Веб-API 2
> - OData версии 3
> - Entity Framework 6

## <a name="example-rating-a-product"></a>Пример: Оценка продукта

В этом примере мы хотим разрешить пользователям оценивать продукты, а затем предоставлять среднюю оценку для каждого продукта. В базе данных будет сохранен список оценок с ключом Products.

Ниже приведена модель, которую можно использовать для представления оценок в Entity Framework:

[!code-csharp[Main](odata-actions/samples/sample1.cs)]

Но мы не хотим, чтобы клиенты пере`ProductRating` объект в коллекцию "оценки". Интуитивно, оценка связана с коллекцией Products, и клиенту нужно только опубликовать значение рейтинга.

Таким образом, вместо обычных операций CRUD мы определим действие, которое клиент может вызывать для продукта. В терминологии OData действие *привязано* к сущностям Product.

>Действия имеют побочные эффекты на сервере. По этой причине они вызываются с помощью HTTP-запросов POST. Действия могут иметь параметры и возвращаемые типы, которые описаны в метаданных службы. Клиент отправляет параметры в тексте запроса, а сервер отправляет возвращаемое значение в тексте ответа. Чтобы вызвать действие "оценить продукт", клиент отправляет POST в URI, как в следующем:

[!code-console[Main](odata-actions/samples/sample2.cmd)]

Данные в запросе POST — это просто Оценка продукта:

[!code-console[Main](odata-actions/samples/sample3.cmd)]

## <a name="declare-the-action-in-the-entity-data-model"></a>Объявите действие в EDM

В конфигурации веб-API добавьте действие в модель EDM:

[!code-csharp[Main](odata-actions/samples/sample4.cs)]

Этот код определяет "Ратепродукт" как действие, которое может быть выполнено с сущностями продукта. Он также объявляет, что действие принимает параметр **int** с именем "Оценка" и **возвращает целочисленное значение.**

## <a name="add-the-action-to-the-controller"></a>Добавление действия в контроллер

Действие "Ратепродукт" привязано к сущностям продукта. Чтобы реализовать действие, добавьте метод с именем `RateProduct` в контроллер Products:

[!code-csharp[Main](odata-actions/samples/sample5.cs)]

Обратите внимание, что имя метода совпадает с именем действия в модели EDM. Метод имеет два параметра:

- *ключ*: ключ продукта для ставки.
- *Parameters*— словарь значений параметров действия.

Если используются соглашения о маршрутизации по умолчанию, параметр key должен иметь имя Key. Также важно включить атрибут **[фромодатаури]** , как показано ниже. Этот атрибут указывает, что веб-API будет использовать правила синтаксиса OData при анализе ключа из URI запроса.

Чтобы получить параметры действия, используйте словарь *параметров* :

[!code-csharp[Main](odata-actions/samples/sample6.cs)]

Если клиент отправляет параметры действия в правильном формате, значение **ModelState. IsValid** равно true. В этом случае можно использовать словарь **одатаактионпараметерс** для получения значений параметров. В этом примере действие `RateProduct` принимает один параметр с именем "Оценка".

## <a name="action-metadata"></a>Метаданные действия

Чтобы просмотреть метаданные службы, отправьте запрос GET в/одата/$metadata. Ниже приведена часть метаданных, объявляющая действие `RateProduct`:

[!code-xml[Main](odata-actions/samples/sample7.xml)]

Элемент **FunctionImport** объявляет действие. Большинство полей говорят сами за себя, но два стоит отметить:

- **Подшивка** означает, что действие может быть вызвано в целевой сущности, по крайней мере в некоторый момент времени.
- **IsAlwaysBindable** означает, что действие всегда может вызываться в целевой сущности.

Разница заключается в том, что некоторые действия всегда доступны клиентам, но другие действия могут зависеть от состояния сущности. Например, предположим, что вы определили действие "Покупка". Вы можете приобрести только тот товар, который находится на бирже. Если товар находится за пределами склада, клиент не может вызвать это действие.

При определении модели EDM метод **действия** создает действие Always-BIND:

[!code-csharp[Main](odata-actions/samples/sample8.cs?highlight=1)]

Далее в этом разделе я расскажу о действиях, которые не всегда являются связываемыми (также называются *временными* действиями).

## <a name="invoking-the-action"></a>Вызов действия

Теперь давайте посмотрим, как клиент вызовет это действие. Предположим, клиент хочет получить оценку 2 для продукта с ИД = 4. Ниже приведен пример сообщения запроса с использованием формата JSON для текста запроса:

[!code-console[Main](odata-actions/samples/sample9.cmd)]

Ответное сообщение:

[!code-console[Main](odata-actions/samples/sample10.cmd)]

## <a name="binding-an-action-to-an-entity-set"></a>Привязка действия к набору сущностей

В предыдущем примере действие привязано к одной сущности: Клиент оценивает один продукт. Можно также привязать действие к коллекции сущностей. Просто внесите следующие изменения:

В EDM добавьте действие в свойство **коллекции** сущности.

[!code-csharp[Main](odata-actions/samples/sample11.cs?highlight=1)]

В методе контроллера опустите параметр *Key* .

[!code-csharp[Main](odata-actions/samples/sample12.cs)]

Теперь клиент вызывает действие для набора сущностей Products:

[!code-console[Main](odata-actions/samples/sample13.cmd)]

## <a name="actions-with-collection-parameters"></a>Действия с параметрами коллекции

Действия могут иметь параметры, которые принимают коллекцию значений. В модели EDM для объявления параметра используйте **коллектионпараметер&lt;t&gt;** .

[!code-csharp[Main](odata-actions/samples/sample14.cs)]

Он объявляет параметр с именем "оценки", который принимает коллекцию значений **типа int** . В методе контроллера вы по-прежнему получаете значение параметра из объекта **одатаактионпараметерс** , но теперь значением является **ICollection&lt;int&gt;** значение:

[!code-csharp[Main](odata-actions/samples/sample15.cs)]

## <a name="transient-actions"></a>Временные действия

В примере "Ратепродукт" пользователи всегда могут оценивать продукт, поэтому действие всегда доступно. Но некоторые действия зависят от состояния сущности. Например, в службе аренды видео действие "извлечение" не всегда доступно. (Это зависит от того, доступна ли копия этого видео.) Этот тип действия называется *временным* действием.

В метаданных службы временное действие имеет значение **IsAlwaysBindable** , равное false. Это действительно значение по умолчанию, поэтому метаданные будут выглядеть следующим образом:

[!code-xml[Main](odata-actions/samples/sample16.xml)]

Вот почему это важно: Если действие является временным, сервер должен сообщить клиенту, когда действие будет доступно. Это достигается путем включения ссылки на действие в сущности. Ниже приведен пример для сущности Movie:

[!code-console[Main](odata-actions/samples/sample17.cmd)]

Свойство "#CheckOut" содержит ссылку на действие извлечения. Если действие недоступно, сервер опускает ссылку.

Чтобы объявить временное действие в модели EDM, вызовите метод **трансиентактион** :

[!code-csharp[Main](odata-actions/samples/sample18.cs)]

Кроме того, необходимо предоставить функцию, которая возвращает ссылку на действие для данной сущности. Установите эту функцию, вызвав **хасактионлинк**. Функцию можно написать в виде лямбда-выражения:

[!code-csharp[Main](odata-actions/samples/sample19.cs)]

Если действие доступно, лямбда-выражение возвращает ссылку на действие. Сериализатор OData включает эту ссылку при сериализации сущности. Если действие недоступно, функция возвращает `null`.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Пример действий OData](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/OData/v3/ODataActionsSample/)
