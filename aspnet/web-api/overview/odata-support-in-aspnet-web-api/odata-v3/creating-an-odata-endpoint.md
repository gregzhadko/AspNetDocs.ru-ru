---
uid: web-api/overview/odata-support-in-aspnet-web-api/odata-v3/creating-an-odata-endpoint
title: Создание конечной точки OData v3 с веб-API 2 | Документация Майкрософт
author: MikeWasson
description: Open Data Protocol (OData) — это протокол доступа к данным веб-приложений. OData предоставляет универсальный способ структуру данных, запроса данных и работы с данными...
ms.author: riande
ms.date: 02/25/2014
ms.assetid: 262843d6-43a2-4f1c-82d9-0b90ae6df0cf
msc.legacyurl: /web-api/overview/odata-support-in-aspnet-web-api/odata-v3/creating-an-odata-endpoint
msc.type: authoredcontent
ms.openlocfilehash: fa0573738fee8f1decc13c9797f644002931e09d
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59381501"
---
# <a name="creating-an-odata-v3-endpoint-with-web-api-2"></a>Создание конечной точки OData v3 с веб-API 2

по [Майк Уоссон](https://github.com/MikeWasson)

[Скачать завершенный проект](http://code.msdn.microsoft.com/ASPNET-Web-API-OData-cecdb524)

> [Open Data Protocol](http://www.odata.org/) (OData) — это протокол доступа к данным веб-приложений. OData предоставляет универсальный способ структуру данных, запрашивать данные и манипулировать набором данных с помощью операций CRUD (Создание, чтение, обновление и удаление). OData поддерживает форматы JSON и AtomPub (XML). OData также определяет способ получения доступа к метаданным о данных. Клиенты могут использовать метаданные для обнаружения сведений о типе и связи для набора данных.
>
> Веб-API ASP.NET позволяет легко создать конечную точку OData для набора данных. Вы можете контролировать, поддерживаемые конечной точкой точно, какие операции OData. Вы можете разместить несколько конечных точек OData, вместе с конечными точками не OData. У вас есть полный контроль над вашей модели данных, серверной части бизнес-логики и уровень данных.
>
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемые в этом руководстве
>
>
> - [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013)
> - Веб-API 2
> - OData версии 3
> - Entity Framework 6
> - [Fiddler веб-отладки, прокси-сервера (необязательно)](http://www.fiddler2.com)
>
> В добавлена поддержка Web API OData [ASP.NET и веб-инструменты 2012.2 обновление](https://go.microsoft.com/fwlink/?LinkId=282650). Тем не менее в этом руководстве используется формирование шаблонов, который был добавлен в Visual Studio 2013.


В этом руководстве вы создадите простой конечной точки OData, который клиенты могут выполнять запросы. Кроме того, будет создан клиент C# для конечной точки. После завершения этого учебника, следующий набор учебных курсов показано, как добавить дополнительные функциональные возможности, включая отношений сущностей, действия, и выберите развернуть $/ $.

- [Создание проекта Visual Studio](#create-project)
- [Добавьте модель EDM](#add-model)
- [Добавить контроллер OData](#add-controller)
- [Добавьте модель EDM и маршрута](#edm)
- [Заполнение базы данных (необязательно)](#seed-db)
- [Изучение конечной точки OData](#explore)
- [Форматы сериализации OData](#formats)

<a id="create-project"></a>
## <a name="create-the-visual-studio-project"></a>Создание проекта Visual Studio

В этом руководстве вы создадите конечную точку OData, которая поддерживает основные операции CRUD. Конечная точка будет предоставлять один ресурс, список продуктов. Последующих руководствах будут добавлены дополнительные функции.

Запустите Visual Studio и выберите **новый проект** с начальной страницы. Или с **файл** меню, выберите **New** и затем **проекта**.

В **шаблоны** области выберите **установленные шаблоны** и разверните узел Visual C#. В разделе **Visual C#** выберите **Web**. Выберите **веб-приложение ASP.NET** шаблона.

![](creating-an-odata-endpoint/_static/image1.png)

В **новый проект ASP.NET** диалоговом окне выберите **пустой** шаблона. В разделе &quot;добавить папки и основные ссылки для... &quot;, проверьте **веб-API**. Нажмите кнопку **ОК**.

![](creating-an-odata-endpoint/_static/image2.png)

<a id="add-model"></a>
## <a name="add-an-entity-model"></a>Добавьте модель EDM

*Модель* — это объект, представляющий данные в приложении. В этом учебнике мы должны модель, которая представляет продукт. Соответствует модели тип сущности OData.

В обозревателе решений щелкните правой кнопкой мыши папку Models. В контекстном меню выберите **добавить** выберите **класс**.

![](creating-an-odata-endpoint/_static/image3.png)

В **Add New** товара диалоговое окно, назовите класс &quot;продукта&quot;.

![](creating-an-odata-endpoint/_static/image4.png)

> [!NOTE]
> По соглашению классы моделей, помещаются в папку Models. У вас нет следуют соглашению в своих собственных проектах. Однако мы будем использовать в этом руководстве.


В файле добавьте следующее определение класса:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample1.cs)]

Свойство ID будет ключ сущности. Клиенты могут запрашивать продуктов по идентификатору. Это поле также будет первичного ключа в базе данных серверной части.

Теперь выполните сборку проекта. В следующем шаге мы будем использовать некоторые формирования шаблонов Visual Studio, который использует отражение для поиска типа продукта.

<a id="add-controller"></a>
## <a name="add-an-odata-controller"></a>Добавить контроллер OData

Объект *контроллера* является классом, который обрабатывает HTTP-запросы. Вы определяете отдельный контроллер для каждого набора сущностей в вы службы OData. В этом руководстве мы создадим один контроллер.

В обозревателе решений щелкните правой кнопкой мыши папку Controllers. Выберите **добавить** , а затем выберите **контроллера**.

![](creating-an-odata-endpoint/_static/image5.png)

В **Добавление шаблона** диалоговом окне выберите &quot;контроллер Web API 2 OData с действиями, использующий Entity Framework&quot;.

![](creating-an-odata-endpoint/_static/image6.png)

В **Добавление контроллера** диалоговое окно, имя контроллера «ProductsController». Выберите &quot;использовать асинхронные действия контроллера&quot; флажок. В **модели** раскрывающегося списка выберите класс Product.

![](creating-an-odata-endpoint/_static/image7.png)

Нажмите кнопку **новый контекст данных...**  кнопки. Оставьте имя по умолчанию для типа контекста данных и нажмите кнопку **добавить**.

![](creating-an-odata-endpoint/_static/image8.png)

В диалоговом окне "Добавление контроллера" Добавление контроллера нажмите кнопку "Добавить".

![](creating-an-odata-endpoint/_static/image9.png)

Примечание. Если вы получаете сообщение об ошибке &quot;произошла ошибка при получении тип... &quot;, убедитесь, что вы создали проект Visual Studio после добавления к классу продукта. Формирование шаблонов использует отражение для поиска класса.

![](creating-an-odata-endpoint/_static/image10.png)

Формирование шаблонов добавляет в проект два файла кода:

- Products.cs определяет контроллер Web API, который реализует конечной точки OData.
- ProductServiceContext.cs предоставляет методы для запроса основной базе данных, использующий Entity Framework.

![](creating-an-odata-endpoint/_static/image11.png)

<a id="edm"></a>
## <a name="add-the-edm-and-route"></a>Добавьте модель EDM и маршрута

В обозревателе решений, разверните приложение\_запустите папку и откройте файл WebApiConfig.cs. Этот класс содержит код конфигурации для веб-API. Замените этот код следующим:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample2.cs)]

Этот код делает две вещи:

- Создает Entity Data Model (EDM) для конечной точки OData.
- Добавляет маршрут для конечной точки.

EDM является абстрактной моделью данных. Модель EDM используется для создания документа метаданных и определения URI для службы. **ODataConventionModelBuilder** создает EDM, используя набор соглашений об именовании по умолчанию модели EDM. Этот подход требует наименьшего объема кода. Если требуется больший контроль над модели EDM, можно использовать **ODataModelBuilder** класс, чтобы создать модель EDM путем добавления свойств, разделов и свойств навигации явным образом.

**EntitySet** метод добавляет в модель EDM набор сущностей:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample3.cs)]

Строка «Продукты» определяет имя набора сущностей. Имя контроллера должно соответствовать имени набора сущностей. В этом руководстве набор сущностей, который называется «Продукты» и именем контроллера `ProductsController`. Если вы с именем «ProductSet» набора сущностей, следует присвоить имя контроллера `ProductSetController`. Обратите внимание на то, что конечная точка может иметь несколько наборов сущностей. Вызовите **EntitySet&lt;T&gt;**  для каждой сущности, установить, а затем определить соответствующий контроллер.

**MapODataRoute** метод добавляет маршрут для конечной точки OData.

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample4.cs)]

Первый параметр — это понятное имя для маршрута. Клиенты службы, это имя не отображается. Второй параметр — префикс URI для конечной точки. Учитывая этот код, URI для набора сущностей Products — http://<em>hostname</em>  /odata/продуктов. Приложение может иметь более одной конечной точки OData. Для каждой конечной точки, вызовите <strong>MapODataRoute</strong> и укажите уникальное имя маршрута и уникальный префикс URI.

<a id="seed-db"></a>
## <a name="seed-the-database-optional"></a>Заполнение базы данных (необязательно)

На этом шаге используется Entity Framework для инициализации базы данных с некоторые тестовые данные. Этот шаг является необязательным, но вы можете сразу тестирование конечной точки OData.

Из **средства** меню, выберите **диспетчер пакетов NuGet**, а затем выберите **консоль диспетчера пакетов**. В окне консоли диспетчера пакетов введите следующую команду:

[!code-console[Main](creating-an-odata-endpoint/samples/sample5.cmd)]

Это добавляет папку с именем миграций и файл кода Configuration.cs.

![](creating-an-odata-endpoint/_static/image12.png)

Откройте этот файл и добавьте следующий код, чтобы `Configuration.Seed` метод.

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample6.cs)]

В окне консоли диспетчера пакетов введите следующие команды:

[!code-console[Main](creating-an-odata-endpoint/samples/sample7.cmd)]

Эти команды создают код, который создает базу данных, а затем выполняет этот код.

<a id="explore"></a>
## <a name="exploring-the-odata-endpoint"></a>Изучение конечной точки OData

В этом разделе мы будем использовать [Fiddler Web Debugging Proxy](http://www.fiddler2.com) для отправки запросов к конечной точке и изучения ответные сообщения. Это поможет вам понять возможности конечной точки OData.

В Visual Studio нажмите клавишу F5, чтобы начать отладку. По умолчанию Visual Studio открывает браузер `http://localhost:*port*`, где *порт* — номер порта, настроенный в параметрах проекта.

Можно изменить номер порта в параметрах проекта. В обозревателе решений щелкните правой кнопкой мыши проект и выберите **свойства**. В окне «Свойства» выберите **Web**. Введите номер порта в разделе **URL-адрес проекта**.

### <a name="service-document"></a>Сервисный документ

*Сервисный документ* содержит список наборов сущностей для конечной точки OData. Чтобы получить Сервисный документ, отправьте запрос GET к корневому URI службы.

С помощью Fiddler, введите следующий URI в **Composer** вкладку: `http://localhost:port/odata/`, где *порт* — номер порта.

![](creating-an-odata-endpoint/_static/image13.png)

Нажмите кнопку **Execute** кнопки. Fiddler приложение отправляет запрос HTTP GET. Вы должны увидеть ответ в списке веб-сеансами. Если все работает, код состояния будет 200.

![](creating-an-odata-endpoint/_static/image14.png)

Дважды щелкните ответ в списке веб-сеансами, чтобы просмотреть сведения о ответное сообщение на вкладке «Инспекторы».

![](creating-an-odata-endpoint/_static/image15.png)

Необработанное сообщение ответа HTTP должен выглядеть следующим образом:

[!code-console[Main](creating-an-odata-endpoint/samples/sample8.cmd)]

По умолчанию веб-API возвращает Сервисный документ в формате AtomPub. Чтобы запросить JSON, добавьте следующий заголовок HTTP-запроса:

`Accept: application/json`

![](creating-an-odata-endpoint/_static/image16.png)

Теперь в HTTP-ответа содержит полезные данные JSON:

[!code-console[Main](creating-an-odata-endpoint/samples/sample9.cmd)]

### <a name="service-metadata-document"></a>Документ метаданных службы

*Документ метаданных службы* описывается модель данных, службы, с помощью языка XML языка определения концептуальной схемы (CSDL). Документ метаданных показана структура данных в службе и может использоваться для создания кода клиента.

Чтобы получить документ метаданных, отправьте запрос GET к `http://localhost:port/odata/$metadata`. Вот метаданные для конечной точки, в этом учебнике.

[!code-console[Main](creating-an-odata-endpoint/samples/sample10.cmd)]

### <a name="entity-set"></a>Набор сущностей

Для получения набора сущностей Products, отправьте запрос GET к `http://localhost:port/odata/Products`.

[!code-console[Main](creating-an-odata-endpoint/samples/sample11.cmd)]

### <a name="entity"></a>Объект

Для получения конкретного продукта, отправьте запрос GET к `http://localhost:port/odata/Products(1)`, где «1» — это код продукта.

[!code-console[Main](creating-an-odata-endpoint/samples/sample12.cmd)]

<a id="formats"></a>
## <a name="odata-serialization-formats"></a>Форматы сериализации OData

OData поддерживает несколько форматов сериализации:

- Atom Pub (XML)
- JSON «light» (впервые представлено в OData v3)
- JSON «verbose» (OData v2)

По умолчанию веб-API использует формат «light» AtomPubJSON.

Чтобы получить формат AtomPub, задайте заголовок Accept «application/atom + xml». Ниже приведен пример текста ответа.

[!code-console[Main](creating-an-odata-endpoint/samples/sample13.cmd)]

Вы увидите одним из очевидных недостатков формат Atom. Это гораздо более подробным, чем JSON light. Тем не менее если у вас есть клиент, который понимает AtomPub, клиент может предпочитать этот формат JSON.

Ниже приведен JSON облегченная версия той же сущности.

[!code-console[Main](creating-an-odata-endpoint/samples/sample14.cmd)]

Формат JSON light появилась в версии 3 протокола OData. Для обеспечения обратной совместимости старые «verbose» формат JSON может запрашиваться клиентом. Чтобы запросить подробный формат JSON, задайте для заголовка Accept `application/json;odata=verbose`. Ниже приведен подробный версии.

[!code-console[Main](creating-an-odata-endpoint/samples/sample15.cmd)]

Этот формат передает дополнительные метаданные в текст ответа, который можно добавляют существенные системные издержки на весь сеанс. Кроме того он добавляет уровень косвенного обращения, заключив объект в свойство с именем «d».

## <a name="next-steps"></a>Следующие шаги

- [Добавление отношений сущностей](working-with-entity-relations.md)
- [Добавление действия OData](odata-actions.md)
- [Вызов службы OData из клиента .NET](calling-an-odata-service-from-a-net-client.md)
