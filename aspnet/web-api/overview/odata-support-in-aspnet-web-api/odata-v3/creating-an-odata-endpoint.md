---
uid: web-api/overview/odata-support-in-aspnet-web-api/odata-v3/creating-an-odata-endpoint
title: Создание конечной точки OData v3 с помощью веб-API 2 | Документация Майкрософт
author: MikeWasson
description: Open Data Protocol (OData) — это протокол доступа к данным для Интернета. OData обеспечивает единообразный способ структурирования данных, запроса данных и обработки данных...
ms.author: riande
ms.date: 02/25/2014
ms.assetid: 262843d6-43a2-4f1c-82d9-0b90ae6df0cf
msc.legacyurl: /web-api/overview/odata-support-in-aspnet-web-api/odata-v3/creating-an-odata-endpoint
msc.type: authoredcontent
ms.openlocfilehash: e68a454398f109dfd089be9c9a44d3fe662acc2f
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2019
ms.locfileid: "74600431"
---
# <a name="creating-an-odata-v3-endpoint-with-web-api-2"></a>Создание конечной точки OData v3 с веб-API 2

по [Майк Уоссон](https://github.com/MikeWasson)

[Скачать завершенный проект](https://code.msdn.microsoft.com/ASPNET-Web-API-OData-cecdb524)

> [Open Data Protocol](http://www.odata.org/) (OData) — это протокол доступа к данным для Интернета. OData обеспечивает единообразный способ структурирования данных, выполнения запросов к данным и управления набором данных с помощью операций CRUD (создание, чтение, обновление и удаление). OData поддерживает форматы AtomPub (XML) и JSON. OData также определяет способ предоставления метаданных о данных. Клиенты могут использовать метаданные для обнаружения сведений о типе и связей для набора данных.
>
> Веб-API ASP.NET позволяет легко создать конечную точку OData для набора данных. Вы можете точно контролировать, какие операции OData поддерживает конечная точка. Можно разместить несколько конечных точек OData вместе с конечными точками, отличными от OData. Вы имеете полный контроль над моделью данных, внутренней бизнес-логикой и уровнем данных.
>
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемые в этом руководстве
>
>
> - [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013)
> - Веб-API 2
> - OData версии 3
> - Entity Framework 6
> - [Fiddler веб-прокси отладки (необязательно)](http://www.fiddler2.com)
>
> Поддержка веб-API OData добавлена в [ASP.NET and Web Tools обновление 2012,2](https://go.microsoft.com/fwlink/?LinkId=282650). Однако в этом руководстве используется формирование шаблонов, добавленное в Visual Studio 2013.

В этом руководстве вы создадите простую конечную точку OData, которую клиенты смогут запрашивать. Вы также создадите C# клиент для конечной точки. После завершения работы с этим руководством в следующем наборе руководств показано, как добавить дополнительные функции, включая отношения сущностей, действия и $expand/$select.

- [Создание проекта Visual Studio](#create-project)
- [Добавление модели сущностей](#add-model)
- [Добавление контроллера OData](#add-controller)
- [Добавление модели EDM и маршрута](#edm)
- [Заполнение базы данных (необязательно)](#seed-db)
- [Изучение конечной точки OData](#explore)
- [Форматы сериализации OData](#formats)

<a id="create-project"></a>
## <a name="create-the-visual-studio-project"></a>Создание проекта Visual Studio

В этом руководстве вы создадите конечную точку OData, которая поддерживает базовые операции CRUD. Конечная точка будет предоставлять один ресурс, список продуктов. В последующих руководствах будут добавлены дополнительные функции.

Запустите Visual Studio и выберите **создать проект** на начальной странице. Либо в меню **файл** выберите **создать** , а затем — **проект**.

В области **шаблоны** выберите **Установленные шаблоны** и разверните узел визуального C# элемента. В **разделе C#визуальный** элемент выберите **веб**. Выберите шаблон **веб-приложение ASP.NET** .

![](creating-an-odata-endpoint/_static/image1.png)

В диалоговом окне **Новый проект ASP.NET** выберите **пустой** шаблон. В разделе &quot;добавить папки и основные ссылки для...&quot;, проверьте **веб-API**. Нажмите кнопку **ОК**.

![](creating-an-odata-endpoint/_static/image2.png)

<a id="add-model"></a>
## <a name="add-an-entity-model"></a>Добавление модели сущностей

*Модель* — это объект, представляющий данные в приложении. Для работы с этим руководством нам нужна модель, представляющая продукт. Модель соответствует типу сущности OData.

В обозреватель решений щелкните правой кнопкой мыши папку модели. В контекстном меню выберите **Добавить** , а затем выберите **класс**.

![](creating-an-odata-endpoint/_static/image3.png)

В диалоговом окне **Добавление нового** элемента назовите класс &quot;&quot;продукта.

![](creating-an-odata-endpoint/_static/image4.png)

> [!NOTE]
> По соглашению классы модели помещаются в папку Models. Вам не нужно следовать этому соглашению в своих проектах, но мы будем использовать его в этом руководстве.

В файле Product.cs добавьте следующее определение класса:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample1.cs)]

Свойство ID будет ключом сущности. Клиенты могут запрашивать продукты по ИДЕНТИФИКАТОРу. Это поле также будет первичным ключом в серверной базе данных.

Постройте проект прямо сейчас. На следующем шаге мы будем использовать некоторые шаблоны Visual Studio, использующие отражение для поиска типа продукта.

<a id="add-controller"></a>
## <a name="add-an-odata-controller"></a>Добавление контроллера OData

*Контроллер* — это класс, который обрабатывает HTTP-запросы. Вы определяете отдельный контроллер для каждого набора сущностей в службе OData. В этом руководстве мы создадим один контроллер.

В обозреватель решений щелкните правой кнопкой мыши папку Controllers. Нажмите кнопку **Добавить** , а затем выберите **контроллер**.

![](creating-an-odata-endpoint/_static/image5.png)

В диалоговом окне **Добавление шаблона** выберите &quot;контроллер OData веб-API 2 с действиями с помощью Entity Framework&quot;.

![](creating-an-odata-endpoint/_static/image6.png)

В диалоговом окне **Добавление контроллера** назовите контроллер «продуктсконтроллер». Установите флажок &quot;использовать действия асинхронного контроллера&quot;. В раскрывающемся списке **модель** выберите класс Product.

![](creating-an-odata-endpoint/_static/image7.png)

Нажмите кнопку **создать контекст данных...** . Оставьте имя по умолчанию для типа контекста данных и нажмите кнопку **Добавить**.

![](creating-an-odata-endpoint/_static/image8.png)

Нажмите кнопку Добавить в диалоговом окне Добавление контроллера, чтобы добавить контроллер.

![](creating-an-odata-endpoint/_static/image9.png)

Примечание. при получении сообщения об ошибке с сообщением &quot;ошибка при получении типа...&quot;убедитесь, что проект Visual Studio создан после добавления класса Product. Формирование шаблонов использует отражение для поиска класса.

![](creating-an-odata-endpoint/_static/image10.png)

Формирование шаблонов добавляет в проект два файла кода:

- Products.cs Определяет контроллер веб-API, который реализует конечную точку OData.
- ProductServiceContext.cs предоставляет методы для запроса к базовой базе данных с помощью Entity Framework.

![](creating-an-odata-endpoint/_static/image11.png)

<a id="edm"></a>
## <a name="add-the-edm-and-route"></a>Добавление модели EDM и маршрута

В обозреватель решений разверните папку приложение\_запуск и откройте файл с именем WebApiConfig.cs. Этот класс содержит код конфигурации для веб-API. Замените этот код следующим:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample2.cs)]

Этот код выполняет два действия:

- Создает EDM (модель EDM) для конечной точки OData.
- Добавляет маршрут для конечной точки.

EDM — это абстрактная модель данных. Модель EDM используется для создания документа метаданных и определения URI для службы. **Одатаконвентионмоделбуилдер** создает EDM с помощью набора соглашений об именовании по умолчанию EDM. Этот подход требует наименьшего кода. Если требуется больший контроль над EDM, можно использовать класс **одатамоделбуилдер** для создания модели EDM путем явного добавления свойств, ключей и свойств навигации.

Метод **EntitySet** добавляет набор сущностей в модель EDM:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample3.cs)]

Строка "Products" определяет имя набора сущностей. Имя контроллера должно совпадать с именем набора сущностей. В этом руководстве набор сущностей называется "Products", а контроллер называется `ProductsController`. При именовании набора сущностей "набор продуктов" имя контроллера будет называться `ProductSetController`. Обратите внимание, что конечная точка может иметь несколько наборов сущностей. Вызовите **entityset&lt;t&gt;** для каждого набора сущностей, а затем определите соответствующий контроллер.

Метод **маподатарауте** добавляет маршрут для конечной точки OData.

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample4.cs)]

Первый параметр — это понятное имя маршрута. Клиенты службы не видят это имя. Вторым параметром является префикс URI для конечной точки. Учитывая этот код, URI для набора сущностей Products — http://<em>имя узла</em>/одата/Продуктс. Приложение может иметь более одной конечной точки OData. Для каждой конечной точки вызовите <strong>маподатарауте</strong> и укажите уникальное имя маршрута и уникальный префикс URI.

<a id="seed-db"></a>
## <a name="seed-the-database-optional"></a>Заполнение базы данных (необязательно)

На этом шаге вы будете использовать Entity Framework для заполнения базы данных некоторыми тестовыми данными. Этот шаг является необязательным, но он позволяет сразу же протестировать конечную точку OData.

В меню **Сервис** выберите **Диспетчер пакетов NuGet**, а затем выберите **консоль диспетчера пакетов**. В окне консоли диспетчера пакетов введите следующую команду:

[!code-console[Main](creating-an-odata-endpoint/samples/sample5.cmd)]

При этом добавляется папка с именем Migrations и файл кода с именем Configuration.cs.

![](creating-an-odata-endpoint/_static/image12.png)

Откройте этот файл и добавьте следующий код в метод `Configuration.Seed`.

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample6.cs)]

В окне консоли диспетчера пакетов введите следующие команды:

[!code-console[Main](creating-an-odata-endpoint/samples/sample7.cmd)]

Эти команды создают код, который создает базу данных, а затем выполняет этот код.

<a id="explore"></a>
## <a name="exploring-the-odata-endpoint"></a>Изучение конечной точки OData

В этом разделе мы будем использовать [прокси веб-отладки Fiddler](http://www.fiddler2.com) для отправки запросов в конечную точку и проверки ответных сообщений. Это поможет понять возможности конечной точки OData.

В Visual Studio нажмите клавишу F5, чтобы начать отладку. По умолчанию Visual Studio открывает браузер для `http://localhost:*port*`, где *Port* — номер порта, настроенный в параметрах проекта.

Номер порта можно изменить в параметрах проекта. В обозреватель решений щелкните правой кнопкой мыши проект и выберите пункт **Свойства**. В окне Свойства выберите **веб**. Введите номер порта в поле **URL-адрес проекта**.

### <a name="service-document"></a>Сервисный документ

*Сервисный документ* содержит список наборов сущностей для конечной точки OData. Чтобы получить сервисный документ, отправьте запрос GET на корневой URI службы.

С помощью Fiddler введите следующий URI на вкладке **Composer** : `http://localhost:port/odata/`, где *Port* — номер порта.

![](creating-an-odata-endpoint/_static/image13.png)

Нажмите кнопку **выполнить** . Fiddler отправляет в приложение запрос HTTP GET. Ответ должен отобразиться в списке веб-сеансов. Если все работает, код состояния будет 200.

![](creating-an-odata-endpoint/_static/image14.png)

Дважды щелкните ответ в списке веб-сеансов, чтобы просмотреть подробные сведения о ответном сообщении на вкладке Инспекторы.

![](creating-an-odata-endpoint/_static/image15.png)

Необработанное ответное сообщение HTTP должно выглядеть следующим образом:

[!code-console[Main](creating-an-odata-endpoint/samples/sample8.cmd)]

По умолчанию веб-API возвращает сервисный документ в формате AtomPub. Чтобы запросить JSON, добавьте следующий заголовок в HTTP-запрос:

`Accept: application/json`

![](creating-an-odata-endpoint/_static/image16.png)

Теперь ответ HTTP содержит полезные данные JSON:

[!code-console[Main](creating-an-odata-endpoint/samples/sample9.cmd)]

### <a name="service-metadata-document"></a>Документ метаданных службы

В *документе метаданных службы* описывается модель данных службы с помощью языка XML, который НАЗЫВАЕТСЯ языком CSDL. В документе метаданных представлена структура данных в службе, которую можно использовать для создания клиентского кода.

Чтобы получить документ метаданных, отправьте запрос GET в `http://localhost:port/odata/$metadata`. Ниже приведены метаданные для конечной точки, показанной в этом руководстве.

[!code-console[Main](creating-an-odata-endpoint/samples/sample10.cmd)]

### <a name="entity-set"></a>Набор сущностей

Чтобы получить набор сущностей Products, отправьте запрос GET в `http://localhost:port/odata/Products`.

[!code-console[Main](creating-an-odata-endpoint/samples/sample11.cmd)]

### <a name="entity"></a>Объект

Чтобы получить отдельный продукт, отправьте запрос GET в `http://localhost:port/odata/Products(1)`, где "1" — это идентификатор продукта.

[!code-console[Main](creating-an-odata-endpoint/samples/sample12.cmd)]

<a id="formats"></a>
## <a name="odata-serialization-formats"></a>Форматы сериализации OData

OData поддерживает несколько форматов сериализации:

- Файл Atom (XML)
- JSON "Light" (появился в OData v3)
- JSON "verbose" (OData v2)

По умолчанию веб-API использует формат "Light" Атомпубжсон.

Чтобы получить формат AtomPub, задайте для заголовка Accept значение "Application/Atom + XML". Вот пример текста ответа:

[!code-console[Main](creating-an-odata-endpoint/samples/sample13.cmd)]

Можно увидеть один из очевидных недостатков формата Atom: он является гораздо более подробным, чем источник JSON. Однако если у вас есть клиент, который понимает AtomPub, клиент может предпочесть этот формат через JSON.

Ниже приведена легкая версия JSON той же сущности:

[!code-console[Main](creating-an-odata-endpoint/samples/sample14.cmd)]

Формат JSON появился в версии 3 протокола OData. Для обеспечения обратной совместимости клиент может запросить старый формат JSON "verbose". Чтобы запросить подробный JSON, задайте для заголовка Accept значение `application/json;odata=verbose`. Ниже приведена подробная версия:

[!code-console[Main](creating-an-odata-endpoint/samples/sample15.cmd)]

Этот формат передает больше метаданных в тексте ответа, что может значительно увеличить нагрузку на весь сеанс. Кроме того, он добавляет уровень косвенного обращения, упаковывая объект в свойство с именем «d».

## <a name="next-steps"></a>Дальнейшие действия

- [Добавление связей сущностей](working-with-entity-relations.md)
- [Добавление действий OData](odata-actions.md)
- [Вызов службы OData из клиента .NET](calling-an-odata-service-from-a-net-client.md)
