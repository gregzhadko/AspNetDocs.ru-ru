---
uid: web-api/overview/testing-and-debugging/tracing-in-aspnet-web-api
title: Трассировка в веб-API ASP.NET 2 | Документация Майкрософт
author: MikeWasson
description: Показывает, как включить трассировку в веб-API ASP.NET.
ms.author: riande
ms.date: 02/25/2014
ms.assetid: 66a837e9-600b-4b72-97a9-19804231c64a
msc.legacyurl: /web-api/overview/testing-and-debugging/tracing-in-aspnet-web-api
msc.type: authoredcontent
ms.openlocfilehash: a01acb649556d06ab9828ceab0fcbdf363bbc0d1
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78484344"
---
# <a name="tracing-in-aspnet-web-api-2"></a>Трассировка в веб-API ASP.NET 2

по [Майк Уоссон](https://github.com/MikeWasson)

> При попытке отладки веб-приложения не заменяется хороший набор журналов трассировки. В этом учебнике показано, как включить трассировку в веб-API ASP.NET. Эту функцию можно использовать для трассировки того, что делает платформа веб-API до и после того, как она вызывает контроллер. Его также можно использовать для трассировки собственного кода.
>
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемые в этом руководстве
>
> - [Visual studio 2017](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=button+cta&utm_content=download+vs2017) (также работает с visual Studio 2015)
> - Веб-API 2
> - [Microsoft. AspNet. WebApi. Tracing](http://www.nuget.org/packages/Microsoft.AspNet.WebApi.Tracing)

## <a name="enable-systemdiagnostics-tracing-in-web-api"></a>Включение трассировки System. Diagnostics в веб-API

Сначала мы создадим новый проект веб-приложения ASP.NET. В Visual Studio в меню **файл** выберите пункт **создать** > **проект**. Вразделе Шаблоны **выберите веб** **-приложение ASP.NET**.

[![](tracing-in-aspnet-web-api/_static/image2.png)](tracing-in-aspnet-web-api/_static/image1.png)

Выберите шаблон проекта веб-API.

[![](tracing-in-aspnet-web-api/_static/image4.png)](tracing-in-aspnet-web-api/_static/image3.png)

В меню **Сервис** выберите **Диспетчер пакетов NuGet**, а затем — **консоль управления пакетами**.

В окне консоли диспетчера пакетов введите следующие команды.

[!code-console[Main](tracing-in-aspnet-web-api/samples/sample1.cmd)]

Первая команда устанавливает последний пакет трассировки веб-API. Он также обновляет основные пакеты веб-API. Вторая команда обновляет пакет WebApi. WebHost до последней версии.

> [!NOTE]
> Если вы хотите ориентироваться на конкретную версию веб-API, используйте флаг-Version при установке пакета трассировки.

Откройте файл WebApiConfig.cs в папке App\_Start. Добавьте следующий код в метод **Register** .

[!code-csharp[Main](tracing-in-aspnet-web-api/samples/sample2.cs?highlight=6)]

Этот код добавляет класс [SystemDiagnosticsTraceWriter](https://msdn.microsoft.com/library/system.web.http.tracing.systemdiagnosticstracewriter.aspx) в конвейер веб-API. Класс **SystemDiagnosticsTraceWriter** записывает трассировки в [System. Diagnostics. Trace](https://msdn.microsoft.com/library/system.diagnostics.trace).

Чтобы просмотреть трассировки, запустите приложение в отладчике. Откройте браузер и перейдите по адресу `/api/values`.

![](tracing-in-aspnet-web-api/_static/image5.png)

Инструкции трассировки записываются в окно вывода в Visual Studio. (В меню **вид** выберите **выходные данные**).

[![](tracing-in-aspnet-web-api/_static/image7.png)](tracing-in-aspnet-web-api/_static/image6.png)

Поскольку **SystemDiagnosticsTraceWriter** записывает трассировки в **System. Diagnostics. Trace**, можно зарегистрировать дополнительные прослушиватели трассировки. Например, для записи трассировок в файл журнала. Дополнительные сведения о модулях записи трассировки см. в разделе [прослушиватели трассировки](https://msdn.microsoft.com/library/4y5y10s7.aspx) в MSDN.

### <a name="configuring-systemdiagnosticstracewriter"></a>Настройка SystemDiagnosticsTraceWriter

В следующем коде показано, как настроить модуль записи трассировки.

[!code-csharp[Main](tracing-in-aspnet-web-api/samples/sample3.cs)]

Существует два параметра, которыми можно управлять:

- Verbose: при значении false Каждая трассировка содержит минимальную информацию. Если значение — true, трассировки содержат дополнительные сведения.
- Минимумлевел: задает минимальный уровень трассировки. Уровни трассировки, по порядку, являются отладкой, информацией, предупреждением, ошибкой и неустранимой.

## <a name="adding-traces-to-your-web-api-application"></a>Добавление трассировок в приложение веб-API

Добавление модуля записи трассировки обеспечивает немедленный доступ к трассировкам, созданным конвейером веб-API. Для трассировки собственного кода можно также использовать модуль записи трассировки:

[!code-csharp[Main](tracing-in-aspnet-web-api/samples/sample4.cs)]

Чтобы получить модуль записи трассировки, вызовите **HttpConfiguration. Services. жеттрацевритер**. С контроллера этот метод доступен через свойство **ApiController. Configuration** .

Чтобы написать трассировку, можно напрямую вызвать метод **итрацевритер. Trace** , но класс [итрацевритерекстенсионс](https://msdn.microsoft.com/library/system.web.http.tracing.itracewriterextensions.aspx) определяет некоторые методы расширения, которые более понятны. Например, приведенный выше метод **info** создает трассировку со **сведениями**на уровне трассировки.

## <a name="web-api-tracing-infrastructure"></a>Инфраструктура трассировки веб-API

В этом разделе описывается написание пользовательского модуля записи трассировки для веб-API.

Пакет Microsoft. AspNet. WebApi. Tracing построен на основе более общей инфраструктуры трассировки в веб-API. Вместо использования Microsoft. AspNet. WebApi. Tracing можно также подключить другую библиотеку трассировки и ведения журнала, например [NLog](http://nlog-project.org/) или [log4net](http://logging.apache.org/log4net/).

Чтобы получить трассировку, реализуйте интерфейс **итрацевритер** . Вот простой пример:

[!code-csharp[Main](tracing-in-aspnet-web-api/samples/sample5.cs)]

Метод **итрацевритер. Trace** создает трассировку. Вызывающий объект указывает категорию и уровень трассировки. Категория может быть любой определяемой пользователем строкой. Ваша реализация **трассировки** должна выполнять следующие действия:

1. Создайте новый **трацерекорд**. Инициализируйте его с помощью запроса, категории и уровня трассировки, как показано ниже. Эти значения предоставляются вызывающей стороной.
2. Вызов делегата *трацеактион* . Внутри этого делегата ожидается, что вызывающий объект заполнит оставшуюся часть **трацерекорд**.
3. Напишите **трацерекорд**, используя любой способ ведения журнала, который вам нравится. Пример, показанный здесь, просто вызывает **System. Diagnostics. Trace**.

## <a name="setting-the-trace-writer"></a>Настройка модуля записи трассировки

Чтобы включить трассировку, необходимо настроить веб-API для использования реализации **итрацевритер** . Это можно сделать с помощью объекта **HttpConfiguration** , как показано в следующем коде:

[!code-csharp[Main](tracing-in-aspnet-web-api/samples/sample6.cs)]

Активным может быть только один модуль записи трассировки. По умолчанию веб-API задает &quot;не&quot; трассировку, которая не выполняет никаких действий. (&quot;оператор tracert&quot; не существует, поэтому код трассировки не должен проверять, имеет ли модуль записи трассировки **значение NULL** перед записью трассировки.)

## <a name="how-web-api-tracing-works"></a>Как работает трассировка веб-API

Трассировка в веб-API использует шаблон *фасадной* : когда трассировка включена, веб-API создает оболочку для различных частей конвейера запросов с помощью классов, выполняющих вызовы трассировки.

Например, при выборе контроллера конвейер использует интерфейс **ихттпконтроллерселектор** . При включенной трассировке конвейер вставляет класс, который реализует **ихттпконтроллерселектор** , но вызывает реальную реализацию:

![Трассировка веб-API использует шаблон фасадной.](tracing-in-aspnet-web-api/_static/image8.png)

Ниже перечислены преимущества этой схемы.

- Если не добавить модуль записи трассировки, компоненты трассировки не создаются и не влияют на производительность.
- Если заменить службы по умолчанию, такие как **ихттпконтроллерселектор** , собственной пользовательской реализацией, трассировка не будет затронуты, так как трассировка выполняется объектом-оболочкой.

Вы также можете заменить всю платформу трассировки веб-API собственной настраиваемой платформой, заменив службу **итрацеманажер** по умолчанию:

[!code-csharp[Main](tracing-in-aspnet-web-api/samples/sample7.cs)]

Реализуйте **итрацеманажер. Initialize** для инициализации системы трассировки. Имейте в виду, что это заменяет *всю* платформу трассировки, включая весь код трассировки, встроенный в веб-API.
