---
uid: web-api/overview/data/using-web-api-with-entity-framework/part-4
title: Обработка отношений сущностей | Документация Майкрософт
author: MikeWasson
description: ''
ms.author: riande
ms.date: 06/16/2014
ms.assetid: d2f5710c-23c7-40a5-9cd9-5d0516570cba
msc.legacyurl: /web-api/overview/data/using-web-api-with-entity-framework/part-4
msc.type: authoredcontent
ms.openlocfilehash: be4948e5443a5eb4e1824c63dd0c445a7ee1928e
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59384698"
---
# <a name="handling-entity-relations"></a>Обработка отношений сущностей

по [Майк Уоссон](https://github.com/MikeWasson)

[Скачать завершенный проект](https://github.com/MikeWasson/BookService)

В этом разделе описаны некоторые дополнительные сведения о том, как EF загружает связанные сущности и способ обработки циклических переходов свойства в классах модели. (В этом разделе содержатся основные сведения и не требуется для работы с этим руководством. Если вы предпочитаете, перейдите к разделу [часть 5.](part-5.md).)

## <a name="eager-loading-versus-lazy-loading"></a>Безотложная загрузка и отложенная загрузка

При использовании EF в реляционной базе данных, важно понять, как EF загружает связанные данные.

Это также полезно видеть, платформа EF создает SQL-запросов. Для трассировки SQL, добавьте следующую строку кода, чтобы `BookServiceContext` конструктор:

[!code-csharp[Main](part-4/samples/sample1.cs)]

При отправке запроса GET к /api/books, возвращается JSON следующего вида:

[!code-console[Main](part-4/samples/sample2.cmd)]

Вы увидите, что свойства Author имеет значение null, несмотря на то, что в книге содержатся допустимые AuthorId. Том, что EF не загружает связанные сущности автора. Это подтверждается в журнал трассировки SQL-запроса:

[!code-console[Main](part-4/samples/sample3.sql)]

Инструкция SELECT принимает из электронной таблицы и не ссылается на таблицу автора.

Для справки ниже приведен метод в `BooksController` класс, который возвращает список книг.

[!code-csharp[Main](part-4/samples/sample4.cs)]

Давайте посмотрим, как мы возвращаем автор как часть данных JSON. Существует три способа загрузки связанных данных в Entity Framework: Безотложная загрузка, отложенная загрузка и явная загрузка. Существует компромисс с каждой технологии и поэтому важно понять принципы их работы.

### <a name="eager-loading"></a>Активная загрузка

С помощью *Безотложная загрузка*, EF загружает связанные сущности как часть запроса исходной базы данных. Безотложная загрузка используется, **System.Data.Entity.Include** метода расширения.

[!code-csharp[Main](part-4/samples/sample5.cs)]

Это сообщает EF, чтобы получить данные автора в запросе. Если вы этого не сделать и запустите приложение, теперь данные JSON выглядит следующим образом:

[!code-console[Main](part-4/samples/sample6.cmd)]

Журнал трассировки показывает, что EF выполнено соединение таблицы Book и автор.

[!code-console[Main](part-4/samples/sample7.cmd)]

### <a name="lazy-loading"></a>Отложенная загрузка

Отложенная загрузка, EF автоматически загружает связанные сущности при разыменовании свойство навигации для этой сущности. Чтобы включить отложенную загрузку, сделайте виртуальный свойство навигации. Например в класс книги:

[!code-csharp[Main](part-4/samples/sample8.cs?highlight=6)]

Теперь рассмотрим следующий код:

[!code-csharp[Main](part-4/samples/sample9.cs)]

Если отложенная загрузка включена, доступ к `Author` свойство `books[0]` приводит к EF для запроса к базе данных для автора.

Отложенная загрузка требуется множество обращений базы данных, так как EF отправляет запрос каждый раз, он извлекает связанной сущности. Как правило требуется отложенная загрузка отключена для объектов, которые можно сериализовать. Сериализатор должен читать все свойства на модели, которая запускает загрузки связанных сущностей. Например вот SQL-запросов, когда EF сериализует список книг, отложенная загрузка включена. Вы увидите, что EF делает три отдельные запросы для трех авторов.

[!code-console[Main](part-4/samples/sample10.sql)]

По-прежнему, бывают случаи, когда может потребоваться использовать отложенную загрузку. Безотложная загрузка может привести к EF для создания очень сложного соединения. Связанные сущности, которые могут потребоваться для небольшой набор данных и отложенная загрузка будет более эффективным.

Один из способов избежать сериализации — сериализовать объекты передачи данных (DTO), а не объектами сущностей. Этот подход я покажу чуть позже.

### <a name="explicit-loading"></a>Явная загрузка

Явная загрузка аналогичен отложенной загрузки, за исключением того, что вы явным образом получать связанные данные в коде; Это не происходит автоматически при доступе к свойству навигации. Явная загрузка обеспечивает больший контроль над тем, когда для загрузки связанных данных, но требует дополнительного кода. Дополнительные сведения о явной загрузкой, см. в разделе [загрузка связанных сущностей](https://msdn.microsoft.com/data/jj574232#explicit).

## <a name="navigation-properties-and-circular-references"></a>Свойства навигации и циклические ссылки

При определении модели книги и автор, я определил свойством навигации на `Book` класс для связи автора книги, но свойство навигации не был определен в другом направлении.

Что произойдет, если добавить соответствующее свойство навигации к `Author` класса?

[!code-csharp[Main](part-4/samples/sample11.cs?highlight=7)]

К сожалению это создает проблему при сериализации модели. Если загружать связанные данные, он создает граф объекта.

![](part-4/_static/image1.png)

Когда модуль форматирования JSON или XML пытается получить сериализация графа, он сообщит об исключении. Двумя модулями форматирования выдавать исключение другого сообщения. Вот пример для модуля форматирования JSON:

[!code-console[Main](part-4/samples/sample12.cmd)]

Ниже приведен модуль форматирования XML.

[!code-xml[Main](part-4/samples/sample13.xml)]

Одним из решений является использование DTO, описывающие в следующем разделе. Кроме того можно настроить модули форматирования JSON и XML для выполнения циклов графа. Дополнительные сведения см. в разделе [обработка циклические ссылки объекта](../../formats-and-model-binding/json-and-xml-serialization.md#handling_circular_object_references).

Для этого руководства не требуется `Author.Book` свойство навигации, поэтому его можно опустить.

> [!div class="step-by-step"]
> [Назад](part-3.md)
> [Вперед](part-5.md)
