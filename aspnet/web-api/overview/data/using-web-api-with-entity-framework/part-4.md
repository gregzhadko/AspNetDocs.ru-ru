---
uid: web-api/overview/data/using-web-api-with-entity-framework/part-4
title: Обработка связей сущностей | Документация Майкрософт
author: MikeWasson
description: ''
ms.author: riande
ms.date: 06/16/2014
ms.assetid: d2f5710c-23c7-40a5-9cd9-5d0516570cba
msc.legacyurl: /web-api/overview/data/using-web-api-with-entity-framework/part-4
msc.type: authoredcontent
ms.openlocfilehash: be4948e5443a5eb4e1824c63dd0c445a7ee1928e
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78449124"
---
# <a name="handling-entity-relations"></a>Обработка отношений сущностей

по [Майк Уоссон](https://github.com/MikeWasson)

[Скачать завершенный проект](https://github.com/MikeWasson/BookService)

В этом разделе описаны некоторые сведения о том, как EF загружает связанные сущности и как обрабатывались циклические свойства навигации в классах модели. (Этот раздел содержит фундаментальные сведения и не является обязательным для работы с этим руководством. Если вы предпочитаете, перейдите к [части 5.](part-5.md)..)

## <a name="eager-loading-versus-lazy-loading"></a>Упреждающая загрузка и отложенная загрузка

При использовании EF с реляционной базой данных важно понимать, как EF загружает связанные данные.

Также полезно просмотреть запросы SQL, формируемые EF. Чтобы выполнить трассировку SQL, добавьте следующую строку кода в конструктор `BookServiceContext`:

[!code-csharp[Main](part-4/samples/sample1.cs)]

Если отправить запрос GET в/АПИ/Букс, он вернет JSON следующим образом:

[!code-console[Main](part-4/samples/sample2.cmd)]

Можно увидеть, что свойство Author имеет значение null, даже если книга содержит допустимый Аусорид. Это обусловлено тем, что EF не загружает связанные сущности Author. Журнал трассировки запроса SQL подтверждает следующее:

[!code-console[Main](part-4/samples/sample3.sql)]

Инструкция SELECT берется из таблицы Books и не ссылается на таблицу Author.

Для справки ниже приведен метод класса `BooksController`, который возвращает список книг.

[!code-csharp[Main](part-4/samples/sample4.cs)]

Давайте посмотрим, как можно вернуть автора в составе данных JSON. Существует три способа загрузки связанных данных в Entity Framework: Упреждающая загрузка, отложенная загрузка и явная загрузка. С каждым приемом связаны компромиссы, поэтому важно понимать, как они работают.

### <a name="eager-loading"></a>Активная загрузка

При *безотлагательной загрузке*EF загружает связанные сущности в ходе первоначального запроса к базе данных. Для выполнения безотлагательной загрузки используйте метод расширения **System. Data. Entity. include** .

[!code-csharp[Main](part-4/samples/sample5.cs)]

Это указывает EF включить в запрос данные автора. Если внести это изменение и запустить приложение, данные JSON будут выглядеть следующим образом:

[!code-console[Main](part-4/samples/sample6.cmd)]

В журнале трассировки показано, что EF выполнил соединение с таблицами Book и Author.

[!code-console[Main](part-4/samples/sample7.cmd)]

### <a name="lazy-loading"></a>Отложенная загрузка

При отложенной загрузке EF автоматически загружает связанную сущность при разыменовании свойства навигации для этой сущности. Чтобы включить отложенную загрузку, сделайте свойство навигации виртуальным. Например, в классе Book:

[!code-csharp[Main](part-4/samples/sample8.cs?highlight=6)]

Теперь рассмотрим следующий код:

[!code-csharp[Main](part-4/samples/sample9.cs)]

Если отложенная загрузка включена, доступ к свойству `Author` в `books[0]` приводит к тому, что EF запрашивает у автора запрос к базе данных.

Для отложенной загрузки требуется несколько обращений к базе данных, поскольку EF отправляет запрос каждый раз, когда он извлекает связанную сущность. Как правило, для сериализуемых объектов требуется неактивная загрузка. Сериализатор должен считывать все свойства модели, что активирует загрузку связанных сущностей. Например, ниже приведены запросы SQL, когда EF сериализует список книг с включенной отложенной загрузкой. Видно, что EF делает три отдельных запроса для трех авторов.

[!code-console[Main](part-4/samples/sample10.sql)]

В некоторых случаях может потребоваться использовать отложенную загрузку. Упреждающая загрузка может привести к тому, что EF создаст очень сложное соединение. Или может потребоваться наличие связанных сущностей для небольшого подмножества данных, а отложенная загрузка будет более эффективной.

Одним из способов избежать проблем с сериализацией является сериализация объектов передаваемых данных (DTO), а не объектов сущностей. Этот подход будет показан далее в этой статье.

### <a name="explicit-loading"></a>Явная загрузка

Явная загрузка аналогична отложенной загрузке за исключением того, что вы явно получаете связанные данные в коде. Это не происходит автоматически при доступе к свойству навигации. Явная загрузка обеспечивает более полное управление временем загрузки связанных данных, но требует дополнительного кода. Дополнительные сведения о явной загрузке см. в разделе [Загрузка связанных сущностей](https://msdn.microsoft.com/data/jj574232#explicit).

## <a name="navigation-properties-and-circular-references"></a>Свойства навигации и циклические ссылки

Определив модели книги и автора, я определил свойство навигации в классе `Book` для связи «книга-автор», но я не определил свойство навигации в другом направлении.

Что произойдет, если добавить соответствующее свойство навигации в класс `Author`?

[!code-csharp[Main](part-4/samples/sample11.cs?highlight=7)]

К сожалению, это создает проблему при сериализации моделей. При загрузке связанных данных создается круглый граф объектов.

![](part-4/_static/image1.png)

Когда модуль форматирования JSON или XML пытается сериализовать граф, возникает исключение. Два модуля форматирования создают разные сообщения об исключениях. Ниже приведен пример модуля форматирования JSON.

[!code-console[Main](part-4/samples/sample12.cmd)]

Вот модуль форматирования XML:

[!code-xml[Main](part-4/samples/sample13.xml)]

Одним из решений является использование DTO, который я опишу в следующем разделе. Кроме того, можно настроить модули форматирования JSON и XML для работы с циклами графов. Дополнительные сведения см. в разделе [Обработка циклических ссылок на объекты](../../formats-and-model-binding/json-and-xml-serialization.md#handling_circular_object_references).

В этом руководстве не требуется свойство навигации `Author.Book`, чтобы его можно было оставить.

> [!div class="step-by-step"]
> [Назад](part-3.md)
> [Вперед](part-5.md)
