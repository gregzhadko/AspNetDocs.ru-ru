---
uid: web-api/overview/advanced/http-cookies
title: Файлы cookie HTTP в веб-API ASP.NET-ASP.NET 4. x
author: MikeWasson
description: Описывает, как отправлять и получать файлы cookie HTTP в веб-API для ASP.NET 4. x.
ms.author: riande
ms.date: 09/17/2012
ms.custom: seoapril2019
ms.assetid: 243db2ec-8f67-4a5e-a382-4ddcec4b4164
msc.legacyurl: /web-api/overview/advanced/http-cookies
msc.type: authoredcontent
ms.openlocfilehash: 8ca26ff6776daa13bc4f8b06c2eba61afcfefba2
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78449316"
---
# <a name="http-cookies-in-aspnet-web-api"></a>Файлы cookie HTTP в веб-API ASP.NET

по [Майк Уоссон](https://github.com/MikeWasson)

В этом разделе описано, как отправлять и получать файлы cookie HTTP в веб-API.

## <a name="background-on-http-cookies"></a>Общие сведения об cookie-файлах HTTP

В этом разделе приводится краткий обзор реализации файлов cookie на уровне HTTP. Дополнительные сведения см. в [RFC 6265](http://tools.ietf.org/html/rfc6265).

Файл cookie — это часть данных, которую сервер отправляет в ответе HTTP. Клиент (необязательно) сохраняет файл cookie и возвращает его в последующие запросы. Это позволяет клиенту и серверу совместно использовать состояние. Чтобы задать файл cookie, сервер включает в ответ заголовок Set-cookie. Формат файла cookie — это пара "имя-значение" с необязательными атрибутами. Пример:

[!code-powershell[Main](http-cookies/samples/sample1.ps1)]

Ниже приведен пример с атрибутами.

[!code-powershell[Main](http-cookies/samples/sample2.ps1)]

Чтобы вернуть файл cookie на сервер, клиент включает заголовок cookie в последующих запросах.

[!code-console[Main](http-cookies/samples/sample3.cmd)]

![](http-cookies/_static/image1.png)

HTTP-ответ может включать несколько заголовков Set-cookie.

[!code-powershell[Main](http-cookies/samples/sample4.ps1)]

Клиент возвращает несколько файлов cookie, используя один заголовок файла cookie.

[!code-console[Main](http-cookies/samples/sample5.cmd)]

Область и длительность файла cookie контролируются следующими атрибутами в заголовке Set-Cookie:

- **Домен**: сообщает клиенту, какой домен должен получить файл cookie. Например, если домен имеет значение "example.com", клиент возвращает файл cookie в каждый поддомен example.com. Если этот параметр не указан, то домен является сервером-источником.
- **Путь**: файл cookie ограничен указанным путем в домене. Если этот параметр не указан, используется путь URI запроса.
- **Срок действия**: задает дату окончания срока действия для файла cookie. Клиент удаляет файл cookie по истечении срока его действия.
- **Max-age**: задает максимальный возраст для cookie. Клиент удаляет файл cookie при достижении максимального срока.

Если заданы и `Expires`, и `Max-Age`, `Max-Age` имеет приоритет. Если ни один из этих параметров не задан, клиент удаляет файл cookie при завершении текущего сеанса. (Точное значение параметра Session определяется агентом пользователя.)

Однако имейте в виду, что клиенты могут игнорировать файлы cookie. Например, пользователь может отключить файлы cookie в целях обеспечения конфиденциальности. Клиенты могут удалять файлы cookie до истечения срока их действия или ограничивать число хранимых файлов cookie. В целях обеспечения конфиденциальности клиенты часто ототклоняют "сторонние" файлы cookie, в которых домен не соответствует серверу источника. Вкратце, сервер не должен полагаться на возвращение файлов cookie, которые он задает.

## <a name="cookies-in-web-api"></a>Файлы cookie в веб-API

Чтобы добавить файл cookie в HTTP-ответ, создайте экземпляр **кукиехеадервалуе** , представляющий файл cookie. Затем вызовите метод расширения **аддкукиес** , который определен в **системе .NET. http. Класс Хттпреспонсехеадерсекстенсионс** для добавления файла cookie.

Например, следующий код добавляет файл cookie в действие контроллера:

[!code-csharp[Main](http-cookies/samples/sample6.cs)]

Обратите внимание, что **аддкукиес** принимает массив экземпляров **кукиехеадервалуе** .

Чтобы извлечь файлы cookie из клиентского запроса, вызовите метод **Кука** :

[!code-csharp[Main](http-cookies/samples/sample7.cs)]

**Кукиехеадервалуе** содержит коллекцию экземпляров **кукиестате** . Каждый **кукиестате** представляет один файл cookie. Используйте метод индексатора для получения **кукиестате** по имени, как показано ниже.

## <a name="structured-cookie-data"></a>Структурированные данные файлов cookie

Многие браузеры ограничивают количество файлов cookie,&#8212;в которых они будут хранить как общее число, так и число на каждый домен. Таким образом, можно разместить структурированные данные в одном файле cookie, а не задавать несколько файлов cookie.

> [!NOTE]
> В RFC 6265 не определена структура данных файлов cookie.

С помощью класса **кукиехеадервалуе** можно передать список пар "имя-значение" для данных файлов cookie. Эти пары "имя-значение" кодируются как данные формы в формате URL-адреса в заголовке Set-Cookie:

[!code-csharp[Main](http-cookies/samples/sample8.cs)]

Предыдущий код создает следующий заголовок Set-Cookie:

[!code-powershell[Main](http-cookies/samples/sample9.ps1)]

Класс **кукиестате** предоставляет метод индексатора для чтения подзначений из файла cookie в сообщении запроса:

[!code-csharp[Main](http-cookies/samples/sample10.cs)]

## <a name="example-set-and-retrieve-cookies-in-a-message-handler"></a>Пример. задание и извлечение файлов cookie в обработчике сообщений

В предыдущих примерах было показано, как использовать файлы cookie в контроллере веб-API. Другой вариант — использовать [обработчики сообщений](http-message-handlers.md). Обработчики сообщений вызываются в конвейере раньше, чем на контроллерах. Обработчик сообщений может считывать файлы cookie из запроса до того, как запрос достигнет контроллера, или добавить файлы cookie в ответ после того, как контроллер создаст ответ.

![](http-cookies/_static/image2.png)

В следующем коде показан обработчик сообщений для создания идентификаторов сеансов. Идентификатор сеанса хранится в файле cookie. Обработчик проверяет запрос для файла cookie сеанса. Если запрос не содержит файл cookie, обработчик создает новый идентификатор сеанса. В любом случае обработчик сохраняет идентификатор сеанса в контейнере свойств **HttpRequestMessage. Properties** . Он также добавляет файл cookie сеанса в HTTP-ответ.

Эта реализация не проверяет, что идентификатор сеанса клиента фактически выдан сервером. Не используйте его в качестве формы проверки подлинности! Точкой примера является отображение управления HTTP-файлами cookie.

[!code-csharp[Main](http-cookies/samples/sample11.cs)]

Контроллер может получить идентификатор сеанса из контейнера свойств **HttpRequestMessage. Properties** .

[!code-csharp[Main](http-cookies/samples/sample12.cs)]
