---
uid: web-api/overview/advanced/sending-html-form-data-part-2
title: 'Отправка данных HTML-формы в веб-API ASP.NET: Отправка файлов и многокомпонентный MIME-ASP.NET 4. x'
author: MikeWasson
description: В этом руководстве показано, как отправлять файлы в веб-API. В нем также описывается обработка составных данных MIME.
ms.author: riande
ms.date: 06/21/2012
ms.custom: seoapril2019
ms.assetid: a7f3c1b5-69d9-4261-b082-19ffafa5f16a
msc.legacyurl: /web-api/overview/advanced/sending-html-form-data-part-2
msc.type: authoredcontent
ms.openlocfilehash: f5aaebb96f631dfb6b0da1fbca96cd93a6a7fe2d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78449214"
---
# <a name="sending-html-form-data-in-aspnet-web-api-file-upload-and-multipart-mime"></a>Отправка данных HTML-формы в веб-API ASP.NET: Отправка файлов и многокомпонентный MIME

по [Майк Уоссон](https://github.com/MikeWasson)

## <a name="part-2-file-upload-and-multipart-mime"></a>Часть 2. Передача файлов и составной MIME

В этом руководстве показано, как отправлять файлы в веб-API. В нем также описывается обработка составных данных MIME.

> [!NOTE]
> [Скачайте завершенный проект](https://code.msdn.microsoft.com/ASPNET-Web-API-File-Upload-a8c0fb0d).

Ниже приведен пример HTML-формы для отправки файла.

[!code-html[Main](sending-html-form-data-part-2/samples/sample1.html)]

![](sending-html-form-data-part-2/_static/image1.png)

Эта форма содержит элемент управления вводом текста и элемент управления вводом файла. Если форма содержит элемент управления вводом файла, атрибут **енктипе** всегда должен быть &quot;составной&quot;многоэлементных данных/форм, который указывает, что форма будет отправлена как многокомпонентное сообщение MIME.

Формат многокомпонентного сообщения MIME проще понять, взглянув на пример запроса:

[!code-console[Main](sending-html-form-data-part-2/samples/sample2.cmd)]

Это сообщение разделено на две *части*— по одному для каждого элемента управления формы. Границы части обозначаются линиями, начинающимися с тире.

> [!NOTE]
> Граница части включает в себя случайный компонент (&quot;41184676334&quot;), чтобы предотвратить случайное отображение строки границы внутри части сообщения.

Каждая часть сообщения содержит один или несколько заголовков, за которыми следует содержимое части.

- Заголовок Content-Disposition содержит имя элемента управления. Для файлов также содержит имя файла.
- Заголовок Content-Type описывает данные в части. Если этот заголовок опущен, по умолчанию используется text/plain.

В предыдущем примере пользователь передал файл с именем Грандканйон. jpg с типом содержимого image/jpeg; а значение текстового ввода было &quot;лето&quot;.

## <a name="file-upload"></a>Передача файла

Теперь давайте взглянем на контроллер веб-API, который считывает файлы из составного сообщения MIME. Контроллер будет считывать файлы в асинхронном режиме. Веб-API поддерживает асинхронные действия с помощью [модели программирования на основе задач](https://msdn.microsoft.com/library/dd460693.aspx). Во-первых, вот код, если вы нацелены на .NET Framework 4,5, поддерживающие ключевые слова **Async** и **await** .

[!code-csharp[Main](sending-html-form-data-part-2/samples/sample3.cs)]

Обратите внимание, что действие контроллера не принимает никаких параметров. Это связано с тем, что мы обрабатываем текст запроса внутри действия без вызова модуля форматирования типа мультимедиа.

Метод **исмултипартконтент** проверяет, содержит ли запрос составной MIME-сообщение. В противном случае контроллер возвращает код состояния HTTP 415 (неподдерживаемый тип носителя).

Класс **мултипартформдатастреампровидер** — это вспомогательный объект, который выделяет потоковые файлы для отправленных файлов. Для чтения составного сообщения MIME вызовите метод **реадасмултипартасинк** . Этот метод извлекает все части сообщения и записывает их в потоки, предоставляемые **мултипартформдатастреампровидер**.

По завершении выполнения метода можно получить сведения о файлах из свойства **филедата** , которое представляет собой коллекцию объектов **мултипартфиледата** .

- **Мултипартфиледата. filename** — это локальное имя файла на сервере, где был сохранен файл.
- **Мултипартфиледата. Headers** содержит заголовок части (а*не* заголовок запроса). Его можно использовать для доступа к содержимому\_расположения и заголовкам Content-Type.

Как видно из названия, **реадасмултипартасинк** является асинхронным методом. Чтобы выполнить работу после завершения метода, используйте [задачу продолжения](https://msdn.microsoft.com/library/ee372288.aspx) (.NET 4,0) или ключевое слово **await** (.NET 4,5).

Ниже приведена версия .NET Framework 4,0 с предыдущим кодом:

[!code-csharp[Main](sending-html-form-data-part-2/samples/sample4.cs)]

## <a name="reading-form-control-data"></a>Чтение данных элемента управления формы

HTML-форма, которую я показал ранее, имел элемент управления Text input.

[!code-html[Main](sending-html-form-data-part-2/samples/sample5.html)]

Значение элемента управления можно получить из свойства **формдата** объекта **мултипартформдатастреампровидер**.

[!code-csharp[Main](sending-html-form-data-part-2/samples/sample6.cs?highlight=15)]

**Формдата** — это **NameValueCollection** , содержащий пары "имя-значение" для элементов управления формы. Коллекция может содержать дублирующиеся ключи. Рассмотрим следующую форму:

[!code-html[Main](sending-html-form-data-part-2/samples/sample7.html)]

![](sending-html-form-data-part-2/_static/image2.png)

Текст запроса может выглядеть следующим образом:

[!code-console[Main](sending-html-form-data-part-2/samples/sample8.cmd)]

В этом случае коллекция **формдата** будет содержать следующие пары "ключ-значение":

- Поездка: круговой путь
- параметры: не останавливаться
- параметры: даты
- рабочее место: окно
