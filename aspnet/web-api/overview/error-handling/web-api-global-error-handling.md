---
uid: web-api/overview/error-handling/web-api-global-error-handling
title: Глобальная обработка ошибок в веб-API ASP.NET 2 — ASP.NET 4. x
author: davidmatson
description: Общие сведения об глобальной обработке ошибок в веб-API ASP.NET 2 для ASP.NET 4. x.
ms.author: riande
ms.date: 02/03/2014
ms.custom: seoapril2019
ms.assetid: bffd7863-f63b-4b23-a13c-372b5492e9fb
msc.legacyurl: /web-api/overview/error-handling/web-api-global-error-handling
msc.type: authoredcontent
ms.openlocfilehash: 94f2d6d31d0b37f9bb0077e6258c70a2dfb1918d
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77457743"
---
# <a name="global-error-handling-in-aspnet-web-api-2"></a><span data-ttu-id="ddb7c-103">Глобальная обработка ошибок в веб-API ASP.NET 2</span><span class="sxs-lookup"><span data-stu-id="ddb7c-103">Global Error Handling in ASP.NET Web API 2</span></span>

<span data-ttu-id="ddb7c-104">по [Дэвида Матсон](https://github.com/davidmatson), [Рик Андерсон (](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-104">by [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="ddb7c-105">В этом разделе приводится обзор глобальной обработки ошибок в веб-API ASP.NET 2 для ASP.NET 4. x.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-105">This topic provides an overview of global error handling in ASP.NET Web API 2 for ASP.NET 4.x.</span></span> <span data-ttu-id="ddb7c-106">Сегодня в веб-API нет простого способа для глобального протоколирования или обработки ошибок.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-106">Today there's no easy way in Web API to log or handle errors globally.</span></span> <span data-ttu-id="ddb7c-107">Некоторые необработанные исключения могут обрабатываться с помощью [фильтров исключений](exception-handling.md), но существует ряд случаев, когда фильтры исключений не могут обрабатываться.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-107">Some unhandled exceptions can be processed via [exception filters](exception-handling.md), but there are a number of cases that exception filters can't handle.</span></span> <span data-ttu-id="ddb7c-108">Например:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-108">For example:</span></span>

1. <span data-ttu-id="ddb7c-109">Исключения выброшены из конструкторов контроллеров.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-109">Exceptions thrown from controller constructors.</span></span>
2. <span data-ttu-id="ddb7c-110">Исключения выброшены из обработчиков сообщений.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-110">Exceptions thrown from message handlers.</span></span>
3. <span data-ttu-id="ddb7c-111">Исключения выброшены при маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-111">Exceptions thrown during routing.</span></span>
4. <span data-ttu-id="ddb7c-112">Исключения, возникшие во время сериализации содержимого ответа.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-112">Exceptions thrown during response content serialization .</span></span>

<span data-ttu-id="ddb7c-113">Мы хотим предоставить простой, согласованный способ ведения журнала и управления (где это возможно) этих исключений.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-113">We want to provide a simple, consistent way to log and handle (where possible) these exceptions.</span></span> 

<span data-ttu-id="ddb7c-114">Существует два основных случая обработки исключений, случаи, когда мы можем отправить ответ об ошибке, и случай, когда все мы можем сделать, — записать исключение.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-114">There are two major cases for handling exceptions, the case where we are able to send an error response and the case where all we can do is log the exception.</span></span> <span data-ttu-id="ddb7c-115">Примером для последнего случая является случай возникновения исключения в середине содержимого ответа потоковой передачи. в этом случае слишком поздно отправить новое ответное сообщение, так как код состояния, заголовки и часть содержимого уже пропали по сети, поэтому мы просто прервать соединение.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-115">An example for the latter case is when an exception is thrown in the middle of streaming response content; in that case it is too late to send a new response message since the status code, headers, and partial content have already gone across the wire, so we simply abort the connection.</span></span> <span data-ttu-id="ddb7c-116">Несмотря на то, что исключение не может быть обработано для создания нового ответного сообщения, мы по-прежнему поддерживаем ведение журнала исключения.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-116">Even though the exception can't be handled to produce a new response message, we still support logging the exception.</span></span> <span data-ttu-id="ddb7c-117">В случаях, когда мы можем обнаружить ошибку, можно вернуть соответствующий ответ об ошибке, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-117">In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample1.cs?highlight=6)]

### <a name="existing-options"></a><span data-ttu-id="ddb7c-118">Существующие параметры</span><span class="sxs-lookup"><span data-stu-id="ddb7c-118">Existing Options</span></span>

<span data-ttu-id="ddb7c-119">В дополнение к [фильтрам исключений](exception-handling.md), [обработчики сообщений](../advanced/http-message-handlers.md) можно использовать сегодня для отслеживания всех ответов уровня 500, но обработка этих ответов усложняется, так как в них отсутствует контекст исходной ошибки.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-119">In addition to [exception filters](exception-handling.md), [message handlers](../advanced/http-message-handlers.md) can be used today to observe all 500-level responses, but acting on those responses is difficult, as they lack context about the original error.</span></span> <span data-ttu-id="ddb7c-120">Обработчики сообщений также имеют некоторые из тех же ограничений, что и фильтры исключений, касающиеся случаев, когда они могут быть обработаны. Хотя веб-API имеет инфраструктуру трассировки, которая фиксирует условия ошибки, инфраструктура трассировки предназначена для диагностики и не предназначена для работы в рабочих средах.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-120">Message handlers also have some of the same limitations as exception filters regarding the cases they can handle.While Web API does have tracing infrastructure that captures error conditions the tracing infrastructure is for diagnostics purposes and is not designed or suited for running in production environments.</span></span> <span data-ttu-id="ddb7c-121">Глобальная обработка исключений и ведение журнала должны быть службами, которые могут выполняться во время рабочей среды и быть подключенными к существующим решениям для мониторинга (например, [ELMAH](https://code.google.com/p/elmah/) ).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-121">Global exception handling and logging should be services that can run during production and be plugged into existing monitoring solutions (for example, [ELMAH](https://code.google.com/p/elmah/) ).</span></span>

### <a name="solution-overview"></a><span data-ttu-id="ddb7c-122">Общие сведения о решении</span><span class="sxs-lookup"><span data-stu-id="ddb7c-122">Solution Overview</span></span>

 <span data-ttu-id="ddb7c-123">Мы предоставляем две новые пользовательские службы, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) и IExceptionHandler, для ведения журнала и обработки необработанных исключений.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-123">We provide two new user-replaceable services, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) and IExceptionHandler, to log and handle unhandled exceptions.</span></span> <span data-ttu-id="ddb7c-124">Службы очень похожи, и два основных отличия:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-124">The services are very similar, with two main differences:</span></span>

1. <span data-ttu-id="ddb7c-125">Мы поддерживаем регистрацию нескольких средств ведения журнала исключений, но только один обработчик исключений.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-125">We support registering multiple exception loggers but only a single exception handler.</span></span>
2. <span data-ttu-id="ddb7c-126">Средства ведения журнала исключений всегда вызываются, даже если мы собираемся прервать подключение.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-126">Exception loggers always get called, even if we're about to abort the connection.</span></span> <span data-ttu-id="ddb7c-127">Обработчики исключений вызываются только тогда, когда мы по-прежнему можем выбрать ответное сообщение для отправки.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-127">Exception handlers only get called when we're still able to choose which response message to send.</span></span>

<span data-ttu-id="ddb7c-128">Обе службы предоставляют доступ к контексту исключения, содержащему важную информацию, из точки, где было обнаружено исключение, в частности [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), [хттпрекуестконтекст](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), вызванного исключения и источника исключения (подробные сведения приведены ниже).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-128">Both services provide access to an exception context containing relevant information from the point where the exception was detected, particularly the [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), the [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), the thrown exception and the exception source (details below).</span></span>

### <a name="design-principles"></a><span data-ttu-id="ddb7c-129">Принципы проектирования</span><span class="sxs-lookup"><span data-stu-id="ddb7c-129">Design Principles</span></span>

1. <span data-ttu-id="ddb7c-130">**Нет критических изменений** Так как эта функциональность добавляется во вспомогательную версию, одно важное ограничение, влияющее на решение, состоит в отсутствии критических изменений либо для ввода контрактов, либо для поведения.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-130">**No breaking changes** Because this functionality is being added in a minor release, one important constraint impacting the solution is that there be no breaking changes, either to type contracts or to behavior.</span></span> <span data-ttu-id="ddb7c-131">Это ограничение потребовало некоторой очистки, которую мы хотели бы сделать с точки зрения существующих блоков catch, переключив исключения в ответы 500.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-131">This constraint ruled out some cleanup we would like to have done in terms of existing catch blocks turning exceptions into 500 responses.</span></span> <span data-ttu-id="ddb7c-132">Эта дополнительная очистка — это то, что мы можем рассмотреть для последующих основных выпусков.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-132">This additional cleanup is something we might consider for a subsequent major release.</span></span> <span data-ttu-id="ddb7c-133">Если это важно, проголосуйте по адресу [веб-API ASP.NET пользовательским голосом](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-133">If this is important to you please vote on it at [ASP.NET Web API user voice](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span></span>
2. <span data-ttu-id="ddb7c-134">**Поддержание согласованности с конструкциями веб-API** Конвейер фильтров веб-API — это отличный способ обработки перекрестных задач с гибкостью применения логики к конкретной или глобальной области, относящейся к конкретному действию или конкретному контроллеру.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-134">**Maintaining consistency with Web API constructs** Web API's filter pipeline is a great way to handle cross-cutting concerns with the flexibility of applying the logic at an action-specific, controller-specific or global scope.</span></span> <span data-ttu-id="ddb7c-135">Фильтры, включая фильтры исключений, всегда имеют контексты действий и контроллеров, даже если они зарегистрированы в глобальной области.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-135">Filters, including exception filters, always have action and controller contexts, even when registered at the global scope.</span></span> <span data-ttu-id="ddb7c-136">Этот контракт имеет смысл для фильтров, но это означает, что фильтры исключений, даже глобальные, не подходят для некоторых случаев обработки исключений, таких как исключения обработчиков сообщений, где не существует действия или контекста контроллера.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-136">That contract makes sense for filters, but it means that exception filters, even globally scoped ones, aren't a good fit for some exception handling cases, such as exceptions from message handlers, where no action or controller context exists.</span></span> <span data-ttu-id="ddb7c-137">Если мы хотим использовать гибкую область действия, обеспечиваемую фильтрами для обработки исключений, нам по-прежнему нужны фильтры исключений.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-137">If we want to use the flexible scoping afforded by filters for exception handling, we still need exception filters.</span></span> <span data-ttu-id="ddb7c-138">Но если нам нужно обрабатывать исключение вне контекста контроллера, нам также потребуется отдельная конструкция для полной глобальной обработки ошибок (что не имеет ограничений контекста контроллера и контекста действия).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-138">But if we need to handle exception outside of a controller context, we also need a separate construct for full global error handling (something without the controller context and action context constraints).</span></span>

### <a name="when-to-use"></a><span data-ttu-id="ddb7c-139">Назначение</span><span class="sxs-lookup"><span data-stu-id="ddb7c-139">When to Use</span></span>

- <span data-ttu-id="ddb7c-140">Средства ведения журнала исключений — это решение для просмотра всех необработанных исключений, перехваченных веб-API.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-140">Exception loggers are the solution to seeing all unhandled exception caught by Web API.</span></span>
- <span data-ttu-id="ddb7c-141">Обработчики исключений — это решение для настройки всех возможных ответов на необработанные исключения, перехваченные веб-API.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-141">Exception handlers are the solution for customizing all possible responses to unhandled exceptions caught by Web API.</span></span>
- <span data-ttu-id="ddb7c-142">Фильтры исключений являются самым простым решением для обработки необработанных исключений подмножества, связанных с определенным действием или контроллером.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-142">Exception filters are the easiest solution for processing the subset unhandled exceptions related to a specific action or controller.</span></span>

### <a name="service-details"></a><span data-ttu-id="ddb7c-143">Service Details</span><span class="sxs-lookup"><span data-stu-id="ddb7c-143">Service Details</span></span>

 <span data-ttu-id="ddb7c-144">Интерфейсы средства ведения журнала исключений и службы обработчиков — это простые асинхронные методы, принимающие соответствующие контексты:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-144">The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span></span> 

[!code-csharp[Main](web-api-global-error-handling/samples/sample2.cs)]

 <span data-ttu-id="ddb7c-145">Мы также предоставляем базовые классы для обоих интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-145">We also provide base classes for both of these interfaces.</span></span> <span data-ttu-id="ddb7c-146">Переопределение основных методов (Sync или Async) — это все, что требуется для регистрации или работы в рекомендуемом времени.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-146">Overriding the core (sync or async) methods is all that is required to log or handle at the recommended times.</span></span> <span data-ttu-id="ddb7c-147">Для ведения журнала базовый класс `ExceptionLogger` гарантирует, что основной метод ведения журнала вызывается только один раз для каждого исключения (даже если позже он передается дальше по стеку вызовов и снова перехватывается).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-147">For logging, the `ExceptionLogger` base class will ensure that the core logging method is only called once for each exception (even if it later propagates further up the call stack and is caught again).</span></span> <span data-ttu-id="ddb7c-148">Базовый класс `ExceptionHandler` будет вызывать основной метод обработки только для исключений в верхней части стека вызовов, игнорируя устаревшие вложенные блоки catch.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-148">The `ExceptionHandler` base class will call the core handling method only for exceptions at the top of the call stack, ignoring legacy nested catch blocks.</span></span> <span data-ttu-id="ddb7c-149">(Упрощенные версии этих базовых классов приведены в приложении ниже.) И `IExceptionLogger`, и `IExceptionHandler` получают сведения об исключении через `ExceptionContext`.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-149">(Simplified versions of these base classes are in the appendix below.) Both `IExceptionLogger` and `IExceptionHandler` receive information about the exception via an `ExceptionContext`.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample3.cs)]

<span data-ttu-id="ddb7c-150">Когда платформа вызывает средство ведения журнала исключений или обработчик исключений, всегда будет предоставляться `Exception` и `Request`.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-150">When the framework calls an exception logger or an exception handler, it will always provide an `Exception` and a `Request`.</span></span> <span data-ttu-id="ddb7c-151">За исключением модульного тестирования, также всегда будет предоставляться `RequestContext`.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-151">Except for unit testing, it will also always provide a `RequestContext`.</span></span> <span data-ttu-id="ddb7c-152">Он редко предоставляет `ControllerContext` и `ActionContext` (только при вызове из блока catch для фильтров исключений).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-152">It will rarely provide a `ControllerContext` and `ActionContext` (only when calling from the catch block for exception filters).</span></span> <span data-ttu-id="ddb7c-153">Он очень редко предоставляет `Response`(только в определенных случаях IIS, когда в ходе попытки записи ответа).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-153">It will very rarely provide a `Response`(only in certain IIS cases when in the middle of trying to write the response).</span></span> <span data-ttu-id="ddb7c-154">Обратите внимание, что, так как некоторые из этих свойств могут быть `null`, пользователь должен проверить наличие `null` перед доступом к членам класса Exception.`CatchBlock`</span><span class="sxs-lookup"><span data-stu-id="ddb7c-154">Note that because some of these properties may be `null` it is up to the consumer to check for `null` before accessing members of the exception class.`CatchBlock`</span></span> <span data-ttu-id="ddb7c-155">Строка, указывающая, какой блок catch обнаружил исключение.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-155">is a string indicating which catch block saw the exception.</span></span> <span data-ttu-id="ddb7c-156">Ниже приведены строки блока catch.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-156">The catch block strings are as follows:</span></span>

- <span data-ttu-id="ddb7c-157">HttpServer (метод SendAsync)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-157">HttpServer (SendAsync method)</span></span>
- <span data-ttu-id="ddb7c-158">Хттпконтроллердиспатчер (метод SendAsync)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-158">HttpControllerDispatcher (SendAsync method)</span></span>
- <span data-ttu-id="ddb7c-159">Хттпбатчхандлер (метод SendAsync)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-159">HttpBatchHandler (SendAsync method)</span></span>
- <span data-ttu-id="ddb7c-160">Иексцептионфилтер (ApiController обработка конвейера фильтра исключений в ExecuteAsync)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-160">IExceptionFilter (ApiController's processing of the exception filter pipeline in ExecuteAsync)</span></span>
- <span data-ttu-id="ddb7c-161">Узел OWIN:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-161">OWIN host:</span></span>

    - <span data-ttu-id="ddb7c-162">HttpMessageHandlerAdapter. Буфферреспонсеконтентасинк (для буферизации выходных данных)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-162">HttpMessageHandlerAdapter.BufferResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="ddb7c-163">HttpMessageHandlerAdapter. Копиреспонсеконтентасинк (для потокового вывода)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-163">HttpMessageHandlerAdapter.CopyResponseContentAsync (for streaming output)</span></span>
- <span data-ttu-id="ddb7c-164">Веб-узел:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-164">Web host:</span></span>

    - <span data-ttu-id="ddb7c-165">HttpControllerHandler. WriteBufferedResponseContentAsync (для буферизации выходных данных)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-165">HttpControllerHandler.WriteBufferedResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="ddb7c-166">HttpControllerHandler. Вритестреамедреспонсеконтентасинк (для потокового вывода)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-166">HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span></span>
    - <span data-ttu-id="ddb7c-167">HttpControllerHandler. Вритиррорреспонсеконтентасинк (для сбоев при восстановлении после ошибок в режиме буферизации вывода)</span><span class="sxs-lookup"><span data-stu-id="ddb7c-167">HttpControllerHandler.WriteErrorResponseContentAsync (for failures in error recovery under buffered output mode)</span></span>

<span data-ttu-id="ddb7c-168">Список строк блока catch также доступен через статические свойства ReadOnly.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-168">The list of catch block strings is also available via static readonly properties.</span></span> <span data-ttu-id="ddb7c-169">(Основная строка блока catch находится на статическом ExceptionCatchBlocks; остаток отображается по одному статическому классу для OWIN и веб-узла).`IsTopLevelCatchBlock`</span><span class="sxs-lookup"><span data-stu-id="ddb7c-169">(The core catch block string are on the static ExceptionCatchBlocks; the remainder appear on one static class each for OWIN and web host).`IsTopLevelCatchBlock`</span></span> <span data-ttu-id="ddb7c-170">рекомендуется использовать для поддержки рекомендуемого шаблона обработки исключений только в верхней части стека вызовов.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-170">is helpful for following the recommended pattern of handling exceptions only at the top of the call stack.</span></span> <span data-ttu-id="ddb7c-171">Вместо того чтобы включать исключения в ответы 500 в любом месте во вложенном блоке catch, обработчик исключений может разрешить распространение исключений до тех пор, пока они не будут видны узлу.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-171">Rather than turning exceptions into 500 responses anywhere a nested catch block occurs, an exception handler can let exceptions propagate until they are about to be seen by the host.</span></span>

<span data-ttu-id="ddb7c-172">Помимо `ExceptionContext`, средство ведения журнала получает еще один фрагмент информации с помощью полной `ExceptionLoggerContext`:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-172">In addition to the `ExceptionContext`, a logger gets one more piece of information via the full `ExceptionLoggerContext`:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample4.cs)]

<span data-ttu-id="ddb7c-173">Второе свойство, `CanBeHandled`, позволяет средству ведения журнала определять исключение, которое не может быть обработано.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-173">The second property, `CanBeHandled`, allows a logger to identify an exception that cannot be handled.</span></span> <span data-ttu-id="ddb7c-174">Если соединение скоро будет прервано и не удается отправить новое ответное сообщение, то средства ведения журнала будут вызываться, но обработчик ***не*** будет вызываться, и средства ведения журнала смогут опознать этот сценарий из этого свойства.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-174">When the connection is about to be aborted and no new response message can be sent, the loggers will be called but the handler will ***not*** be called, and the loggers can identify this scenario from this property.</span></span>

<span data-ttu-id="ddb7c-175">В дополнительных `ExceptionContext`обработчик получает еще одно свойство, которое может быть задано для полной `ExceptionHandlerContext` для обработки исключения:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-175">In additional to the `ExceptionContext`, a handler gets one more property it can set on the full `ExceptionHandlerContext` to handle the exception:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample5.cs)]

<span data-ttu-id="ddb7c-176">Обработчик исключений указывает, что он обработал исключение, присвоив свойству `Result` результат действия (например, [ексцептионресулт](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [интерналсервереррорресулт](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [статускодересулт](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx)или пользовательский результат).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-176">An exception handler indicates that it has handled an exception by setting the `Result` property to an action result (for example, an [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), or a custom result).</span></span> <span data-ttu-id="ddb7c-177">Если свойство `Result` имеет значение null, исключение не обработано, и исходное исключение будет создано повторно.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-177">If the `Result` property is null, the exception is unhandled and the original exception will be re-thrown.</span></span>

<span data-ttu-id="ddb7c-178">Для исключений в верхней части стека вызовов мы заняли дополнительный шаг, чтобы убедиться, что ответ подходит для вызывающих объектов API.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-178">For exceptions at the top of the call stack, we took an extra step to ensure the response is appropriate for API callers.</span></span> <span data-ttu-id="ddb7c-179">Если исключение распространяется на узел, вызывающий объект увидит желтый экран смерти или другой ответ, предоставленный ведущим узлом, который обычно является HTML, и не является, как правило, соответствующим ответом на ошибку API.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-179">If the exception propagates up to the host, the caller would see the yellow screen of death or some other host provided response which is typically HTML and not usually an appropriate API error response.</span></span> <span data-ttu-id="ddb7c-180">В этих случаях результат начинается со значения, отличного от NULL, и только в том случае, если пользовательский обработчик исключений явно задает для него значение `null` (не обработано). это приведет к распространению исключения на узел.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-180">In these cases, the Result starts out non-null, and only if a custom exception handler explicitly sets it back to `null` (unhandled) will the exception propagate to the host.</span></span> <span data-ttu-id="ddb7c-181">Установка `Result` в `null` в таких случаях может оказаться полезной в двух сценариях:</span><span class="sxs-lookup"><span data-stu-id="ddb7c-181">Setting `Result` to `null` in such cases can be useful for two scenarios:</span></span>

1. <span data-ttu-id="ddb7c-182">OWIN размещенный веб-API с настраиваемой обработки исключений по промежуточного слоя, зарегистрированный до или вне веб-API.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-182">OWIN hosted Web API with custom exception handling middleware registered before/outside Web API.</span></span>
2. <span data-ttu-id="ddb7c-183">Локальная отладка через браузер, где желтый экран смерти фактически является полезным ответом для необработанного исключения.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-183">Local debugging via a browser, where the yellow screen of death is actually a helpful response for an unhandled exception.</span></span>

<span data-ttu-id="ddb7c-184">Для средств ведения журнала исключений и обработчиков исключений мы не делаем никаких действий для восстановления, если само средство ведения журнала или обработчик создает исключение.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-184">For both exception loggers and exception handlers, we don't do anything to recover if the logger or handler itself throws an exception.</span></span> <span data-ttu-id="ddb7c-185">(Кроме распространения исключения, оставьте отзыв в нижней части этой страницы, если у вас есть лучший подход.) Контракт для средств ведения журнала исключений и обработчиков заключается в том, что они не должны допустить распространение исключений на вызывающие объекты. в противном случае исключение просто будет распространено, как правило, в результате ошибки HTML (например, ASP). Желтый экран в сети) отправляется обратно клиенту (что обычно не является предпочтительным вариантом для вызывающих объектов API, которые предполагают формат JSON или XML).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-185">(Other than letting the exception propagate, leave feedback at the bottom of this page if you have a better approach.) The contract for exception loggers and handlers is that they should not let exceptions propagate up to their callers; otherwise, the exception will just propagate, often all the way to the host resulting in an HTML error (like the ASP.NET's yellow screen) being sent back to the client (which usually isn't the preferred option for API callers that expect JSON or XML).</span></span>

## <a name="examples"></a><span data-ttu-id="ddb7c-186">Примеры</span><span class="sxs-lookup"><span data-stu-id="ddb7c-186">Examples</span></span>

### <a name="tracing-exception-logger"></a><span data-ttu-id="ddb7c-187">Трассировка средства ведения журнала исключений</span><span class="sxs-lookup"><span data-stu-id="ddb7c-187">Tracing Exception Logger</span></span>

<span data-ttu-id="ddb7c-188">В средстве ведения журнала исключений ниже отправляются данные исключений в настроенные источники трассировки (включая окно выходных данных отладки в Visual Studio).</span><span class="sxs-lookup"><span data-stu-id="ddb7c-188">The exception logger below send exception data to configured Trace sources (including the Debug output window in Visual Studio).</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample6.cs)]

### <a name="custom-error-message-exception-handler"></a><span data-ttu-id="ddb7c-189">Обработчик исключений настраиваемых сообщений об ошибках</span><span class="sxs-lookup"><span data-stu-id="ddb7c-189">Custom Error Message Exception Handler</span></span>

<span data-ttu-id="ddb7c-190">Следующий пример приводит к возникновению настраиваемого ответа об ошибке клиентам, включая адрес электронной почты для обращения в службу поддержки.</span><span class="sxs-lookup"><span data-stu-id="ddb7c-190">The following below produces a custom error response to clients, including an email address for contacting support.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample7.cs)]

## <a name="registering-exception-filters"></a><span data-ttu-id="ddb7c-191">Регистрация фильтров исключений</span><span class="sxs-lookup"><span data-stu-id="ddb7c-191">Registering Exception Filters</span></span>

<span data-ttu-id="ddb7c-192">Если вы используете шаблон проекта "веб-приложение ASP.NET MVC 4" для создания проекта, разместите код конфигурации веб-API в классе `WebApiConfig` в папке *app/_Start* :</span><span class="sxs-lookup"><span data-stu-id="ddb7c-192">If you use the "ASP.NET MVC 4 Web Application" project template to create your project, put your Web API configuration code inside the `WebApiConfig` class, in the *App/_Start* folder:</span></span>

[!code-csharp[Main](exception-handling/samples/sample7.cs?highlight=5)]

## <a name="appendix-base-class-details"></a><span data-ttu-id="ddb7c-193">Приложение. сведения о базовом классе</span><span class="sxs-lookup"><span data-stu-id="ddb7c-193">Appendix: Base Class Details</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample8.cs)]
