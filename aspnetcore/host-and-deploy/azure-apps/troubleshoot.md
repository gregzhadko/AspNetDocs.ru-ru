---
title: Устранение неполадок ASP.NET Core в службе приложений Azure
author: guardrex
description: Сведения о диагностике проблем с развертываниями ASP.NET Core в службе приложений Azure.
ms.author: riande
ms.custom: mvc
ms.date: 01/11/2019
uid: host-and-deploy/azure-apps/troubleshoot
ms.openlocfilehash: 65a5e355bc15db6de9060331395c441160c8b62d
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57040151"
---
# <a name="troubleshoot-aspnet-core-on-azure-app-service"></a>Устранение неполадок ASP.NET Core в службе приложений Azure

Автор [Люк Латэм](https://github.com/guardrex) (Luke Latham)

[!INCLUDE [Azure App Service Preview Notice](../../includes/azure-apps-preview-notice.md)]

Эта статья содержит инструкции по диагностике проблемы запуска приложения ASP.NET Core с помощью средств диагностики службы приложений Azure. Дополнительные советы по устранению неполадок см. в разделе [Общие сведения о диагностике службы приложений Azure](/azure/app-service/app-service-diagnostics) и [Практическое руководство. Мониторинг приложений в службе приложений Azure](/azure/app-service/web-sites-monitor) в документации по Azure.

## <a name="app-startup-errors"></a>Ошибки при запуске приложения

**502.5 — ошибка процесса**  
Рабочий процесс завершается ошибкой. Приложение не запускается.

[Модуль ASP.NET Core](xref:host-and-deploy/aspnet-core-module) пытается запустить рабочий процесс, но он не запускается. Изучение журнала событий приложения часто помогает устранить проблемы такого типа. Доступ к журналу описан в разделе [Журнал событий приложения](#application-event-log).

Когда неправильно сконфигурированное приложение приводит к сбою рабочего процесса, возвращается страница ошибки *502.5 — ошибка процесса*.

![Окно браузера, показывающее страницу "502.5 — ошибка процесса"](troubleshoot/_static/process-failure-page.png)

**500 — внутренняя ошибка сервера**  
Приложение запускается, но ошибка не позволяет серверу выполнить запрос.

Эта ошибка возникает в коде приложения при запуске или при создании ответа. Ответ может не иметь содержимого или ответ в браузере может выглядеть как *500 — внутренняя ошибка сервера*. Как правило, в журнале событий приложения указывается, что приложение запускается в обычном режиме. Сервер действует правильно. Приложение запустилось, но оно не может генерировать действительный ответ. Чтобы устранить проблему, [запустите приложение в консоли Kudu](#run-the-app-in-the-kudu-console) или [включите журнал модуля stdout ASP.NET Core](#aspnet-core-module-stdout-log).

**Сброс подключения**

Если ошибка возникает после отправки заголовков, сервер уже не может отправить страницу **500 — внутренняя ошибка сервера**. Это часто происходит, когда ошибка возникает во время сериализации составных объектов ответа. Этот тип ошибки отображается на стороне клиента как ошибка *Сброс подключения*. [Ведение журналов для приложений](xref:fundamentals/logging/index) может помочь устранить эти ошибки.

## <a name="default-startup-limits"></a>Ограничения по умолчанию при запуске

Параметру *startupTimeLimit* модуля ASP.NET Core установлено значение по умолчанию 120 секунд. Если оставить значение по умолчанию, то прежде чем журнал модуля зарегистрирует ошибку запуска приложения, может пройти до двух минут. Сведения о настройке модуля см. в разделе [Атрибуты элемента aspNetCore](xref:host-and-deploy/aspnet-core-module#attributes-of-the-aspnetcore-element).

## <a name="troubleshoot-app-startup-errors"></a>Устранение неполадок при запуске приложения

### <a name="application-event-log"></a>Журнал событий приложений

Чтобы получить доступ к журналу событий приложения, используйте колонку **Диагностика и решение проблем** на портале Azure.

1. На портале Azure откройте приложение в колонке **Службы приложений**.
1. Выберите колонку **Диагностика и решение проблем**.
1. Щелкните заголовок **Средства диагностики**.
1. В разделе **Средства поддержки** нажмите кнопку **События приложений**.
1. Изучите последние ошибки из журнала *IIS AspNetCoreModule* или *IIS AspNetCoreModule V2* в столбце **Источник**.

Вместо использования колонки **Диагностика и решение проблем** можно изучить файл журнала событий приложения непосредственно с помощью консоли [Kudu](https://github.com/projectkudu/kudu/wiki).

1. В области **Средства разработки** откройте колонку **Дополнительные инструменты**. Нажмите кнопку **Перейти&rarr;**. Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Откройте папку **LogFiles**.
1. Выберите значок с карандашом рядом с файлом *eventlog.xml*.
1. Изучите журнал. Прокрутите список до нижней части журнала, чтобы просмотреть последние события.

### <a name="run-the-app-in-the-kudu-console"></a>Запуск приложения в консоли Kudu

Многие ошибки запуска не создают полезные сведения в журнале событий приложения. Чтобы обнаружить ошибку, можно запустить приложение в удаленной консоли выполнения [Kudu](https://github.com/projectkudu/kudu/wiki).

1. В области **Средства разработки** откройте колонку **Дополнительные инструменты**. Нажмите кнопку **Перейти&rarr;**. Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Откройте папки на пути **веб-сайт** > **wwwroot**.
1. Выполнив сборку приложения, запустите его в консоли.
   * Если приложение является [зависящим от платформы развертывания](/dotnet/core/deploying/#framework-dependent-deployments-fdd), запустите сборку приложения с помощью *dotnet.exe*. В следующей команде замените имя сборки приложения с `<assembly_name>` на `dotnet .\<assembly_name>.dll`
   * Если приложение является [автономным развертыванием](/dotnet/core/deploying/#self-contained-deployments-scd), запустите исполняемый файл приложения. В следующей команде замените имя сборки приложения с `<assembly_name>` на `<assembly_name>.exe`
1. Выходные данные из приложения, отображающие любые ошибки, будут выведены на консоль Kudu.

### <a name="aspnet-core-module-stdout-log"></a>Журнал stdout модуля ASP.NET Core

В журнале stdout модуля ASP.NET Core часто записываются полезные сообщения, которые не удается найти в журнале событий приложения. Чтобы включить и просмотреть журналы stdout выполните следующие действия.

1. Перейдите к колонке **Диагностика и решение проблем** на портале Azure.
1. В разделе **Выберите категорию проблемы** нажмите кнопку **Веб-приложение не работает**.
1. В разделе **Предлагаемые решения** > **Включить перенаправление журнала stdout** нажмите кнопку **Открыть консоль Kudu для редактирования файла Web.Config**.
1. В **консоли диагностики** Kudu откройте папки на пути **веб-сайт** > **wwwroot**. Прокрутите список вниз, чтобы в его нижней части показался файл *web.config*.
1. Щелкните значок карандаша рядом с файлом *web.config*.
1. Установите для параметра **stdoutLogEnabled** значение `true` и измените путь **stdoutLogFile** на `\\?\%home%\LogFiles\stdout`.
1. Выберите **Сохранить** для сохранения обновленного файла *web.config*.
1. Сделайте запрос к приложению.
1. Вернитесь на портал Azure. Выберите колонку **Дополнительные инструменты** в области **Средства разработки**. Нажмите кнопку **Перейти&rarr;**. Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Выберите папку **LogFiles**.
1. Изучите столбец **Изменено** и выберите значок карандаша, чтобы отредактировать журнал stdout для последней даты изменения.
1. При открытии файла журнала отображается сообщение об ошибке.

Завершив устранение неполадок, отключите ведение журнала stdout.

1. В **консоли диагностики** Kudu вернитесь к пути **веб-сайт** > **wwwroot**, чтобы открыть файл *web.config*. Выбрав значок карандаша, снова откройте файл **web.config**.
1. Задайте параметру **stdoutLogEnabled** значение `false`.
1. Нажмите кнопку **Сохранить** для сохранения файла.

> [!WARNING]
> Ошибка при отключении журнала stdout может привести к сбоям приложения или сервера. Ни размер файла журнала, ни количество создаваемых файлов журналов ничем не ограничены. Для устранения неполадок при запуске приложения используйте только журнал stdout.
>
> После запуска в приложении ASP.NET Core для ведения общего журнала используйте библиотеку ведения журналов, которая ограничивает размер файла журнала и выполняет циклический сдвиг журналов. Дополнительные сведения см. в разделе [Сторонние поставщики ведения журналов](xref:fundamentals/logging/index#third-party-logging-providers).

::: moniker range=">= aspnetcore-2.2"

### <a name="aspnet-core-module-debug-log"></a>Журнал отладки модуля ASP.NET Core

В журнал отладки модуля ASP.NET записываются дополнительные и более подробные сообщения, относящиеся к модулю ASP.NET Core. Чтобы включить и просмотреть журналы stdout, сделайте следующее:

1. Чтобы включить ведение расширенного журнала диагностики, выполните одно из следующих действий.
   * Следуйте инструкциям по настройке приложения для ведения расширенных журналов диагностики, приведенным в разделе [Расширенные журналы диагностики](xref:host-and-deploy/aspnet-core-module#enhanced-diagnostic-logs). Повторно разверните приложение.
   * С помощью консоли Kudu добавьте раздел `<handlerSettings>` в файл *web.config* приложения, как показано в разделе [Расширенные журналы диагностики](xref:host-and-deploy/aspnet-core-module#enhanced-diagnostic-logs).
     1. В области **Средства разработки** откройте колонку **Дополнительные инструменты**. Нажмите кнопку **Перейти&rarr;**. Консоль Kudu открывается в новой вкладке или в окне браузера.
     1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
     1. Откройте папки на пути **веб-сайт** > **wwwroot**. Нажмите кнопку с изображением карандаша и внесите изменения в файл *web.config*. Добавьте раздел `<handlerSettings>`, как описано в разделе [Расширенные журналы диагностики](xref:host-and-deploy/aspnet-core-module#enhanced-diagnostic-logs). Нажмите кнопку **Сохранить**.
1. В области **Средства разработки** откройте колонку **Дополнительные инструменты**. Нажмите кнопку **Перейти&rarr;**. Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Откройте папки на пути **веб-сайт** > **wwwroot**. Если вы не указали путь к файлу *aspnetcore-debug.log*, файл появится в списке. Если путь указан, перейдите к расположению файла журнала.
1. Откройте файл журнала, нажав кнопку с изображением карандаша рядом с именем файла.

Завершив устранение неполадок, отключите ведение журнала отладки.

1. Чтобы отключить ведение расширенных журналов отладки, выполните одно из следующих действий.
   * Удалите раздел `<handlerSettings>` из файла *web.config* локально и повторно разверните приложение.
   * С помощью консоли Kudu внесите изменения в файл *web.config* и удалите раздел `<handlerSettings>`. Сохраните файл.

> [!WARNING]
> Ошибка при отключении журнала отладки может привести к сбоям приложения или сервера. Ограничения на размер файла журнала отсутствуют. Для устранения неполадок при запуске приложения используйте только журнал отладки.
>
> После запуска в приложении ASP.NET Core для ведения общего журнала используйте библиотеку ведения журналов, которая ограничивает размер файла журнала и выполняет циклический сдвиг журналов. Дополнительные сведения см. в разделе [Сторонние поставщики ведения журналов](xref:fundamentals/logging/index#third-party-logging-providers).

::: moniker-end

## <a name="common-startup-errors"></a>Стандартные ошибки запуска

См. раздел <xref:host-and-deploy/azure-iis-errors-reference>. В этой статье рассматривается большинство распространенных ошибок, препятствующих запуску приложений.

## <a name="slow-or-hanging-app"></a>Медленное или зависающее приложение

Дополнительную информацию для случаев, когда приложение медленно реагирует или зависает при запросе, см. в разделе [Устранение проблем с медленными веб-приложениями в службе приложений Azure](/azure/app-service/app-service-web-troubleshoot-performance-degradation).

## <a name="remote-debugging"></a>Удаленная отладка

См. указанные ниже разделы.

* [Раздел "Веб-приложения удаленной отладки" раздела "Устранение неполадок веб-приложения в службе приложений Azure с помощью Visual Studio"](/azure/app-service/web-sites-dotnet-troubleshoot-visual-studio#remotedebug) (Документация по Azure)
* [Удаленная отладка ASP.NET Core для служб IIS в Azure с помощью Visual Studio 2017](/visualstudio/debugger/remote-debugging-azure) (документация по Visual Studio)

## <a name="application-insights"></a>Application Insights

[Application Insights](https://azure.microsoft.com/services/application-insights/) обеспечивает телеметрию из приложений, размещенных в службе приложений Azure, включая функции регистрации ошибок и отчетности. Application Insights может сообщать только об ошибках, возникающих после запуска приложения, когда становятся доступными функции ведения журнала приложения. Дополнительные сведения см. в статье [Application Insights для ASP.NET Core](/azure/application-insights/app-insights-asp-net-core).

## <a name="monitoring-blades"></a>Мониторинг колонок

Мониторинг колонок обеспечивает альтернативный поиск неисправностей методам, описанным ранее в этом разделе. Эти колонки можно использовать для диагностики ошибок 500-й серии.

Убедитесь, что установлены расширения ASP.NET Core. Если расширения не установлены, установите их вручную, выполнив следующие действия.

1. В колонке **Средства разработки** выберите колонку **Расширения**.
1. В списке должны появиться **Расширения ASP.NET Core**.
1. Если расширения не установлены, нажмите кнопку **Добавить**.
1. Выберите из списка **Расширения ASP.NET Core**.
1. Для принятия условий нажмите кнопку **ОК**.
1. Нажмите кнопку **ОК** в колонке **Добавить расширение**.
1. Информационное всплывающее сообщение указывает, когда расширения успешно установятся.

Если ведение журнала stdout не включено, выполните следующие действия.

1. На портале Azure выберите колонку **Дополнительные инструменты** в области **Средства разработки**. Нажмите кнопку **Перейти&rarr;**. Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Откройте папки на пути **веб-сайт** > **wwwroot** и прокрутите список вниз, пока в нижней части не покажется файл *web.config*.
1. Щелкните значок карандаша рядом с файлом *web.config*.
1. Установите для параметра **stdoutLogEnabled** значение `true` и измените путь **stdoutLogFile** на `\\?\%home%\LogFiles\stdout`.
1. Выберите **Сохранить** для сохранения обновленного файла *web.config*.

Перейдите к активации ведения журнала диагностики, выполнив следующие действия.

1. На портале Azure выберите колонку **Журналы диагностики**.
1. Выберите положение переключателя **Вкл.** для **Вход в приложения (файловая система)** и **Подробные сообщения об ошибках**. В верхней части колонки нажмите кнопку **Сохранить**.
1. Чтобы включить трассировку неудачно завершенных запросов, также известную как ведение журнала буферизации событий неудачных запросов (FREB), установите положение переключателя **Вкл.** для **Трассировки неудачно завершенных запросов**. 
1. На портале выберите колонку **Поток журнала**, которая в списке отображается сразу под колонкой **Журналы диагностики**.
1. Сделайте запрос к приложению.
1. В пределах данных потока журнала указывается причина ошибки.

После завершения устранения неполадок обязательно отключите ведение журнала stdout. См. инструкции в разделе [Журнал stdout модуля ASP.NET Core](#aspnet-core-module-stdout-log).

Чтобы просмотреть журналы трассировки неудачно завершенных запросов (журналы FREB), выполните следующие действия.

1. Перейдите к колонке **Диагностика и решение проблем** на портале Azure.
1. Выберите **Журналы трассировки неудачно завершенных запросов** из области боковой панели **Средства поддержки**.

Для получения дополнительной информации см. [Раздел "Трассировка неудачно завершенных запросов" раздела "Включение ведения журналов диагностики для веб-приложений в службе приложений Azure"](/azure/app-service/web-sites-enable-diagnostic-log#failed-request-traces) и ["Вопросы и ответы о производительности приложений для веб-приложений в Azure: как включить трассировку неудачно завершенных запросов?"](/azure/app-service/app-service-web-availability-performance-application-issues-faq#how-do-i-turn-on-failed-request-tracing)

Дополнительные сведения см. в разделе [Включение функции ведения журналов диагностики для веб-приложений в службе приложений Azure](/azure/app-service/web-sites-enable-diagnostic-log).

> [!WARNING]
> Ошибка при отключении журнала stdout может привести к сбоям приложения или сервера. Ни размер файла журнала, ни количество создаваемых файлов журналов ничем не ограничены.
>
> Для обычного ведения журналов для приложения ASP.NET Core используйте библиотеку, которая ограничивает размер файла журнала и выполняет циклический сдвиг журналов. Дополнительные сведения см. в разделе [Сторонние поставщики ведения журналов](xref:fundamentals/logging/index#third-party-logging-providers).

## <a name="additional-resources"></a>Дополнительные ресурсы

* <xref:fundamentals/error-handling>
* <xref:host-and-deploy/azure-iis-errors-reference>
* [Устранение неполадок веб-приложения в службе приложений Azure с помощью Visual Studio](/azure/app-service/web-sites-dotnet-troubleshoot-visual-studio)
* [Устранение ошибок HTTP "502 — недопустимый шлюз" и "503 — служба недоступна" в веб-приложениях Azure](/azure/app-service/app-service-web-troubleshoot-http-502-http-503)
* [Устранение проблем с производительностью медленных веб приложений в службе приложений Azure](/azure/app-service/app-service-web-troubleshoot-performance-degradation)
* [Вопросы и ответы о производительности приложений для веб-приложений в Azure](/azure/app-service/app-service-web-availability-performance-application-issues-faq)
* ["Песочница" веб-приложений Azure (ограничения работы среды выполнения службы приложений)](https://github.com/projectkudu/kudu/wiki/Azure-Web-App-sandbox)
* [Пятница с Azure. Практика диагностики и устранения неполадок в Службе приложений Azure (12-минутное видео)](https://channel9.msdn.com/Shows/Azure-Friday/Azure-App-Service-Diagnostic-and-Troubleshooting-Experience)
