---
title: ПО промежуточного слоя для переопределения URL-адресов в ASP.NET Core
author: guardrex
description: Сведения о переопределении и перенаправлении URL-адресов с помощью ПО промежуточного слоя для переопределения URL-адресов в приложениях ASP.NET Core.
ms.author: riande
ms.custom: mvc
ms.date: 12/18/2018
uid: fundamentals/url-rewriting
ms.openlocfilehash: d2dd5e9b7f196bcbd1940f7ef58331dabd2367a1
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57064331"
---
# <a name="url-rewriting-middleware-in-aspnet-core"></a>ПО промежуточного слоя для переопределения URL-адресов в ASP.NET Core

Авторы: [Люк Лэтем](https://github.com/guardrex) (Luke Latham) и [Микаэль Менгисту](https://github.com/mikaelm12) (Mikael Mengistu)

::: moniker range="<= aspnetcore-1.1"

Для версии 1.1 этого раздела скачайте статью [ПО промежуточного слоя для переопределения URL-адресов в ASP.NET Core (версия 1.1, PDF-файл)](https://webpifeed.blob.core.windows.net/webpifeed/Partners/URL_Rewriting_1.1.pdf).

::: moniker-end

Этот документ содержит вводные сведения о переопределении URL-адресов и инструкции по использованию ПО промежуточного слоя для переопределения URL-адресов в приложениях ASP.NET Core.

Переопределение URL-адресов представляет собой изменение URL-адресов запросов на основе одного или нескольких предопределенных правил. Переопределение URL-адресов создает абстракцию между расположениями ресурсов и их адресами, позволяя убрать тесную связь между ними. Существует несколько сценариев, где может пригодиться переопределение URL-адресов:

* Временное или постоянное перемещение или замещение ресурсов сервера с сохранением стабильных указателей для этих ресурсов.
* Разделение обработки запросов между разными приложениями или разными областями одного приложения.
* Удаление, добавление или переупорядочение сегментов URL-адресов для входящих запросов.
* Оптимизация общедоступных URL-адресов в целях оптимизации для поисковых систем (SEO).
* Разрешение использования понятных общедоступных URL-адресов, чтобы помочь посетителям прогнозировать содержимое, возвращаемое в результате запроса ресурса.
* Перенаправление небезопасных запросов на защищенные конечные точки.
* Запрет вставки прямых ссылок, когда внешний сайт использует статический ресурс, размещенный на другом сайте, привязывая ресурс к своему содержимому.

> [!NOTE]
> Переопределение URL-адресов может снижать производительность приложения. Следует по возможности ограничить число и сложность правил.

[Просмотреть или скачать образец кода](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/url-rewriting/samples/) ([как скачивать](xref:index#how-to-download-a-sample))

## <a name="url-redirect-and-url-rewrite"></a>Перенаправление и переопределение URL-адресов

Разница между *перенаправлением* и *переопределением* URL-адресов может показаться незначительной, но она оказывает существенное влияние на предоставление ресурсов клиентам. ПО промежуточного слоя для переопределения URL-адресов в ASP.NET Core удовлетворяет потребность в обеих этих функциях.

*Перенаправление URL-адресов* является операцией на стороне клиента, которая предписывает клиенту обратиться к ресурсу по другому адресу, отличному от запрошенного клиентом. Для этого используется круговое обращение к серверу. URL-адрес перенаправления, возвращаемый клиенту, отображается в адресной строке браузера, когда клиент отправляет новый запрос для данного ресурса.

Если `/resource` *перенаправляется* на `/different-resource`, сервер отвечает, что клиенту следует получить ресурс в `/different-resource` с кодом состояния, указывающим, что такое перенаправление является временным или постоянным.

![Конечная точка службы WebAPI временно изменена с версии 1 (v1) на версию 2 (v2) на сервере. Клиент выполняет запрос к службе по пути версии 1 (/v1/api). Сервер отправляет отклик "302 (найдено)" с новым временным путем для службы в версии 2 (/v2/api). Клиент выполняет второй запрос к службе по URL-адресу перенаправления. Сервер отвечает кодом состояния "200 (ОК)".](url-rewriting/_static/url_redirect.png)

При перенаправлении запросов на другой URL-адрес можно указать, является ли оно постоянным или временным, предоставив код состояния в ответе:

* Код состояния *301 (перемещен окончательно)* используется, когда ресурс имеет новый постоянный URL-адрес и вы хотите сообщить клиенту, что все последующие запросы для этого ресурса должны использовать новый URL-адрес. *Клиент может кэшировать и повторно использовать отклик при получении кода состояния 301.*

* Код состояния *302 (найдено)* используется, когда перенаправление является временным или может меняться. Код состояния 302 указывает клиенту, что не нужно сохранять URL-адрес и использовать его в будущем.

Дополнительные сведения о кодах состояния см. в документе [RFC 2616: определения кодов состояния](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html).

*Переопределение URL-адреса* является операцией на стороне сервера для предоставления ресурса с другого адреса ресурса, отличного от запрошенного клиентом. Переопределение URL-адреса не требует кругового обращения к серверу. Переопределенный URL-адрес не возвращается клиенту и не отображается в адресной строке браузера.

Когда `/resource` *переопределяется* на `/different-resource`, сервер получает и запрашивает ресурс *внутри* в `/different-resource`.

Хотя клиент может быть в состоянии получить ресурс по переопределенному URL-адресу, когда клиент отправляет запрос и получает отклик, он не уведомляется о наличии ресурса по переопределенному URL-адресу.

![Конечная точка службы WebAPI была изменена с версии 1 (v1) на версию 2 (v2) на сервере. Клиент выполняет запрос к службе по пути версии 1 (/v1/api). URL-адрес запроса переопределяется для обращения к службе по пути версии 2 (/v2/api). Служба отвечает клиенту кодом состояния "200 (ОК)".](url-rewriting/_static/url_rewrite.png)

## <a name="url-rewriting-sample-app"></a>Пример приложения с переопределением URL-адресов

Вы можете ознакомиться с функциями ПО промежуточного слоя переопределения URL-адресов на [примере приложения](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/url-rewriting/samples/). Это приложение применяет правила перенаправления и переопределения и показывает перенаправленный или переопределенный URL-адрес для нескольких сценариев.

## <a name="when-to-use-url-rewriting-middleware"></a>Условия для использования ПО промежуточного слоя для переопределения URL-адресов

Используйте ПО промежуточного слоя для переопределения URL-адресов, если невозможно использовать следующие подходы:

* [Модуль переопределения URL-адресов со службами IIS на Windows Server](https://www.iis.net/downloads/microsoft/url-rewrite)
* [Модуль Apache mod_rewrite на сервере Apache Server](https://httpd.apache.org/docs/2.4/rewrite/)
* [Переопределение URL-адресов в Nginx](https://www.nginx.com/blog/creating-nginx-rewrite-rules/)

Кроме того, используйте ПО промежуточного слоя, когда приложение размещается на [сервере HTTP.sys](xref:fundamentals/servers/httpsys) (который раньше назывался WebListener).

Основные причины для использования переопределения URL-адресов на основе сервера в IIS, Apache и Nginx:

* ПО промежуточного слоя не поддерживает все функции этих модулей.

  Некоторые функции серверных модулей не работают с проектами ASP.NET Core, например ограничения `IsFile` и `IsDirectory` для модуля переопределения IIS. В этих случаях следует использовать ПО промежуточного слоя.
* Производительность ПО промежуточного слоя, скорее всего, не соответствует производительности модулей.

  Тестирование производительности — это единственный способ узнать точно, какой подход больше всего снижает производительность или является ли такое снижение незначительным.

## <a name="package"></a>Пакет

Чтобы включить ПО промежуточного слоя в проект, добавьте ссылки на пакет в [метапакет Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app) в файле проекта, который содержит пакет [Microsoft.AspNetCore.Rewrite](https://www.nuget.org/packages/Microsoft.AspNetCore.Rewrite).

Если метапакет `Microsoft.AspNetCore.App` не используется, добавьте ссылку на проект в пакет `Microsoft.AspNetCore.Rewrite`.

## <a name="extension-and-options"></a>Расширение и параметры

Задайте правила переопределения и перенаправления URL-адресов, создав экземпляр класса [RewriteOptions](xref:Microsoft.AspNetCore.Rewrite.RewriteOptions) для каждого правила с помощью методов расширения. Несколько правил можно объединить в цепочку в том порядке, в котором они должны обрабатываться. `RewriteOptions` передаются в ПО промежуточного слоя для переопределения URL-адресов по мере его добавления в конвейер запросов с помощью <xref:Microsoft.AspNetCore.Builder.RewriteBuilderExtensions.UseRewriter*>:

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1)]

### <a name="redirect-non-www-to-www"></a>Перенаправление не www на www

Три параметра разрешают приложению перенаправлять запросы, отличные от `www`, на `www`:

* <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWwwPermanent*> &ndash; Окончательно перенаправляет запрос в поддомен `www`, если запрос не является `www`. Перенаправляет с кодом состояния [Status308PermanentRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status308PermanentRedirect).

* <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToWww*> &ndash; Перенаправляет запрос в поддомен `www`, если входящий запрос не является `www`. Перенаправляет с кодом состояния [Status307TemporaryRedirect](xref:Microsoft.AspNetCore.Http.StatusCodes.Status307TemporaryRedirect). Перегрузка позволяет предоставить код состояния для ответа. Используйте поле класса <xref:Microsoft.AspNetCore.Http.StatusCodes> для назначения кода состояния.

### <a name="url-redirect"></a>Перенаправление URL-адресов

Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirect*> для перенаправления запросов. Первый параметр содержит регулярное выражение, соответствующее пути входящего URL-адреса. Второй параметр является строкой замены. Третий параметр (при его наличии) указывает код состояния. Если код состояния не задан, по умолчанию используется код *302 (найдено)*, указывающий, что ресурс временно перемещен или заменен.

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=9)]

В браузере с включенными средствами разработчика выполните запрос для примера приложения по пути `/redirect-rule/1234/5678`. Регулярное выражение соответствует пути запроса в `redirect-rule/(.*)`, и этот путь заменяется на `/redirected/1234/5678`. URL-адрес перенаправления отправляется обратно клиенту с кодом состояния *302 (найдено)*. Браузер выполняет новый запрос на URL-адрес перенаправления, отображаемый в адресной строке. Поскольку в примере приложения нет правил, соответствующих URL-адресу перенаправления:

* Второй запрос получает от приложения ответ *200 (ОК)*.
* Текст ответа показывает URL-адрес перенаправления.

При *перенаправлении* URL-адреса используется круговое обращение к серверу.

> [!WARNING]
> Соблюдайте осторожность при задании правил перенаправления. Они оцениваются для каждого запроса, отправляемого в приложение, даже после перенаправления. Можно легко случайно создать *бесконечный цикл перенаправлений*.

Исходный запрос: `/redirect-rule/1234/5678`

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect.png)

Часть выражения, заключенная в скобки, называется *группой записи*. Точка (`.`) в выражении означает *совпадение с любым символом*. Звездочка (`*`) означает *совпадение с предыдущим символом ноль или более раз*. Таким образом, два последних сегмента пути URL-адреса, `1234/5678`, перехватываются группой записи `(.*)`. Любое значение, указанное в URL-адресе запроса после `redirect-rule/`, перехватывается этой группой записи.

В строке замены группы записи внедряются с помощью знака доллара (`$`), за которым следует порядковый номер записи. Первое значение группы записи получается с помощью `$1`, второе — с помощью `$2`, после чего они продолжают по очереди использоваться для групп записи в регулярном выражении. В регулярном выражении правила перенаправления в примере приложения присутствует всего одна группа записи, поэтому в строку замены внедряется тоже одна строка — `$1`. Когда применяется правило, URL-адрес становится `/redirected/1234/5678`.

### <a name="url-redirect-to-a-secure-endpoint"></a>Перенаправление URL-адресов на защищенную конечную точку

Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttps*>, чтобы перенаправлять HTTP-запросы на тот же узел и путь с использованием протокола HTTPS. Если код состояния не указан, ПО промежуточного слоя по умолчанию использует значение *302 (найдено)*. Если порт не указан:

* ПО промежуточного слоя по умолчанию устанавливается на `null`.
* Схема меняется на `https` (протокол HTTPS), и клиент обращается к ресурсу через порт 443.

Этот пример показывает, как задать код состояния *301 (перемещен окончательно)* и изменить порт на 5001.

```csharp
public void Configure(IApplicationBuilder app)
{
    var options = new RewriteOptions()
        .AddRedirectToHttps(301, 5001);

    app.UseRewriter(options);
}
```

Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRedirectToHttpsPermanent*>, чтобы перенаправить небезопасные запросы на тот же узел и путь с использованием безопасного протокола HTTPS через порт 443. ПО промежуточного слоя задает код состояния *301 (перемещен окончательно)*.

```csharp
public void Configure(IApplicationBuilder app)
{
    var options = new RewriteOptions()
        .AddRedirectToHttpsPermanent();

    app.UseRewriter(options);
}
```

> [!NOTE]
> При перенаправлении на защищенную конечную точку без дополнительных правил перенаправления рекомендуется использовать ПО промежуточного слоя перенаправления на HTTPS. Дополнительные сведения см. в разделе [Обязательное использование HTTPS](xref:security/enforcing-ssl#require-https).

Пример приложения позволяет продемонстрировать использование `AddRedirectToHttps` или `AddRedirectToHttpsPermanent`. Добавьте этот метод расширения в `RewriteOptions`. Выполните небезопасный запрос к приложению по любому URL-адресу. Закройте предостережение системы безопасности о том, что самозаверяющий сертификат не является доверенным, или создайте исключение, чтобы сделать сертификат доверенным.

Исходный запрос с использованием `AddRedirectToHttps(301, 5001)`: `http://localhost:5000/secure`

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect_to_https.png)

Исходный запрос с использованием `AddRedirectToHttpsPermanent`: `http://localhost:5000/secure`

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_redirect_to_https_permanent.png)

### <a name="url-rewrite"></a>Переопределение URL-адресов

Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.AddRewrite*>, чтобы создать правило для переопределения URL-адресов. Первый параметр содержит регулярное выражение, соответствующее пути входящего URL-адреса. Второй параметр является строкой замены. Третий параметр `skipRemainingRules: {true|false}` сообщает ПО промежуточного слоя, нужно ли пропустить дополнительные правила переопределения, если применяется текущее правило.

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=10-11)]

Исходный запрос: `/rewrite-rule/1234/5678`

![Окно браузера, в котором средства разработчика отслеживают запрос и отклик](url-rewriting/_static/add_rewrite.png)

Карет (`^`) в начале выражение означает, что сопоставление начинается с начала URL-адреса.

В предыдущем примере с правилом перенаправления, `redirect-rule/(.*)`, в начале регулярного выражения нет символа `^`. Таким образом, для успешного совпадения до `redirect-rule/` в пути могут стоять любые символы.

| Путь                               | Соответствие |
| ---------------------------------- | :---: |
| `/redirect-rule/1234/5678`         | Да   |
| `/my-cool-redirect-rule/1234/5678` | Да   |
| `/anotherredirect-rule/1234/5678`  | Да   |

Правило переопределения `^rewrite-rule/(\d+)/(\d+)` соответствует путям, только если они начинаются с `rewrite-rule/`. В следующей таблице обратите внимание на разницу в сопоставлении.

| Путь                              | Соответствие |
| --------------------------------- | :---: |
| `/rewrite-rule/1234/5678`         | Да   |
| `/my-cool-rewrite-rule/1234/5678` | Нет    |
| `/anotherrewrite-rule/1234/5678`  | Нет    |

После части `^rewrite-rule/` выражения стоят две группы записи `(\d+)/(\d+)`. `\d` означает *соответствие цифре (числу)*. Знак "плюс" (`+`) означает *соответствие одному или нескольким предшествующим символам*. Таким образом, URL-адрес должен содержать число, за которым идет прямая косая черта, за которой идет другое число. Эти группы записи внедряются в переопределенный URL-адрес как `$1` и `$2`. Строка замены для правила переопределения помещает группы записи в строку запроса. Запрошенный путь `/rewrite-rule/1234/5678` переопределяется, чтобы ресурс можно было получить по адресу `/rewritten?var1=1234&var2=5678`. Если в исходном запросе присутствует строка запроса, она сохраняется при переопределении URL-адреса.

Круговое обращение к серверу для получения ресурса не выполняется. Если ресурс существует, он извлекается и возвращается клиенту с кодом состояния *200 (ОК)*. Так как клиент не перенаправляется, URL-адрес в адресной строке браузера не изменяется. Клиенты не могут узнать, что на сервере произошла операция переопределения URL-адреса.

> [!NOTE]
> Используйте `skipRemainingRules: true` при любой возможности, так как правила сопоставления потребляют много ресурсов и ухудшают время отклика приложения. Чтобы максимально ускорить отклик приложения:
>
> * расположите правила переопределения в порядке от наиболее к наименее часто используемому;
> * пропускайте обработку оставшихся правил, когда совпадение найдено и обработка дополнительных правил не требуется.

### <a name="apache-modrewrite"></a>Apache mod_rewrite

Для применения правил mod_rewrite Apache можно использовать <xref:Microsoft.AspNetCore.Rewrite.ApacheModRewriteOptionsExtensions.AddApacheModRewrite*>. Убедитесь, что файл правил развертывается вместе с приложением. Дополнительные сведения и примеры правил mod_rewrite см. в статье о [правилах mod_rewrite Apache](https://httpd.apache.org/docs/2.4/rewrite/).

<xref:System.IO.StreamReader> используется для чтения правил из файла *ApacheModRewrite.txt*:

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=3-4,12)]

Пример приложения перенаправляет запросы из `/apache-mod-rules-redirect/(.\*)` в `/redirected?id=$1`. Отклик имеет код состояния *302 (найдено)*.

[!code[](url-rewriting/samples/2.x/SampleApp/ApacheModRewrite.txt)]

Исходный запрос: `/apache-mod-rules-redirect/1234`

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики](url-rewriting/_static/add_apache_mod_redirect.png)

ПО промежуточного слоя поддерживает следующие переменные сервера в mod_rewrite Apache:

* CONN_REMOTE_ADDR
* HTTP_ACCEPT
* HTTP_CONNECTION
* HTTP_COOKIE
* HTTP_FORWARDED
* HTTP_HOST
* HTTP_REFERER
* HTTP_USER_AGENT
* HTTPS
* IPV6
* QUERY_STRING
* REMOTE_ADDR
* REMOTE_PORT
* REQUEST_FILENAME
* REQUEST_METHOD
* REQUEST_SCHEME
* REQUEST_URI
* SCRIPT_FILENAME
* SERVER_ADDR
* SERVER_PORT
* SERVER_PROTOCOL
* TIME
* TIME_DAY
* TIME_HOUR
* TIME_MIN
* TIME_MON
* TIME_SEC
* TIME_WDAY
* TIME_YEAR

### <a name="iis-url-rewrite-module-rules"></a>Правила модуля переопределения URL-адресов для IIS

Чтобы использовать тот же набор правил, который применяется к модулю переопределения URL-адресов для IIS, используйте <xref:Microsoft.AspNetCore.Rewrite.IISUrlRewriteOptionsExtensions.AddIISUrlRewrite*>. Убедитесь, что файл правил развертывается вместе с приложением. Не указывайте ПО промежуточного слоя использовать файл приложения *web.config* при работе в службах IIS Windows Server. В IIS эти правила нужно хранить за пределами файла приложения *web.config*, чтобы предотвратить конфликты с модулем переопределения для IIS. Дополнительные сведения и примеры правил модуля переопределения URL-адресов для IIS см. в разделах [Использование модуля переопределения URL-адресов 2.0](/iis/extensions/url-rewrite-module/using-url-rewrite-module-20) и [Справочник по конфигурации модуля переопределения URL-адресов](/iis/extensions/url-rewrite-module/url-rewrite-module-configuration-reference).

<xref:System.IO.StreamReader> используется для чтения правил из файла *IISUrlRewrite.xml*:

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=5-6,13)]

Пример приложения переопределяет запросы с `/iis-rules-rewrite/(.*)` на `/rewritten?id=$1`. Клиенту отправляется отклик с кодом состояния *200 (ОК)*.

[!code-xml[](url-rewriting/samples/2.x/SampleApp/IISUrlRewrite.xml)]

Исходный запрос: `/iis-rules-rewrite/1234`

![Окно браузера, в котором средства разработчика отслеживают запрос и отклик](url-rewriting/_static/add_iis_url_rewrite.png)

Если имеется активный модуль переопределения для IIS, где настроены правила брандмауэра уровня сервера, способные негативно повлиять на ваше приложение, можно отключить этот модуль для приложения. Дополнительные сведения см. в разделе [Отключение модулей IIS](xref:host-and-deploy/iis/modules#disabling-iis-modules).

#### <a name="unsupported-features"></a>Неподдерживаемые функции

ПО промежуточного слоя, выпущенное вместе с ASP.NET Core 2.x, не поддерживает следующие функции в модуле переопределения URL-адресов для IIS:

* Правила для исходящих подключений
* Пользовательские переменные сервера
* Знаки подстановки
* LogRewrittenUrl

#### <a name="supported-server-variables"></a>Поддерживаемые переменные сервера

ПО промежуточного слоя поддерживает следующие переменные сервера в модуле переопределения URL-адресов для IIS:

* CONTENT_LENGTH
* CONTENT_TYPE
* HTTP_ACCEPT
* HTTP_CONNECTION
* HTTP_COOKIE
* HTTP_HOST
* HTTP_REFERER
* HTTP_URL
* HTTP_USER_AGENT
* HTTPS
* LOCAL_ADDR
* QUERY_STRING
* REMOTE_ADDR
* REMOTE_PORT
* REQUEST_FILENAME
* REQUEST_URI

> [!NOTE]
> Можно также получить <xref:Microsoft.Extensions.FileProviders.IFileProvider> через <xref:Microsoft.Extensions.FileProviders.PhysicalFileProvider>. Такой подход позволяет более гибко задавать расположение для файлов с правилами переопределения. Убедитесь, что эти файлы развертываются на сервере по указанному пути.
>
> ```csharp
> PhysicalFileProvider fileProvider = new PhysicalFileProvider(Directory.GetCurrentDirectory());
> ```

### <a name="method-based-rule"></a>Правило, основанное на методе

Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*>, чтобы реализовать собственную логику правил в методе. `Add` предоставляет <xref:Microsoft.AspNetCore.Rewrite.RewriteContext>, который предоставляет <xref:Microsoft.AspNetCore.Http.HttpContext> для использования в методе. [RewriteContext.Result](xref:Microsoft.AspNetCore.Rewrite.RewriteContext.Result*) определяет, как осуществляется дополнительная обработка в конвейере. Установите значение одного из полей <xref:Microsoft.AspNetCore.Rewrite.RuleResult> из следующей таблицы.

| `RewriteContext.Result`              | Действие                                                           |
| ------------------------------------ | ---------------------------------------------------------------- |
| `RuleResult.ContinueRules` (по умолчанию) | Продолжение применения правил.                                         |
| `RuleResult.EndResponse`             | Остановка применения правил и отправка отклика.                       |
| `RuleResult.SkipRemainingRules`      | Остановка применения правил и отправка контекста в следующий компонент ПО промежуточного слоя. |

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=14)]

Пример приложения демонстрирует метод, который перенаправляет запросы для путей, заканчивающихся на *.xml*. Если запрос выполняется для `/file.xml`, запрос перенаправляется к `/xmlfiles/file.xml`. Для кода состояния задается значение *301 (перемещен окончательно)*. Когда браузер отправляет новый запрос на */xmlfiles/file.xml*, ПО промежуточного слоя статических файлов предоставляет файл клиенту из папки *wwwroot/xmlfiles*. Для перенаправления необходимо явно указать код состояния ответа. В противном случае возвращается код состояния *200 (ОК)* и перенаправление на стороне клиента не происходит.

*RewriteRules.cs*:

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/RewriteRules.cs?name=snippet_RedirectXmlFileRequests&highlight=14-18)]

Этот подход также переопределяет запросы. В примере приложения показано переопределение пути для любого запроса текстового файла, чтобы отправить текстовый файл *file.txt* из папки *wwwroot*. ПО промежуточного слоя статических файлов предоставляет файл по обновленному пути запроса:

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=15,22)]

*RewriteRules.cs*:

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/RewriteRules.cs?name=snippet_RewriteTextFileRequests&highlight=7-8)]

### <a name="irule-based-rule"></a>Правило, основанное на IRule

Используйте <xref:Microsoft.AspNetCore.Rewrite.RewriteOptionsExtensions.Add*>, чтобы использовать собственную логику правил в классе, реализующем интерфейс <xref:Microsoft.AspNetCore.Rewrite.IRule>. `IRule` позволяет более гибко применять правила, основанные на методах. Класс реализации может включать конструктор, который позволяет передавать параметры для метода <xref:Microsoft.AspNetCore.Rewrite.IRule.ApplyRule*>.

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/Startup.cs?name=snippet1&highlight=16-17)]

Значения параметров в примере приложения для `extension` и `newPath` проверяются на соответствие нескольким условиям. `extension` должен содержать одно из значений: *.png*, *.jpg* или *.gif*. Если `newPath` не является допустимым, возникает исключение <xref:System.ArgumentException>. Если запрос выполняется для *image.png*, запрос перенаправляется к `/png-images/image.png`. Если запрос выполняется для *image.jpg*, запрос перенаправляется к `/jpg-images/image.jpg`. Для кода состояния устанавливается значение *301 (перемещен окончательно)*, а также задается `context.Result`, чтобы остановить обработку правил и отправить отклик.

[!code-csharp[](url-rewriting/samples/2.x/SampleApp/RewriteRules.cs?name=snippet_RedirectImageRequests)]

Исходный запрос: `/image.png`

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики для image.png](url-rewriting/_static/add_redirect_png_requests.png)

Исходный запрос: `/image.jpg`

![Окно браузера, в котором средства разработчика отслеживают запросы и отклики для image.jpg](url-rewriting/_static/add_redirect_jpg_requests.png)

## <a name="regex-examples"></a>Примеры регулярных выражений

| Goal | Пример строки регулярного выражения<br>и совпадения | Пример строки замены и<br>выходных данных |
| ---- | ------------------------------- | -------------------------------------- |
| Переопределение пути в строке запроса | `^path/(.*)/(.*)`<br>`/path/abc/123` | `path?var1=$1&var2=$2`<br>`/path?var1=abc&var2=123` |
| Удаление косой черты в конце | `(.*)/$`<br>`/path/` | `$1`<br>`/path` |
| Добавление косой черты в конце | `(.*[^/])$`<br>`/path` | `$1/`<br>`/path/` |
| Запрет переопределения отдельных запросов | `^(.*)(?<!\.axd)$` или `^(?!.*\.axd$)(.*)$`<br>Да: `/resource.htm`<br>Нет: `/resource.axd` | `rewritten/$1`<br>`/rewritten/resource.htm`<br>`/resource.axd` |
| Переупорядочение сегментов URL-адреса | `path/(.*)/(.*)/(.*)`<br>`path/1/2/3` | `path/$3/$2/$1`<br>`path/3/2/1` |
| Замена сегмента URL-адреса | `^(.*)/segment2/(.*)`<br>`/segment1/segment2/segment3` | `$1/replaced/$2`<br>`/segment1/replaced/segment3` |

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Запуск приложения](startup.md)
* [ПО промежуточного слоя](xref:fundamentals/middleware/index)
* [Регулярные выражения в .NET](/dotnet/articles/standard/base-types/regular-expressions)
* [Элементы языка регулярных выражений — краткий справочник](/dotnet/articles/standard/base-types/quick-ref)
* [Apache mod_rewrite](https://httpd.apache.org/docs/2.4/rewrite/)
* [Использование модуля переопределения URL-адресов 2.0 (для IIS)](/iis/extensions/url-rewrite-module/using-url-rewrite-module-20)
* [Справочник по конфигурации модуля переопределения URL-адресов](/iis/extensions/url-rewrite-module/url-rewrite-module-configuration-reference)
* [Форум по модулю переопределения URL-адресов для IIS](https://forums.iis.net/1152.aspx)
* [Сохранение простой структуры URL-адресов](https://support.google.com/webmasters/answer/76329?hl=en)
* [10 советов по переопределению URL-адресов](http://ruslany.net/2009/04/10-url-rewriting-tips-and-tricks/)
* [Аспекты использования косой черты](https://webmasters.googleblog.com/2010/04/to-slash-or-not-to-slash.html)
