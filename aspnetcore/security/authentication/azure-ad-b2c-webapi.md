---
title: Проверка подлинности в веб-API с помощью Azure Active Directory B2C в ASP.NET Core
author: camsoper
description: Узнайте, как настроить проверку подлинности Azure Active Directory B2C с помощью веб-API ASP.NET Core. Тестирование прошедшего проверку подлинности веб-API с помощью приложения Postman.
ms.author: casoper
ms.date: 09/21/2018
ms.custom: mvc, seodec18
uid: security/authentication/azure-ad-b2c-webapi
ms.openlocfilehash: 6d0365b103572d6059ce61c54b9b3406da9e5bd4
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57060381"
---
# <a name="authentication-in-web-apis-with-azure-active-directory-b2c-in-aspnet-core"></a>Проверка подлинности в веб-API с помощью Azure Active Directory B2C в ASP.NET Core

Автор [Кэм Сопер (Cam Soper)](https://twitter.com/camsoper)

[Azure Active Directory B2C](/azure/active-directory-b2c/active-directory-b2c-overview) (Azure AD B2C) является это облаке решение управления удостоверениями для Интернета и мобильных приложений. Эта служба предоставляет проверку подлинности для приложений, размещенных в облаке и локальной. Типы проверки подлинности включают отдельные учетные записи, учетные записи социальных сетей и федеративные пользователи корпоративных учетных записей. Azure AD B2C также предоставляет многофакторной проверки подлинности с минимальной конфигурацией.

Azure Active Directory (Azure AD) и Azure AD B2C являются отдельными предложениями продуктов. Клиент Azure AD представляет организацию, хотя клиент Azure AD B2C представляет коллекцию удостоверений для использования с приложениями проверяющей стороны. Дополнительные сведения см. в разделе [Azure AD B2C: Часто задаваемые вопросы (FAQ)](/azure/active-directory-b2c/active-directory-b2c-faqs).

Так как веб-API не имеют пользовательского интерфейса, они не удалось перенаправить пользователя для службы маркеров безопасности как Azure AD B2C. Вместо этого API передается токен носителя из вызывающего приложения, который уже прошел проверку пользователь с Azure AD B2C. API, затем проверяет маркер без прямого взаимодействия с пользователем.

В этом руководстве описано, как:

> [!div class="checklist"]
> * Создание клиента Azure Active Directory B2C.
> * Регистрация веб-API в Azure AD B2C.
> * Используйте Visual Studio для создания веб-API настроен для использования клиента Azure AD B2C для проверки подлинности.
> * Настройка политик, управляющих поведением клиента Azure AD B2C.
> * Использование Postman для имитации веб-приложение, которое представляет диалоговое окно входа, получает маркер и использует его для выполнения запроса к веб-API.

## <a name="prerequisites"></a>Предварительные требования

Ниже приведены необходимые для этого пошагового руководства.

* [Подписки Microsoft Azure](https://azure.microsoft.com/free/?ref=microsoft.com&utm_source=microsoft.com&utm_medium=docs&utm_campaign=visualstudio)
* [Visual Studio 2017](https://aka.ms/vsdownload?utm_source=mscom&utm_campaign=msdocs) (любой выпуск)
* [Postman](https://www.getpostman.com/postman)

## <a name="create-the-azure-active-directory-b2c-tenant"></a>Создание клиента Azure Active Directory B2C

Создание клиента Azure AD B2C [как описано в документации по](/azure/active-directory-b2c/active-directory-b2c-get-started). При появлении сопоставления клиента с подпиской Azure является необязательным в этом руководстве.

## <a name="configure-a-sign-up-or-sign-in-policy"></a>Настройка политики регистрации или входа в систему

Следуйте инструкциям в документации по Azure AD B2C для [создать политику регистрации или входа в систему](/azure/active-directory-b2c/active-directory-b2c-reference-policies#create-a-sign-up-or-sign-in-policy). Назовите политику **SiUpIn**.  Используйте примеры значений, приведенных в документации для **поставщиков удостоверений**, **атрибуты регистрации**, и **утверждения приложения**. С помощью **запустить сейчас** кнопку, чтобы проверить политику, как описано в документации является необязательным.

## <a name="register-the-api-in-azure-ad-b2c"></a>Зарегистрировать API в Azure AD B2C

В только что созданный клиент Azure AD B2C, зарегистрировать API с помощью [действия, описанные в документации по](/azure/active-directory-b2c/active-directory-b2c-app-registration#register-a-web-api) под **Регистрация веб-API** раздел.

Используйте следующие значения:

| Параметр                       | Значение               | Примечания                                                                                  |
|-------------------------------|---------------------|----------------------------------------------------------------------------------------|
| **Name**                      | *{API-name}*        | Введите **имя** для приложения, которые описывают приложение для потребителей.                     |
| **Включить веб-приложение или веб-API** | Да                 |                                                                                        |
| **Разрешить неявный поток**       | Да                 |                                                                                        |
| **URL-адрес ответа**                 | `https://localhost` | URL-адреса ответа — это конечные точки, куда Azure AD B2C возвращает все токены, запрашиваемые вашим приложением. |
| **URI идентификатора приложения**                | *API*               | URI не должен разрешаться на физический адрес. Оно должно быть уникальным.     |
| **Включить собственный клиент**     | Нет                  |                                                                                        |

После регистрации API отображается список приложений и интерфейсов API в клиенте. Выберите API, который ранее был зарегистрирован. Выберите **копирования** значок справа от **идентификатор приложения** поле, чтобы скопировать его в буфер обмена. Выберите **опубликованные области** и проверьте значение по умолчанию *user_impersonation* область присутствует.

## <a name="create-an-aspnet-core-app-in-visual-studio-2017"></a>Создание приложения ASP.NET Core в Visual Studio 2017

Шаблон веб-приложения Visual Studio можно настроить для использования клиента Azure AD B2C для проверки подлинности.

В Visual Studio сделайте следующее:

1. Создайте новое веб-приложение ASP.NET Core. 
2. Выберите **веб-API** из списка шаблонов.
3. Выберите **изменить способ проверки подлинности** кнопки.

    ![Кнопка "Изменить проверку подлинности"](./azure-ad-b2c-webapi/change-auth-button.png)

4. В **изменить способ проверки подлинности** диалоговом окне выберите **учетные записи отдельных пользователей** > **подключение к существующему хранилищу пользователей в облаке**.

    ![Диалоговое окно Изменение проверки подлинности](./azure-ad-b2c-webapi/change-auth-dialog.png)

5. Заполните форму следующими значениями:

    | Параметр                       | Значение                                                 |
    |-------------------------------|-------------------------------------------------------|
    | **Имя домена**               | *{имя домена клиента B2C}*                |
    | **Идентификатор приложения**            | *{Вставьте идентификатор приложения из буфера обмена}*       |
    | **Политики регистрации или входа в систему** | B2C_1_SiUpIn                                          |

    Выберите **ОК** закрыть **изменить способ проверки подлинности** диалоговое окно. Выберите **ОК** для создания веб-приложения.

Visual Studio создает веб-API с помощью контроллера с именем *ValuesController.cs* , возвращающий жестко запрограммированные значения для запросов GET. Класс декорируется [атрибут Authorize](xref:security/authorization/simple), поэтому все запросы требуют проверки подлинности.

## <a name="run-the-web-api"></a>Запустите веб-API

В Visual Studio запустите API. Visual Studio запустит браузер на URL-адрес корня API. Запишите URL-адрес в адресной строке и оставить API, работающего в фоновом режиме.

> [!NOTE]
> Так как отсутствует контроллер, определенные для корневой URL-адрес, браузер может отображать сообщение об ошибке 404 (страница не найдена). Это нормальная ситуация.

## <a name="use-postman-to-get-a-token-and-test-the-api"></a>Получение маркера и тестирование API с помощью Postman

[Postman](https://getpostman.com/postman) это инструмент для проверки веб-API. В этом учебнике Postman имитирует веб-приложение, которое обращается к веб-API от имени пользователя.

### <a name="register-postman-as-a-web-app"></a>Регистрация в качестве веб-приложения Postman

Так как Postman имитирует веб-приложение, которое получает маркеры из клиента Azure AD B2C, он должны быть зарегистрированы в клиенте как веб-приложения. Регистрация с помощью Postman [действия, описанные в документации по](/azure/active-directory-b2c/active-directory-b2c-app-registration#register-a-web-app) под **зарегистрировать веб-приложение** раздел. Остановиться на **создать секрет клиента приложения web** раздел. Секрет клиента не требуется в этом руководстве. 

Используйте следующие значения:

| Параметр                       | Значение                            | Примечания                           |
|-------------------------------|----------------------------------|---------------------------------|
| **Name**                      | Postman                          |                                 |
| **Включить веб-приложение или веб-API** | Да                              |                                 |
| **Разрешить неявный поток**       | Да                              |                                 |
| **URL-адрес ответа**                 | `https://getpostman.com/postman` |                                 |
| **URI идентификатора приложения**                | *{не указывайте}*                  | Не требуется в этом руководстве. |
| **Включить собственный клиент**     | Нет                               |                                 |

Зарегистрированного веб-приложению требуется разрешение на доступ к веб-API от имени пользователя.  

1. Выберите **Postman** в списке приложений, а затем выберите **доступ через API** в меню слева.
1. Выберите **+ добавить**.
1. В **выбрать API** раскрывающемся списке выберите имя веб-API.
1. В **выбрать области** раскрывающийся список, установите флажки всех областей.
1. Выберите **ОК**.

Запишите идентификатор приложения приложение Postman, так как он должен получить токен носителя.

### <a name="create-a-postman-request"></a>Создать запрос Postman

Запустите Postman. По умолчанию отображает Postman **Create New** диалоговое окно при запуске. Если диалоговое окно не отображается, выберите **+ создать** кнопку в левом верхнем углу.

Из **Create New** диалоговое окно:

1. Выберите **запроса**.

    ![Кнопка запроса](./azure-ad-b2c-webapi/postman-create-new.png)

2. Введите *получить значения* в **имя запроса** поле.
3. Выберите **+ создать коллекцию** для создания новой коллекции для хранения запрос. Присвоение имени коллекции *учебники по ASP.NET Core* и затем установите флажок.

    ![Для создания новой коллекции](./azure-ad-b2c-webapi/postman-create-collection.png)

4. Выберите **сохранить учебники по ASP.NET Core** кнопки.

### <a name="test-the-web-api-without-authentication"></a>Тестирование веб-API без проверки подлинности

Чтобы убедиться, что веб-API требуется проверка подлинности, сначала выполните запрос без проверки подлинности.

1. В **введите URL-адрес запроса** введите URL-адрес `ValuesController`. URL-адрес не отличается от отображения в браузере с **api/values** добавляется. Например, `https://localhost:44375/api/values`.
2. Выберите **отправки** кнопки.
3. Обратите внимание на то, находится в состоянии ответ *401 — не санкционировано*.

    ![ответ 401 Нет доступа](./azure-ad-b2c-webapi/postman-401-status.png)

> [!IMPORTANT]
> Если появится сообщение об ошибке «Не удалось получить любой ответ», может потребоваться отключить проверку сертификатов SSL в [Postman параметры](https://learning.getpostman.com/docs/postman/launching_postman/settings).

### <a name="obtain-a-bearer-token"></a>Получить токен носителя

Чтобы сделать запрос с проверкой подлинности для веб-API, маркер-носитель является обязательным. Postman позволяет легко выполнять вход в клиент Azure AD B2C и получить маркер.

1. На **авторизации** на вкладке **тип** раскрывающемся списке выберите **OAuth 2.0**. В **данные авторизации, чтобы добавить** раскрывающемся списке выберите **заголовки запроса**. Выберите **получить новый токен доступа**.

    ![Вкладка "авторизации" с параметрами](./azure-ad-b2c-webapi/postman-auth-tab.png)

2. Завершить **получить новый ТОКЕН доступа** диалоговое окно, как показано ниже:


   |                Параметр                 |                                             Значение                                             |                                                                                                                                    Примечания                                                                                                                                     |
   |----------------------------------------|-----------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   |      <strong>Имя токена</strong>       |                                          *{Имя токена}*                                       |                                                                                                                   Введите описательное имя для токена.                                                                                                                    |
   |      <strong>Тип предоставления разрешения</strong>       |                                           Неявные                                            |                                                                                                                                                                                                                                                                              |
   |     <strong>URL-адрес обратного вызова</strong>      |                                 `https://getpostman.com/postman`                              |                                                                                                                                                                                                                                                                              |
   |       <strong>URL-адрес проверки подлинности</strong>        | `https://login.microsoftonline.com/{tenant domain name}/oauth2/v2.0/authorize?p=B2C_1_SiUpIn` |  Замените *{имя домена клиента}* доменным именем клиента. **ВАЖНЫЕ**: Этот URL-адрес должен иметь имя домена, в том, что содержится в `AzureAdB2C.Instance` в веб-интерфейса API *appsettings.json* файла. См. Примечание&dagger;.                                                  |
   |       <strong>Идентификатор клиента</strong>       |                *{Введите приложение Postman <b>идентификатор приложения</b>}*                              |                                                                                                                                                                                                                                                                              |
   |         <strong>Область</strong>         |         `https://{tenant domain name}/{api}/user_impersonation openid offline_access`       | Замените *{имя домена клиента}* доменным именем клиента. Замените *{api}* с URI идентификатора приложения вы присвоили веб-API при первой регистрации (в этом случае `api`). Шаблон для URL-адрес: `https://{tenant}.onmicrosoft.com/{api-id-uri}/{scope name}`.         |
   |         <strong>Состояние</strong>         |                                      *{не указывайте}*                                          |                                                                                                                                                                                                                                                                              |
   | <strong>Проверка подлинности клиента</strong> |                                Отправки учетных данных клиента в тексте                                |                                                                                                                                                                                                                                                                              |

    > [!NOTE]
    > &dagger; Диалоговое окно параметров политики на портале Azure Active Directory B2C отображает два возможных URL-адреса: В формате `https://login.microsoftonline.com/`{имя домена клиента} / {Дополнительные сведения о пути}, а другой — в формате `https://{tenant name}.b2clogin.com/`{имя домена клиента} / {Дополнительные сведения о пути}. Он имеет **критических** , найти домен в в `AzureAdB2C.Instance` в веб-интерфейса API *appsettings.json* файл соответствует используемому в веб приложения *appsettings.json* файла. Это же домен, используемый для проверки подлинности URL-адрес поля в Postman. Обратите внимание на то, что Visual Studio использует немного иной формат URL-адрес, чем отображаемые на портале. До тех пор, пока домены совпадают, работает URL-адрес.

3. Выберите **запроса маркера** кнопки.

4. Postman откроется новое окно, содержащее диалоговое окно входа клиента Azure AD B2C. Войдите с помощью существующей учетной записи (если один была создана тестирования политики) или выберите **Зарегистрируйтесь сейчас** для создания новой учетной записи. **Забыли пароль?** связи используются для сбрасывать забытый пароль.

5. После успешного входа, окно закрывается и **УПРАВЛЕНИЕ МАРКЕРЫ доступа** откроется диалоговое окно. Прокрутите вниз до вниз и выберите пункт **использования маркеров** кнопки.

    ![Где можно найти кнопку «Используйте Token»](./azure-ad-b2c-webapi/postman-access-token.png)

### <a name="test-the-web-api-with-authentication"></a>Тестирование веб-API с помощью проверки подлинности

Выберите **отправки** кнопку, чтобы отправить запрос повторно. В данном случае состояние ответа входит *200 ОК* и полезные данные JSON является видимым в ответе **текст** вкладки.

![Полезные данные и успешно состояния](./azure-ad-b2c-webapi/postman-success.png)

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как:

> [!div class="checklist"]
> * Создание клиента Azure Active Directory B2C.
> * Регистрация веб-API в Azure AD B2C.
> * Используйте Visual Studio для создания веб-API настроен для использования клиента Azure AD B2C для проверки подлинности.
> * Настройка политик, управляющих поведением клиента Azure AD B2C.
> * Использование Postman для имитации веб-приложение, которое представляет диалоговое окно входа, получает маркер и использует его для выполнения запроса к веб-API.

Продолжите разработку API, Научившись:

* [Защита с помощью Azure AD B2C в веб-приложение ASP.NET Core](xref:security/authentication/azure-ad-b2c).
* [Вызов веб-API .NET из веб-приложения .NET с помощью Azure AD B2C](/azure/active-directory-b2c/active-directory-b2c-devquickstarts-web-api-dotnet).
* [Настройка пользовательского интерфейса Azure AD B2C](/azure/active-directory-b2c/active-directory-b2c-reference-ui-customization).
* [Настройка требований к сложности пароля](/azure/active-directory-b2c/active-directory-b2c-reference-password-complexity).
* [Включить многофакторную проверку подлинности](/azure/active-directory-b2c/active-directory-b2c-reference-mfa).
* Настройка дополнительных поставщиков удостоверений, таких как [Microsoft](/azure/active-directory-b2c/active-directory-b2c-setup-msa-app), [Facebook](/azure/active-directory-b2c/active-directory-b2c-setup-fb-app), [Google](/azure/active-directory-b2c/active-directory-b2c-setup-goog-app), [Amazon](/azure/active-directory-b2c/active-directory-b2c-setup-amzn-app), [Twitter ](/azure/active-directory-b2c/active-directory-b2c-setup-twitter-app)и другие.
* [С помощью API Azure AD Graph](/azure/active-directory-b2c/active-directory-b2c-devquickstarts-graph-dotnet) для получения дополнительных сведений о пользователе, например членство в группе, из клиента Azure AD B2C.
