---
title: Снятие защиты полезных данных, ключи которых были отозваны в ASP.NET Core
author: rick-anderson
description: Узнайте, как снять защиту данных, защищенных с помощью ключей, так как были отозваны, в приложении ASP.NET Core.
ms.author: riande
ms.custom: mvc
ms.date: 10/24/2018
uid: security/data-protection/consumer-apis/dangerous-unprotect
ms.openlocfilehash: b93ab0fa650041afdfaf1ed5572cc7e081bba244
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57062831"
---
# <a name="unprotect-payloads-whose-keys-have-been-revoked-in-aspnet-core"></a>Снятие защиты полезных данных, ключи которых были отозваны в ASP.NET Core


<a name="data-protection-consumer-apis-dangerous-unprotect"></a>

Интерфейсы API защиты данных ASP.NET Core не предназначены главным образом для неопределенного сохраняемости конфиденциальных полезных данных. Другие технологии, такие как [Windows CNG DPAPI](https://msdn.microsoft.com/library/windows/desktop/hh706794%28v=vs.85%29.aspx) и [Azure Rights Management](/rights-management/) больше подходят для сценария неопределенное хранилища, и они обладают возможностями соответственно строгого управления ключами. С другой стороны, нет ничего запрет разработчику использовать интерфейсы API защиты данных ASP.NET Core для долгосрочной защиты конфиденциальных данных. Ключи никогда не удаляются из набора ключей, поэтому `IDataProtector.Unprotect` всегда можно восстановить существующий полезных данных, до тех пор, пока ключи остаются в наличии и допустимости.

Тем не менее, возникает проблема, когда разработчик попытается снять защиту данных, защищенной с помощью отозванных ключа, как `IDataProtector.Unprotect` в этом случае будет выдано исключение. Это может быть нормально для кратковременных или временных полезных данных (например, токены проверки подлинности), эти виды полезных данных можно легко воссоздать в системе, а в худшем случае посетитель узла возможно, потребуется снова войти в систему. Но для материализованных полезных данных, наличие `Unprotect` throw может привести к потере недопустимых значений.

## <a name="ipersisteddataprotector"></a>IPersistedDataProtector

Для поддержки сценария предоставления полезных данных, необходимо снять защиту даже в случае отозванных ключи, система защиты данных содержит `IPersistedDataProtector` типа. Чтобы получить экземпляр `IPersistedDataProtector`, просто получить экземпляр `IDataProtector` в обычном и приведения try `IDataProtector` для `IPersistedDataProtector`.

> [!NOTE]
> Не все `IDataProtector` экземпляров может быть приведен к `IPersistedDataProtector`. Разработчикам следует использовать C# оператор или аналогичного во избежание исключения среды CLR из-за недопустимые приведения, и они должны быть готовы к соответствующим образом обрабатывать случаи сбоев.

`IPersistedDataProtector` предоставляет следующие поверхность API:

```csharp
DangerousUnprotect(byte[] protectedData, bool ignoreRevocationErrors,
     out bool requiresMigration, out bool wasRevoked) : byte[]
```

Этот API принимает защищенных полезных данных (в виде массива байтов) и возвращает незащищенные полезных данных. Отсутствует перегрузка строковых. Ниже приведены два выходных параметров.

* `requiresMigration`: установлено значение true, если ключ, используемый для защиты этого полезных данных больше не является ключевым active по умолчанию, например, старый ключ, используемый для защиты эти полезные данные и ключ последовательные операции, с момента откроется месте. Вызывающий объект может потребоваться реализовать, повторная защита полезных данных в зависимости от потребностей бизнеса.

* `wasRevoked`: будет присвоено значение true, если ключ, используемый для защиты этого полезных данных было отозвано.

>[!WARNING]
> Проявлять предельную осторожность при передаче `ignoreRevocationErrors: true` для `DangerousUnprotect` метод. Если после вызова этого метода `wasRevoked` значение равно true, то ключ, используемый для защиты этого полезных данных было отозвано и подлинность полезные данные, которые должны рассматриваться как подозрительная. В этом случае только по-прежнему операционных незащищенные полезные данные, если у вас есть некоторые отдельные гарантии того, что это подлинный, например что он поступает из защищенной базе данных, а не отправляются клиентом ненадежных веб.

[!code-csharp[](dangerous-unprotect/samples/dangerous-unprotect.cs)]
