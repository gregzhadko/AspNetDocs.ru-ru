---
title: Предотвращения межсайтовых сценариев (XSS) в ASP.NET Core
author: rick-anderson
description: Дополнительные сведения о межсайтовых сценариев (XSS) и методы для устранения этой уязвимости в приложении ASP.NET Core.
ms.author: riande
ms.date: 10/02/2018
uid: security/cross-site-scripting
ms.openlocfilehash: 50f0211a2c64708d9b788dd10ce9064e66014d55
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57054901"
---
# <a name="prevent-cross-site-scripting-xss-in-aspnet-core"></a>Предотвращения межсайтовых сценариев (XSS) в ASP.NET Core

Автор: [Рик Андерсон](https://twitter.com/RickAndMSFT) (Rick Anderson)

Межузловых сценариев (XSS) — это уязвимость системы безопасности, что позволяет злоумышленнику поместите скриптах на стороне клиента (обычно JavaScript) в веб-страницы. При других пользователей загрузить затронутые страницы, которые будут запущены сценарии злоумышленника, что позволит ему похищать файлы cookie и маркеры сеанса изменить содержание веб-страницы через обработке модели DOM или перенаправить браузер на другую страницу. Уязвимости к XSS, как правило, происходят, когда приложение принимает предоставляемые пользователем данные и выводит его на страницу без проверки, кодирования или экранирование его.

## <a name="protecting-your-application-against-xss"></a>Защита приложения от межсайтовых Сценариев

AT основных уровня XSS осуществляется честных и приложение в виде вставки `<script>` тег в готовом для просмотра страницы или путем вставки `On*` событий в элемент. Разработчикам следует использовать следующие действия для предотвращения во избежание внесения XSS в свое приложение.

1. Никогда не помещайте непроверенных данных в HTML входные данные, если не следовать остальной части указанные ниже действия. Непроверенных данных — это любые данные, которые могут управляться злоумышленник, формы ввода данных HTML, строки запроса, заголовки HTTP, даже данные, исходный код из базы данных, как злоумышленник может иметь возможность нарушения безопасности базы данных, даже если они не может нарушить приложения.

2. Перед добавлением непроверенных данных внутри HTML-элемент убедитесь, что он имеет кодировку HTML. HTML-кодирования принимает символы, такие как &lt; и изменяет их в безопасном формат наподобие &amp;lt;

3. Перед переводом непроверенных данных в HTML-атрибут убедитесь, что он имеет кодировку HTML. Кодировка атрибута HTML является надмножеством HTML-кодирования и кодирует дополнительные символы, такие как "и".

4. Перед переводом непроверенных данных в JavaScript помещает данные в HTML-элемент, содержимое которых получить во время выполнения. Если это невозможно, убедитесь, что данные в кодировке JavaScript. Кодирование JavaScript принимает опасных символов для JavaScript и заменяет их символом их hex, например &lt; должен кодироваться как `\u003C`.

5. Перед добавлением непроверенных данных в строку запроса URL-адрес, убедитесь, что это URL-кодированием.

## <a name="html-encoding-using-razor"></a>Кодировка HTML, с помощью Razor

Подсистема Razor, используемый в MVC автоматически кодирует все выходные данные источником переменные, если вы не работаете усердной блокирует его таким образом. Он использует правила кодирования атрибут HTML, каждый раз при использовании *@* директива. Как HTML кодировка атрибута является надмножеством HTML-кодирования, это означает, что вам не нужно заботиться, нужно ли использовать HTML-кодирования или кодировка атрибута HTML. Необходимо убедиться, что используются только в контексте HTML, не в том случае, при попытке вставить ненадежных входных данных непосредственно в JavaScript. Вспомогательные функции тегов также будет кодирование входных данных, используемых в параметров tag.

Выполните следующее представление Razor.

```cshtml
@{
       var untrustedInput = "<\"123\">";
   }

   @untrustedInput
   ```

Это представление выводит содержимое *untrustedInput* переменной. Эта переменная содержит некоторые символы, которые используются в атак XSS, а именно &lt;, "и &gt;. Анализ источника показаны выводимые данные кодируются как:

```html
&lt;&quot;123&quot;&gt;
   ```

>[!WARNING]
> ASP.NET Core MVC предоставляет `HtmlString` класса, которой не автоматически после вывода. Это никогда не можно использовать в сочетании с ненадежных входных данных, так как это будет предоставлять уязвимость XSS.

## <a name="javascript-encoding-using-razor"></a>JavaScript кодирование с помощью Razor

Могут возникнуть ситуации, нужно вставить значение в JavaScript для обработки в представлении. Это можно сделать двумя способами. Наиболее безопасным способом для вставки значений — разместить значение в атрибуте данных тега и его можно получить в JavaScript. Пример:

```cshtml
@{
       var untrustedInput = "<\"123\">";
   }

   <div
       id="injectedData"
       data-untrustedinput="@untrustedInput" />

   <script>
     var injectedData = document.getElementById("injectedData");

     // All clients
     var clientSideUntrustedInputOldStyle =
         injectedData.getAttribute("data-untrustedinput");

     // HTML 5 clients only
     var clientSideUntrustedInputHtml5 =
         injectedData.dataset.untrustedinput;

     document.write(clientSideUntrustedInputOldStyle);
     document.write("<br />")
     document.write(clientSideUntrustedInputHtml5);
   </script>
   ```

Этот скрипт создаст следующий код HTML

```html
<div
     id="injectedData"
     data-untrustedinput="&lt;&quot;123&quot;&gt;" />

   <script>
     var injectedData = document.getElementById("injectedData");

     var clientSideUntrustedInputOldStyle =
         injectedData.getAttribute("data-untrustedinput");

     var clientSideUntrustedInputHtml5 =
         injectedData.dataset.untrustedinput;

     document.write(clientSideUntrustedInputOldStyle);
     document.write("<br />")
     document.write(clientSideUntrustedInputHtml5);
   </script>
   ```

Который, при ее запуске будет отображаться следующее:

```none
<"123">
   <"123">
   ```

Можно также напрямую вызвать кодировщик JavaScript:

```cshtml
@using System.Text.Encodings.Web;
   @inject JavaScriptEncoder encoder;

   @{
       var untrustedInput = "<\"123\">";
   }

   <script>
       document.write("@encoder.Encode(untrustedInput)");
   </script>
   ```

Это будет отображаться в браузере следующим образом:

```html
<script>
       document.write("\u003C\u0022123\u0022\u003E");
   </script>
   ```

>[!WARNING]
> Не объединять ненадежных входных данных в JavaScript для создания элементов DOM. Следует использовать `createElement()` и соответствующим образом, такие как присвоение значений свойствам `node.TextContent=`, или использовать `element.SetAttribute()` / `element[attribute]=` в противном случае можно предоставить себе коду основе DOM XSS.

## <a name="accessing-encoders-in-code"></a>Доступ к кодировщиков в коде

Кодировщики HTML, JavaScript и URL-адрес, доступные для кода двумя способами, вы можете внедрить их через [внедрения зависимостей](xref:fundamentals/dependency-injection) или вы можете использовать кодировщики по умолчанию, содержащиеся в `System.Text.Encodings.Web` пространства имен. При использовании кодировщики по умолчанию любой применяются к диапазонов символов следует рассматривать как безопасные вступят в силу — кодировщики по умолчанию используется безопасный из возможных правил кодирования.

Чтобы использовать настраиваемые кодировщики через внедрение Зависимостей в конструкторах займет *HtmlEncoder*, *JavaScriptEncoder* и *UrlEncoder* параметр соответствующим образом. Например, если для

```csharp
public class HomeController : Controller
   {
       HtmlEncoder _htmlEncoder;
       JavaScriptEncoder _javaScriptEncoder;
       UrlEncoder _urlEncoder;

       public HomeController(HtmlEncoder htmlEncoder,
                             JavaScriptEncoder javascriptEncoder,
                             UrlEncoder urlEncoder)
       {
           _htmlEncoder = htmlEncoder;
           _javaScriptEncoder = javascriptEncoder;
           _urlEncoder = urlEncoder;
       }
   }
   ```

## <a name="encoding-url-parameters"></a>Параметры кодирования URL-адрес

Если вы хотите создать строку запроса URL-адрес с ненадежных входных данных в качестве значения используйте `UrlEncoder` для кодирования значения. Например, примененная к объекту директива

```csharp
var example = "\"Quoted Value with spaces and &\"";
   var encodedValue = _urlEncoder.Encode(example);
   ```

После кодирования encodedValue переменная будет содержать `%22Quoted%20Value%20with%20spaces%20and%20%26%22`. Пробелов, кавычки, знаки препинания и другие небезопасные символы процента кодируется в их шестнадцатеричное значение, например символ пробела станет % 20.

>[!WARNING]
> Не используйте ненадежных входных данных как часть пути URL-адреса. Всегда выполнять передачу ненадежных входных данных как значения строки запроса.

<a name="security-cross-site-scripting-customization"></a>

## <a name="customizing-the-encoders"></a>Настройка кодировщиков

По умолчанию кодировщиков используйте ограниченный диапазон Юникода для основной латиницы списка надежных отправителей и кодирования всех символов вне этого диапазона как эквиваленты код символа. Это поведение также влияет на Razor TagHelper и HtmlHelper отрисовки, так как он будет использовать кодировщики для вывода строк.

Обуславливается для защиты от неизвестных или будущих браузера ошибок (предыдущих ошибок в обозревателе приводило к ошибкам вверх синтаксического анализа на основе во время обработки неанглийские символы). Если веб-сайт усложняет использование Нелатинские символы, такие как китайский, кириллица, или другими это скорее всего, не необходимого поведения.

Вы можете настроить списки безопасных кодировщика для включения Юникода диапазонами подходящими для вашего приложения, во время запуска, в `ConfigureServices()`.

Например, с помощью конфигурации по умолчанию, можно использовать Razor HtmlHelper следующим образом;

```html
<p>This link text is in Chinese: @Html.ActionLink("汉语/漢語", "Index")</p>
   ```

При просмотре исходного кода веб-страницы, будет видно, что он визуализирован следующим образом, с помощью закодирован; текст на китайском языке

```html
<p>This link text is in Chinese: <a href="/">&#x6C49;&#x8BED;/&#x6F22;&#x8A9E;</a></p>
   ```

Чтобы расширить знаки, обрабатываемые как безопасный кодировщиком, необходимо вставить следующую строку в `ConfigureServices()` метод в `startup.cs`;

```csharp
services.AddSingleton<HtmlEncoder>(
     HtmlEncoder.Create(allowedRanges: new[] { UnicodeRanges.BasicLatin,
                                               UnicodeRanges.CjkUnifiedIdeographs }));
   ```

В этом примере можно расширить список безопасных элементов для включения CjkUnifiedIdeographs диапазон Юникода. Теперь стал бы выводимые данные

```html
<p>This link text is in Chinese: <a href="/">汉语/漢語</a></p>
   ```

Список безопасных диапазоны задаются в виде таблиц кодировок Юникода, не языки. [Стандарта Юникод](http://unicode.org/) имеет список [кода диаграммы](http://www.unicode.org/charts/index.html) можно использовать для поиска таблица, содержащая символы. Каждый из которых, Html, JavaScript и URL-адрес, необходимо настроить по отдельности.

> [!NOTE]
> Настройка надежных влияет только на кодировщиков, отправляемый с помощью внедрения Зависимостей. Если прямой доступ к кодировщик через `System.Text.Encodings.Web.*Encoder.Default` затем по умолчанию, Basic Latin только safelist будет использоваться.

## <a name="where-should-encoding-take-place"></a>Куда следует поместить кодирования take?

Общие применяемый практикой является кодирование выполняется точке выходные данные, что закодированные значения никогда не должны храниться в базе данных. Кодирование точке выходные данные можно изменить использование данных, например, с HTML на значения строки запроса. Также позволяет легко найти данные без необходимости кодирования значений перед поиском и позволяет воспользоваться преимуществами изменения или исправления, внесенные в кодировщиков.

## <a name="validation-as-an-xss-prevention-technique"></a>Проверку, что метод защиты от XSS

Проверка может быть полезным инструментом ограничение атак XSS. Например числовая строка, содержащая только символы 0 – 9, не вызовет срабатывания атаки XSS. Проверка усложняется при приеме HTML во входных данных пользователя. Синтаксический анализ вводимых данных HTML сложно, если вообще. Markdown, в сочетании с средство синтаксического анализа, которое удаляет внедренный HTML-код, более безопасный вариант для принятия широкие возможности ввода. Никогда не используют только проверку. Всегда кодировать ненадежных входных данных перед выводом, независимо от того, какие проверки или очистки будет выполнена.
