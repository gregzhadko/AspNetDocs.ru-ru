---
title: Учебник. Использование ASP.NET MVC с EF Core. Реализация функциональности CRUD
description: В рамках этого учебника вы сможете ознакомиться с кодом операций CRUD (создание, чтение, обновление, удаление), который автоматически создается технологией формирования шаблонов MVC в контроллерах и представлениях, а также настроить этот код.
author: rick-anderson
ms.author: tdykstra
ms.custom: mvc
ms.date: 02/04/2019
ms.topic: tutorial
uid: data/ef-mvc/crud
ms.openlocfilehash: 368b1774ba977ec8020a02d48705200fd54c3bbd
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57052431"
---
# <a name="tutorial-implement-crud-functionality---aspnet-mvc-with-ef-core"></a><span data-ttu-id="2ad55-103">Учебник. Использование ASP.NET MVC с EF Core. Реализация функциональности CRUD</span><span class="sxs-lookup"><span data-stu-id="2ad55-103">Tutorial: Implement CRUD Functionality - ASP.NET MVC with EF Core</span></span>

<span data-ttu-id="2ad55-104">В предыдущем учебнике было создано приложение MVC, которое сохраняет и отображает данные, используя платформу Entity Framework и SQL Server LocalDB.</span><span class="sxs-lookup"><span data-stu-id="2ad55-104">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="2ad55-105">В рамках этого учебника вы сможете ознакомиться с кодом операций CRUD (создание, чтение, обновление, удаление), который автоматически создается технологией формирования шаблонов MVC в контроллерах и представлениях, а также настроить этот код.</span><span class="sxs-lookup"><span data-stu-id="2ad55-105">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="2ad55-106">Широко распространена практика реализации шаблона репозитория, позволяющего создать уровень абстракции между контроллером и уровнем доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="2ad55-106">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="2ad55-107">Чтобы максимально упростить эти учебники и сконцентрироваться на работе с самой платформой Entity Framework, мы не используем в них репозитории.</span><span class="sxs-lookup"><span data-stu-id="2ad55-107">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="2ad55-108">Дополнительные сведения о репозиториях на платформе EF см. в [последнем учебнике серии](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="2ad55-108">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="2ad55-109">В этом учебнике рассмотрены следующие задачи.</span><span class="sxs-lookup"><span data-stu-id="2ad55-109">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="2ad55-110">Настройка страницы сведений</span><span class="sxs-lookup"><span data-stu-id="2ad55-110">Customize the Details page</span></span>
> * <span data-ttu-id="2ad55-111">Обновление страницы Create</span><span class="sxs-lookup"><span data-stu-id="2ad55-111">Update the Create page</span></span>
> * <span data-ttu-id="2ad55-112">Обновление страницы редактирования</span><span class="sxs-lookup"><span data-stu-id="2ad55-112">Update the Edit page</span></span>
> * <span data-ttu-id="2ad55-113">Обновление страницы удаления</span><span class="sxs-lookup"><span data-stu-id="2ad55-113">Update the Delete page</span></span>
> * <span data-ttu-id="2ad55-114">Закрытие подключений к базам данных</span><span class="sxs-lookup"><span data-stu-id="2ad55-114">Close database connections</span></span>

## <a name="prerequisites"></a><span data-ttu-id="2ad55-115">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="2ad55-115">Prerequisites</span></span>

* [<span data-ttu-id="2ad55-116">Начало работы с EF Core в веб-приложении MVC ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="2ad55-116">Get started with EF Core in an ASP.NET Core MVC web app</span></span>](intro.md)

## <a name="customize-the-details-page"></a><span data-ttu-id="2ad55-117">Настройка страницы сведений</span><span class="sxs-lookup"><span data-stu-id="2ad55-117">Customize the Details page</span></span>

<span data-ttu-id="2ad55-118">В шаблонном коде страницы указателя учащихся опущено свойство `Enrollments`, поскольку оно содержит коллекцию.</span><span class="sxs-lookup"><span data-stu-id="2ad55-118">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="2ad55-119">На странице **Details** (Сведения) содержимое коллекции отображается в таблице HTML.</span><span class="sxs-lookup"><span data-stu-id="2ad55-119">In the **Details** page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="2ad55-120">В методе действия *Controllers/StudentsController.cs* для представления Details используется метод `SingleOrDefaultAsync` для извлечения одной сущности `Student`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-120">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="2ad55-121">Добавьте код, который вызывает методы `Include`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-121">Add code that calls `Include`.</span></span> <span data-ttu-id="2ad55-122">`ThenInclude` и `AsNoTracking`, как показано ниже в выделенном коде.</span><span class="sxs-lookup"><span data-stu-id="2ad55-122">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]

<span data-ttu-id="2ad55-123">Методы `Include` и `ThenInclude` инструктируют контекст для загрузки свойства навигации `Student.Enrollments`, а также свойства навигации `Enrollment.Course` в пределах каждой регистрации.</span><span class="sxs-lookup"><span data-stu-id="2ad55-123">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="2ad55-124">Дополнительные сведения об этих методах см. в учебнике [Чтение связанных данных](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="2ad55-124">You'll learn more about these methods in the [read related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="2ad55-125">Метод `AsNoTracking` повышает производительность в тех сценариях, где возвращаемые сущности не будут обновляться во время существования текущего контекста.</span><span class="sxs-lookup"><span data-stu-id="2ad55-125">The `AsNoTracking` method improves performance in scenarios where the entities returned won't be updated in the current context's lifetime.</span></span> <span data-ttu-id="2ad55-126">Дополнительные сведения о методе `AsNoTracking` приводятся в конце этого учебника.</span><span class="sxs-lookup"><span data-stu-id="2ad55-126">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="2ad55-127">Данные маршрута</span><span class="sxs-lookup"><span data-stu-id="2ad55-127">Route data</span></span>

<span data-ttu-id="2ad55-128">Значение ключа, которое передается в метод `Details`, поступает из *данных маршрута*.</span><span class="sxs-lookup"><span data-stu-id="2ad55-128">The key value that's passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="2ad55-129">Данные маршрута обнаруживаются связывателем модели в сегменте URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="2ad55-129">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="2ad55-130">Например, маршрут по умолчанию задает сегменты контроллера, действия и идентификатора:</span><span class="sxs-lookup"><span data-stu-id="2ad55-130">For example, the default route specifies controller, action, and id segments:</span></span>

[!code-csharp[](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]

<span data-ttu-id="2ad55-131">В следующем URL-адресе маршрут по умолчанию сопоставляет контроллер Instructor, действие Index и идентификатор 1, которые принимаются в качестве значений данных маршрута.</span><span class="sxs-lookup"><span data-stu-id="2ad55-131">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="2ad55-132">Последняя часть URL-адреса ("?courseID=2021") представляет значение строки запроса.</span><span class="sxs-lookup"><span data-stu-id="2ad55-132">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="2ad55-133">Связыватель модели также будет передавать значение идентификатора в метод `Details` в параметр `id`, если вы передаете его в качестве значения строки запроса:</span><span class="sxs-lookup"><span data-stu-id="2ad55-133">The model binder will also pass the ID value to the `Details` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="2ad55-134">На странице Index URL-адреса гиперссылок создаются с помощью инструкций вспомогательной функции тегов в представлении Razor.</span><span class="sxs-lookup"><span data-stu-id="2ad55-134">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="2ad55-135">В следующем коде Razor параметр `id` соответствует маршруту по умолчанию, поэтому к данным маршрута добавляется `id`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-135">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="2ad55-136">Если `item.ID` равен 6, создается следующий код HTML:</span><span class="sxs-lookup"><span data-stu-id="2ad55-136">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="2ad55-137">В следующем коде Razor `studentID` не соответствует параметру в маршруте по умолчанию и добавляется в качестве строки запроса.</span><span class="sxs-lookup"><span data-stu-id="2ad55-137">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="2ad55-138">Если `item.ID` равен 6, создается следующий код HTML:</span><span class="sxs-lookup"><span data-stu-id="2ad55-138">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="2ad55-139">Дополнительные сведения о вспомогательных функциях тегов см. в разделе <xref:mvc/views/tag-helpers/intro>.</span><span class="sxs-lookup"><span data-stu-id="2ad55-139">For more information about tag helpers, see <xref:mvc/views/tag-helpers/intro>.</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="2ad55-140">Добавление регистраций в представление сведений</span><span class="sxs-lookup"><span data-stu-id="2ad55-140">Add enrollments to the Details view</span></span>

<span data-ttu-id="2ad55-141">Откройте *Views/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="2ad55-141">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="2ad55-142">Каждое поле отображается с помощью вспомогательных функций `DisplayNameFor` и `DisplayFor`, как показано в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="2ad55-142">Each field is displayed using `DisplayNameFor` and `DisplayFor` helpers, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="2ad55-143">После последнего поля и непосредственно перед закрывающим тегом `</dl>` добавьте следующий код, чтобы отобразить список регистраций:</span><span class="sxs-lookup"><span data-stu-id="2ad55-143">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="2ad55-144">Если после вставки кода нарушаются отступы в нем, нажмите клавиши CTRL-K-D, чтобы исправить это.</span><span class="sxs-lookup"><span data-stu-id="2ad55-144">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="2ad55-145">Этот код циклически обрабатывает сущности в свойстве навигации `Enrollments`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-145">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="2ad55-146">Для каждой регистрации он отображает название курса и оценку.</span><span class="sxs-lookup"><span data-stu-id="2ad55-146">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="2ad55-147">Название курса извлекается из сущности Course, которая хранится в свойстве навигации `Course` сущности Enrollments.</span><span class="sxs-lookup"><span data-stu-id="2ad55-147">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="2ad55-148">Запустите приложение, выберите вкладку **Students** (Учащиеся) и щелкните ссылку **Details** (Сведения) для учащегося.</span><span class="sxs-lookup"><span data-stu-id="2ad55-148">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="2ad55-149">Откроется список курсов и оценок для выбранного учащегося:</span><span class="sxs-lookup"><span data-stu-id="2ad55-149">You see the list of courses and grades for the selected student:</span></span>

![Страница сведений об учащемся](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="2ad55-151">Обновление страницы Create</span><span class="sxs-lookup"><span data-stu-id="2ad55-151">Update the Create page</span></span>

<span data-ttu-id="2ad55-152">В файле *StudentsController.cs* измените метод HttpPost `Create`, добавив в него блок try-catch и удалив идентификатор из атрибута `Bind`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-152">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]

<span data-ttu-id="2ad55-153">Этот код добавляет сущность Student, созданную связывателем модели ASP.NET Core MVC, в набор сущностей Students, после чего сохраняет изменения в базе данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-153">This code adds the Student entity created by the ASP.NET Core MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="2ad55-154">(Связыватель модели использует функциональные возможности ASP.NET Core MVC, упрощая работу с данными, которые вы предоставляете в форме. Связыватель модели преобразует значения из отправленной формы в типы CLR и передает их в виде параметров в метод действия.</span><span class="sxs-lookup"><span data-stu-id="2ad55-154">(Model binder refers to the ASP.NET Core MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="2ad55-155">В этом случае связыватель модели создает сущность Student, используя значения свойств из коллекции Form.)</span><span class="sxs-lookup"><span data-stu-id="2ad55-155">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="2ad55-156">`ID` удаляется из атрибута `Bind` в связи с тем, что он содержит значение первичного ключа, которое будет автоматически устанавливаться SQL Server при вставке строки.</span><span class="sxs-lookup"><span data-stu-id="2ad55-156">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="2ad55-157">Значение ID не задается на основе введенных пользователем данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-157">Input from the user doesn't set the ID value.</span></span>

<span data-ttu-id="2ad55-158">Помимо атрибута `Bind`, в шаблонном коде изменяется только блок try-catch.</span><span class="sxs-lookup"><span data-stu-id="2ad55-158">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="2ad55-159">Если во время сохранения изменений перехватывается исключение, производное от `DbUpdateException`, отображается сообщение об общей ошибке.</span><span class="sxs-lookup"><span data-stu-id="2ad55-159">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="2ad55-160">Исключения `DbUpdateException` иногда связаны с внешними факторами, а не с ошибкой при программировании приложения, поэтому рекомендуется попробовать повторить выполненные действия снова.</span><span class="sxs-lookup"><span data-stu-id="2ad55-160">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="2ad55-161">В этом примере такое поведение не реализовано, однако в рабочем приложении, как правило, исключения заносятся в журнал.</span><span class="sxs-lookup"><span data-stu-id="2ad55-161">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="2ad55-162">Дополнительные сведения см. в разделе **Ведение журналов для анализа** статьи [Мониторинг и телеметрия (построение реальных облачных приложений для Azure)](/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span><span class="sxs-lookup"><span data-stu-id="2ad55-162">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="2ad55-163">Атрибут `ValidateAntiForgeryToken` позволяет предотвратить атаки с подделкой межсайтовых запросов.</span><span class="sxs-lookup"><span data-stu-id="2ad55-163">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="2ad55-164">Токен автоматически вставляется в представление с помощью [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) и включается при отправке формы пользователем.</span><span class="sxs-lookup"><span data-stu-id="2ad55-164">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="2ad55-165">Токен проверяется по атрибуту `ValidateAntiForgeryToken`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-165">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="2ad55-166">Дополнительные сведения об атаках с подделкой межсайтовых запросов см. в разделе [Защита от подделки запросов](../../security/anti-request-forgery.md).</span><span class="sxs-lookup"><span data-stu-id="2ad55-166">For more information about CSRF, see [Anti-Request Forgery](../../security/anti-request-forgery.md).</span></span>

<a id="overpost"></a>
### <a name="security-note-about-overposting"></a><span data-ttu-id="2ad55-167">Примечание о безопасности в связи с атаками чрезмерной передачи данных</span><span class="sxs-lookup"><span data-stu-id="2ad55-167">Security note about overposting</span></span>

<span data-ttu-id="2ad55-168">Атрибут `Bind`, который включается шаблонным кодом в метод `Create`, является одним из способов защиты от чрезмерной передачи данных в сценариях создания.</span><span class="sxs-lookup"><span data-stu-id="2ad55-168">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="2ad55-169">Допустим, сущность Student включает свойство `Secret`, которое не требуется устанавливать на этой веб-странице.</span><span class="sxs-lookup"><span data-stu-id="2ad55-169">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="2ad55-170">Даже если на веб-странице отсутствует поле `Secret`, злоумышленник может использовать такие средства, как Fiddler, или собственный код JavaScript, для отправки значения формы `Secret`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-170">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="2ad55-171">Если отсутствует атрибут `Bind`, ограничивающий поля, которые связыватель модели использует при создании экземпляра Student, связыватель модели выберет это значение формы `Secret` и использует его для создания экземпляра сущности Student.</span><span class="sxs-lookup"><span data-stu-id="2ad55-171">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="2ad55-172">Таким образом, какое бы значение ни задал злоумышленник для поля `Secret`, оно будет обновлено в базе данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-172">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="2ad55-173">На следующем рисунке показано средство Fiddler, с помощью которого в отправленные значения формы добавляется поле `Secret` (со значением "OverPost").</span><span class="sxs-lookup"><span data-stu-id="2ad55-173">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Добавление поля Secret с помощью средства Fiddler](crud/_static/fiddler.png)

<span data-ttu-id="2ad55-175">После этого значение "OverPost" будет успешно добавлено в свойство `Secret` вставленной строки, хотя вы не разрешали установку этого свойства на веб-странице.</span><span class="sxs-lookup"><span data-stu-id="2ad55-175">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="2ad55-176">Чтобы предотвратить чрезмерную передачу данных в сценариях редактирования, можно сначала считать сущность из базы данных и затем вызвать метод `TryUpdateModel`, передав в него список явно разрешенных свойств.</span><span class="sxs-lookup"><span data-stu-id="2ad55-176">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="2ad55-177">Именно этот метод используется в этих учебниках.</span><span class="sxs-lookup"><span data-stu-id="2ad55-177">That's the method used in these tutorials.</span></span>

<span data-ttu-id="2ad55-178">Кроме того, многие разработчики предпочитают для защиты от чрезмерной передачи данных использовать модели представлений вместо классов сущностей с привязкой моделей.</span><span class="sxs-lookup"><span data-stu-id="2ad55-178">An alternative way to prevent overposting that's preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="2ad55-179">Включайте только те свойства, которые требуется обновлять в модели представления.</span><span class="sxs-lookup"><span data-stu-id="2ad55-179">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="2ad55-180">После завершения работы связывателя модели MVC скопируйте свойства модели представления в экземпляр сущности, например с помощью такого средства, как AutoMapper.</span><span class="sxs-lookup"><span data-stu-id="2ad55-180">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="2ad55-181">С помощью `_context.Entry` в экземпляре сущности задайте для него состояние `Unchanged`, после чего присвойте значение true атрибуту `Property("PropertyName").IsModified` для каждого свойства, которое включается в модель представления.</span><span class="sxs-lookup"><span data-stu-id="2ad55-181">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that's included in the view model.</span></span> <span data-ttu-id="2ad55-182">Этот метод подходит для сценариев редактирования и создания.</span><span class="sxs-lookup"><span data-stu-id="2ad55-182">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="2ad55-183">Проверка страницы создания</span><span class="sxs-lookup"><span data-stu-id="2ad55-183">Test the Create page</span></span>

<span data-ttu-id="2ad55-184">Для каждого поля в коде в *Views/Students/Create.cshtml* используются вспомогательные функции тегов `label`, `input` и `span` (для сообщений о проверке).</span><span class="sxs-lookup"><span data-stu-id="2ad55-184">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="2ad55-185">Запустите приложение, выберите вкладку **Students** (Учащиеся) и щелкните **Create New** (Создать).</span><span class="sxs-lookup"><span data-stu-id="2ad55-185">Run the app, select the **Students** tab, and click **Create New**.</span></span>

<span data-ttu-id="2ad55-186">Введите имена и даты.</span><span class="sxs-lookup"><span data-stu-id="2ad55-186">Enter names and a date.</span></span> <span data-ttu-id="2ad55-187">Если браузер допускает это, попробуйте ввести недопустимую дату.</span><span class="sxs-lookup"><span data-stu-id="2ad55-187">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="2ad55-188">(В некоторых браузерах принудительно используется управляющий элемент выбора даты.) Щелкните **Create** (Создать), чтобы просмотреть сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="2ad55-188">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Ошибка проверки даты](crud/_static/date-error.png)

<span data-ttu-id="2ad55-190">Эта проверка по умолчанию выполняется на стороне сервера. Позднее в учебнике вы узнаете, как добавлять атрибуты, которые будут создавать код для проверки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="2ad55-190">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="2ad55-191">В выделенном ниже коде демонстрируется проверка модели в методе `Create`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-191">The following highlighted code shows the model validation check in the `Create` method.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]

<span data-ttu-id="2ad55-192">Измените дату на допустимую и щелкните **Create** (Создать), чтобы добавить нового учащегося на страницу **Index** (Указатель).</span><span class="sxs-lookup"><span data-stu-id="2ad55-192">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="2ad55-193">Обновление страницы редактирования</span><span class="sxs-lookup"><span data-stu-id="2ad55-193">Update the Edit page</span></span>

<span data-ttu-id="2ad55-194">В файле *StudentController.cs* метод HttpGet `Edit` (метод без атрибута `HttpPost`) использует метод `SingleOrDefaultAsync` для извлечения выбранной сущности Student, как показано в методе `Details`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-194">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="2ad55-195">Изменять этот метод не нужно.</span><span class="sxs-lookup"><span data-stu-id="2ad55-195">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="2ad55-196">Рекомендуемый код метода HttpPost Edit: чтение и изменение</span><span class="sxs-lookup"><span data-stu-id="2ad55-196">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="2ad55-197">Замените метод действия HttpPost Edit следующим кодом.</span><span class="sxs-lookup"><span data-stu-id="2ad55-197">Replace the HttpPost Edit action method with the following code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]

<span data-ttu-id="2ad55-198">Благодаря этому изменению реализуются рекомендации по безопасности, позволяющие предотвратить чрезмерную отправку данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-198">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="2ad55-199">Шаблон создал атрибут `Bind` и добавил сущность, созданную связывателем модели, в набор сущностей с флагом `Modified`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-199">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="2ad55-200">В большинстве сценариев не рекомендуется использовать этот код, поскольку атрибут `Bind` очищает любые ранее существовавшие данные в полях, которые не перечислены в параметре `Include`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-200">That code isn't recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="2ad55-201">Новый код считывает существующую сущность и вызывает метод `TryUpdateModel` для обновления полей в извлеченной сущности [на основании данных, введенных пользователем в отправленной форме](xref:mvc/models/model-binding#how-model-binding-works).</span><span class="sxs-lookup"><span data-stu-id="2ad55-201">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding#how-model-binding-works).</span></span> <span data-ttu-id="2ad55-202">Технология автоматического отслеживания изменений платформы Entity Framework устанавливает флаг `Modified` для полей, которые были изменены на основе введенных в форму данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-202">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="2ad55-203">При вызове метода `SaveChanges` платформа Entity Framework создает инструкции SQL для обновления строки базы данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-203">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="2ad55-204">Конфликты параллелизма игнорируются, а в базе данных обновляются только те столбцы таблицы, которые были обновлены пользователем.</span><span class="sxs-lookup"><span data-stu-id="2ad55-204">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="2ad55-205">(Порядок обработки конфликтов параллелизма будет показан позднее в учебнике.)</span><span class="sxs-lookup"><span data-stu-id="2ad55-205">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="2ad55-206">Чтобы предотвратить чрезмерную передачу данных, рекомендуется добавить поля, которые требуется обновлять на странице **Edit**, в список разрешенных в параметрах `TryUpdateModel`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-206">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="2ad55-207">(Пустая строка перед списком полей в списке параметров предназначена для префикса, который используется с именами полей формы.) На данный момент другие поля не защищаются. Если включить в список поля, которые должен привязывать связыватель модели, это позволяет гарантировать, что при добавлении полей в модель данных в будущем они будут автоматически защищаться до тех пор, пока вы явно не добавите их сюда.</span><span class="sxs-lookup"><span data-stu-id="2ad55-207">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="2ad55-208">В результате этих изменений сигнатура метода HttpPost `Edit` будет совпадать с методом HttpGet `Edit`. Таким образом, вы просто переименовали метод `EditPost`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-208">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="2ad55-209">Альтернативный код метода HttpPost Edit: Создание и присоединение</span><span class="sxs-lookup"><span data-stu-id="2ad55-209">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="2ad55-210">Рекомендуемый код метода HttpPost гарантирует обновление только измененных столбцов и сохраняет данные в свойствах, которые не требуется включать в привязку моделей.</span><span class="sxs-lookup"><span data-stu-id="2ad55-210">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="2ad55-211">Тем не менее при подходе с предварительным считыванием дополнительно выполняется чтение из базы данных, в результате чего код может усложняться для обработки конфликтов параллелизма.</span><span class="sxs-lookup"><span data-stu-id="2ad55-211">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="2ad55-212">В качестве альтернативы можно присоединить сущность, созданную связывателем модели, к контексту EF и пометить ее как измененную.</span><span class="sxs-lookup"><span data-stu-id="2ad55-212">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="2ad55-213">(Не добавляйте этот код в проект, поскольку он показан исключительно как пример альтернативного подхода.)</span><span class="sxs-lookup"><span data-stu-id="2ad55-213">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]

<span data-ttu-id="2ad55-214">Этот подход можно использовать в тех случаях, когда пользовательский интерфейс веб-страницы включает все поля сущности и может обновлять любые из них.</span><span class="sxs-lookup"><span data-stu-id="2ad55-214">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="2ad55-215">Шаблонный код используется подход с созданием и присоединением, однако лишь перехватывает исключения `DbUpdateConcurrencyException` и возвращает коды ошибок 404.</span><span class="sxs-lookup"><span data-stu-id="2ad55-215">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="2ad55-216">В показанном примере перехватываются любые исключения обновления базы данных и отображается сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="2ad55-216">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="2ad55-217">Состояния сущностей</span><span class="sxs-lookup"><span data-stu-id="2ad55-217">Entity States</span></span>

<span data-ttu-id="2ad55-218">Контекст базы данных отслеживает состояние синхронизации сущностей в памяти с соответствующими им строками в базе данных. Данные отслеживания определяют, что происходит при вызове метода `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-218">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="2ad55-219">Например, при передаче новой сущности в метод `Add` ей присваивается состояние `Added`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-219">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="2ad55-220">При последующем вызове метода `SaveChanges` контекст базы данных выполняет команду SQL INSERT.</span><span class="sxs-lookup"><span data-stu-id="2ad55-220">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="2ad55-221">Возможны следующие состояния сущности:</span><span class="sxs-lookup"><span data-stu-id="2ad55-221">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="2ad55-222">`Added`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-222">`Added`.</span></span> <span data-ttu-id="2ad55-223">Сущность еще не существует в базе данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-223">The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="2ad55-224">Метод `SaveChanges` выполняет инструкцию INSERT.</span><span class="sxs-lookup"><span data-stu-id="2ad55-224">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="2ad55-225">`Unchanged`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-225">`Unchanged`.</span></span> <span data-ttu-id="2ad55-226">С этой сущностью не нужно выполнять никакие действия с помощью метода `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-226">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="2ad55-227">Это начальный статус сущности, который она имеет при чтении из базы данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-227">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="2ad55-228">`Modified`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-228">`Modified`.</span></span> <span data-ttu-id="2ad55-229">Были изменены значения некоторых или всех свойств сущности.</span><span class="sxs-lookup"><span data-stu-id="2ad55-229">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="2ad55-230">Метод `SaveChanges` выполняет инструкцию UPDATE.</span><span class="sxs-lookup"><span data-stu-id="2ad55-230">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="2ad55-231">`Deleted`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-231">`Deleted`.</span></span> <span data-ttu-id="2ad55-232">Сущность отмечена для удаления.</span><span class="sxs-lookup"><span data-stu-id="2ad55-232">The entity has been marked for deletion.</span></span> <span data-ttu-id="2ad55-233">Метод `SaveChanges` выполняет инструкцию DELETE.</span><span class="sxs-lookup"><span data-stu-id="2ad55-233">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="2ad55-234">`Detached`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-234">`Detached`.</span></span> <span data-ttu-id="2ad55-235">Сущность не отслеживается контекстом базы данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-235">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="2ad55-236">В классическом приложении изменения состояния обычно осуществляются автоматически.</span><span class="sxs-lookup"><span data-stu-id="2ad55-236">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="2ad55-237">Например, вы можете считать сущность и изменить значения некоторых ее свойств.</span><span class="sxs-lookup"><span data-stu-id="2ad55-237">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="2ad55-238">В этом случае состояние сущности автоматически изменится на `Modified`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-238">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="2ad55-239">Если затем вызвать метод `SaveChanges`, платформа Entity Framework выполнит инструкцию SQL UPDATE, которая обновит только фактически измененные свойства.</span><span class="sxs-lookup"><span data-stu-id="2ad55-239">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="2ad55-240">В веб-приложении объект `DbContext`, который изначально считывает сущность и отображает ее данные для редактирования, ликвидируется после отрисовки страницы.</span><span class="sxs-lookup"><span data-stu-id="2ad55-240">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="2ad55-241">При вызове метода действия HttpPost `Edit` выполняется новый веб-запрос и создается новый экземпляр `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-241">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="2ad55-242">Если повторно считать сущность в этот новый контекст, таким образом будет смоделирована обработка в классическом приложении.</span><span class="sxs-lookup"><span data-stu-id="2ad55-242">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="2ad55-243">Однако если выполнять дополнительную операцию чтения не требуется, необходимо использовать объект сущности, созданный связывателем модели.</span><span class="sxs-lookup"><span data-stu-id="2ad55-243">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="2ad55-244">Для этого проще всего присвоить сущности состояние Modified, как это сделано в показанном ранее альтернативном методе HttpPost Edit.</span><span class="sxs-lookup"><span data-stu-id="2ad55-244">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="2ad55-245">При последующем вызове метода `SaveChanges` платформа Entity Framework обновляет все столбцы в строке базы данных, поскольку у контекста нет возможности определить, какие свойства были изменены.</span><span class="sxs-lookup"><span data-stu-id="2ad55-245">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="2ad55-246">Если вы не хотите сначала выполнять чтение, но вам нужно, чтобы инструкция SQL UPDATE обновляла только те поля, которые пользователь фактически изменяет, код будет выглядеть более сложным.</span><span class="sxs-lookup"><span data-stu-id="2ad55-246">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="2ad55-247">Вам необходимо каким-либо образом сохранить исходные значения (например, используя скрытые поля), чтобы они были доступны при вызове метода HttpPost `Edit`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-247">You have to save the original values in some way (such as by using hidden fields) so that they're available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="2ad55-248">Затем вы можете создать сущность Student, используя исходные значения, вызвать метод `Attach` с исходной версией этой сущности, обновить значения сущности и вызвать метод `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-248">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="2ad55-249">Проверка страницы редактирования</span><span class="sxs-lookup"><span data-stu-id="2ad55-249">Test the Edit page</span></span>

<span data-ttu-id="2ad55-250">Запустите приложение, выберите вкладку **Students** (Учащиеся) и щелкните гиперссылку **Edit** (Изменить).</span><span class="sxs-lookup"><span data-stu-id="2ad55-250">Run the app, select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Страница редактирования учащихся](crud/_static/student-edit.png)

<span data-ttu-id="2ad55-252">Измените определенные данные и нажмите кнопку **Save** (Сохранить).</span><span class="sxs-lookup"><span data-stu-id="2ad55-252">Change some of the data and click **Save**.</span></span> <span data-ttu-id="2ad55-253">Откроется страница **Index** (Указатель), на которой будут представлены измененные данные.</span><span class="sxs-lookup"><span data-stu-id="2ad55-253">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="2ad55-254">Обновление страницы удаления</span><span class="sxs-lookup"><span data-stu-id="2ad55-254">Update the Delete page</span></span>

<span data-ttu-id="2ad55-255">В файле *StudentController.cs* в коде шаблона для метода HttpGet `Delete` используется метод `SingleOrDefaultAsync` для извлечения выбранной сущности Student, как показано в методах Details и Edit.</span><span class="sxs-lookup"><span data-stu-id="2ad55-255">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="2ad55-256">Тем не менее, чтобы реализовать настраиваемое сообщение об ошибке при сбое вызова метода `SaveChanges`, необходимо добавить некоторые функции в этот метод и соответствующее ему представление.</span><span class="sxs-lookup"><span data-stu-id="2ad55-256">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="2ad55-257">Как и в случае с операциями обновления и создания, операции удаления требуют двух методов действия.</span><span class="sxs-lookup"><span data-stu-id="2ad55-257">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="2ad55-258">Метод, вызываемый в ответ на запрос GET, отображает представление, в котором пользователь может подтвердить или отменить операцию удаления.</span><span class="sxs-lookup"><span data-stu-id="2ad55-258">The method that's called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="2ad55-259">Если пользователь подтверждает ее, создается запрос POST.</span><span class="sxs-lookup"><span data-stu-id="2ad55-259">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="2ad55-260">В этом случае вызывается метод HttpPost `Delete`, который фактически выполняет операцию удаления.</span><span class="sxs-lookup"><span data-stu-id="2ad55-260">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="2ad55-261">Для обработки ошибок, которые могут произойти при обновлении базы данных, следует добавить в метод HttpPost `Delete` блок try-catch.</span><span class="sxs-lookup"><span data-stu-id="2ad55-261">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="2ad55-262">В случае ошибки метод HttpPost Delete вызывает метод HttpGet Delete, передавая в него параметр, указывающий на состояние ошибки.</span><span class="sxs-lookup"><span data-stu-id="2ad55-262">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="2ad55-263">Метод HttpGet Delete повторно отображает страницу подтверждения и сообщение об ошибке, предлагая пользователю отменить операцию или повторить ее еще раз.</span><span class="sxs-lookup"><span data-stu-id="2ad55-263">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="2ad55-264">Замените метод действия HttpGet `Delete` следующим кодом, в котором реализуется управление сообщениями об ошибках.</span><span class="sxs-lookup"><span data-stu-id="2ad55-264">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]

<span data-ttu-id="2ad55-265">Этот код принимает необязательный параметр, который указывает, был ли метод вызван после сбоя при сохранении изменений.</span><span class="sxs-lookup"><span data-stu-id="2ad55-265">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="2ad55-266">Если перед вызовом метода HttpGet `Delete` не произошел сбой, этот параметр будет иметь значение false.</span><span class="sxs-lookup"><span data-stu-id="2ad55-266">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="2ad55-267">Если он вызывается методом HttpPost `Delete` в ответ на ошибку при обновлении базы данных, этот параметр будет иметь значение true, а в представление передается сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="2ad55-267">When it's called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="2ad55-268">Подход с предварительным чтением для метода HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="2ad55-268">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="2ad55-269">Замените метод действия HttpPost `Delete` (имеет имя `DeleteConfirmed`) следующим кодом, в котором выполняется фактическая операция удаления и перехватываются любые ошибки при обновлении базы данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-269">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]

<span data-ttu-id="2ad55-270">Этот код извлекает выбранную сущность и вызывает метод `Remove`, чтобы присвоить ей состояние `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-270">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="2ad55-271">При вызове метода `SaveChanges` создается инструкция SQL DELETE.</span><span class="sxs-lookup"><span data-stu-id="2ad55-271">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="2ad55-272">Подход с созданием и присоединением для метода HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="2ad55-272">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="2ad55-273">Если требуется обеспечить максимальную производительность крупного приложения, можно избежать создания ненужных запросов SQL. Для этого можно создать экземпляр сущности Student, используя только значение первичного ключа, и затем присвоить этой сущности состояние `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-273">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="2ad55-274">Это все, что платформе Entity Framework необходимо для удаления сущности.</span><span class="sxs-lookup"><span data-stu-id="2ad55-274">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="2ad55-275">(Не используйте этот код в проекте. Он показан здесь исключительно в качестве примера.)</span><span class="sxs-lookup"><span data-stu-id="2ad55-275">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]

<span data-ttu-id="2ad55-276">Если также требуется удалить связанные с сущностью данные, убедитесь, что в базе данных настроено каскадное удаление.</span><span class="sxs-lookup"><span data-stu-id="2ad55-276">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="2ad55-277">При таком подходе к удалению сущности платформе EF может быть неизвестно о наличии связанных сущностей, которые требуется удалить.</span><span class="sxs-lookup"><span data-stu-id="2ad55-277">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="2ad55-278">Обновление представления удаления</span><span class="sxs-lookup"><span data-stu-id="2ad55-278">Update the Delete view</span></span>

<span data-ttu-id="2ad55-279">В файле *Views/Student/Delete.cshtml* добавьте сообщение об ошибке между заголовками h2 и h3, как показано в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="2ad55-279">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="2ad55-280">Запустите приложение, выберите вкладку **Students** (Учащиеся) и щелкните гиперссылку **Delete** (Удалить):</span><span class="sxs-lookup"><span data-stu-id="2ad55-280">Run the app, select the **Students** tab, and click a **Delete** hyperlink:</span></span>

![Страница подтверждения удаления](crud/_static/student-delete.png)

<span data-ttu-id="2ad55-282">Щелкните **Delete** (Удалить).</span><span class="sxs-lookup"><span data-stu-id="2ad55-282">Click **Delete**.</span></span> <span data-ttu-id="2ad55-283">Отображается страница Index (Указатель), на которой удаленный учащийся будет отсутствовать.</span><span class="sxs-lookup"><span data-stu-id="2ad55-283">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="2ad55-284">(В учебнике, посвященном параллелизму, приводится пример кода обработки ошибок.)</span><span class="sxs-lookup"><span data-stu-id="2ad55-284">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="close-database-connections"></a><span data-ttu-id="2ad55-285">Закрытие подключений к базам данных</span><span class="sxs-lookup"><span data-stu-id="2ad55-285">Close database connections</span></span>

<span data-ttu-id="2ad55-286">Чтобы высвободить ресурсы, используемые подключением к базе данных, необходимо как можно скорее ликвидировать экземпляр контекста после завершения работы с ним.</span><span class="sxs-lookup"><span data-stu-id="2ad55-286">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="2ad55-287">Эта задача реализуется с помощью встроенной в ASP.NET Core технологии [внедрения зависимостей](../../fundamentals/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="2ad55-287">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="2ad55-288">В файле *Startup.cs* вызывается [метод расширения AddDbContext](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs), чтобы подготовить класс `DbContext` в контейнере ASP.NET Core DI.</span><span class="sxs-lookup"><span data-stu-id="2ad55-288">In *Startup.cs*, you call the [AddDbContext extension method](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET Core DI container.</span></span> <span data-ttu-id="2ad55-289">Этот метод по умолчанию устанавливает время существования службы `Scoped`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-289">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="2ad55-290">Значение `Scoped` указывает, что срок существования объекта контекста соответствует сроку существования веб-запроса. Таким образом, по завершении веб-запроса автоматически будет вызываться метод `Dispose`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-290">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handle-transactions"></a><span data-ttu-id="2ad55-291">Обработка транзакций</span><span class="sxs-lookup"><span data-stu-id="2ad55-291">Handle transactions</span></span>

<span data-ttu-id="2ad55-292">По умолчанию платформа Entity Framework реализует транзакции неявно.</span><span class="sxs-lookup"><span data-stu-id="2ad55-292">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="2ad55-293">В сценариях, когда вы вносите изменения в несколько строк или таблиц и затем вызываете метод `SaveChanges`, платформа Entity Framework автоматически гарантирует, что одновременно все изменения либо выполняются успешно, либо завершаются неудачно.</span><span class="sxs-lookup"><span data-stu-id="2ad55-293">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="2ad55-294">Если ошибка происходит после того, как были выполнены некоторые изменения, эти изменения автоматически откатываются.</span><span class="sxs-lookup"><span data-stu-id="2ad55-294">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="2ad55-295">Если вам требуется дополнительный контроль, например в сценариях с операциями, выполняемыми в транзакции вне платформы Entity Framework, ознакомьтесь с разделом [Транзакции](/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="2ad55-295">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="2ad55-296">Отключение отслеживания запросов</span><span class="sxs-lookup"><span data-stu-id="2ad55-296">No-tracking queries</span></span>

<span data-ttu-id="2ad55-297">Когда контекст базы данных извлекает строки таблицы и создает представляющие их объекты сущностей, по умолчанию отслеживается состояние синхронизации сущностей в памяти с содержимым базы данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-297">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="2ad55-298">При обновлении сущности данные в памяти выступают в роли кэша.</span><span class="sxs-lookup"><span data-stu-id="2ad55-298">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="2ad55-299">В веб-приложении такое кэширование часто не нужно, поскольку экземпляры контекста, как правило, существуют недолго (для каждого запроса создается и ликвидируется собственный экземпляр), и контекст, считывающий сущность, как правило, ликвидируется до того, как сущность будет использована снова.</span><span class="sxs-lookup"><span data-stu-id="2ad55-299">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="2ad55-300">Чтобы отключить отслеживание объектов сущностей в памяти, вызовите метод `AsNoTracking`.</span><span class="sxs-lookup"><span data-stu-id="2ad55-300">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="2ad55-301">Как правило, это требуется в следующих сценариях:</span><span class="sxs-lookup"><span data-stu-id="2ad55-301">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="2ad55-302">В течение срока существования контекста не требуется обновлять сущности, и не нужно, чтобы платформа EF [автоматически загружала свойства навигации с сущностями, извлекаемыми с помощью отдельных запросов](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="2ad55-302">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="2ad55-303">Эти условия часто выполняются в методах действия контроллера HttpGet.</span><span class="sxs-lookup"><span data-stu-id="2ad55-303">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="2ad55-304">Выполняется запрос, который извлекает большой объем данных, и при этом обновляется только небольшая часть возвращаемых данных.</span><span class="sxs-lookup"><span data-stu-id="2ad55-304">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="2ad55-305">Для повышения эффективности можно отключить отслеживание для больших запросов и выполнить запрос позднее для нескольких обновляемых сущностей.</span><span class="sxs-lookup"><span data-stu-id="2ad55-305">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="2ad55-306">Необходимо присоединить запрос для его обновления, однако ранее та же сущность уже была извлечена для других целей.</span><span class="sxs-lookup"><span data-stu-id="2ad55-306">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="2ad55-307">Поскольку сущность уже отслеживается контекстом базы данных, присоединить сущность, которую требуется изменить, нельзя.</span><span class="sxs-lookup"><span data-stu-id="2ad55-307">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="2ad55-308">Одним из решений в такой ситуации является вызов метода `AsNoTracking` для предшествующего запроса.</span><span class="sxs-lookup"><span data-stu-id="2ad55-308">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="2ad55-309">Дополнительные сведения см. в разделе [Работа с отслеживанием и и без него](/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="2ad55-309">For more information, see [Tracking vs. No-Tracking](/ef/core/querying/tracking).</span></span>

## <a name="get-the-code"></a><span data-ttu-id="2ad55-310">Получение кода</span><span class="sxs-lookup"><span data-stu-id="2ad55-310">Get the code</span></span>

[<span data-ttu-id="2ad55-311">Скачайте или ознакомьтесь с готовым приложением.</span><span class="sxs-lookup"><span data-stu-id="2ad55-311">Download or view the completed application.</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/data/ef-mvc/intro/samples/cu-final)

## <a name="next-steps"></a><span data-ttu-id="2ad55-312">Следующие шаги</span><span class="sxs-lookup"><span data-stu-id="2ad55-312">Next steps</span></span>

<span data-ttu-id="2ad55-313">В этом учебнике рассмотрены следующие задачи.</span><span class="sxs-lookup"><span data-stu-id="2ad55-313">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="2ad55-314">Настройка страницы сведений</span><span class="sxs-lookup"><span data-stu-id="2ad55-314">Customized the Details page</span></span>
> * <span data-ttu-id="2ad55-315">Обновление страницы создания</span><span class="sxs-lookup"><span data-stu-id="2ad55-315">Updated the Create page</span></span>
> * <span data-ttu-id="2ad55-316">Обновление страницы редактирования</span><span class="sxs-lookup"><span data-stu-id="2ad55-316">Updated the Edit page</span></span>
> * <span data-ttu-id="2ad55-317">Обновление страницы удаления</span><span class="sxs-lookup"><span data-stu-id="2ad55-317">Updated the Delete page</span></span>
> * <span data-ttu-id="2ad55-318">Закрытие подключений к базам данных</span><span class="sxs-lookup"><span data-stu-id="2ad55-318">Closed database connections</span></span>

<span data-ttu-id="2ad55-319">В следующем руководстве описано, как добавить на страницу **Index** (Указатель) функции добавления, сортировки, фильтрации и разбиения на страницы.</span><span class="sxs-lookup"><span data-stu-id="2ad55-319">Advance to the next article to learn how to expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="2ad55-320">Сортировка, фильтрация и разбиение на страницы</span><span class="sxs-lookup"><span data-stu-id="2ad55-320">Sorting, filtering, and paging</span></span>](sort-filter-page.md)
