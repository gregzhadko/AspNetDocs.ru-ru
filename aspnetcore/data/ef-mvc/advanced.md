---
title: Учебник. Сведения о сложных сценариях для ASP.NET MVC с EF Core
description: В этом учебнике описываются полезные рекомендации по расширенным возможностям разработки веб-приложений ASP.NET Core, использующих платформу Entity Framework Core.
author: rick-anderson
ms.author: tdykstra
ms.custom: mvc
ms.date: 02/05/2019
ms.topic: tutorial
uid: data/ef-mvc/advanced
ms.openlocfilehash: f02aa1d6d8e431e7e2613835b3216786aed4ecd4
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57064671"
---
# <a name="tutorial-learn-about-advanced-scenarios---aspnet-mvc-with-ef-core"></a>Учебник. Сведения о сложных сценариях для ASP.NET MVC с EF Core

В предыдущем учебнике было реализовано наследование типа "одна таблица на иерархию". В этом учебнике описываются некоторые расширенные возможности, не относящиеся к базовой разработке веб-приложений ASP.NET Core, использующих платформу Entity Framework Core.

В этом учебнике рассмотрены следующие задачи.

> [!div class="checklist"]
> * Выполнение прямых SQL-запросов
> * Вызов запроса для получения сущностей
> * Вызов запроса для получения других типов
> * Вызов запроса на обновление
> * Изучение SQL-запросов
> * Создание уровня абстракции
> * Сведения об автоматическом обнаружении изменений
> * Сведения об исходном коде EF Core и планах разработки
> * Сведения об использовании динамических запросов LINQ для упрощения кода

## <a name="prerequisites"></a>Предварительные требования

* Выполните инструкции из руководства [ASP.NET Core MVC с EF Core — наследование — 9 из 10](inheritance.md)

## <a name="perform-raw-sql-queries"></a>Выполнение прямых SQL-запросов

Одним из преимуществ использования платформы Entity Framework является возможность избежать слишком тесной привязки кода к конкретному способу хранения данных. Это достигается путем автоматического создания запросов и команд SQL, что позволяет упростить написание кода. Тем не менее в редких случаях требуется выполнять созданные вручную SQL-запросы. Для таких сценариев в API Entity Framework Code First включены методы, позволяющие передавать команды SQL напрямую в базу данных. В EF Core 1.0 доступны следующие варианты:

* Использование метода `DbSet.FromSql` для запросов, которые возвращают типы сущностей. Возвращаемые объекты должны иметь тип, ожидаемый объектом `DbSet`, и автоматически отслеживаются контекстом базы данных, кроме случаев, когда [отслеживание отключено](crud.md#no-tracking-queries).

* Использование `Database.ExecuteSqlCommand` для команд, не относящихся к запросам.

Если вам необходимо выполнить запрос, который возвращает типы, не являющиеся сущностями, можно использовать ADO.NET с подключением к базе данных, предоставленным платформой EF. Возвращаемые данные не отслеживаются контекстом базы данных, даже если вы используете этот метод для извлечения типов сущностей.

Как и всегда при выполнении команд SQL в веб-приложении, необходимо принимать меры предосторожности для защиты сайта от атак путем внедрения кода SQL. Одним из способов защиты является применение параметризованных запросов, которые гарантируют, что строки, отправляемые веб-страницей, не могут быть интерпретированы как команды SQL. В рамках этого учебника вы будете использовать параметризованные запросы при интеграции вводимых пользователем данных в запрос.

## <a name="call-a-query-to-return-entities"></a>Вызов запроса для получения сущностей

Класс `DbSet<TEntity>` предоставляет метод, который можно использовать для выполнения запроса, возвращающего сущность типа `TEntity`. Чтобы увидеть, как это работает, измените код в методе `Details` для контроллера Department.

В файле *DepartmentsController.cs* в методе `Details` замените код, извлекающий кафедру, вызовом метода `FromSql`, как показано ниже в выделенном коде:

[!code-csharp[](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_RawSQL&highlight=8,9,10,13)]

Чтобы убедиться, что новый код работает правильно, выберите вкладку **Departments** (Кафедры) и щелкните **Details** (Сведения) для одной из кафедр.

![Сведения о кафедре](advanced/_static/department-details.png)

## <a name="call-a-query-to-return-other-types"></a>Вызов запроса для получения других типов

Ранее вы создали таблицу статистики учащихся на странице сведений, в которой было показано число учащихся на каждую дату регистрации. Вы получали эти данные из набора сущностей Students (`_context.Students`) и использовали LINQ, чтобы спроецировать результаты в список объектов модели представления `EnrollmentDateGroup`. Предположим, что вы хотите написать код SQL вместо использования LINQ. Для этого вам необходимо выполнить SQL-запрос, который возвращает объекты, не являющиеся сущностями. В EF Core 1.0 одним из способов сделать это является написание кода ADO.NET и получение подключения к базе данных из EF.

В файле *HomeController.cs* замените метод `About` следующим кодом:

[!code-csharp[](intro/samples/cu/Controllers/HomeController.cs?name=snippet_UseRawSQL&highlight=3-32)]

Добавьте инструкцию using:

[!code-csharp[](intro/samples/cu/Controllers/HomeController.cs?name=snippet_Usings2)]

Запустите приложение и перейдите на страницу About. На экран будут выведены те же данные, что и ранее.

![Страница About](advanced/_static/about.png)

## <a name="call-an-update-query"></a>Вызов запроса на обновление

Предположим, что администраторам университета Suppose необходимо внести глобальные изменения в базу данных, например изменить число зачетных баллов для каждого курса. Поскольку в университете ведется множество курсов, будет неэффективно извлекать их в виде сущностей и изменять по отдельности. В этом разделе вы реализуете веб-страницу, на которой пользователь может задать множитель, который будет применен к числу зачетных баллов для каждого курса, после чего изменения будут внесены с помощью инструкции SQL UPDATE. Веб-страница должна выглядеть так, как показано на следующем рисунке:

![Страница обновления числа зачетных баллов для курсов](advanced/_static/update-credits.png)

В файле *CoursesContoller.cs* добавьте методы UpdateCourseCredits для HttpGet и HttpPost:

[!code-csharp[](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_UpdateGet)]

[!code-csharp[](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_UpdatePost)]

Когда контроллер обрабатывает запрос HttpGet, в `ViewData["RowsAffected"]` ничего не возвращается, а в представлении отображается пустое текстовое поле и кнопка отправки, как показано на предыдущем рисунке.

При нажатии кнопки **Update** (Обновить) вызывается метод HttpPost, а множителю присваивается значение, введенное в текстовое поле. После этого код выполняет SQL-запрос, который обновляет курсы и возвращает число затронутых строк в представление в `ViewData`. После того как в представление передано значение `RowsAffected`, оно отображает число обновленных строк.

В **обозревателе решений** щелкните правой кнопкой мыши папку *Views/Courses* и выберите **Добавить > Новый элемент**.

В диалоговом окне **Добавление нового элемента** щелкните элемент **ASP.NET Core** в разделе **Установленные** в области слева, выберите **Представление Razor** и присвойте новому представлению имя *UpdateCourseCredits.cshtml*.

В файле *Views/Courses/UpdateCourseCredits.cshtml* замените код шаблона следующим кодом:

[!code-html[](intro/samples/cu/Views/Courses/UpdateCourseCredits.cshtml)]

Выполните метод `UpdateCourseCredits`, выбрав вкладку **Courses** (Курсы), а затем добавив "/UpdateCourseCredits" в конец URL-адреса в адресной строке браузера (например, `http://localhost:5813/Courses/UpdateCourseCredits`). Введите число в текстовое поле:

![Страница обновления числа зачетных баллов для курсов](advanced/_static/update-credits.png)

Нажмите кнопку **Обновить**. Отобразится число обработанных строк:

![Число затронутых строк на странице обновления числа зачетных баллов для курсов](advanced/_static/update-credits-rows-affected.png)

Нажмите кнопку **Back to List** (Вернуться к списку), чтобы просмотреть список курсов с измененным числом зачетных баллов.

Обратите внимание, что в рабочем коде необходимо всегда проверять допустимость новых данных. В приведенном здесь упрощенном коде в результате применения множителя могут получиться значения больше 5. (Свойство `Credits` имеет атрибут `[Range(0, 5)]`.) Запрос на обновление будет выполнен, однако из-за недопустимых данных в других частях системы, в которых число зачетных баллов должно быть не больше 5, могут возникать неожиданные результаты.

Дополнительные сведения о необработанных SQL-запросах см. в разделе [Необработанные SQL-запросы](/ef/core/querying/raw-sql).

## <a name="examine-sql-queries"></a>Изучение SQL-запросов

В некоторых случаях полезно иметь возможность просмотреть фактические SQL-запросы, отправляемые в базу данных. Платформа EF Core использует встроенные функции ASP.NET Core для автоматического ведения журналов, содержащих код SQL запросов и обновлений. В этом разделе приводятся некоторые примеры ведения журналов кода SQL.

Откройте файл *StudentsController.cs* и установите в методе `Details` точку останова на инструкции `if (student == null)`.

Запустите приложение в режиме отладки и перейдите на страницу Details (Сведения) для учащегося.

Перейдите в **окно вывода**, в котором отображаются результаты отладки. В нем будет показан запрос:

```
Microsoft.EntityFrameworkCore.Database.Command:Information: Executed DbCommand (56ms) [Parameters=[@__id_0='?'], CommandType='Text', CommandTimeout='30']
SELECT TOP(2) [s].[ID], [s].[Discriminator], [s].[FirstName], [s].[LastName], [s].[EnrollmentDate]
FROM [Person] AS [s]
WHERE ([s].[Discriminator] = N'Student') AND ([s].[ID] = @__id_0)
ORDER BY [s].[ID]
Microsoft.EntityFrameworkCore.Database.Command:Information: Executed DbCommand (122ms) [Parameters=[@__id_0='?'], CommandType='Text', CommandTimeout='30']
SELECT [s.Enrollments].[EnrollmentID], [s.Enrollments].[CourseID], [s.Enrollments].[Grade], [s.Enrollments].[StudentID], [e.Course].[CourseID], [e.Course].[Credits], [e.Course].[DepartmentID], [e.Course].[Title]
FROM [Enrollment] AS [s.Enrollments]
INNER JOIN [Course] AS [e.Course] ON [s.Enrollments].[CourseID] = [e.Course].[CourseID]
INNER JOIN (
    SELECT TOP(1) [s0].[ID]
    FROM [Person] AS [s0]
    WHERE ([s0].[Discriminator] = N'Student') AND ([s0].[ID] = @__id_0)
    ORDER BY [s0].[ID]
) AS [t] ON [s.Enrollments].[StudentID] = [t].[ID]
ORDER BY [t].[ID]
```

Вы можете заметить удивительные результаты: код SQL выбирает до 2 строк (`TOP(2)`) из таблицы Person. Метод `SingleOrDefaultAsync` не разрешается в 1 строку на сервере. Далее описывается, почему это происходит:

* Если запрос возвращает несколько строк, метод возвращает значение NULL.
* Чтобы определить, будет ли запрос возвращать несколько строк, платформа EF проверяет, возвращаются ли как минимум 2 строки.

Обратите внимание, что вам необязательно использовать режим отладки и доходить до точки останова, чтобы просмотреть содержимое журнала в **окне вывода**. Это просто удобный способ остановить ведение журнала в тот момент, когда вам нужно просмотреть выходные данные. Если не сделать этого, ведение журнала продолжится и вам придется прокручивать окно до нужного места.

## <a name="create-an-abstraction-layer"></a>Создание уровня абстракции

Многие разработчики пишут код, реализующий шаблоны репозитория и единиц работы, в качестве оболочки для кода, работающего с платформой Entity Framework. Эти шаблоны позволяют создать уровень абстракции между уровнями доступа к данным и бизнес-логики приложения. Реализация таких шаблонов позволяет изолировать приложение от изменений в хранилище данных и упрощает автоматическое модульное тестирование или разработку на основе тестирования. Тем не менее написание дополнительного кода для реализации этих шаблонов не всегда подходит для приложений, которые используют платформу EF. Этому есть несколько причин:

* Класс контекста EF сам по себе изолирует код от кода хранилища данных.

* Класс контекста EF может выступать в качестве класса единиц работы для обновления базы данных, которые выполняются с помощью EF.

* Платформа EF предусматривает функции для реализации разработки на основе тестирования, не требующие написания кода репозитория.

Дополнительные сведения о реализации шаблонов репозитория и единиц работы см. в [версии этой серии учебников для платформы Entity Framework 5](/aspnet/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application).

Платформа Entity Framework Core реализует выполняющийся в памяти поставщик базы данных, который может использоваться для тестирования. Дополнительные сведения см. в разделе [Тестирование с помощью InMemory](/ef/core/miscellaneous/testing/in-memory).

## <a name="automatic-change-detection"></a>Автоматическое обнаружение изменений

Платформа Entity Framework определяет, как была изменена сущность (и, соответственно, какие обновления требуется отправить в базу данных), сравнивая текущие значения сущности с исходными. Исходные значения сохраняются при запросе или присоединении сущности. Ниже перечислены некоторые из методов, которые приводят к автоматическому обнаружению изменений:

* DbContext.SaveChanges

* DbContext.Entry

* ChangeTracker.Entries

Если вы отслеживаете большое число сущностей и многократно вызываете один из этих методов в цикле, вы сможете добиться заметного повышения производительности, отключив автоматическое обнаружение изменений с помощью свойства `ChangeTracker.AutoDetectChangesEnabled`. Пример:

```csharp
_context.ChangeTracker.AutoDetectChangesEnabled = false;
```

## <a name="ef-core-source-code-and-development-plans"></a>Исходный код EF Core и планы разработки

Источник Entity Framework Core расположен на странице [https://github.com/aspnet/EntityFrameworkCore](https://github.com/aspnet/EntityFrameworkCore). Репозиторий EF Core содержит ночные сборки, результаты отслеживания проблем, спецификации функций, протоколы совещаний по проекту, а также [стратегию дальнейшей разработки](https://github.com/aspnet/EntityFrameworkCore/wiki/Roadmap). Вы также можете сообщать об ошибках, находить сведения об обнаруженных проблемах и участвовать в работе сообщества.

Несмотря на открытый исходный код, платформа Entity Framework Core полностью поддерживается как продукт корпорации Майкрософт. Команда Microsoft Entity Framework контролирует предложения участников, принимает их и тестирует любые изменения кода, чтобы обеспечить максимальное качество каждого выпуска.

## <a name="reverse-engineer-from-existing-database"></a>Реконструирование из существующей базы данных

Чтобы реконструировать модель данных, включая классы сущностей, из существующей базы данных, используйте команду [scaffold-dbcontext](/ef/core/miscellaneous/cli/powershell#scaffold-dbcontext). Ознакомьтесь с [учебником по началу работы](/ef/core/get-started/aspnetcore/existing-db).

<a id="dynamic-linq"></a>

## <a name="use-dynamic-linq-to-simplify-code"></a>Использование динамических запросов LINQ для упрощения кода

В [третьем учебнике этой серии](sort-filter-page.md) демонстрируется написание кода LINQ с жестко запрограммированными именами столбцов в инструкции `switch`. При наличии всего двух столбцов такой подход эффективен, однако если столбцов много, код может стать слишком громоздким. Чтобы устранить эту проблему, можно использовать метод `EF.Property` для указания имени свойства в виде строки. Чтобы попробовать этот подход, замените метод `Index` в `StudentsController` следующим кодом.

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DynamicLinq)]

## <a name="acknowledgments"></a>Благодарности

Этот учебник написан Томом Дайкстра (Tom Dykstra) и Риком Андерсоном (Rick Anderson) (twitter @RickAndMSFT). Помощь в проверке кода для учебника и отладке проблем, возникавших при его написании, оказывали Роуэн Миллер (Rowan Miller), Диего Вега (Diego Vega) и другие участники команды Entity Framework. Джон Парент (John Parente) и Пол Голдмен (Paul Goldman) обновили это руководство для версии ASP.NET Core 2.2.

<a id="common-errors"></a>
## <a name="troubleshoot-common-errors"></a>Устранение неполадок при распространенных ошибках

### <a name="contosouniversitydll-used-by-another-process"></a>Библиотека ContosoUniversity.dll используется другим процессом

Сообщение об ошибке:

> Не удается открыть файл "...bin\Debug\netcoreapp1.0\ContosoUniversity.dll" для записи — "Процесс не может получить доступ к файлу "...\bin\Debug\netcoreapp1.0\ContosoUniversity.dll", так как этот файл занят другим процессом.

Решение:

Остановите сайт в IIS Express. Найдите значок IIS Express в панели задач Windows, щелкните его правой кнопкой мыши, выберите сайт университета Contoso и затем выберите **Остановить сайт**.

### <a name="migration-scaffolded-with-no-code-in-up-and-down-methods"></a>Формирование шаблонов миграции без кода в методах Up и Down

Возможная причина:

Команды интерфейса командной строки EF не выполняют автоматическое закрытие и сохранение файлов кода. Если при выполнении команды `migrations add` у вас есть несохраненные изменения, платформа EF не сможет обнаружить их.

Решение:

Выполните команду `migrations remove`, сохраните изменения в коде и повторно выполните команду `migrations add`.

### <a name="errors-while-running-database-update"></a>Ошибки во время обновления базы данных

При изменении схемы в базе, содержащей существующие данные, возможны другие ошибки. Если вы получаете ошибки миграции, которые не удается устранить, измените имя базы данных в строке подключения или удалите базу данных. В новой базе не будет данных, которые требуется перенести, в результате чего команда обновления базы данных с большей долей вероятности завершится без ошибок.

Проще всего в этом случае переименовать базу данных в файле *appsettings.json*. В следующий раз при выполнении команды `database update` будет создана новая база данных.

Чтобы удалить базу данных в средстве SSOX, щелкните ее правой кнопкой мыши, выберите **Удалить**, а затем в диалоговом окне **Удаление базы данных** выберите **Закрыть существующие соединения** и нажмите кнопку **ОК**.

Чтобы удалить базу данных с помощью интерфейса командной строки, выполните команду `database drop`:

```console
dotnet ef database drop
```

### <a name="error-locating-sql-server-instance"></a>Ошибка при обнаружении экземпляра SQL Server

Сообщение об ошибке:

> При установлении подключения к SQL Server произошла ошибка сети или ошибка экземпляра. Сервер не найден или недоступен. Проверьте правильность имени экземпляра и настройку сервера SQL Server для удаленных подключений. (поставщик: сетевые интерфейсы SQL, ошибка: 26 — ошибка при обнаружении указанного сервера или экземпляра)

Решение:

Проверьте строку подключения. Если вы вручную удалили файл базы данных, измените имя базы данных в строке подключения, чтобы начать работу с новой базой.

## <a name="get-the-code"></a>Получение кода

[Скачайте или ознакомьтесь с готовым приложением.](https://github.com/aspnet/Docs/tree/master/aspnetcore/data/ef-mvc/intro/samples/cu-final)

## <a name="additional-resources"></a>Дополнительные ресурсы

Дополнительные сведения о EF Core см. в [документации по платформе Entity Framework Core](/ef/core). Можно также прочесть книгу [Entity Framework Core in Action](https://www.manning.com/books/entity-framework-core-in-action).

Сведения о развертывании веб-приложения см. в <xref:host-and-deploy/index>.

Дополнительные сведения по другим вопросам, связанным с использованием ASP.NET Core MVC, включая способы проверки подлинности и авторизации, см. в <xref:index>.

## <a name="next-steps"></a>Следующие шаги

В этом учебнике рассмотрены следующие задачи.

> [!div class="checklist"]
> * Выполнение прямых SQL-запросов
> * Вызов запроса для получения сущностей
> * Вызов запроса для получения других типов
> * Вызов запроса на обновление
> * Изучение SQL-запросов
> * Создание уровня абстракции
> * Сведения об автоматическом обнаружении изменений
> * Сведения об исходном коде EF Core и планах разработки
> * Сведения об использовании динамических запросов LINQ для упрощения кода

На этом серия учебников, посвященных использованию платформы Entity Framework Core в приложении ASP.NET Core MVC, завершена. Если вам нужны сведения об использовании EF 6 с ASP.NET Core, изучите следующую статью.
> [!div class="nextstepaction"]
> [EF 6 с ASP.NET Core](../entity-framework-6.md)
