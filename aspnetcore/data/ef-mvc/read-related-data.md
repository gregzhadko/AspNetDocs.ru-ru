---
title: Учебник. Использование ASP.NET MVC с EF Core. Чтение связанных данных
description: Из этого руководства вы узнаете, как читать и отображать связанные данные — данные, которые Entity Framework загружает в свойства навигации.
author: rick-anderson
ms.author: tdykstra
ms.date: 02/05/2019
ms.topic: tutorial
uid: data/ef-mvc/read-related-data
ms.openlocfilehash: 73e225c2cd6d9f88079c54115cccad48f43d7d0c
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "57056901"
---
# <a name="tutorial-read-related-data---aspnet-mvc-with-ef-core"></a>Учебник. Использование ASP.NET MVC с EF Core. Чтение связанных данных

В предыдущем руководстве мы завершили разработку модели данных School. Из этого руководства вы узнаете, как читать и отображать связанные данные — данные, которые Entity Framework загружает в свойства навигации.

На следующих рисунках изображены страницы, с которыми вы будете работать.

![Страница индекса курсов](read-related-data/_static/courses-index.png)

![Страница индекса преподавателей](read-related-data/_static/instructors-index.png)

В этом учебнике рассмотрены следующие задачи.

> [!div class="checklist"]
> * Загрузка связанных данных
> * Создание страницы курсов
> * Создание страницы преподавателей
> * Дополнительные сведения о явной загрузке

## <a name="prerequisites"></a>Предварительные требования

* [Создание сложной модели данных с использованием EF Core в веб-приложении MVC ASP.NET Core](complex-data-model.md)

## <a name="learn-how-to-load-related-data"></a>Загрузка связанных данных

Существует несколько способов, которыми программное обеспечение объектно-реляционного сопоставления (ORM), такое как Entity Framework, может загружать связанные данные в свойства навигации сущности:

* Безотложная загрузка. При чтении сущности связанные данные извлекаются вместе с ней. Обычно такая загрузка представляет собой одиночный запрос с соединением, который получает все необходимые данные. Настроить Entity Framework Core на использование безотложной загрузки можно при помощи методов `Include` и `ThenInclude`.

  ![Пример безотложной загрузки](read-related-data/_static/eager-loading.png)

  Вы можете получить часть данных в отдельных запросах, и EF "исправит" свойства навигации.  То есть EF автоматически добавляет раздельно извлеченные сущности к соответствующим свойствам навигации ранее извлеченных объектов. Для запроса, получающего связанные данные, можно использовать метод `Load` вместо метода, который возвращает список или объект, такого как `ToList` или `Single`.

  ![Пример отдельных запросов](read-related-data/_static/separate-queries.png)

* Явная загрузка. При первом чтении сущности связанные данные не извлекаются. Если требуется получение связанных данных, то пишется дополнительный код. Как и в случае безотложной загрузки с отдельными запросами, явная загрузка представляет собой несколько запросов к базе данных. Отличие заключается в том, что при явной загрузке в коде указывается, какие свойства навигации будут загружены. В Entity Framework Core 1.1 для выполнения явной загрузки можно использовать метод `Load`. Пример:

  ![Пример явной загрузки](read-related-data/_static/explicit-loading.png)

* Отложенная загрузка. При первом чтении сущности связанные данные не извлекаются. Однако при первой попытке доступа к свойству навигации необходимые для этого свойства навигации данные извлекаются автоматически. Запрос к базе данных отправляется каждый раз, когда вы в первый раз пытаетесь получить данные из свойства навигации. Entity Framework Core 1.0 не поддерживает отложенную загрузку.

### <a name="performance-considerations"></a>Особенности производительности

Если известно, что связанные данные потребуются для каждой полученной сущности, то безотложная загрузка обычно обеспечивает наилучшую производительность, поскольку одиночный запрос к базе данных обычно эффективнее нескольких отдельных запросов для каждой полученной сущности. Пусть, например, на каждом факультете есть десять связанных курсов. Безотложная загрузка всех связанных данных приведет к одиночному запросу (с соединением) и одним циклом приема-передачи данных из базы. Отдельные запросы по курсам для каждого факультета приведут к одиннадцати циклам приема-передачи данных из базы. При высокой задержке дополнительные циклы приема-передачи данных особенно сильно влияют на производительность.

С другой стороны, в некоторых случаях отдельные запросы более эффективны. Безотложная загрузка всех связанных данных в одном запросе может привести к формированию очень сложного соединения, которое SQL сервер не сможет эффективно обработать. Либо, если необходимо получить свойства навигации сущности только для подмножества обрабатываемого набора сущностей, отдельные запросы могут показать большую производительность, поскольку при безотложной загрузке всех данных будет получено больше данных, чем вам необходимо. Если важна производительность, то для выбора наилучшего решения рекомендуется протестировать производительность для обоих случаев.

## <a name="create-a-courses-page"></a>Создание страницы курсов

Сущность Course включает свойство навигации, которое содержит сущность Department факультета, к которому привязан курс. Чтобы отобразить в списке курсов название связанного факультета, необходимо получить свойство Name из сущности Department, находящейся в свойстве навигации `Course.Department`.

Создайте для типа сущности Course контроллер с именем CoursesController с теми же параметрами шаблона **Контроллер MVC с представлениями, использующий Entity Framework**, которые мы ранее задали для контроллера Students, как это показано на следующем рисунке:

![Добавление контроллера Courses](read-related-data/_static/add-courses-controller.png)

Откройте файл *CoursesController.cs* и изучите метод `Index`. В автоматически сформированном шаблоне установлена безотложная загрузка свойства навигации `Department` при помощи метода `Include`.

Замените метод `Index` следующим кодом, который использует более подходящее имя для `IQueryable`, возвращающего сущности Course (`courses` вместо `schoolContext`):

[!code-csharp[](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_RevisedIndexMethod)]

Откройте файл *Views/Courses/Index.cshtml* и замените код шаблона следующим кодом. Изменения выделены:

[!code-html[](intro/samples/cu/Views/Courses/Index.cshtml?highlight=4,7,15-17,34-36,44)]

Мы внесли следующие изменения в код шаблона:

* Изменен заголовок с "Index" (Индекс) на "Courses" (Курсы).

* Добавлен столбец **Number** (Номер), отображающий значение свойства `CourseID`. По умолчанию в шаблоне отсутствуют первичные ключи, поскольку для конечных пользователей они не имеют смысла. Однако в нашем случае первичный ключ имеет смысл, и мы хотим его отобразить.

* Изменен столбец **Department** (Кафедра) для отображения названия кафедры. Код отображает свойство `Name` сущности Department, которая загружена в свойство навигации `Department`:

  ```html
  @Html.DisplayFor(modelItem => item.Department.Name)
  ```

Для просмотра списка с названиями кафедр запустите приложение и выберите вкладку **Courses** (Курсы).

![Страница индекса курсов](read-related-data/_static/courses-index.png)

## <a name="create-an-instructors-page"></a>Создание страницы преподавателей

В этом разделе мы создадим контроллер и представление для сущности Instructor, чтобы отобразить страницу Instructors:

![Страница индекса преподавателей](read-related-data/_static/instructors-index.png)

Эта страница считывает и отображает связанные данные следующим образом:

* Список преподавателей отображает связанные данные сущности OfficeAssignment. Сущности Instructor и OfficeAssignment связаны отношением один к нулю или к одному. Для сущностей OfficeAssignment установлена безотложная загрузка. Как упоминалось ранее, безотложная загрузка обычно эффективнее при получении связанных данных для всех строк главной таблицы. В нашем случае мы хотим отобразить принадлежность к кабинету для каждого преподавателя.

* Когда пользователь выбирает преподавателя, отображаются связанные сущности Course. Сущности Instructor и Course находятся в отношении многие ко многим. Как мы видим, безотложная загрузка также установлена для сущностей Course и связанных с ними сущностями Department. В этом случае отдельные запросы могут оказаться эффективнее, поскольку нам требуются курсы только для выбранного преподавателя. Этот пример, однако, показывает, как использовать безотложную загрузку для свойств навигации сущностей, которые сами находятся в свойствах навигации.

* Когда пользователь выбирает курс, отображаются связанные данные из набора сущностей Enrollments. Сущности Course и Enrollment находятся в отношении один ко многим. Мы используем отдельные запросы для сущностей Enrollment и связанных с ними сущностями Student.

### <a name="create-a-view-model-for-the-instructor-index-view"></a>Создание модели для представления индекса преподавателей

На странице "Instructors" (Преподаватели) отображаются данные из трех различных таблиц. Таким образом, мы создаем модель представления, которая включает три свойства, каждое из которых содержит данные из одной таблицы.

Создайте в папке *SchoolViewModels* файл *InstructorIndexData.cs* и замените существующий код следующим кодом:

[!code-csharp[](intro/samples/cu/Models/SchoolViewModels/InstructorIndexData.cs)]

### <a name="create-the-instructor-controller-and-views"></a>Создание контроллера и представлений Instructor

Создайте контроллер Instructors с действиями чтения/записи Entity Framework, как показано на следующем рисунке:

![Добавление контроллера Instructors](read-related-data/_static/add-instructors-controller.png)

Откройте файл *InstructorsController.cs* и добавьте директиву using для пространства имен ViewModels:

[!code-csharp[](intro/samples/cu/Controllers/InstructorsController.cs?name=snippet_Using)]

Замените код Index следующим кодом для выполнения безотложной загрузки связанных данных и размещения их в модели представления.

[!code-csharp[](intro/samples/cu/Controllers/InstructorsController.cs?name=snippet_EagerLoading)]

Метод принимает необязательные данные маршрута (`id`) и строку запроса (`courseID`), которые содержат значения идентификатора выбранного преподавателя и выбранного курса. Параметры передаются гиперссылками **Select** на странице.

Код начинается с создания экземпляра модели представления и помещения его в список преподавателей. В коде задается безотложная загрузка для свойств навигации `Instructor.OfficeAssignment` и `Instructor.CourseAssignments`. Вместе со свойством `CourseAssignments` загружается свойство `Course`, с которым загружаются свойства `Enrollments` и `Department`, а с каждой сущностью `Enrollment` загружается свойство `Student`.

[!code-csharp[](intro/samples/cu/Controllers/InstructorsController.cs?name=snippet_ThenInclude)]

Так как для представления требуется сущность OfficeAssignment, значительно эффективнее извлекать ее в том же запросе. Получение сущностей Course необходимо при выборе преподавателя на веб-странице, таким образом одиночный запрос окажется предпочтительнее нескольких запросов, только если страница отображается с курсами чаще, чем без них.

В коде повторяются `CourseAssignments` и `Course`, так как требуется получить два свойства из `Course`. Первая строка `ThenInclude` вызывает получение `CourseAssignment.Course`, `Course.Enrollments` и `Enrollment.Student`.

[!code-csharp[](intro/samples/cu/Controllers/InstructorsController.cs?name=snippet_ThenInclude&highlight=3-6)]

В этой точке кода вызов метода `ThenInclude` получал бы свойства навигации `Student`, которые нам требуются. Но вызов `Include` начнет заново получать свойства `Instructor`, поэтому нам придется еще раз выполнить последовательность команд, указав в этот раз `Course.Department` вместо `Course.Enrollments`.

[!code-csharp[](intro/samples/cu/Controllers/InstructorsController.cs?name=snippet_ThenInclude&highlight=7-9)]

Следующий код выполняется при выборе преподавателя. Выбранный преподаватель извлекается из списка преподавателей в модели представления. Затем из свойства навигации `CourseAssignments` этого преподавателя получается свойство модели представления `Courses` вместе с сущностями Course.

[!code-csharp[](intro/samples/cu/Controllers/InstructorsController.cs?range=56-62)]

Метод `Where` возвращает коллекцию, но с учетом переданных в метод условий в данном случае возвращается только одна сущность Instructor. Метод `Single` преобразует коллекцию в отдельную сущность Instructor, что позволяет получить доступ к ее свойству `CourseAssignments`. Свойство `CourseAssignments` содержит сущности `CourseAssignment`, из которых нам нужны только связанные сущности `Course`.

Использовать метод коллекции `Single` можно, если известно, что коллекция содержит только один элемент. Метод Single вызывает исключение, если передаваемая ему коллекция пустая или содержит больше одного элемента. Альтернативным вариантом является метод `SingleOrDefault`, который возвращает значение по умолчанию (в данном случае null), если коллекция пуста. Однако в этом случае это все равно приведет к исключению (из-за попытки найти свойство `Courses` у указателя на null), и из сообщения об исключении нелегко будет понять причину проблемы. При вызове метода `Single` вы можете также передать условие Where вместо отдельного вызова метода `Where`:

```csharp
.Single(i => i.ID == id.Value)
```

вместо следующего кода:

```csharp
.Where(i => i.ID == id.Value).Single()
```

Далее, если был выбран курс, то он получается из списка курсов модели представления. Затем из свойства навигации `Enrollments` этого курса получается свойство модели представления `Enrollments` вместе с сущностями Enrollment.

[!code-csharp[](intro/samples/cu/Controllers/InstructorsController.cs?range=64-69)]

### <a name="modify-the-instructor-index-view"></a>Изменение представления Instructor Index

В файле *Views/Instructors/Index.cshtml* замените код шаблона следующим кодом. Изменения выделены.

[!code-html[](intro/samples/cu/Views/Instructors/Index1.cshtml?range=1-64&highlight=1,3-7,15-19,24,26-31,41-54,56)]

Мы внесли следующие изменения в существующий код:

* Изменили класс модели на `InstructorIndexData`.

* Изменили заголовок страницы с **Index** на **Instructors**.

* Добавили столбец **Office**, отображающий `item.OfficeAssignment.Location` только тогда, когда `item.OfficeAssignment` не равно null. (Так как здесь отношение один к нулю или к одному, то связанной сущности OfficeAssignment может не существовать.)

  ```html
  @if (item.OfficeAssignment != null)
  {
      @item.OfficeAssignment.Location
  }
  ```

* Добавили столбец **Courses**, отображающий курсы, которые ведет конкретный преподаватель. Подробные сведения об использовании синтаксиса Razor см. в разделе [Явные строки перехода с `@:` ](xref:mvc/views/razor#explicit-line-transition-with-).

* Добавили код, который динамически добавляет `class="success"` к элементу `tr` выбранного преподавателя. Этот параметр задает цвет фона для выделенных строк c помощью класса Bootstrap.

  ```html
  string selectedRow = "";
  if (item.ID == (int?)ViewData["InstructorID"])
  {
      selectedRow = "success";
  }
  <tr class="@selectedRow">
  ```

* В каждой строке непосредственно перед другими ссылками добавили новую гиперссылку с меткой **Select**, которая отправляет идентификатор выбранного преподавателя в метод `Index`.

  ```html
  <a asp-action="Index" asp-route-id="@item.ID">Select</a> |
  ```

Запустите приложение и выберите вкладку **Instructors**. На странице отображается свойство Location связанных сущностей OfficeAssignment либо пустая ячейка таблицы при отсутствии связанной сущности OfficeAssignment.

![Страница индекса преподавателей, когда ничего не выбрано](read-related-data/_static/instructors-index-no-selection.png)

В файле *Views/Instructors/Index.cshtml* после закрывающего таблицу элемента (в конце файла) добавьте следующий код. Этот код отображает список связанных с преподавателем курсов, когда преподаватель выбран.

[!code-html[](intro/samples/cu/Views/Instructors/Index1.cshtml?range=66-101)]

Этот код считывает свойство `Courses` модели представления для отображения списка курсов. Он также предоставляет гиперссылку **Select**, которая отправляет идентификатор выбранного курса в метод действия `Index`.

Обновите страницу и выберите преподавателя. Вы увидите сетку, которая отображает курсы, назначенные выбранному преподавателю, и для каждого курса отобразится имя связанного факультета.

![Страница индекса преподавателей, выбран преподаватель](read-related-data/_static/instructors-index-instructor-selected.png)

После только что добавленного блока кода добавьте следующий код. Он отображает список студентов, которые зачислены на курс при выборе этого курса.

[!code-html[](intro/samples/cu/Views/Instructors/Index1.cshtml?range=103-125)]

Этот код считывает свойство Enrollments модели представления для отображения списка студентов, зачисленных на этот курс.

Снова обновите страницу и выберите преподавателя. Затем выберите курс, чтобы увидеть список зачисленных студентов и их оценки.

![Страница индекса преподавателей, выбраны преподаватель и курс](read-related-data/_static/instructors-index.png)

## <a name="about-explicit-loading"></a>Сведения о явной загрузке

При получении списка преподавателей в файле *InstructorsController.cs* мы указали безотложную загрузку для свойства навигации `CourseAssignments`.

Пусть ожидается, что пользователи лишь изредка будут просматривать список зачисления для выбранных преподавателя и курса. В этом случае, возможно, потребуется загружать данные о зачислении, только когда они запрошены. Чтобы продемонстрировать пример того, как выполнять явную загрузку, заменим метод `Index` следующим кодом, который удаляет упреждающую загрузку для Enrollments и загружает это свойство явно. Изменения в коде выделены.

[!code-csharp[](intro/samples/cu/Controllers/InstructorsController.cs?name=snippet_ExplicitLoading&highlight=23-29)]

В новом коде из блока, который получает сущности преподавателей, удален вызов метода *ThenInclude*. Если выбраны преподаватели и курс, выделенный код получает сущности Enrollment выбранного курса и сущности Student для каждой сущности Enrollment.

Запустите приложение, перейдите на страницу Instructors Index, и вы не увидите никаких изменений, несмотря на то, что мы изменили способ получения данных.

## <a name="get-the-code"></a>Получение кода

[Скачайте или ознакомьтесь с готовым приложением.](https://github.com/aspnet/Docs/tree/master/aspnetcore/data/ef-mvc/intro/samples/cu-final)

## <a name="next-steps"></a>Следующие шаги

В этом учебнике рассмотрены следующие задачи.

> [!div class="checklist"]
> * Дополнительные сведения о загрузке связанных данных
> * Создание страницы курсов
> * Создание страницы преподавателей
> * Дополнительные сведения о явной загрузке

В следующем руководстве описано, как обновить связанные данные.
> [!div class="nextstepaction"]
> [Обновление связанных данных](update-related-data.md)
